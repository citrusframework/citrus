<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<meta name="author" content="Authors: The Citrus Community">
<title>Citrus</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/atom-one-light.min.css">
<style>

    html, body {
        font-family: Helvetica,sans-serif;
    }

    h1, h2, h3, h4, h5, h6, #toctitle {
        color: #3b73af;
    }

    div#toctitle {
        content: url("images/citrus-logo-tiny.png");
    }

    #content h1>a.link, h2>a.link, h3>a.link, #toctitle>a.link, .sidebarblock>.content>.title>a.link, h4>a.link, h5>a.link, h6>a.link {
      color: #3b73af;
      text-decoration: none;
    }

    #content h1>a.link:hover, h2>a.link:hover, h3>a.link:hover, #toctitle>a.link:hover, .sidebarblock>.content>.title>a.link:hover, h4>a.link:hover, h5>a.link:hover, h6>a.link:hover {
      color: #3b73af;
    }

    .switch {
        border-width: 1px 0 0 1px !important;
        border-style: solid;
        border-color: #3b73af !important;
        display: inline-block;
    }

    .switch--item {
        padding: 10px;
        border-right: 1px solid !important;
        background-color: #ffffff !important;
        min-width: 5em;
        color: #3b73af !important;
        display: inline-block;
        cursor: pointer;
    }

    .switch--item:hover {
        background-color: #efefef !important;
    }

    .switch--item.selected {
        background-color: #3b73af !important;
        color: #ffffff !important;
    }

    .listingblock>.content {
        border-width: 1px 1px 1px 1px;
        border-style: solid;
        border-color: #3b73af !important;
    }
</style>
<style>
.hidden {
    display: none;
}

.switch {
    border-width: 1px 1px 0 1px;
    border-style: solid;
    border-color: #7a2518;
    display: inline-block;
}

.switch--item {
    padding: 10px;
    background-color: #ffffff;
    color: #7a2518;
    display: inline-block;
    cursor: pointer;
}

.switch--item.selected {
    background-color: #7a2519;
    color: #ffffff;
}

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
<script type="text/javascript">
function addBlockSwitches() {
    $('.primary').each(function() {
        primary = $(this);
        createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
        primary.children('.title').remove();
    });
    $('.secondary').each(function(idx, node) {
        secondary = $(node);
        primary = findPrimary(secondary);
        switchItem = createSwitchItem(secondary, primary.children('.switch'));
        switchItem.content.addClass('hidden');
        findPrimary(secondary).append(switchItem.content);
        secondary.remove();
    });
}

function createBlockSwitch(primary) {
    blockSwitch = $('<div class="switch"></div>');
    primary.prepend(blockSwitch);
    return blockSwitch;
}

function findPrimary(secondary) {
    candidate = secondary.prev();
    while (!candidate.is('.primary')) {
        candidate = candidate.prev();
    }
    return candidate;
}

function createSwitchItem(block, blockSwitch) {
    blockName = block.children('.title').text();
    content = block.children('.content').first().append(block.next('.colist'));
    item = $('<div class="switch--item">' + blockName + '</div>');
    item.on('click', '', content, function(e) {
        $(this).addClass('selected');
        $(this).siblings().removeClass('selected');
        e.data.siblings('.content').addClass('hidden');
        e.data.removeClass('hidden');
    });
    blockSwitch.append(item);
    return {'item': item, 'content': content};
}

$(addBlockSwitches);

</script>

</head>
<body id="citrus" class="book toc2 toc-left">
<div id="header">
<h1>Citrus</h1>
<div class="details">
<span id="author" class="author">Authors: The Citrus Community</span><br>
<span id="revnumber">version 4.8.2,</span>
<span id="revdate">2025-10-28</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">citrus</div>
<ul class="sectlevel1">
<li><a href="#preface">1. Preface</a></li>
<li><a href="#introduction">2. Introduction</a>
<ul class="sectlevel2">
<li><a href="#overview">2.1. Overview</a></li>
<li><a href="#usage-scenarios">2.2. Usage scenarios</a></li>
</ul>
</li>
<li><a href="#setup">3. Setup</a>
<ul class="sectlevel2">
<li><a href="#setup-maven">3.1. Maven</a></li>
<li><a href="#setup-gradle">3.2. Gradle</a></li>
</ul>
</li>
<li><a href="#runtimes">4. Runtimes</a>
<ul class="sectlevel2">
<li><a href="#runtime-testng">4.1. TestNG</a></li>
<li><a href="#runtime-junit5">4.2. JUnit5</a></li>
<li><a href="#runtime-junit4">4.3. JUnit4</a></li>
<li><a href="#runtime-quarkus">4.4. QuarkusTest</a></li>
<li><a href="#runtimes-cucumber">4.5. Cucumber</a></li>
<li><a href="#runtime-main">4.6. Main CLI</a></li>
<li><a href="#runtime-jbang">4.7. JBang</a></li>
<li><a href="#runtime-sharded">4.8. Sharding Test Cases</a></li>
</ul>
</li>
<li><a href="#run">5. Run tests</a>
<ul class="sectlevel2">
<li><a href="#run-java">5.1. Java</a></li>
<li><a href="#run-test-source-loader">5.2. Test source loader</a></li>
<li><a href="#run-xml-tests">5.3. XML</a></li>
<li><a href="#run-yaml-tests">5.4. YAML</a></li>
<li><a href="#run-groovy">5.5. Groovy</a></li>
<li><a href="#run-spring-xml-tests">5.6. Spring Bean XML</a></li>
</ul>
</li>
<li><a href="#test-variables">6. Test variables</a>
<ul class="sectlevel2">
<li><a href="#global-variables">6.1. Global variables</a></li>
<li><a href="#variables-extract">6.2. Extract variables</a></li>
<li><a href="#variables-path-expressions">6.3. Path expressions</a></li>
<li><a href="#escaping-variables-expression">6.4. Escape variables</a></li>
</ul>
</li>
<li><a href="#message-validation">7. Message validation</a>
<ul class="sectlevel2">
<li><a href="#message-validator-registry">7.1. Validation registry</a></li>
<li><a href="#message-validator-modules">7.2. Validation modules</a></li>
<li><a href="#json-message-validation">7.3. Json validation</a></li>
<li><a href="#xml-message-validation">7.4. XML validation</a></li>
<li><a href="#schema-validation">7.5. Schema validation</a></li>
<li><a href="#plaintext-message-validation">7.6. Plain text validation</a></li>
<li><a href="#binary-message-validation">7.7. Binary validation</a></li>
<li><a href="#hamcrest-message-validation">7.8. Hamcrest validation</a></li>
<li><a href="#validation-custom">7.9. Custom validation</a></li>
</ul>
</li>
<li><a href="#actions">8. Test actions</a>
<ul class="sectlevel2">
<li><a href="#actions-send">8.1. Send</a></li>
<li><a href="#actions-receive">8.2. Receive</a></li>
<li><a href="#actions-sql">8.3. SQL</a></li>
<li><a href="#actions-sleep">8.4. Sleep</a></li>
<li><a href="#actions-delay">8.5. Delay</a></li>
<li><a href="#actions-java">8.6. Java</a></li>
<li><a href="#actions-expect-timeout">8.7. Expect timeout</a></li>
<li><a href="#actions-echo">8.8. Echo</a></li>
<li><a href="#actions-print">8.9. Print</a></li>
<li><a href="#actions-stop-time">8.10. Stop time</a></li>
<li><a href="#actions-create-variables">8.11. Create variables</a></li>
<li><a href="#actions-create-endpoint">8.12. Create endpoints</a></li>
<li><a href="#actions-trace-variables">8.13. Trace variables</a></li>
<li><a href="#actions-transform">8.14. Transform</a></li>
<li><a href="#actions-groovy">8.15. Groovy script execution</a></li>
<li><a href="#actions-fail">8.16. Failing the test</a></li>
<li><a href="#actions-input">8.17. Input</a></li>
<li><a href="#actions-load">8.18. Load Properties</a></li>
<li><a href="#actions-purging-jms-destinations">8.19. Purging JMS destinations</a></li>
<li><a href="#actions-purging-message-channels">8.20. Purging Spring Message Channels</a></li>
<li><a href="#actions-purging-endpoints">8.21. Purging endpoints</a></li>
<li><a href="#actions-assert-failure">8.22. Assert failure</a></li>
<li><a href="#actions-catch-exceptions">8.23. Catch exceptions</a></li>
<li><a href="#actions-ant-build">8.24. Apache Ant build</a></li>
<li><a href="#actions-start-stop">8.25. Start/Stop server</a></li>
<li><a href="#actions-stop-timer">8.26. Stop Timer</a></li>
<li><a href="#actions-custom">8.27. Custom action</a></li>
</ul>
</li>
<li><a href="#containers">9. Containers</a>
<ul class="sectlevel2">
<li><a href="#containers-sequential">9.1. Sequential</a></li>
<li><a href="#containers-conditional">9.2. Conditional</a></li>
<li><a href="#containers-parallel">9.3. Parallel</a></li>
<li><a href="#containers-iterate">9.4. Iterate</a></li>
<li><a href="#containers-repeat">9.5. Repeat</a></li>
<li><a href="#containers-repeat-on-error">9.6. Repeat on error</a></li>
<li><a href="#containers-timer">9.7. Timer</a></li>
<li><a href="#containers-async">9.8. Async</a></li>
<li><a href="#containers-wait">9.9. Wait</a></li>
<li><a href="#containers-custom">9.10. Custom containers</a></li>
</ul>
</li>
<li><a href="#endpoints">10. Endpoints</a>
<ul class="sectlevel2">
<li><a href="#endpoints-send-messages">10.1. Send messages</a></li>
<li><a href="#endpoints-receive-messages">10.2. Receive messages</a></li>
<li><a href="#local-message-store">10.3. Local message store</a></li>
</ul>
</li>
<li><a href="#direct">11. Direct endpoint</a>
<ul class="sectlevel2">
<li><a href="#direct-endpoint">11.1. Channel endpoint</a></li>
<li><a href="#synchronous-direct-endpoints">11.2. Synchronous direct endpoints</a></li>
<li><a href="#message-queue-selector">11.3. Message selectors</a></li>
<li><a href="#payload-matching-message-queue-selector">11.4. Payload matching selector</a></li>
<li><a href="#root-qname-message-queue-selector">11.5. Root QName selector</a></li>
<li><a href="#xpath-message-queue-selector">11.6. Xpath selector</a></li>
<li><a href="#json-path-message-queue-selector">11.7. JsonPath selector</a></li>
</ul>
</li>
<li><a href="#jms">12. JMS support</a>
<ul class="sectlevel2">
<li><a href="#jms-endpoints">12.1. JMS endpoints</a></li>
<li><a href="#jms-synchronous-endpoints">12.2. JMS synchronous endpoints</a></li>
<li><a href="#jms-topics">12.3. JMS topics</a></li>
<li><a href="#jms-topic-durable-subscription">12.4. JMS topic durable subscription</a></li>
<li><a href="#jms-topic-purging">12.5. JMS topic purging</a></li>
<li><a href="#jms-message-headers">12.6. JMS message headers</a></li>
<li><a href="#dynamic-destination-names">12.7. Dynamic destination names</a></li>
<li><a href="#soap-over-jms">12.8. SOAP over JMS</a></li>
</ul>
</li>
<li><a href="#kafka">13. Apache Kafka Support</a>
<ul class="sectlevel2">
<li><a href="#kafka-endpoint">13.1. Kafka Endpoint</a></li>
<li><a href="#kafka-synchronous-endpoints">13.2. Kafka Synchronous Endpoints</a></li>
<li><a href="#kafka-message-headers">13.3. Kafka Message Headers</a></li>
<li><a href="#kafka-message">13.4. Kafka Message</a></li>
<li><a href="#kafka-message-selector">13.5. Kafka Message Selector</a></li>
<li><a href="#dynamic-kafka-endpoints">13.6. Dynamic Kafka Endpoints</a></li>
<li><a href="#embedded-kafka-server">13.7. Embedded Kafka Server</a></li>
</ul>
</li>
<li><a href="#http-rest">14. Http REST support</a>
<ul class="sectlevel2">
<li><a href="#http-rest-client">14.1. Http REST client</a></li>
<li><a href="#http-client-interceptors">14.2. Http client interceptors</a></li>
<li><a href="#http-rest-server">14.3. Http REST server</a></li>
<li><a href="#http-headers">14.4. Http headers</a></li>
<li><a href="#http-query-params">14.5. Http query parameter</a></li>
<li><a href="#http-server-interceptors">14.6. Http server interceptors</a></li>
<li><a href="#http-form-urlencoded-data">14.7. Http form urlencoded data</a></li>
<li><a href="#http-error-handling">14.8. Http error handling</a></li>
<li><a href="#http-client-basic-authentication">14.9. Http client basic authentication</a></li>
<li><a href="#http-server-basic-authentication">14.10. Http server basic authentication</a></li>
<li><a href="#http-client-ssl">14.11. Http client SSL</a></li>
<li><a href="#http-server-ssl">14.12. Http server SSL</a></li>
<li><a href="#http-cookies">14.13. Http cookies</a></li>
<li><a href="#http-gzip-compression">14.14. Http Gzip compression</a></li>
<li><a href="#http-servlet-filters">14.15. Http servlet filters</a></li>
<li><a href="#http-servlet-context-customization">14.16. Http servlet context customization</a></li>
</ul>
</li>
<li><a href="#soap-webservices">15. SOAP WebServices</a>
<ul class="sectlevel2">
<li><a href="#soap-client">15.1. SOAP client</a></li>
<li><a href="#soap-client-interceptors">15.2. SOAP client interceptors</a></li>
<li><a href="#soap-server">15.3. SOAP server</a></li>
<li><a href="#soap-send-and-receive">15.4. SOAP send and receive</a></li>
<li><a href="#soap-headers">15.5. SOAP headers</a></li>
<li><a href="#soap-http-mime-headers">15.6. SOAP HTTP mime headers</a></li>
<li><a href="#soap-envelope-handling">15.7. SOAP Envelope handling</a></li>
<li><a href="#soap-server-interceptors">15.8. SOAP server interceptors</a></li>
<li><a href="#soap-1-2">15.9. SOAP 1.2</a></li>
<li><a href="#soap-faults">15.10. SOAP faults</a></li>
<li><a href="#send-soap-faults">15.11. Send SOAP faults</a></li>
<li><a href="#receive-soap-faults">15.12. Receive SOAP faults</a></li>
<li><a href="#multiple-soap-fault-details">15.13. Multiple SOAP fault details</a></li>
<li><a href="#send-http-error-codes-with-soap">15.14. Send HTTP error codes with SOAP</a></li>
<li><a href="#soap-attachment">15.15. SOAP attachment support</a></li>
<li><a href="#send-soap-attachments">15.16. Send SOAP attachments</a></li>
<li><a href="#receive-soap-attachments">15.17. Receive SOAP attachments</a></li>
<li><a href="#soap-mtom">15.18. SOAP MTOM support</a></li>
<li><a href="#soap-client-basic-authentication">15.19. SOAP client basic authentication</a></li>
<li><a href="#soap-server-basic-authentication">15.20. SOAP server basic authentication</a></li>
<li><a href="#ws-addressing">15.21. WS-Addressing support</a></li>
<li><a href="#soap-client-fork-mode">15.22. SOAP client fork mode</a></li>
<li><a href="#soap-servlet-context-customization">15.23. SOAP servlet context customization</a></li>
</ul>
</li>
<li><a href="#apache-camel">16. Apache Camel support</a>
<ul class="sectlevel2">
<li><a href="#camel-endpoint">16.1. Camel endpoint</a></li>
<li><a href="#synchronous-camel-endpoint">16.2. Synchronous Camel endpoint</a></li>
<li><a href="#camel-exchange-headers">16.3. Camel exchange headers</a></li>
<li><a href="#camel-exception-handling">16.4. Camel exception handling</a></li>
<li><a href="#camel-context-handling">16.5. Camel context handling</a></li>
<li><a href="#camel-route-actions">16.6. Camel route actions</a></li>
<li><a href="#camel-controlbus-actions">16.7. Camel controlbus actions</a></li>
<li><a href="#camel-jbang">16.8. Camel JBang support</a></li>
<li><a href="#camel-jbang-kubernetes">16.9. Camel JBang Kubernetes support</a></li>
<li><a href="#camel-infra">16.10. Camel infrastructure services</a></li>
<li><a href="#camel-endpoint-dsl">16.11. Camel endpoint DSL</a></li>
<li><a href="#camel-processor-support">16.12. Camel processor support</a></li>
<li><a href="#camel-data-format-support">16.13. Camel data format support</a></li>
</ul>
</li>
<li><a href="#message-channels">17. Message channel support</a>
<ul class="sectlevel2">
<li><a href="#channel-endpoint">17.1. Channel endpoint</a></li>
<li><a href="#synchronous-channel-endpoints">17.2. Synchronous channel endpoints</a></li>
<li><a href="#message-channel-selector">17.3. Message selectors</a></li>
<li><a href="#payload-matching-message-channel-selector">17.4. Payload matching selector</a></li>
<li><a href="#root-qname-message-channel-selector">17.5. Root QName selector</a></li>
<li><a href="#xpath-message-channel-selector">17.6. Xpath selector</a></li>
<li><a href="#json-path-message-channel-selector">17.7. JsonPath selector</a></li>
</ul>
</li>
<li><a href="#websocket">18. WebSocket support</a>
<ul class="sectlevel2">
<li><a href="#websocket-client">18.1. WebSocket client</a></li>
<li><a href="#websocket-server-endpoints">18.2. WebSocket server endpoints</a></li>
<li><a href="#websocket-headers">18.3. WebSocket headers</a></li>
</ul>
</li>
<li><a href="#mail">19. Mail support</a>
<ul class="sectlevel2">
<li><a href="#mail-client">19.1. Mail client</a></li>
<li><a href="#mail-server">19.2. Mail server</a></li>
</ul>
</li>
<li><a href="#ftp">20. FTP support</a>
<ul class="sectlevel2">
<li><a href="#ftp-client">20.1. FTP client</a></li>
<li><a href="#ftp-server">20.2. FTP server</a></li>
</ul>
</li>
<li><a href="#sftp">21. SFTP/SCP support</a>
<ul class="sectlevel2">
<li><a href="#sftp-client">21.1. SFTP client</a></li>
<li><a href="#sftp-server">21.2. SFTP server</a></li>
<li><a href="#scp-client">21.3. SCP client</a></li>
</ul>
</li>
<li><a href="#file">22. File support</a>
<ul class="sectlevel2">
<li><a href="#write-files">22.1. Write files</a></li>
<li><a href="#read-files">22.2. Read files</a></li>
</ul>
</li>
<li><a href="#selenium">23. Selenium support</a>
<ul class="sectlevel2">
<li><a href="#selenium-browser">23.1. Selenium browser</a></li>
<li><a href="#selenium-actions">23.2. Selenium actions</a></li>
<li><a href="#start-stop-browser">23.3. Start/stop browser</a></li>
<li><a href="#find">23.4. Find</a></li>
<li><a href="#click">23.5. Click</a></li>
<li><a href="#hover">23.6. Hover</a></li>
<li><a href="#form-input-actions">23.7. Form input actions</a></li>
<li><a href="#form-fill-actions">23.8. Fill form</a></li>
<li><a href="#page-actions">23.9. Page actions</a></li>
<li><a href="#page-validation">23.10. Page validation</a></li>
<li><a href="#wait">23.11. Wait</a></li>
<li><a href="#navigate">23.12. Navigate</a></li>
<li><a href="#window-actions">23.13. Window actions</a></li>
<li><a href="#alert">23.14. Alert</a></li>
<li><a href="#make-screenshot">23.15. Make screenshot</a></li>
<li><a href="#temporary-storage-firefox">23.16. Temporary storage (Firefox)</a></li>
<li><a href="#clear-browser-cache">23.17. Clear browser cache</a></li>
</ul>
</li>
<li><a href="#vert-x-event-bus">24. Vert.x event bus support</a>
<ul class="sectlevel2">
<li><a href="#vert-x-endpoint">24.1. Vert.x endpoint</a></li>
<li><a href="#synchronous-vert-x-endpoint">24.2. Synchronous Vert.x endpoint</a></li>
<li><a href="#vert-x-instance-factory">24.3. Vert.x instance factory</a></li>
</ul>
</li>
<li><a href="#jdbc">25. JDBC support</a>
<ul class="sectlevel2">
<li><a href="#jdbc-driver">25.1. The Citrus-JDBC-Driver</a></li>
<li><a href="#jdbc-server">25.2. The Citrus-JDBC-Server</a></li>
<li><a href="#jdbc-message">25.3. JdbcMessage</a></li>
</ul>
</li>
<li><a href="#docker">26. Docker support</a>
<ul class="sectlevel2">
<li><a href="#docker-client">26.1. Docker client</a></li>
<li><a href="#docker-commands">26.2. Docker commands</a></li>
</ul>
</li>
<li><a href="#ssh">27. SSH support</a>
<ul class="sectlevel2">
<li><a href="#ssh-client">27.1. SSH Client</a></li>
<li><a href="#ssh-server">27.2. SSH Server</a></li>
</ul>
</li>
<li><a href="#rmi">28. RMI support</a>
<ul class="sectlevel2">
<li><a href="#rmi-client">28.1. RMI client</a></li>
<li><a href="#rmi-server">28.2. RMI server</a></li>
</ul>
</li>
<li><a href="#jmx">29. JMX support</a>
<ul class="sectlevel2">
<li><a href="#jmx-client">29.1. JMX client</a></li>
<li><a href="#jmx-server">29.2. JMX server</a></li>
</ul>
</li>
<li><a href="#zookeeper">30. Zookeeper support</a>
<ul class="sectlevel2">
<li><a href="#zookeeper-client">30.1. Zookeeper client</a></li>
<li><a href="#zookeeper-commands">30.2. Zookeeper commands</a></li>
</ul>
</li>
<li><a href="#dynamic-endpoint-components">31. Dynamic endpoint components</a></li>
<li><a href="#endpoint-adapter">32. Endpoint adapter</a>
<ul class="sectlevel2">
<li><a href="#empty-response-endpoint-adapter">32.1. Empty response endpoint adapter</a></li>
<li><a href="#static-response-endpoint-adapter">32.2. Static response endpoint adapter</a></li>
<li><a href="#request-dispatching-endpoint-adapter">32.3. Request dispatching endpoint adapter</a></li>
<li><a href="#channel-endpoint-adapter">32.4. Channel endpoint adapter</a></li>
<li><a href="#jms-endpoint-adapter">32.5. JMS endpoint adapter</a></li>
</ul>
</li>
<li><a href="#connectors">33. Connectors</a></li>
<li><a href="#openapi">34. OpenAPI support</a>
<ul class="sectlevel2">
<li><a href="#openapi-specification">34.1. OpenAPI specification</a></li>
<li><a href="#openapi-client">34.2. OpenAPI client</a></li>
<li><a href="#openapi-server">34.3. OpenAPI server</a></li>
</ul>
</li>
<li><a href="#jbang">35. JBang support</a>
<ul class="sectlevel2">
<li><a href="#jbang-action">35.1. JBang action</a></li>
</ul>
</li>
<li><a href="#kubernetes">36. Kubernetes support</a>
<ul class="sectlevel2">
<li><a href="#kubernetes-client">36.1. Kubernetes client</a></li>
<li><a href="#kubernetes-actions">36.2. Kubernetes actions</a></li>
<li><a href="#kubernetes-create-labels">36.3. Create Labels</a></li>
<li><a href="#kubernetes-create-annotations">36.4. Create Annotations</a></li>
<li><a href="#kubernetes-create-service">36.5. Create Service</a></li>
<li><a href="#kubernetes-connect-service">36.6. Connect with Service</a></li>
<li><a href="#kubernetes-disconnect-service">36.7. Disconnect from Service</a></li>
<li><a href="#kubernetes-create-config-map">36.8. Create ConfigMap</a></li>
<li><a href="#kubernetes-create-secret">36.9. Create Secret</a></li>
<li><a href="#kubernetes-create-resources">36.10. Create Resources</a></li>
<li><a href="#kubernetes-delete-resources">36.11. Delete Resources</a></li>
<li><a href="#kubernetes-create-custom-resource">36.12. Create Custom Resource</a></li>
<li><a href="#kubernetes-delete-custom-resources">36.13. Delete Custom Resource</a></li>
<li><a href="#kubernetes-verify-custom-resources">36.14. Verify Custom Resource</a></li>
<li><a href="#kubernetes-verify-pods">36.15. Verify Pod Status</a></li>
<li><a href="#kubernetes-verify-pod-logs">36.16. Verify Pod Logs</a></li>
<li><a href="#kubernetes-agent">36.17. Kubernetes Citrus agent</a></li>
<li><a href="#kubernetes-spring">36.18. Spring bean config</a></li>
<li><a href="#kubernetes-commands">36.19. Kubernetes commands</a></li>
<li><a href="#kubernetes-command-bus">36.20. Kubernetes command bus</a></li>
</ul>
</li>
<li><a href="#knative">37. Knative support</a>
<ul class="sectlevel2">
<li><a href="#knative-client">37.1. Knative client</a></li>
<li><a href="#knative-broker">37.2. Knative broker</a></li>
<li><a href="#knative-broker-verify">37.3. Verify broker status</a></li>
<li><a href="#knative-send-event">37.4. Send events</a></li>
<li><a href="#knative-receive-event">37.5. Receive events</a></li>
<li><a href="#knative-channels">37.6. Knative channels</a></li>
<li><a href="#knative-subscription">37.7. Knative subscription</a></li>
</ul>
</li>
<li><a href="#testcontainers">38. Testcontainers support</a>
<ul class="sectlevel2">
<li><a href="#testcontainers-action">38.1. Start and stop Testcontainers</a></li>
<li><a href="#testcontainers-postgresql">38.2. PostgreSQL</a></li>
<li><a href="#testcontainers-mongodb">38.3. MongoDB</a></li>
<li><a href="#testcontainers-localstack">38.4. LocalStack</a></li>
<li><a href="#testcontainers-kafka">38.5. Kafka</a></li>
<li><a href="#testcontainers-redpanda">38.6. Redpanda</a></li>
<li><a href="#testcontainers-compose">38.7. Docker compose</a></li>
</ul>
</li>
<li><a href="#functions">39. Functions</a>
<ul class="sectlevel2">
<li><a href="#functions-concat">39.1. concat()</a></li>
<li><a href="#functions-substring">39.2. substring()</a></li>
<li><a href="#functions-stringlength">39.3. stringLength()</a></li>
<li><a href="#functions-translate">39.4. translate()</a></li>
<li><a href="#functions-substring-before">39.5. substringBefore()</a></li>
<li><a href="#functions-substring-after">39.6. substringAfter()</a></li>
<li><a href="#functions-round">39.7. round()</a></li>
<li><a href="#functions-floor">39.8. floor()</a></li>
<li><a href="#functions-ceiling">39.9. ceiling()</a></li>
<li><a href="#functions-random-number">39.10. randomNumber()</a></li>
<li><a href="#function-random-number-generator">39.11. randomNumberGenerator()</a></li>
<li><a href="#functions-random-string">39.12. randomString()</a></li>
<li><a href="#functions-random-pattern">39.13. randomPattern()</a></li>
<li><a href="#functions-random-enum-value">39.14. randomEnumValue()</a></li>
<li><a href="#functions-current-date">39.15. currentDate()</a></li>
<li><a href="#functions-uppercase">39.16. upperCase()</a></li>
<li><a href="#functions-lowercase">39.17. lowerCase()</a></li>
<li><a href="#functions-average">39.18. average()</a></li>
<li><a href="#functions-minimum">39.19. minimum()</a></li>
<li><a href="#functions-maximum">39.20. maximum()</a></li>
<li><a href="#functions-sum">39.21. sum()</a></li>
<li><a href="#functions-absolute">39.22. absolute()</a></li>
<li><a href="#functions-map-value">39.23. mapValue()</a></li>
<li><a href="#functions-random-uuid">39.24. randomUUID()</a></li>
<li><a href="#functions-encode-base64">39.25. encodeBase64()</a></li>
<li><a href="#functions-decode-base64">39.26. decodeBase64()</a></li>
<li><a href="#functions-escape-xml">39.27. escapeXml()</a></li>
<li><a href="#functions-escape-json">39.28. escapeJson()</a></li>
<li><a href="#functions-cdata-section">39.29. cdataSection()</a></li>
<li><a href="#functions-digest-auth-header">39.30. digestAuthHeader()</a></li>
<li><a href="#functions-localhost-address">39.31. localHostAddress()</a></li>
<li><a href="#functions-change-date">39.32. changeDate()</a></li>
<li><a href="#functions-read-file">39.33. readFile()</a></li>
<li><a href="#functions-message">39.34. message()</a></li>
<li><a href="#functions-xpath">39.35. xpath()</a></li>
<li><a href="#functions-jsonpath">39.36. jsonPath()</a></li>
<li><a href="#functions-url-encode">39.37. urlEncode()/urlDecode()</a></li>
<li><a href="#functions-system-properties">39.38. systemProperty()</a></li>
<li><a href="#functions-env-settings">39.39. env()</a></li>
<li><a href="#functions-unix-timestamp">39.40. unixTimestamp()</a></li>
</ul>
</li>
<li><a href="#validation-matcher">40. Validation Matchers</a>
<ul class="sectlevel2">
<li><a href="#matcher-ignore">40.1. ignore()</a></li>
<li><a href="#matcher-matches-xml">40.2. matchesXml()</a></li>
<li><a href="#matcher-equals-ignore-case">40.3. equalsIgnoreCase()</a></li>
<li><a href="#matcher-contains">40.4. contains()</a></li>
<li><a href="#matcher-startswith">40.5. startsWith()</a></li>
<li><a href="#matcher-endswith">40.6. endsWith()</a></li>
<li><a href="#matcher-matches">40.7. matches()</a></li>
<li><a href="#matcher-matches-date-pattern">40.8. matchesDatePattern()</a></li>
<li><a href="#matcher-isnumber">40.9. isNumber()</a></li>
<li><a href="#matcher-lowerthan">40.10. lowerThan()</a></li>
<li><a href="#matcher-greaterthan">40.11. greaterThan()</a></li>
<li><a href="#matcher-isweekday">40.12. isWeekday()</a></li>
<li><a href="#matcher-variable">40.13. variable()</a></li>
<li><a href="#matcher-daterange">40.14. dateRange()</a></li>
<li><a href="#matcher-assert-that">40.15. assertThat()</a></li>
<li><a href="#matcher-ignore-new-line">40.16. ignoreNewLine()</a></li>
<li><a href="#matcher-trim-whitespace">40.17. trim()</a></li>
<li><a href="#matcher-trim-all-whitespace">40.18. trimAllWhitespaces()</a></li>
<li><a href="#matcher-is-uuid-v4">40.19. isUUIDv4()</a></li>
</ul>
</li>
<li><a href="#agent">41. Citrus agent</a>
<ul class="sectlevel2">
<li><a href="#agent-service">41.1. Agent REST service API</a></li>
<li><a href="#agent-configuration">41.2. Configuration</a></li>
<li><a href="#agent-ui">41.3. Web UI</a></li>
<li><a href="#agent-docker-image">41.4. Docker container image</a></li>
<li><a href="#agent-jbang">41.5. Agent JBang commands</a></li>
<li><a href="#agent-maven-plugin">41.6. Maven plugin</a></li>
</ul>
</li>
<li><a href="#data-dictionaries">42. Data dictionaries</a>
<ul class="sectlevel2">
<li><a href="#xml-data-dictionaries">42.1. XML data dictionaries</a></li>
<li><a href="#json-data-dictionaries">42.2. JSON data dictionaries</a></li>
<li><a href="#dictionary-scopes">42.3. Dictionary scopes</a></li>
<li><a href="#path-mapping-strategies">42.4. Path mapping strategies</a></li>
</ul>
</li>
<li><a href="#test-actors">43. Test actors</a>
<ul class="sectlevel2">
<li><a href="#test-actors-create">43.1. Create test actors</a></li>
<li><a href="#test-actors-reference">43.2. Reference test actors</a></li>
<li><a href="#test-actors-disable">43.3. Disable test actors</a></li>
<li><a href="#test-actors-environment-setting">43.4. Test actor environment settings</a></li>
</ul>
</li>
<li><a href="#test-suite-actions">44. Test suite actions</a>
<ul class="sectlevel2">
<li><a href="#before-suite">44.1. Before suite</a></li>
<li><a href="#after-suite">44.2. After suite</a></li>
<li><a href="#before-test">44.3. Before test</a></li>
<li><a href="#after-test">44.4. After test</a></li>
</ul>
</li>
<li><a href="#customize-meta-information">45. Customize meta information</a></li>
<li><a href="#reporting-and-test-results">46. Reporting and Test Results</a>
<ul class="sectlevel2">
<li><a href="#console-logging">46.1. Console logging</a></li>
<li><a href="#junit-reports">46.2. JUnit reports</a></li>
<li><a href="#html-reports">46.3. HTML reports</a></li>
</ul>
</li>
<li><a href="#configuration">47. Configuration options</a>
<ul class="sectlevel2">
<li><a href="#configuration-environment-settings">47.1. Environment settings</a></li>
<li><a href="#configuration-property-binding">47.2. Property binding support</a></li>
<li><a href="#configuration-spring">47.3. Spring configuration settings</a></li>
<li><a href="#configuration-property-file">47.4. Property file settings</a></li>
</ul>
</li>
<li><a href="#spring-support">48. Spring support</a>
<ul class="sectlevel2">
<li><a href="#spring-xml-config">48.1. Spring XML application context</a></li>
<li><a href="#spring-java-config">48.2. Spring Java config</a></li>
</ul>
</li>
<li><a href="#tools">49. Tools</a></li>
<li><a href="#tools-cucumber-steps">50. Cucumber Steps</a>
<ul class="sectlevel2">
<li><a href="#tools-cucumber-steps-standard">50.1. Standard steps</a></li>
<li><a href="#tools-cucumber-steps-camel">50.2. Apache Camel steps</a></li>
<li><a href="#tools-cucumber-steps-groovy">50.3. Groovy steps</a></li>
<li><a href="#tools-cucumber-steps-http">50.4. Http steps</a></li>
<li><a href="#tools-cucumber-steps-jdbc">50.5. JDBC steps</a></li>
<li><a href="#steps-tools-cucumber-steps-jms">50.6. JMS steps</a></li>
<li><a href="#tools-cucumber-steps-kafka">50.7. Kafka steps</a></li>
<li><a href="#tools-cucumber-steps-kubernetes">50.8. Kubernetes steps</a></li>
<li><a href="#tools-cucumber-steps-knative">50.9. Knative steps</a></li>
<li><a href="#tools-cucumber-steps-openapi">50.10. OpenAPI steps</a></li>
<li><a href="#steps-tools-cucumber-steps-selenium">50.11. Selenium steps</a></li>
<li><a href="#tools-cucumber-steps-testcontainers">50.12. Testcontainers steps</a></li>
</ul>
</li>
<li><a href="#spring-restdocs">51. Spring Restdocs support</a>
<ul class="sectlevel2">
<li><a href="#spring-restdocs-using-http">51.1. Spring Restdocs using Http</a></li>
<li><a href="#spring-restdocs-using-soap">51.2. Spring Restdocs using SOAP</a></li>
</ul>
</li>
<li><a href="#tracing-messages">52. Tracing messages</a></li>
<li><a href="#samples">53. Samples</a>
<ul class="sectlevel2">
<li><a href="#samples-flightbooking">53.1. The FlightBooking sample</a></li>
</ul>
</li>
<li><a href="#appendix">54. Appendix</a>
<ul class="sectlevel2">
<li><a href="#maven-archetypes">Maven archetype</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><strong>Version: 4.8.2</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/citrus-logo-small.png" alt="citrus-logo">
</div>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect1">
<h2 id="preface"><a class="anchor" href="#preface"></a><a class="link" href="#preface">1. Preface</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Integration tests are a critical part of software testing. In contrast to unit tests where the primary goal is to verify a
single class or method in isolation to other parts of the software the integration tests look at a wider scope with
several components and software parts interacting with each other.</p>
</div>
<div class="paragraph">
<p>Integration tests often rely on infrastructure components such as I/O, databases, 3rd party services and so on. In combination with
messaging and multiple message transports as client and/or server the automated tests become a tough challenge. Testers need sufficient
tool support to master this challenge for automated integration test. Citrus as an Open Source framework is here to help you master this
challenge.</p>
</div>
<div class="paragraph">
<p>In a typical enterprise application and middleware scenario automated integration testing of message-based interfaces is exhausting
and sometimes barely possible. Usually the tester is forced to simulate several interface partners in an end-to-end integration test.</p>
</div>
<div class="paragraph">
<p>The first thing that comes to one&#8217;s mind is manual testing. No doubt manual testing is fast. In a long term perspective
manual testing is time-consuming and causes severe problems regarding maintainability as they are error prone and not repeatable.</p>
</div>
<div class="paragraph">
<p>Citrus provides a complete test automation tool for integration testing of message-based enterprise applications. You can test
your message interfaces (Http REST, SOAP, JMS, Kafka, TCP/IP, FTP, &#8230;&#8203;) to other applications as client and server.
Every time a code change is made all automated Citrus tests ensure the stability of software interfaces and its message communication.</p>
</div>
<div class="paragraph">
<p>Regression testing and continuous integration is very easy as Citrus fits into your build lifecycle (Maven or Gradle) as usual
Java unit test (JUnit, TestNG, Cucumber).</p>
</div>
<div class="paragraph">
<p>With powerful validation capabilities for various message formats like XML, CSV or JSON Citrus is ready to provide fully
automated integration tests for end-to-end use cases. Citrus effectively composes complex messaging use cases with response
generation, error simulation, database interaction and more.</p>
</div>
<div class="paragraph">
<p>This documentation provides a reference guide to all features of the Citrus test framework. It gives a detailed picture of
effective integration testing with automated integration test environments. Since this document is open, please do not
hesitate to give feedback in form of comments, change requests, fixes and pull requests. We are more than happy to continuously
improve this documentation with your help!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a><a class="link" href="#introduction">2. Introduction</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Citrus provides automated integration tests for message-based enterprise applications. The framework is Open Source and
supports various messaging transports (Http REST, SOAP, JMS, Kafka, TCP/IP, FTP, &#8230;&#8203;) and data formats (XML, Json, plaintext, binary).</p>
</div>
<div class="paragraph">
<p>The Citrus tests use well-known unit test frameworks (JUnit, TestNG, Cucumber) for execution and integrates with build
tools like Maven or Gradle. In addition, Citrus leverages standard libraries like Quarkus, the Spring Framework or Apache Camel.</p>
</div>
<div class="paragraph">
<p>It is also good to know that Citrus is written purely in Java. Thus, it is also fully compatible with Kotlin.</p>
</div>
<div class="sect2">
<h3 id="overview"><a class="anchor" href="#overview"></a><a class="link" href="#overview">2.1. Overview</a></h3>
<div class="paragraph">
<p>Citrus supports simulating interface partners across different messaging transports. You can easily
produce and consume messages with a wide range of protocols like HTTP, JMS, TCP/IP, FTP, SMTP and more. The framework is able
to act both as a client and server. In each communication step Citrus is able to validate message contents towards syntax and semantics.</p>
</div>
<div class="paragraph">
<p>In addition to that the Citrus framework offers a wide range of test actions to take control of the process flow during a test
(e.g. iterations, system availability checks, database connectivity, parallelism, delays, error simulation, scripting and many more).</p>
</div>
<div class="paragraph">
<p>The test is able to describe a whole use case scenario including several interface partners that exchange many messages with each other.
The composition of complex message flows in a single test case with several test steps is one of the major features in Citrus.</p>
</div>
<div class="paragraph">
<p>You can choose how to describe the test case definition either with pure XML or a Java domain specific language. The tests can be
executed multiple times as automated integration test.</p>
</div>
<div class="paragraph">
<p>With JUnit and TestNG integration Citrus can easily be integrated into your build lifecycle process (Maven or Gradle). During a test Citrus
simulates all surrounding interface partners (client or server) without any coding effort. With easy definition of expected
message content (header and body) for XML, CSV, SOAP, JSON or plaintext messages Citrus is able to validate the incoming
data towards syntax and semantics.</p>
</div>
</div>
<div class="sect2">
<h3 id="usage-scenarios"><a class="anchor" href="#usage-scenarios"></a><a class="link" href="#usage-scenarios">2.2. Usage scenarios</a></h3>
<div class="paragraph">
<p>Citrus should help you whenever it comes to verify a message-based software with its interfaces to other components and partners
using automated integration tests. Every project that interacts with other components over messaging transports needs to simulate these
interface partners on the client or server side in a test scenario. Citrus is here to help you master these test automation tasks.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/usage_sample.jpg" alt="usage_sample.jpg"></span></p>
</div>
<div class="paragraph">
<p>This test set up is typical for a Citrus use case. In such a test scenario we have a system under test (SUT) with several
messaging interfaces to other applications. A client application invokes services on the SUT and triggers business logic.
The SUT is linked to several backend applications over various messaging transports (here SOAP, JMS, and Http). As part of the
business logic one or more of these backend services is called and interim message notifications and responses are sent back to the
client application.</p>
</div>
<div class="paragraph">
<p>This generates a bunch of messages that are exchanged throughout the components involved.</p>
</div>
<div class="paragraph">
<p>In the automated integration test Citrus needs to send and receive those messages over different transports. Citrus takes
care of all interface partners (ClientApplication, Backend1, Backend2, Backend3) and simulates their behavior by sending
proper response messages in order to keep the message flow alive.</p>
</div>
<div class="paragraph">
<p>Each communication step comes with message validation and comparison against an expected message template (e.g. XML or JSON data).
In addition to messaging steps Citrus is also able to perform arbitrary other test actions (e.g. perform a database
query between requests).</p>
</div>
<div class="paragraph">
<p>In fact a Citrus test case is nothing but a normal JUnit or TestNG test case. This makes it very straight forward to run the tests from
your favorite Java IDE (Eclipse, IntelliJ, VSCode, &#8230;&#8203;) and as part of your software build process (Maven or Gradle). The Citrus
tests become repeatable and give you fully automated integration tests to ensure software quality and interface stability.</p>
</div>
<div class="paragraph">
<p>The following reference guide walks through all Citrus capabilities and shows how to have a great integration test experience.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setup"><a class="anchor" href="#setup"></a><a class="link" href="#setup">3. Setup</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter discusses how to get started with Citrus. It deals with the installation and set up of the framework, so you
are ready to start writing test cases after reading this chapter.</p>
</div>
<div class="paragraph">
<p>Usually you add Citrus as a test-scoped dependency library in your project. Build tools like Maven or Gradle provide standard
integration for test libraries such as Citrus. As Citrus tests are nothing but normal unit tests (JUnit, TestNG, Cucumber)
you can run the tests with the standard unit test build integration (e.g. via maven-failsafe plugin).</p>
</div>
<div class="paragraph">
<p>This chapter describes the Citrus project setup possibilities, choose one of them that fits best to include Citrus into your project.</p>
</div>
<div class="sect2">
<h3 id="setup-maven"><a class="anchor" href="#setup-maven"></a><a class="link" href="#setup-maven">3.1. Maven</a></h3>
<div class="paragraph">
<p>Citrus uses <a href="https://maven.apache.org/">Maven</a> internally as a project build tool and provides extended support for Maven projects.
Maven will ease up your life as it manages project dependencies and provides extended build life cycles and conventions for
compiling, testing, packaging and installing your Java project.</p>
</div>
<div class="paragraph">
<p>In case you already use Maven in your project you can just add Citrus as a test-scoped dependency.</p>
</div>
<div class="paragraph">
<p>As Maven handles all project dependencies automatically you do not need to download any Citrus project artifacts in advance.
If you are new to Maven please refer to the official Maven documentation and find out how to <a href="https://maven.apache.org/">set up a Maven project</a>.</p>
</div>
<div class="paragraph">
<p>Assuming you have a proper Maven project setup you can integrate Citrus with it. Just add the Citrus project dependencies
in your Maven pom.xml as a dependency like follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We add Citrus as test-scoped project dependency to the project POM (pom.xml)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Add Citrus base dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-base&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
  &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The dependency above adds the base functionality of Citrus. You need to add modules as you require them.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Add modules as required in your project. For instance Http support</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-http&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
  &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Choose test runtime (JUnit, TestNG, Cucumber) that is used to run the tests.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-testng&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
  &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Citrus integrates nicely with the <a href="https://spring.io/projects/spring-framework">Spring framework</a>.
In case you want to use the Spring dependency injection and bean configuration capabilities just
add the Spring support in Citrus.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Add Spring support</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-spring&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
  &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Also, Citrus provides a Maven plugin that you can add. The plugin provides some convenience functionalities such
as creating new tests from command line.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Add Citrus Maven plugin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;plugin&gt;
  &lt;groupId&gt;org.citrusframework.mvn&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-maven-plugin&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
  &lt;configuration&gt;
    &lt;author&gt;Donald Duck&lt;/author&gt;
    &lt;targetPackage&gt;org.citrusframework&lt;/targetPackage&gt;
  &lt;/configuration&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Maven project is now ready to use Citrus. You can start writing new test cases with the Citrus Maven plugin:</p>
</div>
<div class="listingblock">
<div class="title">Create new test</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">mvn citrus:create-test</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command above starts an interactive command line interface that helps you to create a test.</p>
</div>
<div class="paragraph">
<p>Once you have written the Citrus test cases you can execute them automatically in your Maven software build lifecycle.
The tests will be included into your project&#8217;s integration-test phase using the Maven failsafe plugin. Here is a sample
failsafe configuration for Citrus.</p>
</div>
<div class="listingblock">
<div class="title">Maven failsafe plugin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;plugin&gt;
  &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
  &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt;
  &lt;version&gt;${maven.failsafe.version}&lt;/version&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;id&gt;integration-tests&lt;/id&gt;
      &lt;goals&gt;
        &lt;goal&gt;integration-test&lt;/goal&gt;
        &lt;goal&gt;verify&lt;/goal&gt;
      &lt;/goals&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Citrus test sources go to the default Maven test source directory <code>src/test/java</code> and <code>src/test/resources</code>.</p>
</div>
<div class="paragraph">
<p>You are now ready to call the usual Maven <strong>verify</strong> goal (<code>mvn verify</code>) in order to build your project and run the tests.
The Citrus integration tests are executed automatically during the build process.</p>
</div>
<div class="listingblock">
<div class="title">Run all tests with Maven</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">mvn verify</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Run single test by its name</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">mvn verify -Dit.test=MyFirstCitrusIT</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The Maven failsafe plugin by default executes tests with specific name pattern. This is because integration
tests should not execute in Maven unit test phase, too. Your integration tests should follow
the failsafe name pattern with each test name beginning or ending with <strong>'IT'</strong>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you need additional assistance in setting up a Citrus Maven project please visit our Maven setup tutorial
on <a href="https://citfrusframework.org">https://citrusframework.org/tutorials.html</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="setup-gradle"><a class="anchor" href="#setup-gradle"></a><a class="link" href="#setup-gradle">3.2. Gradle</a></h3>
<div class="paragraph">
<p>As Citrus tests are nothing but normal JUnit or TestNG tests the integration to Gradle as build tool is as easy as adding
the source files to a folder in your project. With the Gradle task execution for integration tests you are able to execute
the Citrus tests like you would do with normal unit tests.</p>
</div>
<div class="paragraph">
<p>The Gradle build configuration goes to the <strong>build.gradle</strong> and <strong>settings.gradle</strong> files. The files define the project name
and the project version.</p>
</div>
<div class="listingblock">
<div class="title">Gradle project configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">rootProject.name = 'citrus-sample-gradle'
group 'org.citrusframework.samples'
version '${citrus.version}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Citrus libraries are available on Maven central repository. This means you should add this repository so Gradle knows
how to download the required Citrus artifacts.</p>
</div>
<div class="listingblock">
<div class="title">Add Maven central repository</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">repositories {
    mavenCentral()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus stable release versions are available on Maven central. Now let&#8217;s move on with adding the Citrus libraries to the project.</p>
</div>
<div class="listingblock">
<div class="title">Add Citrus test scoped dependencies</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">dependencies {
    testCompile group: 'org.citrusframework', name: 'citrus-base', version: '${citrus.version}'
    testCompile group: 'org.citrusframework', name: 'citrus-http', version: '${citrus.version}'
    testCompile group: 'org.testng', name: 'testng', version: '${testng.version}'
    [...]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus provides various modules that encapsulate different functionalities. The <code>citrus-base</code> module is the basis and holds core functionality. In addition, you may
add further modules that match your project needs (e.g. add Http support with <code>citrus-http</code>).</p>
</div>
<div class="paragraph">
<p>As a runtime the project chose to use TestNG. You can also use JUnit or Cucumber as a test runtime. Each of those frameworks integrates seamlessly with the Gradle build.</p>
</div>
<div class="listingblock">
<div class="title">Choose test runtime provider</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">test {
    useTestNG()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course JUnit is also supported. This completes the Gradle build configuration settings. You can move on to writing some Citrus integration tests and add those to <strong>src/test/java</strong> directory.</p>
</div>
<div class="paragraph">
<p>You can use the Gradle wrapper for compile, package and test the sample with Gradle build command line.</p>
</div>
<div class="listingblock">
<div class="title">Run the build with Gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">gradlew clean build</code></pre>
</div>
</div>
<div class="paragraph">
<p>This executes all Citrus test cases during the build. You will be able to see Citrus performing some integration test logging output.</p>
</div>
<div class="paragraph">
<p>If you just want to execute all tests you can call:</p>
</div>
<div class="listingblock">
<div class="title">Run all tests</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">gradlew clean check</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, you can also run the Citrus tests from your favorite Java IDE. Just start the Citrus test as a normal unit test
using the Gradle integration in IntelliJ, Eclipse or VSCode.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="runtimes"><a class="anchor" href="#runtimes"></a><a class="link" href="#runtimes">4. Runtimes</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Citrus test case is nothing but a normal Java unit test.
Citrus integrates with standard unit test frameworks such as <a href="https://junit.org">JUnit</a>,
<a href="https://testng.org">TestNG</a> or <a href="https://cucumber.io">Cucumber</a> as a runtime.</p>
</div>
<div class="paragraph">
<p>In addition to that Citrus also works with <code>@QuarkusTest</code> and <code>@SpringBootTest</code> annotated classes.</p>
</div>
<div class="paragraph">
<p>Most Java developers are familiar with at least one of the standard tools.
Everything you can do with JUnit or TestNG you can do with Citrus tests, too.
For instance, you can integrate the Citrus tests in a Maven build, run and debug Citrus from your favorite Java IDE or include Citrus tests into a continuous build pipeline.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Why is Citrus integrating with unit test frameworks such as JUnit, although Citrus represents a framework for integration testing?
The answer to this question is quite simple: Citrus benefits a lot from standard libraries such as JUnit and TestNG for Java test execution.
The standard unit testing frameworks provide great tooling support and are widely supported by other components (e.g. continuous build tools, Maven build lifecycle, development IDEs).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Each runtime in Citrus supports polyglot test writing.
You can choose from a set of supported programming languages and domain specific languages (DSL) to write your tests.
Currently supported languages in Citrus are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#run-java">Java</a></p>
</li>
<li>
<p><a href="#run-xml-tests">XML</a></p>
</li>
<li>
<p><a href="#run-yaml-tests">YAML</a></p>
</li>
<li>
<p><a href="#runtimes-cucumber">Cucumber (Gherkin)</a></p>
</li>
<li>
<p><a href="#run-groovy">Groovy</a></p>
</li>
<li>
<p><a href="#run-spring-xml-tests">Spring XML</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Citrus <a href="#run-java">Java</a> DSL represents the most powerful way to write tests.
Citrus provides a set of classes and methods to leverage the test code in form of a fluent API.
Users can simply configure a test action with the different options using a fluent builder pattern style DSL.</p>
</div>
<div class="paragraph">
<p>In addition to that you can also write Citrus tests with <a href="#run-xml-tests">XML</a>, <a href="#run-groovy">Groovy</a>, <a href="#run-yaml-tests">YAML</a>,
<a href="#runtimes-cucumber">Cucumber (Gherkin)</a>, <a href="#run-spring-xml-tests">Spring XML</a> declaration files that get loaded as part of the test runtime.
These test sources represent a more declarative approach of writing tests in Citrus.
You do not necessarily need to know how to code Java when using one of these languages, but you may be limited in terms of customization opportunities.</p>
</div>
<div class="paragraph">
<p>See the following example to explore the different test source languages in Citrus.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void helloWorldTest() {
    variable("user", "Citrus");

    $(echo().message("Hello from ${user}!"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="HelloWorldTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;variables&gt;
      &lt;variable name="user" value="Citrus"/&gt;
    &lt;/variables&gt;
    &lt;actions&gt;
      &lt;echo message="Hello from ${user}!"/&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: HelloWorldTest
variables:
  - name: user
    value: Citrus
actions:
  - echo:
      message: "Hello from ${user}!"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">name "HelloWorldTest"

variables {
   user="Citrus"
}

actions {
    $(echo().message('Hello from ${user}!'))
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Cucumber</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Feature: HelloWorldTest

  Background:
    Given variables
      | user | Citrus |

  Scenario: Should Say Hello
    Then print "Hello from ${user}!"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;
  &lt;testcase name="HelloWorldTest"&gt;
    &lt;variables&gt;
      &lt;variable name="user" value="Citrus"/&gt;
    &lt;/variables&gt;
    &lt;actions&gt;
      &lt;echo&gt;
        &lt;message&gt;Hello from ${user}!&lt;/message&gt;
      &lt;/echo&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sample above is a very simple Citrus test that creates a test variable and prints a message to the console.
You can see the different programming language and data formats that you can choose to write the test.
Citrus provides lots of different test actions that are ready to solve also complex test scenarios and challenges.</p>
</div>
<div class="paragraph">
<p>Each runtime supports the polyglot testing languages Java, XML, YAML, Groovy, Cucumber.
This documentation tries to provide proper sample code for all supported test languages.</p>
</div>
<div class="paragraph">
<p>The following sections have a closer look at the different runtimes for Citrus.</p>
</div>
<div class="sect2">
<h3 id="runtime-testng"><a class="anchor" href="#runtime-testng"></a><a class="link" href="#runtime-testng">4.1. TestNG</a></h3>
<div class="paragraph">
<p><a href="https://testng.org">TestNG</a> stands for next generation testing and has had a great influence in adding Java annotations to the unit test community.
Citrus is able to define tests as executable TestNG Java classes.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The TestNG support is shipped in a separate Maven module. You need to include the module as a dependency in your
project.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">TestNG module dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-testng&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="testng-tests"><a class="anchor" href="#testng-tests"></a><a class="link" href="#testng-tests">4.1.1. TestNG tests</a></h4>
<div class="paragraph">
<p>See the following sample showing how to write a Citrus test on top of TestNG:</p>
</div>
<div class="listingblock">
<div class="title">TestNG Citrus test</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.citrusframework.samples;

import org.testng.annotations.Test;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.testng.TestNGCitrusSupport;

@Test
public class Simple_IT extends TestNGCitrusSupport implements TestActionSupport {

    @CitrusTest(name = "Simple_IT")
    public void simpleTest() {
        description("First example showing the basic Java DSL!");

        given(
            variable("user", "Citrus")
        );

        then(
            echo().message("Hello ${user}!"
        ));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are familiar with TestNG you will see that the Java class is a normal TestNG test class using the usual
<code>@Test</code> annotation. For convenience reasons you can extend a basic Citrus TestNG base class <code>TestNGCitrusSupport</code> which
enables the Citrus test execution as well as the Java DSL features for us.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can also combine Citrus with the Spring framework and its dependency injection and IoC capabilities. In order to
enable Spring support in Citrus add the <code>citrus-spring</code> module to your project and extend <code>TestNGCitrusSpringSupport</code> as a
base class. With the Spring support in Citrus the test is able to use <code>@Autowired</code> annotations for injecting Spring beans into the
test class and you can define the Spring application context with <code>@Configuration</code> annotations for instance.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In addition, the test methods use the <strong>@CitrusTest</strong> annotation which allows setting properties such as test names and packages.</p>
</div>
<div class="paragraph">
<p>The Citrus test logic goes directly as the method body with using the Citrus Java domain specific language features. As you
can see the Java DSL is able to follow BDD (Behavior Drive Design) principles with Given-When-Then syntax. As an alternative
to that you can just use <code>run()</code> for all test actions.</p>
</div>
<div class="listingblock">
<div class="title">Pure test action DSL</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest(name = "Simple_IT")
public void simpleTest() {
    description("First example showing the basic Java DSL!");

    run(variable("user", "Citrus"));

    run(
        echo().message("Hello ${user}!"
    ));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The great news is that you can still use the awesome TestNG features in with the Citrus test class (e.g. parallel test
execution, test groups, setup and tear down operations and so on). Just to give an example we can simply add a test group
to our test like this:</p>
</div>
<div class="listingblock">
<div class="title">Set test groups</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Test(groups = {"long-running"})
public void longRunningTest() {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information on TestNG please visit the <a href="https://testng.org">official TestNG website</a>, where you find a complete
reference documentation. The following sections deal with a subset of these TestNG features in particular.</p>
</div>
</div>
<div class="sect3">
<h4 id="testng-dataproviders"><a class="anchor" href="#testng-dataproviders"></a><a class="link" href="#testng-dataproviders">4.1.2. Use TestNG data providers</a></h4>
<div class="paragraph">
<p>TestNG as a framework comes with lots of great features such as data providers. Data providers execute a test case several
times with different test data. Each test execution works with a specific parameter value. You can use data provider
parameter values as test variables in Citrus. See the next listing on how to use TestNG data providers in Citrus:</p>
</div>
<div class="listingblock">
<div class="title">TestNG Citrus data provider test</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class DataProviderIT extends TestNGCitrusSupport implements TestActionSupport {

    @CitrusTest
    @CitrusParameters({"message", "delay"})
    @Test(dataProvider = "messageDataProvider")
    public void dataProvider(String message, Long sleep) {
        run(echo(message));
        run(sleep().milliseconds(sleep));

        run(echo("${message}"));
        run(echo("${delay}"));
    }

    @DataProvider
    public Object[][] messageDataProvider() {
        return new Object[][] {
                { "Hello World!", 300L },
                { "Citrus rocks!", 1000L },
                { "Hi from Citrus!", 500L },
        };
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Above test case method is annotated with TestNG data provider called <strong>messageDataProvider</strong> . In the same class you can write
the data provider that returns a list of parameter values. TestNG will execute the test case several times according to the
provided parameter list. Each execution is shipped with the respective parameter value.</p>
</div>
<div class="paragraph">
<p>According to the <strong>@CitrusParameter</strong> annotation the test will have test variables called <code>message</code> and <code>delay</code>.</p>
</div>
<div class="sect4">
<h5 id="testng-dataproviders-sharded"><a class="anchor" href="#testng-dataproviders-sharded"></a><a class="link" href="#testng-dataproviders-sharded">With Sharding</a></h5>
<div class="paragraph">
<p>TestNG data provider based tests can additionally be run in a distributed manner, facilitating test sharding.
The following snipped showcases you how to get started within a Spring test case environment.</p>
</div>
<div class="listingblock">
<div class="title">Sharded TestNG Citrus data provider test</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import static org.citrusframework.common.TestLoader.SPRING;
import static org.citrusframework.sharding.Shard.createShard;

import org.citrusframework.annotations.CitrusTestSource;
import org.citrusframework.testng.CitrusParameters;
import org.citrusframework.testng.spring.TestNGCitrusSpringSupport;
import org.testng.annotations.DataProvider;
import org.testng.annotations.Test;

public class DataProviderIT extends TestNGCitrusSupport implements TestActionSupport {

    @CitrusParameters({"message", "delay"})
    @Test(dataProvider = "messageDataProvider")
    @CitrusTestSource(type = SPRING, name = "DataProviderIT")
    public void dataProvider(String message, Long sleep) {
        run(echo(message));
        run(sleep().milliseconds(sleep));
    }

    @DataProvider("messageDataProvider")
    public Object[][] messageDataProvider() {
        return createShard(
            new Object[][] {
                { "Hello World!", 300L },
                { "Citrus rocks!", 1000L },
                { "Hi from Citrus!", 500L },
            }
        );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All the available configuration options are documented withing the chapter <a href="#runtime-sharded">Sharding Test Cases</a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="testng-parallel"><a class="anchor" href="#testng-parallel"></a><a class="link" href="#testng-parallel">4.1.3. Run tests in parallel</a></h4>
<div class="paragraph">
<p>Integration tests tend to be more time-consuming compared to pure unit tests when it comes to execute tests. This is because
integration tests often need to initialize test infrastructure (e.g. test servers, database connections). Running tests
in parallel can reduce the overall test suite time a lot.</p>
</div>
<div class="paragraph">
<p>When running tests in parallel you need to make sure each test operates on its own set of resources. Tests must not share
components such as the Citrus Java DSL test action runner or the test context.</p>
</div>
<div class="paragraph">
<p>You should be using the resource injection to make sure each test operates on its own resources.</p>
</div>
<div class="listingblock">
<div class="title">Resource injection</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class ResourceInjection_IT extends TestNGCitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void injectResources(@Optional @CitrusResource TestCaseRunner runner,
                                @Optional @CitrusResource TestContext context) {

        runner.given(
            createVariable("random", "citrus:randomNumber(10)")
        );

        runner.run(
            echo("The random number is: ${random}")
        );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>First of all the method parameters must be annotated with <code>@Optional</code> because the values are not injected by TestNG itself
but by the Citrus base test class. Finally, the parameter requires the <code>@CitrusResource</code> annotation in order to mark the
parameter for Citrus resource injection.</p>
</div>
<div class="paragraph">
<p>Now each method uses its own resource instances which makes sure that parallel test execution can take place without having
the risk of side effects on other tests running at the same time. Of course, you also need to make sure that the message
exchange in your tests is ready to be performed in parallel (e.g. use message selectors).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="runtime-junit5"><a class="anchor" href="#runtime-junit5"></a><a class="link" href="#runtime-junit5">4.2. JUnit5</a></h3>
<div class="paragraph">
<p>With JUnit version 5 the famous unit test framework offers a new major version. The JUnit platform provides awesome extension
points for other frameworks like Citrus to integrate with the unit testing execution.</p>
</div>
<div class="paragraph">
<p>Citrus provides extensions in order to enable Citrus related dependency injection and parameter resolving in your JUnit5 test.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The JUnit5 support is shipped in a separate Maven module. You need to include the module as a dependency in your
project.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">JUnit5 module dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-junit5&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="junit5-citrus-support"><a class="anchor" href="#junit5-citrus-support"></a><a class="link" href="#junit5-citrus-support">4.2.1. Citrus extension</a></h4>
<div class="paragraph">
<p>You can use the Citrus JUnit5 extension on your test as follows:</p>
</div>
<div class="listingblock">
<div class="title">JUnit5 Citrus test</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.citrusframework.samples;

import org.citrusframework.GherkinTestActionRunner;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.jupiter.CitrusSupport;
import org.junit.jupiter.api.Test;

@CitrusSupport
public class Simple_IT implements TestActionSupport {

    @Test
    @CitrusTest(name = "Simple_IT")
    public void simpleTest(@CitrusResource GherkinTestActionRunner runner) {
        runner.description("First example showing the basic Java DSL!");

        runner.given(
            variable("user", "Citrus")
        );

        runner.then(
            echo().message("Hello ${user}!"
        ));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The class above is using the JUnit5 <code>@Test</code> annotation as a normal unit test would do. The <code>@CitrusSupport</code> annotation marks
the test to use the Citrus JUnit5 extension. This enables us to use the <code>@CitrusTest</code> annotation on the test and adds
support for the parameter injection for the <code>TestActionRunner</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can use the <code>@CitrusSupport</code> annotation, or you can use the classic <code>@ExtendWith(CitrusExtension.class)</code> annotation
to enable the Citrus support for JUnit5.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Citrus Java DSL runner is the entrance to the Java fluent API provided by Citrus. The sample above uses the Gherkin test runner
variation for leveraging the BDD (Behavior Driven Development) style Given-When-Then syntax.</p>
</div>
<div class="paragraph">
<p>The test class implements the interface <code>TestActionSupport</code> which holds all available test actions in Citrus.
You can choose from a wide range of actions.
The provided test action API uses fluent style build pattern to define the test action and its properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>TestActionSupport</code> interface brings quite a lot of methods. In case you are facing issues with one of these methods colliding with your own test methods you can choose from a modular interface hierarchy that builds the Citrus Java test actions API. Instead of implementing the whole <code>TestActionSupport</code> API you may just implement the <code>BaseTestActionSupport</code> API or the very specific <code>HttpTestActionSupport</code> interface in your test. Just look for the <code>*TestActionSupport</code> interfaces provided by Citrus and include what you need into your test class.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For those of you who are not able to use the <code>TestActionSupport</code> or other API interfaces the <strong>DefaultTestActions</strong> class also provides access to the test actions Java DSL API.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">JUnit5 Citrus test</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.citrusframework.samples;

import org.citrusframework.DefaultTestActions;
import org.citrusframework.GherkinTestActionRunner;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.jupiter.CitrusSupport;
import org.junit.jupiter.api.Test;

@CitrusSupport
public class Simple_IT {

    private final DefaultTestActions actions = new DefaultTestActions();

    @Test
    @CitrusTest(name = "Simple_IT")
    public void simpleTest(@CitrusResource GherkinTestActionRunner runner) {
        runner.description("First example showing the basic Java DSL!");

        runner.given(
            variable("user", "Citrus")
        );

        runner.then(
            actions.echo().message("Hello ${user}!"
        ));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also inject the current <code>TestContext</code> in order to get access to the current test variables used by Citrus.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can also combine Citrus with the Spring framework and its dependency injection and IoC capabilities. In order to
enable Spring support in Citrus add the <code>citrus-spring</code> module to your project and use the <code>@ExtendWith(CitrusSpringExtension.class)</code>
annotation. With the Spring support in Citrus the test is able to load components via the Spring application context.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="junit5-endpoint-injection"><a class="anchor" href="#junit5-endpoint-injection"></a><a class="link" href="#junit5-endpoint-injection">4.2.2. Endpoint injection</a></h4>
<div class="paragraph">
<p>In addition to injecting test resources you can also inject endpoints via <code>@CitrusEndpoint</code> annotated field injection in
your test class. This enables you to inject endpoint components that are defined in the Citrus context configuration.</p>
</div>
<div class="listingblock">
<div class="title">JUnit5 Citrus endpoint injection</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.citrusframework.samples;

import org.citrusframework.annotations.*;
import org.citrusframework.GherkinTestActionRunner;
import org.citrusframework.junit.jupiter.CitrusSupport;
import org.citrusframework.http.client.HttpClient;
import org.junit.jupiter.api.Test;
import org.springframework.http.HttpStatus;

@CitrusSupport
public class Simple_IT implements TestActionSupport {

    @CitrusEndpoint
    private HttpClient httpClient;

    @Test
    @CitrusTest
    public void test(@CitrusResource GherkinTestActionRunner runner) {
        runner.http().client(httpClient)
                    .send()
                    .get("/hello");

        runner.http().client(httpClient)
                    .receive()
                    .response(HttpStatus.OK.value());
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="junit5-citrus-spring-support"><a class="anchor" href="#junit5-citrus-spring-support"></a><a class="link" href="#junit5-citrus-spring-support">4.2.3. Citrus Spring extension</a></h4>
<div class="paragraph">
<p>Spring is a famous dependency injection framework that also provides support for JUnit5. Citrus is able to load its
components as Spring beans in an application context. The Citrus JUnit5 extension works great with the Spring extension.</p>
</div>
<div class="paragraph">
<p>The Spring extension loads the application context and Citrus adds all components to the Spring bean configuration.</p>
</div>
<div class="listingblock">
<div class="title">JUnit5 Citrus Spring test</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusSpringSupport
@ContextConfiguration(classes = CitrusSpringConfig.class)
public class SpringBean_IT {

    @Autowired
    private DirectEndpoint direct;

    @Test
    @CitrusTest
    void springBeanTest(@CitrusResource TestActionRunner actions) {
        actions.$(send().endpoint(direct)
                    .message()
                    .body("Hello from Citrus!"));

        actions.$(receive().endpoint(direct)
                    .message()
                    .body("Hello from Citrus!"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test now uses the <code>@CitrusSpringSupport</code> annotation which combines the <code>@ExtendWith(CitrusSpringExtension.class)</code>
and <code>@ExtendWith(SpringExtension.class)</code> annotation. This way the test combines the Spring application context management with
the Citrus Java DSL functionality.</p>
</div>
<div class="paragraph">
<p>You can load Spring beans with <code>@Autowired</code> into your test.
Also, you can use the <code>@CitrusResource</code> annotations to inject the test action runner fluent Java API.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The Spring application context should use the basic <code>CitrusSpringConfig</code> configuration class to load all Citrus components as Spring beans.
You can customize the Spring application context by adding more configuration classes.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="junit5-test-sharding"><a class="anchor" href="#junit5-test-sharding"></a><a class="link" href="#junit5-test-sharding">4.2.4. Test Sharding</a></h4>
<div class="paragraph">
<p>You can run your JUnit5 test cases in order in a distributed manner, facilitating test sharding.
The following snipped showcases you how to get started within a Spring/XML test case environment.
Note that sharding is available with all kind of <code>Stream</code>-sources.</p>
</div>
<div class="listingblock">
<div class="title">Sharded JUnit5 Spring/XML test</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import static org.citrusframework.junit.jupiter.CitrusTestFactorySupport.springXml;
import static org.citrusframework.sharding.Shard.createShard;

import org.citrusframework.config.CitrusSpringConfig;
import org.citrusframework.junit.jupiter.spring.CitrusSpringSupport;
import org.citrusframework.junit.jupiter.spring.CitrusSpringXmlTestFactory;
import org.springframework.test.context.ContextConfiguration;

@CitrusSpringSupport
@ContextConfiguration(classes = {CitrusSpringConfig.class})
class SpringBeanXml_IT {

    @CitrusSpringXmlTestFactory
    Stream&lt;DynamicTest&gt; shardedSpringBeanXml_IT() {
        return createShard(
            springXml().packageScan("org.citrusframework.junit.jupiter.simple")
        );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All the available configuration options are documented withing the chapter <a href="#runtime-sharded">Sharding Test Cases</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="runtime-junit4"><a class="anchor" href="#runtime-junit4"></a><a class="link" href="#runtime-junit4">4.3. JUnit4</a></h3>
<div class="paragraph">
<p>JUnit4 is still very popular and widely supported by many tools even though there is a new major version with JUnit5 already
available. In general Citrus supports both JUnit4 and JUnit5 as test execution framework.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The JUnit4 support is shipped in a separate Maven module. You need to include the module as a dependency in your
project.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">JUnit4 module dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-junit&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="junit4-tests"><a class="anchor" href="#junit4-tests"></a><a class="link" href="#junit4-tests">4.3.1. JUnit4 tests</a></h4>
<div class="paragraph">
<p>See the following sample test class that uses JUnit4.</p>
</div>
<div class="listingblock">
<div class="title">JUnit4 Citrus test</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.citrusframework.samples;

import org.junit.Test;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.JUnit4CitrusSupport;

public class Simple_IT extends JUnit4CitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest(name = "Simple_IT")
    public void simpleTest() {
        description("First example showing the basic Java DSL!");

        given(
            variable("user", "Citrus")
        );

        then(
            echo().message("Hello ${user}!"
        ));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The simple test class above uses the normal <code>@Test</code> annotation and extends the base class <code>JUnit4CitrusSupport</code>. This is
the most convenient way to access the Citrus Java DSL capabilities. As an alternative you may switch to using the
<code>CitrusJUnit4Runner</code> in your test class.</p>
</div>
<div class="paragraph">
<p>The fine thing here is that we are still able to use all JUnit features such as before/after hooks or ignoring tests.</p>
</div>
<div class="paragraph">
<p>After the test run the result is reported exactly like a usual JUnit unit test would do. This also means that
you can execute this Citrus JUnit class like every other JUnit test, especially out of any Java IDE, with Maven, with Gradle and so on.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can also combine Citrus with the Spring framework and its dependency injection and IoC capabilities. In order to
enable Spring support in Citrus add the <code>citrus-spring</code> module to your project and extend <code>JUnit4CitrusSpringSupport</code> as a
base class. With the Spring support in Citrus the test is able to use <code>@Autowired</code> annotations for injecting Spring beans into the
test class. You can define the Spring application context with <code>@Configuration</code> annotations as part of the Spring support.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The test class implements the interface <code>TestActionSupport</code> which holds all available test actions in Citrus.
You can choose from a wide range of actions.
The provided test action API uses fluent style build pattern to define the test action and its properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>TestActionSupport</code> interface brings quite a lot of methods. In case you are facing issues with one of these methods colliding with your own test methods you can choose from a modular interface hierarchy that builds the Citrus Java test actions API. Instead of implementing the whole <code>TestActionSupport</code> API you may just implement the <code>BaseTestActionSupport</code> API or the very specific <code>HttpTestActionSupport</code> interface in your test. Just look for the <code>*TestActionSupport</code> interfaces provided by Citrus and include what you need into your test class.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For those of you who are not able to use the <code>TestActionSupport</code> or other API interfaces the <strong>TestNGCitrusSupport</strong> and <strong>JUnit4CitrusSupport</strong> base classes also provide a method called <code>actions()</code> that provides access to the test actions Java DSL API.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="junit4-parallel"><a class="anchor" href="#junit4-parallel"></a><a class="link" href="#junit4-parallel">4.3.2. Run tests in parallel</a></h4>
<div class="paragraph">
<p>Integration tests tend to be more time-consuming compared to pure unit tests when it comes to execute tests. This is because
integration tests often need to initialize test infrastructure (e.g. test servers, database connections). Running tests
in parallel can reduce the overall test suite time a lot.</p>
</div>
<div class="paragraph">
<p>When running tests in parallel you need to make sure each test operates on its own set of resources. Tests must not share
components such as the Citrus Java DSL test action runner or the test context.</p>
</div>
<div class="paragraph">
<p>You should be using the resource injection to make sure each test operates on its own resources.</p>
</div>
<div class="listingblock">
<div class="title">Resource injection</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class ResourceInjection_IT extends JUnit4CitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void injectResources(@CitrusResource TestCaseRunner runner,
                                @CitrusResource TestContext context) {

        runner.given(
            createVariable("random", "citrus:randomNumber(10)")
        );

        runner.run(
            echo("The random number is: ${random}")
        );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The method parameters require the <code>@CitrusResource</code> annotations in order to mark the parameter for Citrus resource injection.</p>
</div>
<div class="paragraph">
<p>Now each method uses its own resource instances which makes sure that parallel test execution can take place without having
the risk of side effects on other tests running at the same time. Of course, you also need to make sure that the message
exchange in your tests is ready to be performed in parallel (e.g. use message selectors).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="runtime-quarkus"><a class="anchor" href="#runtime-quarkus"></a><a class="link" href="#runtime-quarkus">4.4. QuarkusTest</a></h3>
<div class="paragraph">
<p>Quarkus has emerged into a popular enterprise Java framework.
For unit and integration testing the Quarkus framework provides integrations with JUnit Jupiter.
Citrus adds a Quarkus test resource implementation that allows developers to combine Citrus with Quarkus during testing.
You can use the Citrus test resource annotations on your Quarkus tests and include Citrus capabilities into arbitrary Quarkus tests.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Citrus QuarkusTest extension is shipped in a separate Maven module. You need to include the module as a dependency in your project accordingly.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Citrus Quarkus module dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-quarkus&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Usually a Quarkus test is annotated with the <code>@QuarkusTest</code> or <code>QuarkusIntegrationTest</code> annotation.
Users just add an annotation named <code>@CitrusSupport</code> to also enable Citrus capabilities on the test.</p>
</div>
<div class="paragraph">
<p>The Citrus support will automatically hook into the QuarkusTest lifecycle management to inject Citrus resources with <code>@CitrusResource</code> annotation.
Also, the Citrus extension makes sure to start a proper Citrus instance and call before/after suite and before/after test handlers.</p>
</div>
<div class="paragraph">
<p>This way you are able to combine Citrus with <code>@QuarkusTest</code> annotated classes very easily.</p>
</div>
<div class="listingblock">
<div class="title">Enable Citrus support on QuarkusTest</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.test.junit.QuarkusTest;
import org.citrusframework.TestActionSupport;
import org.citrusframework.TestCaseRunner;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.quarkus.CitrusSupport;
import org.junit.jupiter.api.Test;

@QuarkusTest
@CitrusSupport
public class DemoApplicationTest implements TestActionSupport {

    @CitrusFramework
    private Citrus citrus;

    @CitrusResource
    private TestCaseRunner t;

    @CitrusResource
    private TestContext context;

    @Test
    void shouldVerifyDemoApp() {
        t.when(
            send()
                .endpoint("messageEndpoint")
                .message()
                .body("How about Citrus!?")
        );

        t.when(
            receive()
                .endpoint("messageEndpoint")
                .message()
                .body("Citrus rocks!")
        );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@CitrusSupport</code> annotation enables the Citrus features on the test.
First of all users may inject Citrus related resources such as <code>TestCaseRunner</code> or the <code>TestContext</code>.</p>
</div>
<div class="paragraph">
<p>As usual the <code>TestCaseRunner</code> is the entrance to the Citrus domain specific language for running arbitrary Citrus actions as part of the test.</p>
</div>
<div class="paragraph">
<p>The test class implements the interface <code>TestActionSupport</code> which holds all available test actions in Citrus.
You can choose from a wide range of actions.
The provided test action API uses fluent style build pattern to define the test action and its properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>TestActionSupport</code> interface brings quite a lot of methods. In case you are facing issues with one of these methods colliding with your own test methods you can choose from a modular interface hierarchy that builds the Citrus Java test actions API. Instead of implementing the whole <code>TestActionSupport</code> API you may just implement the <code>BaseTestActionSupport</code> API or the very specific <code>HttpTestActionSupport</code> interface in your test. Just look for the <code>*TestActionSupport</code> interfaces provided by Citrus and include what you need into your test class.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="runtime-quarkus-endpoint-config"><a class="anchor" href="#runtime-quarkus-endpoint-config"></a><a class="link" href="#runtime-quarkus-endpoint-config">4.4.1. Endpoint configuration</a></h4>
<div class="paragraph">
<p>The test is able to configure Message endpoints to connect to different messaging transports as part of the test.</p>
</div>
<div class="listingblock">
<div class="title">Configure message endpoints</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
@CitrusSupport
public class DemoApplicationTest implements TestActionSupport {

    @BindToRegistry
    private final KafkaEndpoint bookings = new KafkaEndpointBuilder()
            .topic("bookings")
            .build();

    @CitrusResource
    private TestCaseRunner t;

    @Test
    void shouldVerifyDemoApp() {
        t.when(
            send()
                .endpoint(bookings)
                .message()
                .body("How about Citrus!?")
        );

        t.when(
            receive()
                .endpoint(bookings)
                .message()
                .body("Citrus rocks!")
        );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Creating new message endpoints is very easy.
Just use the proper endpoint builder and optionally bind the new endpoint to the Citrus bean registry via <code>@BindToRegistry</code> annotation.
You may then use the message endpoint in all <code>send</code> and <code>receive</code> test actions in order to exchange messages.</p>
</div>
<div class="paragraph">
<p>You may move the endpoint configuration into a separate class and load the endpoints with the configuration class as follows:</p>
</div>
<div class="listingblock">
<div class="title">EndpointConfig.class</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class EndpointConfig {

    @BindToRegistry
    public KafkaEndpoint bookings() {
        return new KafkaEndpointBuilder()
            .topic("bookings")
            .build();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The endpoint configuration class uses <code>@BindToRegistry</code> members or methods to add beans to the Citrus registry.
The configuration class may be referenced by many tests then using the <code>@CitrusConfiguration</code> annotation.</p>
</div>
<div class="listingblock">
<div class="title">Load endpoint config classes</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
@CitrusSupport
@CitrusConfiguration(classes = EndpointConfig.class)
public class DemoApplicationTest implements TestActionSupport {

    @CitrusResource
    private KafkaEndpoint bookings;

    @CitrusResource
    private TestCaseRunner t;

    @Test
    void shouldVerifyDemoApp() {
        t.when(
            send()
                .endpoint(bookings)
                .message()
                .body("How about Citrus!?")
        );

        t.when(
            receive()
                .endpoint(bookings)
                .message()
                .body("Citrus rocks!")
        );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus loads the configuration class and injects the <code>KafkaEndpoint</code> instance to the test with <code>@CitrusResource</code>  annotation.</p>
</div>
</div>
<div class="sect3">
<h4 id="runtime-quarkus-dynamic-tests"><a class="anchor" href="#runtime-quarkus-dynamic-tests"></a><a class="link" href="#runtime-quarkus-dynamic-tests">4.4.2. Load dynamic tests</a></h4>
<div class="paragraph">
<p>Citrus supports many test languages besides writing tests in pure Java.
Users can load tests written in XML, YAML, Groovy and many more via dynamic tests.</p>
</div>
<div class="listingblock">
<div class="title">Load YAML tests</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
@CitrusSupport
@CitrusConfiguration(classes = EndpointConfig.class)
public class DemoApplicationTest implements TestActionSupport {

    @CitrusTestFactory
    public Stream&lt;DynamicTest&gt; loadYamlTests() {
        return CitrusTestFactorySupport.factory(TestLoader.YAML).packageScan("some.package.name");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above loads YAML test case definitions and runs those as dynamic tests with JUnit Jupiter.
The package scan loads all files in the given folder and runs the tests via Citrus.
All YAML tests are able to reference the message endpoints configured in the configuration class <code>EndpointConfig.class</code>.</p>
</div>
<div class="paragraph">
<p>A sample YAML test may look like this:</p>
</div>
<div class="listingblock">
<div class="title">my-test.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: my-test
actions:
  - send:
      endpoint: bookings
      message:
        body:
          data: How about Citrus!?
  - receive:
      endpoint: bookings
      timeout: 5000
      message:
        body:
          data: Citrus rocks!</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="runtime-quarkus-application-properties"><a class="anchor" href="#runtime-quarkus-application-properties"></a><a class="link" href="#runtime-quarkus-application-properties">4.4.3. Set application properties</a></h4>
<div class="paragraph">
<p>The <code>@QuarkusTest</code> annotation will automatically start the application under test.
Citrus provides the ability to programmatically set application properties before the Quarkus application is started.
This is important when you need to overwrite configuration based on test message endpoints configured in the test.</p>
</div>
<div class="paragraph">
<p>The next example shows a Citrus enabled Quarkus test that supplies a set of application properties to configure the application under test.</p>
</div>
<div class="listingblock">
<div class="title">Supply application properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
@CitrusSupport(applicationPropertiesSupplier = DemoAppConfigurationSupplier.class)
@CitrusConfiguration(classes = EndpointConfig.class)
public class DemoApplicationTest implements TestActionSupport {

    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>DemoAppConfiguration</code> class implements the <code>Supplier</code> interface and set a config property.
This property will be set on the application under test.</p>
</div>
<div class="listingblock">
<div class="title">DemoAppConfigurationSupplier.class</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class DemoAppConfigurationSupplier implements ApplicationPropertiesSupplier {

    @Override
    public Map&lt;String, String&gt; get() {
        Map&lt;String, String&gt; conf = new Hasmap&lt;&gt;();
        conf.put("quarkus.log.level", "INFO");
        conf.put("greeting.message", "Hello, Citrus rocks!");
        return conf;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The application properties supplier is able to set Quarkus properties as well as application domain properties.
The example above sets <code>greeting.message</code> property which can be referenced in the Quarkus application:</p>
</div>
<div class="listingblock">
<div class="title">DemoApplication</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class DemoApplication {

    private static final Logger logger = Logger.getLogger(DemoApplication.class);

    @ConfigProperty(name = "greeting.message")
    String message;

    void onStart(@Observes StartupEvent ev) {
        logger.info(message);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="runtime-quarkus-testcontainers"><a class="anchor" href="#runtime-quarkus-testcontainers"></a><a class="link" href="#runtime-quarkus-testcontainers">4.4.4. Testcontainers support</a></h4>
<div class="paragraph">
<p>Citrus integrates with Testcontainers to easily start/stop Testcontainers instances as part of the test.
You can leverage the Citrus Testcontainers features within a Quarkus test very easily.
Citrus implements Quarkus test resources for each of the supported containers (AWS LocalStack, Kafka, Redpanda, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>The following example starts an AWS LocalStack Testcontainers instance and uses the S3 service on that container to upload a file to the S3 bucket.
The Quarkus application under test should handle this S3 file then.</p>
</div>
<div class="listingblock">
<div class="title">AwsS3SourceTest</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
@CitrusSupport
@LocalStackContainerSupport(services = LocalStackContainer.Service.S3, containerLifecycleListener = AwsS3SourceTest.class)
public class AwsS3SourceTest implements TestActionSupport, ContainerLifecycleListener&lt;LocalStackContainer&gt; {

    @CitrusResource
    private TestCaseRunner tc;

    @CitrusResource
    private LocalStackContainer localStackContainer;

    @Test
    public void shouldHandleUploadedS3File() {
        tc.given(this::uploadS3File);

        // verify that the Quarkus application has handled the S3 file
    }

    private void uploadS3File(TestContext context) {
        S3Client s3Client = createS3Client(localStackContainer);

        CreateMultipartUploadResponse initResponse = s3Client.createMultipartUpload(b -&gt; b.bucket(s3BucketName).key(s3Key));
        String etag = s3Client.uploadPart(b -&gt; b.bucket(s3BucketName)
                        .key(s3Key)
                        .uploadId(initResponse.uploadId())
                        .partNumber(1),
                RequestBody.fromString(s3Data)).eTag();
        s3Client.completeMultipartUpload(b -&gt; b.bucket(s3BucketName)
                .multipartUpload(CompletedMultipartUpload.builder()
                        .parts(Collections.singletonList(CompletedPart.builder()
                                .partNumber(1)
                                .eTag(etag).build())).build())
                .key(s3Key)
                .uploadId(initResponse.uploadId()));
    }

    @Override
    public Map&lt;String, String&gt; started(LocalStackContainer container) {
        S3Client s3Client = createS3Client(container);

        s3Client.createBucket(b -&gt; b.bucket(s3BucketName));

        Map&lt;String, String&gt; conf = new HashMap&lt;&gt;();
        conf.put("my.app.aws-s3-source.accessKey", container.getAccessKey());
        conf.put("my.app.aws-s3-source.secretKey", container.getSecretKey());
        conf.put("my.app.aws-s3-source.region", container.getRegion());
        conf.put("my.app.aws-s3-source.bucketNameOrArn", s3BucketName);
        conf.put("my.app.aws-s3-source.uriEndpointOverride", container.getServiceEndpoint().toString());
        conf.put("my.app.aws-s3-source.overrideEndpoint", "true");
        conf.put("my.app.aws-s3-source.forcePathStyle", "true");

        return conf;
    }

    private static S3Client createS3Client(LocalStackContainer container) {
        return S3Client.builder()
                .endpointOverride(container.getServiceEndpoint())
                .credentialsProvider(
                        StaticCredentialsProvider.create(
                                AwsBasicCredentials.create(container.getAccessKey(), container.getSecretKey())
                        )
                )
                .forcePathStyle(true)
                .region(Region.of(container.getRegion()))
                .build();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A few things happened in this example and let&#8217;s explain those features one after another.
First thing to notice is the <code>@LocalStackContainerSupport</code> annotation that makes Citrus run the AWS LocalStack Testcontainers instance.
Also, the annotation provides the enabled services on that container (<code>services = LocalStackContainer.Service.S3</code>).
This starts the Testcontainers instance as part of the Quarkus test.</p>
</div>
<div class="paragraph">
<p>The test also implements the <code>ContainerLifecycleListener</code> interface.
This enables the test to handle the container instance after it has been started.
This is a good place to create an S3 client and the bucket for the test.</p>
</div>
<div class="listingblock">
<div class="title">Create S3 client</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
public Map&lt;String, String&gt; started(LocalStackContainer container) {
    S3Client s3Client = createS3Client(container);

    s3Client.createBucket(b -&gt; b.bucket(s3BucketName));

    Map&lt;String, String&gt; conf = new HashMap&lt;&gt;();
    conf.put("my.app.aws-s3-source.accessKey", container.getAccessKey());
    conf.put("my.app.aws-s3-source.secretKey", container.getSecretKey());
    conf.put("my.app.aws-s3-source.region", container.getRegion());
    conf.put("my.app.aws-s3-source.bucketNameOrArn", s3BucketName);
    conf.put("my.app.aws-s3-source.uriEndpointOverride", container.getServiceEndpoint().toString());
    conf.put("my.app.aws-s3-source.overrideEndpoint", "true");
    conf.put("my.app.aws-s3-source.forcePathStyle", "true");

    return conf;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, the started listener may return some application properties that get set for the Quarkus application under test.
This is the opportunity to set the Testcontainers connection settings for the Quarkus application.</p>
</div>
<div class="paragraph">
<p>Obviously the Quarkus application uses some property based configuration with the <code>my.app.*</code> properties.
The test is able to reference the Testcontainers exposed settings as values for these properties (e.g. <code>my.app.aws-s3-source.accessKey=container.getAccessKey()</code>).</p>
</div>
<div class="paragraph">
<p>With this configuration in place the test is able to upload and S3 file to the test bucket on the Testcontainers instance with the <code>uploadS3File()</code> method.
This should trigger the Quarkus application under test to handle the new file accordingly.
We can add some verification and assertion steps to verify that the Quarkus application has handled the S3 file.</p>
</div>
<div class="paragraph">
<p>This is how Citrus is able to start Testcontainers instances as part of a Quarkus test.
The application properties supplier as well as the container lifecycle listener interfaces allow us to connect the Quarkus application with the Testcontainers instance.
The test is able to use the services on the Testcontainers instance to trigger some test data that is consumed by the application under test.</p>
</div>
<div class="paragraph">
<p>Please also have a look into the other provided Testcontainers annotations in Citrus:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@LocalStackContainerSupport</p>
</li>
<li>
<p>@KakfaContainerSupport</p>
</li>
<li>
<p>@RedpandaContainerSupport</p>
</li>
<li>
<p>@TestcontainersSupport</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of these annotations allow you to start Testcontainers instances as part of your Quarkus test and provides the opportunity to participate in the container lifecycle to access managed ports and connectivity settings for instance.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="runtimes-cucumber"><a class="anchor" href="#runtimes-cucumber"></a><a class="link" href="#runtimes-cucumber">4.5. Cucumber</a></h3>
<div class="paragraph">
<p>Behavior driven development (BDD) is a very popular concept when it comes to find a common understanding of test scopes
test logic. The idea of defining and describing the software behavior as basis for all tests in prior to translating those
feature descriptions into executable tests is a very interesting approach because it includes the technical experts as well
as the domain experts.</p>
</div>
<div class="paragraph">
<p>With BDD the domain experts should be able to read and verify tests and the technical experts get a detailed description
of what should happen in the test.</p>
</div>
<div class="paragraph">
<p>The test scenario descriptions follow the Gherkin syntax with a <strong>"Given-When-Then"</strong> structure. The Gherkin language is
business readable and helps to explain business logic with help of concrete examples.</p>
</div>
<div class="paragraph">
<p>There are several frameworks in the Java community supporting BDD concepts. Citrus has dedicated support for the Cucumber
framework because Cucumber is well suited for extensions and plugins. So with the Citrus and Cucumber integration you can
write Gherkin syntax scenarios in order to run those as Citrus integration tests.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Cucumber components in Citrus are located in a separate Maven module. You need to include the module as a Maven
dependency to your project.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Cucumber module dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-cucumber&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cucumber works with both JUnit and TestNG as unit testing framework. You can choose which framework to use with Cucumber.
So following from that we need a Maven dependency for the unit testing framework support:</p>
</div>
<div class="listingblock">
<div class="title">Cucumber JUnit support</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.cucumber&lt;/groupId&gt;
  &lt;artifactId&gt;cucumber-junit&lt;/artifactId&gt;
  &lt;version&gt;${cucumber.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to enable Citrus Cucumber support we need to specify a special object factory in the environment. The most
comfortable way to specify a custom object factory is to add this property to the <code>cucumber.properties</code> in classpath.</p>
</div>
<div class="listingblock">
<div class="title">cucumber.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">cucumber.object-factory=org.citrusframework.cucumber.backend.CitrusObjectFactory</code></pre>
</div>
</div>
<div class="paragraph">
<p>This special object factory takes care of creating all step definition instances. The object factory is able to inject
<code>@CitrusResource</code> annotated fields in step classes. We will see this later on in the examples. The usage of this special
object factory is mandatory in order to combine Citrus and Cucumber capabilities.</p>
</div>
<div class="paragraph">
<p>The <strong>CitrusObjectFactory</strong> will automatically initialize the Citrus world for us. This includes the default Citrus context
configuration that is automatically loaded within the object factory. So you can define and use Citrus components as usual
within your test.</p>
</div>
<div class="paragraph">
<p>After these preparation steps you are able to combine Citrus and Cucumber in your project.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In case you want to use Spring support in Citrus with a Spring application context you should use the following factory
implementation.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">cucumber.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">cucumber.object-factory=org.citrusframework.cucumber.backend.spring.CitrusSpringObjectFactory</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="cucumber-options"><a class="anchor" href="#cucumber-options"></a><a class="link" href="#cucumber-options">4.5.1. Cucumber options</a></h4>
<div class="paragraph">
<p>Cucumber is able to run tests with JUnit. The basic test case is an empty test which uses the respective JUnit runner
implementation from cucumber.</p>
</div>
<div class="listingblock">
<div class="title">MyFeature.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RunWith(Cucumber.class)
@CucumberOptions(
  plugin = { "pretty", "org.citrusframework.cucumber.CitrusReporter" } )
public class MyFeatureIT {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test case above uses the <strong>Cucumber</strong> JUnit test runner. In addition to that we give some options to the Cucumber execution.
In case you want to have the usual Citrus test results reported you can add the special Citrus reporter implementation
<code>org.citrusframework.cucumber.CitrusReporter</code>. This class is responsible for printing the Citrus test summary. This reporter
extends the default Cucumber reporter so the default Cucumber report summary is also printed to the console.</p>
</div>
<div class="paragraph">
<p>That completes the JUnit class configuration. Now we are able to add feature stories and step definitions to the package
of our test <strong>MyFeatureIT</strong> . Cucumber and Citrus will automatically pick up step definitions and glue code in that test
package. So let&#8217;s write a feature story <strong>echo.feature</strong> right next to the <strong>MyFeatureIT</strong> test class.</p>
</div>
<div class="listingblock">
<div class="title">echo.feature</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Feature: Echo service

  Scenario: Say hello
    Given My name is Citrus
    When I say hello to the service
    Then the service should return: "Hello, my name is Citrus!"

  Scenario: Say goodbye
    Given My name is Citrus
    When I say goodbye to the service
    Then the service should return: "Goodbye from Citrus!"</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see this story defines two scenarios with the Gherkin <strong>Given-When-Then</strong> syntax. Now we need to add step definitions
that glue the story description to Citrus test actions. Let&#8217;s do this in a new class <strong>EchoSteps</strong> .</p>
</div>
<div class="listingblock">
<div class="title">EchoSteps.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class EchoSteps {

    @CitrusResource
    private TestCaseRunner runner;

    @Given("^My name is (.*)$")
    public void my_name_is(String name) {
        runner.variable("username", name);
    }

    @When("^I say hello.*$")
    public void say_hello() {
        runner.when(
                send("echoEndpoint")
                    .message()
                    .type(MessageType.PLAINTEXT)
                    .body("Hello, my name is ${username}!"));
    }

    @When("^I say goodbye.*$")
    public void say_goodbye() {
        runner.when(
                send("echoEndpoint")
                    .message()
                    .type(MessageType.PLAINTEXT)
                    .body("Goodbye from ${username}!"));
    }

    @Then("^the service should return: \"([^\"]*)\"$")
    public void verify_return(final String body) {
        runner.then(
                receive("echoEndpoint")
                    .message()
                    .type(MessageType.PLAINTEXT)
                    .body(body));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step definition class is a normal POJO that uses some annotations such as <code>@CitrusResource</code> annotated <code>TestCaseRunner</code>.
The Citrus backend injects the test runner instance at runtime.</p>
</div>
<div class="paragraph">
<p>The step definition contains normal @Given, @When or @Then annotated methods that match the scenario descriptions in our
feature file. Cucumber will automatically find matching methods and execute them. The methods add test actions to the test runner
as we used to do in normal Java DSL tests.</p>
</div>
<div class="paragraph">
<p>That is a first combination of Citrus and Cucumber BDD. The feature file gets translated into step implementations that
use Citrus test action runner Java API to run integration tests with behavior driven development.</p>
</div>
</div>
<div class="sect3">
<h4 id="cucumber-xml-steps"><a class="anchor" href="#cucumber-xml-steps"></a><a class="link" href="#cucumber-xml-steps">4.5.2. Cucumber XML steps</a></h4>
<div class="paragraph">
<p>The previous section handled glue code in Java in form of step definitions accessing the Java test runner fluent API.
This chapter deals with the same concept with just XML configuration.</p>
</div>
<div class="paragraph">
<p>Citrus provides a separate configuration namespace and schema definition for Cucumber related step definitions. Include
this namespace into your Spring configuration in order to use the Citrus Cucumber configuration elements.</p>
</div>
<div class="listingblock">
<div class="title">Spring bean configuration schema</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns:spring="http://www.springframework.org/schema/beans"
     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
     xmlns="http://www.citrusframework.org/schema/cucumber/testcase"
     xsi:schemaLocation="
         http://www.springframework.org/schema/beans
         http://www.springframework.org/schema/beans/spring-beans.xsd
         http://www.citrusframework.org/schema/cucumber/testcase
         http://www.citrusframework.org/schema/cucumber/testcase/citrus-cucumber-testcase.xsd"&gt;

    [...]

&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JUnit Cucumber feature class itself does not change. We still use the Cucumber JUnit runner implementation with some
options specific to Citrus:</p>
</div>
<div class="listingblock">
<div class="title">MyFeatureIT.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RunWith(Cucumber.class)
@CucumberOptions(
    plugin = { "pretty", "org.citrusframework.cucumber.CitrusReporter" } )
public class MyFeatureIT {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The feature file with its Gherkin scenarios does also not change:</p>
</div>
<div class="listingblock">
<div class="title">echo.feature</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Feature: Echo service

  Scenario: Say hello
    Given My name is Citrus
    When I say hello to the service
    Then the service should return: "Hello, my name is Citrus!"

  Scenario: Say goodbye
    Given My name is Citrus
    When I say goodbye to the service
    Then the service should return: "Goodbye from Citrus!"</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the feature package <strong>my.company.features</strong> we add a new XML file <code>EchoSteps.xml</code> that holds the new XML step definitions:</p>
</div>
<div class="listingblock">
<div class="title">EchoSteps.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;spring:beans xmlns:citrus="http://www.citrusframework.org/schema/testcase"
      xmlns:spring="http://www.springframework.org/schema/beans"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns="http://www.citrusframework.org/schema/cucumber/testcase"
      xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/cucumber/testcase
              http://www.citrusframework.org/schema/cucumber/testcase/citrus-cucumber-testcase.xsd"&gt;

  &lt;step given="^My name is (.*)$" parameter-names="username"&gt;
    &lt;citrus:create-variables&gt;
      &lt;citrus:variable name="username" value="${username}"/&gt;
    &lt;/citrus:create-variables&gt;
  &lt;/step&gt;

  &lt;step when="^I say hello.*$"&gt;
    &lt;citrus:send endpoint="echoEndpoint"&gt;
      &lt;citrus:message type="plaintext"&gt;
        &lt;citrus:data&gt;Hello, my name is ${username}!&lt;/citrus:data&gt;
      &lt;/citrus:message&gt;
    &lt;/citrus:send&gt;
  &lt;/step&gt;

  &lt;step when="^I say goodbye.*$"&gt;
    &lt;citrus:send endpoint="echoEndpoint"&gt;
      &lt;citrus:message type="plaintext"&gt;
        &lt;citrus:data&gt;Goodbye from ${username}!&lt;/citrus:data&gt;
      &lt;/citrus:message&gt;
    &lt;/citrus:send&gt;
  &lt;/step&gt;

  &lt;step then="^the service should return: &amp;quot;([^&amp;quot;]*)&amp;quot;$" parameter-names="body"&gt;
    &lt;citrus:receive endpoint="echoEndpoint"&gt;
      &lt;citrus:message type="plaintext"&gt;
        &lt;citrus:data&gt;You just said: ${body}&lt;/citrus:data&gt;
      &lt;/citrus:message&gt;
    &lt;/citrus:receive&gt;
  &lt;/step&gt;

&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above step definition uses pure XML actions. Citrus will automatically read the step definition and add those to the
Cucumber runtime. Following from that the step definitions are executed when matching a statement in the feature story.</p>
</div>
<div class="paragraph">
<p>The XML step files follow a naming convention. Citrus will look for all files located in the feature package with name
pattern <code>**/**.Steps.xml</code> and load those definitions when Cucumber starts up.</p>
</div>
<div class="paragraph">
<p>The XML steps are able to receive parameters from the Gherkin regexp matcher. The parameters are passed to the step as
test variable. The parameter names get declared in the optional attribute <code>parameter-names</code>. In the step definitions you
can use the parameter names as test variables.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The test variables are visible in all upcoming steps, too. This is because the test variables are global by default.
If you need to set local state for a step definition you can use another attribute <code>global-context</code> and set it to <code>false</code>
in the step definition. This way all test variables and parameters are only visible in the step definition. Other steps
will not see the test variables.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Another notable thing is the XML escaping of reserved characters in the pattern definition. You can see that in the
last step where the <strong>then</strong> attribute is escaping quotation characters.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Escape reserved characters</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;step then="^the service should return: &amp;quot;([^&amp;quot;]*)&amp;quot;$" parameter-names="body"&gt;
...
&lt;/step&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have to do this because otherwise the quotation characters will interfere with the XML syntax in the attribute.</p>
</div>
<div class="paragraph">
<p>This completes the description of how to add XML step definitions to the cucumber BDD tests.</p>
</div>
</div>
<div class="sect3">
<h4 id="cucumber-spring"><a class="anchor" href="#cucumber-spring"></a><a class="link" href="#cucumber-spring">4.5.3. Cucumber Spring support</a></h4>
<div class="paragraph">
<p>Cucumber provides support for Spring dependency injection in step definition classes. The Cucumber Spring capabilities
are included in a separate module. So first of all we have to add this dependency to our project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.cucumber&lt;/groupId&gt;
  &lt;artifactId&gt;cucumber-spring&lt;/artifactId&gt;
  &lt;version&gt;${cucumber.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Citrus Cucumber extension has to handle things different when Cucumber Spring support is enabled. Therefore we use
another object factory implementation that also support Cucumber Spring features. Change the object factory property in
<strong>cucumber.properties</strong> to the following:</p>
</div>
<div class="listingblock">
<div class="title">cucumber.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">cucumber.object-factory=org.citrusframework.cucumber.backend.spring.CitrusSpringObjectFactory</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we are ready to add <strong>@Autowired</strong> Spring bean dependency injection to step definition classes:</p>
</div>
<div class="listingblock">
<div class="title">EchoSteps.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ContextConfiguration(classes = CitrusSpringConfig.class)
public class EchoSteps {
    @Autowired
    private Endpoint echoEndpoint;

    @CitrusResource
    protected TestDesigner designer;

    @Given("^My name is (.*)$")
    public void my_name_is(String name) {
        designer.variable("username", name);
    }

    @When("^I say hello.*$")
    public void say_hello() {
        designer.send(echoEndpoint)
            .messageType(MessageType.PLAINTEXT)
            .payload("Hello, my name is ${username}!");
    }

    @When("^I say goodbye.*$")
    public void say_goodbye() {
        designer.send(echoEndpoint)
            .messageType(MessageType.PLAINTEXT)
            .payload("Goodbye from ${username}!");
    }

    @Then("^the service should return: \"([^\"]*)\"$")
    public void verify_return(final String body) {
        designer.receive(echoEndpoint)
            .messageType(MessageType.PLAINTEXT)
            .payload("You just said: " + body);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we used Spring autowiring mechanism for the <strong>echoEndpoint</strong> field in the step definition. Also be sure to
define the <strong>@ContextConfiguration</strong> annotation on the step definition. The Cucumber Spring support loads the Spring application
context and takes care of dependency injection. We use the Citrus <strong>CitrusSpringConfig</strong> Java configuration because this is
the main entrance for Citrus test cases. You can add custom beans and further Spring related configuration to this Spring
application context. If you want to add more beans for autowiring do so in the Citrus Spring configuration. Usually this
is the default <strong>citrus-context.xml</strong> which is automatically loaded.</p>
</div>
<div class="paragraph">
<p>Of course, you can also use a custom Java Spring configuration class here. Please be sure to always import the Citrus
Spring Java configuration classes, too.</p>
</div>
<div class="paragraph">
<p>As usual, we are able to use <strong>@CitrusResource</strong> annotated <strong>TestCaseRunner</strong> fields for building the Citrus integration test
logic. With this extension you can use the full Spring testing power in your tests in particular dependency injection and
also transaction management for data persistence tests.</p>
</div>
</div>
<div class="sect3">
<h4 id="citrus-step-definitions"><a class="anchor" href="#citrus-step-definitions"></a><a class="link" href="#citrus-step-definitions">4.5.4. Predefined step definitions</a></h4>
<div class="paragraph">
<p>Citrus provides a set of predefined step implementations for typical integration test scenarios that you can use out-of-the-box in a Cucumber feature.</p>
</div>
<div class="paragraph">
<p>You can basically define send/receive operations and many other predefined steps to leverage Citrus functionality such as endpoints and test
actions. As these steps are predefined in Citrus you just need to add the step as a line in your feature stories. The step definitions with
the glue to test actions is handled automatically when running Citrus with Cucumber.</p>
</div>
<div class="paragraph">
<p>If you want to enable predefined steps support in your test you need to include the Citrus Cucumber steps module as a Maven dependency.</p>
</div>
<div class="listingblock">
<div class="title">Citrus Cucumber step module dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-cucumber-core&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
  &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that you need to include the glue code package in your test class like this:</p>
</div>
<div class="listingblock">
<div class="title">Include Citrus steps</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RunWith(Cucumber.class)
@CucumberOptions(
    extraGlue = { "org.citrusframework.cucumber" },
    plugin = { "pretty", "org.citrusframework.cucumber.CitrusReporter" } )
public class MyFeatureIT {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of writing the glue code on our own in step definition classes we include the glue package <code>org.citrusframework.cucumber</code>
as extra glue. This automatically loads all predefined Citrus step definitions. Once you have done this you can use predefined
steps without having to write any glue code in Java.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Feature: Hello World

  Scenario: Print Hello World
    Given variable text="Hello World!"
    Then print 'You just said: ${text}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The feature uses the default predefined steps <code>Given variable &lt;name&gt;="&lt;value&gt;"</code> and <code>Then print '&lt;output&gt;'</code> provided by Citrus.</p>
</div>
<div class="paragraph">
<p>The Citrus framework provides many different modules serving many different aspects of integration testing.
You can add those steps with modular dependencies in Maven.
See the following modules with predefined steps provided by Citrus:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Citrus Cucumber step modules</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Module</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus-cucumber-core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard steps such as test variables, sleep/delay, log/print, &#8230;&#8203;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus-cucumber-http</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Http steps for client and server side communication</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus-cucumber-openapi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Load Open API specifications and invoke/verify operations with generated test data</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus-cucumber-kubernetes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manage Kubernetes resources (e.g. pods, deployments, custom resources)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus-cucumber-knative</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Steps to connect with Knative eventing and messaging</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus-cucumber-jms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send/receive steps via JMS queues/topics</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus-cucumber-kafka</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Steps to publish/subscribe on Kafka messaging</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus-cucumber-jdbc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Steps to connect to relational databases</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus-cucumber-camel</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Steps to access Apache Camel components and Camel routes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus-cucumber-selenium</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run UI tests with Selenium using Selenium grid or standalone containers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus-cucumber-groovy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Leverage Groovy scripts as Citrus endpoint and component configuration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus-cucumber-testcontainers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manage Testcontainers instances with starting/stopping databases, message brokers and many more</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Once again it is important to understand that the predefined step definitions included in these modules can be used out-of-the-box.
You can just start to write BDD features in Gherkin syntax that trigger these predefined steps.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you want to include all available step definitions into your project at once you can use the <code>citrus-cucumber-all</code> module dependency.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Include all Citrus Cucumber steps</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-cucumber-all&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
  &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read more about the individual step implementations and their functionality in <a href="#tools-cucumber-steps">Tools - Citrus Cucumber steps</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="runtime-main"><a class="anchor" href="#runtime-main"></a><a class="link" href="#runtime-main">4.6. Main CLI</a></h3>
<div class="paragraph">
<p>Citrus provides a main Java class that you can run from command line.
The Citrus Main CLI class supports some command line arguments that you can use to specify which tests to run.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please also have a look into <a href="#runtime-jbang">Citrus JBang CLI support</a> as it makes running Citrus tests from a command line even more comfortable as it also takes care of setting up Java and the Citrus Maven project for free. With JBang running Citrus tests becomes as easy as running a single file (<code>.java</code>, <code>.xml</code>, <code>.groovy</code>, <code>.yaml</code>) from the command line.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Main CLI support is shipped in a separate Maven module. You need to include the module as a dependency in your
project.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Main CLI module dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-main&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can call the Citrus Main CLI and provide some arguments.</p>
</div>
<div class="listingblock">
<div class="title">Run Citrus main</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">CitrusApp.main(new String[] { "--help" });</code></pre>
</div>
</div>
<div class="paragraph">
<p>This calls the Citrus Main CLI and prints the help message, so you can see which command line arguments you can choose from.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Citrus application option usage:
  -h or --help = Displays cli option usage
  -d or --duration = Maximum time in milliseconds the server should be up and running - server will terminate automatically when time exceeds
  -c or --config = Custom configuration class
  -s or --skipTests = Skip test execution
  -p or --package = Test package to execute
  -D or --properties = Default system properties to set
  --exit = Force system exit when finished
  -e or --engine = Set test engine name used to run the tests
  -t or --test = Test class/method to execute
  -j or --jar = External test jar to load tests from</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>--engine</code> argument specifies which test framework to use when running the tests.
Citrus supports these test engines as an argument value:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JUnit Jupiter (<code>junit5</code> or <code>junit-jupiter</code>)</p>
</li>
<li>
<p>Cucumber (<code>cucumber</code>)</p>
</li>
<li>
<p>TestNG (<code>testng</code>)</p>
</li>
<li>
<p>JUnit 4 (<code>junit</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You may now use <code>--package</code>, <code>--test</code> and <code>--jar</code> to give a Java package name or test class name to run.
With <code>--config</code> you can give a fully qualified class name that points to a Citrus endpoint configuration class.
The configuration class is automatically loaded when the Main CLI is running.</p>
</div>
</div>
<div class="sect2">
<h3 id="runtime-jbang"><a class="anchor" href="#runtime-jbang"></a><a class="link" href="#runtime-jbang">4.7. JBang</a></h3>
<div class="paragraph">
<p>You can easily create and run Citrus tests with <a href="https://www.jbang.dev/">JBang</a>.
The JBang tool support in Citrus is described in more detail in <a href="https://citrusframework.org/citrus/reference/html#runtime-jbang">reference guide</a></p>
</div>
<div class="paragraph">
<p>Running Citrus via JBang does not require any project setup which is a fantastic match for fast prototyping of integration tests.
The JBang command will automatically set up everything you need to run the Citrus test.
This means you can run your test case sources directly from your command line.</p>
</div>
<div class="paragraph">
<p>To initialize a test you can run the script <code>citrus@citrusframework/citrus</code> with the <code>init</code> command as follows:</p>
</div>
<div class="listingblock">
<div class="title">Initialize my-test.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">jbang citrus@citrusframework/citrus init my-test.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command above uses the JBang catalog <code>citrus@citrusframework/citrus</code> located on the <a href="https://github.com/citrusframework/citrus">Citrus GitHub repository</a>.
JBang will automatically resolve all dependencies and execute the command line script tool.
This initializes the Citrus test file.
You will find the created test source file in the current directory.</p>
</div>
<div class="listingblock">
<div class="title">my-test.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: my-test
author: Citrus
status: FINAL
description: Sample test in YAML
variables:
  - name: message
    value: Citrus rocks!
actions:
  - echo:
      message: "${message}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JBang script is able to initialize any supported Citrus test domain specific language <code>.java</code>, <code>.xml</code>, <code>.yaml</code>, <code>.groovy</code> or <code>.feature</code>.</p>
</div>
<div class="paragraph">
<p>You can now run this test source file without any prior project setup using Citrus JBang:</p>
</div>
<div class="listingblock">
<div class="title">Run my-test.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">jbang citrus@citrusframework/citrus run my-test.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command output will be like this:</p>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">INFO 53887 --- [           main] citrusframework.testng.TestNGEngine : Running test source my-test.yaml
INFO 53887 --- [           main] org.testng.internal.Utils           : [TestNG] Running:
INFO 53887 --- [           main] rusframework.report.LoggingReporter :        .__  __
INFO 53887 --- [           main] rusframework.report.LoggingReporter :   ____ |__|/  |________ __ __  ______
INFO 53887 --- [           main] rusframework.report.LoggingReporter : _/ ___\|  \   __\_  __ \  |  \/  ___/
INFO 53887 --- [           main] rusframework.report.LoggingReporter : \  \___|  ||  |  |  | \/  |  /\___ \
INFO 53887 --- [           main] rusframework.report.LoggingReporter :  \___  &gt;__||__|  |__|  |____//____  &gt;
INFO 53887 --- [           main] rusframework.report.LoggingReporter :      \/                           \/
INFO 53887 --- [           main] rusframework.report.LoggingReporter :
INFO 53887 --- [           main] rusframework.report.LoggingReporter : C I T R U S  T E S T S  ${citrus.version}
INFO 53887 --- [           main] rusframework.report.LoggingReporter :
INFO 53887 --- [           main] rusframework.report.LoggingReporter : ------------------------------------------------------------------------
INFO 53887 --- [           main] .citrusframework.actions.EchoAction : Citrus rocks!
INFO 53887 --- [           main] rusframework.report.LoggingReporter :
INFO 53887 --- [           main] rusframework.report.LoggingReporter : TEST SUCCESS my-test (org.citrusframework)
INFO 53887 --- [           main] rusframework.report.LoggingReporter : ------------------------------------------------------------------------
INFO 53887 --- [           main] rusframework.report.LoggingReporter :
INFO 53887 --- [           main] rusframework.report.LoggingReporter :
INFO 53887 --- [           main] rusframework.report.LoggingReporter : CITRUS TEST RESULTS
INFO 53887 --- [           main] rusframework.report.LoggingReporter :
INFO 53887 --- [           main] rusframework.report.LoggingReporter : SUCCESS (     3 ms) my-test
INFO 53887 --- [           main] rusframework.report.LoggingReporter :
INFO 53887 --- [           main] rusframework.report.LoggingReporter : TOTAL:		1
INFO 53887 --- [           main] rusframework.report.LoggingReporter : SUCCESS:	1 (100.0%)
INFO 53887 --- [           main] rusframework.report.LoggingReporter : FAILED:		0 (0.0%)
INFO 53887 --- [           main] rusframework.report.LoggingReporter : PERFORMANCE:	0 ms
INFO 53887 --- [           main] rusframework.report.LoggingReporter :
INFO 53887 --- [           main] rusframework.report.LoggingReporter : ------------------------------------------------------------------------

===============================================
Default Suite
Total tests run: 1, Passes: 1, Failures: 0, Skips: 0
===============================================</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="runtime-jbang-install"><a class="anchor" href="#runtime-jbang-install"></a><a class="link" href="#runtime-jbang-install">4.7.1. Install Citrus JBang app</a></h4>
<div class="paragraph">
<p>For a more convenient command line usage you can install Citrus as a JBang app.</p>
</div>
<div class="listingblock">
<div class="title">Install Citrus as JBang app</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">jbang trust add https://github.com/citrusframework/citrus/
jbang app install citrus@citrusframework/citrus</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can just call <code>citrus</code> and create and run tests with Citrus JBang.</p>
</div>
<div class="listingblock">
<div class="title">Run my-test.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">citrus run my-test.yaml</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="runtime-jbang-run"><a class="anchor" href="#runtime-jbang-run"></a><a class="link" href="#runtime-jbang-run">4.7.2. Run tests</a></h4>
<div class="paragraph">
<p>You can directly run test sources with Citrus JBang.
This includes test sources written in Java (<code>.java</code>), XML (<code>.xml</code>), YAML (<code>.yaml</code>), Groovy (<code>.groovy</code>) or as a Cucumber Gherkin feature file (<code>.feature</code>).</p>
</div>
<div class="sect4">
<h5 id="java-test-sources"><a class="anchor" href="#java-test-sources"></a><a class="link" href="#java-test-sources">Java test sources</a></h5>
<div class="listingblock">
<div class="title">Initialize MyTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">citrus init MyTest.java</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">MyTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.TestCaseRunner;
import org.citrusframework.annotations.CitrusResource;

public class MyTest implements Runnable, TestActionSupport {

    @CitrusResource
    TestCaseRunner t;

    @Override
    public void run() {
        t.given(
            createVariables().variable("message", "Citrus rocks!")
        );

        t.then(
            echo().message("${message}")
        );
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Run MyTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">citrus run MyTest.java</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="xml-test-sources"><a class="anchor" href="#xml-test-sources"></a><a class="link" href="#xml-test-sources">XML test sources</a></h5>
<div class="listingblock">
<div class="title">Initialize my-test.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">citrus init my-test.xml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">my-test.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="EchoTest" author="Christoph" status="FINAL" xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase
            http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;description&gt;Sample test in XML&lt;/description&gt;
  &lt;variables&gt;
    &lt;variable name="message" value="Citrus rocks!"/&gt;
  &lt;/variables&gt;
  &lt;actions&gt;
    &lt;echo message="${message}"/&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Run my-test.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">citrus run my-test.xml</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="yaml-test-sources"><a class="anchor" href="#yaml-test-sources"></a><a class="link" href="#yaml-test-sources">YAML test sources</a></h5>
<div class="listingblock">
<div class="title">Initialize my-test.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">citrus init my-test.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">my-test.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: EchoTest
description: "Sample test in YAML"
variables:
  - name: "message"
    value: "Citrus rocks!"
actions:
  - echo:
      message: "${message}"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Run my-test.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">citrus run my-test.yaml</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="groovy-test-sources"><a class="anchor" href="#groovy-test-sources"></a><a class="link" href="#groovy-test-sources">Groovy test sources</a></h5>
<div class="listingblock">
<div class="title">Initialize my-test.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">citrus init my-test.groovy</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">my-test.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">name "EchoTest"
description "Sample test in Groovy"

variables {
    message="Citrus rocks!"
}

actions {
    $(echo().message('${message}'))
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Run my-test.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">citrus run my-test.groovy</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="cucumber-feature-sources"><a class="anchor" href="#cucumber-feature-sources"></a><a class="link" href="#cucumber-feature-sources">Cucumber feature sources</a></h5>
<div class="listingblock">
<div class="title">Initialize my-test.feature</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">citrus init my-test.feature</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">my-test.feature</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Feature: EchoTest

  Background:
    Given variables
    | message | Citrus rocks! |

  Scenario: Print message
    Then print '${message}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Run my-test.feature</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">jbang --deps org.citrusframework:citrus-cucumber-all:4.8.2 citrus run my-test.feature</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Many of the predefined Cucumber steps (e.g. <code>Then print '&lt;message&gt;'</code>) in Citrus are provided in separate Citrus modules.
You need to add additional project dependencies for that steps to be loaded as part of the JBang script.
The <code>--deps</code> option adds dependencies using Maven artifact coordinates.
You may also add the additional modules to the <code>jbang.properties</code> as described in the next section.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="runtime-jbang-dependencies"><a class="anchor" href="#runtime-jbang-dependencies"></a><a class="link" href="#runtime-jbang-dependencies">4.7.3. Additional JBang dependencies</a></h4>
<div class="paragraph">
<p>Citrus JBang comes with a set of default dependencies that makes the scripts run as tests.</p>
</div>
<div class="paragraph">
<p>The default modules that you can use in Citrus JBang are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>org.citrusframework:citrus-base</p>
</li>
<li>
<p>org.citrusframework:citrus-jbang-connector</p>
</li>
<li>
<p>org.citrusframework:citrus-groovy</p>
</li>
<li>
<p>org.citrusframework:citrus-xml</p>
</li>
<li>
<p>org.citrusframework:citrus-yaml</p>
</li>
<li>
<p>org.citrusframework:citrus-http</p>
</li>
<li>
<p>org.citrusframework:citrus-validation-json</p>
</li>
<li>
<p>org.citrusframework:citrus-validation-yaml</p>
</li>
<li>
<p>org.citrusframework:citrus-validation-xml</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This enables you to run Java, YAML, XML, Groovy tests out of the box.
In case your tests uses an additional feature from the Citrus project you may need to add the module so JBang can load the dependency at startup.</p>
</div>
<div class="paragraph">
<p>The easiest way to do this is to create a <code>jbang.properties</code> file that defines the additional dependencies:</p>
</div>
<div class="listingblock">
<div class="title">jbang.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># Declare required additional dependencies
run.deps=org.citrusframework:citrus-camel:${citrus.version},\
org.citrusframework:citrus-testcontainers:${citrus.version},\
org.citrusframework:citrus-kafka:${citrus.version}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The file above adds the modules <code>citrus-camel</code>, <code>citrus-testcontainers</code> and <code>citrus-kafka</code> so you can use them in your JBang Citrus test source.</p>
</div>
<div class="paragraph">
<p>The <code>jbang.properties</code> file may be located right next to the test source file or in your user home directory for global settings.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
In case you want to run Cucumber BDD Gherkin feature files and use the predefined Citrus steps, you need to add this dependency accordingly: <code>org.citrusframework:citrus-cucumber-all:4.8.2</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="runtime-jbang-clipboard"><a class="anchor" href="#runtime-jbang-clipboard"></a><a class="link" href="#runtime-jbang-clipboard">4.7.4. Run from clipboard</a></h4>
<div class="paragraph">
<p>You can run tests from your current clipboard.
Just use the file name <code>clipboard.xxx</code> where the file extension defines the type of the test source (<code>.java</code>, <code>.yaml</code>, <code>.xml</code>, <code>.groovy</code>, <code>.feature</code>).</p>
</div>
<div class="listingblock">
<div class="title">Run YAML test from Clipboard</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">citrus run clipboard.yaml</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="runtime-jbang-list"><a class="anchor" href="#runtime-jbang-list"></a><a class="link" href="#runtime-jbang-list">4.7.5. List tests</a></h4>
<div class="paragraph">
<p>The <code>ls</code> command lists all running Citrus tests.
These tests may be started</p>
</div>
<div class="listingblock">
<div class="title">List running tests</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">citrus ls</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Command output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">PID   NAME         STATUS  AGE
19201 my-test.yaml Running 20s</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="runtime-sharded"><a class="anchor" href="#runtime-sharded"></a><a class="link" href="#runtime-sharded">4.8. Sharding Test Cases</a></h3>
<div class="paragraph">
<p>Sharding is a powerful option within the Citrus framework designed to facilitate the loading and execution of test cases in a distributed manner.
Sharding test execution is expected to save roughly <code>[TIME] * 1 / 2</code> of execution time per runner.</p>
</div>
<div class="paragraph">
<p>This chapter provides an overview of the available functionality and guides you through the process of configuring and using test loaders with sharding.</p>
</div>
<div class="sect3">
<h4 id="runtime-sharded-configuration"><a class="anchor" href="#runtime-sharded-configuration"></a><a class="link" href="#runtime-sharded-configuration">4.8.1. Configuration</a></h4>
<div class="paragraph">
<p>First of all, you need to wrap your test case loading with the <code>org.citrusframework.sharding.Shard#createShard(Stream&lt;T&gt; items)</code> method.
Have a look at the previous runtime chapters to get to know how to do this with the test framework of your choice.</p>
</div>
<div class="paragraph">
<p>Once you&#8217;re done doing so, the sharding can be configured using environment variables or system properties.
The following two key configuration parameters are required for sharded test loading:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Total number of shards</strong>: Defines how many shards the test cases should be divided into.</p>
</li>
<li>
<p><strong>Shard number</strong>: Specifies the specific shard number that this loader instance will handle.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following table summarizes the full configuration options:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration</th>
<th class="tableblock halign-left valign-top">Environment Variable</th>
<th class="tableblock halign-left valign-top">System Property</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total number of shards</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CITRUS_SHARDING_TOTAL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>citrus.sharding.total</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shard number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CITRUS_SHARDING_NUMBER</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>citrus.sharding.number</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shard seed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CITRUS_SHARDING_SEED</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>citrus.sharding.seed</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When writing test cases in Java, additional constructors exist, such that the total number of shards, as well as the current shard number can be programmatically configured.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="run"><a class="anchor" href="#run"></a><a class="link" href="#run">5. Run tests</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can write Citrus tests in various programming languages.
The following chapters describe the individual domain specific languages that support you in writing tests in Citrus.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We do our best to make all features equal in all supported languages. Some feature may only make sense in a specific test project setup and are not applicable to all languages (e.g. test behaviors only run in Java classes).
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="run-java"><a class="anchor" href="#run-java"></a><a class="link" href="#run-java">5.1. Java</a></h3>
<div class="paragraph">
<p>You can code the Citrus test as you would do with any other unit test framework (e.g. <a href="#runtime-junit5">JUnit Jupiter</a> or <a href="#runtime-testng">TestNG</a>).
In fact Citrus builds on top of those famous unit testing frameworks because the tooling and adoption throughout the industry is very high for these libraries.</p>
</div>
<div class="paragraph">
<p>Citrus has a set of test engines that you can use to run Citrus tests with your favorite unit test framework.
For instance Citrus provides a JUnit Jupiter extension that you can use to code Citrus tests in Java.
Or you can use the Citrus Cucumber integration to run your tests as Gherkin feature files.</p>
</div>
<div class="paragraph">
<p>No matter what test engine you choose the Citrus test will assist you in writing tests through a Java domain specific language.
This is a set of predefined methods, builders and classes that you can use to code the test in Java.
In conclusion the Citrus test holds a sequence of test actions and each action performs a very special step in your test such as sending or receiving a message.</p>
</div>
<div class="paragraph">
<p>Despite the fact that message exchange is one of the main actions in an integration test framework for message-based applications
Citrus is more than just that. Each test case in Citrus is able to perform various actions such as connecting to the database,
transforming data, adding iterations and conditional steps.</p>
</div>
<div class="paragraph">
<p>With the default Citrus actions provided out of the box users can accomplish very complex use cases in integration testing.
As a tester you can configure test actions in Java using a test action runner API that leverages a fluent builder pattern.</p>
</div>
<div class="sect3">
<h4 id="java-test-runner"><a class="anchor" href="#java-test-runner"></a><a class="link" href="#java-test-runner">5.1.1. Test action DSL</a></h4>
<div class="paragraph">
<p>The test action domain specific language is the entry to the fluent Citrus Java API.
You can configure test actions with a builder pattern style API and the test action runner immediately executes the test actions.</p>
</div>
<div class="paragraph">
<p>See the following example to see the Java domain specific language in action.</p>
</div>
<div class="listingblock primary">
<div class="title">TestNG</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.testng.annotations.Test;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.testng.TestNGCitrusSupport;

public class HelloServiceIT extends TestNGCitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void shouldSayHello() {
        variable("user", "Citrus");

        $(echo("Hello from ${user}!"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit5</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestCaseRunner;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.jupiter.CitrusSupport;
import org.junit.jupiter.api.Test;

@CitrusSupport
public class HelloServiceIT implements TestActionSupport {

    @CitrusResource
    private TestCaseRunner t;

    @Test
    @CitrusTest
    public void shouldSayHello() {
        t.createVariable("user", "Citrus");

        t.run(echo("Hello from ${user}!"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit4</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.spring.JUnit4CitrusSupport;
import org.junit.Test;

public class HelloServiceIT extends JUnit4CitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void shouldSayHello() {
        variable("user", "Citrus");

        $(echo("Hello from ${user}!"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test action runner executes each test action immediately as you use the provided <code>run()</code> method.
All actions provided in Citrus represent a certain functionality (e.g. send/receive messages, delay the test, access a database).
Citrus ships with a wide range of <a href="#actions">test actions</a>, but you are also able to write your own test actions and execute them during a test.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>$()</code> method is a shortcut of the <code>run()</code> method. Please choose whatever fits best in terms of readability of the test code.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The test class implements the interface <code>TestActionSupport</code> which holds all available test actions in Citrus.
You can choose from a wide range of actions.
The provided test action API uses fluent style build pattern to define the test action and its properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>TestActionSupport</code> interface brings quite a lot of methods. In case you are facing issues with one of these methods colliding with your own test methods you can choose from a modular interface hierarchy that builds the Citrus Java test actions API. Instead of implementing the whole <code>TestActionSupport</code> API you may just implement the <code>BaseTestActionSupport</code> API or the very specific <code>HttpTestActionSupport</code> interface in your test. Just look for the <code>*TestActionSupport</code> interfaces provided by Citrus and include what you need into your test class.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For those of you who are not able to use the <code>TestActionSupport</code> or other API interfaces the <strong>TestNGCitrusSupport</strong> and <strong>JUnit4CitrusSupport</strong> base classes also provide a method called <code>actions()</code> that provides access to the test actions Java DSL API.
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">TestNG</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.testng.annotations.Test;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.testng.TestNGCitrusSupport;

public class HelloServiceIT extends TestNGCitrusSupport {

    @Test
    @CitrusTest
    public void shouldSayHello() {
        variable("user", "Citrus");

        $(actions().echo("Hello from ${user}!"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit5</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestCaseRunner;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.jupiter.CitrusSupport;
import org.junit.jupiter.api.Test;

@CitrusSupport
public class HelloServiceIT {

    @CitrusResource
    private TestCaseRunner t;

    @Test
    @CitrusTest
    public void shouldSayHello() {
        variable("user", "Citrus");

        t.run(
            t.actions().echo("Hello from ${user}!")
        );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit4</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.spring.JUnit4CitrusSupport;
import org.junit.Test;

public class HelloServiceIT extends JUnit4CitrusSupport {

    @Test
    @CitrusTest
    public void shouldSayHello() {
        variable("user", "Citrus");

        $(actions().echo("Hello from ${user}!"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, all actions run sequentially in the same order as they are defined in the test case. In case one single action fails
the whole test case is failing. Of course, you can leverage parallel action execution with the usage of <a href="#containers">test containers</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <strong>TestNGCitrusSupport</strong> and <strong>JUnit4CitrusSupport</strong> base classes are not thread safe by default. This is simply
because the base class is holding state to the current test action runner instance in order to delegate method calls
to this instance. Parallel test execution is not available with this approach. Fortunately there is a way to support parallel
test execution through resource injection. Read more about this in <a href="#junit4-parallel">JUnit4</a> or <a href="#junit4-parallel">TestNG</a>
support.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="java-test-runner-gherkin"><a class="anchor" href="#java-test-runner-gherkin"></a><a class="link" href="#java-test-runner-gherkin">5.1.2. Gherkin test action runner</a></h4>
<div class="paragraph">
<p>The test action runner is also available as Gherkin style runner with <code>given()</code>, <code>when()</code>, <code>then()</code> methods. The Gherkin test action runner
follows the Behavior Driven Development concepts of structuring the test into the three parts: <strong>Given</strong> a certain context, <strong>when</strong> an event
occurs, <strong>then</strong> an outcome should be verified.</p>
</div>
<div class="listingblock primary">
<div class="title">TestNG</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.testng.annotations.Test;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.testng.TestNGCitrusSupport;

public class ServiceIT extends TestNGCitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void serviceTest() {
        given(
            echo("Setup the context")
        );

        when(
            echo("Trigger the event")
        );

        then(
            echo("Verify the outcome")
        );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit5</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestCaseRunner;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.jupiter.CitrusSupport;
import org.junit.jupiter.api.Test;

@CitrusSupport
public class ServiceIT implements TestActionSupport {

    @CitrusResource
    private TestCaseRunner t;

    @Test
    @CitrusTest
    public void serviceTest() {
        t.given(
            echo("Setup the context")
        );

        t.when(
            echo("Trigger the event")
        );

        t.then(
            echo("Verify the outcome")
        );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit4</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.spring.JUnit4CitrusSupport;
import org.junit.Test;

public class ServiceIT extends JUnit4CitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void serviceTest() {
        given(
            echo("Setup the context")
        );

        when(
            echo("Trigger the event")
        );

        then(
            echo("Verify the outcome")
        );
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="java-test-meta-information"><a class="anchor" href="#java-test-meta-information"></a><a class="link" href="#java-test-meta-information">5.1.3. Test meta information</a></h4>
<div class="paragraph">
<p>The user is able to provide some additional information about the test case. The meta-info section at the very beginning of the
test case holds information like author, status or creation date.</p>
</div>
<div class="listingblock">
<div class="title">Test meta information</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sampleTest() {
    description("This is a Test");
    author("Christoph");
    status(Status.FINAL);

    $(echo("Hello Citrus!"));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The status allows the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DRAFT</p>
</li>
<li>
<p>READY_FOR_REVIEW</p>
</li>
<li>
<p>DISABLED</p>
</li>
<li>
<p>FINAL</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This information gives the reader first impression about the test and is also used to generate test documentation. By default,
Citrus is able to generate test reports in HTML and Excel in order to list all tests with their metadata information and description.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Tests with the status DISABLED will not be executed during a test suite run. So someone can just start adding planned
test cases that are not finished yet in status DRAFT. In case a test is not runnable yet because it is not finished, someone
may disable a test temporarily to avoid causing failures during a test run.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The test description should give a short introduction to the intended use case scenario that will be tested. The user should get
a short summary of what the test case is trying to verify.</p>
</div>
</div>
<div class="sect3">
<h4 id="java-test-finally"><a class="anchor" href="#java-test-finally"></a><a class="link" href="#java-test-finally">5.1.4. Finally block</a></h4>
<div class="paragraph">
<p>Java developers might be familiar with the concept of try-catch-finally blocks. The <strong><em>finally</em></strong> section contains a list of
test actions that will be executed guaranteed at the very end of the test case even if errors did occur during the execution before.</p>
</div>
<div class="paragraph">
<p>This is the right place to tidy up things that were previously created by the test like cleaning up the database for instance.</p>
</div>
<div class="listingblock">
<div class="title">Finally block</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sampleTest() {
    given(
        doFinally()
            .actions(echo("Do finally - regardless of any error before"))
    );

    $(echo("Hello Test Framework"));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an example imagine that you have prepared some data inside the database at the beginning of the test and you need to make
sure the data is cleaned up at the end of the test case.</p>
</div>
<div class="listingblock">
<div class="title">Finally block example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void finallyBlockTest() {
    variable("orderId", "citrus:randomNumber(5)");
    variable("date", "citrus:currentDate('dd.MM.yyyy')");

    given(
        doFinally()
            .actions(sql(dataSource).statement("DELETE FROM ORDERS WHERE ORDER_ID='${orderId}'"))
    );

    when(
        sql(dataSource).statement("INSERT INTO ORDERS VALUES (${orderId}, 1, 1, '${date}')")
    );

    then(
        echo("ORDER creation time: citrus:currentDate('dd.MM.yyyy')")
    );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example the first action creates an entry in the database using an <strong><em>INSERT</em></strong> statement. To be sure that the entry
in the database is deleted after the test, the <code>finally</code> section contains the respective <strong><em>DELETE</em></strong> statement that is always
executed regardless the test case state (successful or failed).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>finally</code> section must be placed at the very beginning of the test. This is because the test action runner
is immediately executing each test action as it is called within the Java DSL methods. This is the only way the test case
can perform the final actions also in case of previous error.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A <code>finally</code> block placed at the very end of the test will not take action unless put in a traditional Java try-finally-block:</p>
</div>
<div class="listingblock">
<div class="title">Traditional try-finally block</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void finallyBlockTest() {
    variable("orderId", "citrus:randomNumber(5)");
    variable("date", "citrus:currentDate('dd.MM.yyyy')");

    try {
        when(
            sql(dataSource).statement("INSERT INTO ORDERS VALUES (${orderId}, 1, 1, '${date}')")
        );

        then(
            echo("ORDER creation time: citrus:currentDate('dd.MM.yyyy')")
        );
    } finally {
        then(
            sql(dataSource).statement("DELETE FROM ORDERS WHERE ORDER_ID='${orderId}'")
        );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the traditional Java <code>try-finally</code> feels more natural no doubt. Please notice that the Citrus report and logging will
not account the traditional finally block actions then. Good news is whatever layout you choose the outcome is always the same.</p>
</div>
<div class="paragraph">
<p>The <code>finally</code> block is executed safely even in case some previous test action raises an error for some reason.</p>
</div>
</div>
<div class="sect3">
<h4 id="java-test-behaviors"><a class="anchor" href="#java-test-behaviors"></a><a class="link" href="#java-test-behaviors">5.1.5. Test behaviors</a></h4>
<div class="paragraph">
<p>The concept of test behaviors is a good way to reuse test action blocks in the Java DSL. Test behaviors combine action
sequences to a logical unit. The behavior defines a set of test actions that can be applied multiple times to different
test cases.</p>
</div>
<div class="paragraph">
<p>The behavior is a separate Java DSL class with a single <em>apply</em> method that configures the test actions. Test behaviors
follow this basic interface:</p>
</div>
<div class="listingblock">
<div class="title">Test behaviors</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@FunctionalInterface
public interface TestBehavior {

    /**
     * Behavior building method.
     */
    void apply(TestCaseRunner t);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The behavior is provided with the test action runner and all actions in the behavior should run on that t. Every time
the behavior is applied to a test the actions get executed accordingly.</p>
</div>
<div class="listingblock">
<div class="title">Test behaviors</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class FooBehavior implements TestBehavior {
    public void apply(TestCaseRunner t) {
        t.run(createVariable("foo", "test"));

        t.run(echo("fooBehavior"));
    }
}

public class BarBehavior implements TestBehavior {
    public void apply(TestCaseRunner t) {
        t.run(createVariable("bar", "test"));

        t.run(echo("barBehavior"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The listing above shows two test behaviors that add very specific test actions and test variables to the test case. As
you can see the test behavior is able to use the same Java DSL action methods and defines test variables and actions as
a normal test case would do. You can apply the behaviors multiple times in different tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void behaviorTest() {
    $(apply(new FooBehavior()));

    $(echo("Successfully applied bar behavior"));

    $(apply(new BarBehavior()));

    $(echo("Successfully applied bar behavior"));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The behavior is applied to the test case by calling the <strong>apply()</strong> method. As a result the behavior is executed adding
its logic at this point of the test execution. The same behavior can now be called in multiple test cases so we have a reusable
set of test actions.</p>
</div>
<div class="paragraph">
<p>A behavior may use different variable names than the test and vice versa. No doubt the behavior will fail as soon as special
variables with respective values are not present. Unknown variables cause the behavior and the whole test to fail with errors.</p>
</div>
<div class="paragraph">
<p>So a good approach would be to harmonize variable usage across behaviors and test cases, so that templates and test cases
do use the same variable naming. The behavior automatically knows all variables in the test case and all test variables
created inside the behavior are visible to the test case after applying.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When a behavior changes variables this will automatically affect the variables in the whole test. So if you
change a variable value inside a behavior and the variable is defined inside the test case the changes will affect
the variable in a global test context. This means we have to be careful when executing a behavior several times in a test,
especially in combination with parallel containers (see <a href="#containers-parallel">containers-parallel</a>).
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="java-custom-actions"><a class="anchor" href="#java-custom-actions"></a><a class="link" href="#java-custom-actions">5.1.6. Run custom code</a></h4>
<div class="paragraph">
<p>In general, you are able to mix Citrus Java DSL actions with custom Java code as you like.</p>
</div>
<div class="listingblock primary">
<div class="title">TestNG</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.testng.annotations.Test;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.testng.TestNGCitrusSupport;

public class ServiceIT extends TestNGCitrusSupport implements TestActionSupport {

    private MyService myService = new MyService();

    @Test
    @CitrusTest
    public void serviceTest() {
        $(echo("Before service call"));

        myService.doSomething("Now calling custom service");

        $(echo("After service call"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit5</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestCaseRunner;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.jupiter.CitrusSupport;
import org.junit.jupiter.api.Test;

@CitrusSupport
public class ServiceIT implements TestActionSupport {

    @CitrusResource
    private TestCaseRunner t;

    private MyService myService = new MyService();

    @Test
    @CitrusTest
    public void serviceTest() {
        t.run(echo("Before service call"));

        myService.doSomething("Now calling custom service");

        t.run(echo("After service call"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit4</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.spring.JUnit4CitrusSupport;
import org.junit.Test;

public class ServiceIT extends JUnit4CitrusSupport implements TestActionSupport {

    private MyService myService = new MyService();

    @Test
    @CitrusTest
    public void serviceTest() {
        $(echo("Before service call"));

        myService.doSomething("Now calling custom service");

        $(echo("After service call"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test above uses a mix of Citrus test actions and custom service calls. The test logic will execute as expected. It is
recommended though to wrap custom code in a test action in order to have a consistent test reporting and failure management
in Citrus.</p>
</div>
<div class="listingblock primary">
<div class="title">TestNG</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.testng.annotations.Test;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.testng.TestNGCitrusSupport;

public class ServiceIT extends TestNGCitrusSupport implements TestActionSupport {

    private MyService myService = new MyService();

    @Test
    @CitrusTest
    public void serviceTest() {
        $(echo("Before service call"));

        $(
            action(context -&gt; myService.doSomething("Now calling custom service"))
        );

        $(echo("After service call"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit5</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestCaseRunner;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.jupiter.CitrusSupport;
import org.junit.jupiter.api.Test;

@CitrusSupport
public class ServiceIT implements TestActionSupport {

    @CitrusResource
    private TestCaseRunner t;

    private MyService myService = new MyService();

    @Test
    @CitrusTest
    public void serviceTest() {
        t.run(echo("Before service call"));

        t.run(
            action(context -&gt; myService.doSomething("Now calling custom service"))
        );

        t.run(echo("After service call"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit4</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.spring.JUnit4CitrusSupport;
import org.junit.Test;

public class ServiceIT extends JUnit4CitrusSupport implements TestActionSupport {

    private MyService myService = new MyService();

    @Test
    @CitrusTest
    public void serviceTest() {
        $(echo("Before service call"));

        $(
            action(context -&gt; myService.doSomething("Now calling custom service"))
        );

        $(echo("After service call"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sample above wraps the call to the custom service <code>myService</code> in an abstract test action represented as Java lambda expression.
This way the service call becomes part of the Citrus test execution and failures are reported properly. Also you have access to the
current test context which holds the list of test variables as well as many other Citrus related test objects (e.g. message store).</p>
</div>
<div class="paragraph">
<p>This is why you should wrap custom code in a test action and run that code via the test action runner methods. You can also put your custom code in
a test action implementation and reference the logic from multiple tests.</p>
</div>
</div>
<div class="sect3">
<h4 id="java-bind-to-registry"><a class="anchor" href="#java-bind-to-registry"></a><a class="link" href="#java-bind-to-registry">5.1.7. Bind objects to registry</a></h4>
<div class="paragraph">
<p>The Citrus context is a place where objects can register themselves in order to enable dependency injection and instance sharing
in multiple tests. Once you register the object in the context others can resolve the reference with its given name.</p>
</div>
<div class="paragraph">
<p>In a simple example the context can register a new endpoint that is injected in several tests.</p>
</div>
<div class="paragraph">
<p>You can access the Citrus context within the provided before/after methods on the test.</p>
</div>
<div class="listingblock">
<div class="title">Register endpoint in Citrus context</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CitrusRegisterEndpoint_IT extends TestNGCitrusSupport implements TestActionSupport {

    @Override
    public void beforeSuite(CitrusContext context) {
        context.bind("foo", new FooEndpoint());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the CitrusContext you can bind objects to the registry. Each binding receives a name so others can resolve the instance
reference for injection.</p>
</div>
<div class="listingblock primary">
<div class="title">TestNG</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.testng.annotations.Test;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.testng.TestNGCitrusSupport;

public class ServiceIT extends TestNGCitrusSupport implements TestActionSupport {

    @CitrusEndpoint
    private FooEndpoint foo;

    @Test
    @CitrusTest
    public void serviceTest() {
        $(send(foo)
                .message()
                .body("Hello foo!"));

        $(receive(foo)
                .message()
                .body("Hello Citrus!"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit5</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestCaseRunner;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.jupiter.CitrusSupport;
import org.junit.jupiter.api.Test;

@CitrusSupport
public class ServiceIT implements TestActionSupport {

    @CitrusEndpoint
    private FooEndpoint foo;

    @CitrusResource
    private TestCaseRunner t;

    @Test
    @CitrusTest
    public void serviceTest() {
        t.run(send(foo)
                .message()
                .body("Hello foo!"));

        t.run(receive(foo)
                .message()
                .body("Hello Citrus!"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit4</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.spring.JUnit4CitrusSupport;
import org.junit.Test;

public class ServiceIT extends JUnit4CitrusSupport implements TestActionSupport {

    @CitrusEndpoint
    private FooEndpoint foo;

    @Test
    @CitrusTest
    public void serviceTest() {
        $(send(foo)
                .message()
                .body("Hello foo!"));

        $(receive(foo)
                .message()
                .body("Hello Citrus!"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@CitrusEndpoint</code> annotation injects the endpoint resolving the instance with the given name <code>foo</code>.
Test methods can use this endpoint in the following send and receive actions.</p>
</div>
<div class="sect4">
<h5 id="java-bind-to-registry-annotation"><a class="anchor" href="#java-bind-to-registry-annotation"></a><a class="link" href="#java-bind-to-registry-annotation">@BindToRegistry</a></h5>
<div class="paragraph">
<p>An alternative to using the <code>bind()</code> method on the CitrusContext is to use the <code>@BindToRegistry</code> annotation.
Methods and fields annotated will automatically register in the CitrusContext registry.</p>
</div>
<div class="listingblock primary">
<div class="title">TestNG</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.testng.annotations.Test;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.testng.TestNGCitrusSupport;

public class ServiceIT extends TestNGCitrusSupport implements TestActionSupport {

    @CitrusFramework
    private Citrus citrus;

    @BindToRegistry(name = "fooQueue")
    private MessageQueue queue = new DefaultMessageQueue("fooQueue");

    @BindToRegistry
    public FooEndpoint foo() {
        return new FooEndpoint();
    }

    @Test
    @CitrusTest
    public void serviceTest() {
        // ...
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit5</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestCaseRunner;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.jupiter.CitrusSupport;
import org.junit.jupiter.api.Test;

@CitrusSupport
public class ServiceIT implements TestActionSupport {

    @CitrusResource
    private TestCaseRunner t;

    @CitrusFramework
    private Citrus citrus;

    @BindToRegistry(name = "fooQueue")
    private MessageQueue queue = new DefaultMessageQueue("fooQueue");

    @BindToRegistry
    public FooEndpoint foo() {
        return new FooEndpoint();
    }

    @Test
    @CitrusTest
    public void serviceTest() {
        // ...
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit4</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.spring.JUnit4CitrusSupport;
import org.junit.Test;

public class ServiceIT extends JUnit4CitrusSupport implements TestActionSupport {

    @CitrusFramework
    private Citrus citrus;

    @BindToRegistry(name = "fooQueue")
    private MessageQueue queue = new DefaultMessageQueue("fooQueue");

    @BindToRegistry
    public FooEndpoint foo() {
        return new FooEndpoint();
    }

    @Test
    @CitrusTest
    public void serviceTest() {
        // ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The annotation is able to specify an explicit binding name.
The annotation works with public methods and fields in tests.</p>
</div>
</div>
<div class="sect4">
<h5 id="java-configuration-class"><a class="anchor" href="#java-configuration-class"></a><a class="link" href="#java-configuration-class">Configuration classes</a></h5>
<div class="paragraph">
<p>As an alternative to adding the registry binding configuration directly to the test you can load configuration classes.</p>
</div>
<div class="paragraph">
<p>Configuration classes are automatically loaded before a test suite run and all methods and fields are parsed for potential bindings.
You can use the environment settings <code>citrus.java.config</code> and/or <code>CITRUS_JAVA_CONFIG</code> to set a default configuration class.</p>
</div>
<div class="listingblock">
<div class="title">citrus-application.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">citrus.java.config=MyConfig.class</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">MyConfig.class</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class MyConfig {

    @BindToRegistry(name = "fooQueue")
    private MessageQueue queue = new DefaultMessageQueue("fooQueue");

    @BindToRegistry
    public FooEndpoint foo() {
        return new FooEndpoint();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="java-configuration-class-annotation"><a class="anchor" href="#java-configuration-class-annotation"></a><a class="link" href="#java-configuration-class-annotation">@CitrusConfiguration</a></h5>
<div class="paragraph">
<p>Each test is able to use the <code>@CitrusConfiguration</code> annotation to add registry bindings, too.</p>
</div>
<div class="listingblock primary">
<div class="title">TestNG</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusConfiguration;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.testng.TestNGCitrusSupport;
import org.testng.annotations.Test;

@CitrusConfiguration(classes = MyConfig.class)
public class ServiceIT extends TestNGCitrusSupport implements TestActionSupport {

    @CitrusEndpoint
    private FooEndpoint foo;

    @Test
    @CitrusTest
    public void serviceTest() {
        $(send(foo)
                .message()
                .body("Hello foo!"));

        $(receive(foo)
                .message()
                .body("Hello Citrus!"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit5</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestCaseRunner;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusConfiguration;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.jupiter.CitrusSupport;
import org.junit.jupiter.api.Test;

@CitrusSupport
@CitrusConfiguration(classes = MyConfig.class)
public class ServiceIT implements TestActionSupport {

    @CitrusResource
    private TestCaseRunner t;

    @CitrusEndpoint
    private FooEndpoint foo;

    @Test
    @CitrusTest
    public void serviceTest() {
        t.run(send(foo)
                .message()
                .body("Hello foo!"));

        t.run(receive(foo)
                .message()
                .body("Hello Citrus!"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit4</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusConfiguration;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.spring.JUnit4CitrusSupport;
import org.junit.Test;

@CitrusConfiguration(classes = MyConfig.class)
public class ServiceIT extends JUnit4CitrusSupport implements TestActionSupport {

    @CitrusEndpoint
    private FooEndpoint foo;

    @Test
    @CitrusTest
    public void serviceTest() {
        $(send(foo)
                .message()
                .body("Hello foo!"));

        $(receive(foo)
                .message()
                .body("Hello Citrus!"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@CitrusConfiguration</code> annotation is able to load configuration classes and bind all components to the registry for later usage.
The test can inject endpoints and other components using the <code>@CitrusEndpoint</code> and <code>@CitrusResource</code> annotation on fields.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="java-resource-injection"><a class="anchor" href="#java-resource-injection"></a><a class="link" href="#java-resource-injection">5.1.8. Resource injection</a></h4>
<div class="paragraph">
<p>Resource injection is a convenient mechanism to access Citrus internal objects such as TestRunner or TestContext instances. The following sections
deal with resource injection of different objects.</p>
</div>
<div class="sect4">
<h5 id="java-resource-injection-citrus"><a class="anchor" href="#java-resource-injection-citrus"></a><a class="link" href="#java-resource-injection-citrus">Inject Citrus framework</a></h5>
<div class="paragraph">
<p>You can access the Citrus framework instance in order to access all components and functionalities. Just use the <code>@CitrusFramework</code>
annotation in your test class.</p>
</div>
<div class="listingblock primary">
<div class="title">TestNG</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.testng.TestNGCitrusSupport;
import org.testng.annotations.Test;

public class ServiceIT extends TestNGCitrusSupport implements TestActionSupport {

    @CitrusFramework
    private Citrus citrus;

    @Test
    @CitrusTest
    public void serviceTest() {
        citrus.getCitrusContext().getMessageListeners().addMessageListener(new MyListener());
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit5</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestCaseRunner;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.jupiter.CitrusSupport;
import org.junit.jupiter.api.Test;

@CitrusSupport
public class ServiceIT implements TestActionSupport {

    @CitrusResource
    private TestCaseRunner t;

    @CitrusFramework
    private Citrus citrus;

    @Test
    @CitrusTest
    public void serviceTest() {
        citrus.getCitrusContext().getMessageListeners().addMessageListener(new MyListener());
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit4</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.spring.JUnit4CitrusSupport;
import org.junit.Test;

public class ServiceIT extends JUnit4CitrusSupport implements TestActionSupport {

    @CitrusFramework
    private Citrus citrus;

    @Test
    @CitrusTest
    public void serviceTest() {
        citrus.getCitrusContext().getMessageListeners().addMessageListener(new MyListener());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The framework instance provides access to the Citrus context which is a central registry for all components. The example above adds
a new message listener.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The Citrus context is a shared component. Components added will perform with all further tests and changes made
affect all tests.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="java-resource-injection-runner"><a class="anchor" href="#java-resource-injection-runner"></a><a class="link" href="#java-resource-injection-runner">Test action runner injection</a></h5>
<div class="paragraph">
<p>The test action runner is the entry to the fluent Java API. You can inject the runner as a method parameter.</p>
</div>
<div class="listingblock primary">
<div class="title">TestNG</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.TestCaseRunner;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.testng.TestNGCitrusSupport;
import org.testng.annotations.Optional;
import org.testng.annotations.Test;

public class ServiceIT extends TestNGCitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void serviceTest(@Optional @CitrusResource TestCaseRunner runner) {
        t.run(
            createVariable("random", "citrus:randomNumber(10)")
        );

        t.run(
            echo("The random number is: ${random}")
        );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit5</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.TestCaseRunner;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.jupiter.CitrusSupport;
import org.junit.jupiter.api.Test;

@CitrusSupport
public class ServiceIT implements TestActionSupport {

    @Test
    @CitrusTest
    public void serviceTest(@CitrusResource TestCaseRunner runner) {
        t.run(
            createVariable("random", "citrus:randomNumber(10)")
        );

        t.run(
            echo("The random number is: ${random}")
        );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit4</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.TestCaseRunner;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.spring.JUnit4CitrusSupport;
import org.junit.Test;

public class ServiceIT extends JUnit4CitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void serviceTest(@CitrusResource TestCaseRunner runner) {
        t.run(
            createVariable("random", "citrus:randomNumber(10)")
        );

        t.run(
            echo("The random number is: ${random}")
        );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The parameter requires the <code>@CitrusResource</code> annotations in order to mark the parameter for Citrus resource injection.</p>
</div>
<div class="paragraph">
<p>Now each method uses its own runner instance which makes sure that parallel test execution can take place without having
the risk of side effects on other tests running at the same time.</p>
</div>
</div>
<div class="sect4">
<h5 id="java-resource-injection-test-context"><a class="anchor" href="#java-resource-injection-test-context"></a><a class="link" href="#java-resource-injection-test-context">Test context injection</a></h5>
<div class="paragraph">
<p>The Citrus test context combines a set of central objects and functionalities that a test is able to make use of. The test context
holds all variables and is able to resolve functions and validation matchers.</p>
</div>
<div class="paragraph">
<p>In general a tester will not have to explicitly access the test context because the framework is working with it behind the scenes.
In terms of advanced operations and customizations accessing the test context may be a good idea though.</p>
</div>
<div class="paragraph">
<p>Each test action implementation has access to the test context as it is provided to the execution method in the interface:</p>
</div>
<div class="listingblock">
<div class="title">Test action interface</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@FunctionalInterface
public interface TestAction {
    /**
     * Main execution method doing all work
     * @param context
     */
    void execute(TestContext context);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to that Citrus provides a resource injection mechanism that allows to access the current test context in a test class or test method.</p>
</div>
<div class="listingblock primary">
<div class="title">TestNG</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.TestCaseRunner;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.testng.TestNGCitrusSupport;
import org.testng.annotations.Optional;
import org.testng.annotations.Test;

public class ServiceIT extends TestNGCitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void serviceTest(@Optional @CitrusResource TestCaseRunner runner,
                            @Optional @CitrusResource TestContext context) {
        context.setVariable("myVariable", "some value");

        t.run(echo("${myVariable}"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit5</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.TestCaseRunner;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.jupiter.CitrusSupport;
import org.junit.jupiter.api.Test;

@CitrusSupport
public class ServiceIT implements TestActionSupport {

    @Test
    @CitrusTest
    public void serviceTest(@CitrusResource TestCaseRunner runner,
                            @CitrusResource TestContext context) {
        context.setVariable("myVariable", "some value");

        t.run(echo("${myVariable}"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit4</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.TestCaseRunner;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.spring.JUnit4CitrusSupport;
import org.junit.Test;

public class ServiceIT extends JUnit4CitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void serviceTest(@CitrusResource TestCaseRunner runner,
                            @CitrusResource TestContext context) {
        context.setVariable("myVariable", "some value");

        t.run(echo("${myVariable}"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the test method defines a parameter of type <strong>org.citrusframework.context.TestContext</strong>. The annotation <strong>@CitrusResource</strong>
tells Citrus to inject this parameter with the according instance of the context for this test.</p>
</div>
<div class="paragraph">
<p>Now you have access to the context and all its capabilities such as variable management. As an alternative you can inject
the test context as a class member variable.</p>
</div>
</div>
<div class="sect4">
<h5 id="java-resource-injection-endpoint"><a class="anchor" href="#java-resource-injection-endpoint"></a><a class="link" href="#java-resource-injection-endpoint">Endpoint injection</a></h5>
<div class="paragraph">
<p>Endpoints play a significant role when sending/receiving messages over various transports. An endpoint defines how to connect
to a message transport (e.g. Http endpoint URL, JMS message broker connection, Kafka connection and topic selection).</p>
</div>
<div class="paragraph">
<p>Endpoints can live inside the Citrus context (e.g. in Spring application context) or you can inject the endpoint into the test class
with given configuration.</p>
</div>
<div class="listingblock primary">
<div class="title">TestNG</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.TestCaseRunner;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.testng.TestNGCitrusSupport;
import org.testng.annotations.Optional;
import org.testng.annotations.Test;

public class ServiceIT extends TestNGCitrusSupport implements TestActionSupport {

    @CitrusEndpoint
    @DirectEndpointConfig(queueName = "FOO.test.queue")
    private Endpoint directEndpoint;

    @Test
    @CitrusTest
    public void serviceTest(@Optional @CitrusResource TestCaseRunner runner) {
        t.run(send(directEndpoint)
                .message()
                    .type(MessageType.PLAINTEXT)
                    .body("Hello!"));

        t.run(receive(directEndpoint)
                .message()
                    .type(MessageType.PLAINTEXT)
                    .body("Hello!"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit5</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.TestCaseRunner;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.jupiter.CitrusSupport;
import org.junit.jupiter.api.Test;

@CitrusSupport
public class ServiceIT implements TestActionSupport {

    @CitrusEndpoint
    @DirectEndpointConfig(queueName = "FOO.test.queue")
    private Endpoint directEndpoint;

    @Test
    @CitrusTest
    public void serviceTest(@CitrusResource TestCaseRunner runner) {
        t.run(send(directEndpoint)
                .message()
                    .type(MessageType.PLAINTEXT)
                    .body("Hello!"));

        t.run(receive(directEndpoint)
                .message()
                    .type(MessageType.PLAINTEXT)
                    .body("Hello!"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit4</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.TestCaseRunner;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.spring.JUnit4CitrusSupport;
import org.junit.Test;

public class ServiceIT extends JUnit4CitrusSupport implements TestActionSupport {

    @CitrusEndpoint
    @DirectEndpointConfig(queueName = "FOO.test.queue")
    private Endpoint directEndpoint;

    @Test
    @CitrusTest
    public void serviceTest() {
        $(send(directEndpoint)
                .message()
                    .type(MessageType.PLAINTEXT)
                    .body("Hello!"));

        $(receive(directEndpoint)
                .message()
                    .type(MessageType.PLAINTEXT)
                    .body("Hello!"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sample above creates a new endpoint as a direct in-memory channel endpoint. Citrus reads the <code>@CitrusEndpoint</code> annotation and
adds the configuration as given in the <code>@DirectEndpointConfig</code> annotation. This way you can create and inject endpoints directly to
your test.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Citrus also supports the Spring framework as a central bean registry. You can add endpoints as Spring beans and use the
<code>@Autowired</code> annotation to inject the endpoint in your test.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="run-test-source-loader"><a class="anchor" href="#run-test-source-loader"></a><a class="link" href="#run-test-source-loader">5.2. Test source loader</a></h3>
<div class="paragraph">
<p>Besides writing Citrus tests directly in Java you can code tests in domain specific languages using one of the supported tests sources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java runnable</p>
</li>
<li>
<p>XML</p>
</li>
<li>
<p>YAML</p>
</li>
<li>
<p>Cucumber</p>
</li>
<li>
<p>Groovy</p>
</li>
<li>
<p>Spring XML</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The test case definition file is loaded by Citrus and run as a normal test.
In Citrus the <code>@CitrusTestSource</code> annotation in the Java class defines the test source location to be loaded.
This annotation makes Citrus search for the XML, YAML, Groovy, Cucumber, Spring XML files that represent the Citrus test.</p>
</div>
<div class="paragraph">
<p>The next example shows how the annotation is used in a normal Java test to load XML test case definitions.</p>
</div>
<div class="listingblock">
<div class="title">MyFirstCitrus_IT.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.citrusframework;

import org.citrusframework.annotations.CitrusTestSource;
import org.citrusframework.testng.TestNGCitrusSupport;
import org.testng.annotations.Test;

public class MyFirstCitrus_IT extends TestNGCitrusSpringSupport {

    @Test
    @CitrusTestSource(type = "xml", name="MyFirstCitrus_IT")
    public void myFirstCitrus_IT() {
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the basic example above this means that Citrus searches for an XML test file in <strong>org/citrusframework/MyFirstCitrus_IT.xml</strong> .</p>
</div>
<div class="paragraph">
<p>You can customize this path and tell Citrus to search for another XML file by using the <code>@CitrusTestSource</code> annotation properties.</p>
</div>
<div class="paragraph">
<p>Following annotation properties are available:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
type
</td>
<td class="hdlist2">
<p>Type of the test source to load (spring, groovy, xml, &#8230;&#8203;)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
name
</td>
<td class="hdlist2">
<p>List of test case names to execute. Names also define XML file names to look for (<strong>.xml</strong> file extension is not needed here).</p>
</td>
</tr>
<tr>
<td class="hdlist1">
packageName
</td>
<td class="hdlist2">
<p>Custom package location for the XML files to load</p>
</td>
</tr>
<tr>
<td class="hdlist1">
packageScan
</td>
<td class="hdlist2">
<p>List of packages that are automatically scanned for XML test files to execute. For each XML file found separate
test is executed. Note that this performs a Java Classpath package scan so all XML files in package are assumed to be valid Citrus
XML test cases. In order to minimize the amount of accidentally loaded XML files the scan will only load XML files with <code>**/*Test.xml</code> and <code>**/*IT.xml</code>
file name pattern.</p>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Customize @CitrusTestSource</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Sample_IT extends TestNGCitrusSpringSupport {

    @Test
    @CitrusTestSource(type = "xml", name = "CustomName_IT", packageName = "com.other.test.package")
    public void customXmlTest() {}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The annotation above loads a different XML test file named <code>CustomName_IT</code> in package <code>com.other.test.package</code>.</p>
</div>
<div class="paragraph">
<p>You can also load multiple XML files and run each of them.</p>
</div>
<div class="listingblock">
<div class="title">Load multiple XML files</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Sample_IT extends TestNGCitrusSpringSupport {

    @Test
    @CitrusTestSource(type = "xml", name = { "Test_1", "Test_2" })
    public void multipleTests() {}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This tells Citrus to search for the files <code>Test_1.xml</code> and <code>Test_2.xml</code>. Citrus loads the files and runs each of them as
a separate test. You can also load all test in a package with a <code>packageScan</code>.</p>
</div>
<div class="listingblock">
<div class="title">Load multiple XML files</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Sample_IT extends TestNGCitrusSpringSupport {

    @Test
    @CitrusTestSource(type = "xml", packageScan =  { "com.some.test.package", "com.other.test.package" })
    public void packageScanTest() {}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This loads all XML files in the given packages and executes each of them as a separate test.</p>
</div>
<div class="paragraph">
<p>You can also mix the various <code>@CitrusTestSource</code> annotations in a single Java class.
The class can have several methods with different annotations. Each annotated method represents one or more Citrus XML test cases.</p>
</div>
<div class="listingblock">
<div class="title">@CitrusTestSource annotations</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SampleIT extends TestNGCitrusSpringSupport {

    @Test
    @CitrusTestSource(type = "xml", name = "SampleIT")
    public void sampleTest() {}

    @Test
    @CitrusTestSource(type = "xml", name = { "Test_1", "Test_2" })
    public void multipleTests() {}

    @Test
    @CitrusTestSource(type = "xml", name = "CustomName_IT", packageName = "com.other.test.package")
    public void customXmlTest() {}

    @Test
    @CitrusTestSource(type = "xml", packageScan =  { "com.some.test.package", "com.other.test.package" })
    public void packageScanTest() {}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You are free to combine these test annotations as you like in your class.
Each XML test loaded as part of the class will be reported separately as a unit test.
So the test reports will have the exact number of tests executed with proper success and failed stats.
You can use the reports as normal unit test reports, for instance in a continuous build.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When test execution takes place each test method annotation is evaluated in sequence.
XML test cases that match several times, for instance by explicit name reference and a package scan will be executed several times respectively.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The best thing about using the <strong>@CitrusTestSource</strong> annotation is that you can continue to use the test framework capabilities
(e.g. test groups, invocation count, thread pools, data providers, and so on).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following chapters describe the different supported test sources that you can load as a Citrus test.</p>
</div>
</div>
<div class="sect2">
<h3 id="run-xml-tests"><a class="anchor" href="#run-xml-tests"></a><a class="link" href="#run-xml-tests">5.3. XML</a></h3>
<div class="paragraph">
<p>As an alternative to coding tests in a programming language you can specify the test logic in XML only, too.
The XML language gives you some XSD schema and a set of elements that you can choose from to specify test actions.</p>
</div>
<div class="paragraph">
<p>As usual, you need to choose one of the supported test engines in Citrus to actually run the test (e.g. <a href="#runtime-junit5">JUnit Jupiter</a> or <a href="#runtime-testng">TestNG</a>).
You can then use the <code>@CitrusTestSource</code> annotation to load the XML file that represents the test case.</p>
</div>
<div class="listingblock">
<div class="title">MyFirstXmlIT.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.citrusframework;

import org.citrusframework.annotations.CitrusTestSource;
import org.citrusframework.testng.TestNGCitrusSupport;
import org.testng.annotations.Test;

public class MyFirstXmlIT extends TestNGCitrusSpringSupport {

    @Test
    @CitrusTestSource(type = "xml", name="my-test.xml")
    public void myFirstXmlIT() {
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test logic itself is defined in the XML file like this:</p>
</div>
<div class="listingblock">
<div class="title">my-test.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="EchoTest" author="Christoph" status="FINAL"
      xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase
            http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;description&gt;Sample test in XML&lt;/description&gt;

  &lt;variables&gt;
    &lt;variable name="text" value="Hello from Citrus!"/&gt;
  &lt;/variables&gt;

  &lt;actions&gt;
    &lt;echo message="${text}"/&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="run-xml-groovy-configuration"><a class="anchor" href="#run-xml-groovy-configuration"></a><a class="link" href="#run-xml-groovy-configuration">5.3.1. Configuration scripts</a></h4>
<div class="paragraph">
<p>The XML test is able to create endpoints and other configuration entities as part of the test.
The test leverages the Groovy programming language that provides a comfortable way to define beans in the Citrus registry.
You can set any of the supported properties on the configuration components.</p>
</div>
<div class="listingblock">
<div class="title">my-test.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="EchoTest" author="Christoph" status="FINAL"
      xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase
            http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;description&gt;Sample test in XML&lt;/description&gt;

  &lt;variables&gt;
    &lt;variable name="text" value="Hello from Citrus!"/&gt;
  &lt;/variables&gt;

  &lt;actions&gt;
    &lt;groovy&gt;
      &lt;endpoints&gt;
        &lt;script&gt;
        configuration {
            queues {
                queue('say-hello')
            }

            endpoints {
                direct('hello')
                    .asynchronous()
                    .queue('say-hello')
            }
        }
        &lt;/script&gt;
      &lt;/endpoints&gt;
    &lt;/groovy&gt;

    &lt;send endpoint="hello"&gt;
      &lt;message&gt;
        &lt;body&gt;
          &lt;data&gt;Hello Citrus!&lt;/data&gt;
        &lt;/body&gt;
      &lt;/message&gt;
    &lt;/send&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test above creates a new <code>direct</code> endpoint called <code>hello</code> that uses an im-memory queue <code>say-hello</code>.
The send action is able to reference the endpoint by its name to send a message body to the queue.</p>
</div>
</div>
<div class="sect3">
<h4 id="run-xml-templates"><a class="anchor" href="#run-xml-templates"></a><a class="link" href="#run-xml-templates">5.3.2. Templates</a></h4>
<div class="paragraph">
<p>Templates group action sequences to a logical unit.
You can think of templates as reusable components that are used in several tests.
The maintenance is much more efficient because you need to apply changes only on the templates and all referenced use cases are updated automatically.</p>
</div>
<div class="paragraph">
<p>The template gets identified by a unique name.
Inside a test case we apply the template referencing this unique name.
Have a look at a first example:</p>
</div>
<div class="listingblock">
<div class="title">echo-template.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;template name="echo"&gt;
  &lt;description&gt;Sample template in XML&lt;/description&gt;
  &lt;parameters&gt;
    &lt;parameter name="message" value="Citrus rocks!"/&gt;
  &lt;/parameters&gt;

  &lt;actions&gt;
    &lt;echo message="${message}"/&gt;
  &lt;/actions&gt;
&lt;/template&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code example above describes a template called <code>echo</code>.
Templates hold a sequence of test actions or calls other templates themselves.
The template may define a set of parameters that represent customizable user input when applying the template.</p>
</div>
<div class="paragraph">
<p>The template is available for multiple tests that may apply the template as part of their test action sequence.</p>
</div>
<div class="listingblock">
<div class="title">Apply templates</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ApplyTemplateTest" author="Christoph" status="FINAL"
      xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase
            http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;description&gt;Sample test in XML&lt;/description&gt;

  &lt;actions&gt;
    &lt;apply-template name="echo"/&gt;

    &lt;apply-template name="echo"&gt;
      &lt;parameters&gt;
        &lt;parameter name="message" value="Hello from Citrus!"/&gt;
      &lt;/parameters&gt;
    &lt;/apply-template&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example references the <code>echo</code> template and call it as part of the test with <code>&lt;apply-template/&gt;</code>.
You can customize the template parameter to overwrite the default variable <code>text</code> with a custom value.</p>
</div>
<div class="paragraph">
<p>The example above assumes that you have added the template to the Citrus bean registry with the name <code>echo</code>.
If this is not the case you may also reference the file resource path when applying the template:</p>
</div>
<div class="listingblock">
<div class="title">Apply templates</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ApplyTemplateTest" author="Christoph" status="FINAL"
      xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase
            http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;description&gt;Sample test in XML&lt;/description&gt;

  &lt;actions&gt;
    &lt;apply-template file="classpath:templates/xml/echo-template.xml"&gt;
      &lt;parameters&gt;
        &lt;parameter name="message" value="Hello from Citrus!"/&gt;
      &lt;/parameters&gt;
    &lt;/apply-template&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="run-xml-template-parameters"><a class="anchor" href="#run-xml-template-parameters"></a><a class="link" href="#run-xml-template-parameters">Template parameters</a></h5>
<div class="paragraph">
<p>How to handle test variables when dealing with templates, in particular when templates are defined in separate source files?
A template may use different variable names compared to those names used a test and vice versa.
The template fails immediately when respective variables are not present.
Therefore, templates introduce the concept of parameters to declare its variable names.</p>
</div>
<div class="paragraph">
<p>Assume you have the following template:</p>
</div>
<div class="listingblock">
<div class="title">sayHello template</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;template name="sayHello"&gt;
  &lt;description&gt;Sample template in XML&lt;/description&gt;
  &lt;parameters&gt;
    &lt;parameter name="user" value="Citrus"/&gt;
  &lt;/parameters&gt;

  &lt;actions&gt;
    &lt;echo message="Hello ${user}!"/&gt;
  &lt;/actions&gt;
&lt;/template&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The template <code>sayHello</code> in the example uses the variable <code>${user}</code>.</p>
</div>
<div class="paragraph">
<p>In case the test case already uses the template parameter as a value you do not need to set this variable explicitly on the apply template action.</p>
</div>
<div class="listingblock">
<div class="title">Implicit template parameter</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SayHelloTemplateTest" author="Christoph" status="FINAL"
      xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase
            http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;description&gt;Sample test in XML&lt;/description&gt;

  &lt;variables&gt;
    &lt;variable name="user" value="Christoph"/&gt;
  &lt;/variables&gt;

  &lt;actions&gt;
    &lt;apply-template name="sayHello"/&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Hello Christoph!</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The implicit template parameter may break as soon as the template or the test changes its parameter or variable name.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The test case may also explicitly set the template parameter when applying the template:</p>
</div>
<div class="listingblock">
<div class="title">Explicit template parameter</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SayHelloTemplateTest" author="Christoph" status="FINAL"
      xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase
            http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;description&gt;Sample test in XML&lt;/description&gt;

  &lt;variables&gt;
    &lt;variable name="username" value="Mickey"/&gt;
  &lt;/variables&gt;

  &lt;actions&gt;
    &lt;apply-template name="sayHello"&gt;
      &lt;parameters&gt;
        &lt;parameter name="user" value="${username}"/&gt;
      &lt;/parameters&gt;
    &lt;/apply-template&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Hello Mickey!</code></pre>
</div>
</div>
<div class="paragraph">
<p>The variable <strong>username</strong> is already present in the test case and gets translated into the <strong>user</strong> parameter.
Following from that the template works fine although test and template do work on different variable names.</p>
</div>
<div class="paragraph">
<p>With template parameters you are able to solve the calibration effort when working with templates and variables.
It is always a good idea to check the used variables/parameters inside a template when calling it.
There might be a variable that is not declared yet inside your test.
So you need to define this value as a parameter.</p>
</div>
</div>
<div class="sect4">
<h5 id="run-xml-template-paremeter-scope"><a class="anchor" href="#run-xml-template-paremeter-scope"></a><a class="link" href="#run-xml-template-paremeter-scope">Template parameter scope</a></h5>
<div class="paragraph">
<p>A template is able to change a test variable value for the rest of the test case.
It is important to know about this when changing test variables in a template as it affects the descendant test actions.
Especially when running test actions or templates in parallel to each other this might lead to unexpected behavior.
You may choose the template parameter scope for this scenario.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When a template works on variable values and parameters changes to these variables will automatically affect the
variables in the whole test. So if you change a variable&#8217;s value inside a template and the variable is defined inside the
test case the changes will affect the variable in a global context. We have to be careful with this when executing a template
several times in a test, especially in combination with parallel containers (see <a href="#containers-parallel">containers-parallel</a>).
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">print template</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;template name="print"&gt;
  &lt;description&gt;Sample template in XML&lt;/description&gt;
  &lt;parameters&gt;
    &lt;parameter name="index" value="0"/&gt;
    &lt;parameter name="area" value="Atlantis"/&gt;
  &lt;/parameters&gt;

  &lt;actions&gt;
    &lt;echo message="#${index} Hello ${area}!"/&gt;
  &lt;/actions&gt;
&lt;/template&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Global scope parameter (default)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SayHelloTemplateTest" author="Christoph" status="FINAL"
      xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase
            http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;description&gt;Sample test in XML&lt;/description&gt;

  &lt;actions&gt;
    &lt;parallel&gt;
      &lt;actions&gt;
        &lt;apply-template name="print"&gt;
          &lt;parameters&gt;
            &lt;parameter name="index" value="1"/&gt;
            &lt;parameter name="area" value="Europe"/&gt;
          &lt;/parameters&gt;
        &lt;/apply-template&gt;
        &lt;apply-template name="print"&gt;
          &lt;parameters&gt;
            &lt;parameter name="index" value="2"/&gt;
            &lt;parameter name="area" value="Asia"/&gt;
          &lt;/parameters&gt;
        &lt;/apply-template&gt;
        &lt;apply-template name="print"&gt;
          &lt;parameters&gt;
            &lt;parameter name="index" value="3"/&gt;
            &lt;parameter name="area" value="Africa"/&gt;
          &lt;/parameters&gt;
        &lt;/apply-template&gt;
      &lt;/actions&gt;
    &lt;/parallel&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the listing above a template <strong>print</strong> is called several times in a parallel container.
The parameter values will be handled in a global context, so it is quite likely to happen that the template instances influence each other during execution.
We might get such print messages:</p>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">#2 Hello Europe!
#2 Hello Africa!
#3 Hello Africa!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Index parameters do not fit and the message <strong>'Hello Asia'</strong> is completely gone.
This is because templates overwrite parameters to each other as they are executed in parallel at the same time.
To avoid this behavior we need to tell the template that it should handle parameters as well as variables in a local context.
This will enforce that each template instance is working on a dedicated local context.
See the <strong>global-context</strong> attribute that is set to <strong>false</strong> in this example:</p>
</div>
<div class="listingblock">
<div class="title">print template</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;template name="print" global-context="false"&gt;
  &lt;description&gt;Sample template in XML&lt;/description&gt;
  &lt;parameters&gt;
    &lt;parameter name="index" value="0"/&gt;
    &lt;parameter name="area" value="Atlantis"/&gt;
  &lt;/parameters&gt;

  &lt;actions&gt;
    &lt;echo message="#${index} Hello ${area}!"/&gt;
  &lt;/actions&gt;
&lt;/template&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that template instances will not influence each other anymore.
But notice that variable changes inside the template then do not affect the test case neither.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="run-yaml-tests"><a class="anchor" href="#run-yaml-tests"></a><a class="link" href="#run-yaml-tests">5.4. YAML</a></h3>
<div class="paragraph">
<p>As an alternative to coding tests in a programming language you can specify the test logic in YAML only, too.
The YAML language gives you some XSD schema and a set of elements that you can choose from to specify test actions.</p>
</div>
<div class="paragraph">
<p>As usual, you need to choose one of the supported test engines in Citrus to actually run the test (e.g. <a href="#runtime-junit5">JUnit Jupiter</a> or <a href="#runtime-testng">TestNG</a>).
You can then use the <code>@CitrusTestSource</code> annotation to load the YAML file that represents the test case.</p>
</div>
<div class="listingblock">
<div class="title">MyFirstYamlIT.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.citrusframework;

import org.citrusframework.annotations.CitrusTestSource;
import org.citrusframework.testng.TestNGCitrusSupport;
import org.testng.annotations.Test;

public class MyFirstYamlIT extends TestNGCitrusSpringSupport {

    @Test
    @CitrusTestSource(type = "yaml", name="my-test.yaml")
    public void myFirstXmlIT() {
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test logic itself is defined in the YAML file like this:</p>
</div>
<div class="listingblock">
<div class="title">my-test.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: EchoTest
author: Christoph
status: FINAL
description: "Sample test in YAML"
variables:
  - name: "message"
    value: "Hello from Citrus!"
actions:
  - echo:
      message: "${message}"</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="run-yaml-groovy-configuration"><a class="anchor" href="#run-yaml-groovy-configuration"></a><a class="link" href="#run-yaml-groovy-configuration">5.4.1. Configuration scripts</a></h4>
<div class="paragraph">
<p>The YAML test is able to create endpoints and other configuration entities as part of the test.
The test leverages the Groovy programming language that provides a comfortable way to define beans in the Citrus registry.</p>
</div>
<div class="paragraph">
<p>The script creates the instances as beans in the Citrus registry.</p>
</div>
<div class="paragraph">
<p>A configuration script may use methods and closures to define the bean instances.
The configuration script supports following methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>queues()</p>
</li>
<li>
<p>endpoints()</p>
</li>
<li>
<p>beans()</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">my-test.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: EchoTest
author: Christoph
status: FINAL
description: "Sample test in YAML"
variables:
  - name: "message"
    value: "Hello from Citrus!"
actions:
  - groovy:
      endpoints:
        script: |
          configuration {
              queues {
                  queue('say-hello')
              }

              endpoints {
                  direct('hello')
                      .asynchronous()
                      .queue('say-hello')
              }
          }
  - send:
      endpoint: "hello"
      message&gt;:
        body:
          data: Hello Citrus!</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test above creates a new <code>direct</code> endpoint called <code>hello</code> that uses an in-memory queue named <code>say-hello</code>.</p>
</div>
<div class="paragraph">
<p>The <code>send</code> test action is able to reference the new endpoint by its name to send a message body to the queue.</p>
</div>
<div class="paragraph">
<p>You can also create bean instances with a Groovy script:</p>
</div>
<div class="listingblock">
<div class="title">my-test.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">actions:
  - groovy:
      beans:
        script: |
          beans {
            bean(DefaultTextEqualsMessageValidator.class)
          }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration script initializes a new bean instance of type <code>org.citrusframework.validation.DefaultTextEqualsMessageValidator.class</code>.
A <code>receive</code> test action will automatically resolve the new message validator instance from the Citrus bean registry to perform its message validation.</p>
</div>
<div class="paragraph">
<p>The bean type must have a default constructor in this case.</p>
</div>
<div class="listingblock">
<div class="title">Create beans in registry</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">beans {
    bean('foo', org.example.foo.FooBean.class)
    fooClient = new org.example.foo.FooClientBuilder().build()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example creates a new instance of <code>FooBean</code> with the id <code>foo</code> in the Citrus bean registry.
The <code>FooBean</code> class must have a default constructor in this case, too.</p>
</div>
<div class="paragraph">
<p>You can also create the instances on your own (e.g. using a builder factory) as seen with the <code>fooClient</code> bean in this example.</p>
</div>
<div class="paragraph">
<p>All beans added to the Citrus registry are subject to being injected into or resolved by test actions and other components in Citrus.</p>
</div>
</div>
<div class="sect3">
<h4 id="run-yaml-templates"><a class="anchor" href="#run-yaml-templates"></a><a class="link" href="#run-yaml-templates">5.4.2. Templates</a></h4>
<div class="paragraph">
<p>Templates group action sequences to a logical unit.
You can think of templates as reusable components that are used in several tests.
The maintenance is much more efficient because you need to apply changes only on the templates and all referenced use cases are updated automatically.</p>
</div>
<div class="paragraph">
<p>The template gets identified by a unique name.
Inside a test case we apply the template referencing this unique name.
Have a look at a first example:</p>
</div>
<div class="listingblock">
<div class="title">echo-template.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: echo
description: Sample template in YAML
parameters:
  - name: message
    value: "Citrus rocks!"
actions:
  - echo:
      message: "${message}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code example above describes a template called <code>echo</code>.
Templates hold a sequence of test actions or calls other templates themselves.
The template may define a set of parameters that represent customizable user input when applying the template.</p>
</div>
<div class="paragraph">
<p>The template is available for multiple tests that may apply the template as part of their test action sequence.</p>
</div>
<div class="listingblock">
<div class="title">Apply templates</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ApplyTemplateTest
author: Christoph
status: FINAL
description: Sample test in YAML
actions:
  - applyTemplate:
      name: echo
  - applyTemplate:
      name: echo
      parameters:
        - name: message
          value: "Hello from Citrus!"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example references the <code>echo</code> template and call it as part of the test with <code>&lt;apply-template/&gt;</code>.
You can customize the template parameter to overwrite the default variable <code>text</code> with a custom value.</p>
</div>
<div class="paragraph">
<p>The example above assumes that you have added the template to the Citrus bean registry with the name <code>echo</code>.
If this is not the case you may also reference the file resource path when applying the template:</p>
</div>
<div class="listingblock">
<div class="title">Apply templates</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ApplyTemplateTest
author: Christoph
status: FINAL
description: Sample test in YAML
actions:
  - applyTemplate:
      file: "classpath:templates/yaml/echo-template.yaml"
      parameters:
        - name: message
          value: "Citrus rocks!"</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="run-yaml-template-parameters"><a class="anchor" href="#run-yaml-template-parameters"></a><a class="link" href="#run-yaml-template-parameters">Template parameters</a></h5>
<div class="paragraph">
<p>How to handle test variables when dealing with templates, in particular when templates are defined in separate source files?
A template may use different variable names compared to those names used a test and vice versa.
The template fails immediately when respective variables are not present.
Therefore, templates introduce the concept of parameters to declare its variable names.</p>
</div>
<div class="paragraph">
<p>Assume you have the following template:</p>
</div>
<div class="listingblock">
<div class="title">sayHello template</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: sayHello
description: Sample template in YAML
parameters:
  - name: user
    value: "Citrus"
actions:
  - echo:
      message: "Hello ${user}!"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The template <code>sayHello</code> in the example uses the variable <code>${user}</code>.</p>
</div>
<div class="paragraph">
<p>In case the test case already uses the template parameter as a value you do not need to set this variable explicitly on the apply template action.</p>
</div>
<div class="listingblock">
<div class="title">Implicit template parameter</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SayHelloTemplateTest
author: Christoph
status: FINAL
description: Sample test in YAML
variables:
  - name: "user"
    value: "Christoph"
actions:
  - applyTemplate:
      name: sayHello</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Hello Christoph!</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The implicit template parameter may break as soon as the template or the test changes its parameter or variable name.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The test case may also explicitly set the template parameter when applying the template:</p>
</div>
<div class="listingblock">
<div class="title">Explicit template parameter</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SayHelloTemplateTest
author: Christoph
status: FINAL
description: Sample test in YAML
variables:
  - name: "username"
    value: "Mickey"
actions:
  - applyTemplate:
      name: sayHello
      parameters:
        - name: user
          value: "${username}"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Hello Mickey!</code></pre>
</div>
</div>
<div class="paragraph">
<p>The variable <strong>username</strong> is already present in the test case and gets translated into the <strong>user</strong> parameter.
Following from that the template works fine although test and template do work on different variable names.</p>
</div>
<div class="paragraph">
<p>With template parameters you are able to solve the calibration effort when working with templates and variables.
It is always a good idea to check the used variables/parameters inside a template when calling it.
There might be a variable that is not declared yet inside your test.
So you need to define this value as a parameter.</p>
</div>
</div>
<div class="sect4">
<h5 id="run-yaml-template-paremeter-scope"><a class="anchor" href="#run-yaml-template-paremeter-scope"></a><a class="link" href="#run-yaml-template-paremeter-scope">Template parameter scope</a></h5>
<div class="paragraph">
<p>A template is able to change a test variable value for the rest of the test case.
It is important to know about this when changing test variables in a template as it affects the descendant test actions.
Especially when running test actions or templates in parallel to each other this might lead to unexpected behavior.
You may choose the template parameter scope for this scenario.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When a template works on variable values and parameters changes to these variables will automatically affect the
variables in the whole test. So if you change a variable&#8217;s value inside a template and the variable is defined inside the
test case the changes will affect the variable in a global context. We have to be careful with this when executing a template
several times in a test, especially in combination with parallel containers (see <a href="#containers-parallel">containers-parallel</a>).
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">print template</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: print
description: Sample template in YAML
parameters:
  - name: index
    value: "0"
  - name: area
    value: "Atlantis"
actions:
  - echo:
      message: "#${index} Hello ${area}!"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Global scope parameter (default)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SayHelloTemplateTest
author: Christoph
status: FINAL
description: Sample test in YAML
variables:
  - name: "username"
    value: "Mickey"
actions:
  - parallel:
      actions:
      - applyTemplate:
          name: print
          parameters:
            - name: index
              value: "1"
            - name: area
              value: "Europe"
      - applyTemplate:
          name: print
          parameters:
            - name: index
              value: "2"
            - name: area
              value: "Asia"
      - applyTemplate:
          name: print
          parameters:
            - name: index
              value: "3"
            - name: area
              value: "Africa"</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the listing above a template <strong>print</strong> is called several times in a parallel container.
The parameter values will be handled in a global context, so it is quite likely to happen that the template instances influence each other during execution.
We might get such print messages:</p>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">#2 Hello Europe!
#2 Hello Africa!
#3 Hello Africa!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Index parameters do not fit and the message <strong>'Hello Asia'</strong> is completely gone.
This is because templates overwrite parameters to each other as they are executed in parallel at the same time.
To avoid this behavior we need to tell the template that it should handle parameters as well as variables in a local context.
This will enforce that each template instance is working on a dedicated local context.
See the <strong>globalContext</strong> key that is set to <strong>false</strong> in this example:</p>
</div>
<div class="listingblock">
<div class="title">print template</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: print
description: Sample template in YAML
globalContext: false
parameters:
  - name: index
    value: "0"
  - name: area
    value: "Atlantis"
actions:
  - echo:
      message: "#${index} Hello ${area}!"</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that template instances will not influence each other anymore.
But notice that variable changes inside the template then do not affect the test case neither.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="run-groovy"><a class="anchor" href="#run-groovy"></a><a class="link" href="#run-groovy">5.5. Groovy</a></h3>
<div class="paragraph">
<p>Running Citrus tests in Groovy is a specialization of running Citrus tests in Java.
The Groovy language gives you some syntax sugar and optimized statements that you can use to write your tests.</p>
</div>
<div class="paragraph">
<p>As usual, you need to choose one of the supported test engines in Citrus to actually run the test (e.g. <a href="#runtime-junit5">JUnit Jupiter</a> or <a href="#runtime-testng">TestNG</a>).
You can then use the <code>@CitrusTestSource</code> annotation to load the Groovy code that represents the test case.</p>
</div>
<div class="listingblock">
<div class="title">MyFirstGroovyIT.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.citrusframework;

import org.citrusframework.annotations.CitrusTestSource;
import org.citrusframework.testng.TestNGCitrusSupport;
import org.testng.annotations.Test;

public class MyFirstGroovyIT extends TestNGCitrusSpringSupport {

    @Test
    @CitrusTestSource(type = "groovy", name="my-test.groovy")
    public void myFirstGroovyIT() {
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test logic itself is coded in a Groovy file like this:</p>
</div>
<div class="listingblock">
<div class="title">my-test.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">name "MyFirstGroovyTest"
author "Christoph"
status "FINAL"
description "Sample test in Groovy"

variables {
    text="Hello from Citrus!"
}

actions {
    $(echo().message("${text}"))
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="run-groovy-configuration-dsl"><a class="anchor" href="#run-groovy-configuration-dsl"></a><a class="link" href="#run-groovy-configuration-dsl">5.5.1. Configuration scripts</a></h4>
<div class="paragraph">
<p>A Groovy test is able to create endpoints and other configuration entities as part of the test.
The script creates these instances as beans in the Citrus registry.</p>
</div>
<div class="paragraph">
<p>A configuration script may use methods and closures to define the bean instances.
The configuration script supports following methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>queues()</p>
</li>
<li>
<p>endpoints()</p>
</li>
<li>
<p>beans()</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">my-test.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">configuration {
    queues {
        queue('say-hello')
    }

    endpoints {
        direct('hello')
            .asynchronous()
            .queue('say-hello')
    }

    beans {
        bean(DefaultTextEqualsMessageValidator.class)
    }
}

actions {
    $(send().endpoint(hello)
            .message()
            .body("Hello Citrus!")
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test above creates a new <code>direct</code> endpoint called <code>hello</code> that uses an in-memory queue named <code>say-hello</code>.
Also, the configuration script initializes a new bean instance of type <code>org.citrusframework.validation.DefaultTextEqualsMessageValidator.class</code>.</p>
</div>
<div class="paragraph">
<p>The <code>send</code> test action is able to reference the new endpoint by its name to send a message body to the queue.
A <code>receive</code> test action will automatically resolve the new message validator instance from the Citrus bean registry to perform its message validation.</p>
</div>
<div class="paragraph">
<p>The Groovy language provides a comfortable way to define common beans in the Citrus registry.</p>
</div>
<div class="listingblock">
<div class="title">Create beans in registry</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">configuration {
    beans {
        bean('foo', org.example.foo.FooBean.class)
        fooClient = new org.example.foo.FooClientBuilder().build()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example creates a new instance of <code>FooBean</code> with the id <code>foo</code> in the Citrus bean registry.
The <code>FooBean</code> class must have a default constructor in this case.</p>
</div>
<div class="paragraph">
<p>You can also create the instances on your own (e.g. using a builder factory) as seen with the <code>fooClient</code> bean in this example.</p>
</div>
<div class="paragraph">
<p>All beans added to the Citrus registry are subject to being injected into or resolved by test actions and other components in Citrus.
For instance a JMS test action requires a client connection factory bean instance in the Citrus registry.</p>
</div>
</div>
<div class="sect3">
<h4 id="run-groovy-gherkin"><a class="anchor" href="#run-groovy-gherkin"></a><a class="link" href="#run-groovy-gherkin">5.5.2. Gherkin style syntax</a></h4>
<div class="paragraph">
<p>The Gherkin <code>Given-When-Then</code> syntax helps you to categorize and structure the individual steps in your test.
The Groovy test language in Citrus can use this concept, too.</p>
</div>
<div class="listingblock">
<div class="title">my-test.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">configuration {
    queues {
        queue('say-hello')
    }

    endpoints {
        direct('hello') {
            asynchronous()
                .queue('say-hello')
        }
    }
}

given:
    $(createVariables()
        .variable("text", "Citrus rocks!")
    )

when:
    $(send().endpoint(hello)
            .message()
            .body('${text}')
    )

then:
    $(receive().endpoint(hello)
            .message()
            .body('${text}')
    )</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="run-groovy-message-builder"><a class="anchor" href="#run-groovy-message-builder"></a><a class="link" href="#run-groovy-message-builder">5.5.3. Message builders</a></h4>
<div class="paragraph">
<p>The Groovy language is good choice when it comes to creating domain specific languages.
You can provide syntactical sugar to make it as comfortable as possible to use your domain.</p>
</div>
<div class="paragraph">
<p>As an example you can use message builders to create message body payloads in XML or Json format.</p>
</div>
<div class="listingblock">
<div class="title">my-test.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">configuration {
    queues {
        queue('say-hello')
    }

    endpoints {
        direct('hello') {
            asynchronous()
                .queue('say-hello')
        }
    }
}

given:
    $(createVariables()
        .variable("text", "Citrus rocks!"))

when:
    $(send().endpoint(hello)
        .message {
            body {
                json()
                    .greeting {
                        text '${text}'
                        language 'eng'
                    }
            }
            headers {
                operation = "sayHello"
            }
        })

then:
    $(receive().endpoint(hello)
        .message {
            body().json {
                greeting {
                    text '${text}'
                    language 'eng'
                }
            }
            headers {
                operation = "sayHello"
            }
        })</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above deals with Json message payloads and leverages the message builders to create a Json body like this:</p>
</div>
<div class="listingblock">
<div class="title">body.json</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "greeting": {
    "text": "${text}",
    "language": "eng"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same approach works fine with XML payloads:</p>
</div>
<div class="listingblock">
<div class="title">my-test.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">configuration {
    queues {
        queue('say-hello')
    }

    endpoints {
        direct('hello') {
            asynchronous()
                .queue('say-hello')
        }
    }
}

given:
    $(createVariables()
        .variable("text", "Citrus rocks!"))

when:
    $(send().endpoint(hello)
        .message {
            body {
                xml()
                    .greeting(language: 'eng') {
                        text '${text}'
                    }
            }
            headers {
                operation = "sayHello"
            }
        })

then:
    $(receive().endpoint(hello)
        .message {
            body().xml {
                greeting(language: 'eng') {
                    text '${text}'
                }
            }
            headers {
                operation = "sayHello"
            }
        })</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test actions use the XML message builder and create XML body payloads such as:</p>
</div>
<div class="listingblock">
<div class="title">body.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;greeting language='eng'&gt;
  &lt;text&gt;Citrus rocks!&lt;/text&gt;
&lt;/greeting&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="run-groovy-templates"><a class="anchor" href="#run-groovy-templates"></a><a class="link" href="#run-groovy-templates">5.5.4. Templates</a></h4>
<div class="paragraph">
<p>Templates group action sequences to a logical unit.
You can think of templates as reusable components that are used in several tests.
The maintenance is much more efficient because you need to apply changes only on the templates and all referenced use cases are updated automatically.</p>
</div>
<div class="paragraph">
<p>The template gets identified by a unique name.
Inside a test case we apply the template referencing this unique name.
Have a look at a first example:</p>
</div>
<div class="listingblock">
<div class="title">echo-template.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">name "echo"
description "Sample template in Groovy"

parameters {
    message="Citrus rocks!"
}

actions {
    $(echo().message('${message}'))
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code example above describes a template called <code>echo</code>.
Templates hold a sequence of test actions or calls other templates themselves.
The template may define a set of parameters that represent customizable user input when applying the template.</p>
</div>
<div class="paragraph">
<p>The template is available for multiple tests that may apply the template as part of their test action sequence.</p>
</div>
<div class="listingblock">
<div class="title">Apply templates</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">name "ApplyTemplateTest"
author "Christoph"
status "FINAL"
description "Sample test in Groovy"

actions {
    $(applyTemplate().templateName("echo"))

    $(applyTemplate().templateName("echo")
        .parameter("text", "Hello from Citrus!"))
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example references the <code>echo</code> template and call it as part of the test with <code>applyTemplate()</code>.
You can customize the template parameter to overwrite the default variable <code>text</code> with a custom value.</p>
</div>
<div class="paragraph">
<p>The example above assumes that you have added the template to the Citrus bean registry with the name <code>echo</code>.
If this is not the case you may also reference the file resource path when applying the template:</p>
</div>
<div class="listingblock">
<div class="title">Apply templates</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">actions {
    $(applyTemplate().file("classpath:templates/groovy/echo-template.groovy"))
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="run-groovy-template-parameters"><a class="anchor" href="#run-groovy-template-parameters"></a><a class="link" href="#run-groovy-template-parameters">Template parameters</a></h5>
<div class="paragraph">
<p>How to handle test variables when dealing with templates, in particular when templates are defined in separate source files?
A template may use different variable names compared to those names used a test and vice versa.
The template fails immediately when respective variables are not present.
Therefore, templates introduce the concept of parameters to declare its variable names.</p>
</div>
<div class="paragraph">
<p>Assume you have the following template:</p>
</div>
<div class="listingblock">
<div class="title">sayHello template</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">name "sayHello"
description "Sample template in Groovy"

parameters {
    user="Citrus"
}

actions {
    $(echo().message('Hello ${user}!'))
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The template <code>sayHello</code> in the example uses the variable <code>${user}</code>.</p>
</div>
<div class="paragraph">
<p>In case the test case already uses the template parameter as a value you do not need to set this variable explicitly on the apply template action.</p>
</div>
<div class="listingblock">
<div class="title">Implicit template parameter</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">name "SayHelloTemplateTest"
description "Sample test in Groovy"

variables {
    user = "Christoph"
}

actions {
    $(applyTemplate().templateName("sayHello"))
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Hello Christoph!</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The implicit template parameter may break as soon as the template or the test changes its parameter or variable name.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The test case may also explicitly set the template parameter when applying the template:</p>
</div>
<div class="listingblock">
<div class="title">Explicit template parameter</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">name "SayHelloTemplateTest"
description "Sample test in Groovy"

variables {
    username = "Mickey"
}

actions {
    $(applyTemplate().templateName("sayHello")
        .parameter("user", "${username}"))
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Hello Mickey!</code></pre>
</div>
</div>
<div class="paragraph">
<p>The variable <strong>username</strong> is already present in the test case and gets translated into the <strong>user</strong> parameter.
Following from that the template works fine although test and template do work on different variable names.</p>
</div>
<div class="paragraph">
<p>With template parameters you are able to solve the calibration effort when working with templates and variables.
It is always a good idea to check the used variables/parameters inside a template when calling it.
There might be a variable that is not declared yet inside your test.
So you need to define this value as a parameter.</p>
</div>
</div>
<div class="sect4">
<h5 id="run-groovy-template-paremeter-scope"><a class="anchor" href="#run-groovy-template-paremeter-scope"></a><a class="link" href="#run-groovy-template-paremeter-scope">Template parameter scope</a></h5>
<div class="paragraph">
<p>A template is able to change a test variable value for the rest of the test case.
It is important to know about this when changing test variables in a template as it affects the descendant test actions.
Especially when running test actions or templates in parallel to each other this might lead to unexpected behavior.
You may choose the template parameter scope for this scenario.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When a template works on variable values and parameters changes to these variables will automatically affect the
variables in the whole test. So if you change a variable&#8217;s value inside a template and the variable is defined inside the
test case the changes will affect the variable in a global context. We have to be careful with this when executing a template
several times in a test, especially in combination with parallel containers (see <a href="#containers-parallel">containers-parallel</a>).
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">print template</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">name "print"
description "Sample template in Groovy"

parameters {
    index = "0"
    area = "Atlantis"
}

actions {
    $(echo().message('#${index} Hello ${area}!'))
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Global scope parameter (default)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">actions {
    $(parallel().actions(
        applyTemplate().templateName("print")
            .parameter("index", "1")
            .parameter("area", "Europe"),
        applyTemplate().templateName("print")
            .parameter("index", "2")
            .parameter("area", "Asia"),
        applyTemplate().templateName("print")
            .parameter("index", "3")
            .parameter("area", "Africa")
        )
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the listing above a template <strong>print</strong> is called several times in a parallel container.
The parameter values will be handled in a global context, so it is quite likely to happen that the template instances influence each other during execution.
We might get such print messages:</p>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">#2 Hello Europe!
#2 Hello Africa!
#3 Hello Africa!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Index parameters do not fit and the message <strong>'Hello Asia'</strong> is completely gone.
This is because templates overwrite parameters to each other as they are executed in parallel at the same time.
To avoid this behavior we need to tell the template that it should handle parameters as well as variables in a local context.
This will enforce that each template instance is working on a dedicated local context.
See the <strong>globalContext()</strong> method that is set to <strong>false</strong> in this example:</p>
</div>
<div class="listingblock">
<div class="title">print template</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">name "print"
description "Sample template in Groovy"

globalContext(false)

parameters {
    index = "0"
    area = "Atlantis"
}

actions {
    $(echo().message('#${index} Hello ${area}!'))
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that template instances will not influence each other anymore.
But notice that variable changes inside the template then do not affect the test case neither.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="run-spring-xml-tests"><a class="anchor" href="#run-spring-xml-tests"></a><a class="link" href="#run-spring-xml-tests">5.6. Spring Bean XML</a></h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The Spring bean XML domain specific language for writing tests is deprecated.
Please consider using the arbitrary XML test language syntax instead (see chapter <a href="#run-xml-tests">Run XML tests</a>])
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Spring bean XML domain specific language is a variation of the arbitrary XML domain specific language in Citrus.
The Spring XML file holds all test actions in the form of Spring XML beans.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You need to have the runtime module <code>citrus-spring</code> enabled in your project to use the Spring bean XML test case language.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Citrus uses Spring bean definition parsers to load the XML test actions.
The Spring application context loads the Spring XML test case file as a set of Spring bean configurations.
Citrus runs the resulting test Spring bean as a normal unit test using one of the provided runtimes like <a href="#runtime-junit5">JUnit Jupiter</a> or <a href="#runtime-testng">TestNG</a>.</p>
</div>
<div class="paragraph">
<p>You define the complete test logic in the Spring bean XML file:</p>
</div>
<div class="listingblock">
<div class="title">MyFirstCitrus_IT.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;spring:beans
    xmlns="http://www.citrusframework.org/schema/testcase"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:spring="http://www.springframework.org/schema/beans"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.citrusframework.org/schema/testcase
            http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;

    &lt;testcase name="MyFirstCitrus_IT"&gt;
      &lt;description&gt;
          First example showing the basic test case definition elements!
      &lt;/description&gt;
      &lt;variables&gt;
        &lt;variable name="text" value="Hello Test Framework"/&gt;
      &lt;/variables&gt;
      &lt;actions&gt;
        &lt;echo&gt;
          &lt;message&gt;${text}&lt;/message&gt;
        &lt;/echo&gt;
      &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>All Spring XML test definitions use a custom Spring XML schema that aims to reach the convenience of a domain specific language (DSL).</p>
</div>
<div class="paragraph">
<p>The definition uses the <code>&lt;spring:beans&gt;</code> root element that declares all XML namespaces used in the file.
This is because the XML file will be loaded as a Spring bean definition.
The root element defines a <code>testcase</code> element which represents the actual Citrus test.</p>
</div>
<div class="paragraph">
<p>The test case itself gets a mandatory name that must be unique throughout all test cases in a project.
You will receive errors when using duplicate test names.
The test name has to follow the common Java naming conventions and rules for Java classes.
This means names must not contain whitespace characters except <code>'-'</code>, <code>'.'</code> and <code>'_'</code>.</p>
</div>
<div class="paragraph">
<p>For example, <strong><em>TestFeature_1</em></strong> is valid but <strong><em>Test Feature 1</em></strong> is not because of the space characters.</p>
</div>
<div class="sect3">
<h4 id="run-spring-xml-java-class"><a class="anchor" href="#run-spring-xml-java-class"></a><a class="link" href="#run-spring-xml-java-class">5.6.1. Java test runner</a></h4>
<div class="paragraph">
<p>Despite the fact that the complete test logic is defined in XML we need a Java class to actually load the XML file and run the test as part of
JUnit, Cucumber or TestNG depending on the test engine you choose.
The Java class acts as a wrapper to load the XML file and execute the test.</p>
</div>
<div class="paragraph">
<p>The Spring XML test case definition in Citrus uses two files that are connected via naming conventions.
In a Maven project these two files would be:</p>
</div>
<div class="listingblock">
<div class="title">XML test case files</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">src/test/java/org/citrusframework/MyFirstCitrus_IT.java
src/test/resources/org/citrusframework/MyFirstCitrus_IT.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The files above represent a test called <code>MyFirstCitrus_IT</code>.
The <code>.java</code> file defines the runtime that should be used to execute the test.
This Java file does not have any test logic and is not likely to be changed.
In fact, you can generate the Java file from Citrus (e.g. Maven plugin).</p>
</div>
<div class="listingblock">
<div class="title">Generate test files via Maven plugin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">mvn citrus:create-test</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Interactive test creation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Enter test name:: MyFirstCitrus_IT
Enter test author: Unknown::
Enter test description:: Sample XML test
Enter test package: org.citrusframework::
Choose unit test framework: (testng/junit4/junit5) testng::
Choose target code base type: (java/xml) java:: xml
Create test with XML schema? (y/n) n::
Create test with WSDL? (y/n) n::
Create test with Swagger API? (y/n) n::

Confirm test creation:
type: xml
framework: testng
name: MyFirstCitrus_IT
author: Unknown
description:
package: org.citrusframework
 (y/n) y:: y

[INFO] Successfully created new test case org.citrusframework.MyFirstCitrus_IT</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command above creates the two test files (<code>.java</code> and <code>.xml</code>) using an interactive mode.
The user provides the test case information such as test name, package, runtime and so on.</p>
</div>
<div class="listingblock">
<div class="title">MyFirstCitrus_IT.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.citrusframework;

import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTestSource;
import org.citrusframework.testng.TestNGCitrusSupport;
import org.testng.annotations.Optional;
import org.testng.annotations.Parameters;
import org.testng.annotations.Test;

public class MyFirstCitrus_IT extends TestNGCitrusSpringSupport {

    @Test
    @CitrusTestSource(type = "spring", name="MyFirstCitrus_IT")
    public void myFirstCitrus_IT() {
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The purpose of the generated Java class is to load the XML file as a Spring bean test and execute the test case.</p>
</div>
<div class="paragraph">
<p>The default naming convention requires the XML file with the test name in the same package as the generated Java class.
This makes sure that the Java class is able to find the XML file when loading and running the test.</p>
</div>
</div>
<div class="sect3">
<h4 id="run-spring-xml-test-meta-info"><a class="anchor" href="#run-spring-xml-test-meta-info"></a><a class="link" href="#run-spring-xml-test-meta-info">5.6.2. Test meta information</a></h4>
<div class="paragraph">
<p>The user is able to provide some additional information about the test case.
The meta-info section at the very beginning of the test case holds information like author, status or creation date.</p>
</div>
<div class="listingblock">
<div class="title">Test meta information</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="metaInfoTest"&gt;
    &lt;meta-info&gt;
        &lt;author&gt;Christoph Deppisch&lt;/author&gt;
        &lt;creationdate&gt;2008-01-11&lt;/creationdate&gt;
        &lt;status&gt;FINAL&lt;/status&gt;
        &lt;last-updated-by&gt;Christoph Deppisch&lt;/last-updated-by&gt;
        &lt;last-updated-on&gt;2008-01-11T10:00:00&lt;/last-updated-on&gt;
    &lt;/meta-info&gt;
    &lt;description&gt;
        ...
    &lt;/description&gt;
    &lt;actions&gt;
        ...
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The status allows the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DRAFT</p>
</li>
<li>
<p>READY_FOR_REVIEW</p>
</li>
<li>
<p>DISABLED</p>
</li>
<li>
<p>FINAL</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This information gives the reader first impression about the test and is also used to generate test documentation.
By default, Citrus is able to generate test reports in HTML and Excel in order to list all tests with their metadata information and description.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Tests with the status DISABLED will not be executed during a test suite run.
So someone can just start adding planned test cases that are not finished yet in status DRAFT.
In case a test is not runnable yet because it is not finished, someone may disable a test temporarily to avoid causing failures during a test run.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The test description should give a short introduction to the intended use case scenario that will be tested.
The user should get a short summary of what the test case is trying to verify.
You can use free text in your test description no limit to the number of characters.
Please be aware of the XML validation rules of well-formed XML (e.g. special character escaping).
The usage of CDATA sections for large descriptions may be a good idea, too.</p>
</div>
</div>
<div class="sect3">
<h4 id="run-spring-xml-test-finally"><a class="anchor" href="#run-spring-xml-test-finally"></a><a class="link" href="#run-spring-xml-test-finally">5.6.3. Finally block</a></h4>
<div class="paragraph">
<p>Java developers might be familiar with the concept of try-catch-finally blocks. The <strong><em>finally</em></strong> section contains a list of
test actions that will be executed guaranteed at the very end of the test case even if errors did occur during the execution before.</p>
</div>
<div class="paragraph">
<p>This is the right place to tidy up things that were previously created by the test like cleaning up the database for instance.</p>
</div>
<div class="listingblock">
<div class="title">Finally block</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;finally&gt;
    &lt;echo&gt;
        &lt;message&gt;Do finally - regardless of what has happened before&lt;/message&gt;
    &lt;/echo&gt;
&lt;/finally&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an example imagine that you have prepared some data inside the database at the beginning of the test and you need to make
sure the data is cleaned up at the end of the test case.</p>
</div>
<div class="listingblock">
<div class="title">Finally block example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="finallyTest"&gt;
    &lt;variables&gt;
        &lt;variable name="orderId" value="citrus:randomNumber(5)"/&gt;
        &lt;variable name="date" value="citrus:currentDate('dd.MM.yyyy')"/&gt;
    &lt;/variables&gt;
    &lt;actions&gt;
        &lt;sql datasource="testDataSource"&gt;
            &lt;statement&gt;
                INSERT INTO ORDERS VALUES (${orderId}, 1, 1, '${date}')
            &lt;/statement&gt;
        &lt;/sql&gt;

        &lt;echo&gt;
            &lt;message&gt;
                ORDER creation time: ${date}
            &lt;/message&gt;
        &lt;/echo&gt;
    &lt;/actions&gt;
    &lt;finally&gt;
        &lt;sql datasource="testDataSource"&gt;
            &lt;statement&gt;
              DELETE FROM ORDERS WHERE ORDER_ID='${orderId}'
            &lt;/statement&gt;
        &lt;/sql&gt;
    &lt;/finally&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example the first action creates an entry in the database using an <strong><em>INSERT</em></strong> statement.
To be sure that the entry in the database is deleted after the test, the finally section contains the respective <strong><em>DELETE</em></strong> statement that is always
executed regardless the test case state (successful or failed).</p>
</div>
</div>
<div class="sect3">
<h4 id="run-spring-xml-test-variables-cdata"><a class="anchor" href="#run-spring-xml-test-variables-cdata"></a><a class="link" href="#run-spring-xml-test-variables-cdata">5.6.4. Variables with CDATA sections</a></h4>
<div class="paragraph">
<p>When using the XML test definition you must obey the XML rules for variable values.
First of all you need to escape XML reserved characters such as <code>&lt;</code>, <code>&amp;</code> or <code>"</code> with <code>&lt;</code>, <code>&amp;</code> or <code>&quot;</code>.
Other values such as XML snippets would also interfere with the XML well-formed paradigm.
You can use CDATA sections within the variable value element as a solution.</p>
</div>
<div class="listingblock">
<div class="title">Variable CDATA sections</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variables&gt;
  &lt;variable name="persons"&gt;
    &lt;value&gt;
      &lt;data&gt;
        &lt;![CDATA[
          &lt;persons&gt;
            &lt;person&gt;
              &lt;name&gt;Theodor&lt;/name&gt;
              &lt;age&gt;10&lt;/age&gt;
            &lt;/person&gt;
            &lt;person&gt;
              &lt;name&gt;Alvin&lt;/name&gt;
              &lt;age&gt;9&lt;/age&gt;
            &lt;/person&gt;
          &lt;/persons&gt;
        ]]&gt;
      &lt;/data&gt;
    &lt;/value&gt;
  &lt;/variable&gt;
&lt;/variables&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>That is how you can use structured variable values in the XML DSL.</p>
</div>
</div>
<div class="sect3">
<h4 id="run-spring-xml-variables-groovy"><a class="anchor" href="#run-spring-xml-variables-groovy"></a><a class="link" href="#run-spring-xml-variables-groovy">5.6.5. Variables with Groovy</a></h4>
<div class="paragraph">
<p>You can also use a script to create variable values.
This is extremely handy when you have very complex variable values.
Just code a small Groovy script for instance in order to define the variable value.
A small sample should give you the idea how that works:</p>
</div>
<div class="listingblock">
<div class="title">Groovy variable script</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variables&gt;
  &lt;variable name="avg"&gt;
    &lt;value&gt;
      &lt;script type="groovy"&gt;
        &lt;![CDATA[
          a = 4
          b = 6
          return (a + b) / 2
        ]]&gt;
      &lt;/script&gt;
    &lt;/value&gt;
  &lt;/variable&gt;
  &lt;variable name="sum"&gt;
    &lt;value&gt;
      &lt;script type="groovy"&gt;
        &lt;![CDATA[
          5 + 5
        ]]&gt;
      &lt;/script&gt;
    &lt;/value&gt;
  &lt;/variable&gt;
&lt;/variables&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just use the script code right inside the variable value definition.
The value of the variable is the result of the last operation performed within the script.
For longer script code the use of <code>&lt;![CDATA[ ]]&gt;</code> sections is recommended.</p>
</div>
<div class="paragraph">
<p>Citrus uses the JavaScript engine mechanism to evaluate the script code.
By default, Groovy is supported as a script engine implementation.
You can add additional engine implementations to your project and support other script types, too.</p>
</div>
</div>
<div class="sect3">
<h4 id="run-spring-xml-templates"><a class="anchor" href="#run-spring-xml-templates"></a><a class="link" href="#run-spring-xml-templates">5.6.6. Templates</a></h4>
<div class="paragraph">
<p>Templates group action sequences to a logical unit.
You can think of templates as reusable components that are used in several XML tests.
The maintenance is much more efficient because you need to apply changes only on the templates and all referenced use cases are updated automatically.</p>
</div>
<div class="paragraph">
<p>The template always has a unique name.
Inside a test case we call the template by this unique name.
Have a look at a first example:</p>
</div>
<div class="listingblock">
<div class="title">XML templates</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;template name="doCreateVariables"&gt;
    &lt;create-variables&gt;
        &lt;variable name="var" value="123456789"/&gt;
    &lt;/create-variables&gt;

    &lt;call-template name="doTraceVariables"/&gt;
&lt;/template&gt;

&lt;template name="doTraceVariables"&gt;
    &lt;echo&gt;
        &lt;message&gt;Current time is: ${time}&lt;/message&gt;
    &lt;/echo&gt;

    &lt;trace-variables/&gt;
&lt;/template&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code example above describes two template definitions.
Templates hold a sequence of test actions or call other templates themselves as seen in the example above.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>&lt;call-template&gt;</code> action calls other templates by their name.
The called template not necessarily has to be located in the same test case XML file.
The template might be defined in a separate XML file other than the test case itself:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Call XML templates</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="templateTest"&gt;
    &lt;variables&gt;
        &lt;variable name="myTime" value="citrus:currentDate()"/&gt;
    &lt;/variables&gt;
    &lt;actions&gt;
        &lt;call-template name="doCreateVariables"/&gt;

        &lt;call-template name="doTraceVariables"&gt;
            &lt;parameter name="time" value="${myTime}"&gt;
        &lt;/call-template&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is an open question when dealing with templates that are defined somewhere else outside the test case.
How to handle variables? A templates may use different variable names then the test and vice versa.
No doubt the template will fail as soon as special variables with respective values are not present.
Unknown variables cause the template and the whole test to fail with errors.</p>
</div>
<div class="paragraph">
<p>So a first approach would be to harmonize variable usage across templates and test cases, so that templates and test cases
do use the same variable naming.
But this approach might lead to high calibration effort.
Therefore, templates support parameters to solve this problem.
When a template is called the calling actor is able to set some parameters.
Let us discuss an example for this issue.</p>
</div>
<div class="paragraph">
<p>The template "doDateConversion" in the next sample uses the variable ${date}.
The calling test case can set this variable as a parameter without actually declaring the variable in the test itself:</p>
</div>
<div class="listingblock">
<div class="title">Template parameter</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;call-template name="doDateConversion"&gt;
    &lt;parameter name="date" value="${sampleDate}"/&gt;
&lt;/call-template&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The variable <strong>sampleDate</strong> is already present in the test case and gets translated into the <strong>date</strong> parameter.
Following from that the template works fine although test and template do work on different variable namings.</p>
</div>
<div class="paragraph">
<p>With template parameters you are able to solve the calibration effort when working with templates and variables.
It is always a good idea to check the used variables/parameters inside a template when calling it.
There might be a variable that is not declared yet inside your test.
So you need to define this value as a parameter.</p>
</div>
<div class="paragraph">
<p>Template parameters may contain more complex values like XML fragments.
The call-template action offers following CDATA variation for defining complex parameter values:</p>
</div>
<div class="listingblock">
<div class="title">Complex parameter values</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;call-template name="printXMLPayload"&gt;
    &lt;parameter name="payload"&gt;
      &lt;value&gt;
        &lt;![CDATA[
          &lt;HelloRequest xmlns="http://citrusframework.org/schemas/samples/sayHello.xsd"&gt;
            &lt;Text&gt;Hello South ${var}&lt;/Text&gt;
          &lt;/HelloRequest&gt;
        ]]&gt;
      &lt;/value&gt;
    &lt;/parameter&gt;
&lt;/call-template&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When a template works on variable values and parameters changes to these variables will automatically affect the
variables in the whole test. So if you change a variable&#8217;s value inside a template and the variable is defined inside the
test case the changes will affect the variable in a global context. We have to be careful with this when executing a template
several times in a test, especially in combination with parallel containers (see <a href="#containers-parallel">containers-parallel</a>).
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Global scope parameter</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;parallel&gt;
    &lt;call-template name="print"&gt;
        &lt;parameter name="param1" value="1"/&gt;
        &lt;parameter name="param2" value="Hello Europe"/&gt;
    &lt;/call-template&gt;
    &lt;call-template name="print"&gt;
        &lt;parameter name="param1" value="2"/&gt;
        &lt;parameter name="param2" value="Hello Asia"/&gt;
    &lt;/call-template&gt;
    &lt;call-template name="print"&gt;
        &lt;parameter name="param1" value="3"/&gt;
        &lt;parameter name="param2" value="Hello Africa"/&gt;
    &lt;/call-template&gt;
&lt;/parallel&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the listing above a template <strong>print</strong> is called several times in a parallel container.
The parameter values will be handled in a global context, so it is quite likely to happen that the template instances influence each other during execution. We might get such print messages:</p>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">2. Hello Europe
2. Hello Africa
3. Hello Africa</code></pre>
</div>
</div>
<div class="paragraph">
<p>Index parameters do not fit and the message <strong>'Hello Asia'</strong> is completely gone.
This is because templates overwrite parameters to each other as they are executed in parallel at the same time.
To avoid this behavior we need to tell the template that it should handle parameters as well as variables in a local context.
This will enforce that each template instance is working on a dedicated local context. See the <strong>global-context</strong> attribute that is set to <strong>false</strong> in this example:</p>
</div>
<div class="listingblock">
<div class="title">Local scope parameter</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;template name="print" global-context="false"&gt;
    &lt;echo&gt;
        &lt;message&gt;${param1}.${param2}&lt;/message&gt;
    &lt;/echo&gt;
&lt;/template&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that template instances won&#8217;t influence each other anymore.
But notice that variable changes inside the template then do not affect the test case neither.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="test-variables"><a class="anchor" href="#test-variables"></a><a class="link" href="#test-variables">6. Test variables</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The usage of test variables is a core concept when writing maintainable tests. The key identifiers of a test case should
be exposed as test variables at the very beginning of a test. This avoids hard coded identifiers and multiple redundant values
inside the test.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public void fooService_IT() {
    variable("text", "Hello Citrus!");
    variable("customerId", "123456789");

    run(echo("Text: ${text} Id: ${id}"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="FooService_IT"&gt;
  &lt;variables&gt;
    &lt;variable name="text" value="Hello Citrus!"/&gt;
    &lt;variable name="customerId" value="123456789"/&gt;
  &lt;/variables&gt;

  &lt;actions&gt;
    &lt;echo&gt;
      &lt;message&gt;Text: ${text} Id: ${id}&lt;/message&gt;
    &lt;/echo&gt;
  &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Test variables help significantly when writing complex tests with lots of identifiers and semantic data. The
variables are valid for the whole test case. You can reference a variable multiple times using a common variable
expression <code>${variable-name}</code>.</p>
</div>
<div class="paragraph">
<p>The usage of variables should make the test easier to maintain and more flexible. All essential entities and identifiers are present
right at the beginning of the test, which may also give the opportunity to easily create test variants by simply changing
the variable values for other test scenarios (e.g. different error codes, identifiers).</p>
</div>
<div class="paragraph">
<p>The name of the variable is arbitrary. Of course, you need to be careful with special characters and reserved XML entities
like '&amp;', '&lt;', '&gt;'. In general, you can apply to the Java naming convention, and you will be fine.</p>
</div>
<div class="sect2">
<h3 id="global-variables"><a class="anchor" href="#global-variables"></a><a class="link" href="#global-variables">6.1. Global variables</a></h3>
<div class="paragraph">
<p>You can work with different variable scopes (local or global). Local variables are accessible throughout a single test.
Global variables are visible for all tests yet global variables are immutable, so tests cannot change their values.</p>
</div>
<div class="paragraph">
<p>This is a good opportunity to declare constant values for all tests. As these variables are global we need to add those
to the basic Citrus context. The following example demonstrates how to add global variables in Citrus:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public GlobalVariables globalVariables() {
    return new GlobalVariables.Builder()
        .variable("projectName", "Citrus Integration Testing")
        .variable("userName", "TestUser")
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public GlobalVariables globalVariables() {
    return new GlobalVariables.Builder()
        .variable("projectName", "Citrus Integration Testing")
        .variable("userName", "TestUser")
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;

    &lt;citrus:global-variables&gt;
      &lt;citrus:variable name="projectName" value="Citrus Integration Testing"/&gt;
      &lt;citrus:variable name="userName" value="TestUser"/&gt;
    &lt;/citrus:global-variables&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We add the Spring bean component to the application context file. The component receives a list of name-value variable
elements. You can reference the global variables in your test cases as usual.</p>
</div>
<div class="paragraph">
<p>Another possibility to set global variables is to load those from external property files. This may give you more powerful
global variables with user specific properties for instance. See how to load property files as global variables in this example:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public GlobalVariablesPropertyLoader propertyLoader() {
    GlobalVariablesPropertyLoader propertyLoader = new GlobalVariablesPropertyLoader();

    propertyLoader.getPropertyFiles().add("classpath:global-variable.properties");

    return propertyLoader;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public GlobalVariablesPropertyLoader propertyLoader() {
    GlobalVariablesPropertyLoader propertyLoader = new GlobalVariablesPropertyLoader();

    propertyLoader.getPropertyFiles().add("classpath:global-variable.properties");

    return propertyLoader;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;

    &lt;citrus:global-variables&gt;
      &lt;citrus:file path="classpath:global-variable.properties"/&gt;
    &lt;/citrus:global-variables&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the <code>GlobalVariablesPropertyLoader</code> component and add it to the context as a Spring bean. Citrus loads the
given property file content as global test variables. You can mix property file and name-value pair variable definitions
in the global variables component.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The global variables can have variable expressions and Citrus functions. It is possible to use previously defined
global variables as values of new variables, like in this example:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">global-variable.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">user=Citrus
greeting=Hello ${user}!
date=citrus:currentDate('yyyy-MM-dd')</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="variables-extract"><a class="anchor" href="#variables-extract"></a><a class="link" href="#variables-extract">6.2. Extract variables</a></h3>
<div class="paragraph">
<p>Imagine you receive a message in your test with some generated message identifier values. You have no chance to predict the
identifier value because it was generated at runtime by a foreign application. You can ignore the value in order to protect
your validation. In many cases you might want to save this identifier in order to use this value in the respective response
message or somewhat later on in the test.</p>
</div>
<div class="paragraph">
<p>The solution is to extract dynamic values from received messages and save those to test variables at runtime.</p>
</div>
<div class="sect3">
<h4 id="variables-extract-json-path"><a class="anchor" href="#variables-extract-json-path"></a><a class="link" href="#variables-extract-json-path">6.2.1. JsonPath expressions</a></h4>
<div class="paragraph">
<p>When an incoming message is passing the message validation the user can extract some values of that received message to
new test variables for later use in the test.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;message type="json"&gt;
  &lt;data&gt;
    { "user":
      {
        "name": "Admin",
        "password": "secret",
        "admin": "true",
        "aliases": ["penny","chef","master"]
      }
    }
  &lt;/data&gt;
  &lt;extract&gt;
    &lt;message path="$.user.name" variable="userName"/&gt;
    &lt;message path="$.user.aliases" variable="userAliases"/&gt;
    &lt;message path="$.user[?(@.admin)].password" variable="adminPassword"/&gt;
  &lt;/extract&gt;
&lt;/message&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this example we have extracted three new test variables via JSONPath expression evaluation. The three test variables
will be available to all upcoming test actions. The variable values are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">userName=Admin
userAliases=["penny","chef","master"]
adminPassword=secret</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we can also extract complex JSONObject items or JSONArray items. The test variable value is a String representation
of the complex object.</p>
</div>
</div>
<div class="sect3">
<h4 id="variables-extract-xpath"><a class="anchor" href="#variables-extract-xpath"></a><a class="link" href="#variables-extract-xpath">6.2.2. XPath expressions</a></h4>
<div class="paragraph">
<p>Add this code to your message receiving action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void receiveMessageTest() {
    when(
        receive("helloService")
            .extract(extract().fromBody()
                    .expression("//TestRequest/VersionId", "versionId"))
            .extract(extract().fromHeaders()
                    .header("Operation", "operation"))
    );

    then(
        echo("Operation from header is: ${operation}")
    );

    then(
        echo("Version from body is: ${versionId}")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ReceiveMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;receive endpoint="helloService"&gt;
        &lt;message&gt;
          &lt;body&gt;
              &lt;data&gt;[...]&lt;/data&gt;
          &lt;/body&gt;
        &lt;/message&gt;
        &lt;extract&gt;
          &lt;header name="Operation"
                  variable="operation"/&gt;
          &lt;body path="/TestRequest/VersionId"
                variable="versionId"/&gt;
        &lt;/extract&gt;
      &lt;/receive&gt;

      &lt;echo&gt;
        &lt;message&gt;Operation from header is: ${operation}&lt;/message&gt;
      &lt;/echo&gt;

      &lt;echo&gt;
        &lt;message&gt;Version from body is: ${versionId}&lt;/message&gt;
      &lt;/echo&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ReceiveMessageTest
actions:
  - receive:
      endpoint: helloService
      message:
        body:
          data: {}
        extract:
          header:
            - name: "Operation"
              variable: "operation"
          body:
            - path: "/TestRequest/VersionId"
              variable: "versionId"
  - echo:
      message: "Operation from header is: ${operation}"
  - echo:
      message: "Version from body is: ${versionId}"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;
  &lt;testcase name="ReceiveMessageTest"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="helloService"&gt;
            &lt;message&gt;
              &lt;data&gt;[...]&lt;/data&gt;
            &lt;/message&gt;
            &lt;extract&gt;
              &lt;header name="Operation"
                      variable="operation"/&gt;
              &lt;message path="/TestRequest/VersionId"
                       variable="versionId"/&gt;
            &lt;/extract&gt;
        &lt;/receive&gt;

        &lt;echo&gt;
          &lt;message&gt;Operation from header is: ${operation}&lt;/message&gt;
        &lt;/echo&gt;

        &lt;echo&gt;
          &lt;message&gt;Version from body is: ${versionId}&lt;/message&gt;
        &lt;/echo&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see Citrus is able to extract both header and message body content into test variables. The extraction will automatically
create a new variable in case it does not exist. The time the variable was created all following test actions can access the
test variables as usual. So you can reference the variable values in response messages or other test steps ahead.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
We can also use expression result types in order to manipulate the test variable outcome. In case we use a <strong>boolean</strong> result
type the existence of elements can be saved to variable values. The result type <strong>node-set</strong> translates a node list result to
a comma separated string of all values in this node list. Simply use the expression result type attributes as shown in previous
sections.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="variables-path-expressions"><a class="anchor" href="#variables-path-expressions"></a><a class="link" href="#variables-path-expressions">6.3. Path expressions</a></h3>
<div class="paragraph">
<p>Some elements in message body might be of dynamic nature. Just think of generated identifiers or timestamps. This is the right
time to use test variables and dynamic message element overwrite. You can overwrite specific elements in the message body
with path expressions (XPath or JsonPath).</p>
</div>
<div class="sect3">
<h4 id="variables-json-path-expressions"><a class="anchor" href="#variables-json-path-expressions"></a><a class="link" href="#variables-json-path-expressions">6.3.1. JsonPath expressions</a></h4>
<div class="paragraph">
<p>First thing we want to do with JsonPath is to manipulate a message content before it is actually processed. This is very
useful when working with message file resources that are reused across multiple test cases. Each test case can manipulate
the message content individually with JsonPath before processing the message content.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a look at this simple sample Json message body:</p>
</div>
<div class="listingblock">
<div class="title">Json message body user.json</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{ "user":
  {
    "id": citrus:randomNumber(10),
    "name": "Unknown",
    "admin": "?",
    "projects":
      [{
        "name": "Project1",
        "status": "open"
      },
      {
        "name": "Project2",
        "status": "open"
      },
      {
        "name": "Project3",
        "status": "closed"
      }]
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus can load the file content and uses it as message body when sending or receiving messages in a test case. You can apply
JsonPath expressions in order to manipulate the message content.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;message type="json"&gt;
  &lt;resource file="file:path/to/user.json" /&gt;
  &lt;element path="$.user.name" value="Admin" /&gt;
  &lt;element path="$.user.admin" value="true" /&gt;
  &lt;element path="$..status" value="closed" /&gt;
&lt;/message&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When all path expressions are evaluated the resulting message looks like follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{ "user":
  {
    "id": citrus:randomNumber(10),
    "name": "Admin",
    "admin": "true",
    "projects":
      [{
        "name": "Project1",
        "status": "closed"
      },
      {
        "name": "Project2",
        "status": "closed"
      },
      {
        "name": "Project3",
        "status": "closed"
      }]
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JsonPath expressions set the username to <strong>Admin</strong> . The <strong>admin</strong> boolean property was set to <strong>true</strong> and all project
status values were set to <strong>closed</strong>. In case a JsonPath expression should fail to find a matching element within the message
structure the test case will fail.</p>
</div>
<div class="paragraph">
<p>With this JsonPath mechanism you are able to manipulate message content before it is sent or received within Citrus. This
makes life very easy when using message resource files that are reused across multiple test cases.</p>
</div>
</div>
<div class="sect3">
<h4 id="variables-xpath-expressions"><a class="anchor" href="#variables-xpath-expressions"></a><a class="link" href="#variables-xpath-expressions">6.3.2. XPath expressions</a></h4>
<div class="paragraph">
<p>In case of XML message bodies you can use XPath expressions to manipulate the body content before any message processing
takes place.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void receiveMessageTest() {
    receive("helloService")
        .message()
            .header("Operation", "sayHello")
            .body("""
            &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
              &lt;MessageId&gt;${messageId}&lt;/MessageId&gt;
              &lt;CreatedAt&gt;?&lt;/CreatedAt&gt;
              &lt;VersionId&gt;${version}&lt;/VersionId&gt;
            &lt;/TestMessage&gt;
            """)
            .process(processor().path()
                .expression("/TestMessage/CreatedAt", "${date}"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ReceiveMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;receive endpoint="helloService"&gt;
        &lt;message&gt;
          &lt;headers&gt;
            &lt;header name="Operation" value="sayHello"/&gt;
          &lt;/headers&gt;
          &lt;body&gt;
            &lt;payload&gt;
                &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                  &lt;MessageId&gt;${messageId}&lt;/MessageId&gt;
                  &lt;CreatedAt&gt;?&lt;/CreatedAt&gt;
                  &lt;VersionId&gt;${version}&lt;/VersionId&gt;
                &lt;/TestMessage&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
          &lt;expression path="/TestMessage/CreatedAt" value="${date}"/&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ReceiveMessageTest
actions:
  - receive:
      endpoint: helloService
      message:
        body:
          data: |
            &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
              &lt;MessageId&gt;${messageId}&lt;/MessageId&gt;
              &lt;CreatedAt&gt;?&lt;/CreatedAt&gt;
              &lt;VersionId&gt;${version}&lt;/VersionId&gt;
            &lt;/TestMessage&gt;
        expressions:
          - path: "/TestMessage/CreatedAt"
            value: "${date}"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;
  &lt;testcase name="ReceiveMessageTest"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="helloService"&gt;
            &lt;message&gt;
              &lt;payload&gt;
                &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                  &lt;MessageId&gt;${messageId}&lt;/MessageId&gt;
                  &lt;CreatedAt&gt;?&lt;/CreatedAt&gt;
                  &lt;VersionId&gt;${version}&lt;/VersionId&gt;
                &lt;/TestMessage&gt;
              &lt;/payload&gt;
              &lt;element path="/TestMessage/CreatedAt" value="${date}"/&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The program listing above shows ways of setting variable values inside a message template. First you can simply place variable
expressions inside the message (see how <code>${messageId}</code> is used in the sample). In addition to that you can also use path
expressions to explicitly overwrite message elements before message processing takes place.</p>
</div>
<div class="paragraph">
<p>The sample above uses an XPath expression that evaluates and searches for the right element in the message body in order
to set the given value. The previously defined variable <strong>${date}</strong> replaces the respective element value. Of course this
works with XML attributes too (e.g. path expression <code>/TestMessage/Person/@age</code>).</p>
</div>
<div class="paragraph">
<p>Both ways via XPath or JsonPath or inline variable expressions are equal to each other. With respect to the complexity of
XML namespaces and XPath you may find the inline variable expression more comfortable to use. Anyway feel free to choose
the way that fits best for you.</p>
</div>
<div class="paragraph">
<p>This is how you can overwrite values in message templates in order to increase maintainability and robustness of your test.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Validation matchers put validation mechanisms to a new level offering dynamic assertion statements for validation.
Have a look at the possibilities with assertion statements in <a href="#validation-matcher">validation-matcher</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="escaping-variables-expression"><a class="anchor" href="#escaping-variables-expression"></a><a class="link" href="#escaping-variables-expression">6.4. Escape variables</a></h3>
<div class="paragraph">
<p>The test variable expression syntax <code>${variable-name}</code> is preserved to evaluate to a test variable within the current
test context. In case the same syntax is used in one of your message content values you need to escape the syntax from
being interpreted as test variable expression. You can do this by using the variable expression escaping character sequence
<code>//</code> wrapping the actual variable name like this:</p>
</div>
<div class="listingblock">
<div class="title">Plain text message content with escapes</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">This is an escaped variable expression ${//escaped//} and should not lead to unknown variable exceptions within Citrus.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The escaped expression <code>${//escaped//}</code> above will result in the string <strong>${escaped}</strong> where <em>escaped</em> is not treated as a
test variable name but as a normal string in the message body.</p>
</div>
<div class="paragraph">
<p>This way you are able to have the same variable syntax in a message content without interfering with the Citrus variable
expression syntax. As a result Citrus will not complain about not finding the test variable <strong>escaped</strong> in the current context.</p>
</div>
<div class="paragraph">
<p>The variable syntax escaping characters <code>//</code> are automatically removed when the expression is processed by Citrus. So we
will get the following result after processing.</p>
</div>
<div class="listingblock">
<div class="title">Parsed plain text mesage content</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">This is an escaped variable expression ${escaped} and should not lead to unknown variable exceptions within Citrus.</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="message-validation"><a class="anchor" href="#message-validation"></a><a class="link" href="#message-validation">7. Message validation</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>When Citrus receives a message from external applications it is time to verify the message content. This message validation
includes syntax rules with schema validation and message content comparison to expected templates. Citrus provides powerful
message validation capabilities for different data formats. The tester is able to define expected message headers and body
content. The Citrus message validator finds values not matching the expectations and reports the difference as test failure.</p>
</div>
<div class="sect2">
<h3 id="message-validator-registry"><a class="anchor" href="#message-validator-registry"></a><a class="link" href="#message-validator-registry">7.1. Validation registry</a></h3>
<div class="paragraph">
<p>Citrus provides default message validator implementations for different data formats. The Citrus project context
automatically loads these default message validators. In case one of these message validators matches the incoming
message the message validator performs its validation steps with the message.</p>
</div>
<div class="paragraph">
<p>All default message validators can be overwritten by binding a component with the same id to the project context (e.g. as
Spring bean in the application context).</p>
</div>
<div class="paragraph">
<p>The default message validator implementations of Citrus are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
defaultXmlMessageValidator
</td>
<td class="hdlist2">
<p>org.citrusframework.validation.xml.DomXmlMessageValidator</p>
</td>
</tr>
<tr>
<td class="hdlist1">
defaultXpathMessageValidator
</td>
<td class="hdlist2">
<p>org.citrusframework.validation.xml.XpathMessageValidator</p>
</td>
</tr>
<tr>
<td class="hdlist1">
defaultJsonMessageValidator
</td>
<td class="hdlist2">
<p>org.citrusframework.validation.json.JsonTextMessageValidator</p>
</td>
</tr>
<tr>
<td class="hdlist1">
defaultJsonPathMessageValidator
</td>
<td class="hdlist2">
<p>org.citrusframework.validation.json.JsonPathMessageValidator</p>
</td>
</tr>
<tr>
<td class="hdlist1">
defaultPlaintextMessageValidator
</td>
<td class="hdlist2">
<p>org.citrusframework.validation.text.PlainTextMessageValidator</p>
</td>
</tr>
<tr>
<td class="hdlist1">
defaultYamlMessageValidator
</td>
<td class="hdlist2">
<p>org.citrusframework.validation.yaml.YamlMessageValidator</p>
</td>
</tr>
<tr>
<td class="hdlist1">
defaultMessageHeaderValidator
</td>
<td class="hdlist2">
<p>org.citrusframework.validation.DefaultMessageHeaderValidator</p>
</td>
</tr>
<tr>
<td class="hdlist1">
defaultBinaryBase64MessageValidator
</td>
<td class="hdlist2">
<p>org.citrusframework.validation.text.BinaryBase64MessageValidator</p>
</td>
</tr>
<tr>
<td class="hdlist1">
defaultGzipBinaryBase64MessageValidator
</td>
<td class="hdlist2">
<p>org.citrusframework.validation.text.GzipBinaryBase64MessageValidator</p>
</td>
</tr>
<tr>
<td class="hdlist1">
defaultXhtmlMessageValidator
</td>
<td class="hdlist2">
<p>org.citrusframework.validation.xhtml.XhtmlMessageValidator</p>
</td>
</tr>
<tr>
<td class="hdlist1">
defaultGroovyXmlMessageValidator
</td>
<td class="hdlist2">
<p>org.citrusframework.validation.script.GroovyXmlMessageValidator</p>
</td>
</tr>
<tr>
<td class="hdlist1">
defaultGroovyTextMessageValidator
</td>
<td class="hdlist2">
<p>org.citrusframework.validation.script.GroovyScriptMessageValidator</p>
</td>
</tr>
<tr>
<td class="hdlist1">
defaultGroovyJsonMessageValidator
</td>
<td class="hdlist2">
<p>org.citrusframework.validation.script.GroovyJsonMessageValidator</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can overwrite a default message validator with a custom implementation. Just add your customized validator implementation
as a bean to the Citrus context and use one of the default bean identifiers.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can add a custom message validator as a component in the context (e.g. as Spring bean in the application context).</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public CustomMessageValidator customMessageValidator() {
    return new CustomMessageValidator();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public CustomMessageValidator customMessageValidator() {
    return new CustomMessageValidator();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;

    &lt;bean id="customMessageValidator"
          class="org.citrusframework.validation.custom.CustomMessageValidator"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The listing above adds a custom message validator implementation. The message validator registry will automatically add this
validator to the list of available validators in the project.</p>
</div>
<div class="paragraph">
<p>The custom implementation class has to implement the basic interface <strong>org.citrusframework.validation.MessageValidator&lt;&gt;</strong>. Now
Citrus will try to match the custom implementation to incoming message types and occasionally execute the message validator
logic when applicable.</p>
</div>
</div>
<div class="sect2">
<h3 id="message-validator-modules"><a class="anchor" href="#message-validator-modules"></a><a class="link" href="#message-validator-modules">7.2. Validation modules</a></h3>
<div class="paragraph">
<p>The list of available message validators in your project is controlled by the available message validator implementations
on the project classpath.</p>
</div>
<div class="paragraph">
<p>You need to add validator modules to the project accordingly. For instance if you want to use the default Json message validation
capabilities in Citrus you need to add the following dependency:</p>
</div>
<div class="listingblock">
<div class="title">Json validation module dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-validation-json&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This adds the Citrus message validator component for dealing with Json message format. This includes message validators and
JsonPath support. Now your Citrus project is able to validate Json messages.</p>
</div>
<div class="paragraph">
<p>Citrus provides the following validation modules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#json-message-validation">citrus-validation-json</a></p>
</li>
<li>
<p><a href="#xml-message-validation">citrus-validation-xml</a></p>
</li>
<li>
<p><a href="#yaml-message-validation">citrus-validation-yaml</a></p>
</li>
<li>
<p><a href="#plaintext-message-validation">citrus-validation-text</a></p>
</li>
<li>
<p><a href="#binary-message-validation">citrus-validation-binary</a></p>
</li>
<li>
<p><a href="#groovy-xml-validation">citrus-validation-groovy</a></p>
</li>
<li>
<p><a href="#hamcrest-message-validation">citrus-validation-hamcrest</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Read more about the individual validation modules in the next sections.</p>
</div>
</div>
<div class="sect2">
<h3 id="json-message-validation"><a class="anchor" href="#json-message-validation"></a><a class="link" href="#json-message-validation">7.3. Json validation</a></h3>
<div class="paragraph">
<p>Message formats such as Json have become very popular, in particular when dealing with RESTful services.
Citrus is able to expect and validate Json messages with a powerful comparison of Json structures.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
By default, Citrus will use XML message formats when sending and receiving messages.
This also reflects to the message validation logic Citrus uses for incoming messages.
So by default Citrus will try to parse the incoming message as XML DOM element tree.
In case we would like to enable Json message validation we have to tell Citrus that we expect a Json message right now.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Json message validation is not enabled by default in your project.
You need to add the validation module to your project as a Maven dependency.</p>
</div>
<div class="listingblock">
<div class="title">Json validation module dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-validation-json&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus provides several default message validator implementations for Json messages:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
JsonTextMessageValidator
</td>
<td class="hdlist2">
<p>Basic Json message validator implementation compares Json objects/arrays (expected and received).</p>
<div class="ulist">
<ul>
<li>
<p>The order of Json object properties can differ, whereas array order is always validated.</p>
</li>
<li>
<p>Test variables and ignored-placeholders (<code>@ignore@</code>) can be used.</p>
</li>
<li>
<p>JsonArray as well as nested JsonObjects are supported.</p>
</li>
</ul>
</div>
</td>
</tr>
<tr>
<td class="hdlist1">
GroovyJsonMessageValidator
</td>
<td class="hdlist2">
<p>Extended groovy message validator provides specific Json slurper support.
With Json slurper the tester can validate the Json message body with closures for instance.</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The Json validator offers two different modes to operate.
By default, <strong>strict</strong> mode is enabled and the validator will also check the exact amount of entries (object properties / array items) to match in received and control message.
No additional fields in received Json data structure will be accepted.
In <strong>soft</strong> mode the validator allows additional entries (object properties / array items) in received Json, so the control Json can be a subset of the received.
Additional entries in the received Json data structure are ignored.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The Json validation mode (strict or soft) is settable via environment variable <code>CITRUS_JSON_MESSAGE_VALIDATION_STRICT</code> or system property <code>citrus.json.message.validation.strict=false</code>.
This will set soft mode to all Json text message validators.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also overwrite these default message validators for Json by placing a bean into the Spring Application context.
The bean uses a default name as identifier.
Then your custom bean will overwrite the default validator:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JsonTextMessageValidator defaultJsonMessageValidator() {
    return new JsonTextMessageValidator();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="defaultJsonMessageValidator" class="org.citrusframework.validation.json.JsonTextMessageValidator"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same approach applies to the Groovy message validator implementation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public GroovyJsonMessageValidator defaultGroovyJsonMessageValidator() {
    return new GroovyJsonMessageValidator();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="defaultGroovyJsonMessageValidator" class="org.citrusframework.validation.script.GroovyJsonMessageValidator"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is how you can customize the message validators used for Json message data.</p>
</div>
<div class="paragraph">
<p>When a message has been received in Citrus the message validation will try to find a matching message validator according to the message content.
You can also specify the Json message format on a receive action in order to force Json message validation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(someEndpoint)
    .message()
    .type(MessageType.JSON)
    .body("{" +
            "\"type\" : \"read\"," +
            "\"mbean\" : \"java.lang:type=Memory\"," +
            "\"attribute\" : \"HeapMemoryUsage\"," +
            "\"path\" : \"@equalsIgnoreCase('USED')@\"," +
            "\"value\" : \"${heapUsage}\"," +
            "\"timestamp\" : \"@ignore@\"" +
          "}");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
    &lt;message type="json"&gt;
        &lt;data&gt;
          {
            "type" : "read",
            "mbean" : "java.lang:type=Memory",
            "attribute" : "HeapMemoryUsage",
            "path" : "@equalsIgnoreCase('USED')@",
            "value" : "${heapUsage}",
            "timestamp" : "@ignore@"
          }
        &lt;/data&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message receiving action in our test case specifies a message format type <code>type="json"</code> . This tells Citrus to look for some message validator implementation capable of validating Json messages.
As we have added the proper message validator to the Spring application context Citrus will pick the right validator and Json message validation is performed on this message.</p>
</div>
<div class="paragraph">
<p>Instead of defining an expected message body template we can also use Groovy validation scripts.
Let&#8217;s have a look at the Groovy Json message validator example.
As usual the default Groovy Json message validator is active by default.
But the special Groovy message validator implementation will only jump in when we used a validation script in our receive message definition.
Let&#8217;s have an example for that.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(someEndpoint)
    .message()
    .type(MessageType.JSON)
    .validate(groovy()
        .script("assert json.type == 'read'\n" +
                "assert json.mbean == 'java.lang:type=Memory'\n" +
                "assert json.attribute == 'HeapMemoryUsage'\n" +
                "assert json.value == '${heapUsage}'"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
    &lt;message type="json"&gt;
        &lt;validate&gt;
            &lt;script type="groovy"&gt;
                &lt;![CDATA[
                  assert json.type == 'read'
                  assert json.mbean == 'java.lang:type=Memory'
                  assert json.attribute == 'HeapMemoryUsage'
                  assert json.value == '${heapUsage}'
                ]]&gt;
            &lt;/script&gt;
        &lt;/validate&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again the message type tells Citrus that we expect a message of type <strong>json</strong>.
The action uses a validation script written in Groovy to verify the incoming message.
Citrus will automatically activate the special message validator that executes our Groovy script.</p>
</div>
<div class="paragraph">
<p>The script validation is very powerful as we can use the full power of the Groovy language.
The validation script automatically has access to the incoming Json message object <strong>json</strong>.
We can use the Groovy Json dot notated syntax in order to navigate through the Json structure.
The Groovy Json slurper object <strong>json</strong> is automatically injected in the validation script.
This way you can access the Json object elements in your code doing some assertions.</p>
</div>
<div class="paragraph">
<p>There is even more object injection for the validation script.
With the automatically added object <strong><em>receivedMessage</em></strong> you have access to the Citrus message object for this receive action.
This enables you to do whatever you want with the message body or header.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(someEndpoint)
    .message()
    .type(MessageType.JSON)
    .validate(groovy()
        .script("assert receivedMessage.getPayload(String.class).contains(\"Hello Citrus!\")\n" +
                "assert receivedMessage.getHeader(\"Operation\") == 'sayHello'\n" +
                "context.setVariable(\"request_body\", receivedMessage.getPayload(String.class))"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
    &lt;message type="json"&gt;
        &lt;validate&gt;
            &lt;script type="groovy"&gt;
                assert receivedMessage.getPayload(String.class).contains("Hello Citrus!")
                assert receivedMessage.getHeader("Operation") == 'sayHello'

                context.setVariable("request_body", receivedMessage.getPayload(String.class))
            &lt;/script&gt;
        &lt;/validate&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The listing above shows some power of the validation script.
We can access the message body, we can access the message header.
With test context access we can also save the whole message body as a new test variable for later usage in the test.</p>
</div>
<div class="paragraph">
<p>In general Groovy code inside the XML test case definition or as part of the Java DSL code is not very comfortable to maintain.
Neither you do have code syntax assist nor code completion when using inline Groovy scripts.</p>
</div>
<div class="paragraph">
<p>Also, in case the validation script gets more complex you might want to load the script from an external file resource.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(someEndpoint)
    .message()
    .type(MessageType.JSON)
    .validate(groovy()
        .script(new ClassPathResource("path/to/validationScript.groovy")));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
    &lt;message type="json"&gt;
        &lt;validate&gt;
            &lt;script type="groovy" file="path/to/validationScript.groovy"/&gt;
        &lt;/validate&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We referenced some external file resource <strong><em>validationScript.groovy</em></strong> . This file content is loaded at runtime and is used as script body.
Now that we have a normal groovy file we can use the code completion and syntax highlighting of our favorite Groovy editor.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Using several message validator implementations at the same time in the Spring application context is also no problem.
Citrus automatically searches for all available message validators applicable for the given message format and executes these validators in sequence.
This means that multiple message validators can coexist in a Citrus project.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Multiple message validators that all apply to the message content format will run in sequence.
In case you need to explicitly choose a message validator implementation you can do so in the receive action:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(someEndpoint)
    .validator(groovyJsonMessageValidator)
    .message()
    .type(MessageType.JSON)
    .validate(groovy()
        .script(new ClassPathResource("path/to/validationScript.groovy")));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
    &lt;message type="json" validator="groovyJsonMessageValidator"&gt;
        &lt;validate&gt;
            &lt;script type="groovy" file="path/to/validationScript.groovy"/&gt;
        &lt;/validate&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example we use the <strong>groovyJsonMessageValidator</strong> explicitly in the receive test action.
The message validator implementation was added as Spring bean with id <strong>groovyJsonMessageValidator</strong> to the Spring application context before.
Now Citrus will only execute the explicit message validator.
Other implementations that might also apply are skipped.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
By default, Citrus consolidates all available message validators.
You can explicitly pick a special message validator in the receive message action as shown in the example above.
In this case all other validators will not take part in this special message validation.
But be careful: When picking a message validator explicitly you are of course limited to this message validator capabilities.
Validation features of other validators are not valid in this case (e.g. message header validation, XPath validation, etc.)
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="json-ignore-validation"><a class="anchor" href="#json-ignore-validation"></a><a class="link" href="#json-ignore-validation">7.3.1. Ignore with JsonPath</a></h4>
<div class="paragraph">
<p>The next usage scenario for JsonPath expressions in Citrus is the ignoring of elements during message validation.
As you already know Citrus provides powerful validation mechanisms for XML and Json message format.
The framework is able to compare received and expected message contents with powerful validator implementations.
You can use a JsonPath expression for ignoring a very specific entry in the Json object structure.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(someEndpoint)
    .message()
    .type(MessageType.JSON)
    .body("{\"users\":" +
            "[{" +
                "\"name\": \"Jane\"," +
                "\"token\": \"?\"," +
                "\"lastLogin\": 0" +
            "}," +
            "{" +
                "\"name\": \"Penny\"," +
                "\"token\": \"?\"," +
                "\"lastLogin\": 0" +
            "}," +
            "{" +
                "\"name\": \"Mary\"," +
                "\"token\": \"?\"," +
                "\"lastLogin\": 0" +
            "}]" +
        "}")
        .validate(validate().json()
                .ignore("$.users[*].token")
                .ignore("$..lastLogin"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
    &lt;message type="json"&gt;
      &lt;data&gt;
        {
          "users":
          [{
            "name": "Jane",
            "token": "?",
            "lastLogin": 0
          },
          {
            "name": "Penny",
            "token": "?",
            "lastLogin": 0
          },
          {
            "name": "Mary",
            "token": "?",
            "lastLogin": 0
          }]
        }
      &lt;/data&gt;
      &lt;ignore expression="$.users[*].token" /&gt;
      &lt;ignore expression="$..lastLogin" /&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time we add JsonPath expressions as ignore statements.
This means that we explicitly leave out the evaluated elements from validation.
Obviously this mechanism is a good thing to do when dynamic message data simply is not deterministic such as timestamps and dynamic identifiers.
In the example above we explicitly skip the <strong>token</strong> entry and all <strong>lastLogin</strong> values that are obviously timestamp values in milliseconds.</p>
</div>
<div class="paragraph">
<p>The JsonPath evaluation is very powerful when it comes to select a set of Json objects and elements.
This is how we can ignore several elements with one single JsonPath expression which is very powerful.</p>
</div>
</div>
<div class="sect3">
<h4 id="json-path-validation"><a class="anchor" href="#json-path-validation"></a><a class="link" href="#json-path-validation">7.3.2. JsonPath validation</a></h4>
<div class="paragraph">
<p>Let&#8217;s continue to use JsonPath expressions when validating a received message in Citrus:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(someEndpoint)
    .message()
    .type(MessageType.JSON)
    .validate(validate().jsonPath()
        .expression("$.user.name", "Penny")
        .expression("$['user']['name']", "${userName}")
        .expression("$.user.aliases", "[\"penny\",\"jenny\",\"nanny\"]")
        .expression("$.user[?(@.admin)].password", "@startsWith('$%00')@")
        .expression("$.user.address[?(@.type='office')]", "{\"city\":\"Munich\",\"street\":\"Company Street\",\"type\":\"office\"}"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
  &lt;message type="json"&gt;
    &lt;validate&gt;
      &lt;json-path expression="$.user.name" value="Penny"/&gt;
      &lt;json-path expression="$['user']['name']" value="${userName}"/&gt;
      &lt;json-path expression="$.user.aliases" value="['penny','jenny','nanny']"/&gt;
      &lt;json-path expression="$.user[?(@.admin)].password" value="@startsWith('$%00')@"/&gt;
      &lt;json-path expression="$.user.address[?(@.type='office')]"
          value="{&amp;quot;city&amp;quot;:&amp;quot;Munich&amp;quot;,&amp;quot;street&amp;quot;:&amp;quot;Company Street&amp;quot;,&amp;quot;type&amp;quot;:&amp;quot;office&amp;quot;}"/&gt;
    &lt;/validate&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Use path expression map</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">final Map&lt;String, Object&gt; validationMap = new HashMap&lt;&gt;();
validationMap.put("$.user.name", "Penny");
validationMap.put("$['user']['name']", "${userName}");
validationMap.put("$.user.aliases", "[\"penny\",\"jenny\",\"nanny\"]");
validationMap.put("$.user[?(@.admin)].password", "@startsWith('$%00')@");
validationMap.put("$.user.address[?(@.type='office')]", "{\"city\":\"Munich\",\"street\":\"Company Street\",\"type\":\"office\"}");

receive(someEndpoint)
    .message()
    .type(MessageType.JSON)
    .validate(validate().jsonPath().expressions(validationMap));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above JsonPath expressions will be evaluated when Citrus validates the received message.
The expression result is compared to the expected value where expectations can be static values as well as test variables and validation matcher expressions.
In case a JsonPath expression should not be able to find any elements the test case will also fail.</p>
</div>
<div class="paragraph">
<p>Json is a pretty simple yet powerful message format.
Simply put, a Json message just knows JsonObject, JsonArray and JsonValue items.
The handling of JsonObject and JsonValue items in JsonPath expressions is straight forward.
We just use a dot notated syntax for walking through the JsonObject hierarchy.
The handling of JsonArray items is also not very difficult either.
Citrus will try the best to convert JsonArray items to String representation values for comparison.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
JsonPath expressions will only work on Json message formats.
This is why we have to tell Citrus the correct message format.
By default, Citrus is working with XML message data and therefore the XML validation mechanisms do apply by default.
With the message type attribute set to <strong>json</strong> we make sure that Citrus enables Json specific features on the message validation such as JsonPath support.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s get a bit more complex with validation matchers and Json object functions.
Citrus tries to give you the most comfortable validation capabilities when comparing Json object values and Json arrays.
One first thing you can use is object functions like <strong>keySet()</strong> or <strong>size()</strong> . This functionality is not covered by JsonPath out of the box but added by Citrus.
See the following example on how to use it:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(someEndpoint)
    .message()
    .type(MessageType.JSON)
    .validate(validate().jsonPath()
        .expression("$.user.keySet()", "[id,name,admin,projects]")
        .expression("$.user.aliases.size()", "3"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
  &lt;message type="json"&gt;
    &lt;validate&gt;
      &lt;json-path expression="$.user.keySet()" value="[id,name,admin,projects]"/&gt;
      &lt;json-path expression="$.user.aliases.size()" value="3"/&gt;
    &lt;/validate&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The object functions do return special Json object related properties such as the set of <strong>keys</strong> for an object or the size of a Json array.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s get even more comfortable validation capabilities with matchers.
Citrus supports Hamcrest matchers which gives us a very powerful way of validating Json object elements and arrays.
See the following examples that demonstrate how this works:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(someEndpoint)
    .message()
    .type(MessageType.JSON)
    .validate(validate().jsonPath()
                .expression("$.user.keySet()", contains("id","name","admin","projects"))
                .expression("$.user.aliases.size()", allOf(greaterThan(0), lessThan(5))));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
  &lt;message type="json"&gt;
    &lt;validate&gt;
      &lt;json-path expression="$.user.keySet()" value="@assertThat(contains(id,name,admin,projects))@"/&gt;
      &lt;json-path expression="$.user.aliases.size()" value="@assertThat(allOf(greaterThan(0), lessThan(5)))@"/&gt;
    &lt;/validate&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using the XML DSL we have to use the <strong>assertThat</strong> validation matcher syntax for defining the Hamcrest matchers.
You can combine matcher implementation as seen in the <strong>allOf(greaterThan(0), lessThan(5))</strong> expression.
When using the Java DSL you can just add the matcher as expected result object.
Citrus evaluates the matchers and makes sure everything is as expected.
This is a very powerful validation mechanism as it combines the Hamcrest matcher capabilities with Json message validation.</p>
</div>
</div>
<div class="sect3">
<h4 id="json-schema-validation"><a class="anchor" href="#json-schema-validation"></a><a class="link" href="#json-schema-validation">7.3.3. Json schema validation</a></h4>
<div class="paragraph">
<p>The Json schema validation in Citrus is based on the drafts provided by <a href="http://json-schema.org/">json-schema.org</a>.
Because Json schema is a fast evolving project, only Json schema V3 and V4 are currently supported.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
In contrast to the XML validation, the Json validation is an optional feature.
You have to activate it within every receive-message action by setting <code>schema-validation="true"</code>
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(someEndpoint)
    .message()
    .type(MessageType.JSON)
    .body()
    .validate(validate().json()
        .schemaValidation(true)
        .schema("bookStore"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="echoHttpServer"&gt;
  &lt;message type="json" schema="bookStore" schema-validation="true"&gt;
    &lt;data&gt;
      {
        "isbn" : "0345391802",
        "title": "The Hitchhiker's Guide to the Galaxy",
        "author": "Douglas Adams"
      }
    &lt;/data&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Json schema validation in Citrus is optional and disabled by default.
This is why the action required to explicitly enable the schema validation with <code>schemaValidation(true)</code>.
The schema references a bean in the Citrus context (e.g. a Spring bean in the application context).
Read more about how to declare schemas in <a href="#schema-definition">schema validation</a>.</p>
</div>
<div class="paragraph">
<p>We encourage you to add Json schema validation to your test cases as soon as possible, because we think that message validation is an important part of integration testing.</p>
</div>
</div>
<div class="sect3">
<h4 id="json-schema-repositories"><a class="anchor" href="#json-schema-repositories"></a><a class="link" href="#json-schema-repositories">7.3.4. Json schema repositories</a></h4>
<div class="paragraph">
<p>Because Citrus supports different types of schema repositories, it is necessary to declare a Json schema repository as <code>type="json"</code>.
This allows Citrus to collect all Json schema files for the message validation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JsonSchemaRepository schemaRepository() {
    JsonSchemaRepository repository = new JsonSchemaRepository();
    repository.getSchemas().add(productSchema());
    return repository;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:schema-repository type="json" id="jsonSchemaRepository"&gt;
    &lt;citrus:schemas&gt;
        &lt;citrus:schema ref="productSchema" location="classpath:org/citrusframework/validation/ProductsSchema.json"/&gt;
    &lt;/citrus:schemas&gt;
&lt;/citrus:schema-repository&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The referenced schema is another bean in the configuration that represents the schema definition.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SimpleJsonSchema productSchema() {
    return new SimpleJsonSchema(
            new ClassPathResource("classpath:org/citrusframework/validation/ProductsSchema.json"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:schema id="productSchema" location="classpath:org/citrusframework/validation/ProductsSchema.json"/&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="json-schema-filtering-and-validation-strategy"><a class="anchor" href="#json-schema-filtering-and-validation-strategy"></a><a class="link" href="#json-schema-filtering-and-validation-strategy">7.3.5. Json schema filtering and validation strategy</a></h4>
<div class="paragraph">
<p>In reference to the current Json schema definition, it is not possible to create a direct reference between a Json message and a set of schemas, as it would be possible with XML namespaces.
Because of that, Citrus follows a rule set for choosing the relevant schemas based on the configuration within the test case in relation to the given context.
The following table assumes that the Json schema validation is activated for the test action.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Scenario</th>
<th class="tableblock halign-left valign-top">Validation rules</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">No Json schema repositories are defined in the context.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No Json schema validation applies.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">There is at least one Json schema repository defined in the context.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The message of the test action must be valid regarding at least one of the available schemas within the context.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A schema overruling is configured in the test case.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The configured schema must exist and the message must be valid regarding the specified schema.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A schema repository overruling is configured in the test case.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The configured schema repository must exist and the message must be valid regarding at least one of the schemas within
the specified schema repository.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="xml-message-validation"><a class="anchor" href="#xml-message-validation"></a><a class="link" href="#xml-message-validation">7.4. XML validation</a></h3>
<div class="paragraph">
<p>XML is a very common message format especially in the SOAP WebServices and JMS messaging world. Citrus provides XML message
validator implementations that are able to compare XML message structures. The validator will notice differences in the XML
message and supports XML namespaces, attributes and XML schema validation.</p>
</div>
<div class="paragraph">
<p>XML message validation is not enabled by default in your project. You need to add the validation module to your project
as a Maven dependency.</p>
</div>
<div class="listingblock">
<div class="title">XML validation module dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-validation-xml&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default XML message validator implementation is active by default and can be overwritten with a custom implementation
using the bean id <strong>defaultXmlMessageValidator</strong> .</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public DomXmlMessageValidator defaultXmlMessageValidator() {
    return new DomXmlMessageValidator();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="defaultXmlMessageValidator" class="org.citrusframework.validation.xml.DomXmlMessageValidator"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default XML message validator is very powerful when it comes to compare XML structures. The validator supports namespaces
with different prefixes and attributes as well as namespace qualified attributes. See the following sections for a detailed
description of all capabilities.</p>
</div>
<div class="sect3">
<h4 id="xml-payload-validation"><a class="anchor" href="#xml-payload-validation"></a><a class="link" href="#xml-payload-validation">7.4.1. XML payload validation</a></h4>
<div class="paragraph">
<p>Citrus is able to verify XML message content on a received message. You as a tester can compare the whole XML message body
to a predefined control message template. The Citrus message validator will walk through the XML document and compare the
elements, attributes and values.</p>
</div>
<div class="paragraph">
<p>You can define the expected XML message template in multiple ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Defines the message body as nested XML message template in the test code. The whole message body is defined inside the test case.</p>
</li>
<li>
<p>Defines an expected XML message template via external file resources. This time the body content is loaded at runtime from the external file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In Java tests that use the Citrus domain specific language you must use verbose String concatenation when constructing XML
message contents inline. You need to escape reserved characters like quotes and line breaks. This is why you should consider
to using external file resources in Java when dealing with large complex message data.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void externalBodyResourceTest() {
    receive("someEndpoint")
        .message()
        .body(new ClassPathResource("org/citrusframework/message/data/TestRequest.xml"))
        .header("Operation", "sayHello")
        .header("MessageId", "${messageId}");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
  &lt;message&gt;
    &lt;payload file="classpath:org/citrusframework/message/data/TestRequest.xml"/&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Inline message body definition or external file resource give us a control message template that the test case expects to
validate. Citrus uses this control template for extended message comparison. All elements, namespaces, attributes and node
values are validated in this comparison. When using XML message bodies Citrus will navigate through the whole XML structure
validating each element and its content.</p>
</div>
<div class="paragraph">
<p>Only in case received message and control message are equal to each other as expected the message validation will pass. In
case differences occur the test case fails with detailed error message.</p>
</div>
<div class="paragraph">
<p>Citrus supports various ways to add dynamic message content in the message template. Secondly, Citrus can ignore some elements
that should not be part of message comparison (e.g. when generated content or timestamps are part of the message content).
The tester can enrich the expected message template with test variables or ignore-expressions so we get a more robust
validation mechanism. We will talk about this in the next sections to come.</p>
</div>
</div>
<div class="sect3">
<h4 id="xml-header-validation"><a class="anchor" href="#xml-header-validation"></a><a class="link" href="#xml-header-validation">7.4.2. XML header validation</a></h4>
<div class="paragraph">
<p>A message can have multiple headers in addition to the body content. You can validate headers with expected name and the
control value. Just add the following header validation to your receiving action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .message()
    .header("Operation", "sayHello")
    .header("MessageId", "${messageId}");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
  &lt;message&gt;
    &lt;header&gt;
        &lt;element name="Operation" value="GetCustomer"/&gt;
        &lt;element name="RequestTag" value="${requestTag}"/&gt;
    &lt;/header&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Message headers are represented as name-value pairs. Each expected header element identified by its name has to be present
in the received message. In addition to that the header value is compared to the given control value. If a header entry is
not available, or the value does not match the expectations the test raises validation errors.</p>
</div>
</div>
<div class="sect3">
<h4 id="xml-header-fragment-validation"><a class="anchor" href="#xml-header-fragment-validation"></a><a class="link" href="#xml-header-fragment-validation">7.4.3. XML header fragment validation</a></h4>
<div class="paragraph">
<p>Sometimes message headers may not apply to the name-value pair pattern. For example SOAP headers can also contain XML
fragments as header values. You can add complex header data as expected value in the validation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .message()
    .header("Operation", "SayHello")
    .header("&lt;ns0:HelloHeader xmlns:ns0=\"http://citrusframework.org/schemas/samples/HelloService.xsd\"&gt;" +
                "&lt;ns0:MessageId&gt;${messageId}&lt;/ns0:MessageId&gt;" +
                "&lt;ns0:CorrelationId&gt;${correlationId}&lt;/ns0:CorrelationId&gt;" +
                "&lt;ns0:User&gt;${user}&lt;/ns0:User&gt;" +
                "&lt;ns0:Text&gt;Hello from Citrus!&lt;/ns0:Text&gt;" +
            "&lt;/ns0:HelloHeader&gt;");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
  &lt;message&gt;
    &lt;header&gt;
      &lt;data&gt;
        &lt;![CDATA[
          &lt;ns0:HelloHeader xmlns:ns0="http://citrusframework.org/schemas/samples/HelloService.xsd"&gt;
              &lt;ns0:MessageId&gt;${messageId}&lt;/ns0:MessageId&gt;
              &lt;ns0:CorrelationId&gt;${correlationId}&lt;/ns0:CorrelationId&gt;
              &lt;ns0:User&gt;${user}&lt;/ns0:User&gt;
              &lt;ns0:Text&gt;Hello from Citrus!&lt;/ns0:Text&gt;
          &lt;/ns0:HelloHeader&gt;
        ]]&gt;
      &lt;/data&gt;
      &lt;element name="Operation" value="SayHello"/&gt;
    &lt;/header&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The header data has no name but uses a complex XML fragment as a value. In SOAP this header fragment will be added as
a <code>SOAP-ENV:Header</code> then. Please read more about this in <a href="#soap-headers">SOAP support</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="xml-ignore-validation"><a class="anchor" href="#xml-ignore-validation"></a><a class="link" href="#xml-ignore-validation">7.4.4. Ignore XML elements</a></h4>
<div class="paragraph">
<p>Some elements in the message payload might not apply for validation at all. Just think of communication timestamps or dynamic
values that have been generated from a foreign service.</p>
</div>
<div class="paragraph">
<p>You as a tester may not be able to predict such a timestamp or dynamic value for expected validation. This is why you can
safely ignore elements and attributes in the XML message validation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .message()
    .header("&lt;TestMessage&gt;" +
                "&lt;VersionId&gt;${versionId}&lt;/VersionId&gt;" +
                "&lt;Timestamp&gt;?&lt;/Timestamp&gt;" +
                "&lt;MessageId&gt;?&lt;/MessageId&gt;" +
            "&lt;/TestMessage&gt;")
    .validate(validate().xpath()
            .ignore("/TestMessage/Timestamp")
            .ignore("/TestMessage/MessageId"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
  &lt;message&gt;
    &lt;payload&gt;
      &lt;TestMessage&gt;
        &lt;VersionId&gt;${versionId}&lt;/VersionId&gt;
        &lt;Timestamp&gt;?&lt;/Timestamp&gt;
        &lt;MessageId&gt;?&lt;/MessageId&gt;
      &lt;/TestMessage&gt;
    &lt;/payload&gt;
    &lt;ignore path="/TestMessage/Timestamp"/&gt;
    &lt;ignore path="/TestMessage/MessageId"/&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The receive action above is not able to verify the elements <code>Timestamp</code> and <code>MessageId</code>. This is because the timestamp uses
milliseconds and the message id has been generated by the server application. Both values must be excluded from XML validation.</p>
</div>
<div class="paragraph">
<p>You can use ignore XPath expressions that match elements in the message content that should be excluded. XPath expressions can
be cumbersome and error prone though.</p>
</div>
<div class="paragraph">
<p>You can also use inline <strong>@ignore@</strong> expressions as expected template values in order to exclude elements from valdidation. This
is for those of you that do not like to write XPath expressions. As a result the ignored message elements are automatically
skipped when Citrus compares and validates message contents and do not break the test case.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .message()
    .header("&lt;TestMessage&gt;" +
                "&lt;VersionId&gt;${versionId}&lt;/VersionId&gt;" +
                "&lt;Timestamp&gt;@ignore@&lt;/Timestamp&gt;" +
                "&lt;MessageId&gt;@ignore@&lt;/MessageId&gt;" +
            "&lt;/TestMessage&gt;");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
  &lt;message&gt;
    &lt;payload&gt;
      &lt;TestMessage&gt;
        &lt;VersionId&gt;${versionId}&lt;/VersionId&gt;
        &lt;Timestamp&gt;@ignore@&lt;/Timestamp&gt;
        &lt;MessageId&gt;@ignore@&lt;/MessageId&gt;
      &lt;/TestMessage&gt;
    &lt;/payload&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Feel free to mix both mechanisms to ignore message elements. Ignore expressions are valid as elements, sub-tree nodes and
attributes. You can use the <strong>@ignore@</strong> placeholder in external file resources, too.</p>
</div>
</div>
<div class="sect3">
<h4 id="xml-xpath-validation"><a class="anchor" href="#xml-xpath-validation"></a><a class="link" href="#xml-xpath-validation">7.4.5. XPath validation</a></h4>
<div class="paragraph">
<p>The section <a href="#xml-payload-validation">XML payload validation</a> showed how to validate the complete XML message structure
with control message template. All elements are validated and compared one after another.</p>
</div>
<div class="paragraph">
<p>In some cases this approach might be too extensive. Imagine the tester only needs to validate a small subset of message elements.
You would rather want to use explicit element validation with XPath.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .message()
    .validate(validate().xpath()
        .expression("/TestRequest/MessageId", "${messageId}")
        .expression("//VersionId", "2"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
  &lt;message&gt;
    &lt;validate&gt;
      &lt;xpath expression="/TestRequest/MessageId" value="${messageId}"/&gt;
      &lt;xpath expression="/TestRequest/VersionId" value="2"/&gt;
    &lt;/validate&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In Java the use of a map may be the easiest way to declare multiple expressions for XPath validation.</p>
</div>
<div class="listingblock">
<div class="title">Java DSL</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">final Map&lt;String, Object&gt; expressions = new HashMap&lt;&gt;();
expressions.put("/TestRequest/MessageId", "${messageId}");
expressions.put("//VersionId", "2");

receive("someEndpoint")
    .message()
    .validate(validate().xpath()
        .expressions(expressions));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of comparing the whole message some message elements are validated explicitly via XPath. Citrus evaluates the XPath
expression on the received message and compares the result value to the control value. The basic message structure as well
as all other message elements are not included into this explicit validation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If this type of element validation is chosen neither &lt;payload&gt; nor &lt;data&gt; nor &lt;resource&gt; template definitions are
allowed in Citrus XML test cases.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Citrus offers an alternative dot-notated syntax in order to walk through XML trees. In case you are not familiar with
XPath or simply need a very easy way to find your element inside the XML tree you might use this way. Every element hierarchy
in the XML tree is represented with a simple dot - for example:
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>TestRequest.VersionId</code></p>
</div>
<div class="paragraph">
<p>The expression will search the XML tree for the respective <code>&lt;TestRequest&gt;&lt;VersionId&gt;</code> element. Attributes are supported too.
In case the last element in the dot-notated expression is an XML attribute the framework will automatically find it.</p>
</div>
<div class="paragraph">
<p>Of course this dot-notated syntax is very simple and might not be applicable for more complex tree navigation. XPath is
much more powerful - no doubt. The dot-notated syntax might help those of you that are not familiar with XPath.
So the dot-notation is supported wherever XPath expressions might apply.</p>
</div>
<div class="paragraph">
<p>The Xpath expressions can evaluate to different result types. By default, Citrus is operating on <strong>NODE</strong> and <strong>STRING</strong> result
types so that you can validate some element value. But you can also use different result types such as <strong>NODESET</strong> and <strong>BOOLEAN</strong> .</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .validate(validate().xpath()
        .expression("boolean:/TestRequest/Error", false)
        .expression("number:/TestRequest/Status[.='success']", 3)
        .expression("node-set:/TestRequest/OrderType", "[single, multi, multi]");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
  &lt;message&gt;
    &lt;validate&gt;
      &lt;xpath expression="/TestRequest/Error" value="false" result-type="boolean"/&gt;
      &lt;xpath expression="/TestRequest/Status[.='success']" value="3" result-type="number"/&gt;
      &lt;xpath expression="/TestRequest/OrderType" value="[single, multi, multi]" result-type="node-set"/&gt;
    &lt;/validate&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above we use different expression result types. First we want to make sure no <strong>/TestRequest/Error</strong> element
is present. This can be done with a boolean result type and <strong>false</strong> value. Second we want to validate the number of found
elements for the expression <strong>/TestRequest/Status[.='success']</strong> . The XPath expression evaluates to a node list that results
in its list size to be checked. And last but not least we evaluate to a <strong>node-set</strong> result type where all values in the node list
will be translated to a comma delimited string value.</p>
</div>
<div class="paragraph">
<p>You can use even more powerful validation expressions with matcher implementations. With validation matchers you are able to
use validations such as <strong>greaterThan</strong>, <strong>lessThan</strong>, <strong>hasSize</strong> and much more.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .validate(validate().xpath()
        .expression("/TestRequest/Error", anyOf(empty(), nullValue()))
        .expression("number:/TestRequest/Status[.='success']", greaterThan(0.0))
        .expression("integer:/TestRequest/Status[.='failed']", lowerThan(1))
        .expression("node-set:/TestRequest/OrderType", hasSize(3));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
  &lt;message&gt;
    &lt;validate&gt;
      &lt;xpath expression="/TestRequest/Error" value="@assertThat(anyOf(empty(), nullValue()))@"/&gt;
      &lt;xpath expression="/TestRequest/Status[.='success']" value="@assertThat(greaterThan(0.0))@" result-type="number"/&gt;
      &lt;xpath expression="/TestRequest/Status[.='failed']" value="@assertThat(lowerThan(1))@" result-type="integer"/&gt;
      &lt;xpath expression="/TestRequest/OrderType" value="@assertThat(hasSize(3))@" result-type="node-set"/&gt;
    &lt;/validate&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The validation matchers used in the example above use the <a href="#hamcrest-message-validation">citrus-hamcrest-validation</a>
module.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
XPath uses decimal number type <strong>Double</strong> by default when evaluating expressions with <strong>number</strong> result type. This means
we have to use Double typed expected values, too. Citrus also provides the result type <strong>integer</strong> that automatically converts
the XPath expression result to an <strong>Integer</strong> type.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When using the XML DSL we have to use the <strong>assertThat</strong> validation matcher syntax for defining the Hamcrest matcher. You can
combine matcher implementation as seen in the <strong>anyOf(empty(), nullValue())</strong> expression. When using the Java DSL you can just
add the matcher as expected result object. Citrus evaluates the matchers and makes sure everything is as expected. This is a
very powerful validation mechanism as it also works with node-sets containing multiple values as list.</p>
</div>
<div class="paragraph">
<p>This is how you can add very powerful message element validation in XML using XPath expressions.</p>
</div>
</div>
<div class="sect3">
<h4 id="xml-validation-namespaces"><a class="anchor" href="#xml-validation-namespaces"></a><a class="link" href="#xml-validation-namespaces">7.4.6. XML namespaces</a></h4>
<div class="paragraph">
<p>Namespaces represent an essential concept in XML. A namespace declares an element to be part of a very specific ruleset. You
have to specify namespaces also when using XPath expressions. Let&#8217;s have a look at an example message that uses XML namespaces:</p>
</div>
<div class="listingblock">
<div class="title">Sample XML body with namepaces</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;ns1:TestMessage xmlns:ns1="http://citrus.com/namespace"&gt;
    &lt;ns1:TestHeader&gt;
        &lt;ns1:CorrelationId&gt;_&lt;/ns1:CorrelationId&gt;
        &lt;ns1:Timestamp&gt;2001-12-17T09:30:47.0Z&lt;/ns1:Timestamp&gt;
        &lt;ns1:VersionId&gt;2&lt;/ns1:VersionId&gt;
    &lt;/ns1:TestHeader&gt;
    &lt;ns1:TestBody&gt;
        &lt;ns1:Customer&gt;
            &lt;ns1:Id&gt;1&lt;/ns1:Id&gt;
        &lt;/ns1:Customer&gt;
    &lt;/ns1:TestBody&gt;
&lt;/ns1:TestMessage&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we would like to validate some elements in this message using XPath</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .validate(validate().xpath()
        .expression("//TestMessage/TestHeader/VersionId", 2L)
        .expression("//TestMessage/TestHeader/CorrelationId", "${correlationId}");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
  &lt;message&gt;
    &lt;validate&gt;
      &lt;xpath expression="//TestMessage/TestHeader/VersionId" value="2"/&gt;
      &lt;xpath expression="//TestMessage/TestHeader/CorrelationId" value="${correlationId}"/&gt;
    &lt;/validate&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The validation will fail although the XPath expression looks correct regarding the XML tree. This is because the message uses the
namespace <code>xmlns:ns1="http://citrus.com/namespace"</code>. The XPath expression is not able to find the elements because of the missing
namespace declaration in the expression. The correct XPath expression uses the namespace prefix as defined in the message.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .validate(validate().xpath()
        .expression("//ns1:TestMessage/ns1:TestHeader/ns1:VersionId", 2L)
        .expression("//ns1:TestMessage/ns1:TestHeader/ns1:CorrelationId", "${correlationId}");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
  &lt;message&gt;
    &lt;validate&gt;
      &lt;xpath expression="//ns1:TestMessage/ns1:TestHeader/ns1:VersionId" value="2"/&gt;
      &lt;xpath expression="//ns1:TestMessage/ns1:TestHeader/ns1:CorrelationId" value="${correlationId}"/&gt;
    &lt;/validate&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the expressions works fine, and the validation is successful. Relying on the namespace prefix <code>ns1</code> is quite error-prone though.
This is because the test depends on the very specific namespace prefix. As soon as the message is sent with a different
namespace prefix (e.g. ns2) the validation will fail again.</p>
</div>
<div class="paragraph">
<p>You can avoid this effect when specifying your own namespace context and your own namespace prefix during validation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .validate(validate().xpath()
        .expression("//pfx:TestMessage/pfx:TestHeader/pfx:VersionId", 2L)
        .expression("//pfx:TestMessage/pfx:TestHeader/pfx:CorrelationId", "${correlationId}")
        .namespaceContext("pfx", "http://citrus.com/namespace"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
  &lt;message&gt;
    &lt;validate&gt;
      &lt;xpath expression="//pfx:TestMessage/pfx:TestHeader/pfx:VersionId" value="2"/&gt;
      &lt;xpath expression="//pfx:TestMessage/pfx:TestHeader/pfx:CorrelationId" value="${correlationId}"/&gt;
      &lt;namespace prefix="pfx" value="http://citrus.com/namespace"/&gt;
    &lt;/validate&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the test is independent of any namespace prefix in the received message. The namespace context will resolve the namespaces
and find the elements although the message might use different prefixes. The only thing that matters is that the namespace
value (<a href="http://citrus.com/namespace">http://citrus.com/namespace</a>) matches.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Instead of this namespace context on validation level you can also have a global namespace context which is valid in
all test cases. We just add a bean in the basic Spring application context configuration which defines global namespace mappings.
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public NamespaceContextBuilder namespaceContext() {
    NamespaceContextBuilder builder = new NamespaceContextBuilder();
    builder.getNamepspaceMappings().put("pfx", "http://citrusframework.org/samples/sayHello");
    return builder;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;namespace-context&gt;
    &lt;namespace prefix="def" uri="http://citrusframework.org/samples/sayHello"/&gt;
&lt;/namespace-context&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once defined the <strong>def</strong> namespace prefix is valid in all test cases and all XPath expressions. This enables you to free your
test cases from namespace prefix bindings that might be broken with time. You can use these global namespace mappings wherever
XPath expressions are valid inside a test case (validation, ignore, extract).</p>
</div>
<div class="paragraph">
<p>In the previous section we have seen that XML namespaces can get tricky with XPath validation. Default namespaces can do
even more! So let&#8217;s look at the example with default namespaces:</p>
</div>
<div class="listingblock">
<div class="title">Sample XML body with default namespaces</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;TestMessage xmlns="http://citrus.com/namespace"&gt;
    &lt;TestHeader&gt;
        &lt;CorrelationId&gt;_&lt;/CorrelationId&gt;
        &lt;Timestamp&gt;2001-12-17T09:30:47.0Z&lt;/Timestamp&gt;
        &lt;VersionId&gt;2&lt;/VersionId&gt;
    &lt;/TestHeader&gt;
    &lt;TestBody&gt;
        &lt;Customer&gt;
            &lt;Id&gt;1&lt;/Id&gt;
        &lt;/Customer&gt;
    &lt;/TestBody&gt;
&lt;/TestMessage&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message uses default namespaces. The following approach in XPath will fail due to namespace problems.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .validate(validate().xpath()
        .expression("//TestMessage/TestHeader/VersionId", 2L)
        .expression("//TestMessage/TestHeader/CorrelationId", "${correlationId}"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
  &lt;message&gt;
    &lt;validate&gt;
      &lt;xpath expression="//TestMessage/TestHeader/VersionId" value="2"/&gt;
      &lt;xpath expression="//TestMessage/TestHeader/CorrelationId" value="${correlationId}"/&gt;
    &lt;/validate&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Even default namespaces need to be specified in the XPath expressions. Look at the following code listing that works fine
with default namespaces:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .validate(validate().xpath()
        .expression("//:TestMessage/:TestHeader/:VersionId", 2L)
        .expression("//:TestMessage/:TestHeader/:CorrelationId", "${correlationId}"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
  &lt;message&gt;
    &lt;validate&gt;
      &lt;xpath expression="//:TestMessage/:TestHeader/:VersionId" value="2"/&gt;
      &lt;xpath expression="//:TestMessage/:TestHeader/:CorrelationId" value="${correlationId}"/&gt;
    &lt;/validate&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is recommended to use the namespace context as described in the previous chapter when validating. Only this approach
ensures flexibility and stable test cases regarding namespace changes.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="customize-xml-parser-and-serializer"><a class="anchor" href="#customize-xml-parser-and-serializer"></a><a class="link" href="#customize-xml-parser-and-serializer">7.4.7. Customize XML parser and serializer</a></h4>
<div class="paragraph">
<p>When working with XML data format parsing and serializing is a common task. XML structures are parsed to a DOM (Document
Object Model) representation in order to process elements, attributes and text nodes. DOM node objects get serialized to a
String message payload representation. The XML parser and serializer is customizable to a certain level. By default, Citrus
uses the <a href="https://www.w3.org/TR/2004/REC-DOM-Level-3-LS-20040407/">DOM Level 3 Load and Save</a> implementation with following settings:</p>
</div>
<div class="hdlist">
<div class="title">Parser settings</div>
<table>
<tr>
<td class="hdlist1">
cdata-sections
</td>
<td class="hdlist2">
<p><strong>true</strong></p>
</td>
</tr>
<tr>
<td class="hdlist1">
split-cdata-sections
</td>
<td class="hdlist2">
<p><strong>false</strong></p>
</td>
</tr>
<tr>
<td class="hdlist1">
validate-if-schema
</td>
<td class="hdlist2">
<p><strong>true</strong></p>
</td>
</tr>
<tr>
<td class="hdlist1">
element-content-whitespace
</td>
<td class="hdlist2">
<p><strong>false</strong></p>
</td>
</tr>
</table>
</div>
<div class="hdlist">
<div class="title">Serializer settings</div>
<table>
<tr>
<td class="hdlist1">
format-pretty-print
</td>
<td class="hdlist2">
<p><strong>true</strong></p>
</td>
</tr>
<tr>
<td class="hdlist1">
split-cdata-sections
</td>
<td class="hdlist2">
<p><strong>false</strong></p>
</td>
</tr>
<tr>
<td class="hdlist1">
element-content-whitespace
</td>
<td class="hdlist2">
<p><strong>true</strong></p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The parameters are also described in <a href="https://www.w3.org/TR/DOM-Level-3-Core/core.html#DOMConfiguration">W3C DOM configuration</a> documentation. We can customize the default settings by adding
an <em>XmlConfigurer</em> Spring bean to the Citrus application context.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public XmlConfigurer xmlConfigurer() {
    XmlConfigurer configurer = new XmlConfigurer();
    configurer.getParseSettings().put("validate-if-schema", false);

    configurer.getSerializeSettings().put("comments", false);
    configurer.getSerializeSettings().put("format-pretty-print", false);
    return configurer;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="xmlConfigurer" class="org.citrusframework.xml.XmlConfigurer"&gt;
    &lt;property name="parseSettings"&gt;
        &lt;map&gt;
            &lt;entry key="validate-if-schema" value="false" value-type="java.lang.Boolean"/&gt;
        &lt;/map&gt;
    &lt;/property&gt;
    &lt;property name="serializeSettings"&gt;
        &lt;map&gt;
            &lt;entry key="comments" value="false" value-type="java.lang.Boolean"/&gt;
            &lt;entry key="format-pretty-print" value="false" value-type="java.lang.Boolean"/&gt;
        &lt;/map&gt;
    &lt;/property&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This configuration is of global nature. All XML processing operations will be affected with this configuration.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="groovy-xml-validation"><a class="anchor" href="#groovy-xml-validation"></a><a class="link" href="#groovy-xml-validation">7.4.8. Groovy XML validation</a></h4>
<div class="paragraph">
<p>With the Groovy XmlSlurper you can easily validate XML message payloads without having to deal directly with XML. People
who do not want to deal with XPath may also like this validation alternative.</p>
</div>
<div class="paragraph">
<p>The tester directly navigates through the message elements and uses simple code assertions in order to control the message content.
Here is an example how to validate messages with Groovy script:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .validate(groovy().script("assert root.children().size() == 4\n" +
                              "assert root.MessageId.text() == '${messageId}'\n" +
                              "assert root.CorrelationId.text() == '${correlationId}'\n")
                              "assert root.Text.text() == 'Hello ' + context.getVariable(\"user\")"))
    .header("Operation", "sayHello")
    .header("CorrelationId", "${correlationId}")
    .timeout(5000L);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint" timeout="5000"&gt;
    &lt;message&gt;
        &lt;validate&gt;
            &lt;script type="groovy"&gt;
                assert root.children().size() == 4
                assert root.MessageId.text() == '${messageId}'
                assert root.CorrelationId.text() == '${correlationId}'
                assert root.Text.text() == 'Hello ' + context.getVariable("user")
            &lt;/script&gt;
        &lt;/validate&gt;
    &lt;/message&gt;
    &lt;header&gt;
        &lt;element name="Operation" value="sayHello"/&gt;
        &lt;element name="CorrelationId" value="${correlationId}"/&gt;
    &lt;/header&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Groovy XmlSlurper validation script goes right into the message-tag instead of an XML control template or XPath validation.
The Groovy script supports Java <strong><em>assert</em></strong> statements for message element validation. Citrus automatically injects the root
element <strong><em>root</em></strong> to the validation script. This is the Groovy XmlSlurper object and the start of element navigation. Based on
this root element you can access child elements and attributes with a dot notated syntax. Just use the element names separated
by a simple dot. Very easy! If you need the list of child elements use the <strong><em>children()</em></strong> function on any element. With the
<strong><em>text()</em></strong> function you get access to the element&#8217;s text-value. The <strong><em>size()</em></strong> is very useful for validating the number of
child elements which completes the basic validation statements.</p>
</div>
<div class="paragraph">
<p>As you can see from the example, we may use test variables within the validation script, too. Citrus has also injected the
actual test context to the validation script. The test context object holds all test variables. So you can also access variables
with <strong><em>context.getVariable("user")</em></strong> for instance. On the test context you can also set new variable values with <strong><em>context.setVariable("user", "newUserName")</em></strong> .</p>
</div>
<div class="paragraph">
<p>There is even more object injection for the validation script. With the automatically added object <strong><em>receivedMessage</em></strong> You
have access to the Citrus message object for this receive action. This enables you to do whatever you want with the message
payload or header.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .validate(groovy().script("assert receivedMessage.getPayload(String.class).contains(\"Hello Citrus!\")\n" +
                              "assert receivedMessage.getHeader(\"Operation\") == 'sayHello'\n" +
                              "context.setVariable(\"request_payload\", receivedMessage.getPayload(String.class))"))
    .timeout(5000L);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint" timeout="5000"&gt;
    &lt;message&gt;
        &lt;validate&gt;
            &lt;script type="groovy"&gt;
                assert receivedMessage.getPayload(String.class).contains("Hello Citrus!")
                assert receivedMessage.getHeader("Operation") == 'sayHello'

                context.setVariable("request_payload", receivedMessage.getPayload(String.class))
            &lt;/script&gt;
        &lt;/validate&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The listing above shows some power of the validation script. We can access the message payload, we can access the message
header. With test context access we can also save the whole message payload as a new test variable for later usage in the test.</p>
</div>
<div class="paragraph">
<p>In general Groovy code inside the XML test case definition or as part of the Java DSL code is not very comfortable to maintain.
You do not have code syntax assist or code completion. This is why we can also use external file resources for the validation
scripts. The syntax looks like follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .validate(groovy()
            .script(new ClassPathResource("validationScript.groovy"))
    .timeout(5000L);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint" timeout="5000"&gt;
    &lt;message&gt;
        &lt;validate&gt;
            &lt;script type="groovy" file="classpath:validationScript.groovy"/&gt;
        &lt;/validate&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We referenced some external file resource <strong><em>validationScript.groovy</em></strong> . This file content is loaded at runtime and is used
as script body. Now that we have a normal groovy file we can use the code completion and syntax highlighting of our favorite
Groovy editor.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can use the Groovy validation script in combination with other validation types like XML tree comparison and XPath
validation.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For further information on the Groovy XmlSlurper please see the official Groovy website and documentation
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="xml-schema-validation"><a class="anchor" href="#xml-schema-validation"></a><a class="link" href="#xml-schema-validation">7.4.9. XML schema validation</a></h4>
<div class="paragraph">
<p>There are several possibilities to describe the structure of XML documents. The two most popular ways are DTD
(Document type definition) and XSD (XML Schema definition). In case the XML document is classified using a
schema definition the structure of the document has to fit the predefined rules inside the schema definition.
XML document instances are valid only in case they meet all these structure rules defined in the schema definition.
Citrus can validate XML documents using the schema languages DTD and XSD.</p>
</div>
<div class="sect4">
<h5 id="xsd-schema-repositories"><a class="anchor" href="#xsd-schema-repositories"></a><a class="link" href="#xsd-schema-repositories">XSD schema repositories</a></h5>
<div class="paragraph">
<p>Citrus tries to validate all incoming XML messages against a schema definition in order to ensure that all rules are
fulfilled. This means that the message receiving actions in Citrus have to know the XML schema definition file
resources that belong to our test context.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public XsdSchemaRepository schemaRepository() {
    XsdSchemaRepository repository = new XsdSchemaRepository();
    repository.getSchemas().add(travelAgencySchema());
    repository.getSchemas().add(royalAirlineSchema());
    repository.getSchemas().add(smartAirlineSchema());
    return repository;
}

@Bean
public SimpleXsdSchema travelAgencySchema() {
    return new SimpleXsdSchema(
            new ClassPathResource("classpath:citrus/flightbooking/TravelAgencySchema.xsd"));
}

@Bean
public SimpleXsdSchema royalAirlineSchema() {
    return new SimpleXsdSchema(
            new ClassPathResource("classpath:citrus/flightbooking/RoyalAirlineSchema.xsd"));
}

@Bean
public SimpleXsdSchema smartAirlineSchema() {
    return new SimpleXsdSchema(
            new ClassPathResource("classpath:citrus/flightbooking/SmartAirlineSchema.xsd"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:schema-repository id="schemaRepository"&gt;
    &lt;citrus:schemas&gt;
        &lt;citrus:schema id="travelAgencySchema"
            location="classpath:citrus/flightbooking/TravelAgencySchema.xsd"/&gt;
        &lt;citrus:schema id="royalAirlineSchema"
            location="classpath:citrus/flightbooking/RoyalAirlineSchema.xsd"/&gt;
        &lt;citrus:reference schema="smartAirlineSchema"/&gt;
    &lt;/citrus:schemas&gt;
&lt;/citrus:schema-repository&gt;

&lt;citrus:schema id="smartAirlineSchema"
      location="classpath:citrus/flightbooking/SmartAirlineSchema.xsd"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>By convention there is a default schema repository component defined in the Citrus Spring application context with
the id <strong>schemaRepository</strong>. Spring application context is then able to inject the schema repository into all message
receiving test actions at runtime. The receiving test action consolidates the repository for a matching schema
definition file in order to validate the incoming XML document structure.</p>
</div>
<div class="paragraph">
<p>The connection between incoming XML messages and xsd schema files in the repository is done by a mapping strategy which
we will discuss later in this chapter. By default, Citrus picks the right schema based on the target namespace that is
defined inside the schema definition. The target namespace of the schema definition has to match the namespace of the
root element in the received XML message. With this mapping strategy you will not have to wire XML messages and schema
files manually, all is done automatically by the Citrus schema repository at runtime. All you need to do is to register
all available schema definition files regardless of which target namespace or nature inside the Citrus schema
repository.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
XML schema validation is mandatory in Citrus. This means that Citrus always tries to find a matching schema
definition inside the schema repository in order to perform syntax validation on incoming schema qualified XML messages.
A classified XML message is defined by its namespace definitions. Consequently you will get validation errors in case
no matching schema definition file is found inside the schema repository. So if you explicitly do not want to validate
the XML schema for some reason you have to disable the validation explicitly in your test with
<strong>schema-validation="false"</strong>.
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .validate(validate().xpath()
            .expression("//ns1:TestMessage/ns1:MessageHeader/ns1:MessageId", "${messageId}")
            .expression("//ns1:TestMessage/ns1:MessageHeader/ns1:CorrelationId", "${correlationId}")
            .schemaValidation(false)
            .namespaceContext("ns1", "http://citrus.com/namespace"))
    .timeout(5000L);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
    &lt;message schema-validation="false"&gt;
      &lt;validate&gt;
        &lt;xpath expression="//ns1:TestMessage/ns1:MessageHeader/ns1:MessageId"
             value="${messageId}"/&gt;
        &lt;xpath expression="//ns1:TestMessage/ns1:MessageHeader/ns1:CorrelationId"
             value="${correlationId}"/&gt;
        &lt;namespace prefix="ns1" value="http://citrus.com/namespace"/&gt;
      &lt;/validate&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This mandatory schema validation might sound annoying to you but in our opinion it is very important to validate the
structure of the received XML messages, so disabling the schema validation should not be the standard for all tests.
Disabling automatic schema validation should only apply to very special situations. So please try to put all available
schema definitions to the schema repository and you will be fine.</p>
</div>
</div>
<div class="sect4">
<h5 id="wsdl-schemas"><a class="anchor" href="#wsdl-schemas"></a><a class="link" href="#wsdl-schemas">WSDL schemas</a></h5>
<div class="paragraph">
<p>In SOAP WebServices world the WSDL (WebService Schema Definition Language) defines the structure and nature of the XML
messages exchanged across the interface. Often the WSDL files do hold the XML schema definitions as nested elements.
In Citrus you can directly set the WSDL file as location of a schema definition like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WsdlXsdSchema airlineWsdl() {
    return new WsdlXsdSchema(
            new ClassPathResource("classpath:citrus/flightbooking/AirlineSchema.wsdl"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:schema id="airlineWsdl"
    location="classpath:citrus/flightbooking/AirlineSchema.wsdl"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus is able to find the nested schema definitions inside the WSDL file in order to build a valid schema file for the
schema repository. So incoming XML messages that refer to the WSDL file can be validated for syntax rules.</p>
</div>
</div>
<div class="sect4">
<h5 id="schema-collections"><a class="anchor" href="#schema-collections"></a><a class="link" href="#schema-collections">Schema collections</a></h5>
<div class="paragraph">
<p>Sometimes an XML schema definition is separated into multiple files. This is a problem for the Citrus schema repository
as the schema mapping strategy then is not able to pick the right file for validation, in particular when working with
target namespace values as key for the schema mapping strategy. As a solution for this problem you have to put all
schemas with the same target namespace value into a schema collection.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public XsdSchemaCollection flightbookingSchemaCollection() {
    XsdSchemaCollection collection = new XsdSchemaCollection();
    collection.getSchemas().add("classpath:citrus/flightbooking/BaseTypes.xsd");
    collection.getSchemas().add("classpath:citrus/flightbooking/AirlineSchema.xsd");
    return collection;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:schema-collection id="flightbookingSchemaCollection"&gt;
  &lt;citrus:schemas&gt;
    &lt;citrus:schema location="classpath:citrus/flightbooking/BaseTypes.xsd"/&gt;
    &lt;citrus:schema location="classpath:citrus/flightbooking/AirlineSchema.xsd"/&gt;
  &lt;/citrus:schemas&gt;
&lt;/citrus:schema-collection&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both schema definitions <strong>BaseTypes.xsd</strong> and <strong>AirlineSchema.xsd</strong> share the same target namespace and therefore need to
be combined in schema collection component. The schema collection can be referenced in any schema repository as normal
schema definition.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public XsdSchemaRepository schemaRepository() {
    XsdSchemaRepository repository = new XsdSchemaRepository();
    repository.getSchemas().add(flightbookingSchemaCollection());
    return repository;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:schema-repository id="schemaRepository"&gt;
  &lt;citrus:schemas&gt;
    &lt;citrus:reference schema="flightbookingSchemaCollection"/&gt;
  &lt;/citrus:schemas&gt;
&lt;/citrus:schema-repository&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="schema-mapping-strategy"><a class="anchor" href="#schema-mapping-strategy"></a><a class="link" href="#schema-mapping-strategy">Schema mapping strategy</a></h5>
<div class="paragraph">
<p>The schema repository in Citrus holds one to many schema definition files and dynamically picks up the right one
according to the validated message payload. The repository needs to have some strategy for deciding which schema
definition to choose. See the following schema mapping strategies and decide which of them is suitable for you.</p>
</div>
</div>
<div class="sect4">
<h5 id="target-namespace-mapping-strategy"><a class="anchor" href="#target-namespace-mapping-strategy"></a><a class="link" href="#target-namespace-mapping-strategy">Target Namespace Mapping Strategy</a></h5>
<div class="paragraph">
<p>This is the default schema mapping strategy. Schema definitions usually define some target namespace which is valid
for all elements and types inside the schema file. The target namespace is also used as root namespace in XML message
payloads. According to this information Citrus can pick up the right schema definition file in the schema repository.
You can set the schema mapping strategy as property in the configuration files:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public XsdSchemaRepository schemaRepository() {
    XsdSchemaRepository repository = new XsdSchemaRepository();
    repository.setSchemaMappingStrategy(schemaMappingStrategy());
    repository.getSchemas().add(helloSchema());
    return repository;
}

@Bean
public TargetNamespaceSchemaMappingStrategy schemaMappingStrategy() {
    return new TargetNamespaceSchemaMappingStrategy();
}

@Bean
public SimpleXsdSchema helloSchema() {
    return new SimpleXsdSchema(
            new ClassPathResource("classpath:citrus/samples/sayHello.xsd"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:schema-repository id="schemaRepository"
    schema-mapping-strategy="schemaMappingStrategy"&gt;
  &lt;citrus:schemas&gt;
    &lt;citrus:schema id="helloSchema"
        location="classpath:citrus/samples/sayHello.xsd"/&gt;
  &lt;/citrus:schemas&gt;
&lt;/citrus:schema-repository&gt;

&lt;bean id="schemaMappingStrategy"
    class="org.citrusframework.xml.schema.TargetNamespaceSchemaMappingStrategy"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>sayHello.xsd</strong> schema file defines a target namespace (<a href="http://citrusframework.org/schemas/sayHello.xsd)">http://citrusframework.org/schemas/sayHello.xsd)</a>:</p>
</div>
<div class="listingblock">
<div class="title">Schema target namespace</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns="http://citrusframework.org/schemas/sayHello.xsd"
    targetNamespace="http://citrusframework.org/schemas/sayHello.xsd"
    elementFormDefault="qualified"
    attributeFormDefault="unqualified"&gt;

&lt;/xs:schema&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Incoming request messages should also have the target namespace set in the root element and this is how Citrus matches
the right schema file in the repository.</p>
</div>
<div class="listingblock">
<div class="title">HelloRequest.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;HelloRequest xmlns="http://citrusframework.org/schemas/sayHello.xsd"&gt;
   &lt;MessageId&gt;123456789&lt;/MessageId&gt;
   &lt;CorrelationId&gt;1000&lt;/CorrelationId&gt;
   &lt;User&gt;Christoph&lt;/User&gt;
   &lt;Text&gt;Hello Citrus&lt;/Text&gt;
&lt;/HelloRequest&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="root-qname-mapping-strategy"><a class="anchor" href="#root-qname-mapping-strategy"></a><a class="link" href="#root-qname-mapping-strategy">Root QName Mapping Strategy</a></h5>
<div class="paragraph">
<p>The next possibility for mapping incoming request messages to a schema definition is via the XML root element QName.
Each XML message payload starts with a root element that usually declares the type of an XML message. According to this
root element you can set up mappings in the schema repository.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public XsdSchemaRepository schemaRepository() {
    XsdSchemaRepository repository = new XsdSchemaRepository();
    repository.setSchemaMappingStrategy(schemaMappingStrategy());
    repository.getSchemas().add(helloSchema());
    repository.getSchemas().add(goodbyeSchema());
    return repository;
}

@Bean
public RootQNameSchemaMappingStrategy schemaMappingStrategy() {
    RootQNameSchemaMappingStrategy rootQnameStrategy = new RootQNameSchemaMappingStrategy();
    rootQnameStrategy.getMappings().put("HelloRequest", helloSchema());
    rootQnameStrategy.getMappings().put("GoodbyeRequest", goodbyeSchema());

    return rootQnameStrategy;
}

@Bean
public SimpleXsdSchema helloSchema() {
    return new SimpleXsdSchema(
            new ClassPathResource("classpath:citrus/samples/sayHello.xsd"));
}

@Bean
public SimpleXsdSchema goodbyeSchema() {
    return new SimpleXsdSchema(
            new ClassPathResource("classpath:citrus/samples/sayGoodbye.xsd"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:schema-repository id="schemaRepository"
    schema-mapping-strategy="schemaMappingStrategy"&gt;
  &lt;citrus:schemas&gt;
    &lt;citrus:reference schema="helloSchema"/&gt;
    &lt;citrus:reference schema="goodbyeSchema"/&gt;
  &lt;/citrus:schemas&gt;
&lt;/citrus:schema-repository&gt;

&lt;bean id="schemaMappingStrategy"
    class="org.citrusframework.xml.schema.RootQNameSchemaMappingStrategy"&gt;
  &lt;property name="mappings"&gt;
    &lt;map&gt;
      &lt;entry key="HelloRequest" value="helloSchema"/&gt;
      &lt;entry key="GoodbyeRequest" value="goodbyeSchema"/&gt;
    &lt;/map&gt;
  &lt;/property&gt;
&lt;/bean&gt;

&lt;citrus:schema id="helloSchema"
    location="classpath:citrus/samples/sayHello.xsd"/&gt;

&lt;citrus:schema id="goodbyeSchema"
     location="classpath:citrus/samples/sayGoodbye.xsd"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The listing above defines two root qname mappings - one for <strong>HelloRequest</strong> and one for <strong>GoodbyeRequest</strong> message types.
An incoming message of type &lt;HelloRequest&gt; is then mapped to the respective schema and so on. With these dedicated
mappings you are able to control which schema is used on an XML request, regardless of target namespace definitions.</p>
</div>
</div>
<div class="sect4">
<h5 id="schema-mapping-strategy-chain"><a class="anchor" href="#schema-mapping-strategy-chain"></a><a class="link" href="#schema-mapping-strategy-chain">Schema mapping strategy chain</a></h5>
<div class="paragraph">
<p>Let&#8217;s discuss the possibility to combine several schema mapping strategies in a logical chain. You can define more than
one mapping strategy that are evaluated in sequence. The first strategy to find a proper schema definition file in the
repository wins.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public XsdSchemaRepository schemaRepository() {
    XsdSchemaRepository repository = new XsdSchemaRepository();
    repository.setSchemaMappingStrategy(schemaMappingStrategy());
    repository.getSchemas().add(helloSchema());
    repository.getSchemas().add(goodbyeSchema());
    return repository;
}

@Bean
public SchemaMappingStrategyChain schemaMappingStrategy() {
    SchemaMappingStrategyChain chain = new SchemaMappingStrategyChain();

    RootQNameSchemaMappingStrategy rootQnameStrategy = new RootQNameSchemaMappingStrategy();
    rootQnameStrategy.getMappings().put("HelloRequest", helloSchema());

    chain.setStrategies(Arrays.asList(
        rootQnameStrategy,
        new TargetNamespaceSchemaMappingStrategy()
    ));

    return chain;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:schema-repository id="schemaRepository"
    schema-mapping-strategy="schemaMappingStrategy"&gt;
  &lt;citrus:schemas&gt;
    &lt;citrus:reference schema="helloSchema"/&gt;
    &lt;citrus:reference schema="goodbyeSchema"/&gt;
  &lt;/citrus:schemas&gt;
&lt;/citrus:schema-repository&gt;

&lt;bean id="schemaMappingStrategy"
    class="org.citrusframework.xml.schema.SchemaMappingStrategyChain"&gt;
  &lt;property name="strategies"&gt;
    &lt;list&gt;
      &lt;bean class="org.citrusframework.xml.schema.RootQNameSchemaMappingStrategy"&gt;
        &lt;property name="mappings"&gt;
          &lt;map&gt;
            &lt;entry key="HelloRequest" value="helloSchema"/&gt;
          &lt;/map&gt;
        &lt;/property&gt;
      &lt;/bean&gt;
      &lt;bean class="org.citrusframework.xml.schema.TargetNamespaceSchemaMappingStrategy"/&gt;
    &lt;/list&gt;
  &lt;/property&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>So the schema mapping chain uses both <strong>RootQNameSchemaMappingStrategy</strong> and <strong>TargetNamespaceSchemaMappingStrategy</strong> in
combination. In case the first root qname strategy fails to find a proper mapping the next target namespace strategy
comes in and tries to find a proper schema.</p>
</div>
</div>
<div class="sect4">
<h5 id="dtd-validation"><a class="anchor" href="#dtd-validation"></a><a class="link" href="#dtd-validation">DTD validation</a></h5>
<div class="paragraph">
<p>XML DTD (document type definition) is another way to validate the structure of an XML document. Many people say that
DTD is outdated and XML schema is the much more efficient way to describe the rules of an XML structure. We do not
disagree with that, but we also know that legacy systems might still use DTD. So in order to avoid validation errors
we have to deal with DTD validation as well.</p>
</div>
<div class="paragraph">
<p>First thing you can do about DTD validation is to specify an inline DTD in your expected message template.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .message()
    .body("&lt;!DOCTYPE root [\n" +
                "&lt;!ELEMENT root (message)&gt;\n" +
                "&lt;!ELEMENT message (text)&gt;\n" +
                "&lt;!ELEMENT text (#PCDATA)&gt;\n" +
            "]&gt;\n" +
            "&lt;root&gt;\n" +
                "&lt;message&gt;\n" +
                    "&lt;text&gt;Hello from Citrus!&lt;/text&gt;\n" +
                "&lt;/message&gt;\n" +
            "&lt;/root&gt;")
    .timeout(5000L);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
    &lt;message schema-validation="false"&gt;
        &lt;data&gt;
        &lt;![CDATA[
            &lt;!DOCTYPE root [
                &lt;!ELEMENT root (message)&gt;
                &lt;!ELEMENT message (text)&gt;
                &lt;!ELEMENT text (#PCDATA)&gt;
                ]&gt;
            &lt;root&gt;
                &lt;message&gt;
                    &lt;text&gt;Hello from Citrus!&lt;/text&gt;
                &lt;/message&gt;
            &lt;/root&gt;
        ]]&gt;
        &lt;/data&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The system under test may also send the message with an inline DTD definition. So validation will succeed.</p>
</div>
<div class="paragraph">
<p>In most cases the DTD is referenced as external .dtd file resource. You can do this in your expected message template
as well.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .message()
    .body("&lt;!DOCTYPE root SYSTEM \"org/citrusframework/validation/example.dtd\"&gt;\n" +
            "&lt;root&gt;\n" +
                "&lt;message&gt;\n" +
                    "&lt;text&gt;Hello from Citrus!&lt;/text&gt;\n" +
                "&lt;/message&gt;\n" +
            "&lt;/root&gt;")
    .timeout(5000L);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
    &lt;message schema-validation="false"&gt;
        &lt;data&gt;
        &lt;![CDATA[
            &lt;!DOCTYPE root SYSTEM "org/citrusframework/validation/example.dtd"&gt;
            &lt;root&gt;
                &lt;message&gt;
                    &lt;text&gt;Hello from Citrus!&lt;/text&gt;
                &lt;/message&gt;
            &lt;/root&gt;
        ]]&gt;
        &lt;data/&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="xml-validation-xhtml"><a class="anchor" href="#xml-validation-xhtml"></a><a class="link" href="#xml-validation-xhtml">7.4.10. XHTML validation</a></h4>
<div class="paragraph">
<p>Html message content is hard to verify with XML validation capabilities such as XML tree comparison or XPath support.
Usually Html messages do not follow the XML well-formed rules very strictly. This implies that XML message validation will
fail because of non-well-formed Html code.</p>
</div>
<div class="paragraph">
<p>XHTML closes this gap by automatically fixing the most common Html XML incompatible rule violations such as missing end
tags (e.g. &lt;br&gt;).</p>
</div>
<div class="paragraph">
<p>Please add a new library dependency to your project. Citrus is using the <strong>jtidy</strong> library in order to prepare the HTML and
XHTML messages for validation. As this 3rd party dependency is optional in Citrus we have to add it now to our project dependency
list. Just add the <strong>jtidy</strong> dependency to your Maven project POM.</p>
</div>
<div class="listingblock">
<div class="title">Jtidy library</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;net.sf.jtidy&lt;/groupId&gt;
    &lt;artifactId&gt;jtidy&lt;/artifactId&gt;
    &lt;version&gt;r938&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please refer to the <strong>jtidy</strong> project documentation for the latest versions. Now everything is ready. As usual the Citrus
message validator for XHTML is active in background by default. You can overwrite this default implementation by placing
a Spring bean with id <strong>defaultXhtmlMessageValidator</strong> to the Citrus application context.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public XhtmlMessageValidator defaultXhtmlMessageValidator() {
    return new XhtmlMessageValidator();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="defaultXhtmlMessageValidator" class="org.citrusframework.validation.xhtml.XhtmlMessageValidator"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can use the XHTML message validation in your test case.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .message()
    .type(MessageType.XHTML)
    .body("&lt;!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.1//EN\" \"org/w3c/xhtml/xhtml1-strict.dtd\"&gt;" +
            "&lt;html xmlns=\"http://www.w3.org/1999/xhtml\"&gt;" +
                "&lt;head&gt;" +
                    "&lt;title&gt;Citrus Hello World&lt;/title&gt;" +
                "&lt;/head&gt;" +
                "&lt;body&gt;" +
                    "&lt;h1&gt;Hello World!&lt;/h1&gt;" +
                    "&lt;br/&gt;" +
                    "&lt;p&gt;This is a test!&lt;/p&gt;" +
                "&lt;/body&gt;" +
            "&lt;/html&gt;")
    .timeout(5000L);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
    &lt;message type="xhtml"&gt;
        &lt;data&gt;
          &lt;![CDATA[
            &lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "org/w3c/xhtml/xhtml1-strict.dtd"&gt;
            &lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;
              &lt;head&gt;
                &lt;title&gt;Citrus Hello World&lt;/title&gt;
              &lt;/head&gt;
              &lt;body&gt;
                &lt;h1&gt;Hello World!&lt;/h1&gt;
                &lt;br/&gt;
                &lt;p&gt;This is a test!&lt;/p&gt;
              &lt;/body&gt;
            &lt;/html&gt;
          ]]&gt;
        &lt;/data&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message receiving action in our test case has to specify a message format type <strong>type="xhtml"</strong> . As you can see the Html
message payload get XHTML specific DOCTYPE processing instruction. The <strong>xhtml1-strict.dtd</strong> is mandatory in the XHTML message
validation. For better convenience all XHTML dtd files are packaged within Citrus so you can use this as a relative path.</p>
</div>
<div class="paragraph">
<p>The incoming Html message is automatically converted into proper XHTML code with well formed XML. So now the XHTML message
validator can use the XML message validation mechanism of Citrus for comparing received and expected data. You can also use
test variables, ignore element expressions and XPath expressions.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="schema-validation"><a class="anchor" href="#schema-validation"></a><a class="link" href="#schema-validation">7.5. Schema validation</a></h3>
<div class="paragraph">
<p>When structured data is transmitted from one system to another, it is important that both sender and receiver
agree on an interface contract. The contract introduces rules of communication for both parties.</p>
</div>
<div class="paragraph">
<p>Schemas represent the most popular way to define contracts. Citrus is able to manage multiple schemas in the project context.
You can define mapping rules to pick the right schema for a message validation.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start with this chapter by introducing some basic concepts of the schema validation.</p>
</div>
<div class="sect3">
<h4 id="schema-definition"><a class="anchor" href="#schema-definition"></a><a class="link" href="#schema-definition">7.5.1. Schema definition</a></h4>
<div class="paragraph">
<p>Complex applications require multiple schemas that are relevant for different use cases. You should organize these schemas
in your test project. First you need to add a schema definition that points to the schema location.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SimpleXsdSchema bookstoreSchema() {
    return new SimpleXsdSchema(new ClassPathResource("classpath:org/citrusframework/xml/BookStore.wsdl"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:schema id="bookstoreSchema" location="classpath:org/citrusframework/xml/BookStore.wsdl"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please keep in mind, that the id of the schema has to be unique within the context.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The samples above are using XML XSD/WSDL schema definitions. The same approach applies to Json schemas, too. You just need
to use the <code>SimpleJsonSchema</code> class in the Java configuration. The XML configuration components derive the schema type automatically
based on the file extension (<code>.xsd</code>, <code>.wsdl</code>, <code>.json</code>).
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="schema-repository"><a class="anchor" href="#schema-repository"></a><a class="link" href="#schema-repository">7.5.2. Schema repository</a></h4>
<div class="paragraph">
<p>You can now reference the schema definition in a repository component. The repository is able to hold multiple schema definitions.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public XsdSchemaRepository schemaRepository() {
    XsdSchemaRepository repository = new XsdSchemaRepository();
    repository.getSchemas().add(bookstoreSchema());
    return repository;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:schema-repository id="schemaRepository"&gt;
  &lt;citrus:schemas&gt;
    &lt;citrus:reference schema="bookstoreSchema" /&gt;
  &lt;/citrus:schemas&gt;
&lt;/citrus:schema-repository&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus allows you to reuse your schema definition within your context by referencing them. For a valid reference,
the id of the schema and the value of the schema attribute within the reference element have to match.</p>
</div>
<div class="paragraph">
<p>As an alternative to a schema reference you can also provide the schema location in a repository.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public XsdSchemaRepository schemaRepository() {
    XsdSchemaRepository repository = new XsdSchemaRepository();
    repository.getLocations().add("classpath:schemas/flightbooking.xsd");
    return repository;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:schema-repository id="schemaRepository"&gt;
  &lt;citrus:locations&gt;
    &lt;citrus:location path="classpath:schemas/flightbooking.xsd"/&gt;
  &lt;/citrus:locations&gt;
&lt;/citrus:schema-repository&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The given location points to the schema definition file. Setting all schemas one by one can be verbose and cumbersome, especially
when dealing with lots of schema files. Therefore, Citrus provides schema location patterns which will import all matching schema files
within the given location.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public XsdSchemaRepository schemaRepository() {
    XsdSchemaRepository repository = new XsdSchemaRepository();
    repository.getLocations().add("classpath:schemas/*.xsd");
    return repository;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:schema-repository id="schemaRepository"&gt;
  &lt;citrus:locations&gt;
    &lt;citrus:location path="classpath:schemas/*.xsd"/&gt;
  &lt;/citrus:locations&gt;
&lt;/citrus:schema-repository&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The schema repository is able to receive many schemas with different locations and schema sources.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SimpleXsdSchema testSchema() {
    return new SimpleXsdSchema(new ClassPathResource("classpath:org/citrusframework/xml/test.xsd"));
}

@Bean
public XsdSchemaRepository schemaRepository() {
    SimpleXsdSchema bookstoreSchema = new SimpleXsdSchema(
            new ClassPathResource("classpath:org/citrusframework/xml/BookStore.wsdl"));

    XsdSchemaRepository repository = new XsdSchemaRepository();
    repository.getSchemas().add(bookstoreSchema);
    repository.getSchemas().add(testSchema());
    repository.getLocations().add("classpath:schemas/*.xsd");
    return repository;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:schema id="testSchema" location="classpath:org/citrusframework/xml/test.xsd"/&gt;

&lt;citrus:schema-repository id="xmlSchemaRepository"&gt;
  &lt;citrus:schemas&gt;
    &lt;citrus:schema id="bookstoreSchema" location="classpath:org/citrusframework/xml/BookStore.wsdl"/&gt;
    &lt;citrus:reference schema="testSchema"/&gt;
    &lt;citrus:location path="classpath:schemas/*.xsd"/&gt;
  &lt;/citrus:schemas&gt;
&lt;/citrus:schema-repository&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The examples in this chapter have been using XML XSD schema repository components. Of course, the same components are
available for Json schema repositories, too. By default, the type of the schema repository is <code>type=xml</code>. You can use <code>type=json</code>
to mark the schema repository as Json nature. In Java configuration please use the <code>JsonSchemaRepository</code> class.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The schema repository component holds a set of schema files for a project disjoint by their type (xml, json, etc.) and identified
by its unique id.</p>
</div>
<div class="paragraph">
<p>As you can see the schema repository is a simple bean defined inside the Spring application context.
The repository can hold nested schema definitions, references and location definitions for all types of schema
repositories.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
In case you have several schema repositories in your project do always define a default repository
(name="schemaRepository"). This helps Citrus to always find at least one repository to interact with.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="schema-mapping"><a class="anchor" href="#schema-mapping"></a><a class="link" href="#schema-mapping">7.5.3. Schema definition mapping</a></h4>
<div class="paragraph">
<p>Depending on the type of message you want to validate, there are different attempts to find the correct schema for the
given message. The XML schema repository will apply a mapping strategy that decides which schema should verify the current
message. Citrus knows multiple mapping strategies that you can review in chapter <a href="#xml-schema-validation">XML schema validation</a>.</p>
</div>
<div class="paragraph">
<p>As a user you always have the chance to explicitly pick the right schema definition for a <code>receive</code> operation. You can overrule
all schema mapping strategies in Citrus by directly setting the desired schema in your receiving message action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(httpMessageEndpoint)
    .message()
    .validate(
        xml().schema("helloSchema")
    );</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="httpMessageEndpoint"&gt;
    &lt;message schema="helloSchema"&gt;
      &lt;payload&gt;
        ...
      &lt;/payload&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above the tester explicitly sets a schema definition in the <code>receive</code> action (schema="helloSchema").
The schema value refers to named schema bean defined in the project context (e.g. Spring application context).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This overrules all schema mapping strategies used in the central schema repository as the given schema is directly
used for validation. This feature is helpful when dealing with different schema versions at the same time.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Another possibility would be to set a custom schema repository at this point. This means you can have more than one
schema repository in your Citrus project and you pick the right one by yourself in the <code>receive</code> action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(httpMessageEndpoint)
    .message()
    .validate(
        xml().schemaRepository("helloSchemaRepository")
    );</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="httpMessageEndpoint"&gt;
    &lt;message schema-repository="helloSchemaRepository"&gt;
      &lt;payload&gt;
        ...
      &lt;/payload&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>schema-repository</strong> attribute refers to a Citrus schema repository component which is defined as bean in the
project context.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="plaintext-message-validation"><a class="anchor" href="#plaintext-message-validation"></a><a class="link" href="#plaintext-message-validation">7.6. Plain text validation</a></h3>
<div class="paragraph">
<p>Plain text message validation performs an exact Java String match of received and expected message payloads.</p>
</div>
<div class="paragraph">
<p>Plaintext message validation is not enabled by default in your project. You need to add the validation module to your project
as a Maven dependency.</p>
</div>
<div class="listingblock">
<div class="title">Plaintext validation module dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-validation-text&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This adds the default message validator for plaintext messages. Citrus will pick this message validator for all messages
of <strong>type="plaintext"</strong>. The default message validator implementation can be overwritten by placing a Spring bean with
id <strong>defaultPlaintextMessageValidator</strong>.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public PlainTextMessageValidator defaultPlaintextMessageValidator() {
    return new PlainTextMessageValidator();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="defaultPlaintextMessageValidator" class="org.citrusframework.validation.text.PlainTextMessageValidator"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus will try to auto-guess the appropiate message validator for the incoming message. You can explicitly set the message
type on the receive action so Citrus knows how to apply plaintext message validation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .message()
    .type(MessageType.PLAINTEXT)
    .body("Hello World!");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
    &lt;message type="plaintext"&gt;
        &lt;data&gt;Hello World!&lt;/data&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the message format type <strong>type="plaintext"</strong> set Citrus performs String equals on the message payloads (received and expected).
Only exact match will pass the test.</p>
</div>
<div class="paragraph">
<p>Of course test variables are supported in the plaintext payloads. The variables are replaced before processing the message
template.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .message()
    .type(MessageType.PLAINTEXT)
    .body("${hello} ${world}!");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
    &lt;message type="plaintext"&gt;
        &lt;data&gt;${hello} ${world}!&lt;/data&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="plaintext-validation-whitespaces"><a class="anchor" href="#plaintext-validation-whitespaces"></a><a class="link" href="#plaintext-validation-whitespaces">7.6.1. Whitespace characters</a></h4>
<div class="paragraph">
<p>Plaintext message payloads may only differ in system-dependent line separator characters (<strong>CR</strong>, <em>LF</em>, <em>CRLF</em>). By default,
the plaintext message validation fails because of that differences even if only whitespace characters are different.</p>
</div>
<div class="paragraph">
<p>You can disable this default validation behavior and ignore new line types with following system property or environment variable:</p>
</div>
<div class="listingblock">
<div class="title">Plaintext validation settings</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">citrus.plaintext.validation.ignore.newline.type=true
CITRUS_PLAINTEXT_VALIDATION_IGNORE_NEWLINE_TYPE=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case you need to ignore all whitespaces during plaintext validation such as multiple new line characters or tabs you
need to set this system property or environment variable:</p>
</div>
<div class="listingblock">
<div class="title">Plaintext validation settings</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">citrus.plaintext.validation.ignore.whitespace=true
CITRUS_PLAINTEXT_VALIDATION_IGNORE_WHITESPACE=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>This property will not only ignore new line types but also normalize the whitespaces. As a result all empty lines, tabs
and double whitespace characters are filtered before comparison.</p>
</div>
<div class="paragraph">
<p>Of course, you can also set the properties directly on the plaintext message validator bean:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public PlainTextMessageValidator defaultPlaintextMessageValidator() {
    PlainTextMessageValidator validatoe = new PlainTextMessageValidator();
    validator.setIgnoreNewLineType(true);
    validator.setIgnoreWhitespace(true);
    return validator;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="defaultPlaintextMessageValidator" class="org.citrusframework.validation.text.PlainTextMessageValidator"&gt;
  &lt;property name="ignoreNewLineType" value="true"/&gt;
  &lt;property name="ignoreWhitespace" value="true"/&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="plaintext-validation-ignore"><a class="anchor" href="#plaintext-validation-ignore"></a><a class="link" href="#plaintext-validation-ignore">7.6.2. Ignoring text parts</a></h4>
<div class="paragraph">
<p>The plaintext validator performs a String equals operation. Test variables are automatically replaced before that comparison
takes place but what about ignore statements? The plaintext message validator is able to ignore words and character sequences
based on their position in the text value. Given a source plaintext value:</p>
</div>
<div class="listingblock">
<div class="title">Received text</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Your current id is "1234567890"</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the plaintext validation you need to ignore the actual id value due to some reason. Maybe the id is generated on a foreign
application and you simply do not know the actual value at runtime.</p>
</div>
<div class="paragraph">
<p>In this case we can use the common <code>@ignore@</code> statement in the control message payload as follows:</p>
</div>
<div class="listingblock">
<div class="title">Control text</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Your current id is "@ignore@"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus and the plaintext message validator will ignore the marked part of the text during validation. This mechanism is
based on the fact that the <code>@ignore@</code> statement is placed at the exact same position as the actual id value. So this mechanism
requires you to know the exact structure of the plaintext value including all whitespace characters. In case Citrus finds the <code>@ignore@</code>
keyword in the control value the placeholder is replaced with the actual character sequence that is located at the exact
same position in the source message payload that is validated.</p>
</div>
<div class="paragraph">
<p>The character sequence is defined as sequence of Java word characters. This word sequence is ending with a non-word character
defined in Java (<code>\\W</code> which is a character that is not in <code>[a-zA-Z_0-9]</code>).</p>
</div>
<div class="paragraph">
<p>Instead of ignoring a single word you can also specify the amount of characters that should be ignored. This is when you
have Java non-word characters that you need to ignore. Let&#8217;s have an example for that, too:</p>
</div>
<div class="listingblock">
<div class="title">Received text</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Your current id is "#12345-67890"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Given that text the simple <code>@ignore@</code> statement will fail because of the non-word characters <strong>'#'</strong> and <strong>'-'</strong> that are located
in the id value. This time we ignore the whole id sequence with:</p>
</div>
<div class="listingblock">
<div class="title">Control text</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Your current id is "@ignore(12)@"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will ignore exactly <strong>12</strong> characters starting from the exact position of the <code>@ignore@</code> keyword. So knowing that the
id is exactly <strong>12</strong> characters long we can ignore that part.</p>
</div>
</div>
<div class="sect3">
<h4 id="plaintext-validation-variables"><a class="anchor" href="#plaintext-validation-variables"></a><a class="link" href="#plaintext-validation-variables">7.6.3. Creating variables</a></h4>
<div class="paragraph">
<p>Instead of just ignoring certain text parts we can also extract those parts into test variables. The actual character sequence
is ignored during validation and in addition to that the actual value is stored to a new test variable. Given the following text payload:</p>
</div>
<div class="listingblock">
<div class="title">Received text</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Your current id is "1234567890"</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the expected control text:</p>
</div>
<div class="listingblock">
<div class="title">Control text</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Your current id is "@variable('id')@"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The validation will automatically ignore the id part in the text and create a new test variable with name <code>id</code> that holds
the actual value. The name of the variable to create is given in the <code>@variable()@</code> statement. This enables us to extract
dynamic text parts that we are not able to validate. After that we can access the dynamic text part using the normal test
variable syntax <code>${id}</code>.</p>
</div>
<div class="paragraph">
<p>Also notice that the <code>@variable()@</code> keyword expression has to be placed at the exact same position in the text as the actual
value. The variable extractor will read the variable value from the source message payload starting from that position.
The ending of the variable value is defined by a non-word Java character. Dashes <strong>'-'</strong> and dots <strong>'.'</strong> are automatically
included in these values, too. So this will also work for you:</p>
</div>
<div class="listingblock">
<div class="title">Received text</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Today is "2017-12-24"</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the expected control text:</p>
</div>
<div class="listingblock">
<div class="title">Control text</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Today is "@variable('date')@"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in a new variable called <code>date</code> with value <code>2017-12-24</code>. In addition, the European date representation works fine
here, too because dots and dashes are automatically included:</p>
</div>
<div class="listingblock">
<div class="title">Received text</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Today is "24.12.2017"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="plaintext-validation-gzip"><a class="anchor" href="#plaintext-validation-gzip"></a><a class="link" href="#plaintext-validation-gzip">7.6.4. Gzip validation</a></h4>
<div class="paragraph">
<p>Gzip is a message compression library to optimize the message transport of large content. Citrus is able to handle
compressed message payloads on send and receive operations. Sending compressed data sets the message type to <strong>gzip</strong>.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">send("someEndpoint")
    .message()
    .type(MessageType.GZIP)
    .body("Hello World!")</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;send endpoint="someEndpoint"&gt;
    &lt;message type="gzip"&gt;
        &lt;data&gt;Hello World!&lt;/data&gt;
    &lt;/message&gt;
&lt;/send&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just use the <strong>type="gzip"</strong> message type in the send operation. Citrus now converts the message payload to a gzip binary
stream as payload.</p>
</div>
<div class="paragraph">
<p>When validating gzip binary message content the messages are compared with a given control message in binary base64 String
representation. The gzip binary data is automatically unzipped and encoded as base64 character sequence in order to compare
with an expected content.</p>
</div>
<div class="paragraph">
<p>The received message content is using gzip format but the actual message content does not have to be base64 encoded. Citrus
is doing this conversion automatically before validation takes place. The binary data can be anything e.g. images, pdf or
plaintext content.</p>
</div>
<div class="paragraph">
<p>The default message validator for gzip messages is active by default. Citrus will pick this message validator for all messages
of <strong>type="gzip_base64"</strong> . The default message validator implementation can be overwritten by placing a Spring bean with
id <strong>defaultGzipBinaryBase64MessageValidator</strong> to the Spring application context.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public GzipBinaryBase64MessageValidator defaultGzipBinaryBase64MessageValidator() {
    return new GzipBinaryBase64MessageValidator();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="defaultGzipBinaryBase64MessageValidator"
      class="org.citrusframework.validation.text.GzipBinaryBase64MessageValidator"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the test case receiving action we tell Citrus to use gzip message validation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .message()
    .type(MessageType.GZIP_BASE64)
    .body("citrus:encodeBase64('Hello World!')")</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
    &lt;message type="gzip_base64"&gt;
        &lt;data&gt;citrus:encodeBase64('Hello World!')&lt;/data&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the message format type <strong>type="gzip_base64"</strong> Citrus performs the gzip base64 character sequence validation. Incoming
message content is automatically unzipped and encoded as base64 String and compared to the expected data. This way we can
make sure that the binary content is as expected.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are using http client and server components the gzip compression support is built in with the underlying Spring
and http commons libraries. So in http communication you just have to set the header <strong>Accept-Encoding=gzip</strong> or <strong>Content-Encoding=gzip</strong>.
The message data is then automatically zipped/unzipped before Citrus gets the message data for validation. Read more about
this http specific gzip compression in <a href="#http-rest">chapter http</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="binary-message-validation"><a class="anchor" href="#binary-message-validation"></a><a class="link" href="#binary-message-validation">7.7. Binary validation</a></h3>
<div class="paragraph">
<p>Binary message validation is not an easy task in particular when it comes to compare data with a given control message.</p>
</div>
<div class="paragraph">
<p>Binary message validation is not enabled by default in your project. You need to add the validation module to your project
as a Maven dependency.</p>
</div>
<div class="listingblock">
<div class="title">Binary validation module dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-validation-binary&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are basically two ways in Citrus how to compare binary message content for validation purpose.</p>
</div>
<div class="sect3">
<h4 id="binary-stream-message-validation"><a class="anchor" href="#binary-stream-message-validation"></a><a class="link" href="#binary-stream-message-validation">7.7.1. Stream message validation</a></h4>
<div class="paragraph">
<p>A first approach to validate incoming binary message content is to compare the binary stream data with an expected stream.
This comparison is straight forward as each byte in the binary stream is compared to an expected stream.</p>
</div>
<div class="paragraph">
<p>The default message validator for binary messages is active by default. Citrus will pick this message validator for all
messages of <strong>type="binary_base64"</strong> . The default message validator implementation can be overwritten by placing a Spring
bean with id <strong>defaultBinaryBase64MessageValidator</strong> to the Spring application context.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public BinaryMessageValidator defaultBinaryMessageValidator() {
    return new BinaryMessageValidator();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="defaultBinaryMessageValidator" class="org.citrusframework.validation.text.BinaryMessageValidator"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the binary message type in a receive action in order to enable this stream comparison during validation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">.receive("someEndpoint")
    .message(new DefaultMessage(FileCopyUtils.copyToByteArray(new ClassPathResource("templates/foo.png").getFile())))
    .type(MessageType.BINARY);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
    &lt;message type="binary"&gt;
        &lt;resource file="classpath:templates/foo.png"/&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is very important to set the message type to <code>MessageType.BINARY</code> as this is the message type that is automatically handled
by the binary stream message validator.</p>
</div>
<div class="paragraph">
<p>By the way sending binary messages in Citrus is also very easy. Just use the <strong>type="binary"</strong> message type in the send
operation. Citrus now converts the message payload to a binary stream as payload.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">send("someEndpoint")
    .message()
    .type(MessageType.BINARY)
    .body("Hello World")</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;send endpoint="someEndpoint"&gt;
    &lt;message type="binary"&gt;
        &lt;data&gt;Hello World!&lt;/data&gt;
    &lt;/message&gt;
&lt;/send&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="binary-base64-message-validation"><a class="anchor" href="#binary-base64-message-validation"></a><a class="link" href="#binary-base64-message-validation">7.7.2. Base64 message validation</a></h4>
<div class="paragraph">
<p>Another way to validate binary message content is to use base64 String encoding. The binary data is encoded as base64
character sequence and therefore is comparable with an expected content.</p>
</div>
<div class="paragraph">
<p>The received message content does not have to be base64 encoded. Citrus is doing this conversion automatically before validation
takes place. The binary data can be anything e.g. images, pdf or gzip content.</p>
</div>
<div class="paragraph">
<p>The default message validator for binary messages is active by default. Citrus will pick this message validator for all
messages of <strong>type="binary_base64"</strong> . The default message validator implementation can be overwritten by placing a Spring
bean with id <strong>defaultBinaryBase64MessageValidator</strong> to the Spring application context.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public BinaryBase64MessageValidator defaultBinaryBase64MessageValidator() {
    return new BinaryBase64MessageValidator();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="defaultBinaryBase64MessageValidator" class="org.citrusframework.validation.text.BinaryBase64MessageValidator"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the test case receiving action we tell Citrus to use binary base64 message validation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .message()
    .body("citrus:encodeBase64('Hello World!')")</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
    &lt;message type="binary_base64"&gt;
        &lt;data&gt;citrus:encodeBase64('Hello World!')&lt;/data&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the message format type <strong>type="binary_base64"</strong> Citrus performs the base64 character sequence validation. Incoming
message content is automatically encoded as base64 String and compared to the expected data. This way we can make sure that
the binary content is as expected.</p>
</div>
<div class="paragraph">
<p>Base64 encoding is also supported in outbound messages. Just use the <strong>encodeBase64</strong> function in Citrus. The result is a
base64 encoded String as message payload.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">send("someEndpoint")
    .message()
    .body("citrus:encodeBase64('Hello World!')")</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;send endpoint="someEndpoint"&gt;
    &lt;message&gt;
        &lt;data&gt;citrus:encodeBase64('Hello World!')&lt;/data&gt;
    &lt;/message&gt;
&lt;/send&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="hamcrest-message-validation"><a class="anchor" href="#hamcrest-message-validation"></a><a class="link" href="#hamcrest-message-validation">7.8. Hamcrest validation</a></h3>
<div class="paragraph">
<p>Hamcrest validation empowers the validation capabilities by adding special assertions.</p>
</div>
<div class="paragraph">
<p>Hamcrest message validation capability is not enabled by default in your project. You need to add the validation module
to your project as a Maven dependency.</p>
</div>
<div class="listingblock">
<div class="title">Binary validation module dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-validation-hamcrest&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the Hamcrest assertions when receiving a message in order to validate elements, for instance with XPath.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .validate(validate().xpath()
        .expression("/TestRequest/Error", anyOf(empty(), nullValue()))
        .expression("number:/TestRequest/Status[.='success']", greaterThan(0.0))
        .expression("integer:/TestRequest/Status[.='failed']", lowerThan(1))
        .expression("node-set:/TestRequest/OrderType", hasSize(3));</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to match text containing any of the following characters: ' , ( )
You need to enclose the respective string in quotation marks when defining your matcher.
If you intend to match an actual single quote, it should be escaped with a backslash (\').
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">anyOf(equalTo('text containing a \\' (quote) and a , (comma)  '), anyOf(isEmptyOrNullString()))
anyOf(equalTo('text containing a backslash and quote \\\\' and a , (comma)  '), anyOf(isEmptyOrNullString()))</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
  &lt;message&gt;
    &lt;validate&gt;
      &lt;xpath expression="/TestRequest/Error" value="@assertThat(anyOf(empty(), nullValue()))@"/&gt;
      &lt;xpath expression="/TestRequest/Status[.='success']" value="@assertThat(greaterThan(0.0))@" result-type="number"/&gt;
      &lt;xpath expression="/TestRequest/Status[.='failed']" value="@assertThat(lowerThan(1))@" result-type="integer"/&gt;
      &lt;xpath expression="/TestRequest/OrderType" value="@assertThat(hasSize(3))@" result-type="node-set"/&gt;
    &lt;/validate&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="validation-custom"><a class="anchor" href="#validation-custom"></a><a class="link" href="#validation-custom">7.9. Custom validation</a></h3>
<div class="paragraph">
<p>In a previous section you have seen how to customize the global set of available message validators in a Citrus project using
the <a href="#message-validator-registry">validator registry</a>.</p>
</div>
<div class="sect3">
<h4 id="validation-custom-validator"><a class="anchor" href="#validation-custom-validator"></a><a class="link" href="#validation-custom-validator">7.9.1. Custom message validator</a></h4>
<div class="paragraph">
<p>You can also explicitly use a custom message validator in a receive test action. This approach skips the automatic message
validator resolving mechanism, and the receive action uses the defined validator implementation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .validator(groovyJsonMessageValidator)
    .message()
    .type(MessageType.JSON)
    .validate(groovy()
                .script("assert json.type == 'read'\n" +
                  "assert json.mbean == 'java.lang:type=Memory'\n" +
                  "assert json.attribute == 'HeapMemoryUsage'\n" +
                  "assert json.value == '${heapUsage}'");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
    &lt;message type="json" validator="groovyJsonMessageValidator"&gt;
        &lt;validate&gt;
            &lt;script type="groovy"&gt;
                &lt;![CDATA[
                  assert json.type == 'read'
                  assert json.mbean == 'java.lang:type=Memory'
                  assert json.attribute == 'HeapMemoryUsage'
                  assert json.value == '${heapUsage}'
                ]]&gt;
            &lt;/script&gt;
        &lt;/validate&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The receive action defines the message validator to use in this specific use case. You can set a custom message validator
implementation here.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Be careful when overwriting default message validation behavior. Setting a specific message validator has the effect
that your receive action may not use the other default validators. The explicit validator definition in a receive action
is exclusive so no further message validator resolving is performed on this receive action.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You may want to set multiple validators here in order to meet your validation requirements. For instance when setting a
<code>DomXmlMessageValidator</code> explicitly you may not be able to use the <code>XpathMessageValidator</code> capabilities on that specific
receive action anymore. Fortunately you can set multiple validators on a receive action that will all perform validation
tasks on the received message.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("someEndpoint")
    .validators(myXmlMessageValidator, defaultXpathMessageValidator)
    .message()
    .body("...")
    .validate(validate().xpath().expression("//some/xpath/expression", "someControlValue"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="someEndpoint"&gt;
    &lt;message type="json" validators="myXmlMessageValidator,defaultXpathMessageValidator"&gt;
        &lt;payload&gt;...&lt;/data&gt;
        &lt;validate path="//some/xpath/expression" value="someControlValue"/&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="validation-custom-processor"><a class="anchor" href="#validation-custom-processor"></a><a class="link" href="#validation-custom-processor">7.9.2. Validation processor</a></h4>
<div class="paragraph">
<p>The Java DSL offers some additional validation tricks and possibilities when dealing with messages that are sent and received
over Citrus. One of them is the validation processor functionality. With this feature you can marshal/unmarshal message payloads
and code validation steps on Java objects.</p>
</div>
<div class="listingblock">
<div class="title">Validation processor usage</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(bookResponseEndpoint)
    .validate(new XmlMarshallingValidationProcessor&lt;AddBookResponseMessage&gt;() {
        @Override
        public void validate(AddBookResponseMessage response, MessageHeaders headers) {
            Assert.isTrue(response.isSuccess());
        }
    });</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the validation processor needs some XML unmarshaller implementation for transforming the XML payload to a Java
object. Citrus will automatically search for the unmarshaller bean in your Spring application context if nothing specific
is set. Of course, you can also set the unmarshaller instance explicitly.</p>
</div>
<div class="listingblock">
<div class="title">Use autowired unmarshaller</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
private Unmarshaller unmarshaller;

@CitrusTest
public void receiveMessageTest() {
    receive(bookResponseEndpoint)
        .validate(new XmlMarshallingValidationProcessor&lt;AddBookResponseMessage&gt;(unmarshaller) {
            @Override
            public void validate(AddBookResponseMessage response, MessageHeaders headers) {
                Assert.isTrue(response.isSuccess());
            }
        });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Obviously working on Java objects is much more comfortable than using the XML String concatenation. This is why you can
also use this feature when sending messages.</p>
</div>
<div class="listingblock">
<div class="title">Message body marshalling</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
private Marshaller marshaller;

@CitrusTest
public void sendMessageTest() {
    send(bookRequestEndpoint)
        .message()
        .body(createAddBookRequestMessage("978-citrus:randomNumber(10)"), marshaller)
        .header(SoapMessageHeaders.SOAP_ACTION, "addBook");
}

private AddBookRequestMessage createAddBookRequestMessage(String isbn) {
    AddBookRequestMessage requestMessage = new AddBookRequestMessage();
    Book book = new Book();
    book.setAuthor("Foo");
    book.setTitle("FooTitle");
    book.setIsbn(isbn);
    book.setYear(2008);
    book.setRegistrationDate(Calendar.getInstance());
    requestMessage.setBook(book);
    return requestMessage;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above creates an <strong>AddBookRequestMessage</strong> object and puts this as payload to a send action. In combination with
a marshaller instance Citrus is able to create a proper XML message payload then.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="actions"><a class="anchor" href="#actions"></a><a class="link" href="#actions">8. Test actions</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter gives a brief description to all test actions that a tester can incorporate into the test case. Besides sending
and receiving messages the tester may access these actions in order to build a more complex test scenario that fits the desired use case.</p>
</div>
<div class="sect2">
<h3 id="actions-send"><a class="anchor" href="#actions-send"></a><a class="link" href="#actions-send">8.1. Send</a></h3>
<div class="paragraph">
<p>Integration test scenarios need to trigger business logic on foreign applications by calling service interfaces on the system
under test. The Citrus test is able to send messages over various message transports (e.g. Http REST, JMS, Kafka, filte transfer).</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/figure_001.jpg" alt="figure_001.jpg"></span></p>
</div>
<div class="paragraph">
<p>A message consists of a message header (name-value pairs) and a message body. Later in this section we will see different
ways of constructing a message with body and header values.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sendMessageTest() {
    variable("text", "Hello Citrus!");
    variable("messageId", "Mx1x123456789");

    $(send("helloService")
        .message()
        .name("helloMessage")
        .header("Operation", "sayHello")
        .header("RequestTag", "${messageId}")
        .body("""
            &lt;HelloMessage&gt;
                &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
            &lt;/HelloMessage&gt;
        """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ReceiveMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;variables&gt;
        &lt;variable name="text" value="Hello Citrus!"/&gt;
        &lt;variable name="messageId" value="Mx1x123456789"/&gt;
    &lt;/variables&gt;

    &lt;actions&gt;
        &lt;send endpoint="helloService"&gt;
            &lt;message name="helloMessage"&gt;
                &lt;headers&gt;
                    &lt;header name="Operation" value="sayHello"/&gt;
                    &lt;header name="MessageId" value="${messageId}"/&gt;
                &lt;/headers&gt;
                &lt;body&gt;
                    &lt;![CDATA[
                    &lt;HelloMessage&gt;
                        &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
                    &lt;/HelloMessage&gt;
                    ]]&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ReceiveMessageTest
variables:
    - name: "text"
      value: "Hello Citrus!"
    - name: "messageId"
      value: "Mx1x123456789"
actions:
  - send:
      endpoint: "helloService"
      message:
        name: "helloMessage"
        headers:
          - name: "Operation"
            value: "sayHello"
          - name: "MessageId"
            value: '${messageId}'
        body: |
          &lt;HelloMessage&gt;
              &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
          &lt;/HelloMessage&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="SendMessageTest"&gt;
        &lt;variables&gt;
            &lt;variable name="text" value="Hello Citrus!"/&gt;
            &lt;variable name="messageId" value="Mx1x123456789"/&gt;
        &lt;/variables&gt;

        &lt;actions&gt;
            &lt;send endpoint="helloService"&gt;
                &lt;message name="helloMessage"&gt;
                    &lt;payload&gt;
                        &lt;![CDATA[
                        &lt;HelloMessage&gt;
                            &lt;Text&gt;${text}&lt;/Text&gt;
                        &lt;/HelloMessage&gt;
                        ]]&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
                &lt;header&gt;
                    &lt;element name="Operation" value="sayHello"/&gt;
                    &lt;element name="MessageId" value="${messageId}"/&gt;
                &lt;/header&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message name is optional and defines the message identifier in the local message store. This message name is very useful
when accessing the message content later on during the test case. The local message store is handled per test case and contains
all exchanged messages.</p>
</div>
<div class="paragraph">
<p>The sample uses both header and payload as message parts to send. In both parts you can use variable definitions (see <strong>${text}</strong>
and <strong>${messageId}</strong>). So first of all let us recap what variables do. Test variables are defined at the very beginning of the
test case and are valid throughout all actions that take place in the test. This means that actions can simply reference a
variable by the expression <strong><em>${variable-name}</em></strong> .</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Use variables wherever you can! At least the important entities of a test should be defined as variables at the beginning.
The test case improves maintainability and flexibility when using variables.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s have a closer look at the sending action. The <strong>'endpoint'</strong> attribute might catch your attention first. This attribute
references a message endpoint in Citrus configuration by name. As previously mentioned the message endpoint definition lives
in a separate configuration file and contains the actual message transport settings. In this example the <strong>"helloService"</strong> is
referenced which is a message endpoint for sending out messages via JMS or HTTP for instance.</p>
</div>
<div class="paragraph">
<p>The test case is not aware of any transport details, because it does not have to. The advantages are obvious: On the one
hand multiple test cases can reference the message endpoint definition for better reuse. Secondly test cases are independent
of message transport details. So connection factories, user credentials, endpoint uri values and so on are not present in
the test case.</p>
</div>
<div class="paragraph">
<p>In other words the <strong>"endpoint"</strong> attribute of the <code>&lt;send&gt;</code> element specifies which message endpoint definition to use
and therefore where the message should go to. Once again all available message endpoints are configured in a separate Citrus
configuration file. We will come to this later on. Be sure to always pick the right message endpoint type in order to publish
your message to the right destination.</p>
</div>
<div class="paragraph">
<p>Now that the message sender pattern is clear we can concentrate on how to specify the message content to be sent. There are
several possibilities for you to define message content in Citrus:</p>
</div>
<div class="sect3">
<h4 id="send-message-body"><a class="anchor" href="#send-message-body"></a><a class="link" href="#send-message-body">8.1.1. Send message body</a></h4>
<div class="paragraph">
<p>The most important thing when dealing with sending actions is to prepare the message payload and header.
You can specify the body as nested String value.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sendMessageTest() {
    $(send("helloService")
        .message()
        .body("""
            &lt;HelloMessage&gt;
                &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
            &lt;/HelloMessage&gt;
        """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SendMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="helloService"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;![CDATA[
                    &lt;HelloMessage&gt;
                        &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
                    &lt;/HelloMessage&gt;
                    ]]&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SendMessageTest
actions:
  - send:
      endpoint: "helloService"
      message:
        body: |
          &lt;HelloMessage&gt;
              &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
          &lt;/HelloMessage&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="SendMessageTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="helloService"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;![CDATA[
                        &lt;HelloMessage&gt;
                            &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
                        &lt;/HelloMessage&gt;
                        ]]&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A simple way of defining the message body content is to provide the message body as a String.
You can do this in the different supported languages by embedding the message content in the body section of the <code>send</code> action.</p>
</div>
<div class="paragraph">
<p>In XML you can embed the content as a <code>CDATA</code> section and in Java, or YAML you may want to use text blocks.</p>
</div>
<div class="paragraph">
<p>When the message body content is an XML payload you can also use nested XML elements in the XML domain specific languages as the next example shows:</p>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ReceiveMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="helloService"&gt;
            &lt;message name="helloRequest"&gt;
                &lt;body&gt;
                    &lt;HelloMessage xmlns="http://sample.org/"&gt;
                        &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
                    &lt;/HelloMessage&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="ReceiveMessageTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="helloService"&gt;
              &lt;message&gt;
                &lt;payload&gt;
                  &lt;HelloMessage xmlns="http://sample.org/"&gt;
                      &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
                  &lt;/HelloMessage&gt;
                &lt;/payload&gt;
              &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In XML you can use nested XML elements or CDATA sections. Sometimes the nested XML message payload elements may cause
XSD schema violations. This is because of variable values not fitting the XSD schema rules for example.
In this scenario you could also use simple CDATA sections as payload data. In this case you need to use the <strong><em>`&lt;data&gt;`</em></strong>
element in contrast to the <strong><em>`&lt;payload&gt;`</em></strong> element that we have used in our examples so far.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With this alternative you can skip the XML schema validation from your IDE at design time. Unfortunately you will lose
the XSD auto-completion features many XML editors offer when constructing your payload.</p>
</div>
<div class="paragraph">
<p>Message body content may be quite huge, so you can also load the message content form an external file resource.
The file path is given as either a classpath or file system resource.</p>
</div>
<div class="paragraph">
<p>When writing tests in Java you can use one of the classpath or file system resource implementations to resolve the file path.
In XML and other languages you may use a resource path given as: <code>file=&quot;classpath:path/to/request.xml&quot;</code>.
The file path prefix indicates the file resource type (<code>file:</code> or <code>classpath:</code>), so the file location is resolved either as file system resource (<code>file:</code>)
or classpath resource (<code>classpath:</code>).</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sendMessageTest() {
    $(send("helloService")
        .message()
        .body(new ClassPathResource("path/to/request.xml"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SendMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="helloService"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;resource file="classpath:path/to/request.xml"/&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SendMessageTest
actions:
  - send:
      endpoint: "helloService"
      message:
        body:
          resource:
            file: "classpath:path/to/request.xml"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="SendMessageTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="helloService"&gt;
                &lt;message&gt;
                    &lt;resource file="classpath:path/to/request.xml" /&gt;
                &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to defining message payloads as normal Strings and via external file resource (classpath and file system) you can also
provide a POJO model object as a message payload.
The model object will be serialized with a marshaller or object mapper implementation which gets loaded from the Citrus context.</p>
</div>
<div class="paragraph">
<p>You can use the marshalling message payload builders in a <code>send</code> action as follows.</p>
</div>
<div class="listingblock">
<div class="title">Marshalling message payload builder</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">$(send("helloService")
    .message()
    .body(marshal(new TestRequest("Hello Citrus!")))
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>send</code> action uses the marshalling message builder provided with Citrus and just provides the model object <code>new TestRequest()</code>.
The marshalling message builder automatically loads a proper XML message marshaller that should be available as a bean in the project context (e.g. the
Spring application context). By default, Citrus is searching for a bean of type <strong>org.citrusframework.xml.Marshaller</strong>.
You can add the marshaller to your project context as a bean.</p>
</div>
<div class="listingblock">
<div class="title">Marshaller bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public Marshaller xmlMarshaller() {
    return new Jaxb2Marshaller();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now Citrus is able to automatically resolve the marshaller from the project context as soon as the <code>receive</code> action uses the model object in combination with the <code>marshal</code> instruction.</p>
</div>
<div class="paragraph">
<p>When you have multiple message marshaller instances in your project context you have to tell Citrus which one to use in this particular receive message action.</p>
</div>
<div class="listingblock">
<div class="title">Reference message marshaller</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">$(send("helloService")
    .message()
    .body(marshal(new TestRequest("Hello Citrus!"), "myMessageMarshallerBean"))
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now Citrus will marshal the message body with the message marshaller bean named <strong>myMessageMarshallerBean</strong>.
This way you can have multiple message marshaller implementations in your project (XML, JSON, and so on).</p>
</div>
<div class="paragraph">
<p>You can implement your own message payload builder or use one of the provided Citrus message payload builders.</p>
</div>
<div class="listingblock">
<div class="title">Custom message payload builder</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
private MessagePayloadBuilder mySpecialPayloadBuilder = new FooPayloadBuilder();

$(send("helloService")
    .message()
    .body(mySpecialPayloadBuilder)
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message payload builder must implement the <code>MessagePayloadBuilder</code> interface with the method <code>buildPayload(TestContext context)</code>.</p>
</div>
<div class="listingblock">
<div class="title">MessagePayloadBuilder interface</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class FooPayloadBuilder implements MessagePayloadBuilder {

    @Override
    public Object buildPayload(TestContext context) {
        // return some special payload
        return new FooModel();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use a Citrus message instance directly.
Citrus provides different message implementations with fluent APIs to
have a convenient way of setting properties (e.g. HttpMessage, MailMessage, FtpMessage, SoapMessage, &#8230;&#8203;).</p>
</div>
<div class="listingblock">
<div class="title">Citrus message object</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">$(send("helloService")
    .message(new DefaultMessage("Hello World!"))
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can explicitly overwrite some message values in the body before the validations is performed.
This is for overwriting specific message elements with variable values for instance.
Also, you can overwrite values using XPath (<a href="#xml-xpath-validation">xpath</a>) or
JsonPath (<a href="#json-path-validation">json-path</a>) expressions.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void jsonPathTest() {
    $(receive("someEndpoint")
        .message()
        .type(MessageType.JSON)
        .body(new ClassPathResource("path/to/request.xml"))
        .process(processor().jsonPath()
            .expression("$.user.name", "Penny")
            .expression("$['user']['name']", "${userName}"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="JsonPathTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="someEndpoint"&gt;
            &lt;message type="json"&gt;
                &lt;body&gt;
                    &lt;resource file="classpath:path/to/request.xml" /&gt;
                &lt;/body&gt;
                &lt;expression path="$.user.name" value="Penny"/&gt;
                &lt;expression path="$['user']['name']" value="${userName}"/&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: JsonPathTest
actions:
  - receive:
      endpoint: "someEndpoint"
      message:
        type: json
        resource:
          file: "classpath:path/to/request.xml"
        expression:
          - path: '$.user.name'
            value: "Penny"
          - path: '$["user"]["name"]'
            value: '${userName}'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="JsonPathTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="someEndpoint"&gt;
                &lt;message type="json"&gt;
                    &lt;resource file="classpath:path/to/request.xml" /&gt;
                    &lt;element path="$.user.name" value="Penny"/&gt;
                    &lt;element path="$['user']['name']" value="${userName}"/&gt;
                &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="send-message-headers"><a class="anchor" href="#send-message-headers"></a><a class="link" href="#send-message-headers">8.1.2. Send message headers</a></h4>
<div class="paragraph">
<p>Defining the message header is an essential part.
Citrus uses name-value pairs like "Operation" and "MessageId" in the
next example to set message header entries.</p>
</div>
<div class="paragraph">
<p>Depending on what message endpoint and which message transport underneath is used the header values will be shipped in different ways.
In JMS for instance the headers go to the header section of the message, in Http we set mime headers accordingly, in SOAP we can access the SOAP header elements and so on.
Citrus knows how to set headers on different message transports and aims to do the hard work for you .</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void messageHeaderTest() {
    $(send("helloService")
        .message()
        .header("Operation", "sayHello")
        .header("MessageId", "${messageId}")
        .body("""
            &lt;TestMessage xmlns="http://citrusframework.org/schema"&gt;
                &lt;Text&gt;Hello!&lt;/Text&gt;
            &lt;/TestMessage&gt;
        """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="MessageHeaderTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="someEndpoint"&gt;
            &lt;message&gt;
                &lt;headers&gt;
                    &lt;header name="Operation" value="sayHello"/&gt;
                &lt;/headers&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;TestMessage xmlns="http://citrusframework.org/schema"&gt;
                            &lt;Text&gt;Hello!&lt;/Text&gt;
                        &lt;/TestMessage&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: MessageHeaderTest
actions:
  - send:
      endpoint: "helloService"
      message:
        headers:
          - name: "Operation"
            value: "sayHello"
        body:
          data: |
            &lt;TestMessage xmlns="http://citrusframework.org/schema"&gt;
                &lt;Text&gt;Hello!&lt;/Text&gt;
            &lt;/TestMessage&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="MessageHeaderTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="helloService"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;TestMessage xmlns="http://citrusframework.org/schema"&gt;
                            &lt;Text&gt;Hello!&lt;/Text&gt;
                        &lt;/TestMessage&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
                &lt;header&gt;
                    &lt;element name="Operation" value="sayHello"/&gt;
                &lt;/header&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message headers to send are defined by a simple name and value pairs.
Of course you can use test variables in header values as well.</p>
</div>
<div class="paragraph">
<p>This is basically how to send messages in Citrus.
The test case is responsible for constructing the message content while the predefined message endpoint holds transport specific settings.
Test cases reference endpoint components to publish messages to the outside world.
The variable support in message payload and message header enables you to add dynamic values before sending out the message.</p>
</div>
</div>
<div class="sect3">
<h4 id="send-groovy-markupbuilder"><a class="anchor" href="#send-groovy-markupbuilder"></a><a class="link" href="#send-groovy-markupbuilder">8.1.3. Groovy Markup builder</a></h4>
<div class="paragraph">
<p>With the Groovy markup builder you can build XML message body content in a simple way, without having to write the typical XML overhead.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The Groovy test action support lives in a separate module.
You need to add the module to your project to use the functionality.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">citrus-groovy dependency module</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-groovy&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, we use a Groovy script to construct the XML message to be sent out.
Instead of a plain CDATA XML section or the nested body XML data we write a Groovy script snippet.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void scriptMessageBuilderTest() {
    $(send("helloService")
        .message()
        .body(new GroovyScriptPayloadBuilder("""
                    markupBuilder.TestRequest(xmlns: 'https://citrus.schemas/samples/sayHello.xsd') {
                        Message('Hello World!')
                    }
        """))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ScriptMessageBuilderTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="helloService"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;builder type="groovy"&gt;
                        markupBuilder.TestRequest(xmlns: 'https://citrus.schemas/samples/sayHello.xsd') {
                            Message('Hello World!')
                        }
                    &lt;/builder&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ScriptMessageBuilderTest
actions:
  - send:
      endpoint: "helloService"
      message:
        builder:
          type: "groovy"
          value: |
            markupBuilder.TestRequest(xmlns: 'https://citrus.schemas/samples/sayHello.xsd') {
                Message('Hello World!')
            }</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="ScriptMessageBuilderTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="helloService"&gt;
              &lt;message&gt;
                &lt;builder type="groovy"&gt;
                    markupBuilder.TestRequest(xmlns: 'https://citrus.schemas/samples/sayHello.xsd') {
                        Message('Hello World!')
                    }
                &lt;/builder&gt;
              &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Groovy markup builder generates the XML message body with following content:</p>
</div>
<div class="listingblock">
<div class="title">Genereted markup</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;TestRequest xmlns="https://citrus.schemas/samples/sayHello.xsd"&gt;
  &lt;Message&gt;Hello World&lt;/Message&gt;
&lt;/TestRequest&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We use the <strong>builder</strong> element with type <strong>groovy</strong> and the markup builder code is directly written to this element. As you can
see from the example above, you can mix XPath and Groovy markup builder code. The markup builder syntax is very easy and follows
the simple rule: <strong>markupBuilder.ROOT-ELEMENT{ CHILD-ELEMENTS }</strong> . However the tester has to follow some simple rules and naming
conventions when using the Citrus markup builder extension:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The markup builder is accessed within the script over an object named markupBuilder. The name of the custom root element follows with all its child elements.</p>
</li>
<li>
<p>Child elements may be defined within curly brackets after the root-element (the same applies for further nested child elements)</p>
</li>
<li>
<p>Attributes and element values are defined within round brackets, after the element name</p>
</li>
<li>
<p>Attribute and element values have to stand within apostrophes (e.g. attribute-name: 'attribute-value')</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Groovy markup builder script may also be used as external file resource:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void scriptMessageBuilderTest() {
    $(send("helloService")
        .message()
        .body(new GroovyFileResourcePayloadBuilder("classpath:path/to/helloRequest.groovy"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ScriptMessageBuilderTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="helloService"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;builder type="groovy" file="classpath:path/to/helloRequest.groovy"/&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ScriptMessageBuilderTest
actions:
  - send:
      endpoint: "helloService"
      message:
        builder:
          type: "groovy"
          file: "classpath:path/to/helloRequest.groovy"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="ScriptMessageBuilderTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="helloService"&gt;
              &lt;message&gt;
                &lt;builder type="groovy" file="classpath:path/to/helloRequest.groovy"/&gt;
              &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The markup builder implementation in Groovy offers great possibilities in defining message body content.
We do not need to write XML the tag overhead anymore.
The approach also enables us to construct complex message body content with Groovy script logic like iterations and conditional elements.
For detailed markup builder descriptions please see the official Groovy documentation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="actions-receive"><a class="anchor" href="#actions-receive"></a><a class="link" href="#actions-receive">8.2. Receive</a></h3>
<div class="paragraph">
<p>Receiving and validating messages is an essential part of an integration test. You can perform assertions and checks on incoming
messages in order to verify that everything works as expected.</p>
</div>
<div class="paragraph">
<p>A message consists of a message header (name-value pairs) and a message body. You can specify expected message content on a
receive message test action. Citrus will perform validation steps and raise errors in case the incoming message does not match these
expectations.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void receiveMessageTest() {
    $(receive("helloService")
        .message()
        .name("helloRequest")
        .header("Operation", "sayHello")
        .header("MessageId", "${messageId}")
        .body("""
            &lt;HelloMessage&gt;
                &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
            &lt;/HelloMessage&gt;
        """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ReceiveMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="helloService"&gt;
            &lt;message name="helloRequest"&gt;
                &lt;headers&gt;
                    &lt;header name="Operation" value="sayHello"/&gt;
                    &lt;header name="MessageId" value="${messageId}"/&gt;
                &lt;/headers&gt;
                &lt;body&gt;
                    &lt;![CDATA[
                    &lt;HelloMessage&gt;
                        &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
                    &lt;/HelloMessage&gt;
                    ]]&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ReceiveMessageTest
actions:
  - receive:
      endpoint: "helloService"
      message:
        name: "helloRequest"
        headers:
          - name: "Operation"
            value: "sayHello"
          - name: "MessageId"
            value: '${messageId}'
        body: |
          &lt;HelloMessage&gt;
              &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
          &lt;/HelloMessage&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="ReceiveMessageTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="helloService"&gt;
                &lt;message name="helloRequest"&gt;
                    &lt;payload&gt;
                        &lt;![CDATA[
                        &lt;HelloMessage&gt;
                            &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
                        &lt;/HelloMessage&gt;
                        ]]&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
                &lt;header&gt;
                    &lt;element name="Operation" value="sayHello"/&gt;
                    &lt;element name="MessageId" value="${messageId}"/&gt;
                &lt;/header&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message name is optional and defines the message identifier in the <a href="#local-message-store">local message store</a>. This
message name is very useful when accessing the message content later on during the test case. The local message store is
handled per test case and contains all exchanged messages.</p>
</div>
<div class="paragraph">
<p>The test action waits for a message to arrive. The whole test execution is blocked while waiting for the expected message.
This is important to ensure the step by step test workflow processing. Of course, you can specify a message timeout setting
so the receiver will only wait a given amount of time before raising a timeout error. Following from that timeout exception
the test case fails as the message did not arrive in time. Citrus defines default timeout settings for all message receiving tasks.</p>
</div>
<div class="paragraph">
<p>In case the message arrives in time, the test action moves on to validate the message content as a next step. The user is
able to choose from different validation capabilities. On the one hand you can specify a whole message body content that you
expect as control template. In this case the received message structure is compared to the expected message content element
by element. On the other hand you can use explicit element validation where only a small subset of message elements is validated.</p>
</div>
<div class="paragraph">
<p>In addition to verifying the message body content, Citrus will also perform validation on the received message header values.
Test variable usage is supported as usual during the whole validation process for body and header checks.</p>
</div>
<div class="paragraph">
<p>In general the validation component (validator) in Citrus works hand in hand with a message receiving component as the following
figure shows:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/figure_005.jpg" alt="figure_005.jpg"></span></p>
</div>
<div class="paragraph">
<p>The message receiving component passes the message to the validator where the individual validation steps are performed.
Let us have a closer look at the validation options and features step by step.</p>
</div>
<div class="sect3">
<h4 id="receive-message-body"><a class="anchor" href="#receive-message-body"></a><a class="link" href="#receive-message-body">8.2.1. Validate message body</a></h4>
<div class="paragraph">
<p>The most detailed validation of incoming messages is to define some expected message body.
The Citrus message validator will then perform a detailed message body comparison.
The incoming message has to match exactly to the expected message body.
The different message validator implementations in Citrus provide deep comparison of message structures such as XML, JSON and so on.</p>
</div>
<div class="paragraph">
<p>So by defining an expected message body we validate the incoming message in syntax and semantics.
In case a difference is identified by the message validator the validation and the test case fails with respective exceptions.
This is how you can define message body content in receive action:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void receiveMessageTest() {
    $(receive("helloService")
        .message()
        .body("""
            &lt;HelloMessage&gt;
                &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
            &lt;/HelloMessage&gt;
        """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ReceiveMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="helloService"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;![CDATA[
                    &lt;HelloMessage&gt;
                        &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
                    &lt;/HelloMessage&gt;
                    ]]&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ReceiveMessageTest
actions:
  - receive:
      endpoint: "helloService"
      message:
        body: |
          &lt;HelloMessage&gt;
              &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
          &lt;/HelloMessage&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="ReceiveMessageTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="helloService"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;![CDATA[
                        &lt;HelloMessage&gt;
                            &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
                        &lt;/HelloMessage&gt;
                        ]]&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A simple way of defining the expected message body content is to provide the message body as a String.
You can do this in the different supported languages by embedding the message content in the body section of the <code>receive</code> action.</p>
</div>
<div class="paragraph">
<p>In XML you can embed the content as a <code>CDATA</code> section and in Java, or YAML you may want to use text blocks.</p>
</div>
<div class="paragraph">
<p>When the message body content is an XML payload you can also use nested XML elements in the XML domain specific languages as the next example shows:</p>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ReceiveMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="helloService"&gt;
            &lt;message name="helloRequest"&gt;
                &lt;body&gt;
                    &lt;HelloMessage xmlns="http://sample.org/"&gt;
                        &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
                    &lt;/HelloMessage&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="ReceiveMessageTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="helloService"&gt;
              &lt;message&gt;
                &lt;payload&gt;
                  &lt;HelloMessage xmlns="http://sample.org/"&gt;
                      &lt;Text&gt;Hello Citrus!&lt;/Text&gt;
                  &lt;/HelloMessage&gt;
                &lt;/payload&gt;
              &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In XML you can use nested XML elements or CDATA sections. Sometimes the nested XML message payload elements may cause
XSD schema violations. This is because of variable values not fitting the XSD schema rules for example.
In this scenario you could also use simple CDATA sections as payload data. In this case you need to use the <strong><em>`&lt;data&gt;`</em></strong>
element in contrast to the <strong><em>`&lt;payload&gt;`</em></strong> element that we have used in our examples so far.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With this alternative you can skip the XML schema validation from your IDE at design time. Unfortunately you will lose
the XSD auto-completion features many XML editors offer when constructing your payload.</p>
</div>
<div class="paragraph">
<p>Message body content may be quite huge, so you can also load the message content form an external file resource.
The file path is given as either a classpath or file system resource.</p>
</div>
<div class="paragraph">
<p>When writing tests in Java you can use one of the classpath or file system resource implementations to resolve the file path.
In XML and other languages you may use a resource path given as: <code>file=&quot;classpath:path/to/request.xml&quot;</code>.
The file path prefix indicates the file resource type (<code>file:</code> or <code>classpath:</code>), so the file location is resolved either as file system resource (<code>file:</code>)
or classpath resource (<code>classpath:</code>).</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void receiveMessageTest() {
    $(receive("helloService")
        .message()
        .body(new ClassPathResource("path/to/request.xml"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ReceiveMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="helloService"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;resource file="classpath:path/to/request.xml"/&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ReceiveMessageTest
actions:
  - receive:
      endpoint: "helloService"
      message:
        body:
          resource:
            file: "classpath:path/to/request.xml"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="ReceiveMessageTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="helloService"&gt;
                &lt;message&gt;
                    &lt;resource file="classpath:path/to/request.xml" /&gt;
                &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to defining message payloads as normal Strings and via external file resource (classpath and file system) you can also
provide a POJO model object as a message payload.
The model object will be serialized with a marshaller or object mapper implementation which gets loaded from the Citrus context.</p>
</div>
<div class="paragraph">
<p>You can use the marshalling message payload builders in a <code>receive</code> action as follows.</p>
</div>
<div class="listingblock">
<div class="title">Marshalling message payload builder</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">$(receive("helloService")
    .message()
    .body(marshal(new TestRequest("Hello Citrus!")))
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>receive</code> action uses the marshalling message builder provided with Citrus and just provides the model object <code>new TestRequest()</code>.
The marshalling message builder automatically loads a proper XML message marshaller that should be available as a bean in the project context (e.g. the
Spring application context). By default, Citrus is searching for a bean of type <strong>org.citrusframework.xml.Marshaller</strong>.
You can add the marshaller to your project context as a bean.</p>
</div>
<div class="listingblock">
<div class="title">Marshaller bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public Marshaller xmlMarshaller() {
    return new Jaxb2Marshaller();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now Citrus is able to automatically resolve the marshaller from the project context as soon as the <code>receive</code> action uses the model object in combination with the <code>marshal</code> instruction.</p>
</div>
<div class="paragraph">
<p>When you have multiple message marshaller instances in your project context you have to tell Citrus which one to use in this particular receive message action.</p>
</div>
<div class="listingblock">
<div class="title">Reference message marshaller</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">$(receive("helloService")
    .message()
    .body(marshal(new TestRequest("Hello Citrus!"), "myMessageMarshallerBean"))
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now Citrus will marshal the message body with the message marshaller bean named <strong>myMessageMarshallerBean</strong>.
This way you can have multiple message marshaller implementations in your project (XML, JSON, and so on).</p>
</div>
<div class="paragraph">
<p>You can implement your own message payload builder or use one of the provided Citrus message payload builders.</p>
</div>
<div class="listingblock">
<div class="title">Custom message payload builder</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
private MessagePayloadBuilder mySpecialPayloadBuilder = new FooPayloadBuilder();

$(receive("helloService")
    .message()
    .body(mySpecialPayloadBuilder)
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message payload builder must implement the <code>MessagePayloadBuilder</code> interface with the method <code>buildPayload(TestContext context)</code>.</p>
</div>
<div class="listingblock">
<div class="title">MessagePayloadBuilder interface</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class FooPayloadBuilder implements MessagePayloadBuilder {

    @Override
    public Object buildPayload(TestContext context) {
        // return some special payload
        return new FooModel();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use a Citrus message instance directly.
Citrus provides different message implementations with fluent APIs to
have a convenient way of setting properties (e.g. HttpMessage, MailMessage, FtpMessage, SoapMessage, &#8230;&#8203;).</p>
</div>
<div class="listingblock">
<div class="title">Citrus message object</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">$(receive("helloService")
    .message(new DefaultMessage("Hello World!"))
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can explicitly overwrite some message values in the body before the validations is performed.
This is for overwriting specific message elements with variable values for instance.
Also, you can overwrite values using XPath (<a href="#xml-xpath-validation">xpath</a>) or
JsonPath (<a href="#json-path-validation">json-path</a>) expressions.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void jsonPathTest() {
    $(receive("someEndpoint")
        .message()
        .type(MessageType.JSON)
        .body(new ClassPathResource("path/to/request.xml"))
        .validate(validate().jsonPath()
            .expression("$.user.name", "Penny")
            .expression("$['user']['name']", "${userName}"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="JsonPathTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="someEndpoint"&gt;
            &lt;message type="json"&gt;
                &lt;body&gt;
                    &lt;resource file="classpath:path/to/request.xml" /&gt;
                &lt;/body&gt;
            &lt;/message&gt;
            &lt;validate path="$.user.name" value="Penny"/&gt;
            &lt;validate path="$['user']['name']" value="${userName}"/&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: JsonPathTest
actions:
  - receive:
      endpoint: "someEndpoint"
      message:
        type: json
        resource:
          file: "classpath:path/to/request.xml"
        validate:
          jsonPath:
            - expression: '$.user.name'
              value: "Penny"
            - expression: '$["user"]["name"]'
              value: '${userName}'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="JsonPathTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="someEndpoint"&gt;
                &lt;message type="json"&gt;
                    &lt;resource file="classpath:path/to/request.xml" /&gt;
                    &lt;validate path="$.user.name" value="Penny"/&gt;
                    &lt;validate path="$['user']['name']" value="${userName}"/&gt;
                &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to that you can ignore some elements that are skipped in comparison. We will describe this later on in this section.
Now let&#8217;s continue with message header validation.</p>
</div>
</div>
<div class="sect3">
<h4 id="receive-message-headers"><a class="anchor" href="#receive-message-headers"></a><a class="link" href="#receive-message-headers">8.2.2. Validate message headers</a></h4>
<div class="paragraph">
<p>Message headers are used widely in enterprise messaging.
The message headers often represent a critical part of the message semantics and need to be validated, too.
Citrus is able to validate message headers by name and value.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void messageHeaderTest() {
    $(receive("helloService")
        .message()
        .header("Operation", "sayHello")
        .body("""
            &lt;TestMessage xmlns="http://citrusframework.org/schema"&gt;
                &lt;Text&gt;Hello!&lt;/Text&gt;
            &lt;/TestMessage&gt;
        """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="MessageHeaderTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="someEndpoint"&gt;
            &lt;message&gt;
                &lt;headers&gt;
                    &lt;header name="Operation" value="sayHello"/&gt;
                &lt;/headers&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;TestMessage xmlns="http://citrusframework.org/schema"&gt;
                            &lt;Text&gt;Hello!&lt;/Text&gt;
                        &lt;/TestMessage&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: MessageHeaderTest
actions:
  - receive:
      endpoint: "helloService"
      message:
        headers:
          - name: "Operation"
            value: "sayHello"
        body:
          data: |
            &lt;TestMessage xmlns="http://citrusframework.org/schema"&gt;
                &lt;Text&gt;Hello!&lt;/Text&gt;
            &lt;/TestMessage&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="MessageHeaderTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="helloService"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;TestMessage xmlns="http://citrusframework.org/schema"&gt;
                            &lt;Text&gt;Hello!&lt;/Text&gt;
                        &lt;/TestMessage&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
                &lt;header&gt;
                    &lt;element name="Operation" value="sayHello"/&gt;
                &lt;/header&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The expected message headers are defined by a name and value pair.
Citrus will check that the expected message header is present and will verify the value accordingly.
In case the message header is not found or the value does not match Citrus will raise
an exception and the test fails.
You can use validation matchers (<a href="#validation-matcher">validation-matcher</a>) for a more powerful validation of header values, too.</p>
</div>
<div class="paragraph">
<p>Header definition in Java DSL is straight forward as we just define name and value as usual.
This completes tha basic message validation in Citrus.
The individual message validator implementations may add additional validation capabilities such as XML schema validation or XPath and JSONPath validation. Please refer to the respective chapters in this guide to learn more about that.</p>
</div>
</div>
<div class="sect3">
<h4 id="receive-message-ignore"><a class="anchor" href="#receive-message-ignore"></a><a class="link" href="#receive-message-ignore">8.2.3. Ignore elements</a></h4>
<div class="paragraph">
<p>Sometimes a tester can not verify all values because specifying expected values is not possible for non deterministic values
(e.g. timestamps, dynamic and generated identifiers).</p>
</div>
<div class="paragraph">
<p>You can use a path expressions (e.g. Xpath, JsonPath) to ignoring a very specific entry in the message body.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void ignorePathTest() {
    $(receive(someEndpoint)
        .message()
        .type(MessageType.JSON)
        .body("""
            {
              "users":
              [{
                "name": "Jane",
                "token": "?",
                "lastLogin": 0
              },
              {
                "name": "Penny",
                "token": "?",
                "lastLogin": 0
              },
              {
                "name": "Mary",
                "token": "?",
                "lastLogin": 0
              }]
            }
        """)
        .validate(validate().json()
                    .ignore("$.users[*].token")
                    .ignore("$..lastLogin"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="IgnorePathTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="someEndpoint"&gt;
            &lt;message type="json"&gt;
                &lt;body&gt;
                    &lt;data&gt;
                    {
                      "users":
                      [{
                        "name": "Jane",
                        "token": "?",
                        "lastLogin": 0
                      },
                      {
                        "name": "Penny",
                        "token": "?",
                        "lastLogin": 0
                      },
                      {
                        "name": "Mary",
                        "token": "?",
                        "lastLogin": 0
                      }]
                    }
                    &lt;/data&gt;
                &lt;/body&gt;
            &lt;/message&gt;
            &lt;ignore path="$..lastLogin" /&gt;
            &lt;ignore path="$.users[*].token" /&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: IgnorePathTest
actions:
  - receive:
      endpoint: "someEndpoint"
      message:
        type: "json"
        body:
          data: |
            {
              "users":
              [{
                "name": "Jane",
                "token": "?",
                "lastLogin": 0
              },
              {
                "name": "Penny",
                "token": "?",
                "lastLogin": 0
              },
              {
                "name": "Mary",
                "token": "?",
                "lastLogin": 0
              }]
            }
          ignore:
            - path: "$.users[*].token"
            - path: "$..lastLogin"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="IgnorePathTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="someEndpoint"&gt;
                &lt;message type="json"&gt;
                    &lt;data&gt;
                    {
                      "users":
                      [{
                        "name": "Jane",
                        "token": "?",
                        "lastLogin": 0
                      },
                      {
                        "name": "Penny",
                        "token": "?",
                        "lastLogin": 0
                      },
                      {
                        "name": "Mary",
                        "token": "?",
                        "lastLogin": 0
                      }]
                    }
                    &lt;/data&gt;
                    &lt;ignore path="$.users[*].token" /&gt;
                    &lt;ignore path="$..lastLogin" /&gt;
                &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sample above adds JsonPath expressions as ignore statements. This means that we explicitly leave out the evaluated elements
from validation. In the example above we explicitly skip the <strong>token</strong> entry and all <strong>lastLogin</strong> values that are obviously
timestamp values in milliseconds.</p>
</div>
<div class="paragraph">
<p>The path evaluation is very powerful when it comes to select a set of objects and elements. This is how you can ignore
several elements with path expressions.</p>
</div>
<div class="paragraph">
<p>As an alternative you can also use the <code>@ignore@</code> placeholder in the message content. The placeholder tells Citrus to skip the element in validation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void ignorePathTest() {
    $(receive(someEndpoint)
        .message()
        .type(MessageType.JSON)
        .body("""
            {
              "users":
              [{
                "name": "Jane",
                "token": "@ignore@",
                "lastLogin": "@ignore@"
              },
              {
                "name": "Penny",
                "token": "@ignore@",
                "lastLogin": "@ignore@"
              },
              {
                "name": "Mary",
                "token": "@ignore@",
                "lastLogin": "@ignore@"
              }]
            }
        """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="IgnorePathTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="someEndpoint"&gt;
            &lt;message type="json"&gt;
                &lt;body&gt;
                    &lt;data&gt;
                    {
                      "users":
                      [{
                        "name": "Jane",
                        "token": "@ignore@",
                        "lastLogin": "@ignore@"
                      },
                      {
                        "name": "Penny",
                        "token": "@ignore@",
                        "lastLogin": "@ignore@"
                      },
                      {
                        "name": "Mary",
                        "token": "@ignore@",
                        "lastLogin": "@ignore@"
                      }]
                    }
                    &lt;/data&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: IgnorePathTest
actions:
  - receive:
      endpoint: "someEndpoint"
      message:
        type: "json"
        body:
          data: |
            {
              "users":
              [{
                "name": "Jane",
                "token": "@ignore@",
                "lastLogin": "@ignore@"
              },
              {
                "name": "Penny",
                "token": "@ignore@",
                "lastLogin": "@ignore@"
              },
              {
                "name": "Mary",
                "token": "@ignore@",
                "lastLogin": "@ignore@"
              }]
            }</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="IgnorePathTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="someEndpoint"&gt;
                &lt;message type="json"&gt;
                  &lt;data&gt;
                    {
                      "users":
                      [{
                        "name": "Jane",
                        "token": "@ignore@",
                        "lastLogin": "@ignore@"
                      },
                      {
                        "name": "Penny",
                        "token": "@ignore@",
                        "lastLogin": "@ignore@"
                      },
                      {
                        "name": "Mary",
                        "token": "@ignore@",
                        "lastLogin": "@ignore@"
                      }]
                    }
                  &lt;/data&gt;
                &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can also ignore a whole sub-tree in XML and whole objects and arrays in Json with the ignore expression/placeholder.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <code>ignore</code> expression as well as the <code>@ignore@</code> placeholder will only skip the value matching validations for the selected element or object.
The element still has to be present in the message structure. In case the element is missing for any reason the validation fails even for ignored values.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="receive-message-selectors"><a class="anchor" href="#receive-message-selectors"></a><a class="link" href="#receive-message-selectors">8.2.4. Message selectors</a></h4>
<div class="paragraph">
<p>The <code>&lt;selector&gt;</code> element inside the receiving action defines key-value pairs in order to filter the messages being received.
The filter applies to the message headers.
This means that a receiver will only accept messages matching a header element value.
In messaging applications the header information often holds message ids, correlation ids, operation names and so on.
With this information given you can explicitly listen for messages that belong to your test case.
This is very helpful to avoid receiving messages that are still available on the message destination.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s say the tested software application keeps sending messages that belong to previous test cases. This could happen in
retry situations where the application error handling automatically tries to solve a communication problem that occurred
during previous test cases. As a result a message destination (e.g. a JMS message queue) contains messages that are not
valid anymore for the currently running test case. The test case might fail because the received message does not apply
to the actual use case. So we will definitely run into validation errors as the expected message control values do not match.</p>
</div>
<div class="paragraph">
<p>Now we have to find a way to avoid these problems. The test could filter the messages on a destination to only receive messages
that apply for the use case that is being tested. The Java Messaging System (JMS) came up with a message header selector that
will only accept messages that fit the expected header values.</p>
</div>
<div class="paragraph">
<p>Let us have a closer look at a message selector inside a receiving action:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void selectorTest() {
    Map&lt;String, String&gt; selectorMap = new HashMap&lt;&gt;();
    selectorMap.put("correlationId", "Cx1x123456789");
    selectorMap.put("operation", "getOrders");

    $(receive(someEndpoint)
        .selector(selectorMap)
        .message()
        .body("...")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SelectorTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="someEndpoint"&gt;
            &lt;selector&gt;
                &lt;element name="correlationId" value="Cx1x123456789"/&gt;
                &lt;element name="operation" value="getOrders"/&gt;
            &lt;/selector&gt;
            &lt;message&gt;
                &lt;!-- --&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SelectorTest
actions:
  - receive:
      endpoint: "someEndpoint"
      selector:
        element:
          - name: correlationId
            value: "Cx1x123456789"
          - name: operation
            value: "getOrders"
      message:
        # ...</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="SelectorTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="someEndpoint"&gt;
              &lt;selector&gt;
                &lt;element name="correlationId" value="Cx1x123456789"/&gt;
                &lt;element name="operation" value="getOrders"/&gt;
              &lt;/selector&gt;
              &lt;!-- ... --&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example shows how message selectors work. The selector will only accept messages that meet the correlation id and the
operation in the header values. All other messages on the message destination are ignored. The selector elements are automatically
associated to each other using the logical AND operator. This means that the message selector string would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>correlationId = 'Cx1x123456789' AND operation = 'getOrders'</pre>
</div>
</div>
<div class="paragraph">
<p>Instead of using several elements in the selector you can also define a selector string directly which gives you more power
in constructing the selection logic yourself. This way you can use <strong>AND</strong> logical operators yourself.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void selectorTest() {
    $(receive(someEndpoint)
        .selector("correlationId = 'Cx1x123456789' AND operation = 'getOrders'")
        .message()
        .body("...")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SelectorTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="someEndpoint"&gt;
            &lt;selector&gt;
                &lt;value&gt;
                    correlationId = 'Cx1x123456789' AND operation = 'getOrders'
                &lt;/value&gt;
            &lt;/selector&gt;
            &lt;message&gt;
                &lt;!-- --&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SelectorTest
actions:
  - receive:
      endpoint: "someEndpoint"
      selector:
        value: "correlationId = 'Cx1x123456789' AND operation = 'getOrders'"
      message:
        # ...</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="SelectorTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="someEndpoint"&gt;
              &lt;selector&gt;
                &lt;value&gt;
                    correlationId = 'Cx1x123456789' AND operation = 'getOrders'
                &lt;/value&gt;
              &lt;/selector&gt;
              &lt;!-- ... --&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
In case you want to run tests in parallel message selectors become essential in your test cases. The different
tests running at the same time will steal messages from each other when you lack of message selection mechanisms.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="receive-groovy-markupbuilder"><a class="anchor" href="#receive-groovy-markupbuilder"></a><a class="link" href="#receive-groovy-markupbuilder">8.2.5. Groovy Markup builder</a></h4>
<div class="paragraph">
<p>With the Groovy markup builder you can build XML message body content in a simple way, without having to write the typical XML overhead.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The Groovy test action support lives in a separate module.
You need to add the module to your project to use the functionality.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">citrus-groovy dependency module</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-groovy&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, we use a Groovy script to construct the XML message to be sent out.
Instead of a plain CDATA XML section or the nested body XML data we write a Groovy script snippet.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void scriptMessageBuilderTest() {
    $(receive("helloService")
        .message()
        .body(new GroovyScriptPayloadBuilder("""
                    markupBuilder.TestRequest(xmlns: 'https://citrus.schemas/samples/sayHello.xsd') {
                        Message('Hello World!')
                    }
        """))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ScriptMessageBuilderTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="helloService"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;builder type="groovy"&gt;
                        markupBuilder.TestRequest(xmlns: 'https://citrus.schemas/samples/sayHello.xsd') {
                            Message('Hello World!')
                        }
                    &lt;/builder&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ScriptMessageBuilderTest
actions:
  - receive:
      endpoint: "helloService"
      message:
        builder:
          type: "groovy"
          value: |
            markupBuilder.TestRequest(xmlns: 'https://citrus.schemas/samples/sayHello.xsd') {
                Message('Hello World!')
            }</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="ScriptMessageBuilderTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="helloService"&gt;
              &lt;message&gt;
                &lt;builder type="groovy"&gt;
                    markupBuilder.TestRequest(xmlns: 'https://citrus.schemas/samples/sayHello.xsd') {
                        Message('Hello World!')
                    }
                &lt;/builder&gt;
              &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Groovy markup builder generates the XML message body with following content:</p>
</div>
<div class="listingblock">
<div class="title">Generated markup</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;TestRequest xmlns="https://citrus.schemas/samples/sayHello.xsd"&gt;
  &lt;Message&gt;Hello World&lt;/Message&gt;
&lt;/TestRequest&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We use the <strong>builder</strong> element with type <strong>groovy</strong> and the markup builder code is directly written to this element. As you can
see from the example above, you can mix XPath and Groovy markup builder code. The markup builder syntax is very easy and follows
the simple rule: <strong>markupBuilder.ROOT-ELEMENT{ CHILD-ELEMENTS }</strong> . However the tester has to follow some simple rules and naming
conventions when using the Citrus markup builder extension:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The markup builder is accessed within the script over an object named markupBuilder. The name of the custom root element follows with all its child elements.</p>
</li>
<li>
<p>Child elements may be defined within curly brackets after the root-element (the same applies for further nested child elements)</p>
</li>
<li>
<p>Attributes and element values are defined within round brackets, after the element name</p>
</li>
<li>
<p>Attribute and element values have to stand within apostrophes (e.g. attribute-name: 'attribute-value')</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Groovy markup builder script may also be used as external file resource:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void scriptMessageBuilderTest() {
    $(receive("helloService")
        .message()
        .body(new GroovyFileResourcePayloadBuilder("classpath:path/to/helloRequest.groovy"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ScriptMessageBuilderTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="helloService"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;builder type="groovy" file="classpath:path/to/helloRequest.groovy"/&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ScriptMessageBuilderTest
actions:
  - receive:
      endpoint: "helloService"
      message:
        builder:
          type: "groovy"
          file: "classpath:path/to/helloRequest.groovy"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="ScriptMessageBuilderTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="helloService"&gt;
              &lt;message&gt;
                &lt;builder type="groovy" file="classpath:path/to/helloRequest.groovy"/&gt;
              &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The markup builder implementation in Groovy offers great possibilities in defining message body content.
We do not need to write XML the tag overhead anymore.
The approach also enables us to construct complex message body content with Groovy script logic like iterations and conditional elements.
For detailed markup builder descriptions please see the official Groovy documentation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="actions-sql"><a class="anchor" href="#actions-sql"></a><a class="link" href="#actions-sql">8.3. SQL</a></h3>
<div class="paragraph">
<p>In many cases it is necessary to access the database during a test. This enables a tester to also validate the persistent
data in a database. It might also be helpful to prepare the database with some test data before running a test. You can do this
using the two database actions that are described in the following sections.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The SQL test actions live in a separate module.
You need to add the module to your project to use the actions.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">citrus-sql dependency module</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-sql&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In general Citrus handles SELECT statements differently to other statements like INSERT, UPDATE and DELETE. When executing an SQL query with
SELECT you are able to add validation steps on the result sets returned from the database. This is not allowed when executing update statements like
INSERT, UPDATE, DELETE.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Do not mix statements of type <strong><em>SELECT</em></strong> with others in a single sql test action. This will lead to errors because validation steps are not valid
for statements other than SELECT. Please use separate test actions for update statements.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="sql-update-insert-delete"><a class="anchor" href="#sql-update-insert-delete"></a><a class="link" href="#sql-update-insert-delete">8.3.1. SQL update, insert, delete</a></h4>
<div class="paragraph">
<p>The &lt;sql&gt; action simply executes a group of SQL statements in order to change data in a database. Typically the action is used to prepare the database at the beginning of a test or to clean up the database at the end of a test. You can specify SQL statements like INSERT, UPDATE, DELETE, CREATE TABLE, ALTER TABLE and many more.</p>
</div>
<div class="paragraph">
<p>On the one hand you can specify the statements as inline SQL or stored in an external SQL resource file as shown in the next two examples.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
@Qualifier("myDataSource")
private DataSource dataSource;

@CitrusTest
public void sqlTest() {
    $(sql()
        .dataSource(dataSource)
        .statement("DELETE FROM CUSTOMERS")
        .statement("DELETE FROM ORDERS"))
    );

    $(sql()
        .dataSource(dataSource)
        .sqlResource("file:tests/unit/resources/script.sql"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SQLTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;sql datasource="myDataSource"&gt;
            &lt;statements&gt;
                &lt;statement&gt;DELETE FROM CUSTOMERS&lt;/statement&gt;
                &lt;statement&gt;DELETE FROM ORDERS&lt;/statement&gt;
            &lt;/statements&gt;
        &lt;/sql&gt;

        &lt;sql datasource="myDataSource"&gt;
            &lt;statements file="file:tests/unit/resources/script.sql"/&gt;
        &lt;/sql&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "SQLTest"
actions:
  - sql:
      dataSource: "myDataSource"
      statements:
        - statement: "DELETE FROM CUSTOMERS"
        - statement: "DELETE FROM ORDERS"

  - sql:
      dataSource: "myDataSource"
      statements:
        - file: "file:tests/unit/resources/script.sql"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="SQLTest"&gt;
        &lt;actions&gt;
            &lt;sql datasource="myDataSource"&gt;
                &lt;statement&gt;DELETE FROM CUSTOMERS&lt;/statement&gt;
                &lt;statement&gt;DELETE FROM ORDERS&lt;/statement&gt;
            &lt;/sql&gt;

            &lt;sql datasource="myDataSource"&gt;
                &lt;resource file="file:tests/unit/resources/script.sql"/&gt;
            &lt;/sql&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first action uses inline SQL statements defined directly inside the test case. The next action uses an external SQL resource file instead. The file resource can hold several SQL statements separated by new lines. All statements inside the file are executed sequentially by the framework.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You have to pay attention to some rules when dealing with external SQL resources.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Each statement should begin in a new line</p>
</li>
<li>
<p>It is not allowed to define statements with word wrapping</p>
</li>
<li>
<p>Comments begin with two dashes "–"</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The external file is referenced either as file system resource or class path resource, by using the "file:" or "classpath:" prefix.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Both examples use the "datasource" attribute. This value defines the database data source to be used. The connection to a data source is mandatory, because the test case does not know about user credentials or database names. The 'datasource' attribute references predefined data sources that are located in a separate Spring configuration file.</p>
</div>
</div>
<div class="sect3">
<h4 id="sql-query"><a class="anchor" href="#sql-query"></a><a class="link" href="#sql-query">8.3.2. SQL query</a></h4>
<div class="paragraph">
<p>The &lt;sql&gt; query action is specially designed to execute SQL queries (SELECT * FROM). So the test is able to read data from a database. The query results are validated against expected data as shown in the next example.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
@Qualifier("myDataSource")
private DataSource dataSource;

@CitrusTest
public void sqlQueryTest() {
    $(sql()
        .dataSource(dataSource)
        .query()
            .statement("select NAME from CUSTOMERS where CUSTOMER_ID='${customerId}'")
            .statement("select COUNT(1) as overall_cnt from ERRORS")
            .statement("select ORDER_ID from ORDERS where DESCRIPTION LIKE 'Migrate%'")
            .statement("select DESCRIPTION from ORDERS where ORDER_ID = 2")
        .validate("ORDER_ID", "1")
        .validate("NAME", "Christoph")
        .validate("OVERALL_CNT", "${rowsCount}")
        .validate("DESCRIPTION", "NULL"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SqlQueryTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;sql datasource="myDataSource"&gt;
            &lt;statements&gt;
                &lt;statement&gt;select NAME from CUSTOMERS where ID='${customerId}'&lt;/statement&gt;
                &lt;statement&gt;select count(*) from ERRORS&lt;/statement&gt;
                &lt;statement&gt;select ID from ORDERS where DESC LIKE 'Def%'&lt;/statement&gt;
                &lt;statement&gt;select DESCRIPTION from ORDERS where ID='${id}'&lt;/statement&gt;
            &lt;/statements&gt;
            &lt;validate column="ID" value="1"/&gt;
            &lt;validate column="NAME" value="Christoph"/&gt;
            &lt;validate column="COUNT(*)" value="${rowsCount}"/&gt;
            &lt;validate column="DESCRIPTION" value="null"/&gt;
        &lt;/sql&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "SqlQueryTest"
actions:
  - sql:
      dataSource: "dataSource"
      statements:
        - statement: "select NAME from CUSTOMERS where CUSTOMER_ID='${customerId}'"
        - statement: "select COUNT(1) as overall_cnt from ERRORS"
        - statement: "select ORDER_ID from ORDERS where DESCRIPTION LIKE 'Migrate%'"
        - statement: "select DESCRIPTION from ORDERS where ORDER_ID = 2"
      validate:
        - column: "ID"
          value: "1"
        - column: "NAME"
          value: "Christoph"
        - column: "COUNT(*)"
          value: '${rowsCount}'
        - column: "DESCRIPTION"
          value: "null"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- ... --&gt;
    &lt;sql datasource="myDataSource"&gt;
        &lt;statement&gt;select NAME from CUSTOMERS where ID='${customerId}'&lt;/statement&gt;
        &lt;statement&gt;select count(*) from ERRORS&lt;/statement&gt;
        &lt;statement&gt;select ID from ORDERS where DESC LIKE 'Def%'&lt;/statement&gt;
        &lt;statement&gt;select DESCRIPTION from ORDERS where ID='${id}'&lt;/statement&gt;

        &lt;validate column="ID" value="1"/&gt;
        &lt;validate column="NAME" value="Christoph"/&gt;
        &lt;validate column="COUNT(*)" value="${rowsCount}"/&gt;
        &lt;validate column="DESCRIPTION" value="null"/&gt;
    &lt;/sql&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The action offers a wide range of validating functionality for database result sets. First of all you have to select the data via SQL statements. Here again you have the choice to use inline SQL statements or external file resource pattern.</p>
</div>
<div class="paragraph">
<p>The result sets are validated through &lt;validate&gt; elements. It is possible to do a detailed check on every selected column of the result set. Simply refer to the selected column name in order to validate its value. The usage of test variables is supported as well as database expressions like count(), avg(), min(), max().</p>
</div>
<div class="paragraph">
<p>You simply define the &lt;validate&gt; entry with the column name as the "column" attribute and any expected value expression as expected "value". The framework then will check the column to fit the expected value and raise validation errors in case of mismatch.</p>
</div>
<div class="paragraph">
<p>Looking at the first SELECT statement in the example you will see that test variables are supported in the SQL statements. The framework will replace the variable with its respective value before sending it to the database.</p>
</div>
<div class="paragraph">
<p>In the validation section variables can be used too. Look at the third validation entry, where the variable "${rowsCount}" is used. The last validation in this example shows, that <strong><em>NULL</em></strong> values are also supported as expected values.</p>
</div>
<div class="paragraph">
<p>If a single validation happens to fail, the whole action will fail with respective validation errors.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The validation with <strong><em>"&lt;validate column="&#8230;&#8203;" value="&#8230;&#8203;"/&gt;"</em></strong> meets single row result sets as you specify a single column control value. In case you have multiple rows in a result set you can pass a variable argument list to the validate method like this:
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">$(sql()
    .query()
    .statement("...")
    .validate("SOME_COLUMN",
        "Value in 1st row",
        "Value in 2nd row",
        "Value in 3rd row",
        "Value in x row")
);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;sql datasource="myDataSource"&gt;
    &lt;statements&gt;
        &lt;statement&gt;...&lt;/statement&gt;
    &lt;/statement&gt;
    &lt;validate column="SOME_COLUMN"&gt;
      &lt;values&gt;
          &lt;value&gt;Value in 1st row&lt;/value&gt;
          &lt;value&gt;Value in 2nd row&lt;/value&gt;
          &lt;value&gt;Value in 3rd row&lt;/value&gt;
          &lt;value&gt;Value in x row&lt;/value&gt;
      &lt;/values&gt;
    &lt;/validate&gt;
&lt;/sql&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- sql:
  dataSource: myDataSource
  statements:
    - statement: {}
  validate:
    - column: "SOME_COLUMN"
      values:
        - "Value in 1st row"
        - "Value in 2nd row"
        - "Value in 3rd row"
        - "Value in x row"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;sql dataSource="myDataSource"&gt;
    &lt;statement&gt;...&lt;/statement&gt;
    &lt;validate column="SOME_COLUMN"&gt;
      &lt;values&gt;
          &lt;value&gt;Value in 1st row&lt;/value&gt;
          &lt;value&gt;Value in 2nd row&lt;/value&gt;
          &lt;value&gt;Value in 3rd row&lt;/value&gt;
          &lt;value&gt;Value in x row&lt;/value&gt;
      &lt;/values&gt;
    &lt;/validate&gt;
&lt;/sql&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next example shows how to work with multiple row result sets and multiple values to expect within one column:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">$(sql()
    .dataSource(myDataSource)
    .query()
    .statement("select WEEKDAY as DAY, DESCRIPTION from WEEK")
    .validate("DAY",
        "Monday",
        "Tuesday",
        "Wednesday",
        "Thursday",
        "Friday",
        "@ignore@",
        "@ignore@")
    .validate("DESCRIPTION",
        "I hate Mondays!",
        "Tuesday is sports day",
        "The mid of the week",
        "Thursday we play chess",
        "Friday, the weekend is near!",
        "@ignore@",
        "@ignore@")
);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;sql datasource="myDataSource"&gt;
    &lt;statements&gt;
        &lt;statement&gt;select WEEKDAY as DAY, DESCRIPTION from WEEK&lt;/statement&gt;
    &lt;/statements&gt;
    &lt;validate column="DAY"&gt;
      &lt;values&gt;
          &lt;value&gt;Monday&lt;/value&gt;
          &lt;value&gt;Tuesday&lt;/value&gt;
          &lt;value&gt;Wednesday&lt;/value&gt;
          &lt;value&gt;Thursday&lt;/value&gt;
          &lt;value&gt;Friday&lt;/value&gt;
          &lt;value&gt;@ignore@&lt;/value&gt;
          &lt;value&gt;@ignore@&lt;/value&gt;
      &lt;/values&gt;
    &lt;/validate&gt;
    &lt;validate column="DESCRIPTION"&gt;
      &lt;values&gt;
          &lt;value&gt;I hate Mondays!&lt;/value&gt;
          &lt;value&gt;Tuesday is sports day&lt;/value&gt;
          &lt;value&gt;The mid of the week&lt;/value&gt;
          &lt;value&gt;Thursday we play chess&lt;/value&gt;
          &lt;value&gt;Friday, the weekend is near!&lt;/value&gt;
          &lt;value&gt;@ignore@&lt;/value&gt;
          &lt;value&gt;@ignore@&lt;/value&gt;
      &lt;/values&gt;
    &lt;/validate&gt;
&lt;/sql&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- sql:
  dataSource: "myDataSource"
  statements:
    - statement: "select WEEKDAY as DAY, DESCRIPTION from WEEK"
  validate:
    - column: "SOME_COLUMN"
      values:
        - "Value in 1st row"
        - "Value in 2nd row"
        - "Value in 3rd row"
        - "Value in x row"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;sql datasource="myDataSource"&gt;
    &lt;statement&gt;select WEEKDAY as DAY, DESCRIPTION from WEEK&lt;/statement&gt;
    &lt;validate column="DAY"&gt;
      &lt;values&gt;
          &lt;value&gt;Monday&lt;/value&gt;
          &lt;value&gt;Tuesday&lt;/value&gt;
          &lt;value&gt;Wednesday&lt;/value&gt;
          &lt;value&gt;Thursday&lt;/value&gt;
          &lt;value&gt;Friday&lt;/value&gt;
          &lt;value&gt;@ignore@&lt;/value&gt;
          &lt;value&gt;@ignore@&lt;/value&gt;
      &lt;/values&gt;
    &lt;/validate&gt;
    &lt;validate column="DESCRIPTION"&gt;
      &lt;values&gt;
          &lt;value&gt;I hate Mondays!&lt;/value&gt;
          &lt;value&gt;Tuesday is sports day&lt;/value&gt;
          &lt;value&gt;The mid of the week&lt;/value&gt;
          &lt;value&gt;Thursday we play chess&lt;/value&gt;
          &lt;value&gt;Friday, the weekend is near!&lt;/value&gt;
          &lt;value&gt;@ignore@&lt;/value&gt;
          &lt;value&gt;@ignore@&lt;/value&gt;
      &lt;/values&gt;
    &lt;/validate&gt;
&lt;/sql&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the validation of multiple rows the <strong><em>`&lt;validate&gt;`</em></strong> element is able to host a list of control values for a column. As you can see from the example above, you have to add a control value for each row in the result set. This also means that we have to take care of the total number of rows. Fortunately we can use the ignore placeholder, in order to skip the validation of a specific row in the result set. Functions and variables are supported as usual.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is important, that the control values are defined in the correct order, because they are compared one on one with the actual result set coming from database query. You may need to add "order by" SQL expressions to get the right order of rows returned. If any of the values fails in validation or the total number of rows is not equal, the whole action will fail with respective validation errors.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="sql-transaction-management"><a class="anchor" href="#sql-transaction-management"></a><a class="link" href="#sql-transaction-management">8.3.3. Transaction management</a></h4>
<div class="paragraph">
<p>By default no transactions are used when Citrus executes SQL statements on a datasource. You can enable transaction management by selecting a transaction manager.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">$(sql()
    .dataSource(myDataSource)
    .transactionManager(transactionManager)
    .transactionTimeout(15000)
    .transactionIsolationLevel("ISOLATION_READ_COMMITTED")
    .statement("DELETE FROM CUSTOMERS")
    .statement("DELETE FROM ORDERS")
);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;sql datasource="someDataSource"&gt;
    &lt;transaction&gt;
        &lt;manager&gt;"someTransactionManager"&lt;/manager&gt;
        &lt;timeout&gt;"15000"&lt;/timeout&gt;
        &lt;isolation-level&gt;"ISOLATION_READ_COMMITTED"&lt;/isolation-level&gt;
    &lt;/transaction&gt;
    &lt;statements&gt;
        &lt;statement&gt;DELETE FROM CUSTOMERS&lt;/statement&gt;
        &lt;statement&gt;DELETE FROM ORDERS&lt;/statement&gt;
    &lt;/statements&gt;
&lt;/sql&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- sql:
    datasource: "myDataSource"
    transaction:
      manager: "someTransactionManager"
      timeout: 15000
      isolation-level: "ISOLATION_READ_COMMITTED"
    statements:
      - statement: "DELETE FROM CUSTOMERS"
      - statement: "DELETE FROM ORDERS"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;sql datasource="myDataSource"
     transaction-manager="someTransactionManager"
     transaction-timeout="15000"
     transaction-isolation-level="ISOLATION_READ_COMMITTED"&gt;
    &lt;statement&gt;DELETE FROM CUSTOMERS&lt;/statement&gt;
    &lt;statement&gt;DELETE FROM ORDERS&lt;/statement&gt;
&lt;/sql&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>transaction-manager</em> attribute references a Spring bean of type "<em>org.springframework.transaction.PlatformTransactionManager</em>". You can add this transaction manager to the Spring bean configuration:</p>
</div>
<div class="listingblock primary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public TransactionManager myTransactionManager(DataSource myDataSource) {
    return new DataSourceTransactionManager(myDataSource);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="myTransactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager"&gt;
  &lt;constructor-arg ref="myDataSource"/&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The transaction isolation level as well as the transaction timeout get set on the transaction definition used during SQL statement execution. The isolation level should evaluate to one of the constants given in "<em>org.springframework.transaction.TransactionDefinition</em>". Valid isolation level are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ISOLATION_DEFAULT</p>
</li>
<li>
<p>ISOLATION_READ_UNCOMMITTED</p>
</li>
<li>
<p>ISOLATION_READ_COMMITTED</p>
</li>
<li>
<p>ISOLATION_REPEATABLE_READ</p>
</li>
<li>
<p>ISOLATION_SERIALIZABLE</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="groovy-sql-result-set-validation"><a class="anchor" href="#groovy-sql-result-set-validation"></a><a class="link" href="#groovy-sql-result-set-validation">8.3.4. Groovy SQL result set validation</a></h4>
<div class="paragraph">
<p>Groovy provides great support for accessing Java list objects and maps. As a Java SQL result set is nothing but a list of map representations, where each entry in the list defines a row in the result set and each map entry represents the columns and values. So with Groovy&#8217;s list and map access we have great possibilities to validate a SQL result set - out of the box.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">$(sql()
    .dataSource(myDataSource)
    .query()
    .statement("select ORDERTYPE, STATUS from ORDERS where ID='${orderId}'")
    .validateScript("assert rows.size() == 2;" +
            "assert rows[0].ID == '1';" +
            "assert rows[0].STATUS == 'in progress';", "groovy")
);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;sql datasource="myDataSource"&gt;
    &lt;statements&gt;
        &lt;statement&gt;select ID from CUSTOMERS where NAME='${customerName}'&lt;/statement&gt;
        &lt;statement&gt;select ORDERTYPE, STATUS from ORDERS where ID='${orderId}'&lt;/statement&gt;
    &lt;/statements&gt;
    &lt;validate&gt;
        &lt;script type="groovy"&gt;
          assert rows.size() == 2
          assert rows[0].ID == '1'
          assert rows[1].STATUS == 'in progress'
          assert rows[1] == [ORDERTYPE:'SampleOrder', STATUS:'in progress']
        &lt;/script&gt;
    &lt;/validate&gt;
&lt;/sql&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- sql:
  dataSource: "myDataSource"
  statements:
    - statement: "select ID from CUSTOMERS where NAME='${customerName}'"
    - statement: "select ORDERTYPE, STATUS from ORDERS where ID='${orderId}'"
  validate:
    - script:
        type: "groovy"
        value: |
          assert rows.size() == 2
          assert rows[0].ID == '1'
          assert rows[1].STATUS == 'in progress'
          assert rows[1] == [ORDERTYPE:'SampleOrder', STATUS:'in progress']</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;sql datasource="myDataSource"&gt;
    &lt;statement&gt;select ID from CUSTOMERS where NAME='${customerName}'&lt;/statement&gt;
    &lt;statement&gt;select ORDERTYPE, STATUS from ORDERS where ID='${orderId}'&lt;/statement&gt;

    &lt;validate-script type="groovy"&gt;
        assert rows.size() == 2
        assert rows[0].ID == '1'
        assert rows[1].STATUS == 'in progress'
        assert rows[1] == [ORDERTYPE:'SampleOrder', STATUS:'in progress']
    &lt;/validate-script&gt;
&lt;/sql&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see Groovy provides fantastic access methods to the SQL result set. We can browse the result set with named column values and check the size of the result set. We are also able to search for an entry, iterate over the result set and have other helpful operations. For a detailed description of the list and map handling in Groovy my advice for you is to have a look at the official Groovy documentation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In general other script languages do also support this kind of list and map access. For now we just have implemented the Groovy script support, but the framework is ready to work with all other great script languages out there, too (e.g. Scala, Clojure, Fantom, etc.). So if you prefer to work with another language join and help us implement those features.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="save-result-set-values"><a class="anchor" href="#save-result-set-values"></a><a class="link" href="#save-result-set-values">8.3.5. Save result set values</a></h4>
<div class="paragraph">
<p>Now the validation of database entries is a very powerful feature but sometimes we simply do not know the persisted content values. The test may want to read database entries into test variables without validation. Citrus is able to do that with the following &lt;extract&gt; expressions:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">$(sql()
    .dataSource(myDataSource)
    .query()
        .statement("select ID from CUSTOMERS where NAME='${customerName}'")
        .statement("select STATUS from ORDERS where ID='${orderId}'")
    .extract("ID", "customerId")
    .extract("STATUS", "orderStatus")
);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;sql datasource="myDataSource"&gt;
    &lt;statements&gt;
        &lt;statement&gt;select ID from CUSTOMERS where NAME='${customerName}'&lt;/statement&gt;
        &lt;statement&gt;select STATUS from ORDERS where ID='${orderId}'&lt;/statement&gt;
    &lt;/statements&gt;
    &lt;extract  column="ID" variable="customerId"/&gt;
    &lt;extract  column="STATUS" variable="orderStatus"/&gt;
&lt;/sql&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- sql:
  dataSource: "myDataSource"
  statements:
    - statement: "select ID from CUSTOMERS where NAME='${customerName}'"
    - statement: "select ORDERTYPE, STATUS from ORDERS where ID='${orderId}'"
  extract:
    - column: "ID"
      variable: "customerId"
    - column: "STATUS"
      variable: "orderStatus"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;sql datasource="testDataSource"&gt;
    &lt;statement&gt;select ID from CUSTOMERS where NAME='${customerName}'&lt;/statement&gt;
    &lt;statement&gt;select STATUS from ORDERS where ID='${orderId}'&lt;/statement&gt;

    &lt;extract column="ID" variable="${customerId}"/&gt;
    &lt;extract column="STATUS" variable="${orderStatus}"/&gt;
&lt;/sql&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can save the database column values directly to test variables. Of course you can combine the value extraction with the normal column validation described earlier in this chapter. Please keep in mind that we can not use these operations on result sets with multiple rows. Citrus will always use the first row in a result set.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="actions-sleep"><a class="anchor" href="#actions-sleep"></a><a class="link" href="#actions-sleep">8.4. Sleep</a></h3>
<div class="paragraph">
<p>This action shows how to make the test framework execution stop for a given amount of time.
The attribute 'time' defines the amount of time to wait in seconds.
As shown in the next example decimal values are supported too.
When no waiting time is specified the default time of 50000 milliseconds applies.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sleepTest() {
    $(sleep().seconds(3.5));

    $(sleep().milliseconds(500));

    $(sleep());
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SleepTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;sleep seconds="3.5"/&gt;

        &lt;sleep milliseconds="500"/&gt;

        &lt;sleep/&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SleepTest
actions:
  - sleep:
      seconds: "3.5"
  - sleep:
      milliseconds: "500"
  - sleep: {}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="SleepTest"&gt;
        &lt;actions&gt;
            &lt;sleep seconds="3.5"/&gt;

            &lt;sleep milliseconds="500"/&gt;

            &lt;sleep/&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When should somebody use this action?
To us this action was always very useful in case the test needed to wait until an application had done some work.
For example in some cases the application took some time to write some data into the database.
We waited then a small amount of time in order to avoid unnecessary test failures, because the test framework simply validated the database too early.
Or as another example the test may wait a given time until retry mechanisms are triggered in the tested application and then proceed with the test actions.</p>
</div>
</div>
<div class="sect2">
<h3 id="actions-delay"><a class="anchor" href="#actions-delay"></a><a class="link" href="#actions-delay">8.5. Delay</a></h3>
<div class="paragraph">
<p>This action shows how to make the test framework execution stop for a given amount of time.
The attribute 'time' defines the amount of time to wait in seconds.
As shown in the next example decimal values are supported too.
When no waiting time is specified the default time of 50000 milliseconds applies.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void delayTest() {
    $(delay().seconds(3.5));

    $(delay().milliseconds(500));

    $(delay());
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="DelayTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;delay seconds="3.5"/&gt;

        &lt;delay milliseconds="500"/&gt;

        &lt;delay/&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: DelayTest
actions:
  - delay:
      seconds: "3.5"
  - delay:
      milliseconds: "500"
  - delay: {}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="DelayTest"&gt;
        &lt;actions&gt;
            &lt;delay seconds="3.5"/&gt;

            &lt;delay milliseconds="500"/&gt;

            &lt;delay/&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When should somebody use this action?
To us this action was always very useful in case the test needed to wait until an application had done some work.
For example in some cases the application took some time to write some data into the database.
We waited then a small amount of time in order to avoid unnecessary test failures, because the test framework simply validated the database too early.
Or as another example the test may wait a given time until retry mechanisms are triggered in the tested application and then proceed with the test actions.</p>
</div>
</div>
<div class="sect2">
<h3 id="actions-java"><a class="anchor" href="#actions-java"></a><a class="link" href="#actions-java">8.6. Java</a></h3>
<div class="paragraph">
<p>The test framework is written in Java and runs inside a Java virtual machine. The functionality of calling other Java objects and methods in this same Java VM through Java Reflection is self-evident. With this action you can call any Java API available at runtime through the specified Java classpath.</p>
</div>
<div class="paragraph">
<p>The action syntax looks like follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void javaActionTest() {
    $(java("org.citrusframework.test.util.InvocationDummy")
        .constructorArgs("Test Invocation")
        .method("invoke")
        .methodArgs(new String[] { "1","2" })
    );

    $(java(new InvocationDummy("Test Invocation"))
        .method("invoke")
        .methodArgs(new Object[] { 4, "Test Invocation", true })
    );

    $(java(InvocationDummy.class)
        .method("main")
        .methodArgs(new String[] { "4", "Test Invocation", "true" })
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="JavaTest"&gt;
        &lt;actions&gt;
            &lt;java class="org.citrusframework.test.util.InvocationDummy"&gt;
                &lt;constructor&gt;
                    &lt;argument type=""&gt;Test Invocation&lt;/argument&gt;
                &lt;/constructor&gt;
                &lt;method name="invoke"&gt;
                    &lt;argument type="String[]"&gt;1,2&lt;/argument&gt;
                &lt;/method&gt;
            &lt;/java&gt;

            &lt;java class="org.citrusframework.test.util.InvocationDummy"&gt;
                &lt;constructor&gt;
                    &lt;argument type=""&gt;Test Invocation&lt;/argument&gt;
                &lt;/constructor&gt;
                &lt;method name="invoke"&gt;
                    &lt;argument type="int"&gt;4&lt;/argument&gt;
                    &lt;argument type="String"&gt;Test Invocation&lt;/argument&gt;
                    &lt;argument type="boolean"&gt;true&lt;/argument&gt;
                &lt;/method&gt;
            &lt;/java&gt;

            &lt;java class="org.citrusframework.test.util.InvocationDummy"&gt;
                &lt;method name="main"&gt;
                    &lt;argument type="String[]"&gt;4,Test,true &lt;/argument&gt;
                &lt;/method&gt;
            &lt;/java&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Java class is specified by fully qualified class name. Constructor arguments are added using the &lt;constructor&gt; element with a list of &lt;argument&gt; child elements. The type of the argument is defined within the respective attribute "type". By default the type would be String.</p>
</div>
<div class="paragraph">
<p>The invoked method on the Java object is simply referenced by its name. Method arguments do not bring anything new after knowing the constructor argument definition, do they?.</p>
</div>
<div class="paragraph">
<p>Method arguments support data type conversion too, even string arrays (useful when calling CLIs). In the third action in the example code you can see that colon separated strings are automatically converted to string arrays.</p>
</div>
<div class="paragraph">
<p>Simple data types are defined by their name (int, boolean, float etc.). Be sure that the invoked method and class constructor fit your arguments and vice versa, otherwise you will cause errors at runtime.</p>
</div>
<div class="paragraph">
<p>Besides instantiating a fully new object instance for a class how about reusing a bean instance available in Spring bean container. Simply use the <strong>ref</strong> attribute and refer to an existing bean in Spring application context.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">InvocationDummy invocationDummy = new InvocationDummy("Test Invocation");
$(java(invocationDummy)
    .method("invoke")
    .methodArgs(new Object[] { 4, "Test Invocation", true })
);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;java ref="invocationDummy"&gt;
    &lt;method name="invoke"&gt;
        &lt;argument type="int"&gt;4&lt;/argument&gt;
        &lt;argument type="String"&gt;Test Invocation&lt;/argument&gt;
        &lt;argument type="boolean"&gt;true&lt;/argument&gt;
    &lt;/method&gt;
&lt;/java&gt;

&lt;bean id="invocationDummy" class="org.citrusframework.test.util.InvocationDummy"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The method is invoked on the Spring bean instance. This is very useful as you can inject other objects (e.g. via Autowiring) to the Spring bean instance before method invocation in test takes place. This enables you to execute any Java logic inside a test case.</p>
</div>
</div>
<div class="sect2">
<h3 id="actions-expect-timeout"><a class="anchor" href="#actions-expect-timeout"></a><a class="link" href="#actions-expect-timeout">8.7. Expect timeout</a></h3>
<div class="paragraph">
<p>In some cases it might be necessary to validate that a message is <strong>not</strong> present on a destination. This means that this action expects a timeout when receiving a message from an endpoint destination. For instance the tester intends to ensure that no message is sent to a certain destination in a time period. In that case the timeout would not be a test aborting error but the expected behavior. And in contrast to the normal behavior when a message is received in the time period the test will fail with error.</p>
</div>
<div class="paragraph">
<p>In order to validate such a timeout situation the action &lt;expectTimout&gt; shall help. The usage is very simple as the following example shows:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
@Qualifier("myEndpoint")
private Endpoint myEndpoint;

@CitrusTest
public void expectTimeoutTest() {
    $(expectTimeout()
            .endpoint(myEndpoint)
            .timeout(500)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ExpectTimeoutTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;expect-timeout endpoint="myEndpoint" wait="500"/&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ExpectTimeoutTest
actions:
  - expect-timeout:
      endpoint: "myEndpoint"
      wait: "500"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="ExpectTimeoutTest"&gt;
        &lt;actions&gt;
            &lt;expect-timeout endpoint="myEndpoint" wait="500"/&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The action offers two attributes:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
endpoint
</td>
<td class="hdlist2">
<p>Reference to a message endpoint that will try to receive messages.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
wait/timeout
</td>
<td class="hdlist2">
<p>Time period to wait for messages to arrive</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Sometimes you may want to add some selector on the timeout receiving action. This way you can very selective check on a message to not be present on a message destination. This is possible with defining a message selector on the test action as follows.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
@Qualifier("myEndpoint")
private Endpoint myEndpoint;

@CitrusTest
public void expectTimeoutTest() {
    $(expectTimeout()
            .endpoint(myEndpoint)
            .timeout(500)
            .selector("MessageId = '123456789'")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ExpectTimeoutTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;expect-timeout endpoint="myEndpoint" wait="500"&gt;
            &lt;selector&gt;MessageId='123456789'&lt;/selector&gt;
        &lt;/expect-timeout&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ExpectTimeoutTest
actions:
  - expect-timeout:
      endpoint: "myEndpoint"
      wait: "500"
      selector:
        value: "MessageId='123456789'"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="ExpectTimeoutTest"&gt;
        &lt;actions&gt;
            &lt;expect-timeout endpoint="myEndpoint" wait="500"&gt;
                &lt;select&gt;MessageId='123456789'&lt;select/&gt;
            &lt;/expect-timeout&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="actions-echo"><a class="anchor" href="#actions-echo"></a><a class="link" href="#actions-echo">8.8. Echo</a></h3>
<div class="paragraph">
<p>The &lt;echo&gt; action prints messages to the console/logger. This functionality is useful when debugging test runs. The property "message" defines the text that is printed. Tester might use it to print out debug messages and variables as shown in the next code example:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void echoTest() {
    variable("today", "citrus:currentDate()");

    $(echo().message("Hello Test Framework"));
    $(echo().message("Current date is: ${today}"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="EchoTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;variables&gt;
        &lt;variable name="today" value="citrus:currentDate()"/&gt;
    &lt;/variables&gt;
    &lt;actions&gt;
        &lt;echo&gt;
            &lt;message&gt;Hello Test Framework&lt;/message&gt;
        &lt;/echo&gt;

        &lt;echo&gt;
            &lt;message&gt;Current date is: ${today}&lt;/message&gt;
        &lt;/echo&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: EchoTest
variables:
  - name: "today"
    value: "citrus:currentDate()"
actions:
  - echo:
      message: "Hello Test Framework"
  - echo:
      message: "Current date is: ${today}"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="EchoTest"&gt;
        &lt;variables&gt;
            &lt;variable name="today" value="citrus:currentDate()"/&gt;
        &lt;/variables&gt;
        &lt;actions&gt;
            &lt;echo&gt;
                &lt;message&gt;Hello Test Framework&lt;/message&gt;
            &lt;/echo&gt;

            &lt;echo&gt;
                &lt;message&gt;Current date is: ${today}&lt;/message&gt;
            &lt;/echo&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Result on the console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Hello Test Framework
Current time is: 05.08.2008</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="actions-print"><a class="anchor" href="#actions-print"></a><a class="link" href="#actions-print">8.9. Print</a></h3>
<div class="paragraph">
<p>The &lt;print&gt; action prints messages to the console/logger.
This functionality is useful when debugging test runs.
The property "message" defines the text that is printed.
Tester might use it to print out debug messages and variables as shown the next code example:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void printTest() {
    variable("today", "citrus:currentDate()");

    $(print().message("Hello Test Framework"));
    $(print().message("Current date is: ${today}"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="PrintTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;variables&gt;
        &lt;variable name="today" value="citrus:currentDate()"/&gt;
    &lt;/variables&gt;
    &lt;actions&gt;
        &lt;print&gt;
            &lt;message&gt;Hello Test Framework&lt;/message&gt;
        &lt;/print&gt;

        &lt;print&gt;
            &lt;message&gt;Current date is: ${today}&lt;/message&gt;
        &lt;/print&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: PrintTest
variables:
  - name: "today"
    value: "citrus:currentDate()"
actions:
  - print:
      message: "Hello Test Framework"
  - print:
      message: "Current date is: ${today}"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="PrintTest"&gt;
        &lt;variables&gt;
            &lt;variable name="today" value="citrus:currentDate()"/&gt;
        &lt;/variables&gt;
        &lt;actions&gt;
            &lt;print&gt;
                &lt;message&gt;Hello Test Framework&lt;/message&gt;
            &lt;/print&gt;

            &lt;print&gt;
                &lt;message&gt;Current date is: ${today}&lt;/message&gt;
            &lt;/print&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Result on the console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Hello Test Framework
Current time is: 05.08.2008</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="actions-stop-time"><a class="anchor" href="#actions-stop-time"></a><a class="link" href="#actions-stop-time">8.10. Stop time</a></h3>
<div class="paragraph">
<p>Time measurement during a test can be very helpful.
The <code>&lt;trace-time&gt;</code> action creates and monitors multiple timelines.
The action offers the attribute <em>id</em> to identify a timeline.
The tester can of course use more than one timeline with different ids simultaneously.</p>
</div>
<div class="paragraph">
<p>Read the next example, and you will understand the mix of different timelines:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sleepTest() {
    $(stopTime());

    $(stopTime().id("time_line_id"));

    $(sleep().seconds(3.5));

    $(stopTime().id(" time_line_id "));

    $(sleep().milliseconds(5000));

    $(stopTime());

    $(stopTime().id(" time_line_id "));

}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SleepTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;stop-time/&gt;

        &lt;stop-time id="time_line_id"/&gt;

        &lt;sleep seconds="3.5"/&gt;

        &lt;stop-time id=" time_line_id "/&gt;

        &lt;sleep milliseconds="5000"/&gt;

        &lt;stop-time/&gt;

        &lt;stop-time id=" time_line_id "/&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SleepTest
actions:
  - stop-time: {}

  - stop-time:
      id: "time_line_id"

  - sleep:
      seconds: "3.5"

  - stop-time:
      id: "time_line_id"

  - sleep:
      milliseconds: "5000"

  - stop-time: {}

  - stop-time:
      id: "time_line_id"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="SleepTest"&gt;
        &lt;actions&gt;
            &lt;trace-time/&gt;

            &lt;trace-time id="time_line_id"/&gt;

            &lt;sleep seconds="3.5"/&gt;

            &lt;trace-time id=" time_line_id "/&gt;

            &lt;sleep milliseconds="5000"/&gt;

            &lt;trace-time/&gt;

            &lt;trace-time id=" time_line_id "/&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test output looks like follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Starting TimeWatcher:
Starting TimeWatcher: time_line_id
TimeWatcher time_line_id after 3500 milliseconds
TimeWatcher after 8500 seconds
TimeWatcher time_line_id after 8500 milliseconds</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Timeline ids should not exist as test variables before the action is called for the first time. This would break the timeline initialization.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In case no timeline id is specified the framework will measure the time for a default timeline. To print out the current elapsed time for a timeline you simply have to place the
`&lt;trace-time&gt; action into the action chain again and again, using the respective timeline identifier. The elapsed time will be printed out to the console every time.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Each timeline is stored as test variable in the test case. By default you will have the following test variables set for each timeline:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
CITRUS_TIMELINE
</td>
<td class="hdlist2">
<p>first timestamp of timeline</p>
</td>
</tr>
<tr>
<td class="hdlist1">
CITRUS_TIMELINE_VALUE
</td>
<td class="hdlist2">
<p>latest time measurement value (time passed since first timestamp in milliseconds)</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>According to your timeline id you will get different test variable names. Also you can customize the time value suffix (default: <strong>_VALUE</strong>):</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sleepTest() {
    $(stopTime().id("custom_watcher").suffix("_1st"));

    $(sleep());

    $(stopTime().id(" custom_watcher ").suffix("_2nd"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SleepTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;stop-time id="custom_watcher" suffix="_1st"/&gt;

        &lt;sleep/&gt;

        &lt;stop-time id="custom_watcher" suffix="_2nd"/&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SleepTest
actions:
  - stop-time:
      id: "custom_watcher"
      suffix: "_1st"

  - sleep: {}

  - stop-time:
      id: "custom_watcher"
      suffix: "_2nd"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="SleepTest"&gt;
        &lt;actions&gt;
            &lt;trace-time id="custom_watcher" suffix="_1st"/&gt;

            &lt;sleep/&gt;

            &lt;trace-time id="custom_watcher" suffix="_2nd"/&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will get following test variables set:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
custom_watcher
</td>
<td class="hdlist2">
<p>first timestamp of timeline</p>
</td>
</tr>
<tr>
<td class="hdlist1">
custom_watcher_1st
</td>
<td class="hdlist2">
<p>time passed since start</p>
</td>
</tr>
<tr>
<td class="hdlist1">
custom_watcher_2nd
</td>
<td class="hdlist2">
<p>time passed since start</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Of course using the same suffix multiple times will overwrite the timestamps in test variables.</p>
</div>
</div>
<div class="sect2">
<h3 id="actions-create-variables"><a class="anchor" href="#actions-create-variables"></a><a class="link" href="#actions-create-variables">8.11. Create variables</a></h3>
<div class="paragraph">
<p>As you know variables usually are defined at the beginning of the test case (<a href="#test-variables">test-variables</a>).
It might also be helpful to reset existing variables as well as to define new variables during the test.
The action <code>&lt;create-variables&gt;</code> is able to declare new variables or overwrite existing ones.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void createVariableTest() {
    variable("myVariable", "12345");
    variable("id", "54321");

    $(echo()
        .message("Current variable value: ${myVariable}"));

    $(createVariable("myVariable", "${id}"));
    $(createVariable("newVariable", "this is a test"));

    $(echo()
        .message("Current variable value: ${myVariable}"));

    $(echo()
        .message("New variable 'newVariable' has the value: ${newVariable}"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CreateVariablesTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;variables&gt;
        &lt;variable name="myVariable" value="12345"/&gt;
        &lt;variable name="id" value="54321"/&gt;
    &lt;/variables&gt;
    &lt;actions&gt;
        &lt;echo&gt;
            &lt;message&gt;Current variable value: ${myVariable}&lt;/message&gt;
        &lt;/echo&gt;

        &lt;create-variables&gt;
            &lt;variable name="myVariable" value="${id}"/&gt;
            &lt;variable name="newVariable" value="'this is a test'"/&gt;
        &lt;/create-variables&gt;

        &lt;echo&gt;
            &lt;message&gt;Current variable value: ${myVariable} &lt;/message&gt;
        &lt;/echo&gt;

        &lt;echo&gt;
            &lt;message&gt;New variable 'newVariable' has the value: ${newVariable}&lt;/message&gt;
        &lt;/echo&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "CreateVariablesTest"
variables:
  - name: "myVariable"
    value: "12345"
  - name: "id"
    value: "54321"
actions:
  - echo:
      message: "Current variable value: ${myVariable}"
  - create-variable:
      variables:
        - name: "myVariable"
          value: "${id}"
        - name: "newVariable"
          value: "this is a test"
  - echo:
      message: "Current variable value: ${myVariable}"
  - echo:
      message: "New variable 'newVariable' has the value: ${newVariable}"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="createVariablesTest"&gt;
        &lt;variables&gt;
            &lt;variable name="myVariable" value="12345"/&gt;
            &lt;variable name="id" value="54321"/&gt;
        &lt;/variables&gt;
        &lt;actions&gt;
            &lt;echo&gt;
                &lt;message&gt;Current variable value: ${myVariable}&lt;/message&gt;
            &lt;/echo&gt;

            &lt;create-variables&gt;
                &lt;variable name="myVariable" value="${id}"/&gt;
                &lt;variable name="newVariable" value="'this is a test'"/&gt;
            &lt;/create-variables&gt;

            &lt;echo&gt;
                &lt;message&gt;Current variable value: ${myVariable} &lt;/message&gt;
            &lt;/echo&gt;

            &lt;echo&gt;
                &lt;message&gt;
                  New variable 'newVariable' has the value: ${newVariable}
                &lt;/message&gt;
            &lt;/echo&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please note the difference between the <strong>variable()</strong> method and the <strong>createVariable()</strong> method.
The first initializes the test case with the test variables.
So all variables defined with this method are valid from the very beginning of the test.
In contrary to that the <strong>createVariable()</strong> is executed within the test action chain. The newly created variables are then valid for the rest of the test.
Trailing actions can reference the variables as usual with the variable expression.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="actions-create-endpoint"><a class="anchor" href="#actions-create-endpoint"></a><a class="link" href="#actions-create-endpoint">8.12. Create endpoints</a></h3>
<div class="paragraph">
<p>Endpoints represent the connectivity to other services in Citrus.
An endpoint may create producers and consumers to send and receive messages as part of the test.</p>
</div>
<div class="paragraph">
<p>Users are able to declare endpoints in the form of a project wide configuration in Citrus.
Also, users are able to use dynamic endpoint definitions with a <code>send</code> or <code>receive</code> action where the endpoint is defined as a URI.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void useDynamicEndpoints() {
    $(send()
        .endpoint("kafka:bookings?server=${kafka.bootstrapServer}")
        .message()
        // ...
    );

    $(receive()
        .endpoint("kafka:bookings?server=${kafka.bootstrapServer}")
        .message()
        // ...
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="UseDynamicEndpoints" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="kafka:bookings?server=${kafka.bootstrapServer}"&gt;
            &lt;message&gt;
              &lt;!--
              ...
              --&gt;
            &lt;/message&gt;
        &lt;/send&gt;
        &lt;receive endpoint="kafka:bookings?server=${kafka.bootstrapServer}"&gt;
            &lt;message&gt;
              &lt;!--
              ...
              --&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "UseDynamicEndpoints"
actions:
  - send:
      endpoint: "kafka:bookings?server=${kafka.bootstrapServer}"
      message:
        # ...
  - receive:
      endpoint: "kafka:bookings?server=${kafka.bootstrapServer}"
      message:
        # ...</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="useDynamicEndpoints"&gt;
        &lt;actions&gt;
            &lt;send endpoint="kafka:bookings?server=${kafka.bootstrapServer}"&gt;
                &lt;message&gt;
                  &lt;!--
                  ...
                  --&gt;
                &lt;/message&gt;
            &lt;/send&gt;
            &lt;receive endpoint="kafka:bookings?server=${kafka.bootstrapServer}"&gt;
                &lt;message&gt;
                  &lt;!--
                  ...
                  --&gt;
                &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The dynamic endpoint receives its properties in the form of endpoint URI parameters: <code>kafka:bookings?server=${kafka.bootstrapServer}</code></p>
</div>
<div class="paragraph">
<p>The test needs to repeat the same configuration endpoint URI several times with multiple send/receive test actions.</p>
</div>
<div class="paragraph">
<p>This can be improved by using the <code>createEndpoint()</code> test action that declares the endpoint once with a given name.
Following test actions are able to reference the endpoint as usual by its give name.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void useDynamicEndpoints() {
    $(createEndpoint()
        .endpointName("bookings")
        .uri("kafka:bookings?server=${kafka.bootstrapServer}")
    );

    $(send()
        .endpoint("bookings")
        .message()
        // ...
    );

    $(receive()
        .endpoint("bookings")
        .message()
        // ...
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="UseDynamicEndpoints" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;create-endpoint name="bookings"
                         uri="kafka:bookings?server=${kafka.bootstrapServer}"/&gt;

        &lt;send endpoint="bookings"&gt;
            &lt;message&gt;
              &lt;!--
              ...
              --&gt;
            &lt;/message&gt;
        &lt;/send&gt;
        &lt;receive endpoint="bookings"&gt;
            &lt;message&gt;
              &lt;!--
              ...
              --&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "UseDynamicEndpoints"
actions:
  - createEndpoint:
      name: bookings
      uri: "kafka:bookings?server=${kafka.bootstrapServer}"
  - send:
      endpoint: "bookings"
      message:
        # ...
  - receive:
      endpoint: "bookings"
      message:
        # ...</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an alternative syntax aou may also declare the properties with key-value pairs in the <code>createEndpoint()</code> action:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void useDynamicEndpoints() {
    $(createEndpoint()
        .endpointName("bookings")
        .type("kafka")
        .property("topic", "bookings")
        .property("server", "${kafka.bootstrapServer}")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="UseDynamicEndpoints" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;create-endpoint name="bookings" type="kafka"&gt;
          &lt;properties&gt;
            &lt;property name="topic" value="bookings"/&gt;
            &lt;property name="server" value="${kafka.bootstrapServer}"/&gt;
          &lt;/properties&gt;
        &lt;/create-endpoint&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "UseDynamicEndpoints"
actions:
  - createEndpoint:
      name: bookings
      type: "kafka"
      properties:
        topic: bookings
        server: "${kafka.bootstrapServer}"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="actions-trace-variables"><a class="anchor" href="#actions-trace-variables"></a><a class="link" href="#actions-trace-variables">8.13. Trace variables</a></h3>
<div class="paragraph">
<p>You already know the &lt;echo&gt; action that prints messages to the console or logger. The &lt;trace-variables&gt; action is specially designed to trace all currently valid test variables to the console. This was mainly used by us for debug reasons. The usage is quite simple:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void traceVariablesTest() {
    variable("myVariable", "12345");
    variable("nextVariable", "54321");

    $(traceVariables("myVariable", "nextVariable"));
    $(traceVariables());
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="TraceVariablesTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;variables&gt;
        &lt;variable name="myVariable" value="12345"/&gt;
        &lt;variable name="nextVariable" value="54321"/&gt;
    &lt;/variables&gt;
    &lt;actions&gt;
        &lt;trace&gt;
            &lt;variable name="myVariable"/&gt;
            &lt;variable name="nextVariable"/&gt;
        &lt;/trace&gt;

        &lt;trace-variables/&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: TraceVariablesTest
variables:
  - name: "myVariable"
    value: "12345"
  - name: "nextVariable"
    value: "54321"
actions:
  - trace:
      variables:
          - name: "myVariable"
          - name: "nextVariable"
  - trace: {}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="TraceVariablesTest"&gt;
        &lt;variables&gt;
            &lt;variable name="myVariable" value="12345"/&gt;
            &lt;variable name="nextVariable" value="54321"/&gt;
        &lt;/variables&gt;
        &lt;actions&gt;
            &lt;trace-variables&gt;
                &lt;variable name="myVariable"/&gt;
                &lt;variable name="nextVariable"/&gt;
            &lt;/trace-variables&gt;

            &lt;trace-variables/&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Simply add the &lt;trace-variables&gt; action to your action chain and all variables will be printed out to the console. You are able to define a special set of variables by using the &lt;variable&gt; child elements. See the output that was generated by the test example above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Current value of variable myVariable = 12345
Current value of variable nextVariable = 54321</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="actions-transform"><a class="anchor" href="#actions-transform"></a><a class="link" href="#actions-transform">8.14. Transform</a></h3>
<div class="paragraph">
<p>The <strong><em>`&lt;transform&gt;`</em></strong> action transforms XML fragments with XSLT in order to construct various XML representations. The transformation result is stored into a test variable for further usage. The property <strong>xml-data</strong> defines the XML source, that is going to be transformed, while <strong>xslt-data</strong> defines the XSLT transformation rules. The attribute <strong>variable</strong> specifies the target test variable which receives the transformation result. The tester might use the action to transform XML messages as shown in the next code example:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void transformTest() {
    $(transform()
        .variable("result")
        .source("""
            &lt;TestRequest&gt;
                &lt;Message&gt;Hello World!&lt;/Message&gt;
            &lt;/TestRequest&gt;
        """)
        .xslt("""
            &lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
              &lt;xsl:template match="/"&gt;
                  &lt;html&gt;
                      &lt;body&gt;
                          &lt;h2&gt;Test Request&lt;/h2&gt;
                          &lt;p&gt;Message: &lt;xsl:value-of select="TestRequest/Message"/&gt;&lt;/p&gt;
                      &lt;/body&gt;
                  &lt;/html&gt;
              &lt;/xsl:template&gt;
            &lt;/xsl:stylesheet&gt;
        """)
    );

    $(echo().message("${result}"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="TransformTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;transform variable="result"&gt;
            &lt;source&gt;
              &lt;![CDATA[
                  &lt;TestRequest&gt;
                      &lt;Message&gt;Hello World!&lt;/Message&gt;
                  &lt;/TestRequest&gt;
              ]]&gt;
            &lt;/source&gt;
            &lt;xslt&gt;
              &lt;![CDATA[
                  &lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
                      &lt;xsl:template match="/"&gt;
                          &lt;html&gt;
                              &lt;body&gt;
                                  &lt;h2&gt;Test Request&lt;/h2&gt;
                                  &lt;p&gt;Message: &lt;xsl:value-of select="TestRequest/Message"/&gt;&lt;/p&gt;
                              &lt;/body&gt;
                          &lt;/html&gt;
                      &lt;/xsl:template&gt;
                  &lt;/xsl:stylesheet&gt;
              ]]&gt;
            &lt;/xslt&gt;
        &lt;/transform&gt;
        &lt;echo&gt;
          &lt;message&gt;${result}&lt;/message&gt;
        &lt;/echo&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: TransformTest
actions:
  - transform:
      variable: result
      source:
        value: |
          &lt;TestRequest&gt;
              &lt;Message&gt;Hello World!&lt;/Message&gt;
          &lt;/TestRequest&gt;
      xslt:
        value: |
          &lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
              &lt;xsl:template match="/"&gt;
              &lt;html&gt;
                  &lt;body&gt;
                      &lt;h2&gt;Test Request&lt;/h2&gt;
                      &lt;p&gt;Message: &lt;xsl:value-of select="TestRequest/Message"/&gt;&lt;/p&gt;
                  &lt;/body&gt;
              &lt;/html&gt;
              &lt;/xsl:template&gt;
          &lt;/xsl:stylesheet&gt;
  - echo:
      message: '${result}'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="TransformTest"&gt;
        &lt;actions&gt;
            &lt;transform variable="result"&gt;
                &lt;xml-data&gt;
                  &lt;![CDATA[
                      &lt;TestRequest&gt;
                          &lt;Message&gt;Hello World!&lt;/Message&gt;
                      &lt;/TestRequest&gt;
                  ]]&gt;
                &lt;/xml-data&gt;
                &lt;xslt-data&gt;
                    &lt;![CDATA[
                    &lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
                        &lt;xsl:template match="/"&gt;
                          &lt;html&gt;
                              &lt;body&gt;
                                  &lt;h2&gt;Test Request&lt;/h2&gt;
                                  &lt;p&gt;Message: &lt;xsl:value-of select="TestRequest/Message"/&gt;&lt;/p&gt;
                              &lt;/body&gt;
                          &lt;/html&gt;
                        &lt;/xsl:template&gt;
                    &lt;/xsl:stylesheet&gt;
                    ]]&gt;
                &lt;/xslt-data&gt;
            &lt;/transform&gt;
            &lt;echo&gt;
              &lt;message&gt;${result}&lt;/message&gt;
            &lt;/echo&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The transformation above results to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">  &lt;html&gt;
      &lt;body&gt;
          &lt;h2&gt;Test Request&lt;/h2&gt;
          &lt;p&gt;Message: Hello World!&lt;/p&gt;
      &lt;/body&gt;
  &lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example we used CDATA sections to define the transformation source as well as the XSL transformation rules.
As usual you can also use external file resources here.
The transform action with external file resources looks like follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void transformTest() {
    $(transform()
        .variable("result")
        .source(new ClassPathResource("org/citrusframework/actions/transform-source.xml"))
        .xslt(new ClassPathResource("org/citrusframework/actions/transform.xslt"))
    );

    $(echo().message("${result}"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="TransformTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;transform variable="result"&gt;
            &lt;source file="classpath:transform-source.xml"/&gt;
            &lt;xslt file="classpath:transform.xslt"/&gt;
        &lt;/transform&gt;
        &lt;echo&gt;
          &lt;message&gt;${result}&lt;/message&gt;
        &lt;/echo&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: TransformTest
actions:
  - transform:
      variable: result
      source:
        file: "classpath:transform-source.xml"
      xslt:
        file: "classpath:transform.xslt"
  - echo:
      message: '${result}'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="TransformTest"&gt;
        &lt;actions&gt;
            &lt;transform variable="result"&gt;
                &lt;xml-resource file="classpath:transform-source.xml"/&gt;
                &lt;xslt-resource file="classpath:transform.xslt"/&gt;
            &lt;/transform&gt;
            &lt;echo&gt;
              &lt;message&gt;${result}&lt;/message&gt;
            &lt;/echo&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Defining multi-line Strings with nested quotes is no fun in Java.
So you may want to use external file resources for your scripts as shown in the second part of the example.
In fact, you could also use script languages like Groovy or Scala that have much better support for multi-line Strings.</p>
</div>
</div>
<div class="sect2">
<h3 id="actions-groovy"><a class="anchor" href="#actions-groovy"></a><a class="link" href="#actions-groovy">8.15. Groovy script execution</a></h3>
<div class="paragraph">
<p>Groovy is an agile dynamic language for the Java Platform.
Groovy ships with a lot of very powerful features and fits perfectly with Java as it is based on Java and runs inside the JVM.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The Groovy test action support lives in a separate module.
You need to add the module to your project to use the functionality.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">citrus-groovy dependency module</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-groovy&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Citrus Groovy support might be the entrance for you to write customized test actions.
You can easily execute Groovy code inside a test case, just like a normal test action.
The whole test context with all variables is available to the Groovy action. This means someone can change variable values or create new variables very easily.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a look at some examples in order to understand the possible Groovy code interactions in Citrus:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void GroovyTest() {
    $(groovy()
        .script("println 'Hello Citrus'")
    );

    $(groovy()
        .script("println 'The variable is: ${time}'")
    );

    $(groovy()
        .scriptResourcePath("classpath:org/citrusframework/script/example.groovy")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="GroovyTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;variables&gt;
        &lt;variable name="time" value="citrus:currentDate()"/&gt;
    &lt;/variables&gt;
    &lt;actions&gt;
        &lt;groovy&gt;
          &lt;script&gt;
            println 'Hello Citrus'
          &lt;/script&gt;
        &lt;/groovy&gt;
        &lt;groovy&gt;
          &lt;script&gt;
            println 'The variable is: ${time}'
          &lt;/script&gt;
        &lt;/groovy&gt;
        &lt;groovy&gt;
          &lt;script file="classpath:org/citrusframework/script/example.groovy"/&gt;
        &lt;/groovy&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: GroovyTest
variables:
  - name: "time"
    value: "citrus:currentDate()"
actions:
  - groovy:
      script: "println 'Hello Citrus'"
  - groovy:
      script: |
        println 'The variable is: ${time}'
  - groovy:
      script:
        file: classpath:org/citrusframework/script/example.groovy</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="GroovyTest"&gt;
      &lt;variables&gt;
        &lt;variable name="time" value="citrus:currentDate()"/&gt;
      &lt;/variables&gt;
      &lt;actions&gt;
        &lt;groovy&gt;
            println 'Hello Citrus'
        &lt;/groovy&gt;
        &lt;groovy&gt;
            println 'The variable is: ${time}'
        &lt;/groovy&gt;
        &lt;groovy resource="classpath:org/citrusframework/script/example.groovy"/&gt;
      &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see it is possible to write Groovy code directly into the test case. Citrus will interpret and execute the Groovy code at runtime. As usual nested variable expressions are replaced with respective values. In general this is done in advance before the Groovy code is interpreted. For more complex Groovy code sections which grow in lines of code you can also reference external file resources.</p>
</div>
<div class="paragraph">
<p>After this basic Groovy code usage inside a test case we might be interested accessing the whole TestContext. The TestContext Java object holds all test variables and function definitions for the test case and can be referenced in Groovy code via simple naming convention. Just access the object reference 'context' and you are able to manipulate the TestContext (e.g. setting a new variable which is directly ready for use in following test actions).</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void GroovyTest() {
    $(groovy()
        .script("""
            context.setVariable("greetingText","Hello Citrus")
            println context.getVariable("greetingText")
        """)
    );

    $(echo()
        .message("New variable: ${greetingText}")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="GroovyTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;groovy&gt;
            context.setVariable("greetingText","Hello Citrus")
            println context.getVariable("greetingText")
        &lt;/groovy&gt;
        &lt;echo&gt;
            &lt;message&gt;New variable: ${greetingText}&lt;/message&gt;
        &lt;/echo&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: GroovyTest
actions:
  - groovy:
      script: |
        context.setVariable("greetingText","Hello Citrus")
        println context.getVariable("greetingText")
  - echo:
      message: "New variable: ${greetingText}"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="groovyTest"&gt;
      &lt;actions&gt;
        &lt;groovy&gt;
          context.setVariable("greetingText","Hello Citrus")
          println context.getVariable("greetingText")
        &lt;/groovy&gt;

        &lt;echo&gt;
          &lt;message&gt;New variable: ${greetingText}&lt;/message&gt;
        &lt;/echo&gt;
      &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The implicit TestContext access that was shown in the previous sample works with a default Groovy script template provided by Citrus. The Groovy code you write in the test case is automatically surrounded with a Groovy script which takes care of handling the TestContext. The default template looks like follows:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Groovy script template</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.*
import org.citrusframework.variable.*
import org.citrusframework.context.TestContext
import org.citrusframework.script.GroovyAction.ScriptExecutor

public class GScript implements ScriptExecutor {
    public void execute(TestContext context) {
        @SCRIPTBODY@
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your code is placed in substitution to the <strong><em>@SCRIPTBODY@</em></strong> placeholder. Now you might understand how Citrus handles the context automatically. You can also write your own script templates making more advanced usage of other Java APIs and Groovy code. Just add a script template path to the test action like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">$(groovy()
    .template("classpath:my-custom-template.groovy")
    .script("...")
);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;groovy script-template="classpath:my-custom-template.groovy"&gt;
    &lt;!-- ... --&gt;
&lt;/groovy&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- groovy:
  script-template: "classpath:my-custom-template.groovy"
  script: "..."</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;groovy script-template="classpath:my-custom-template.groovy"&gt;
  &lt;!-- ... --&gt;
&lt;/groovy&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the other hand you can disable the automatic script template wrapping in your action at all:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">$(groovy()
    .useScriptTemplate(false)
    .script("println 'Just use some Groovy code'")
);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;groovy use-script-template="false"&gt;
    println 'Just use some Groovy code'
&lt;/groovy&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- groovy:
  use-script-template: false
  script: "println 'Just use some Groovy code'"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;groovy use-script-template="false"&gt;
  println 'Just use some Groovy code'
&lt;/groovy&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next example deals with advanced Groovy code and writing whole classes. We write a new Groovy class which implements the ScriptExecutor interface offered by Citrus. This interface defines a special execute method and provides access to the whole TestContext for advanced test variables access.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void GroovyTest() {
    variable("time", "citrus:currentDate()");

    $(groovy()
        .script("""
            import org.citrusframework.*
            import org.citrusframework.variable.*
            import org.citrusframework.context.TestContext
            import org.citrusframework.script.GroovyAction.ScriptExecutor

            public class GScript implements ScriptExecutor {
                public void execute(TestContext context) {
                    println context.getVariable("time")
                }
            }
        """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="GroovyTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;variables&gt;
        &lt;variable name="time" value="citrus:currentDate()"/&gt;
    &lt;/variables&gt;
    &lt;actions&gt;
        &lt;groovy&gt;
        &lt;![CDATA[
            import org.citrusframework.*
            import org.citrusframework.variable.*
            import org.citrusframework.context.TestContext
            import org.citrusframework.script.GroovyAction.ScriptExecutor

            public class GScript implements ScriptExecutor {
                public void execute(TestContext context) {
                    println context.getVariable("time")
                }
            }
        ]]&gt;
        &lt;/groovy&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: GroovyTest
variables:
  - name: time
    value: citrus:currentDate()
actions:
  - groovy:
      script: |
        import org.citrusframework.*
        import org.citrusframework.variable.*
        import org.citrusframework.context.TestContext
        import org.citrusframework.script.GroovyAction.ScriptExecutor

        public class GScript implements ScriptExecutor {
            public void execute(TestContext context) {
                println context.getVariable("time")
            }
        }</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="groovyTest"&gt;
      &lt;variables&gt;
        &lt;variable name="time" value="citrus:currentDate()"/&gt;
      &lt;/variables&gt;
      &lt;actions&gt;
        &lt;groovy&gt;
          &lt;![CDATA[
            import org.citrusframework.*
            import org.citrusframework.variable.*
            import org.citrusframework.context.TestContext
            import org.citrusframework.script.GroovyAction.ScriptExecutor

            public class GScript implements ScriptExecutor {
                public void execute(TestContext context) {
                    println context.getVariable("time")
                }
            }
          ]]&gt;
        &lt;/groovy&gt;
      &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Implementing the ScriptExecutor interface in a custom Groovy class is applicable for very special test context manipulations as you are able to import and use other Java API classes in this code.</p>
</div>
</div>
<div class="sect2">
<h3 id="actions-fail"><a class="anchor" href="#actions-fail"></a><a class="link" href="#actions-fail">8.16. Failing the test</a></h3>
<div class="paragraph">
<p>The fail action will generate an exception in order to terminate the test case with error. The test case will therefore not be successful in the reports.</p>
</div>
<div class="paragraph">
<p>The user can specify a custom error message for the exception in order to describe the error cause. Here is a very simple example to clarify the syntax:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void failTest() {
    $(fail().message("Test will fail with custom message"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="FailTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;fail message="Test will fail with custom message"/&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: FailTest
actions:
  - fail:
      message: "Test will fail with custom message"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="FailTest"&gt;
        &lt;actions&gt;
            &lt;fail message="Test will fail with custom message"/&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Test results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">Execution of test: failTest failed! Nested exception is:
org.citrusframework.exceptions.CitrusRuntimeException:
Test will fail with custom message

[...]

CITRUS TEST RESULTS

failTest          : failed - Exception is: Test will fail with custom message

Found 1 test cases to execute
Skipped 0 test cases (0.0%)
Executed 1 test cases, containing 3 actions
Tests failed:        1 (100.0%)
Tests successfully:  0 (0.0%)</code></pre>
</div>
</div>
<div class="paragraph">
<p>While using the Java DSL you can also raise arbitrary Java exceptions and let the test fail.</p>
</div>
<div class="listingblock">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void throwExceptionSample() {
    // some test actions

    throw new ValidationException("This test should fail now");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The validation exception above will cause the test to fail as expected. However you may consider using the fail action to raise errors because this ensures to properly report the error in the Citrus test reports.</p>
</div>
</div>
<div class="sect2">
<h3 id="actions-input"><a class="anchor" href="#actions-input"></a><a class="link" href="#actions-input">8.17. Input</a></h3>
<div class="paragraph">
<p>During the test case execution it is possible to read some user input from the command line. The test execution will stop and wait for keyboard inputs over the standard input stream. The user has to type the input and end it with the return key.</p>
</div>
<div class="paragraph">
<p>The user input is stored to the respective variable value.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void inputActionTest() {
    variable("userinput", "");
    variable("userinput1", "");
    variable("userinput2", "y");
    variable("userinput3", "yes");
    variable("userinput4", "");

    $(input());

    $(echo().message("user input was: ${userinput}"));

    $(input().message("Now press enter:").result("userinput1"));

    $(echo().message("user input was: ${userinput1}"));

    $(input().message("Do you want to continue?").answers("y", "n").result("userinput2"));

    $(echo().message("user input was: ${userinput2}"));

    $(input().message("Do you want to continue?").answers("yes", "no").result("userinput3"));

    $(echo().message("user input was: ${userinput3}"));

    $(input().result("userinput4"));

    $(echo().message("user input was: ${userinput4}"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="InputTest"&gt;
        &lt;variables&gt;
            &lt;variable name="userinput" value=""&gt;&lt;/variable&gt;
            &lt;variable name="userinput1" value=""&gt;&lt;/variable&gt;
            &lt;variable name="userinput2" value="y"&gt;&lt;/variable&gt;
            &lt;variable name="userinput3" value="yes"&gt;&lt;/variable&gt;
            &lt;variable name="userinput4" value=""&gt;&lt;/variable&gt;
        &lt;/variables&gt;
        &lt;actions&gt;
            &lt;input/&gt;
            &lt;echo&gt;&lt;message&gt;user input was: ${userinput}&lt;/message&gt;&lt;/echo&gt;

            &lt;input message="Now press enter:" variable="userinput1"/&gt;
            &lt;echo&gt;&lt;message&gt;user input was: ${userinput1}&lt;/message&gt;&lt;/echo&gt;

            &lt;input message="Do you want to continue?"
                      valid-answers="y/n" variable="userinput2"/&gt;
            &lt;echo&gt;&lt;message&gt;user input was: ${userinput2}&lt;/message&gt;&lt;/echo&gt;

            &lt;input message="Do you want to continue?"
                      valid-answers="yes/no" variable="userinput3"/&gt;
            &lt;echo&gt;&lt;message&gt;user input was: ${userinput3}&lt;/message&gt;&lt;/echo&gt;

            &lt;input variable="userinput4"/&gt;
            &lt;echo&gt;&lt;message&gt;user input was: ${userinput4}&lt;/message&gt;&lt;/echo&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the input action is customizable with a prompt message that is displayed to the user and some valid answer possibilities. The user input is stored to a test variable for further use in the test case. In detail the input action offers following attributes:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
message
</td>
<td class="hdlist2">
<p>message displayed to the user</p>
</td>
</tr>
<tr>
<td class="hdlist1">
valid-answers
</td>
<td class="hdlist2">
<p>possible valid answers separated with '/' character</p>
</td>
</tr>
<tr>
<td class="hdlist1">
variable
</td>
<td class="hdlist2">
<p>result variable name holding the user input (default = ${userinput})</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the user input is restricted to a set of valid answers the input validation of course can fail due to mismatch. This is the case when the user provides some input not matching the valid answers given. In this case the user is again asked to provide valid input. The test action will continue to ask for valid input until a valid answer is given.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
User inputs may not fit to automatic testing in terms of continuous integration testing where no user is present to type in the correct answer over the keyboard. In this case you can always skip the user input in advance by specifying a variable that matches the user input variable name. As the user input variable is then already present the user input is missed out and the test proceeds automatically.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="actions-load"><a class="anchor" href="#actions-load"></a><a class="link" href="#actions-load">8.18. Load Properties</a></h3>
<div class="paragraph">
<p>You are able to load properties from external property files and store them as test variables. The action will require a file resource either from class path or file system in order to read the property values.</p>
</div>
<div class="paragraph">
<p>Let us look at an example to get an idea about this action:</p>
</div>
<div class="listingblock">
<div class="title">Content of load.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">username=Mickey Mouse
greeting.text=Hello Test Framework</code></pre>
</div>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void loadPropertiesTest() {
    $(load().filePath("file:tests/resources/load.properties"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="LoadPropertiesTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;load&gt;
            &lt;properties file="file:tests/resources/load.properties"/&gt;
        &lt;/load&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: LoadPropertiesTest
actions:
  - load:
      properties:
        file: "file:tests/resources/load.properties"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="LoadPropertiesTest"&gt;
        &lt;actions&gt;
            &lt;load&gt;
                &lt;properties file="file:tests/resources/load.properties"/&gt;
            &lt;/load&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Current value of variable username = Mickey Mouse
Current value of variable greeting.text = Hello Test Framework</code></pre>
</div>
</div>
<div class="paragraph">
<p>The action will load all available properties in the file load.properties and store them to the test case as local variables.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Please be aware of the fact that existing variables are overwritten!
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="actions-purging-jms-destinations"><a class="anchor" href="#actions-purging-jms-destinations"></a><a class="link" href="#actions-purging-jms-destinations">8.19. Purging JMS destinations</a></h3>
<div class="paragraph">
<p>Purging JMS destinations during the test run is quite essential. Different test cases can influence each other when sending messages to the same JMS destinations. A test case should only receive those messages that actually belong to it.</p>
</div>
<div class="paragraph">
<p>Therefore, it is a good idea to purge all JMS queue destinations between the test cases. Obsolete messages that are stuck in a JMS queue for some reason are then removed so that the following test case is not offended.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
@Qualifier("connectionFactory")
private ConnectionFactory connectionFactory;

@CitrusTest
public void purgeJmsQueuesTest() {
    $(purgeQueues()
        .connectionFactory(connectionFactory)
        .queue("JMS.Queue.1")
        .queue("JMS.Queue.2")
        .queue("JMS.Queue.3")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="PurgeJmsQueuesTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;purge-jms-queues connection-factory="connectionFactory"&gt;
            &lt;queue name="JMS.Queue.1"/&gt;
            &lt;queue name="JMS.Queue.2"/&gt;
            &lt;queue name="JMS.Queue.3"/&gt;
        &lt;/purge-jms-queues&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: PurgeJmsQueuesTest
actions:
  - purge-queues:
      connection-factory: "connectionFactory"
      queues:
        - "JMS.Queue.1"
        - "JMS.Queue.2"
        - "JMS.Queue.3"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="purgeJmsQueuesTest"&gt;
      &lt;actions&gt;
          &lt;jms:purge-jms-queues connection-factory="connectionFactory"&gt;
              &lt;jms:queue name="JMS.Queue.1"/&gt;
              &lt;jms:queue name="JMS.Queue.2"/&gt;
              &lt;jms:queue name="JMS.Queue.3"/&gt;
          &lt;/jms:purge-jms-queues&gt;
      &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Citrus provides special support for JMS related features when using the Spring XML bean integration. You have to activate those JMS features in our test case by adding a special "jms" namespace and schema definition location to the test case XML.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
        xmlns:spring="http://www.springframework.org/schema/beans"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:jms="http://www.citrusframework.org/schema/jms/testcase"
        xsi:schemaLocation="
            http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.citrusframework.org/schema/testcase
            http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
            http://www.citrusframework.org/schema/jms/testcase
            http://www.citrusframework.org/schema/jms/testcase/citrus-jms-testcase.xsd"&gt;

    [...]

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that we have referenced the <strong>jms</strong> namespace when using the <strong>purge-jms-queues</strong> test action.</p>
</div>
<div class="paragraph">
<p>Purging the JMS queues in every test case is quite exhausting because every test case needs to define a purging action at the very beginning of the test. Fortunately the test suite definition offers tasks to run before, between and after the test cases which should ease up these tasks a lot. The test suite offers a very simple way to purge the destinations between the tests. See <a href="#before-suite">testsuite-before-test</a> for more information about this.</p>
</div>
<div class="paragraph">
<p>As you can see in the next example it is quite easy to specify a group of destinations in the Spring configuration that get purged before a test is executed.</p>
</div>
<div class="listingblock primary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SequenceBeforeTest beforeTest() {
    return SequenceBeforeTest.Builder.beforeTest()
            .actions(
                purgeQueues()
                    .queue("fooChannel")
                    .queue("barChannel")
            );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns:spring="http://www.springframework.org/schema/beans"
              xmlns:citrus="http://www.citrusframework.org/schema/config"&gt;
    &lt;citrus:before-test id="purgeBeforeTest"&gt;
        &lt;citrus:actions&gt;
            &lt;jms:purge-jms-queues&gt;
                &lt;jms:queue name="fooChannel"/&gt;
                &lt;jms:queue name="barChannel"/&gt;
            &lt;/jms:purge-jms-queues&gt;
        &lt;/citrus:actions&gt;
    &lt;/citrus:before-test&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please keep in mind that the JMS related configuration components in Citrus belong to a separate XML namespace <strong>jms:</strong> . We have to add this namespace declaration to each test case XML and Spring bean XML configuration file as described at the very beginning of this section.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The syntax for purging the destinations is the same as we used it inside the test case. So now we are able to purge JMS destinations with given destination names. But sometimes we do not want to rely on queue or topic names as we retrieve destinations over JNDI for instance. We can deal with destinations coming from JNDI lookup like follows:</p>
</div>
<div class="listingblock">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;jee:jndi-lookup id="jmsQueueHelloRequestIn" jndi-name="jms/jmsQueueHelloRequestIn"/&gt;
&lt;jee:jndi-lookup id="jmsQueueHelloResponseOut" jndi-name="jms/jmsQueueHelloResponseOut"/&gt;

&lt;citrus:before-test id="purgeBeforeTest"&gt;
    &lt;citrus:actions&gt;
        &lt;jms:purge-jms-queues&gt;
            &lt;jms:queue ref="jmsQueueHelloRequestIn"/&gt;
            &lt;jms:queue ref="jmsQueueHelloResponseOut"/&gt;
        &lt;/jms:purge-jms-queues&gt;
    &lt;/citrus:actions&gt;
&lt;/citrus:before-test&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We just use the attribute <strong>'ref'</strong> instead of <strong>'name'</strong> and Citrus is looking for a bean reference for that identifier that resolves to a JMS destination. You can use the JNDI bean references inside a test case, too.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
@Qualifier("jmsQueue1")
private Queue jmsQueue1;

@Autowired
@Qualifier("jmsQueue2")
private Queue jmsQueue2;

@CitrusTest
public void purgeJmsQueuesTest() {
    $(purgeQueues()
        .queue(jmsQueue1)
        .queue(jmsQueue1)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="PurgeJmsQueuesTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;purge-jms-queues&gt;
            &lt;queue ref="jmsQueue1"/&gt;
            &lt;queue ref="jmsQueue2"/&gt;
        &lt;/purge-jms-queues&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: PurgeJmsQueuesTest
actions:
  - purge-queues:
      queue: jmsQueue1
  - purge-queues:
      queue: jmsQueue2</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="purgeJmsQueuesTest"&gt;
      &lt;actions&gt;
          &lt;jms:purge-jms-queues&gt;
              &lt;jms:queue ref="jmsQueue1"/&gt;
              &lt;jms:queue ref="jmsQueue2"/&gt;
          &lt;/jms:purge-jms-queues&gt;
      &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course you can use queue object references also in Java DSL test cases. Here we easily can use Spring&#8217;s dependency injection with autowiring to get the object references from the IoC container.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can mix queue name and queue object references as you like within one single purge queue test action.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="actions-purging-message-channels"><a class="anchor" href="#actions-purging-message-channels"></a><a class="link" href="#actions-purging-message-channels">8.20. Purging Spring Message Channels</a></h3>
<div class="paragraph">
<p>The Spring Integration project defines message channels as a central messaging destination.
These are in-memory message queues holding messages for test cases.
Messages that are queued on a channel may become obsolete during a test run, especially when test cases fail and stop in their message consumption.
Purging these message channel destinations is essential in these scenarios in order to avoid bad influence on upcoming test cases.
Each test case should only receive those messages that actually refer to the test model.
Therefore, it is a good idea to purge all message channel destinations between the test cases.
Obsolete messages that get stuck in a message channel destination for some reason are then removed so that upcoming test case are not broken.</p>
</div>
<div class="paragraph">
<p>Following action definition purges all messages from a list of message channels:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
@Qualifier("someChannelName")
private MessageChannel someChannel;

@Autowired
@Qualifier("anotherChannelName")
private MessageChannel anotherChannel;

@CitrusTest
public void purgeChannelTest() {
    $(purgeChannels()
        .channelResolver(channelResolver)
        .channelNames("someChannelName", "anotherChannelName")
    );

    $(purgeChannels()
        .channels(someChannel, anotherChannel)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="PurgeChannelTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;purge-channels channel-resolver="channelResolver"&gt;
            &lt;channel name="someChannelName"/&gt;
            &lt;channel name="anotherChannelName"/&gt;
        &lt;/purge-channels&gt;

        &lt;purge-channels&gt;
            &lt;channel ref="someChannel"/&gt;
            &lt;channel ref="anotherChannel"/&gt;
        &lt;/purge-channels&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: PurgeChannelTest
actions:
  - purge-channels:
      channel-resolver: "channelResolver"
      channels:
        - "someChannelName"
        - "anotherChannelName"
  - purge-channels:
      channel: someChannel
  - purge-channels:
      channel: anotherChannel</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="PurgeChannelTest"&gt;
      &lt;actions&gt;
          &lt;purge-channel&gt;
              &lt;channel name="someChannelName"/&gt;
              &lt;channel name="anotherChannelName"/&gt;
          &lt;/purge-channel&gt;

          &lt;purge-channel&gt;
              &lt;channel ref="someChannel"/&gt;
              &lt;channel ref="anotherChannel"/&gt;
          &lt;/purge-channel&gt;
      &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the test action supports channel names as well as channel references to Spring bean instances.
When using channel references you refer to the bean id or name in your application context.</p>
</div>
<div class="paragraph">
<p>The channel resolver reference is optional and points to a channel resolver that is used to resolve names to actual channel instances.
By default, Citrus will automatically use a Spring application context channel resolver, so you just have to use the respective Spring bean names that are configured in the Spring application context.
However, setting a custom channel resolver may be adequate for you in some special cases.</p>
</div>
<div class="paragraph">
<p>Message selectors enable you to selectively remove messages from the destination.
All messages that pass the message selection logic get deleted the other messages will remain unchanged inside the channel destination. The message selector is a Spring bean that implements a special message selector interface. A possible implementation could be a selector deleting all messages that are older than five seconds:</p>
</div>
<div class="listingblock">
<div class="title">Message selector implementation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.springframework.messaging.Message;
import org.springframework.integration.core.MessageSelector;

public class TimeBasedMessageSelector implements MessageSelector {

    public boolean accept(Message&lt;?&gt; message) {
        if (System.currentTimeMillis() - message.getHeaders().getTimestamp() &gt; 5000) {
            return false;
        } else {
            return true;
        }
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The message selector returns <strong>false</strong> for those messages that should be deleted from the channel!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You simply define the message selector as a new Spring bean in the Citrus application context and reference it in your test action property.</p>
</div>
<div class="listingblock primary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public MessageSelector specialMessageSelector() {
    return new TimeBasedMessageSelector();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="specialMessageSelector"
    class="org.citrusframework.special.TimeBasedMessageSelector"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let us have a look at how you reference the selector in your test case:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void purgeChannelTest() {
    $(purgeChannels()
        .selector(specialMessageSelector)
        .channels(someChannel, anotherChannel)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="PurgeChannelTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;purge-channels message-selector="specialMessageSelector"&gt;
            &lt;channel ref="someChannel"/&gt;
            &lt;channel ref="anotherChannel"/&gt;
        &lt;/purge-channels&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: PurgeChannelTest
actions:
  - purge-channels:
      message-selector: "specialMessageSelector"
      channels:
        - "someChannel"
        - "anotherChannel"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;purge-channel message-selector="specialMessageSelector"&gt;
  &lt;channel ref="someChannel"/&gt;
  &lt;channel red="anotherChannel"/&gt;
&lt;/purge-channel&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the examples above we use a message selector implementation that gets injected via Spring IoC container.</p>
</div>
<div class="paragraph">
<p>Purging channels in each test case every time is quite exhausting because every test case needs to define a purging action at the very beginning of the test. A more straight forward approach would be to introduce some purging action which is automatically executed before each test. Fortunately the Citrus test suite offers a very simple way to do this. It is described in <a href="#before-suite">testsuite-before-test</a>.</p>
</div>
<div class="paragraph">
<p>When using the special action sequence before test cases we are able to purge channel destinations every time a test case executes. See the upcoming example to find out how the action is defined in the Spring configuration application context.</p>
</div>
<div class="listingblock primary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SequenceBeforeTest beforeTest() {
    return SequenceBeforeTest.Builder.beforeTest()
            .actions(
                purgeChannels()
                    .channel("fooChannel")
                    .channel("barChannel")
            );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns:spring="http://www.springframework.org/schema/beans"
              xmlns:citrus="http://www.citrusframework.org/schema/config"&gt;
    &lt;citrus:before-test id="purgeBeforeTest"&gt;
        &lt;citrus:actions&gt;
            &lt;purge-channel&gt;
                &lt;channel name="fooChannel"/&gt;
                &lt;channel name="barChannel"/&gt;
            &lt;/purge-channel&gt;
        &lt;/citrus:actions&gt;
    &lt;/citrus:before-test&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just use this before-test bean in the Spring bean application context and the purge channel action is active. Obsolete messages that are waiting on the message channels for consumption are purged before the next test in line is executed.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Purging message channels becomes also very interesting when working with server instances in Citrus. Each server component automatically has an inbound message channel where incoming messages are stored internally. So if you need to clean up a server that has already stored some incoming messages you can do this easily by purging the internal message channel. The message channel follows a naming convention <strong>{serverName}.inbound</strong> where <strong>{serverName}</strong> is the Spring bean name of the Citrus server endpoint component. If you purge this internal channel in a before test nature you are sure that obsolete messages on a server instance get purged before each test is executed.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="actions-purging-endpoints"><a class="anchor" href="#actions-purging-endpoints"></a><a class="link" href="#actions-purging-endpoints">8.21. Purging endpoints</a></h3>
<div class="paragraph">
<p>Citrus works with message endpoints when sending and receiving messages.
In general endpoints can also queue messages.
This is especially the case when using JMS message endpoints or any server endpoint component in Citrus.
These are in-memory message queues holding messages for test cases.
The enqueued messages may become obsolete during a test run, especially when a test case that would consume the messages fails.</p>
</div>
<div class="paragraph">
<p>Deleting all messages from a message endpoint is therefore a useful task and is essential in such scenarios so that upcoming test cases are not influenced.
Each test case should only receive those messages that actually refer to the test model.
Therefore it is a good idea to purge all message endpoint destinations between the test cases.
Obsolete messages that get stuck in a message endpoint destination for some reason are then removed so that upcoming test case are not broken.</p>
</div>
<div class="paragraph">
<p>Following action definition purges all messages from a list of message endpoints:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
@Qualifier("someEndpointName")
private DirectEndpoint someEndpoint;

@Autowired
@Qualifier("anotherEndpointName")
private DirectEndpoint anotherEndpoint;

@CitrusTest
public void purgeEndpointTest() {
    $(purgeEndpoints()
        .endpointNames("someEndpointName", "anotherEndpointName")
    );

    $(purgeEndpoints()
        .endpoints(someEndpoint, anotherEndpoint)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="PurgeEndpointTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;purge-endpoint&gt;
            &lt;endpoint name="someChannelName"/&gt;
            &lt;endpoint name="anotherChannelName"/&gt;
        &lt;/purge-endpoint&gt;

        &lt;purge-endpoint&gt;
            &lt;endpoint ref="someChannel"/&gt;
            &lt;endpoint ref="anotherChannel"/&gt;
        &lt;/purge-endpoint&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: PurgeEndpointTest
actions:
  - purge:
      endpoints:
        - name: "someEndpointName"
        - name: "anotherEndpointName"
  - purge:
      endpoints:
        - ref: someEndpoint
        - ref: anotherEndpoint</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="purgeEndpointTest"&gt;
      &lt;actions&gt;
          &lt;purge-endpoint&gt;
              &lt;endpoint name="someEndpointName"/&gt;
              &lt;endpoint name="anotherEndpointName"/&gt;
          &lt;/purge-endpoint&gt;

          &lt;purge-endpoint&gt;
              &lt;endpoint ref="someEndpoint"/&gt;
              &lt;endpoint ref="anotherEndpoint"/&gt;
          &lt;/purge-endpoint&gt;
      &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the test action supports endpoint names as well as endpoint references to Spring bean instances. When using endpoint references you refer to the Spring bean name in your application context.</p>
</div>
<div class="paragraph">
<p>When using the Java DSL we can inject endpoint objects with Spring bean container IoC.</p>
</div>
<div class="paragraph">
<p>Message selectors enable you to selectively remove messages from an endpoint. All messages that meet the message selector condition get deleted and the other messages remain inside the endpoint destination. The message selector is either a normal String name-value representation or a map of key value pairs:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void purgeEndpointTest() {
    $(purgeEndpoints()
        .selector("operation = 'sayHello'")
        .endpoints(someEndpoint, anotherEndpoint)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="PurgeEndpointTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;purge-endpoint&gt;
            &lt;selector&gt;
                &lt;value&gt;operation = 'sayHello'&lt;/value&gt;
            &lt;/selector&gt;
            &lt;endpoint ref="someEndpoint"/&gt;
            &lt;endpoint ref="anotherEndpoint"/&gt;
        &lt;/purge-endpoint&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: PurgeEndpointTest
actions:
  - purge-endpoints:
      selector:
        value: "operation = 'sayHello'"
      endpoints:
        - "someEndpoint"
        - "anotherEndpoint"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;purge-endpoints&gt;
  &lt;selector&gt;
    &lt;value&gt;operation = 'sayHello'&lt;/value&gt;
  &lt;/selector&gt;
  &lt;endpoint name="someEndpointName"/&gt;
  &lt;endpoint name="anotherEndpointName"/&gt;
&lt;/purge-endpoints&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the examples above we use a String to represent the message selector expression. In general the message selector operates on the message header. So following on from that we remove all messages selectively that have a message header <strong>operation</strong> with its value <strong>sayHello</strong> .</p>
</div>
<div class="paragraph">
<p>Purging endpoints in each test case every time is quite exhausting because every test case needs to define a purging action at the very beginning of the test. A more straight forward approach would be to introduce some purging action which is automatically executed before each test. Fortunately the Citrus test suite offers a very simple way to do this. It is described in <a href="#before-suite">testsuite-before-test</a>.</p>
</div>
<div class="paragraph">
<p>When using the special action sequence before test cases we are able to purge endpoint destinations every time a test case executes. See the upcoming example to find out how the action is defined in the Spring configuration application context.</p>
</div>
<div class="listingblock primary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SequenceBeforeTest beforeTest() {
    return SequenceBeforeTest.Builder.beforeTest()
            .actions(
                purgeEndpoints()
                    .endpoint("fooChannel")
                    .endpoint("barChannel")
            );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns:spring="http://www.springframework.org/schema/beans"
              xmlns:citrus="http://www.citrusframework.org/schema/config"&gt;
    &lt;citrus:before-test id="purgeBeforeTest"&gt;
        &lt;citrus:actions&gt;
            &lt;purge-endpoints&gt;
                &lt;channel name="fooChannel"/&gt;
                &lt;channel name="barChannel"/&gt;
            &lt;/purge-endpoints&gt;
        &lt;/citrus:actions&gt;
    &lt;/citrus:before-test&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just use this before-test bean in the Spring bean application context and the purge endpoint action is active. Obsolete messages that are waiting on the message endpoints for consumption are purged before the next test in line is executed.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Purging message endpoints becomes also very interesting when working with server instances in Citrus. Each server component automatically has an inbound message endpoint where incoming messages are stored too internally. Citrus will automatically use this incoming message endpoint as target for the purge action so you can just use the server instance as you know it from your configuration in any purge action.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="actions-assert-failure"><a class="anchor" href="#actions-assert-failure"></a><a class="link" href="#actions-assert-failure">8.22. Assert failure</a></h3>
<div class="paragraph">
<p>Citrus test actions fail with Java exceptions and error messages.
This gives you the opportunity to expect an action to fail during test execution.
You can simply assert a Java exception to be thrown during execution. See the example for an assert action definition in a test case:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void assertFailureTest() {
    $(assertException()
            .exception(org.citrusframework.exceptions.CitrusRuntimeException.class)
            .message("Unknown variable ${date}")
            .when(
                echo().message("Current date is: ${date}")
            )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="AssertFailureTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;assert exception="org.citrusframework.exceptions.CitrusRuntimeException"
                message="Unknown variable ${date}"&gt;
            &lt;when&gt;
                &lt;echo&gt;
                    &lt;message&gt;Current date is: ${date}&lt;/message&gt;
                &lt;/echo&gt;
            &lt;/when&gt;
        &lt;/assert&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "AssertFailureTest"
actions:
  - assert:
      exception: "org.citrusframework.exceptions.CitrusRuntimeException"
      message: 'Unknown variable ${date}'
      when:
        - echo:
            message: 'Current date is: ${date}'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="AssertFailureTest"&gt;
        &lt;actions&gt;
            &lt;assert exception="org.citrusframework.exceptions.CitrusRuntimeException"
                    message="Unknown variable ${date}"&gt;
                &lt;when&gt;
                    &lt;echo&gt;
                        &lt;message&gt;Current date is: ${date}&lt;/message&gt;
                    &lt;/echo&gt;
                &lt;/when&gt;
            &lt;/assert&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that the assert action requires an exception.
In case no exception is thrown by the embedded test action the assertion and the test case will fail!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The assert action always wraps a single test action, which is then monitored for failure.
In case the nested test action fails with error you can validate the error in its type and error message (optional).
The failure has to fit the expected one exactly otherwise the assertion fails itself.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Important to notice is the fact that asserted exceptions do not cause failure of the test case.
As you expect the failure to happen the test continues with its work once the assertion is done successfully.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="actions-catch-exceptions"><a class="anchor" href="#actions-catch-exceptions"></a><a class="link" href="#actions-catch-exceptions">8.23. Catch exceptions</a></h3>
<div class="paragraph">
<p>In the previous chapter we have seen how to expect failures in Citrus with assert action.
Now the assert action is designed for single actions to be monitored and for failures to be expected in any case.
The <strong>'catch'</strong> action in contrary can hold several nested test actions and exception failure is optional.</p>
</div>
<div class="paragraph">
<p>The nested actions are error proof for the chosen exception type.
This means possible exceptions are caught and ignored - the test case will not fail for this exception type.
But only for this particular exception type! Other exception types that occur during execution do cause the test to fail as usual.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void catchFailureTest() {
    $(catchException()
        .exception(CitrusRuntimeException.class)
        .when(
            echo().message("Current date is: ${date}")
        );
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CatchFailureTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;catch exception="org.citrusframework.exceptions.CitrusRuntimeException"&gt;
            &lt;when&gt;
                &lt;echo&gt;
                    &lt;message&gt;Current date is: ${date}&lt;/message&gt;
                &lt;/echo&gt;
            &lt;/when&gt;
        &lt;/assert&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "CatchFailureTest"
actions:
  - catch:
      exception: "org.citrusframework.exceptions.CitrusRuntimeException"
      when:
        - echo:
            message: 'Current date is: ${date}'</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="catchExceptionTest"&gt;
        &lt;actions&gt;
            &lt;catch exception="org.citrusframework.exceptions.CitrusRuntimeException"&gt;
                &lt;echo&gt;
                    &lt;message&gt;Current date is: ${date}&lt;/message&gt;
                &lt;/echo&gt;
            &lt;/catch&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Note that there is no validation available in a catch block.
So catching exceptions is just to make a test more stable towards errors that can occur.
The caught exception does not cause any failure in the test.
The test case may continue with execution as if there was no failure.
Also notice that the catch action is also happy when no exception at all is raised.
In contrary to that the assert action requires the exception and an assert action is failing in positive processing.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Catching exceptions like this may only fit to very error-prone action blocks where failures do not harm the test case success.
Otherwise, a failure in a test action should always reflect to the whole test case to fail with errors.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Java developers might ask why not use try-catch Java block instead?
The answer is simple yet very important to understand.
The test method is called by the Java DSL test case builder for building the Citrus test.
This can be referred to as the design time of the test.
After the building test method was processed the test gets executed, which can be called the runtime of the test.
This means that a try-catch block within the design time method will never perform during the test run.
The only reliable way to add the catch capability to the test as part of the test case runtime is to use the Citrus test action which gets executed during test runtime.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="actions-ant-build"><a class="anchor" href="#actions-ant-build"></a><a class="link" href="#actions-ant-build">8.24. Apache Ant build</a></h3>
<div class="paragraph">
<p>The &lt;ant&gt; action loads a build.xml Ant file and executes one or more targets in the Ant project. The target is executed with optional build properties passed to the Ant run. The Ant build output is logged with Citrus logger and the test case success is bound to the Ant build success. This means in case the Ant build fails for some reason the test case will also fail with build exception accordingly.</p>
</div>
<div class="paragraph">
<p>See this basic Ant run example to see how it works within your test case:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void antRunTest() {
    variable("today", "citrus:currentDate()");

    $(antrun()
        .buildFilePath("classpath:org/citrusframework/actions/build.xml")
        .target("sayHello")
        .property("date", "${today}")
        .property("welcomeText", "$Hello!"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="AntRunTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;variables&gt;
        &lt;variable name="today" value="citrus:currentDate()"/&gt;
    &lt;/variables&gt;
    &lt;actions&gt;
        &lt;ant build-file="classpath:org/citrusframework/actions/build.xml"&gt;
            &lt;execute target="sayHello"/&gt;
            &lt;properties&gt;
                &lt;property name="date" value="${today}"/&gt;
                &lt;property name="welcomeText" value="Hello!"/&gt;
            &lt;/properties&gt;
        &lt;/ant&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: AntRunTest
variables:
  - name: "today"
    value: "citrus:currentDate()"
actions:
  - ant:
      build-file: "classpath:org/citrusframework/actions/build.xml"
      execute:
        target: "sayHello"
      properties:
        - name: "date"
          value: "${today}"
        - name: "welcomeText"
          value: "Hello!"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="AntRunTest"&gt;
        &lt;variables&gt;
            &lt;variable name="today" value="citrus:currentDate()"/&gt;
        &lt;/variables&gt;
        &lt;actions&gt;
            &lt;ant build-file="classpath:org/citrusframework/actions/build.xml"&gt;
                &lt;execute target="sayHello"/&gt;
                &lt;properties&gt;
                    &lt;property name="date" value="${today}"/&gt;
                    &lt;property name="welcomeText" value="Hello!"/&gt;
                &lt;/properties&gt;
            &lt;/ant&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The respective build.xml Ant file must provide the target to call. For example:</p>
</div>
<div class="listingblock">
<div class="title">build.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;project name="citrus-build" default="sayHello"&gt;
    &lt;property name="welcomeText" value="Welcome to Citrus!"&gt;&lt;/property&gt;

    &lt;target name="sayHello"&gt;
        &lt;echo message="${welcomeText} - Today is ${date}"&gt;&lt;/echo&gt;
    &lt;/target&gt;

    &lt;target name="sayGoodbye"&gt;
        &lt;echo message="Goodbye everybody!"&gt;&lt;/echo&gt;
    &lt;/target&gt;
&lt;/project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see you can pass custom build properties to the Ant build execution. Existing Ant build properties are replaced and you can use the properties in your build file as usual.</p>
</div>
<div class="paragraph">
<p>You can also call multiple targets within one single build run by using a comma separated list of target names:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void antRunTest() {
    variable("today", "citrus:currentDate()");

    $(antrun()
        .buildFilePath("classpath:org/citrusframework/actions/build.xml")
        .targets("sayHello", "sayGoodbye")
        .property("date", "${today}"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="AntRunTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;variables&gt;
        &lt;variable name="today" value="citrus:currentDate()"/&gt;
    &lt;/variables&gt;
    &lt;actions&gt;
        &lt;ant build-file="classpath:org/citrusframework/actions/build.xml"&gt;
            &lt;execute targets="sayHello,sayGoodbye"/&gt;
            &lt;properties&gt;
                &lt;property name="date" value="${today}"/&gt;
            &lt;/properties&gt;
        &lt;/ant&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: AntRunTest
variables:
  - name: "today"
    value: "citrus:currentDate()"
actions:
  - ant:
      build-file: "classpath:org/citrusframework/actions/build.xml"
      execute:
        targets: "sayHello,sayGoodbye"
      properties:
        - name: "date"
          value: "${today}"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="AntRunTest"&gt;
        &lt;variables&gt;
            &lt;variable name="today" value="citrus:currentDate()"/&gt;
        &lt;/variables&gt;
        &lt;actions&gt;
            &lt;ant build-file="classpath:org/citrusframework/actions/build.xml"&gt;
                &lt;execute targets="sayHello,sayGoodbye"/&gt;
                &lt;properties&gt;
                    &lt;property name="date" value="${today}"/&gt;
                &lt;/properties&gt;
            &lt;/ant&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The build properties can live in external file resource as an alternative to the inline property definitions. You just have to use the respective file resource path and all nested properties get loaded as build properties.</p>
</div>
<div class="paragraph">
<p>In addition to that you can also define a custom build listener. The build listener must implement the Ant API interface <strong>org.apache.tools.ant.BuildListener</strong> . During the Ant build run the build listener is called with several callback methods (e.g. buildStarted(), buildFinished(), targetStarted(), targetFinished(), …). This is how you can add additional logic to the Ant build run from Citrus. A custom build listener could manage the fail state of your test case, in particular by raising some exception forcing the test case to fail accordingly.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
private BuildListener customBuildListener;

@CitrusTest
public void antRunTest() {
    $(antrun()
        .buildFilePath("classpath:org/citrusframework/actions/build.xml")
        .target("sayHello")
        .propertyFile("classpath:org/citrusframework/actions/build.properties")
        .listener(customBuildListener))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="AntRunTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;ant build-file="classpath:org/citrusframework/actions/build.xml"
             build-listener="customBuildListener"&gt;
            &lt;execute target="sayHello"/&gt;
            &lt;properties  file="classpath:org/citrusframework/actions/build.properties" /&gt;
        &lt;/ant&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: AntRunTest
actions:
  - ant:
      build-file: "classpath:org/citrusframework/actions/build.xml"
      build-listener: "customBuildListener"
      execute:
        target: "sayHello"
      properties-file: "classpath:org/citrusframework/actions/build.properties"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="AntRunTest"&gt;
        &lt;actions&gt;
            &lt;ant build-file="classpath:org/citrusframework/actions/build.xml"
                 build-listener="customBuildListener"&gt;
                &lt;execute target="sayHello"/&gt;
                &lt;properties file="classpath:org/citrusframework/actions/build.properties"/&gt;
            &lt;/ant&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>customBuildListener</strong> used in the example above should reference a Spring bean in the Citrus application context. The bean implements the interface <strong>org.apache.tools.ant.BuildListener</strong> and controls the Ant build run.</p>
</div>
</div>
<div class="sect2">
<h3 id="actions-start-stop"><a class="anchor" href="#actions-start-stop"></a><a class="link" href="#actions-start-stop">8.25. Start/Stop server</a></h3>
<div class="paragraph">
<p>Citrus is working with server components that are started and stopped within a test run. This can be a Http server or some SMTP mail server for instance. Usually the Citrus server components are automatically started when Citrus is starting and respectively stopped when Citrus is shutting down. Sometimes it might be helpful to explicitly start and stop a server instance within your test case. Here you can use special start and stop test actions inside your test. This is a good way to test downtime scenarios of interface partners with respective error handling when connections to servers are lost</p>
</div>
<div class="paragraph">
<p>Let me explain with a simple sample test case:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
@Qualifier("myMailServer")
private MailServer myMailServer;

@CitrusTest
public void manageServerTest() {
    $(start()
        .server(myMailServer));

    $(sequential()
        .actions(...)); // do something

    $(stop()
        .server(myMailServer));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ManageServerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;start server="myMailServer"/&gt;

        &lt;sequential&gt;
            &lt;!-- do something --&gt;
        &lt;/sequential&gt;

        &lt;stop server="myMailServer"/&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ManageServerTest
actions:
  - start:
      server: "myMailServer"
  - sequential:
      actions: {}
  - stop:
      server: "myMailServer"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="manageServerTest"&gt;
        &lt;actions&gt;
            &lt;start server="myMailServer"/&gt;

            &lt;sequential&gt;
                &lt;!-- do something --&gt;
            &lt;/sequential&gt;

            &lt;stop server="myMailServer"/&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The start and stop server test action receive a server name which references a Spring bean component of type <strong>org.citrusframework.server.Server</strong> in your basic Spring application context. The server instance is started or stopped within the test case. As you can see in the next listing we can also start and stop multiple server instances within a single test action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
@Qualifier("myMailServer")
private MailServer myMailServer;

@Autowired
@Qualifier("myFtpServer")
private FtpServer myFtpServer;

@CitrusTest
public void manageServerTest() {
    $(start()
        .server(myMailServer, myFtpServer));

    $(sequential()
        .actions(...)); // do something

    $(stop()
        .server(myMailServer, myFtpServer));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ManageServerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;start&gt;
            &lt;servers&gt;
                &lt;server name="myMailServer"/&gt;
                &lt;server name="myFtpServer"/&gt;
            &lt;/servers&gt;
        &lt;/start&gt;

        &lt;sequential&gt;
            &lt;!-- do something --&gt;
        &lt;/sequential&gt;

        &lt;stop&gt;
            &lt;servers&gt;
                &lt;server name="myMailServer"/&gt;
                &lt;server name="myFtpServer"/&gt;
            &lt;/servers&gt;
        &lt;/stop&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ManageServerTest
actions:
  - start:
      servers:
        - "myMailServer"
        - "myFtpServer"
  - sequential:
      actions: {}
  - stop:
      servers:
        - "myMailServer"
        - "myFtpServer"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="manageServerTest"&gt;
        &lt;actions&gt;
            &lt;start&gt;
                &lt;servers&gt;
                    &lt;server name="myMailServer"/&gt;
                    &lt;server name="myFtpServer"/&gt;
                &lt;/servers&gt;
            &lt;/start&gt;

            &lt;sequential&gt;
                &lt;!-- do something --&gt;
            &lt;/sequential&gt;

            &lt;stop&gt;
                &lt;servers&gt;
                    &lt;server name="myMailServer"/&gt;
                    &lt;server name="myFtpServer"/&gt;
                &lt;/servers&gt;
            &lt;/stop&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using the Java DSL the best way to reference a server instance is to autowire the Spring bean via dependency injection. The Spring framework takes care of injecting the proper Spring bean component defined in the Spring application context. This way you can easily start and stop server instances within Java DSL test cases.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Starting and stopping server instances is a synchronous test action. This means that your test case is waiting for the server to start before other test actions take place. Startup times and shut down of server instances may delay your test accordingly.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you can see starting and stopping Citrus server instances is very easy. You can also write your own server implementations by implementing the interface <strong>org.citrusframework.server.Server</strong>. All custom server implementations can then be started and stopped during a test case.</p>
</div>
</div>
<div class="sect2">
<h3 id="actions-stop-timer"><a class="anchor" href="#actions-stop-timer"></a><a class="link" href="#actions-stop-timer">8.26. Stop Timer</a></h3>
<div class="paragraph">
<p>The &lt;stop-timer&gt; action can be used for stopping either a specific timer (<a href="#containers-timer">containers-timer</a>) or all timers running within a test. This action is useful when timers are started in the background (using parallel or fork=true) and you wish to stop these timers at the end of the test. Some examples of using this action are provided below:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void timerTest() {
    $(timer()
      .id("forkedTimer")
      .fork(true)
      .actions(sleep(50L))
    );

    $(timer()
      .fork(true)
      .actions(sleep(50L))
    );

    $(timer()
      .repeatCount(5)
      .actions(sleep(50L))
    );

    $(stopTimer("forkedTimer"));

    $(doFinally().actions(
      stopTimer()
    ));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="TimerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;timer id="forkedTimer" fork="true"&gt;
            &lt;actions&gt;
                &lt;sleep milliseconds="50" /&gt;
            &lt;/actions&gt;
        &lt;/timer&gt;

        &lt;timer fork="true"&gt;
            &lt;actions&gt;
                &lt;sleep milliseconds="50" /&gt;
            &lt;/actions&gt;
        &lt;/timer&gt;

        &lt;timer repeatCount="5"&gt;
            &lt;actions&gt;
                &lt;sleep milliseconds="50" /&gt;
            &lt;/actions&gt;
        &lt;/timer&gt;

        &lt;stop-timer id="forkedTimer" /&gt;
    &lt;/actions&gt;

    &lt;finally&gt;
        &lt;stop-timer/&gt;
    &lt;/finally&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: TimerTest
actions:
  - timer:
      id: "forkedTimer"
      fork: true
      actions:
        - sleep:
            milliseconds: "50"
  - timer:
      fork: true
      actions:
        - sleep:
            milliseconds: "50"
  - timer:
      repeatCount: 5
      actions:
        - sleep:
            milliseconds: "50"
  - stop-timer:
      id: "forkedTimer"
finally:
  - stop-timer: {}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="TimerTest"&gt;
        &lt;actions&gt;
            &lt;timer id="forkedTimer" fork="true"&gt;
                &lt;sleep milliseconds="50" /&gt;
            &lt;/timer&gt;

            &lt;timer fork="true"&gt;
                &lt;sleep milliseconds="50" /&gt;
            &lt;/timer&gt;

            &lt;timer repeatCount="5"&gt;
                &lt;sleep milliseconds="50" /&gt;
            &lt;/timer&gt;

            &lt;stop-timer timerId="forkedTimer" /&gt;
        &lt;/actions&gt;

        &lt;finally&gt;
            &lt;stop-timer/&gt;
        &lt;/finally&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example 3 timers are started, the first 2 in the background and the third in the test execution thread. Timer #3 has a repeatCount set to 5 so it will terminate automatically after 5 runs. Timer #1 and #2 however have no repeatCount set so they will execute until they are told to stop.</p>
</div>
<div class="paragraph">
<p>Timer #1 is stopped explicitly using the first stopTimer action. Here the stopTimer action includes the name of the timer to stop. This is convenient when you wish to terminate a specific timer. However since no timerId was set for timer #2, you can terminate this (and all other timers) using the 'stopTimer' action with no explicit timerId set.</p>
</div>
</div>
<div class="sect2">
<h3 id="actions-custom"><a class="anchor" href="#actions-custom"></a><a class="link" href="#actions-custom">8.27. Custom action</a></h3>
<div class="paragraph">
<p>Now we have a look at the opportunity to add custom test actions to the test case flow. Let us start this section with an example:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void actionReferenceTest() {
    $(action().reference("clearDatabase"));
    $(action().reference("mySpecialAction"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ActionReferenceTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;action reference="clearDatabase"/&gt;
        &lt;action reference="mySpecialAction"/&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ActionReferenceTest
actions:
  - action:
      ref: "clearDatabase"
  - action:
      ref: "mySpecialAction"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="ActionReferenceTest"&gt;
        &lt;actions&gt;
            &lt;action reference="clearDatabase"/&gt;
            &lt;action reference="mySpecialAction"/&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generic &lt;action&gt; element references Spring beans that implement the Java interface <strong><em>org.citrusframework.TestAction</em></strong> . This is a very fast way to add your own action implementations to a Citrus test case. This way you can easily implement your own actions in Java and include them into the test case.</p>
</div>
<div class="paragraph">
<p>In the example above the called actions are special database cleanup implementations. The actions are defined as Spring beans in the Citrus configuration and get referenced by their bean name or id.</p>
</div>
<div class="listingblock primary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SpecialDatabaseCleanupAction clearDatabase(DataSource ds) {
    return new SpecialDatabaseCleanupAction(ds);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="clearDatabase" class="my.domain.citrus.actions.SpecialDatabaseCleanupAction"&gt;
    &lt;constructor-arg ref="myDataSource"/&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Spring application context holds your custom bean implementations. You can set properties and use the full Spring power while implementing your custom test action in Java. Let us have a look on how such a Java class may look like.</p>
</div>
<div class="listingblock">
<div class="title">SpecialDatabaseCleanupAction</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.actions.AbstractTestAction;
import org.citrusframework.context.TestContext;

public class SpecialDatabaseCleanupAction extends AbstractTestAction {

    @Autowired
    private DataSource dataSource;

    @Override
    public void doExecute(TestContext context) {
        JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);

        jdbcTemplate.execute("...");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All you need to do in your Java class is to implement the Citrus <strong><em>org.citrusframework.TestAction</em></strong> interface. The abstract class <strong><em>org.citrusframework.actions.AbstractTestAction</em></strong> may help you to start with your custom test action implementation as it provides basic method implementations so you just have to implement the <strong><em>doExecute()</em></strong> method.</p>
</div>
<div class="paragraph">
<p>When using the Java test case DSL you are also quite comfortable with including your custom test actions.</p>
</div>
<div class="listingblock">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
private SpecialDatabaseCleanupAction clearDatabaseAction;

@CitrusTest
public void actionReferenceTest() {
    $(echo().message("Now let's include our special test action"));

    $(clearDatabaseAction);

    $(echo().message("That's it!"));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using anonymous class uses as Lambda expression is also possible.</p>
</div>
<div class="listingblock">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void genericActionTest() {
    $(echo().message("Now let's call our special test action anonymously"));

    $(context -&gt; {
        // do something
    });

    $(echo().message("That's it!"));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test action receives a single argument <code>context</code> which represent the <code>org.citrusframework.context.TestContext</code>. The context provides access to test variables and shared components resolvable via reference resolver API.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="containers"><a class="anchor" href="#containers"></a><a class="link" href="#containers">9. Containers</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Similar to templates a container element holds one to many test actions. In contrast to the template the container appears directly inside the test case action chain, meaning that the container is not referenced by more than one test case.</p>
</div>
<div class="paragraph">
<p>Containers execute the embedded test actions in specific logic. This can be an execution in iteration for instance. Combine different containers with each other and you will be able to generate very powerful hierarchical structures in order to create a complex execution logic. In the following sections some predefined containers are described.</p>
</div>
<div class="sect2">
<h3 id="containers-sequential"><a class="anchor" href="#containers-sequential"></a><a class="link" href="#containers-sequential">9.1. Sequential</a></h3>
<div class="paragraph">
<p>The sequential container executes the embedded test actions in strict sequence. Readers now might search for the difference to the normal action chain that is specified inside the test case. The actual power of sequential containers does show only in combination with other containers like iterations and parallels. We will see this later when handling these containers.</p>
</div>
<div class="paragraph">
<p>For now the sequential container seems not very sensational - one might say boring - because it simply groups a pair of test actions to sequential execution.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sequentialTest() {
    $(sequential()
        .actions(
            sleep().seconds(1),
            echo("Hello Citrus!")
        )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SequentialTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;sequential&gt;
            &lt;actions&gt;
                &lt;sleep seconds="1"/&gt;
                &lt;echo&gt;
                    &lt;message&gt;Hello Citrus!&lt;/message&gt;
                &lt;/echo&gt;
            &lt;/actions&gt;
        &lt;/sequential&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SequentialTest
actions:
  - sequential:
      actions:
        - sleep:
            seconds: 1
        - echo:
            message: "Hello Citrus!"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="SequentialTest"&gt;
        &lt;actions&gt;
            &lt;sequential&gt;
                &lt;sleep seconds="1"/&gt;
                &lt;echo&gt;
                    &lt;message&gt;Hello Citrus!&lt;/message&gt;
                &lt;/echo&gt;
            &lt;/sequential&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="containers-conditional"><a class="anchor" href="#containers-conditional"></a><a class="link" href="#containers-conditional">9.2. Conditional</a></h3>
<div class="paragraph">
<p>Now we deal with conditional executions of test actions. Nested actions inside a conditional container are executed only in case a boolean expression evaluates to true. Otherwise the container execution is not performed at all.</p>
</div>
<div class="paragraph">
<p>See some example to find out how it works with the conditional expression string.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void conditionalTest() {
    variable("index", 5);
    variable("shouldSleep", true);

    $(conditional().when("${index} = 5")
        .actions(
            sleep(10000L)
        )
    );

    $(conditional().when("${shouldSleep}")
        .actions(
            sleep(10000L)
        )
    );

    $(conditional().when("${shouldSleep}", anyOf(is("true"), isEmptyString()))
        .actions(
            sleep(10000L)
        )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ConditionalTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;variables&gt;
      &lt;variable name="index" value="5"/&gt;
      &lt;variable name="shouldSleep" value="true"/&gt;
    &lt;/variables&gt;

    &lt;actions&gt;
        &lt;conditional when="${index} = 5"&gt;
            &lt;actions&gt;
                &lt;sleep seconds="10"/&gt;
            &lt;/actions&gt;
        &lt;/conditional&gt;

        &lt;conditional when="${shouldSleep}"&gt;
            &lt;actions&gt;
                &lt;sleep seconds="10"/&gt;
            &lt;/actions&gt;
        &lt;/conditional&gt;

        &lt;conditional when="@assertThat('${shouldSleep}', 'anyOf(is(true), isEmptyString())')@"&gt;
            &lt;actions&gt;
                &lt;sleep seconds="10"/&gt;
            &lt;/actions&gt;
        &lt;/conditional&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ConditionalTest
variables:
  - name: "index"
    value: 5
  - name: "shouldSleep"
    value: true

actions:
  - conditional:
      when: '${index} = 5'
      actions:
        - sleep:
            seconds: 10
  - conditional:
      when: '${shouldSleep}'
      actions:
        - sleep:
            seconds: 10
  - conditional:
      when: '@assertThat("${shouldSleep}", "anyOf(is(true), isEmptyString())")@'
      actions:
        - sleep:
            seconds: 10</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="ConditionalTest"&gt;
        &lt;variables&gt;
          &lt;variable name="index" value="5"/&gt;
          &lt;variable name="shouldSleep" value="true"/&gt;
        &lt;/variables&gt;

        &lt;actions&gt;
            &lt;conditional expression="${index} = 5"&gt;
                &lt;sleep seconds="10"/&gt;
            &lt;/conditional&gt;

            &lt;conditional expression="${shouldSleep}"&gt;
                &lt;sleep seconds="10"/&gt;
            &lt;/conditional&gt;

            &lt;conditional expression="@assertThat('${shouldSleep}', 'anyOf(is(true), isEmptyString())')@"&gt;
                &lt;sleep seconds="10"/&gt;
            &lt;/conditional&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The nested sleep action is executed in case the variable ${index} is equal to the value '5'. This conditional execution of test actions is useful when dealing with different test environments such as different operating systems for instance. The conditional container also supports expressions that evaluate to the character sequence "true" or "false" as shown in the ${shouldSleep} example.</p>
</div>
<div class="paragraph">
<p>The last conditional container in the example above makes use of Hamcrest matchers. The matcher evaluates to <strong>true</strong> or <strong>false</strong> and based on that the container actions are executed or skipped. The Hamcrest matchers are very powerful when it comes to evaluation of multiple conditions at a time.</p>
</div>
</div>
<div class="sect2">
<h3 id="containers-parallel"><a class="anchor" href="#containers-parallel"></a><a class="link" href="#containers-parallel">9.3. Parallel</a></h3>
<div class="paragraph">
<p>Parallel containers execute embedded test actions concurrently to each other. Every action in this container will be
executed in a separate Java thread. The following example should clarify the usage:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void parallelTest() {
    $(parallel()
        .actions(
            sleep(),
            sequential().actions(
                sleep(),
                echo("1")
            ),
            echo("2"),
            echo("3"),
            iterate().condition("i lt= 5").index("i"))
                .actions(
                    echo("10")
                )
        )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ParallelTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;parallel&gt;
            &lt;actions&gt;
                &lt;sleep/&gt;

                &lt;sequential&gt;
                    &lt;actions&gt;
                        &lt;sleep/&gt;
                        &lt;echo&gt;
                            &lt;message&gt;1&lt;/message&gt;
                        &lt;/echo&gt;
                    &lt;/actions&gt;
                &lt;/sequential&gt;

                &lt;echo&gt;
                    &lt;message&gt;2&lt;/message&gt;
                &lt;/echo&gt;

                &lt;echo&gt;
                    &lt;message&gt;3&lt;/message&gt;
                &lt;/echo&gt;

                &lt;iterate condition="i lt= 5"
                            index="i"&gt;
                    &lt;actions&gt;
                        &lt;echo&gt;
                            &lt;message&gt;10&lt;/message&gt;
                        &lt;/echo&gt;
                    &lt;/actions&gt;
                &lt;/iterate&gt;
            &lt;/actions&gt;
        &lt;/parallel&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ParallelTest
actions:
  - parallel:
      actions:
        - sleep: {}
        - sequential:
            actions:
              - sleep: {}
              - echo:
                  message: "1"
        - echo:
            message: "2"
        - echo:
            message: "3"
        - iterate:
            index: "i"
            condition: "i lt 5"
            actions:
              - echo:
                  message: "10"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="ParallelTest"&gt;
        &lt;actions&gt;
            &lt;parallel&gt;
                &lt;sleep/&gt;

                &lt;sequential&gt;
                    &lt;sleep/&gt;
                    &lt;echo&gt;
                        &lt;message&gt;1&lt;/message&gt;
                    &lt;/echo&gt;
                &lt;/sequential&gt;

                &lt;echo&gt;
                    &lt;message&gt;2&lt;/message&gt;
                &lt;/echo&gt;

                &lt;echo&gt;
                    &lt;message&gt;3&lt;/message&gt;
                &lt;/echo&gt;

                &lt;iterate condition="i lt= 5"
                            index="i"&gt;
                    &lt;echo&gt;
                        &lt;message&gt;10&lt;/message&gt;
                    &lt;/echo&gt;
                &lt;/iterate&gt;
            &lt;/parallel&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, test actions are processed and executed one action after another.
Since the first action is a sleep of five seconds, the whole test would stop and wait for 5 seconds.
Things are different inside the parallel container.
Here, the descending test actions will not wait, but execute at the same time.</p>
</div>
<div class="paragraph">
<p>If you are using this container to send or receive messages, you have to use the unique correlation ID of the message to link the actions concerning this message.
Otherwise, the testcase might associate a send or receive action with the wrong message.
Please note that this ID is <strong>not</strong> passed to your system under test.
The management of correlation IDs as well as the assignment to messages is done internally.
Only the mapping between the request and response has to be done by the author of the test.
As you can see in the following example, the value of the header <code>MessageHeaders.ID</code> is stored in the variable <code>request#1</code> respectively <code>request#2</code>.
This variable is reused in the <code>receive</code> action to identify the correct response from the server.</p>
</div>
<div class="listingblock">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void paralletTest() {

    $(parallel()
        .actions(
            sequential()
                .actions(
                    http().client(httpClient)
                            .send()
                            .post("/foo")
                            .extract(extract().fromHeaders().header(MessageHeaders.ID, "request#1")
                            .payload("{ \"info\": \"foo\"}"),

                    //SUT echoing the input

                    http().client(httpClient)
                            .receive()
                            .response(HttpStatus.OK.value())
                            .payload("{ \"info\": \"foo\"}")
                            .selector(
                                Collections.singletonMap(
                                    MessageHeaders.ID, "${request#1}"))
                ),

            sequential()
                .actions(
                    http().client(httpClient)
                         .send()
                         .post("/boo")
                         .extract(extract().fromHeaders().header(MessageHeaders.ID, "request#2")
                         .payload("{ \"info\": \"boo\"}"),

                    //SUT echoing the input

                    http().client(httpClient)
                         .receive()
                         .response(HttpStatus.OK.value())
                         .payload("{ \"info\": \"boo\"}")
                         .selector(
                            Collections.singletonMap(
                                MessageHeaders.ID, "${request#2}"))
                )
        )
    );
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Containers can easily wrap other containers.
The example shows a simple combination of sequential and parallel containers that will achieve more complex execution logic.
Actions inside the sequential container will execute one after another.
But actions in parallel will be executed at the same time.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="containers-iterate"><a class="anchor" href="#containers-iterate"></a><a class="link" href="#containers-iterate">9.4. Iterate</a></h3>
<div class="paragraph">
<p>Iterations are very powerful elements when describing complex logic. The container executes the embedded actions several times. The container will continue with looping as long as the defined breaking condition string evaluates to <strong><em>true</em></strong> . In case the condition evaluates to <strong><em>false</em></strong> the iteration will break and finish execution.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void iterateTest() {
    $(iterate().condition("i lt 5").index("i")
        .actions(
            echo().message("index is: ${i}")
        )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="IterateTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;iterate index="i" condition="i lt 5"&gt;
            &lt;actions&gt;
                &lt;echo&gt;
                    &lt;message&gt;index is: ${i}&lt;/message&gt;
                &lt;/echo&gt;
            &lt;/actions&gt;
        &lt;/iterate&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: IterateTest
actions:
  - iterate:
      index: "i"
      condition: "i lt 5"
      actions:
        - echo:
            message: "index is: ${i}"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="IterateTest"&gt;
        &lt;actions&gt;
            &lt;iterate index="i" condition="i lt 5"&gt;
                &lt;echo&gt;
                    &lt;message&gt;index is: ${i}&lt;/message&gt;
                &lt;/echo&gt;
            &lt;/iterate&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The attribute "index" automatically defines a new variable that holds the actual loop index starting at "1". This index variable is available as a normal variable inside the iterate container. Therefore it is possible to print out the actual loop index in the echo action as shown in the above example.</p>
</div>
<div class="paragraph">
<p>The condition string is mandatory and describes the actual end of the loop.
In iterate containers the loop will break in case the condition evaluates to <strong><em>false</em></strong>.</p>
</div>
<div class="paragraph">
<p>The condition string can be any Boolean expression and supports several operators:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
lt
</td>
<td class="hdlist2">
<p>lower than</p>
</td>
</tr>
<tr>
<td class="hdlist1">
lt=
</td>
<td class="hdlist2">
<p>lower than equals</p>
</td>
</tr>
<tr>
<td class="hdlist1">
gt
</td>
<td class="hdlist2">
<p>greater than</p>
</td>
</tr>
<tr>
<td class="hdlist1">
gt=
</td>
<td class="hdlist2">
<p>greater than equals</p>
</td>
</tr>
<tr>
<td class="hdlist1">
=
</td>
<td class="hdlist2">
<p>equals</p>
</td>
</tr>
<tr>
<td class="hdlist1">
and
</td>
<td class="hdlist2">
<p>logical combining of two Boolean values</p>
</td>
</tr>
<tr>
<td class="hdlist1">
or
</td>
<td class="hdlist2">
<p>logical combining of two Boolean values</p>
</td>
</tr>
<tr>
<td class="hdlist1">
()
</td>
<td class="hdlist2">
<p>brackets</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is very important to notice that the condition is evaluated before the very first iteration takes place. The loop therefore can be executed 0-n times according to the condition value.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now the boolean expression evaluation as described above is limited to very basic operation such as <strong>lower than</strong>, <strong>greater than</strong> and so on. We also can use Hamcrest matchers in conditions that are way more powerful than that.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void iterateTest() {
    $(iterate().condition(assertThat(lessThan(5)).index("i"))
        .actions(
            echo().message("index is: ${i}")
        )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="IterateTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;iterate index="i" condition="@assertThat(lessThan(5))@"&gt;
            &lt;actions&gt;
                &lt;echo&gt;
                    &lt;message&gt;index is: ${i}&lt;/message&gt;
                &lt;/echo&gt;
            &lt;/actions&gt;
        &lt;/iterate&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: IterateTest
actions:
  - iterate:
      index: "i"
      condition: "@assertThat(lessThan(5))@"
      actions:
        - echo:
            message: "index is: ${i}"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="IterateTest"&gt;
        &lt;actions&gt;
            &lt;iterate index="i" condition="@assertThat(lessThan(5))@"&gt;
                &lt;echo&gt;
                    &lt;message&gt;index is: ${i}&lt;/message&gt;
                &lt;/echo&gt;
            &lt;/iterate&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above we use Hamcrest matchers as a condition expression.
In Java you may use the <code>org.citrusframework.container.HamcrestConditionExpression.assertThat(org.hamcrest.Matcher&lt;?&gt;)</code> method.
This way you can combine Hamcrest matchers and create very powerful condition evaluations here.</p>
</div>
<div class="paragraph">
<p>The Hamcrest expression evaluation in Citrus gets added with this module:</p>
</div>
<div class="listingblock">
<div class="title">citrus-validation-hamcrest Module</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
    &lt;artifactId&gt;citrus-validation-hamcrest&lt;/artifactId&gt;
    &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You need to add this module to your project accordingly when using the Hamcrest matcher support.</p>
</div>
</div>
<div class="sect2">
<h3 id="containers-repeat"><a class="anchor" href="#containers-repeat"></a><a class="link" href="#containers-repeat">9.5. Repeat</a></h3>
<div class="paragraph">
<p>Quite similar to the previously described iterate container this repeating container will execute its actions in a loop according to an ending condition. The condition describes a Boolean expression using the operators as described in the previous chapter.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The loop continues its work until the provided condition evaluates to <strong>true</strong> . It is very important to notice that the repeat loop will execute the actions before evaluating the condition. This means the actions get executed <code>n-1</code> times.
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void repeatTest() {
    $(repeat().until("(i gt 5) or (i = 3)").index("i")
        .actions(
            echo("index is: ${i}")
        )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="RepeatTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;repeat index="i" until="(i = 3) or (i = 5)"&gt;
            &lt;actions&gt;
                &lt;echo&gt;
                    &lt;message&gt;index is: ${i}&lt;/message&gt;
                &lt;/echo&gt;
            &lt;/actions&gt;
        &lt;/repeat&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: RepeatTest
actions:
  - repeat:
      index: "i"
      until: "(i = 3) or (i = 5)"
      actions:
        - echo:
            message: "index is: ${i}"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="RepeatTest"&gt;
        &lt;actions&gt;
            &lt;repeat-until-true index="i" condition="(i = 3) or (i = 5)"&gt;
                &lt;echo&gt;
                    &lt;message&gt;index is: ${i}&lt;/message&gt;
                &lt;/echo&gt;
            &lt;/repeat-until-true&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the repeat container is only executed when the iterating condition expression evaluates to <strong>false</strong> . By the time the condition is <strong>true</strong> execution is discontinued. You can use basic logical operators such as <strong>and</strong>, <strong>or</strong> and so on.</p>
</div>
<div class="paragraph">
<p>A more powerful way is given by Hamcrest matchers that are directly supported in condition expressions.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void repeatTest() {
    $(repeat().until(assertThat(anyOf(is(3), is(5))).index("i")
        .actions(
            echo("index is: ${i}")
        )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="RepeatTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;repeat index="i" until="@assertThat(anyOf(is(3), is(5))@"&gt;
            &lt;actions&gt;
                &lt;echo&gt;
                    &lt;message&gt;index is: ${i}&lt;/message&gt;
                &lt;/echo&gt;
            &lt;/actions&gt;
        &lt;/repeat&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: RepeatTest
actions:
  - repeat:
      index: "i"
      until: "@assertThat(anyOf(is(3), is(5))@"
      actions:
        - echo:
            message: "index is: ${i}"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="RepeatTest"&gt;
        &lt;actions&gt;
            &lt;repeat-until-true index="i" condition="@assertThat(anyOf(is(3), is(5))@"&gt;
                &lt;echo&gt;
                    &lt;message&gt;index is: ${i}&lt;/message&gt;
                &lt;/echo&gt;
            &lt;/repeat-until-true&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Hamcrest matcher usage simplifies the reading a lot.
In addition to that it empowers you to combine more complex condition expressions.
In Java you may use the <code>org.citrusframework.container.HamcrestConditionExpression.assertThat(org.hamcrest.Matcher&lt;?&gt;)</code> method.</p>
</div>
<div class="paragraph">
<p>The Hamcrest expression evaluation in Citrus gets added with this module:</p>
</div>
<div class="listingblock">
<div class="title">citrus-validation-hamcrest Module</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
    &lt;artifactId&gt;citrus-validation-hamcrest&lt;/artifactId&gt;
    &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You need to add this module to your project accordingly when using the Hamcrest matcher support.</p>
</div>
</div>
<div class="sect2">
<h3 id="containers-repeat-on-error"><a class="anchor" href="#containers-repeat-on-error"></a><a class="link" href="#containers-repeat-on-error">9.6. Repeat on error</a></h3>
<div class="paragraph">
<p>The next looping container is called repeat-on-error-until-true. This container repeats a group of actions in case one embedded action failed with error. In case of an error inside the container the loop will try to execute <strong><em>all</em></strong> embedded actions again in order to seek for overall success. The execution continues until all embedded actions were processed successfully <strong><em>or</em></strong> the ending condition evaluates to true and the error-loop will lead to final failure.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void repeatOnErrorTest() {
    $(repeatOnError().until("i = 5").index("i")
        .actions(
            echo().message("index is: ${i}"),
            fail().message("Force loop to fail!")
        )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="RepeatOnErrorTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;repeat-on-error index="i" until="i = 5"&gt;
            &lt;actions&gt;
                &lt;echo&gt;
                    &lt;message&gt;index is: ${i}&lt;/message&gt;
                &lt;/echo&gt;
                &lt;fail message="Force loop to fail!"/&gt;
            &lt;/actions&gt;
        &lt;/repeat-on-error&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: RepeatOnErrorTest
actions:
  - repeat-on-error:
      index: "i"
      until: "i = 5"
      actions:
        - echo:
            message: "index is: ${i}"
        - fail:
            message: "Force loop to fail!"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="RepeatOnErrorTest"&gt;
        &lt;actions&gt;
            &lt;repeat-onerror-until-true index="i" condition="i = 5"&gt;
                &lt;echo&gt;
                    &lt;message&gt;index is: ${i}&lt;/message&gt;
                &lt;/echo&gt;
                &lt;fail message="Force loop to fail!"/&gt;
            &lt;/repeat-onerror-until-true&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the code example the error-loop continues four times as the &lt;fail&gt; action definitely fails the test. During the fifth iteration the condition "i=5" evaluates to true and the loop breaks its processing leading to a final failure as the test actions were not successful.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The overall success of the test case depends on the error situation inside the repeat-onerror-until-true container. In case the loop breaks because of failing actions and the loop will discontinue its work the whole test case is failing too. The error loop processing is successful in case all embedded actions were not raising any errors during an iteration.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The repeat-on-error container also offers an automatic sleep mechanism. This auto-sleep property will force the container to wait a given amount of time before executing the next iteration. We used this mechanism a lot when validating database entries. Let&#8217;s say we want to check the existence of an order entry in the database. Unfortunately the system under test is not very well performing and may need some time to store the new order. This amount of time is not predictable, especially when dealing with different hardware on our test environments (local testing vs. server testing). Following from that our test case may fail unpredictably only because of runtime conditions.</p>
</div>
<div class="paragraph">
<p>We can avoid unstable test cases that are based on these runtime conditions with the auto-sleep functionality.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void repeatOnErrorTest() {
    $(repeatOnError().until("i = 5").index("i").autoSleep(1000)
        .actions(
            sql()
                .dataSource(testDataSource)
                .query()
                .statement("""
                    SELECT COUNT(1) AS CNT_ORDERS
                    FROM ORDERS
                    WHERE CUSTOMER_ID='${customerId}'
                """)
                .validate("CNT_ORDERS", 1)
        )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="RepeatOnErrorTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;repeat-on-error auto-sleep="1000" until="i = 5" index="i"&gt;
            &lt;actions&gt;
                &lt;sql datasource="testDataSource"&gt;
                    &lt;statements&gt;
                        &lt;statement&gt;
                          SELECT COUNT(1) AS CNT_ORDERS
                          FROM ORDERS
                          WHERE CUSTOMER_ID='${customerId}'
                        &lt;/statement&gt;
                    &lt;/statements&gt;
                    &lt;validate column="CNT_ORDERS" value="1"/&gt;
                &lt;/sql&gt;
            &lt;/actions&gt;
        &lt;/repeat-on-error&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: RepeatOnErrorTest
actions:
  - repeat-on-error:
      index: "i"
      until: "i = 5"
      auto-sleep: 1000
      actions:
        - sql:
            dataSource: "testDataSource"
            statements:
              - statement: |
                  SELECT COUNT(1) AS CNT_ORDERS
                  FROM ORDERS
                  WHERE CUSTOMER_ID='${customerId}'
            validate:
              - column: "CNT_ORDERS"
                value: 1</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="RepeatOnErrorTest"&gt;
        &lt;actions&gt;
            &lt;repeat-onerror-until-true auto-sleep="1000" condition="i = 5" index="i"&gt;
                &lt;sql datasource="testDataSource"&gt;
                    &lt;statement&gt;
                      SELECT COUNT(1) AS CNT_ORDERS
                      FROM ORDERS
                      WHERE CUSTOMER_ID='${customerId}'
                    &lt;/statement&gt;
                    &lt;validate column="CNT_ORDERS" value="1"/&gt;
                &lt;/sql&gt;
            &lt;/repeat-onerror-until-true&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We surrounded the database check with a repeat-onerror container having the auto-sleep property set to 1000 milliseconds. The repeat container will try to check the database up to five times with an automatic sleep of 1 second before every iteration. This gives the system under test up to five seconds time to store the new entry to the database. The test case is very stable and just fits to the hardware environment. On slow test environments the test may need several iterations to successfully read the database entry. On very fast environments the test may succeed right on the first try.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
We changed auto sleep time from seconds to milliseconds with Citrus 2.0 release. So if you are coming from previous Citrus versions be sure to now use proper millisecond values.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So fast environments are not slowed down by static sleep operations and slower environments are still able to execute this test case with high stability.</p>
</div>
</div>
<div class="sect2">
<h3 id="containers-timer"><a class="anchor" href="#containers-timer"></a><a class="link" href="#containers-timer">9.7. Timer</a></h3>
<div class="paragraph">
<p>Timers are very useful containers when you wish to execute a collection of test actions several times at regular intervals. The timer component generates an event which in turn triggers the execution of the nested test actions associated with the timer. This can be useful in a number of test scenarios for example when Citrus needs to simulate a heart beat or if you are debugging a test and you wish to query the contents of the database, to mention just a few. The following code sample should demonstrate the power and flexibility of timers:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void timerTest() {
    $(timer()
        .id("forkedTimer")
        .interval(100L)
        .fork(true)
        .actions(
            echo()
                .message("I'm going to run in the background and let some other test actions run (nested action run ${forkedTimer-index} times)"),
            sleep().milliseconds(50L)
        )
    );

    $(timer()
        .repeatCount(3)
        .interval(100L)
        .delay(50L)
        .actions(
            sleep().milliseconds(50L),
            echo().message("I'm going to repeat this message 3 times before the next test actions are executed")
        )
    );

    $(echo()
        .message("Test almost complete. Make sure all timers running in the background are stopped")
    );

    $(doFinally().actions(
        stopTimer("forkedTimer")
    ));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="TimerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;timer id="forkedTimer" interval="100" fork="true"&gt;
            &lt;actions&gt;
                &lt;echo&gt;
                    &lt;message&gt;I'm going to run in the background and let some other test actions run (nested action run ${forkedTimer-index} times)&lt;/message&gt;
                &lt;/echo&gt;
                &lt;sleep milliseconds="50" /&gt;
            &lt;/actions&gt;
        &lt;/timer&gt;

        &lt;timer repeatCount="3" interval="100" delay="50"&gt;
            &lt;actions&gt;
                &lt;sleep milliseconds="50" /&gt;
                &lt;echo&gt;
                    &lt;message&gt;I'm going to repeat this message 3 times before the next test actions are executed&lt;/message&gt;
                &lt;/echo&gt;
            &lt;/actions&gt;
        &lt;/timer&gt;

        &lt;echo&gt;
          &lt;message&gt;Test almost complete. Make sure all timers running in the background are stopped&lt;/message&gt;
        &lt;/echo&gt;
    &lt;/actions&gt;

    &lt;finally&gt;
        &lt;stop-timer id="forkedTimer" /&gt;
    &lt;/finally&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: TimerTest
actions:
  - timer:
      id: forkedTimer
      fork: true
      delay: 5000
      interval: 100
      repeatCount: 1
      actions:
        - echo:
            message: |
              I'm going to run in the background and let some other test actions run (nested action run ${forkedTimer-index} times)
        - sleep:
            milliseconds: 50
  - timer:
      delay: 50
      interval: 100
      repeatCount: 3
      actions:
        - sleep:
            milliseconds: 50
        - echo:
            message: |
              I'm going to repeat this message 3 times before the next test actions are executed
  - echo:
      message: |
        Test almost complete. Make sure all timers running in the background are stopped
finally:
  - stop-timer:
      id: "forkedTimer"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="TimerTest"&gt;
        &lt;actions&gt;
            &lt;timer id="forkedTimer" interval="100" fork="true"&gt;
              &lt;echo&gt;
                &lt;message&gt;I'm going to run in the background and let some other test actions run (nested action run ${forkedTimer-index} times)&lt;/message&gt;
              &lt;/echo&gt;
              &lt;sleep milliseconds="50" /&gt;
            &lt;/timer&gt;

            &lt;timer repeatCount="3" interval="100" delay="50"&gt;
              &lt;sleep milliseconds="50" /&gt;
              &lt;echo&gt;
                &lt;message&gt;I'm going to repeat this message 3 times before the next test actions are executed&lt;/message&gt;
              &lt;/echo&gt;
            &lt;/timer&gt;

            &lt;echo&gt;
              &lt;message&gt;Test almost complete. Make sure all timers running in the background are stopped&lt;/message&gt;
            &lt;/echo&gt;
        &lt;/actions&gt;

        &lt;finally&gt;
            &lt;stop-timer timerId="forkedTimer" /&gt;
        &lt;/finally&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example the first timer (timerId = forkedTimer) is started in the background. By default timers are run in the current thread of execution but to start it in the background just use "fork=true". Every 100 milliseconds this timer emits an event which will result in the nested actions being executed. The nested 'echo' action outputs the number of times this timer has already been executed. It does this with the help of an 'index' variable, in this example ${forkedTimer-index}, which is named according to the timer <strong>id</strong> with the suffix '-index'. No limit is set on the number of times this timer should run so it will keep on running until either a nested test action fails or it is instructed to stop (more on this below).</p>
</div>
<div class="paragraph">
<p>The second timer is configured to run 3 times with a delay of 100 milliseconds between each iteration. Using the attribute 'delay' we can get the timer pause for 50 milliseconds before running the nested actions for the first time. The timer is configured to run in the current thread of execution so the last test action, the 'echo', has to wait for this timer to complete before it is executed.</p>
</div>
<div class="paragraph">
<p>So how do we tell the forked timer to stop running? If we forget to do this the timer will just execute indefinitely. To help us out here we can use the 'stop-timer' action. By adding this to the finally block we ensure that the timer will be stopped, even if some nested test action fails. We could have easily added it as a nested test action, to the forkedTimer for example, but if some other test action failed before the stop-timer was called, the timer would never stop.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can also configure timers to run in the background using the 'parallel' container, rather than setting the attribute 'fork' to true. Using parallel allows more fine-grained control of the test and has the added advantage that all errors generated from a nested timer action are visible to the test executer. If an error occurs within the timer then the test status is set to failed. Using fork=true an error causes the timer to stop executing, but the test status is not influenced by this error.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="containers-async"><a class="anchor" href="#containers-async"></a><a class="link" href="#containers-async">9.8. Async</a></h3>
<div class="paragraph">
<p>Now we deal with parallel execution of test actions. Nested actions inside an async container are executed in a separate
thread. This allows to continue test execution without having to wait for actions inside the async container to complete.
The test immediately continues to execute the next test actions, which will be executed in parallel to those actions inside
the async container.</p>
</div>
<div class="paragraph">
<p>This mechanism comes in handy when a test action should be forked to the rest of the test. In send operations we were
already able to achieve this by setting <code>fork="true"</code>. With async containers, we&#8217;re able to execute all
kinds of test actions asynchronous.</p>
</div>
<div class="paragraph">
<p>See some example to find out how it works.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void asyncTest() {
    $(async()
        .actions(
            send(fooEndpoint)
                .message(fooRequest()),
            receive(fooEndpoint)
                .message(fooResponse())
        )
    );

    $(echo().message("Continue with test"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="AsyncTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;async&gt;
            &lt;actions&gt;
                &lt;send endpoint="fooEndpoint"&gt;
                    &lt;message&gt;&lt;!-- ... --&gt;&lt;/message&gt;
                &lt;/send&gt;
                &lt;receive endpoint="fooEndpoint"&gt;
                    &lt;message&gt;&lt;!-- ... --&gt;&lt;/message&gt;
                &lt;/receive&gt;
            &lt;/actions&gt;
        &lt;/async&gt;

        &lt;echo&gt;
          &lt;message&gt;Continue with test&lt;/message&gt;
        &lt;/echo&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: AsyncTest
actions:
  - async:
      actions:
        - send:
            endpoint: "fooEndpoint"
            message: {}
        - receive:
            endpoint: "fooEndpoint"
            message: {}
  - echo:
      message: "Continue with test"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="AsyncTest"&gt;
        &lt;actions&gt;
            &lt;async&gt;
                &lt;actions&gt;
                    &lt;send endpoint="fooEndpoint"&gt;
                        &lt;message&gt;&lt;!-- ... --&gt;&lt;/message&gt;
                    &lt;/send&gt;
                    &lt;receive endpoint="fooEndpoint"&gt;
                        &lt;message&gt;&lt;!-- ... --&gt;&lt;/message&gt;
                    &lt;/receive&gt;
                &lt;/actions&gt;
            &lt;/async&gt;

            &lt;echo&gt;
              &lt;message&gt;Continue with test&lt;/message&gt;
            &lt;/echo&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The nested <code>send</code> and <code>receive</code> actions get executed in parallel to the other test actions in that test case.
So the test will not wait for these actions to finish before executing next actions.
Of course possible errors inside the async container will also cause the whole test case to fail.
And the test will definitely wait for all async actions to be finished before finishing the whole test case.
This safely lets us execute test actions in parallel to each other.</p>
</div>
<div class="paragraph">
<p>The async container also supports success and error callback actions.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void asyncTest() {
    $(async()
        .actions(
            send(fooEndpoint)
                .message(fooRequest()),
            receive(fooEndpoint)
                .message(fooResponse())
        )
        .successActions(
            echo().message("Success!")
        )
        .errorActions(
            echo().message("Error!")
        )
    );

    $(echo().message("Continue with test"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="AsyncTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;async&gt;
            &lt;actions&gt;
                &lt;send endpoint="fooEndpoint"&gt;
                    &lt;message&gt;&lt;!-- ... --&gt;&lt;/message&gt;
                &lt;/send&gt;
                &lt;receive endpoint="fooEndpoint"&gt;
                    &lt;message&gt;&lt;!-- ... --&gt;&lt;/message&gt;
                &lt;/receive&gt;
            &lt;/actions&gt;
            &lt;success&gt;
                &lt;echo&gt;&lt;message&gt;Success!&lt;/message&gt;&lt;/echo&gt;
            &lt;/success&gt;
            &lt;error&gt;
                &lt;echo&gt;&lt;message&gt;Failed!&lt;/message&gt;&lt;/echo&gt;
            &lt;/error&gt;
        &lt;/async&gt;

        &lt;echo&gt;
          &lt;message&gt;Continue with test&lt;/message&gt;
        &lt;/echo&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: AsyncTest
actions:
  - async:
      actions:
        - send:
            endpoint: "fooEndpoint"
            message: {}
        - receive:
            endpoint: "fooEndpoint"
            message: {}
      success:
        - echo:
            message: "Success!"
      error:
        - echo:
            message: "Error!"
  - echo:
      message: "Continue with test"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="AsyncTest"&gt;
        &lt;actions&gt;
            &lt;async&gt;
                &lt;actions&gt;
                    &lt;send endpoint="fooEndpoint"&gt;
                        &lt;message&gt;&lt;!-- ... --&gt;&lt;/message&gt;
                    &lt;/send&gt;
                    &lt;receive endpoint="fooEndpoint"&gt;
                        &lt;message&gt;&lt;!-- ... --&gt;&lt;/message&gt;
                    &lt;/receive&gt;
                &lt;/actions&gt;
                &lt;success&gt;
                    &lt;echo&gt;&lt;message&gt;Success!&lt;/message&gt;&lt;/echo&gt;
                &lt;/success&gt;
                &lt;error&gt;
                    &lt;echo&gt;&lt;message&gt;Failed!&lt;/message&gt;&lt;/echo&gt;
                &lt;/error&gt;
            &lt;/async&gt;

            &lt;echo&gt;
              &lt;message&gt;Continue with test&lt;/message&gt;
            &lt;/echo&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>So you can add test actions which are executed based on the async test actions outcome <code>success</code> or <code>error</code>.</p>
</div>
<div class="paragraph">
<p>If you are using this container to send or receive messages, you have to use the unique correlation ID of the message to link the actions concerning this message.
Otherwise the testcase might associate a <code>send</code> or <code>receive</code> action with the wrong message.
Please note that this ID is <strong>not</strong> provided to your system under test.
The management of correlation IDs as well as the assignment to messages is done internally.
Only the mapping between the request and response has to be done by the author of the test.
As you can see in the following example, the value of the header <code>MessageHeaders.ID</code> is stored in the variable <code>request#1</code> respectively <code>request#2</code>.
This variable is reused in the <code>receive</code> action to identify the correct response from the server.</p>
</div>
<div class="listingblock">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void testAsync() {

    $(async()
        .actions(
            http().client(httpClient)
                    .send()
                    .post("/foo")
                    .extract(extract().fromHeaders().header(MessageHeaders.ID, "request#1")
                    .payload("{ \"info\": \"foo\"}"),

            //SUT echoing the input

            http().client(httpClient)
                    .receive()
                    .response(HttpStatus.OK.value())
                    .payload("{ \"info\": \"foo\"}")
                    .selector(
                        Collections.singletonMap(
                            MessageHeaders.ID, "${request#1}"))
        )
    );

    $(async()
        .actions(
            http().client(httpClient)
                    .send()
                    .post("/boo")
                    .extract(extract().fromHeaders().header(MessageHeaders.ID, "request#2")
                    .payload("{ \"info\": \"boo\"}"),

            //SUT echoing the input

            http().client(httpClient)
                    .receive()
                    .response(HttpStatus.OK.value())
                    .payload("{ \"info\": \"boo\"}")
                    .selector(
                        Collections.singletonMap(
                            MessageHeaders.ID, "${request#2}"))
        )
    );
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="containers-wait"><a class="anchor" href="#containers-wait"></a><a class="link" href="#containers-wait">9.9. Wait</a></h3>
<div class="paragraph">
<p>With this action you can make your test wait until a certain condition is satisfied. The attribute <strong>seconds</strong> defines the amount of time to wait in seconds. You can also use the milliseconds attribute for a more fine grained time value. The attribute <strong>interval</strong> defines the amount of time to wait <strong>between</strong> each check. The interval is always specified as millisecond time interval.</p>
</div>
<div class="paragraph">
<p>If the check does not exceed within the defined overall waiting time then the test execution fails with an appropriate error message. There are different types of conditions to check.</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
http
</td>
<td class="hdlist2">
<p>This condition is based on an Http request call on a server endpoint. Citrus will wait until the Http response is as defined (e.g. Http 200 OK). This is useful when you want to wait for a server to start.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
file
</td>
<td class="hdlist2">
<p>This condition checks for the existence of a file on the local file system. Citrus will wait until the file is present.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
message
</td>
<td class="hdlist2">
<p>This condition checks for the existence of a message in the local message store of the current test case. Citrus will wait until the message with the given name is present.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
action
</td>
<td class="hdlist2">
<p>This condition executes another test action and checks for successful execution. Citrus will wait until the nested action is executed without any errors.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When should somebody use this action? This action is very useful when you want your test to wait for a certain event to occur before continuing with the test execution. For example if you wish that your test waits until a Docker container is started or for an application to create a log file before continuing, then use this action. You can also create your own condition statements
and bind it to the test action.</p>
</div>
<div class="sect3">
<h4 id="containers-wait-http"><a class="anchor" href="#containers-wait-http"></a><a class="link" href="#containers-wait-http">9.9.1. Http condition</a></h4>
<div class="paragraph">
<p>Next let us have a look at a simple example:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void waitTest() {
    $(waitFor()
        .time(Duration.ofMillis(10000))
        .interval(2000)
        .http()
            .url("http://sample.org/resource")
            .status(200)
            .timeout(2000);
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="WaitTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;wait-for timeout="10" interval="2000"&gt;
          &lt;http url="http://sample.org/resource" status="200" timeout="2000" /&gt;
        &lt;/wait-for&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: WaitTest
actions:
  - wait-for:
      timeout: "10"
      interval: "2000"
      http:
        url: path/to/resource/file.txt
        status: 200
        timeout: 2000</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="WaitTest"&gt;
        &lt;actions&gt;
            &lt;wait seconds="10" interval="2000"&gt;
              &lt;http url="http://sample.org/resource" status="200" timeout="2000" /&gt;
            &lt;/wait&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example waits for some Http server resource to be available with <strong>Http 200 OK</strong> response. Citrus will use <strong>HEAD</strong> request method by default. You can set the request method with the <strong>method</strong> attribute on the Http condition.</p>
</div>
</div>
<div class="sect3">
<h4 id="containers-wait-file"><a class="anchor" href="#containers-wait-file"></a><a class="link" href="#containers-wait-file">9.9.2. File condition</a></h4>
<div class="paragraph">
<p>Next let us have a look at the file condition usage:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void waitTest() {
    $(waitFor()
        .time(Duration.ofMillis(10000))
        .interval(2000)
        .file().path("path/to/resource/file.txt")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="WaitTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;wait-for timeout="10" interval="2000"&gt;
          &lt;file path="path/to/resource/file.txt" /&gt;
        &lt;/wait-for&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: WaitTest
actions:
  - wait-for:
      timeout: "10"
      interval: "2000"
      file:
        path: path/to/resource/file.txt</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="WaitTest"&gt;
        &lt;actions&gt;
            &lt;wait seconds="10" interval="2000"&gt;
              &lt;file path="path/to/resource/file.txt" /&gt;
            &lt;/wait&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus checks for the file to exist under the given path. Only if the file exists the test will continue with further test actions.</p>
</div>
</div>
<div class="sect3">
<h4 id="containers-wait-message"><a class="anchor" href="#containers-wait-message"></a><a class="link" href="#containers-wait-message">9.9.3. Message condition</a></h4>
<div class="paragraph">
<p>Next let us have a look at the message condition usage:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void waitTest() {
    $(waitFor()
        .time(Duration.ofMillis(10000))
        .interval(2000)
        .message().name("helloRequest")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="WaitTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;wait-for timeout="10" interval="2000"&gt;
          &lt;message name="helloRequest" /&gt;
        &lt;/wait-for&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: WaitTest
actions:
  - wait-for:
      timeout: "10"
      interval: "2000"
      message:
        name: "helloRequest"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="WaitTest"&gt;
        &lt;actions&gt;
            &lt;wait seconds="10" interval="2000"&gt;
              &lt;message name="helloRequest" /&gt;
            &lt;/wait&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus checks for the message with the name <strong>helloRequest</strong> in the local message store. Only if the message with the given name is found the test will continue with further test actions. The local message
store is automatically filled with all exchanged messages (send or receive) in a test case. The message names are defined in the respective send or receive operations in the test.</p>
</div>
</div>
<div class="sect3">
<h4 id="containers-wait-action"><a class="anchor" href="#containers-wait-action"></a><a class="link" href="#containers-wait-action">9.9.4. Action condition</a></h4>
<div class="paragraph">
<p>Now we would like to wait for some other test action to execute.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void waitTest() {
    $(waitFor()
        .time(Duration.ofMillis(10000))
        .interval(2000)
        .execution()
        .action(
            receive(jmsEndpoint)
                .message()
                .body("Wait for me!")
        )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="WaitTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;wait-for timeout="10" interval="2000"&gt;
          &lt;action&gt;
            &lt;receive endpoint="jmsEndpoint"&gt;
                &lt;message&gt;
                    &lt;body&gt;&lt;data&gt;Wait for me!&lt;/data&gt;&lt;/body&gt;
                &lt;/message&gt;
            &lt;/receive&gt;
          &lt;/action&gt;
        &lt;/wait-for&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: WaitTest
actions:
  - wait-for:
      timeout: "10"
      interval: "2000"
      action:
        receive:
          endpoint: "jmsEndpoint"
          message:
            body: |
              Wait for me!</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="WaitTest"&gt;
        &lt;actions&gt;
            &lt;wait seconds="10" interval="2000"&gt;
              &lt;action&gt;
                &lt;receive endpoint="jmsEndpoint"&gt;
                    &lt;message&gt;
                        &lt;payload&gt;Wait for me!&lt;/payload&gt;
                    &lt;/message&gt;
                &lt;/receive&gt;
              &lt;/action&gt;
            &lt;/wait&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can add any test action to the wait condition so you can execute any other action and wait for its success. This enables us to also use the full send and receive operations on other message transports.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="containers-custom"><a class="anchor" href="#containers-custom"></a><a class="link" href="#containers-custom">9.10. Custom containers</a></h3>
<div class="paragraph">
<p>In case you have a custom action container implementation you might also want to use it in Java DSL. The action containers are handled with special care in the Java DSL because they have nested actions. So when you call a test action container in the Java DSL you always have something like this:</p>
</div>
<div class="listingblock">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void containerTest() {
    $(echo("This echo is outside of the action container"));

    $(sequential()
        .actions(
            echo().message("Inside"),
            echo().message("Inside once more"),
            echo().message("And again: Inside!")
        )
    );

    $(echo().message("This echo is outside of the action container"));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the three nested actions are added to the action <strong>sequential</strong> container rather than to the test case itself although we are using the same action Java DSL methods outside the container. This mechanism is only working because Citrus is handling test action containers with special care.</p>
</div>
<div class="paragraph">
<p>A custom test action container implementation could look like this:</p>
</div>
<div class="listingblock">
<div class="title">Custom container implementation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class ReverseActionContainer extends AbstractActionContainer {
    @Override
    public void doExecute(TestContext context) {
        for (int i = getActions().size(); i &gt; 0; i--) {
            getActions().get(i-1).execute(context);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The container logic is very simple: The container executes the nested actions in reverse order. As already mentioned Citrus needs to take special care on all action containers when executing a Java DSL test. This is why you should not execute a custom test container implementation on your own.</p>
</div>
<div class="listingblock">
<div class="title">Run custom container</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void containerTest() {
    ReverseActionContainer reverseContainer = new ReverseActionContainer();
    reverseContainer.addTestActions(
        echo().message("Foo"),
        echo().message("Bar")
    );

    $(reverseContainer);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above custom container execution is going to fail with internal error as the Citrus Java DSL was not able to recognise the action container as it should be. Also the <strong>EchoAction</strong> instance creation is not very comfortable. Instead you can use a special container Java DSL syntax also with your custom container implementation:</p>
</div>
<div class="listingblock">
<div class="title">Generic container syntax</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void containerTest() {
    $(container(new ReverseActionContainer())
        .actions(
            echo("Foo"),
            echo("Bar")
        )
    );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The custom container implementation now works fine with the automatically nested echo actions. And we are able to use the usual Java DSL syntactic sugar for test actions like <strong>echo</strong> .</p>
</div>
<div class="paragraph">
<p>In a next step we add a custom superclass for all our test classes which provides a helper method for the custom container implementation in order to have an even more comfortable syntax.</p>
</div>
<div class="listingblock">
<div class="title">Container creating helper method</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public static AbstractTestContainerBuilder&lt;ReverseActionContainer&gt; reverse() {
    return container(new ReverseActionContainer());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now all subclasses can use the new <strong>reverse</strong> method for calling the custom container implementation.</p>
</div>
<div class="listingblock">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void containerTest() {
    $(reverse()
        .actions(
            echo().message("Foo"),
            echo().message("Bar")
        )
    );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nice! This is how we should integrate customized test action containers to the Citrus Java DSL.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="endpoints"><a class="anchor" href="#endpoints"></a><a class="link" href="#endpoints">10. Endpoints</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In one of the previous chapters we have discussed the basic test case structure as we introduced <strong>variables</strong> and <strong>test actions</strong>.
The &lt;actions&gt; section contains a list of test actions that take place during the test case. Each test action is executed in
sequential order by default. Citrus offers several built-in test actions that the user can choose from to construct a complex
testing workflow without having to code everything from scratch. In particular Citrus aims to provide all the test actions
that you need as predefined components ready for you to use. The goal is to minimize the coding effort for you so you can
concentrate on the test logic itself.</p>
</div>
<div class="paragraph">
<p>Exactly the same approach is used in Citrus to provide ready-to-use endpoint components for connecting to different message
transports. There are several ways in an enterprise application to exchange messages with some other application. We have
synchronous interfaces like Http and SOAP WebServices. We have asynchronous messaging with JMS or file transfer FTP interfaces.</p>
</div>
<div class="paragraph">
<p>Citrus provides endpoint components as client and server to connect with these typical message transports. So you as a tester
must not care about how to send a message to a JMS queue. The Citrus endpoints are configured in the Spring application context
and receive endpoint specific properties like endpoint uri or ports or message timeouts as configuration.</p>
</div>
<div class="paragraph">
<p>The next figure shows a typical message sending endpoint component in Citrus:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/figure_002.jpg" alt="figure_002.jpg"></span></p>
</div>
<div class="paragraph">
<p>The endpoint producer publishes messages to a destination. This destination can be a JMS queue/topic, a SOAP WebService
endpoint, an Http URL, an FTP folder destination and so on. The producer just takes a previously defined message definition
(header and body) and sends it to the message destination.</p>
</div>
<div class="paragraph">
<p>Similar to that Citrus defines several endpoint consumer components to consume messages from destinations. This can be
a simple subscription on message channels and JMS queues/topics. In case of SOAP WebServices and Http GET/POST things are
more complicated as we have to provide a server component that clients can connect to. We will handle server related communication
in more detail later on. For now the endpoint consumer component in its most simple way is defined like this:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/figure_003.jpg" alt="figure_003.jpg"></span></p>
</div>
<div class="paragraph">
<p>This is all you need to know about Citrus endpoints. We have mentioned that the endpoints are defined in the Spring application
context. Let&#8217;s have a simple example that shows the basic idea:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public JmsEndpoint helloEndpoint() {
    return new JmsEndpointBuilder()
            .destinationName("Citrus.HelloService.Request.Queue")
            .connectionFactory(myConnectionFactory())
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmsEndpoint helloEndpoint() {
    return new JmsEndpointBuilder()
            .destinationName("Citrus.HelloService.Request.Queue")
            .connectionFactory(myConnectionFactory())
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-jms="http://www.citrusframework.org/schema/jms/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/jms/config
           http://www.citrusframework.org/schema/jms/config/citrus-jms-config.xsd"&gt;

    &lt;citrus-jms:endpoint id="helloEndpoint"
        destination-name="Citrus.HelloService.Request.Queue"
        connection-factory="myConnectionFactory"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a simple JMS endpoint component in Citrus. The endpoint XML bean definition follows a custom XML namespace and defines
endpoint specific properties like the JMS destination name and the JMS connection factory. The endpoint id is a significant
property as the test cases will reference this endpoint when sending and receiving messages by its identifier.</p>
</div>
<div class="paragraph">
<p>In the next sections you will learn how a test case uses those endpoint components for producing and consuming messages.</p>
</div>
<div class="sect2">
<h3 id="endpoints-send-messages"><a class="anchor" href="#endpoints-send-messages"></a><a class="link" href="#endpoints-send-messages">10.1. Send messages</a></h3>
<div class="paragraph">
<p>The &lt;send&gt; action in a test case publishes messages to a destination. The actual message transport connection is defined
with the endpoint component. The test case simply defines the message contents and references a predefined message endpoint
component by its identifier. Endpoint specific configurations are centralized in the Spring bean application context while
multiple test cases can reference the endpoint to actually publish the constructed message to a destination. There are several
message endpoint implementations in Citrus available representing different transport protocols like JMS, SOAP, HTTP, TCP/IP
and many more.</p>
</div>
<div class="paragraph">
<p>Again the type of transport to use is not specified inside the test case but in the message endpoint definition. The separation
of concerns (test case/message sender transport) gives us a good flexibility of our test cases. The test case does not know
anything about connection factories, queue names or endpoint uri, connection timeouts and so on. The transport internals underneath
a sending test action can change easily without affecting the test case definition. We will see later in this document how to
create different message endpoints for various transports in Citrus. For now we concentrate on constructing the message content
to be sent.</p>
</div>
<div class="paragraph">
<p>We assume that the message&#8217;s body will be plain XML format. Citrus uses XML as the default data format for message body data.
But Citrus is not limited to XML message format though; you can always define other message data formats such as JSON, plain text,
CSV. As XML is still a very popular message format in enterprise applications and message-based solution architectures we have
this as a default format. Anyway Citrus works best on XML bodies and you will see a lot of example code in this document using
XML. Finally let us have a look at a first example how a sending action is defined in the test.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sendMessageTest() {
    run(send()
        .endpoint("helloEndpoint")
        .message()
            .header("Operation", "sayHello")
            .body("""
            &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                &lt;Text&gt;Hello!&lt;/Text&gt;
            &lt;/TestMessage&gt;
            """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SendMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;send endpoint="helloEndpoint"&gt;
        &lt;message&gt;
          &lt;headers&gt;
            &lt;header name="Operation" value="sayHello"/&gt;
          &lt;/headers&gt;
          &lt;body&gt;
            &lt;payload&gt;
            &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                &lt;Text&gt;Hello!&lt;/Text&gt;
            &lt;/TestMessage&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SendMessageTest
actions:
  - send:
      endpoint: helloEndpoint
      message:
        body:
          data: |
            &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                &lt;Text&gt;Hello!&lt;/Text&gt;
            &lt;/TestMessage&gt;
        headers:
          - name: Operation
            value: sayHello</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;
  &lt;testcase name="SendMessageTest"&gt;
    &lt;description&gt;Basic send message example&lt;/description&gt;
    &lt;actions&gt;
        &lt;send endpoint="helloEndpoint"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                    &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                        &lt;Text&gt;Hello!&lt;/Text&gt;
                    &lt;/TestMessage&gt;
                &lt;/payload&gt;
            &lt;/message&gt;
            &lt;header&gt;
                &lt;element name="Operation" value="sayHello"/&gt;
            &lt;/header&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s have a closer look at the sending action. The <strong>'endpoint'</strong> attribute might catch your attention first. This attribute
references the message endpoint in Citrus configuration by its identifier. As previously mentioned the message endpoint definition
lives in a separate configuration file and contains the actual message transport settings. In this example the <strong>"helloEndpoint"</strong>
is referenced which is a JMS endpoint for sending out messages to a JMS queue for instance.</p>
</div>
<div class="paragraph">
<p>The test case is not aware of any transport details, because it does not have to. The advantages are obvious: On the one
hand multiple test cases can reference the message endpoint definition for better reuse. Secondly test cases are independent
of message transport details. So connection factories, user credentials, endpoint uri values and so on are not present in
the test case.</p>
</div>
<div class="paragraph">
<p>In other words the <strong>"endpoint"</strong> attribute of the <code>&lt;send&gt;</code> element specifies which message endpoint definition to use
and therefore where the message should go to. Once again all available message endpoints are configured in a separate Citrus
configuration file. Be sure to always pick the right message endpoint type in order to publish your message to the right
destination.</p>
</div>
<div class="paragraph">
<p>In a Java test you can choose from a set of supported runtimes.
In fact, Citrus is able to run tests with popular Java testing frameworks such as JUnit Jupiter, JUnit4, TestNG or Cucumber.</p>
</div>
<div class="listingblock primary">
<div class="title">TestNG</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.testng.annotations.Test;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.testng.TestNGCitrusSupport;

public class SendMessageIT extends TestNGCitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void sendMessageTest() {
        run(send()
            .endpoint("helloEndpoint")
            .message()
                .header("Operation", "sayHello")
                .body("""
                &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                    &lt;Text&gt;Hello!&lt;/Text&gt;
                &lt;/TestMessage&gt;
                """)
        );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit5</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionRunner;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.jupiter.CitrusSupport;
import org.junit.jupiter.api.Test;

@CitrusSupport
public class SendMessageIT implements TestActionSupport {

    @CitrusResource
    private TestActionRunner runner;

    @Test
    @CitrusTest
    public void sendMessageTest() {
        runner.run(send()
            .endpoint("helloEndpoint")
            .message()
                .header("Operation", "sayHello")
                .body("""
                &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                    &lt;Text&gt;Hello!&lt;/Text&gt;
                &lt;/TestMessage&gt;
                """)
        );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit4</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.spring.JUnit4CitrusSupport;
import org.junit.Test;

public class SendMessageIT extends JUnit4CitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void sendMessageTest() {
        run(send()
            .endpoint("helloEndpoint")
            .message()
                .header("Operation", "sayHello")
                .body("""
                &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                    &lt;Text&gt;Hello!&lt;/Text&gt;
                &lt;/TestMessage&gt;
                """)
        );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can choose your favorite Java testing framework to run the Citrus tests.
Each framework JUnit Jupiter, JUnit4, TestNG, Cucumber may require slightly different setup.
Please also refer to the individual framework documentation and see how it works.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Please be aware of proper test case naming conventions when separating unit and integration tests.
In Maven for example unit tests are run with the <code>surefire</code> plugin in the unit test phase.
Maven surefire includes tests with a naming pattern (e.g. <code>*Test</code>).
Integration tests are run with <code>failsafe</code> plugin in the Maven integration test phase and these tests follow a different naming pattern (e.g. <code>*IT</code>).
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is good practice to follow naming conventions when defining names for message endpoints. The intended purpose of
the message endpoint as well as the sending/receiving actor should be clear when choosing the name. For instance messageEndpoint1,
messageEndpoint2 will not give you much hints to the purpose of the message endpoint.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is basically how to send messages in Citrus. The test case is responsible for constructing the message content while
the predefined message endpoint holds transport specific settings. Test cases reference endpoint components to publish messages
to the outside world. This is just the start of action. Citrus supports a whole package of other ways how to define and manipulate
the message contents. Read more about message sending actions in <a href="#actions-send">actions-send</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="endpoints-receive-messages"><a class="anchor" href="#endpoints-receive-messages"></a><a class="link" href="#endpoints-receive-messages">10.2. Receive messages</a></h3>
<div class="paragraph">
<p>Now we have a look at the message receiving part inside the test. A simple example shows how it works.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void receiveMessageTest() {
    run(receive()
        .endpoint("helloEndpoint")
        .message()
            .header("Operation", "sayHello")
            .body("""
            &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                &lt;Text&gt;Hello!&lt;/Text&gt;
            &lt;/TestMessage&gt;
            """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ReceiveMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;receive endpoint="helloEndpoint"&gt;
        &lt;message&gt;
          &lt;headers&gt;
            &lt;header name="Operation" value="sayHello"/&gt;
          &lt;/headers&gt;
          &lt;body&gt;
            &lt;payload&gt;
            &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                &lt;Text&gt;Hello!&lt;/Text&gt;
            &lt;/TestMessage&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ReceiveMessageTest
actions:
  - receive:
      endpoint: helloEndpoint
      message:
        body:
          data: |
            &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                &lt;Text&gt;Hello!&lt;/Text&gt;
            &lt;/TestMessage&gt;
        headers:
          - name: Operation
            value: sayHello</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;
  &lt;testcase name="ReceiveMessageTest"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="helloEndpoint"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                    &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                        &lt;Text&gt;Hello!&lt;/Text&gt;
                    &lt;/TestMessage&gt;
                &lt;/payload&gt;
            &lt;/message&gt;
            &lt;header&gt;
                &lt;element name="Operation" value="sayHello"/&gt;
            &lt;/header&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we recap the send action of the previous chapter we can identify some common mechanisms that apply for both sending and
receiving actions. The test action also uses the <strong>endpoint</strong> attribute for referencing a predefined message endpoint. This
time we want to receive a message from the endpoint. Again the test is not aware of the transport details such as JMS connections,
endpoint uri, and so on. The message endpoint component encapsulates this information.</p>
</div>
<div class="paragraph">
<p>Before we go into detail on validating the received message we have a quick look at the different options to run the Java test.
Basically you can choose from a set of popular Java testing frameworks to actually run the Citrus test.
Citrus integrates with the famous frameworks such as JUnit Jupiter, JUnit4, TestNG or Cucumber.</p>
</div>
<div class="listingblock primary">
<div class="title">TestNG</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.testng.annotations.Test;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.testng.TestNGCitrusSupport;

public class ReceiveMessageIT extends TestNGCitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void receiveMessageTest() {
        run(receive()
            .endpoint("helloEndpoint")
            .message()
                .header("Operation", "sayHello")
                .body("""
                &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                    &lt;Text&gt;Hello!&lt;/Text&gt;
                &lt;/TestMessage&gt;
                """)
        );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit5</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionRunner;
import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusResource;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.jupiter.CitrusSupport;
import org.junit.jupiter.api.Test;

@CitrusSupport
public class ReceiveMessageIT implements TestActionSupport {

    @CitrusResource
    private TestActionRunner runner;

    @Test
    @CitrusTest
    public void receiveMessageTest() {
        runner.run(receive()
            .endpoint("helloEndpoint")
            .message()
                .header("Operation", "sayHello")
                .body("""
                &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                    &lt;Text&gt;Hello!&lt;/Text&gt;
                &lt;/TestMessage&gt;
                """)
        );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JUnit4</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestActionSupport;
import org.citrusframework.annotations.CitrusTest;
import org.citrusframework.junit.spring.JUnit4CitrusSupport;
import org.junit.Test;

public class ReceiveMessageIT extends JUnit4CitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void receiveMessageTest() {
        run(receive()
            .endpoint("helloEndpoint")
            .message()
                .header("Operation", "sayHello")
                .body("""
                &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                    &lt;Text&gt;Hello!&lt;/Text&gt;
                &lt;/TestMessage&gt;
                """)
        );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whatever Java test framework you choose you may apply very specific configuration and setup details to run the test.
Please also have a look into the individual Java test frameworks JUnit Jupiter, JUnit4, TestNG, Cucumber and so on to see how it works.</p>
</div>
<div class="paragraph">
<p>The <code>receive</code> action waits for a message to arrive. The whole test execution is stopped while waiting for the message. This
is important to ensure the step by step test workflow processing. Of course you can specify message timeouts so the receiver
will only wait a given amount of time before raising a timeout error. Following from that timeout exception the test case
fails as the message did not arrive in time. Citrus defines default timeout settings for all message receiving tasks.</p>
</div>
<div class="paragraph">
<p>At this point you know the two most important test actions in Citrus. Sending and receiving actions will become the main
components of your integration tests when dealing with loosely coupled message based components in an enterprise application
environment. It is very easy to create complex message flows, meaning a sequence of sending and receiving actions in your
test case. You can replicate use cases and test your message exchange with extended message validation capabilities. See
<a href="#actions-receive">actions-receive</a> for a more detailed description on how to validate incoming messages and how to expect
message contents in a test case.</p>
</div>
</div>
<div class="sect2">
<h3 id="local-message-store"><a class="anchor" href="#local-message-store"></a><a class="link" href="#local-message-store">10.3. Local message store</a></h3>
<div class="paragraph">
<p>All messages that are sent and received during a test case are stored in a local memory storage. This is because we might
want to access the message content later on in a test case. We can do so by using message store functions for loading messages
that have been exchanged earlier in the test. When storing a message in the local storage Citrus uses a message name as
identifier key. This message name is later on used to access the message. You can define the message name in any send or
receive action:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void receiveMessageTest() {
    receive("helloEndpoint")
        .message()
            .name("helloMessage")
            .header("Operation", "sayHello")
            .body("""
            &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                &lt;Text&gt;Hello!&lt;/Text&gt;
            &lt;/TestMessage&gt;
            """);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ReceiveMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;receive endpoint="helloEndpoint"&gt;
        &lt;message name="helloMessage"&gt;
          &lt;headers&gt;
            &lt;header name="Operation" value="sayHello"/&gt;
          &lt;/headers&gt;
          &lt;body&gt;
            &lt;payload&gt;
            &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                &lt;Text&gt;Hello!&lt;/Text&gt;
            &lt;/TestMessage&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ReceiveMessageTest
actions:
  - receive:
      endpoint: helloEndpoint
      message:
        name: helloMessage
        body:
          data: |
            &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                &lt;Text&gt;Hello!&lt;/Text&gt;
            &lt;/TestMessage&gt;
        headers:
          - name: Operation
            value: sayHello</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;
  &lt;testcase name="ReceiveMessageTest"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="helloEndpoint"&gt;
            &lt;message name="helloMessage"&gt;
                &lt;payload&gt;
                    &lt;TestMessage xmlns="http://citrusframework.org/schemas/test"&gt;
                        &lt;Text&gt;Hello!&lt;/Text&gt;
                    &lt;/TestMessage&gt;
                &lt;/payload&gt;
            &lt;/message&gt;
            &lt;header&gt;
                &lt;element name="Operation" value="sayHello"/&gt;
            &lt;/header&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The receive operation above set the message name to <strong>helloMessage</strong>. The message received is automatically stored in the local
storage with that name. You can access the message content for instance by using a function:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void receiveMessageTest() {
    echo()
        .message("citrus:message(helloMessage.body())");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ReceiveMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;echo message="citrus:message(helloMessage.body())"/&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ReceiveMessageTest
actions:
  - echo:
      message: "citrus:message(helloMessage.body())"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;
  &lt;testcase name="ReceiveMessageTest"&gt;
    &lt;actions&gt;
        &lt;echo&gt;
            &lt;message&gt;citrus:message(helloMessage.body())&lt;/message&gt;
        &lt;/echo&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The function loads the <strong>helloMessage</strong> and prints the body information with the <strong>echo</strong> test action. In combination with Xpath
or JsonPath functions this mechanism is a good way to access the exchanged message contents later in a test case.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The storage is for both sent and received messages in a test case. The storage is per test case and contains all sent
and received messages.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When no explicit message name is given the local storage will construct a default message name. The default name is built
from the action (send or receive) plus the endpoint used to exchange the message. For instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">send(helloEndpoint)
receive(helloEndpoint)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The names above would be generated by a send and receive operation on the endpoint named <strong>helloEndpoint</strong>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The message store is not able to handle multiple message of the same name in one test case. So messages with
identical names will overwrite existing messages in the local storage.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we have seen the basic endpoint concept in Citrus. The endpoint components represent the connections to the test boundary
systems. This is how we can connect to the system under test for message exchange. And this is our main goal with this integration
test framework. We want to provide easy access to common message transports on client and server side so that we can test
the communication interfaces on a real message transport exchange.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="direct"><a class="anchor" href="#direct"></a><a class="link" href="#direct">11. Direct endpoint</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Direct endpoints represent the default in memory messaging solution in Citrus. Producer and consumer components are linked
via queues exchanging messages in memory.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The direct endpoint configuration components use the default "citrus" configuration namespace and schema definition.
Include this namespace into your Spring bean configuration in order to use the Citrus configuration elements. The namespace
URI and schema location are added to the Spring configuration XML file as follows.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:citrus="http://www.citrusframework.org/schema/config"
        xsi:schemaLocation="
            http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.citrusframework.org/schema/config
            http://www.citrusframework.org/schema/config/citrus-config.xsd"&gt;

    [...]

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Right now you are able to use the Citrus XML elements in order to define the direct endpoint components.</p>
</div>
<div class="sect2">
<h3 id="direct-endpoint"><a class="anchor" href="#direct-endpoint"></a><a class="link" href="#direct-endpoint">11.1. Channel endpoint</a></h3>
<div class="paragraph">
<p>Citrus offers a direct endpoint component that is able to create producers and consumers. Producer and consumer
send and receive messages both to and from a direct endpoint. By default, the endpoint is asynchronous when configured
in the Citrus context.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public ChannelEndpoint helloEndpoint() {
    return new ChannelEndpointBuilder()
        .queue("helloChannel")
        .build();
}

@Bean
public MessageSelectingQueueChannel helloChannel() {
    return new MessageSelectingQueueChannel();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:direct-endpoint id="helloEndpoint" queue="helloChannel"/&gt;

&lt;citrus:queue id="helloChannel"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Citrus direct endpoint references a queue directly. Inside your test case you can reference the
Citrus endpoint as usual to send and receive messages.</p>
</div>
<div class="paragraph">
<p>The message sender is now ready to publish messages on the defined queue. The communication is supposed to be asynchronous,
so the producer is not able to process any reply message. We will deal with synchronous communication and reply messages
later in this chapter. You can reference the id of the endpoint in a send and receive test action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(send("helloEndpoint")
        .message()
        .body("&lt;v1:HelloRequest xmlns:v1=\"http://citrusframework.org/schemas/HelloService.xsd\"&gt;" +
                "&lt;v1:Text&gt;Hello World!&lt;/v1:Text&gt;" +
            "&lt;/v1:HelloRequest&gt;"));

then(receive("helloEndpoint")
        .message()
        .body("&lt;v1:HelloResponse xmlns:v1=\"http://citrusframework.org/schemas/HelloService.xsd\"&gt;" +
                "&lt;v1:Text&gt;Hello Citrus!&lt;/v1:Text&gt;" +
            "&lt;/v1:HelloResponse&gt;"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;send endpoint="helloEndpoint"&gt;
    &lt;message&gt;
        &lt;payload&gt;
            &lt;v1:HelloRequest xmlns:v1="http://citrusframework.org/schemas/HelloService.xsd"&gt;
                &lt;v1:Text&gt;Hello World!&lt;/v1:Text&gt;
            &lt;/v1:HelloRequest&gt;
        &lt;/payload&gt;
    &lt;/message&gt;
&lt;/send&gt;

&lt;receive endpoint="helloEndpoint"&gt;
    &lt;message&gt;
        &lt;payload&gt;
            &lt;v1:HelloResponse xmlns:v1="http://citrusframework.org/schemas/HelloService.xsd"&gt;
                &lt;v1:Text&gt;Hello Citrus!&lt;/v1:Text&gt;
            &lt;/v1:HelloResponse&gt;
        &lt;/payload&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can send and receive messages from the same direct endpoint. As usual the receiver connects
to the message destination and waits for messages to arrive. The user can set a receive timeout which is set to 5000 milliseconds
by default. In case no message was received in this time frame the receiver raises timeout errors and the test fails.</p>
</div>
</div>
<div class="sect2">
<h3 id="synchronous-direct-endpoints"><a class="anchor" href="#synchronous-direct-endpoints"></a><a class="link" href="#synchronous-direct-endpoints">11.2. Synchronous direct endpoints</a></h3>
<div class="paragraph">
<p>The synchronous direct producer publishes messages and waits synchronously for the response to arrive on a reply queue
destination. The reply queue name is set in the message headers. The counterpart in this communication must send its
reply to that queue. The basic configuration for a synchronous direct endpoint component looks like follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public ChannelSyncEndpoint helloEndpoint() {
    return new ChannelSyncEndpointBuilder()
        .queue("helloChannel")
        .pollingInterval(1000)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:direct-sync-endpoint id="helloSyncEndpoint"
                            queue="helloChannel"
                            polling-interval="1000"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Synchronous direct endpoints usually do poll for synchronous reply messages for processing the reply messages.
The poll interval is an optional setting in order to manage the amount of reply message handshake attempts. When the endpoint
was able to receive the reply message synchronously the test case can verify the reply.</p>
</div>
<div class="paragraph">
<p>In case all polling attempts have failed the action raises a timeout error, and the test will fail.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, the direct endpoint uses temporary reply queue destinations. The temporary reply queues are only
used once for a single communication handshake. The temporary reply queue is deleted automatically.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When sending a message to this endpoint in the first place the producer will wait synchronously for the response message
to arrive on the reply queue. You can receive the reply message in your test case using the same endpoint component. So
we have two actions on the same endpoint, first send then receive.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(send("helloSyncEndpoint")
        .message()
        .body("&lt;v1:HelloRequest xmlns:v1=\"http://citrusframework.org/schemas/HelloService.xsd\"&gt;" +
                "&lt;v1:Text&gt;Hello World!&lt;/v1:Text&gt;" +
            "&lt;/v1:HelloRequest&gt;"));

then(receive("helloSyncEndpoint")
        .message()
        .body("&lt;v1:HelloResponse xmlns:v1=\"http://citrusframework.org/schemas/HelloService.xsd\"&gt;" +
                "&lt;v1:Text&gt;Hello Citrus!&lt;/v1:Text&gt;" +
            "&lt;/v1:HelloResponse&gt;"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;send endpoint="helloSyncEndpoint"&gt;
    &lt;message&gt;
        &lt;payload&gt;
            &lt;v1:HelloRequest xmlns:v1="http://citrusframework.org/schemas/HelloService.xsd"&gt;
                &lt;v1:Text&gt;Hello World!&lt;/v1:Text&gt;
            &lt;/v1:HelloRequest&gt;
        &lt;/payload&gt;
    &lt;/message&gt;
&lt;/send&gt;

&lt;receive endpoint="helloSyncEndpoint"&gt;
    &lt;message&gt;
        &lt;payload&gt;
            &lt;v1:HelloResponse xmlns:v1="http://citrusframework.org/schemas/HelloService.xsd"&gt;
                &lt;v1:Text&gt;Hello Citrus!&lt;/v1:Text&gt;
            &lt;/v1:HelloResponse&gt;
        &lt;/payload&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is how you handle synchronous communication as a sender. You publish messages to a queue and wait for reply messages
on a temporary reply queue. The next section deals with the same synchronous communication, but now Citrus will receive
a request and send a synchronous reply message to a temporary reply queue.</p>
</div>
<div class="paragraph">
<p>As usual the reply queue name is stored in the message headers. Citrus handles this synchronous communication with the
same synchronous direct endpoint component. The handling of temporary reply destinations is done automatically behind
the scenes.</p>
</div>
<div class="paragraph">
<p>So we have again two actions in our test case, but this time first receive then send.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("helloSyncEndpoint")
        .message()
        .body("&lt;v1:HelloRequest xmlns:v1=\"http://citrusframework.org/schemas/HelloService.xsd\"&gt;" +
                "&lt;v1:Text&gt;Hello World!&lt;/v1:Text&gt;" +
            "&lt;/v1:HelloRequest&gt;"));

then(send("helloSyncEndpoint")
        .message()
        .body("&lt;v1:HelloResponse xmlns:v1=\"http://citrusframework.org/schemas/HelloService.xsd\"&gt;" +
                "&lt;v1:Text&gt;Hello Citrus!&lt;/v1:Text&gt;" +
            "&lt;/v1:HelloResponse&gt;"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="helloSyncEndpoint"&gt;
    &lt;message&gt;
        &lt;payload&gt;
            &lt;v1:HelloRequest xmlns:v1="http://citrusframework.org/schemas/HelloService.xsd"&gt;
                &lt;v1:Text&gt;Hello World!&lt;/v1:Text&gt;
            &lt;/v1:HelloRequest&gt;
        &lt;/payload&gt;
    &lt;/message&gt;
&lt;/receive&gt;

&lt;send endpoint="helloSyncEndpoint"&gt;
    &lt;message&gt;
        &lt;payload&gt;
            &lt;v1:HelloResponse xmlns:v1="http://citrusframework.org/schemas/HelloService.xsd"&gt;
                &lt;v1:Text&gt;Hello Citrus!&lt;/v1:Text&gt;
            &lt;/v1:HelloResponse&gt;
        &lt;/payload&gt;
    &lt;/message&gt;
&lt;/send&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="message-queue-selector"><a class="anchor" href="#message-queue-selector"></a><a class="link" href="#message-queue-selector">11.3. Message selectors</a></h3>
<div class="paragraph">
<p>A queue can hold multiple messages at the same time. Usually you receive messages using first-in-first-out pattern. Message
selectors enable you to select messages form that queue so you can pick messages form a queue based on a selector evaluation.</p>
</div>
<div class="paragraph">
<p>Citrus introduces a special message queue implementation that supports message selectors.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public MessageSelectingQueueChannel helloChannel() {
    return new MessageSelectingQueueChannel();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:queue id="orderChannel" capacity="5"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can add a capacity attribute for this queue. A receive test action makes use of message selectors on header values as described
in <a href="#receive-message-selectors">message-selector</a>.</p>
</div>
<div class="paragraph">
<p>In addition to that we have implemented other message filter possibilities on message queues that we discuss in the next
sections.</p>
</div>
</div>
<div class="sect2">
<h3 id="payload-matching-message-queue-selector"><a class="anchor" href="#payload-matching-message-queue-selector"></a><a class="link" href="#payload-matching-message-queue-selector">11.4. Payload matching selector</a></h3>
<div class="paragraph">
<p>You can select messages based on the payload content. Either you define the expected payload as an exact match in the selector
or you make use of Citrus validation matchers which is more adequate in most scenarios.</p>
</div>
<div class="paragraph">
<p>Assume there are two different plain text messages living on a message queue waiting to be picked up by a consumer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Hello, welcome!</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">GoodBye, see you next time!</code></pre>
</div>
</div>
<div class="paragraph">
<p>The tester would like to pick up the message starting with <strong>GoodBye</strong> in our test case. The other messages should be left on the
queue as we are not interested in it right now. We can define a payload matching selector in the receive action like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("orderChannelEndpoint")
        .selector(Collections.singletonMap("payload", "@startsWith(GoodBye)@"))
        .message()
        .body("GoodBye, see you next time!"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="orderChannelEndpoint"&gt;
    &lt;selector&gt;
        &lt;element name="payload" value="@startsWith(GoodBye)@"/&gt;
    &lt;/selector&gt;
    &lt;message&gt;
        &lt;payload&gt;GoodBye, see you next time!&lt;/payload&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Citrus receiver picks up the <strong>GoodBye</strong> from the queue selected via the payload matching expression defined in the
selector element. Of course, you can also combine message header selectors and payload matching selectors as shown in this
example below where a message header <strong>sequenceId</strong> is added to the selection logic.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Map&lt;String, String&gt; selectorMap = new HashMap&lt;&gt;();
selectorMap.put("payload", "@startsWith(GoodBye)@");
selectorMap.put("sequenceId", "1234");

when(receive("orderChannelEndpoint")
        .selector(selector)
        .message()
        .body("GoodBye, see you next time!"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;selector&gt;
    &lt;element name="payload" value="@startsWith(GoodBye)@"/&gt;
    &lt;element name="sequenceId" value="1234"/&gt;
&lt;/selector&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="root-qname-message-queue-selector"><a class="anchor" href="#root-qname-message-queue-selector"></a><a class="link" href="#root-qname-message-queue-selector">11.5. Root QName selector</a></h3>
<div class="paragraph">
<p>As a special payload matching selector you can use the XML root QName of your message as selection criteria when dealing
with XML message content. Let&#8217;s see how this works in a small example:</p>
</div>
<div class="paragraph">
<p>We have two different XML messages on a message queue waiting to be picked up by a consumer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;HelloMessage xmlns="http://citrusframework.org/schema"&gt;Hello Citrus&lt;/HelloMessage&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;GoodbyeMessage xmlns="http://citrusframework.org/schema"&gt;Goodbye Citrus&lt;/GoodbyeMessage&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We would like to pick up the <strong>GoodbyeMessage</strong> in our test case. The <strong>HelloMessage</strong> should be left on the message queue
as we are not interested in it right now. We can define a root qname message selector in the receive action like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("orderChannelEndpoint")
        .selector(Collections.singletonMap("root-qname", "GoodbyeMessage"))
        .message()
        .body("&lt;GoodbyeMessage xmlns=\"http://citrusframework.org/schema\"&gt;Goodbye Citrus&lt;/GoodbyeMessage&gt;"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="orderChannelEndpoint"&gt;
    &lt;selector&gt;
        &lt;element name="root-qname" value="GoodbyeMessage"/&gt;
    &lt;/selector&gt;
    &lt;message&gt;
        &lt;payload&gt;
            &lt;GoodbyeMessage xmlns="http://citrusframework.org/schema"&gt;Goodbye Citrus&lt;/GoodbyeMessage&gt;
        &lt;/payload&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Citrus receiver picks up the <strong>GoodbyeMessage</strong> from the queue selected via the root qname of the XML message payload.
Of course, you can also combine message header selectors and root qname selectors as shown in this example below where a
message header <strong>sequenceId</strong> is added to the selection logic.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Map&lt;String, String&gt; selectorMap = new HashMap&lt;&gt;();
selectorMap.put("root-qname", "GoodbyeMessage");
selectorMap.put("sequenceId", "1234");

when(receive("orderChannelEndpoint")
        .selector(selector)
        .message()
        .body("GoodBye, see you next time!"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;selector&gt;
    &lt;element name="root-qname" value="GoodbyeMessage"/&gt;
    &lt;element name="sequenceId" value="1234"/&gt;
&lt;/selector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we deal with XML qname values, we can also use namespaces in our selector root qname selection.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("orderChannelEndpoint")
        .selector(Collections.singletonMap("root-qname", "{http://citrusframework.org/schema}GoodbyeMessage"))
        .message()
        .body("&lt;GoodbyeMessage xmlns=\"http://citrusframework.org/schema\"&gt;Goodbye Citrus&lt;/GoodbyeMessage&gt;"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;selector&gt;
    &lt;element name="root-qname" value="{http://citrusframework.org/schema}GoodbyeMessage"/&gt;
&lt;/selector&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="xpath-message-queue-selector"><a class="anchor" href="#xpath-message-queue-selector"></a><a class="link" href="#xpath-message-queue-selector">11.6. Xpath selector</a></h3>
<div class="paragraph">
<p>It is also possible to evaluate some XPath expression on the message payload in order to select a message from a message
queue. The XPath expression outcome must match an expected value and only then the message is consumed from the queue.</p>
</div>
<div class="paragraph">
<p>The syntax for the XPath expression is to be defined as the element name like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("orderChannelEndpoint")
        .selector(Collections.singletonMap("xpath://Order/status", "pending"))
        .message()
        .body("&lt;Order&gt;&lt;status&gt;pending&lt;/status&gt;&lt;/Order&gt;"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;selector&gt;
    &lt;element name="xpath://Order/status" value="pending"/&gt;
&lt;/selector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message selector looks for order messages with <strong>status="pending"</strong> in the message payload. This means that following
messages would get accepted/declined by the message selector.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;Order&gt;&lt;status&gt;pending&lt;/status&gt;&lt;/Order&gt; &lt;!-- ACCEPTED --&gt;
&lt;Order&gt;&lt;status&gt;finished&lt;/status&gt;&lt;/Order&gt; &lt;!-- NOT ACCEPTED --&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, you can also use XML namespaces in your XPath expressions when selecting messages from queues.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("orderChannelEndpoint")
        .selector(Collections.singletonMap("xpath://ns1:Order/ns1:status", "pending"))
        .message()
        .body("&lt;Order&gt;&lt;status&gt;pending&lt;/status&gt;&lt;/Order&gt;"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;selector&gt;
    &lt;element name="xpath://ns1:Order/ns1:status" value="pending"/&gt;
&lt;/selector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Namespace prefixes must match the incoming message - otherwise the XPath expression will not work as expected. In our example
the message should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;ns1:Order xmlns:ns1="http://citrus.org/schema"&gt;&lt;ns1:status&gt;pending&lt;/ns1:status&gt;&lt;/ns1:Order&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Knowing the correct XML namespace prefix is not always easy. If you are not sure which namespace prefix to choose Citrus
ships with a dynamic namespace replacement for XPath expressions. The XPath expression looks like this and is most flexible:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("orderChannelEndpoint")
        .selector(Collections.singletonMap(
                "xpath://{http://citrus.org/schema}:Order/{http://citrus.org/schema}:status", "pending"))
        .message()
        .body("&lt;Order&gt;&lt;status&gt;pending&lt;/status&gt;&lt;/Order&gt;"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;selector&gt;
    &lt;element name="xpath://{http://citrus.org/schema}:Order/{http://citrus.org/schema}:status"
                value="pending"/&gt;
&lt;/selector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will match all incoming messages regardless the XML namespace prefix that is used.</p>
</div>
</div>
<div class="sect2">
<h3 id="json-path-message-queue-selector"><a class="anchor" href="#json-path-message-queue-selector"></a><a class="link" href="#json-path-message-queue-selector">11.7. JsonPath selector</a></h3>
<div class="paragraph">
<p>It is also possible to evaluate some JsonPath expression on the message payload in order to select a message from a message
queue. The JsonPath expression outcome must match an expected value and only then the message is consumed from the queue.</p>
</div>
<div class="paragraph">
<p>The syntax for the JsonPath expression is to be defined as the element name like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("orderChannelEndpoint")
        .selector(Collections.singletonMap("jsonPath:$.order.status", "pending"))
        .message()
        .body("{ \"order\": { \"status\": \"pending\" } }"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;selector&gt;
    &lt;element name="jsonPath:$.order.status" value="pending"/&gt;
&lt;/selector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message selector looks for order messages with <strong>status="pending"</strong> in the message payload. This means that following messages would get accepted/declined by the message selector.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{ "order": { "status": "pending" } } //ACCEPTED
{ "order": { "status": "finished" } } //NOT ACCEPTED</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jms"><a class="anchor" href="#jms"></a><a class="link" href="#jms">12. JMS support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Citrus provides support for sending and receiving JMS messages. We have to separate between synchronous and asynchronous
communication. So in this chapter we explain how to work with JMS message endpoints for synchronous and asynchronous communication</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The JMS components in Citrus are kept in a separate Maven module. If not already done so you have to include the module
as Maven dependency to your project
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Maven module dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-jms&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus provides a "citrus-jms" configuration namespace and schema definition for JMS related components and features. Include
this namespace into your Spring configuration in order to use the Citrus JMS configuration elements. The namespace URI and
schema location are added to the Spring configuration XML file as follows.</p>
</div>
<div class="listingblock">
<div class="title">Spring configuration namespace</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus-jms="http://www.citrusframework.org/schema/jms/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/jms/config
           http://www.citrusframework.org/schema/jms/config/citrus-jms-config.xsd"&gt;

    [...]

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you are able to use customized Citrus XML elements in order to define the JMS endpoint components.</p>
</div>
<div class="sect2">
<h3 id="jms-endpoints"><a class="anchor" href="#jms-endpoints"></a><a class="link" href="#jms-endpoints">12.1. JMS endpoints</a></h3>
<div class="paragraph">
<p>By default, Citrus JMS endpoints are asynchronous. Asynchronous messaging means that the endpoint will not wait for a response
message after sending a message.</p>
</div>
<div class="paragraph">
<p>The test case itself should not know about JMS transport details like queue names or connection credentials. This information
is stored in the endpoint component configuration that lives in the basic project configuration files in Citrus. So let us
have a look at a simple JMS message endpoint configuration in Citrus.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmsEndpoint helloServiceEndpoint() {
    return new JmsEndpointBuilder()
        .destination("Citrus.HelloService.Request.Queue")
        .timeout(10000L)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-jms:endpoint id="helloServiceEndpoint"
          destination-name="Citrus.HelloService.Request.Queue"
          timeout="10000"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The endpoint component receives a unique id as well as a JMS destination name. This can be a queue or topic destination.
JMS topics are described later on in this chapter. For now the timeout setting completes the first JMS endpoint component
definition example.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In addition to the <code>destination-name</code> attribute you can also provide a reference to a destination implementation.
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmsEndpoint helloServiceEndpoint() {
    return new JmsEndpointBuilder()
        .destination(helloServiceQueue())
        .build();
}

@Bean
public ActiveMQQueue helloServiceQueue() {
    return new ActiveMQQueue("Citrus.HelloService.Request.Queue");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-jms:endpoint id="helloServiceEndpoint"
                     destination="helloServiceQueue"/&gt;

&lt;amq:queue id="helloServiceQueue" physicalName="Citrus.HelloService.Request.Queue"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The destination attribute references to a JMS destination object in the same Spring application context. In the example
above we used the ActiveMQ queue destination component. The destination reference can also refer to a JNDI lookup for instance.</p>
</div>
<div class="paragraph">
<p>The endpoint needs a JMS connection factory for connecting to a JMS message broker. The connection factory is also added
as component bean to the Citrus project (e.g. in the Spring application context).</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public ActiveMQConnectionFactory connectionFactory() {
    ActiveMQConnectionFactory factory = new ActiveMQConnectionFactory();
    factory.setBrokerURL("tcp://localhost:61616");
    return factory;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="connectionFactory" class="org.apache.activemq.artemis.jms.client.ActiveMQConnectionFactory"&gt;
  &lt;property name="brokerURL" value="tcp://localhost:61616"/&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JMS connection factory receives the broker URL and is able to hold many other connection specific options. In this example
we use the Apache ActiveMQ connection factory implementation as we want to use the ActiveMQ message broker. Citrus works
with a bean id <strong>connectionFactory</strong>. All Citrus JMS component will automatically recognize this connection factory.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The configuration makes it very easy to connect to other JMS broker implementations, too (e.g. Apache ActiveMQ, TIBCO Enterprise
Messaging Service, IBM Websphere MQ). Just add the required connection factory implementation as <strong>connectionFactory</strong> bean.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All JMS endpoint components in Citrus will automatically load the factory named <strong>connectionFactory</strong>.
You can use the <strong>connection-factory</strong> endpoint attribute in order to use another connection factory instance with different
bean names.
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmsEndpoint helloServiceEndpoint() {
    return new JmsEndpointBuilder()
        .destination("Citrus.HelloService.Request.Queue")
        .connectionFactory(myConnectionFactory())
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-jms:endpoint id="helloServiceEndpoint"
      destination-name="Citrus.HelloService.Request.Queue"
      connection-factory="myConnectionFactory"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an alternative to that you may want to use a special Spring JMS template implementation as custom bean in your endpoint.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmsEndpoint helloServiceEndpoint() {
    return new JmsEndpointBuilder()
        .destination("Citrus.HelloService.Request.Queue")
        .jmsTemplate(myJmsTemplate())
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-jms:endpoint id="helloServiceEndpoint"
              destination-name="Citrus.HelloService.Request.Queue"
              jms-template="myJmsTemplate"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The endpoint is now ready to be used inside a test case. You can send or receive messages using this endpoint. The test
actions reference the JMS endpoint using its unique identifier. When sending a message the message endpoint creates a JMS
message producer and will simply publish the message to the defined JMS destination. As the communication is asynchronous
by default the producer does not wait for a synchronous response.</p>
</div>
<div class="paragraph">
<p>When receiving messages the endpoint creates a JMS consumer on the JMS destination. The endpoint then acts as a message
driven listener. This means that the message consumer connects to the given destination and waits for messages to arrive.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(send("helloServiceEndpoint")
        .message()
        .body("..."));

then(receive("helloServiceEndpoint")
        .message()
        .body("..."));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="jmsMessagingTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="helloServiceEndpoint"&gt;
            &lt;message&gt;
                &lt;data&gt;
                  [...]
                &lt;/data&gt;
            &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="helloServiceEndpoint"&gt;
            &lt;message&gt;
                &lt;data&gt;
                  [...]
                &lt;/data&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jms-synchronous-endpoints"><a class="anchor" href="#jms-synchronous-endpoints"></a><a class="link" href="#jms-synchronous-endpoints">12.2. JMS synchronous endpoints</a></h3>
<div class="paragraph">
<p>When using synchronous message endpoints Citrus will manage a reply destination for receiving a synchronous response message
on the reply destination. The following figure illustrates that we now have two destinations in our communication scenario.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/figure_006.jpg" alt="figure_006.jpg"></span></p>
</div>
<div class="paragraph">
<p>The synchronous message endpoint component is similar to the asynchronous variant that has been discussed before. The only
difference is that the endpoint will automatically manage a reply destination behind the scenes. By default, Citrus uses
temporary reply destinations that get automatically deleted after the communication handshake is done. Again we need to use
a JMS connection factory in the configuration as the component needs to connect to a JMS message broker.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmsSyncEndpoint helloServiceSyncEndpoint() {
    return new JmsSyncEndpointBuilder()
        .destination("Citrus.HelloService.InOut.Queue")
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-jms:sync-endpoint id="helloServiceSyncEndpoint"
          destination-name="Citrus.HelloService.InOut.Queue"
          timeout="10000"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The synchronous component defines a target destination which again is either a queue or topic destination. The endpoint will
create the temporary reply destinations on its own. As soon as the endpoint has published a request message it waits synchronously for the
response message to arrive at the reply destination. You can receive this reply message in your test case by referencing
this same endpoint in a receiving test action. The timeout setting defines how long the endpoint waits for the synchronous reply.
In case no reply message arrives in time a message timeout error is raised respectively.</p>
</div>
<div class="paragraph">
<p>See the following example test case which references the synchronous message endpoint in its send and receive test action
in order to send out a message and wait for the synchronous response.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(send("helloServiceSyncEndpoint")
        .message()
        .body("..."));

then(receive("helloServiceSyncEndpoint")
        .message()
        .body("..."));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="jmsSyncMessagingTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="helloServiceSyncEndpoint"&gt;
            &lt;message&gt;
                &lt;data&gt;
                  [...]
                &lt;/data&gt;
            &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="helloServiceSyncEndpoint"&gt;
            &lt;message&gt;
                &lt;data&gt;
                  [...]
                &lt;/data&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We initiated the synchronous communication by sending a message on the synchronous endpoint. The second step then receives
the synchronous message on the temporary reply destination that was automatically created for you.</p>
</div>
<div class="paragraph">
<p>If you rather want to define a static reply destination you can do so, too. The static reply destination is not deleted
after the communication handshake. You may need to work with message selectors then in order to pick the right response message
that belongs to a specific communication handshake. You can define a static reply destination on the synchronous endpoint
component as follows.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmsSyncEndpoint helloServiceSyncEndpoint() {
    return new JmsSyncEndpointBuilder()
        .destination("Citrus.HelloService.InOut.Queue")
        .replyDestination("Citrus.HelloService.Reply.Queue")
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-jms:sync-endpoint id="helloServiceSyncEndpoint"
          destination-name="Citrus.HelloService.InOut.Queue"
          reply-destination-name="Citrus.HelloService.Reply.Queue"
          timeout="10000"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of using the <strong>reply-destination-name</strong> feel free to use the destination reference with <strong>reply-destination</strong> attribute.
Again you can use a JNDI lookup then to reference a destination object.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Be aware of permissions that are mandatory for creating temporary destinations. Citrus tries to create temporary
queues on the JMS message broker. Following from that the Citrus JMS user has to have the permission to do so. Be sure that
the user has the sufficient rights when using temporary reply destinations.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Up to now we have sent a message and waited for a synchronous response in the next step. Now it is also possible to switch
the directions of send and receive actions. Then we have the situation where Citrus receives a JMS message first and then
Citrus is in charge of providing a proper synchronous response message to the initial sender.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/figure_007.jpg" alt="figure_007.jpg"></span></p>
</div>
<div class="paragraph">
<p>In this scenario the foreign message producer has stored a dynamic JMS reply queue destination to the JMS header. So Citrus
has to send the reply message to this specific reply destination, which is dynamic of course. Fortunately the heavy lift
is done with the JMS endpoint and we do not have to change anything in our configuration. Again we just define a synchronous
message endpoint in the application context.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmsSyncEndpoint helloServiceSyncEndpoint() {
    return new JmsEndpointBuilder()
        .destination("Citrus.HelloService.InOut.Queue")
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-jms:sync-endpoint id="helloServiceSyncEndpoint"
      destination-name="Citrus.HelloService.InOut.Queue"
      timeout="10000"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the only thing that changes here is that we first receive a message in our test case on this endpoint. The second step
is a send message action that references this same endpoint and we are done. Citrus automatically manages the reply destinations
for us.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("helloServiceSyncEndpoint")
        .message()
        .body("..."));

then(send("helloServiceSyncEndpoint")
        .message()
        .body("..."));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="jmsSyncMessagingTest"&gt;
  &lt;actions&gt;
        &lt;receive endpoint="helloServiceSyncEndpoint"&gt;
            &lt;message&gt;
                &lt;data&gt;
                  [...]
                &lt;/data&gt;
            &lt;/message&gt;
        &lt;/receive&gt;

        &lt;send endpoint="helloServiceSyncEndpoint"&gt;
            &lt;message&gt;
                &lt;data&gt;
                  [...]
                &lt;/data&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jms-topics"><a class="anchor" href="#jms-topics"></a><a class="link" href="#jms-topics">12.3. JMS topics</a></h3>
<div class="paragraph">
<p>Up to now we have used JMS queue destinations on our endpoints. Citrus is also able to connect to JMS topic destinations.
In contrary to JMS queues which represents the <strong>point-to-point</strong> communication JMS topics use <strong>publish-subscribe</strong> mechanism
in order to spread messages over JMS.</p>
</div>
<div class="paragraph">
<p>A JMS topic producer publishes messages to the topic, while the topic accepts multiple message subscriptions and delivers
the message to all subscribers.</p>
</div>
<div class="paragraph">
<p>The Citrus JMS endpoints offer the attribute <strong>'pub-sub-domain'</strong>. Once this attribute is set to <strong>true</strong> Citrus will use JMS
topics instead of queue destinations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When using JMS topics in your project you may want to configure a <code>jakarta.jms.TopicConnectionFactory</code> instead of a
<code>jakarta.jms.QueueConnectionFactory</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See the following example where the publish-subscribe attribute is set to true in JMS message endpoint components.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmsSyncEndpoint helloServiceSyncEndpoint() {
    return new JmsEndpointBuilder()
        .destination("Citrus.HelloService.Topic")
        .pubSubDomain(true)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-jms:endpoint id="helloServiceTopicEndpoint"
            destination="Citrus.HelloService.Topic"
            pub-sub-domain="true"/&gt;
----</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using JMS topics you will be able to subscribe several test actions to the topic destination and receive a message
multiple times as all subscribers will receive the message. Also other applications besides Citrus are also able to consume
messages with a topic subscription. This allows Citrus and other software components to coexist in a test environment.</p>
</div>
<div class="sect3">
<h4 id="jms-topic-subscriber"><a class="anchor" href="#jms-topic-subscriber"></a><a class="link" href="#jms-topic-subscriber">12.3.1. JMS topic subscriber</a></h4>
<div class="paragraph">
<p>By default, Citrus does not deal with durable subscribers when using JMS topics. This means that messages that were sent
in advance to the message subscription are not delivered to the Citrus message endpoint. Following from that racing conditions
may cause problems when using JMS topic endpoints in Citrus.</p>
</div>
<div class="paragraph">
<p>Be sure to start the Citrus subscription before messages are sent to the topic. Otherwise, you may lose some messages that
were sent in advance to the subscription. By default Citrus will use a subscription per receive action using the JMS endpoint
in the test cases. This means that the topic subscription is started and stopped per receive action when the action is performed
inside a test case.</p>
</div>
<div class="paragraph">
<p>In order to solve racing conditions for messages that are sent prior to the subscription you can also use an <code>auto-start</code>
setting on the JMS endpoint component. This causes Citrus to start/stop the subscription based on the endpoint lifecycle
instead of linking the subscription to the receive action. When the endpoint is ready the subscription is started and all
incoming message events are cached and stored to an internal in-memory message channel for later consumption in the tests.</p>
</div>
<div class="paragraph">
<p>Here is the endpoint configuration with <code>auto-start</code> enabled.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmsSyncEndpoint helloServiceSyncEndpoint() {
    return new JmsEndpointBuilder()
        .destination("Citrus.HelloService.Topic")
        .pubSubDomain(true)
        .autoStart(true)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-jms:endpoint id="helloServiceTopicEndpoint"
            destination="helloServiceTopic"
            pub-sub-domain="true"
            auto-start="true"/&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>auto-start</code> option is only valid in combination with <code>pub-sub-domain</code> enabled. Other combinations may be ignored
or lead to configuration failure at start-up.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now with <code>auto-start</code> set to <code>true</code> the Citrus JMS endpoint will setup a subscription at the very beginning when the endpoint
is loaded in the project. The internal message channel name is derived from the JMS endpoint id and follows the pattern:</p>
</div>
<div class="paragraph">
<p><code>{citrus-jms:endpoint@id}":subscriber.inbound"</code></p>
</div>
<div class="paragraph">
<p>The in-memory channel id is the combined result of the JMS endpoint id and the postfix <code>:subscriber.inbound</code>. In our example
this would be <code>helloServiceTopicEndpoint:subscriber.inbound</code>. Now all messages sent to the topic in advance to the tests are
cached and ready for consumption and verification in the test.</p>
</div>
<div class="paragraph">
<p>In the test nothing really changes for you. You simply use a receive test action on the JMS endpoint as you would have done
before. In the background Citrus will automatically receive the messages from the in memory cache. This mechanism enables
us to not loose any messages that were sent to the topic in prior to Citrus firing up the test cases.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
There is a small downside of the <code>auto-start</code> topic subscriber. As incoming events are cached internally you
will not be able to receive the same topic event in multiple receive actions within the Citrus project. If you need to receive
the topic message in several places within Citrus you need to set up several JMS topic endpoints with <code>auto-start</code> enabled.
In case you just have one receive action at a time you are good to go with the <code>auto-start</code> subscriber as it is described here.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jms-topic-durable-subscription"><a class="anchor" href="#jms-topic-durable-subscription"></a><a class="link" href="#jms-topic-durable-subscription">12.4. JMS topic durable subscription</a></h3>
<div class="paragraph">
<p>When using durable subscriptions on JMS message brokers the message events on a topic are preserved for a subscriber even
if the subscriber is inactive. This means that the subscriber may not loose any message events on that particular topic as
the subscription is durable and all events are stored for later consumption.</p>
</div>
<div class="paragraph">
<p>In case you want to activate durable subscriptions on the Citrus JMS endpoint use the <code>durable-subscription</code> setting in the
configuration:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmsSyncEndpoint helloServiceSyncEndpoint() {
    return new JmsEndpointBuilder()
        .destination("Citrus.HelloService.Topic")
        .pubSubDomain(true)
        .durableSubscription(true)
        .autoStart(true)
        .build();
}

@Bean SingleConnectionFactory topicConnectionFactory() {
    ActiveMQConnectionFactory factory = new ActiveMQConnectionFactory();
    factory.setBrokerURL("tcp://localhost:61616");
    factory.setClientID("citrusDurableConnectionFactory");
    factory.setWatchTopicAdvisories(false);

    return new SingleConnectionFactory(factory);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-jms:endpoint id="helloServiceTopicEndpoint"
            connection-factory="topicConnectionFactory"
            destination="helloServiceTopic"
            pub-sub-domain="true"
            durable-subscription="true"
            auto-start="true"/&gt;

&lt;bean class="org.apache.activemq.artemis.core.server.embedded.EmbeddedActiveMQ" init-method="start" destroy-method="stop"&gt;
  &lt;property name="SecurityManager" ref="securityManager"/&gt;
&lt;/bean&gt;

&lt;bean id="topicConnectionFactory" class="org.springframework.jms.connection.SingleConnectionFactory"&gt;
  &lt;constructor-arg&gt;
    &lt;bean class="org.apache.activemq.artemis.jms.client.ActiveMQTopicConnectionFactory"&gt;
      &lt;property name="brokerURL" value="tcp://localhost:61616"/&gt;
      &lt;property name="clientID" value="citrusDurableConnectionFactory"/&gt;
    &lt;/bean&gt;
  &lt;/constructor-arg&gt;
&lt;/bean&gt;

&lt;bean id="securityManager" class="org.apache.activemq.artemis.spi.core.security.ActiveMQJAASSecurityManager"&gt;
  &lt;constructor-arg value="org.apache.activemq.artemis.spi.core.security.jaas.InVMLoginModule"/&gt;
  &lt;constructor-arg&gt;
    &lt;bean class="org.apache.activemq.artemis.core.config.impl.SecurityConfiguration"&gt;
      &lt;constructor-arg name="users"&gt;
        &lt;map&gt;
          &lt;entry key="citrus" value="citrus"/&gt;
        &lt;/map&gt;
      &lt;/constructor-arg&gt;
      &lt;constructor-arg name="roles"&gt;
        &lt;map&gt;
          &lt;entry key="citrus"&gt;
            &lt;list&gt;
              &lt;value&gt;citrus&lt;/value&gt;
            &lt;/list&gt;
          &lt;/entry&gt;
        &lt;/map&gt;
      &lt;/constructor-arg&gt;
      &lt;property name="DefaultUser" value="citrus"/&gt;
    &lt;/bean&gt;
  &lt;/constructor-arg&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The durable subscription in Citrus implies that the subscriber is started when the endpoint configuration is done. All
messages received on that subscription are cached internally until the receive action in the test case is performed for
actual message consumption. The <code>auto-start</code> setting is required to be enabled for this reason when using durable subscriptions.</p>
</div>
<div class="paragraph">
<p>By default, Citrus is using the JMS endpoint subscriber name as durable subscription name (e.g. <strong>helloServiceTopicEndpoint:subscriber</strong>).
You can overwrite the durable subscriber name with <code>durable-subscriber-name</code> setting on the endpoint.</p>
</div>
<div class="paragraph">
<p>In addition to that you need to add a client id on the connection factory so the message broker is able to identify the durable
subscription with the client address. Also we use the <code>SingleConnectionFactory</code> implementation of Spring as a connection factory
wrapper so we do not fail because of multiple connections with the same durable subscriber id.</p>
</div>
</div>
<div class="sect2">
<h3 id="jms-topic-purging"><a class="anchor" href="#jms-topic-purging"></a><a class="link" href="#jms-topic-purging">12.5. JMS topic purging</a></h3>
<div class="paragraph">
<p>As mentioned earlier, topic subscribers with <code>autoStart=true</code> consume all messages sent to the topic during the test run.
Durable topic subscribers even consume messages sent outside the test run.
Both cache the consumed messages internally in an in-memory-message-queue.
To ensure that tests start with a clean in-memory-message-queue,
it is necessary to purge the topic-subscribtion JmsEndpoint (which is defined in the code examples above) before the test begins.
Endpoint-purging is explained in detail in this section: <a href="#actions-purging-endpoints">Purging Endpoints</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="jms-message-headers"><a class="anchor" href="#jms-message-headers"></a><a class="link" href="#jms-message-headers">12.6. JMS message headers</a></h3>
<div class="paragraph">
<p>The JMS specification defines a set of special message header entries that can go into your JMS message. These JMS headers
are stored differently in a JMS message header than other custom header entries do. This is why these special header values
should be set in a special syntax that we discuss in the next paragraphs.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("helloServiceSyncEndpoint")
        .message()
        .header("citrus_jms_correlationId", "${correlationId}")
        .header("citrus_jms_messageId", "${messageId}")
        .header("citrus_jms_redelivered", "${redelivered}")
        .header("citrus_jms_timestamp", "${timestamp}")
        .body("..."));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;header&gt;
    &lt;element name="citrus_jms_correlationId" value="${correlationId}"/&gt;
    &lt;element name="citrus_jms_messageId" value="${messageId}"/&gt;
    &lt;element name="citrus_jms_redelivered" value="${redelivered}"/&gt;
    &lt;element name="citrus_jms_timestamp" value="${timestamp}"/&gt;
&lt;/header&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you see all JMS specific message headers use the <code>citrus_jms_</code> prefix. This prefix comes from Spring Integration message
header mappers that take care of setting those headers in the JMS message header properly.</p>
</div>
<div class="paragraph">
<p>Typing of message header entries may also be of interest in order to meet the JMS standards of typed message headers. For
instance the following message header is of type double and is therefore transferred via JMS as a double value.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("jmsEndpoint")
        .message()
        .header("amount", 19.75D)
        .body("..."));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;header&gt;
    &lt;element name="amount" value="19.75" type="double"/&gt;
&lt;/header&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dynamic-destination-names"><a class="anchor" href="#dynamic-destination-names"></a><a class="link" href="#dynamic-destination-names">12.7. Dynamic destination names</a></h3>
<div class="paragraph">
<p>Usually you set the target destination as property on the JMS endpoint component. In some cases it might be useful to set
the target destination in a more dynamic way during the test run. You can do this by adding a special message header named
<strong>citrus_jms_destination_name</strong>. This header is automatically interpreted by the Citrus JMS endpoint and is set as the target
destination before a message is sent.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(send("jmsEndpoint")
        .message()
        .header("citrus_jms_destination_name", "dynamic.destination.name")
        .body("..."));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;send endpoint="jmsEndpoint"&gt;
    &lt;message&gt;
        ...
    &lt;/message&gt;
    &lt;header&gt;
        &lt;element name="citrus_jms_destination_name" value="dynamic.destination.name"/&gt;
    &lt;/header&gt;
&lt;/send&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This action above will send the message to the destination "<em>dynamic.destination.name</em>" no matter what default destination
is set on the referenced endpoint component named <em>jmsEndpoint</em>. The dynamic destination name setting also supports test
variables. This means you can use variables and functions in the destination name, too.</p>
</div>
<div class="paragraph">
<p>Another possibility for dynamic JMS destinations is given with the <a href="#dynamic-endpoint-components">dynamic endpoints</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="soap-over-jms"><a class="anchor" href="#soap-over-jms"></a><a class="link" href="#soap-over-jms">12.8. SOAP over JMS</a></h3>
<div class="paragraph">
<p>When sending SOAP messages you have to deal with proper envelope, body and header construction. In Citrus you can add a
special message converter that performs the heavy lift for you. Just add the message converter to the JMS endpoint as shown
in the next program listing:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmsSyncEndpoint helloServiceSoapJmsEndpoint() {
    return new JmsEndpointBuilder()
        .destination("Citrus.HelloService.Request.Queue")
        .messageConverter(soapJmsMessageConverter())
        .build();
}

@Bean
public SoapJmsMessageConverter soapJmsMessageConverter() {
    return new SoapJmsMessageConverter();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-jms:endpoint id="helloServiceSoapJmsEndpoint"
        destination-name="Citrus.HelloService.Request.Queue"
        message-converter="soapJmsMessageConverter"/&gt;

&lt;bean id="soapJmsMessageConverter" class="org.citrusframework.jms.message.SoapJmsMessageConverter"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this message converter you can skip the SOAP envelope completely in your test case. You just deal with the message
body payload and the header entries. The rest is done by the message converter. So you get proper SOAP messages on the
producer and consumer side.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kafka"><a class="anchor" href="#kafka"></a><a class="link" href="#kafka">13. Apache Kafka Support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kafka is a distributed streaming platform that enables you to publish and subscribe to streams of records, similar to a
message queue or enterprise messaging system. Citrus provides support for publishing/consuming records to/from a Kafka topic.
Citrus acts as producer or consumer as the Citrus Kafka endpoint can be used bidirectional. In the current version Citrus
supports asynchronous communication only.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Kafka components in Citrus are shipped in a separate Maven module. If not already done so you have to include
the module as Maven dependency to your project
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Maven dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-kafka&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case you are using XML Spring configuration files Citrus provides a "citrus-kafka" configuration namespace and schema
definition for Kafka related components and features. Include this namespace into your Spring XML configuration in order
to use the Citrus Kafka configuration elements. The namespace URI and schema location are added to the Spring bean root element.</p>
</div>
<div class="listingblock">
<div class="title">Spring bean configuration namespace</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus-kafka="http://www.citrusframework.org/schema/kafka/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/kafka/config
           http://www.citrusframework.org/schema/kafka/config/citrus-kafka-config.xsd"&gt;

    [...]

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you are able to use customized Citrus XML elements in order to define the Kafka endpoint components. In case you are
using the Spring Java configuration with <code>@Bean</code> annotations you do not require this step.</p>
</div>
<div class="sect2">
<h3 id="kafka-endpoint"><a class="anchor" href="#kafka-endpoint"></a><a class="link" href="#kafka-endpoint">13.1. Kafka Endpoint</a></h3>
<div class="paragraph">
<p>By default, Citrus Kafka endpoints are asynchronous. Asynchronous messaging means that the endpoint will not wait for any
response message after sending or receiving a message.</p>
</div>
<div class="paragraph">
<p>The endpoint component configuration holds transport specific configuration details such as topic names and server connectivity
settings. So let us have a look at a simple Kafka message endpoint configuration in Citrus.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public KafkaEndpoint helloKafkaEndpoint() {
    return new KafkaEndpointBuilder()
                    .topic("hello")
                    .server("localhost:9092")
                    .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-kafka:endpoint id="helloKafkaEndpoint"
          topic="hello"
          server="localhost:9092"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The endpoint component receives a unique id as well as a Kafka topic name. The bootstrap server url that points to the Kafka
message brokers completes our first Kafka endpoint component definition. With this configuration you will be able to send and
receive records on the given topic.</p>
</div>
<div class="paragraph">
<p>By default, the endpoint uses the topic partition <code>0</code>. The consumer on this endpoint is automatically added to a consumer
group <code>citrus_kafka_group</code>. You can customize these settings on the endpoint.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public KafkaEndpoint helloKafkaEndpoint() {
    return new KafkaEndpointBuilder()
                    .topic("hello")
                    .server("localhost:9092")
                    .partition(1)
                    .consumerGroup("citrus_group")
                    .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-kafka:endpoint id="helloKafkaEndpoint"
          topic="hello"
          server="localhost:9092"
          partition="1"
          consumer-group="citrus_group"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The endpoint is now ready to be used inside a test case.
The test simply references the endpoint by its name when sending or receiving.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <code>org.apache.kafka.clients.consumer.KafkaConsumer&lt;K,V&gt;</code> is <strong>not thread-safe</strong>.
When using <a href="#kafka-message-selector">selective message consumption</a>, it is recommended to configure <code>useThreadSafeConsumer</code> respectively <code>thread-safe-consumer</code> for the Kafka endpoint.
Otherwise, you cannot execute tests in parallel.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For effective message consumption, it is additionally advisable to use random consumer groups.
Both the Java and XML DSL support random consumer groups, when enabled: <code>randomConsumerGroup(true)</code> or <code>random-consumer-group="true"</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In case of a send operation the endpoint creates a Kafka producer and will simply publish the records to the defined Kafka topic.
As the communication is asynchronous by default, the producer does not wait for a response.</p>
</div>
<div class="paragraph">
<p>In case of a receive operation the endpoint creates a Kafka consumer instance in the defined (possibly random) consumer group.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, the consumer starts a subscription on the given topic and acts as a polling listener.
This means that the message consumer connects to the given topic and polls one single record at a time.
The action is the ready to perform the validation process that verifies the record, once it has been received.
This approach requires looping to find specific Kafka messages, which can be highly inefficient, especially when the Kafka topic experiences high traffic.
See <a href="#kafka-message-selector">Kafka message selectors</a> for a more effective Kafka message selection.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="kafka-endpoint-configuration"><a class="anchor" href="#kafka-endpoint-configuration"></a><a class="link" href="#kafka-endpoint-configuration">13.1.1. Configuration</a></h4>
<div class="paragraph">
<p>The following table shows all available settings on a Kafka endpoint in Citrus:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 18.1818%;">
<col style="width: 18.1818%;">
<col style="width: 18.1818%;">
<col style="width: 45.4546%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Mandatory</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Identifying name of the endpoint. Only required for XML configuration.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>topic</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Default topic to use with this endpoint. Multiple topics are supported by using a comma delimited list of names (e.g. <code>topic1,topic2,topicN</code>).
  If not specified the test case send operation needs to set the topic as message header information.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>server</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>localhost:9092</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A comma delimited list of host/port pairs to use for establishing the initial connection to the Kafka cluster.
  Usually it is only required to connect to one Kafka server instance in the cluster.
  Kafka then makes sure that the endpoint is automatically introduced to all other servers in the cluster.
  This list only impacts the initial hosts used to discover the full set of servers.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>5000</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Timeout in milliseconds.
  For producers the timeout is set as time to wait for the message to be accepted by the cluster.
  For consumers the timeout is used for polling records on a specific topic.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>message-converter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.citrusframework.kafka.message.KafkaMessageConverter</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Converter maps internal Citrus message objects to <code>ProducerRecord</code>/<code>ConsumerRecord</code> objects.
  The converter implementation takes care of message key, value, timestamp and special message headers.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>header-mapper</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.citrusframework.kafka.message.KafkaMessageHeaderMapper</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Header mapper maps Kafka record information (e.g. topic name, timestamp, message key) to internal message headers (<code>org.citrusframework.kafka.message.KafkaMessageHeaders</code>) and vice versa.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>auto-commit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>When this setting is enabled the consumer will automatically commit consumed records so the offset pointer on the Kafka topic is set to the next record.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>auto-commit-interval</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1000</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Interval in milliseconds the auto commit operation on consumed records is performed.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">offset-reset</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>earliest</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>When consuming records from a topic partition and the current offset does not exist on that partition Kafka will automatically seek to a valid offset position on that partition.
  The <code>offset-reset</code> setting sets where to find the new position (<code>latest</code>, <code>earliest</code>, <code>none</code>).
  If <code>none</code> is set the consumer will receive an exception instead of resetting the offset to a valid position.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>partition</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Partition id that the consumer will be assigned to.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>consumer-group</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>citrus_kafka_group</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Consumer group name.
Please keep in mind that records are load balanced across consumer instances with the same consumer group name set.
So you might run into message timeouts when using multiple Kafka endpoints with the same consumer group name.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>random-consumer-group</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Whether to use random consumer group names.
  Note that these will all be prefixed by <code>citrus_kafka_</code> and end with a random 10 characters alphabetic suffix.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>key-serializer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.kafka.common.serialization.StringSerializer</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Serializer implementation that converts message key values.
  By default, keys are serialized to String values.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>key-deserializer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.kafka.common.serialization.StringDeserializer</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Deserializer implementation that converts message key values.
  By default, keys are deserialized as String values.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>value-serializer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.kafka.common.serialization.StringSerializer</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Serializer implementation that converts record values.
  By default values are serialized to String values.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>value-deserializer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.kafka.common.serialization.StringDeserializer</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Deserializer implementation that converts record values.
  By default, values are deserialized as String values.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>client-id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>citrus_kafka_[producer/consumer]_{randomUUID}</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>An id string to pass to the server when producing/consuming records.
  Used as logical application name to be included in server-side request logging.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>consumer-properties</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Map of consumer property settings to apply to the Kafka consumer configuration.
  This enables you to overwrite any consumer setting with respective property key value pairs.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>producer-properties</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Map of producer property settings to apply to the Kafka producer configuration.
  This enables you to overwrite any producer setting with respective property key value pairs.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>thread-safe-consumer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Whether to use separate <code>org.apache.kafka.clients.consumer.KafkaConsumer&lt;K,V&gt;</code>'s per thread.
  Required for parallel test execution, because the consumer is <strong>not thread-safe</strong>.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="kafka-endpoint-properties"><a class="anchor" href="#kafka-endpoint-properties"></a><a class="link" href="#kafka-endpoint-properties">13.1.2. Producer and Consumer Properties</a></h4>
<div class="paragraph">
<p>The Citrus Kafka endpoint component is also able to receive a map of Kafka producer and consumer properties. These property
settings overwrite any predefined setting on the producer/consumer instance created by the endpoint. You can use the Kafka
property keys with respective values for producer and consumer config maps.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public KafkaEndpoint helloKafkaEndpoint() {
    return new KafkaEndpointBuilder()
                    .consumerProperties(getConsumerProps())
                    .producerProperties(getProducerProps())
                    .build();
}

private Map&lt;String, Object&gt; getProducerProps() {
    // ...
}

private Map&lt;String, Object&gt; getConsumerProps() {
    // ...
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-kafka:endpoint id="helloKafkaEndpoint"
                               consumer-properties="consumerProps"
                               producer-properties="producerProps"/&gt;


&lt;util:map id="producerProps"&gt;
  &lt;entry key="bootstrap.servers" value="localhost:9093,localhost:9094"/&gt;
  &lt;entry key="retries" value="10" value-type="java.lang.Integer"/&gt;
  &lt;entry key="max.request.size" value="1024" value-type="java.lang.Integer"/&gt;
  &lt;entry key="ssl.keystore.location" value="/path/to/keystore.jks"/&gt;
  &lt;entry key="ssl.kestore.password" value="secr3t"/&gt;
&lt;/util:map&gt;

&lt;util:map id="consumerProps"&gt;
  &lt;entry key="bootstrap.servers" value="localhost:9093,localhost:9094"/&gt;
  &lt;entry key="session.timeout.ms" value="10000" value-type="java.lang.Integer"/&gt;
  &lt;entry key="enable.auto.commit" value="true" value-type="java.lang.Boolean"/&gt;
  &lt;entry key="ssl.truststore.location" value="/path/to/truststore.jks"/&gt;
  &lt;entry key="ssl.truststore.password" value="secr3t"/&gt;
&lt;/util:map&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kafka-synchronous-endpoints"><a class="anchor" href="#kafka-synchronous-endpoints"></a><a class="link" href="#kafka-synchronous-endpoints">13.2. Kafka Synchronous Endpoints</a></h3>
<div class="paragraph">
<p>Not implemented yet.</p>
</div>
</div>
<div class="sect2">
<h3 id="kafka-message-headers"><a class="anchor" href="#kafka-message-headers"></a><a class="link" href="#kafka-message-headers">13.3. Kafka Message Headers</a></h3>
<div class="paragraph">
<p>The Kafka Citrus integration defines a set of special message header entries that are either used to manipulate the endpoint
behavior or as validation object. These Kafka specific headers are stored with a header key prefix <code>citrus_kafka_*</code>. You
can set or verify those headers in send and receive actions as follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">send(helloKafkaEndpoint)
    .message()
    .header(KafkaMessageHeaders.TOPIC, "my.very.special.topic")
    .header(KafkaMessageHeaders.MESSAGE_KEY, "myKey")
    .header(KafkaMessageHeaders.PARTITION, 1);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;header&gt;
    &lt;element name="citrus_kafka_topic" value="my.very.special.topic"/&gt;
    &lt;element name="citrus_kafka_messageKey" value="myKey"/&gt;
    &lt;element name="citrus_kafka_partition" value="1" /&gt;
&lt;/header&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The header entries above are used in a send operation in order to overwrite the topic destination, to set the record key
and to specify the target partition of the producer record. These settings do only apply for the very specific send operation.
Default values on the Kafka endpoint are overwritten respectively.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Typing of message header entries may also be of interest in order to meet the Kafka standards. For instance the following
message key is of type <code>java.lang.Integer</code> and is therefore transferred via Kafka&#8217;s key-serializer as an integer value. You need
to set the header type to <code>integer</code> and use a <code>org.apache.kafka.common.serialization.IntegerSerializer</code> as key-serializer on
the Kafka endpoint configuration.
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">send(helloKafkaEndpoint)
    .message()
    .header(KafkaMessageHeaders.MESSAGE_KEY, 1L);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;header&gt;
    &lt;element name="citrus_kafka_messageKey" value="1" type="integer"/&gt;
&lt;/header&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case of a receiving operation message headers are valuable validation objects that can be used to verify the message content with
an expected behavior.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(helloKafkaEndpoint)
    .message()
    .header(KafkaMessageHeaders.TIMESTAMP, Matchers.greaterThan(0))
    .header(KafkaMessageHeaders.TOPIC, "my.expected.topic")
    .header(KafkaMessageHeaders.MESSAGE_KEY, "myKey")
    .header(KafkaMessageHeaders.PARTITION, 1)
    .header(KafkaMessageHeaders.OFFSET, Matchers.greaterThanOrEqualTo(0));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;header&gt;
    &lt;element name="citrus_kafka_timestamp" value="@assertThat(greaterThan(0))@"/&gt;
    &lt;element name="citrus_kafka_topic" value="my.expected.topic"/&gt;
    &lt;element name="citrus_kafka_messageKey" value="myKey"/&gt;
    &lt;element name="citrus_kafka_partition" value="1"/&gt;
    &lt;element name="citrus_kafka_offset" value="@assertThat(greaterThanOrEqualTo(0))@"/&gt;
&lt;/header&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>These are the available Kafka message headers in Citrus:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 18.1818%;">
<col style="width: 18.1818%;">
<col style="width: 18.1818%;">
<col style="width: 45.4546%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Header</th>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">KafkaMessageHeaders.TIMESTAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus_kafka_timestamp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Long</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Record timestamp value</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">KafkaMessageHeaders.TOPIC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus_kafka_topic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Topic name</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">KafkaMessageHeaders.MESSAGE_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus_kafka_messageKey</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Object</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Record key</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">KafkaMessageHeaders.PARTITION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus_kafka_partition</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Topic partition id</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">KafkaMessageHeaders.OFFSET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus_kafka_offset</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Long</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Record offset on partition</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="kafka-message"><a class="anchor" href="#kafka-message"></a><a class="link" href="#kafka-message">13.4. Kafka Message</a></h3>
<div class="paragraph">
<p>Citrus also provides a Kafka message implementation that you can use on any send and receive operation. This enables you
to set special message headers in a more comfortable way when using the Java fluent API:</p>
</div>
<div class="listingblock">
<div class="title">Use message objects</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">send(helloKafkaEndpoint)
    .message(new KafkaMessage("sayHello")
                    .topic("my.very.special.topic")
                    .messageKey("myKey")
                    .partition(1));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message implementation provides fluent API builder methods for each Kafka specific header.</p>
</div>
<div class="paragraph">
<p>Additionally, when receiving messages, you might want to use <a href="#kafka-message-selector">Kafka message selectors</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="kafka-message-selector"><a class="anchor" href="#kafka-message-selector"></a><a class="link" href="#kafka-message-selector">13.5. Kafka Message Selector</a></h3>
<div class="paragraph">
<p>The Kafka Message Selector feature allows you to selectively receive messages from a Kafka topic based on specific criteria.
This powerful functionality enables you to filter Kafka messages by different criteria, e.g. <a href="#kafka-message-selector-types">based on headers</a>.
Additionally, the defined time window for message retrieval significantly improves the performance.
Imagine a large Kafka topic with thousands of events.
Looking through all of these would require an immense amount of resources and time.
Instead, selective message consumption starts at an offset <code>Ox = OT-n</code>.
Where <code>T</code> is the current timestamp and <code>n</code> is the maximum timespan in which the wanted event is expected to have been published.</p>
</div>
<div class="sect3">
<h4 id="kafka-message-selector-basic"><a class="anchor" href="#kafka-message-selector-basic"></a><a class="link" href="#kafka-message-selector-basic">13.5.1. Basic Usage</a></h4>
<div class="paragraph">
<p>The Kafka Message Selector can be used in various ways, depending on your preferred syntax and test framework.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">then(
    receive(kafkaEndpoint)
        .selector(
            kafkaMessageFilter()
                .eventLookbackWindow(Duration.ofSeconds(1L))
                .kafkaMessageSelector(kafkaHeaderEquals("key", "value"))
                .build()
        )
);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Java 2</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">then(
    kafkaEndpoint.findKafkaEventHeaderEquals(Duration.ofSeconds(1L), "key", "value")
);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="helloKafkaEndpoint"&gt;
    &lt;description&gt;Receive selective Kafka message&lt;/description&gt;
    &lt;selector&gt;
      &lt;element name="header-filter-key" value="key"/&gt;
      &lt;element name="header-filter-value" value="value"/&gt;
      &lt;element name="event-lookback-window" value="PT1S"/&gt;
    &lt;/selector&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="kafka-message-selector-configuration"><a class="anchor" href="#kafka-message-selector-configuration"></a><a class="link" href="#kafka-message-selector-configuration">13.5.2. Configuration</a></h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Java DSL</th>
<th class="tableblock halign-left valign-top">XML DSL</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>eventLookbackWindow</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>event-lookback-window</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This defines how far back in time the selector should search for messages.
  When using XML configuration, the event lookback window must be specified as an <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO-8601 duration string</a>.
  For example, <code>PT1S</code> represents a duration of 1 second.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafkaMessageSelector</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <a href="#kafka-message-selector-types">Selector Types</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This specifies the criteria for message selection.
  In the examples, we&#8217;re using <code>kafkaHeaderEquals("key", "value")</code>, which selects messages where a header with the <code>key</code> "key" exactly matches the <code>value</code> "value".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pollTimeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>poll-timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The timeout duration for each poll operation when consuming messages from Kafka.
  This value determines how long the consumer will wait for new records in each poll cycle.
  It is not the overall receive action timeout!
  When using XML configuration, the poll timeout must be specified as an <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO-8601 duration string</a>.
  For example, <code>PT0.100S</code> represents a duration of 1 millisecond.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="kafka-message-selector-types"><a class="anchor" href="#kafka-message-selector-types"></a><a class="link" href="#kafka-message-selector-types">13.5.3. Selector Types</a></h4>
<div class="paragraph">
<div class="title">Message Header</div>
<p>The framework provides two main types of message header selectors.
From within the Java DSL, these two can be easily invoked using statically provided methods:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>kafkaHeaderEquals</code>: Matches messages where the specified header <code>key</code> exactly equals the given <code>value</code>.</p>
</li>
<li>
<p><code>kafkaHeaderContains</code>: Matches messages where the specified header <code>key</code> contains the given <code>value</code> as a substring.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>More advanced users might want to do pre- or suffix matching.
That is also possible.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">then(
    receive(kafkaWithRandomConsumerGroupEndpoint)
        .selector(
            kafkaMessageFilter()
                .eventLookbackWindow(Duration.ofSeconds(1L))
                .kafkaMessageSelector(
                    KafkaMessageByHeaderSelector.builder()
                        .key("key")
                        .value("prefix")
                        .matchingMechanism(STARTS_WITH)
                        .build()
                )
                .build()
        )
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that if the specified <code>key</code> is <code>null</code>, all headers in the record will be matched against the <code>value</code>.
If the <code>value</code> is <code>null</code> however, all headers with the exact <code>key</code> match.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Java DSL</th>
<th class="tableblock halign-left valign-top">XML DSL</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>header-filter-key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key-filter being applied to Kafka messages.
  Matches exact if specified, all keys if <code>null</code> or empty.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>value</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>header-filter-value</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value-filter being applied to Kafka messages.
  Matches all values if <code>null</code> or empty.
  Otherwise matches as specified by strategy.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>valueMatchingStrategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>header-filter-comparator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies how the <code>value</code> is being matched.
  Must be one of <code>EQUALS</code>, <code>CONTAINS</code>, <code>STARTS_WITH</code> or <code>ENDS_WITH</code>.
  It defaults to <code>EQUALS</code>, if not specified.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Custom Selector Strategy</div>
<p>In addition to the default Kafka message selection strategies in Citrus, it additionally allows you to define custom message selectors.
This is especially useful when you want to select messages based on predicates Citrus does not (yet) support.</p>
</div>
<div class="paragraph">
<p>A custom selector strategy consists of two parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <strong>predicate</strong> to determine if a custom selector applies.</p>
</li>
<li>
<p>A <strong>constructor function</strong> that returns the appropriate <code>KafkaMessageSelector</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You register your strategy using the <code>KafkaMessageSelectorFactory#setCustomStrategies</code> method, typically within your test setup:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">kafkaWithRandomConsumerGroupEndpoint.getEndpointConfiguration()
    .getKafkaMessageSelectorFactory()
    .setCustomStrategies(
        factoryWithKafkaMessageSelector(
            messageSelectors -&gt; messageSelectors.containsKey(MESSAGE_KEY_FILTER_KEY),
            messageSelectors -&gt; new KafkaMessageByKeySelector(
                (String) messageSelectors.get(MESSAGE_KEY_FILTER_KEY)
            )
        )
    );</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, the <code>MESSAGE_KEY_FILTER_KEY</code> is a custom key used to recognize and extract the expected Kafka message key from the selector.</p>
</div>
<div class="paragraph">
<p>The <code>KafkaMessageByKeySelector</code> is an implementation of <code>KafkaMessageSelector</code> and matches messages by key:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">record KafkaMessageByKeySelector(String key) implements KafkaMessageSelector {
    static final String MESSAGE_KEY_FILTER_KEY = "message-key";

    @Override
    public boolean matches(ConsumerRecord&lt;Object, Object&gt; consumerRecord) {
        return nonNull(consumerRecord.key()) &amp;&amp; consumerRecord.key().equals(key);
    }

    @Override
    public Map&lt;String, String&gt; asSelector() {
        return Map.of(MESSAGE_KEY_FILTER_KEY, key);
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>matches</code> method defines the filter logic.</p>
</li>
<li>
<p>The <code>asSelector</code> method returns a key-value map representation of the selector.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="kafka-message-selector-best-practices"><a class="anchor" href="#kafka-message-selector-best-practices"></a><a class="link" href="#kafka-message-selector-best-practices">13.5.4. Best Practices</a></h4>
<div class="paragraph">
<p><strong>Set Appropriate Lookback Window:</strong> Choose a lookback window that balances between finding the desired message and performance.
A larger window might find older messages but could impact performance.</p>
</div>
<div class="paragraph">
<p><strong>Combine with Other Citrus Features:</strong> The Kafka Message Selector can be combined with other Citrus testing features for comprehensive Kafka integration testing.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dynamic-kafka-endpoints"><a class="anchor" href="#dynamic-kafka-endpoints"></a><a class="link" href="#dynamic-kafka-endpoints">13.6. Dynamic Kafka Endpoints</a></h3>
<div class="paragraph">
<p>As we have seen before the topic name can be overwritten in each send and receive operation by specifying the <code>citrus_kafka_topic</code>
message header. In addition to that you can make use of completely dynamic Kafka endpoints, too.</p>
</div>
<div class="paragraph">
<p>The dynamic endpoint is created on the fly with respective settings. So you can use the <code>kafka</code> endpoint component in your
test as follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">send("kafka:hello")
    .message()
    .body("foo")
    .header(KafkaMessageHeaders.MESSAGE_KEY, 1);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;send endpoint="kafka:hello"&gt;
    &lt;message&gt;
        ...
    &lt;/message&gt;
    &lt;header&gt;
        &lt;element name="citrus_kafka_messageKey" value="1"/&gt;
    &lt;/header&gt;
&lt;/send&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This action above will create a dynamic Kafka endpoint and publish the message to the <code>hello</code> topic. The dynamic endpoint
url uses the <code>kafka:</code> scheme and gives the topic name as resource path. In addition to that the dynamic endpoint url is able
to set multiple parameters such as <code>server</code>. Let&#8217;s have a look at this in a small example.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">send("kafka:hello?server=localhost:9091")
    .message(new KafkaMessage("foo"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;send endpoint="kafka:hello?server=localhost:9091"&gt;
    &lt;message&gt;
        ...
    &lt;/message&gt;
&lt;/send&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can add multiple parameters to the endpoint url in order to set properties on the dynamic endpoint. You can read more
about dynamic endpoints in chapter <a href="#dynamic-endpoint-components">dynamic endpoints</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="embedded-kafka-server"><a class="anchor" href="#embedded-kafka-server"></a><a class="link" href="#embedded-kafka-server">13.7. Embedded Kafka Server</a></h3>
<div class="paragraph">
<p>The Kafka message broker is composed of a Zookeeper server and a Kafka server. Citrus provides an embedded server (<strong>for testing purpose only!</strong>)
that is able to start within your integration test environment. The server cluster is configured with one single Zookeeper
server and a single Kafka server. You can define server ports and broker properties such as topics, number of partitions and
broker ids. Given topics are automatically added via admin client on the Kafka server with given amount of partitions.</p>
</div>
<div class="paragraph">
<p>You can add the embedded server component to the Spring application context as normal Spring bean. The server will automatically
start and stop within the application context lifecycle. The Zookeeper log directory is located in the Java temp directory
and is automatically deleted on JVM exit.</p>
</div>
<div class="paragraph">
<p>See the following configuration how to use the embedded server component:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public EmbeddedKafkaServer kafkaServer() {
    return new EmbeddedKafkaServerBuilder()
                    .topics("foo", "bar")
                    .kafkaServerPort(9091)
                    .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-kafka:embedded-server id="kafkaServer"
                                topics="foo,bar"
                                kafka-server-port="9091"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The embedded server component provides following properties to set:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 22.2222%;">
<col style="width: 22.2222%;">
<col style="width: 55.5556%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">topics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Comma delimited list of topic names that automatically will be created on the server.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafka-server-port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Port of the embedded Kafka server</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">zookeeper-port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Zookeeper server port. By default, a random port is used.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">broker-properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.util.Map</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Map of broker property key-value pairs that overwrite the default broker properties. For a list of available properties
  please review the official Kafka documentation.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">partitions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Number of partitions to create for each topic</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">log-dir-path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Path to Zookeeper log directory. The Zookeeper server will create its data directory in this directory. By default, the
  Java temp directory is used.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">auto-delete-logs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Auto delete Zookeeper log directories on exit. Default is true.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="http-rest"><a class="anchor" href="#http-rest"></a><a class="link" href="#http-rest">14. Http REST support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>REST APIs have gained more and more significance regarding client-server interfaces with message exchange over Http. Http
is a synchronous protocol by nature so the client blocks in order to wait for the server response synchronously. Citrus
is able to connect with Http services and REST APIs on both client and server side with a powerful JSON message data support.</p>
</div>
<div class="paragraph">
<p>In the next sections you will learn how to invoke Http services as a client and how to handle REST Http requests in a test case.
The chapter deals with setting up an Http server in order to accept client requests and provide proper Http responses with
GET, PUT, DELETE or POST request method.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The http components in Citrus are kept in a separate Maven module. So you should add the module as Maven dependency
to your project accordingly.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Http module dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-http&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="http-rest-client"><a class="anchor" href="#http-rest-client"></a><a class="link" href="#http-rest-client">14.1. Http REST client</a></h3>
<div class="paragraph">
<p>On the client side Citrus uses a simple Http message client component connecting to the server. The <strong>request-url</strong> attribute
defines the Http server endpoint URL to connect to. You can reference this client in your test case in order to send and
receive messages. Citrus as client waits for the response message from the server. After that the response message goes
through the validation process as usual.</p>
</div>
<div class="listingblock primary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public HttpClient httpClient() {
    return new HttpClientBuilder()
        .requestUrl("http://localhost:8080/hello")
        .requestMethod(HttpMethod.GET)
        .contentType("application/xml")
        .charset("UTF-8")
        .timeout(60000L)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-http="http://www.citrusframework.org/schema/http/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/http/config
           http://www.citrusframework.org/schema/http/config/citrus-http-config.xsd"&gt;

    &lt;citrus-http:client id="httpClient"
          request-url="http://localhost:8080/hello"
          request-method="GET"
          content-type="application/xml"
          charset="UTF-8"
          timeout="60000"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Citrus provides a customized Http configuration schema for the Spring XML application context configuration files.
Simply include the <code>citrus-http</code> namespace in the configuration XML files as seen in the example above.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <strong>request-method</strong> defines the Http method to use. In addition to that we can specify the content-type of the request
we are about to send. The charset is also added to the content-type header. In case you do not want to set the charset at
all please specify an empty string as the default value is <em>UTF-8</em>.</p>
</div>
<div class="paragraph">
<p>The client builds the Http request and sends it to the Http server. While the client is waiting for the synchronous Http
response to arrive we are able to poll several times for the response message in our test case. As usual you can use the
same client endpoint in your test case to send and receive messages synchronously. In case the reply message comes in too
late according to the timeout settings a respective timeout error is raised.</p>
</div>
<div class="paragraph">
<p>Http defines several request methods that a client can use to access Http server resources. In the example client above we
are using <strong>GET</strong> as default request method. Of course you can overwrite this setting in a test case action by setting the
Http request method inside the sending test action. The Http client component can be used as normal endpoint in a sending
test action. Use something like this in your test:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">send("httpClient")
    .message()
    .body("Hello HttpServer")
    .header(HttpMessageHeaders.HTTP_REQUEST_METHOD, HttpMethod.POST.name())</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;send endpoint="httpClient"&gt;
    &lt;message&gt;
        &lt;payload&gt;
            &lt;TestMessage&gt;
                &lt;Text&gt;Hello HttpServer&lt;/Text&gt;
            &lt;/TestMessage&gt;
        &lt;/payload&gt;
    &lt;/message&gt;
    &lt;header&gt;
        &lt;element name="citrus_http_method" value="POST"/&gt;
    &lt;/header&gt;
&lt;/send&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Citrus uses the Spring REST template mechanism for sending out Http requests. This means you have great customizing
opportunities with a special REST template configuration. You can think of basic Http authentication, read timeouts and
special message factory implementations. Just use the custom REST template attribute in client configuration like this:
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public HttpClient httpClient() {
    return new HttpClientBuilder()
        .requestUrl("http://localhost:8080/hello")
        .requestMethod(HttpMethod.GET)
        .contentType("text/plain")
        .restTemplate(customizedRestTemplate())
        .timeout(60000L)
        .build();
}

@Bean
public RestTemplate customizedRestTemplate() {
    RestTemplate restTemplate = new RestTemplate();

    StringHttpMessageConverter converter = new StringHttpMessageConverter();
    converter.setSupportedMediaTypes(Collections.singletonList("text/plain"));

    restTemplate.setMessageConverters(Collections.singletonList(converter));

    restTemplate.setErrorHandler(customErrorHandler());

    HttpComponentsClientHttpRequestFactory requestFactory = new HttpComponentsClientHttpRequestFactory();
    requestFactory.setReadTimeout(9000L);

    restTemplate.setRequestFactory(requestFactory);

    return restTemplate;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-http:client id="httpClient"
                   request-url="http://localhost:8080/hello"
                   request-method="GET"
                   content-type="text/plain"
                   rest-template="customizedRestTemplate"/&gt;

&lt;!-- Customized rest template --&gt;
&lt;bean name="customizedRestTemplate" class="org.springframework.web.client.RestTemplate"&gt;
  &lt;property name="messageConverters"&gt;
    &lt;util:list id="converter"&gt;
      &lt;bean class="org.springframework.http.converter.StringHttpMessageConverter"&gt;
        &lt;property name="supportedMediaTypes"&gt;
          &lt;util:list id="types"&gt;
            &lt;value&gt;text/plain&lt;/value&gt;
          &lt;/util:list&gt;
        &lt;/property&gt;
      &lt;/bean&gt;
    &lt;/util:list&gt;
  &lt;/property&gt;
  &lt;property name="errorHandler"&gt;
    &lt;!-- Custom error handler --&gt;
    &lt;ref bean ="customErrorHandler"/&gt;
  &lt;/property&gt;
  &lt;property name="requestFactory"&gt;
    &lt;bean class="org.springframework.http.client.HttpComponentsClientHttpRequestFactory"&gt;
      &lt;property name="readTimeout" value="9000"/&gt;
    &lt;/bean&gt;
  &lt;/property&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Up to now we have used a generic <strong>send</strong> test action to send Http requests as a client. This is completely valid strategy
as the Citrus Http client is a normal message endpoint.</p>
</div>
<div class="paragraph">
<p>In order to simplify the Http usage in a test case Citrus also provides special test action implementations for Http.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
These Http specific actions are located in a separate XML namespace. In case you are writing XML test cases you need
to add this namespace to our test case XML first.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Add Citrus Http action namespace</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:http="http://www.citrusframework.org/schema/http/testcase"
        xsi:schemaLocation="
            http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.citrusframework.org/schema/http/testcase
            http://www.citrusframework.org/schema/http/testcase/citrus-http-testcase.xsd"&gt;

      [...]

    &lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test case is now ready to use the specific Http test actions.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">http().client("httpClient")
        .send()
        .post("/customer")
        .message()
        .body("&lt;customer&gt;" +
                "&lt;id&gt;citrus:randomNumber()&lt;/id&gt;" +
                "&lt;name&gt;testuser&lt;/name&gt;" +
              "&lt;/customer&gt;")
        .contentType(MediaType.APPLICATION_XML_VALUE)
        .accept(MediaType.APPLICATION_XML_VALUE)
        .header("X-CustomHeaderId", "${custom_header_id}");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:send-request client="httpClient"&gt;
  &lt;http:POST path="/customer"&gt;
    &lt;http:headers content-type="application/xml" accept="application/xml"&gt;
      &lt;http:header name="X-CustomHeaderId" value="${custom_header_id}"/&gt;
    &lt;/http:headers&gt;
    &lt;http:body&gt;
      &lt;http:data&gt;
        &lt;![CDATA[
          &lt;customer&gt;
            &lt;id&gt;citrus:randomNumber()&lt;/id&gt;
            &lt;name&gt;testuser&lt;/name&gt;
          &lt;/customer&gt;
        ]]&gt;
      &lt;/http:data&gt;
    &lt;/http:body&gt;
  &lt;/http:POST&gt;
&lt;/http:send-request&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The action above uses several Http specific settings such as the request method <strong>POST</strong> as well as the <strong>content-type</strong> and
<strong>accept</strong> headers. As usual the send action needs a target Http client endpoint component. We can specify a request <strong>path</strong>
attribute that added as relative path to the base uri used on the client.</p>
</div>
<div class="paragraph">
<p>When using a <strong>GET</strong> request we can specify some request uri parameters.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">http().client("httpClient")
        .send()
        .get("/customer/${custom_header_id}")
        .message()
        .contentType(MediaType.APPLICATION_XML_VALUE)
        .accept(MediaType.APPLICATION_XML_VALUE)
        .queryParam("type", "active");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:send-request client="httpClient"&gt;
  &lt;http:GET path="/customer/${custom_header_id}"&gt;
    &lt;http:params content-type="application/xml" accept="application/xml"&gt;
      &lt;http:param name="type" value="active"/&gt;
    &lt;/http:params&gt;
  &lt;/http:GET&gt;
&lt;/http:send-request&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The send action above uses a <strong>GET</strong> request on the endpoint uri <code><a href="http://localhost:8080/customer/1234?type=active" class="bare">http://localhost:8080/customer/1234?type=active</a></code>.</p>
</div>
<div class="paragraph">
<p>Of course when sending Http client requests we are also interested in receiving Http response messages. We want to validate
the success response with Http status code.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">http().client("httpClient")
        .receive()
        .response(HttpStatus.OK.value())
        .message()
        .body("&lt;customer&gt;" +
                "&lt;id&gt;citrus:randomNumber()&lt;/id&gt;" +
                "&lt;name&gt;testuser&lt;/name&gt;" +
              "&lt;/customer&gt;")
        .header("X-CustomHeaderId", "${custom_header_id}");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:receive-response client="httpClient"&gt;
  &lt;http:headers status="200" reason-phrase="OK" version="HTTP/1.1"&gt;
    &lt;http:header name="X-CustomHeaderId" value="${custom_header_id}"/&gt;
  &lt;/http:headers&gt;
  &lt;http:body&gt;
    &lt;http:data&gt;
      &lt;![CDATA[
          &lt;customerResponse&gt;
            &lt;success&gt;true&lt;/success&gt;
          &lt;/customerResponse&gt;
      ]]&gt;
    &lt;/http:data&gt;
  &lt;/http:body&gt;
&lt;/http:receive-response&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>receive-response</strong> test action also uses a client component. We can expect response status code information such as
<strong>status</strong> and <strong>reason-phrase</strong> . Of course Citrus will raise a validation exception in case Http status codes mismatch.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, the client component will add the <strong>Accept</strong> http header and set its value to a list of all supported encodings
on the host operating system. This list can get quite big so you may want to not set this default accept header. The setting
is done in the Spring RestTemplate:
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public RestTemplate customizedRestTemplate() {
    RestTemplate restTemplate = new RestTemplate();

    StringHttpMessageConverter converter = new StringHttpMessageConverter();
    converter.setWriteAcceptCharset(false);

    restTemplate.setMessageConverters(Collections.singletonList(converter));

    return restTemplate;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean name="customizedRestTemplate" class="org.springframework.web.client.RestTemplate"&gt;
    &lt;property name="messageConverters"&gt;
        &lt;util:list id="converter"&gt;
            &lt;bean class="org.springframework.http.converter.StringHttpMessageConverter"&gt;
                &lt;property name="writeAcceptCharset" value="false"/&gt;
            &lt;/bean&gt;
        &lt;/util:list&gt;
    &lt;/property&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add this custom RestTemplate configuration and set it to the client component with <strong>rest-template</strong> property. Fortunately the
Citrus client component provides a separate setting <strong>default-accept-header</strong> which is a Boolean setting. By default, this
setting is set to <strong>true</strong> so the default accept header is automatically added to all requests. If you set this flag to <strong>false</strong>
the header is not set:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public HttpClient httpClient() {
    return new HttpClientBuilder()
        .requestUrl("http://localhost:8080/hello")
        .requestMethod(HttpMethod.GET)
        .contentType("text/plain")
        .defaultAcceptHeader(false)
        .timeout(60000L)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-http:client id="httpClient"
                   request-url="http://localhost:8080/hello"
                   request-method="GET"
                   content-type="text/plain"
                   default-accept-header="false"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, you can set the <strong>Accept</strong> header on each send operation in order to tell the server what kind of content types
are supported in response messages.</p>
</div>
<div class="paragraph">
<p>Now we can send and receive messages as Http client with specific test actions. Now let&#8217;s move on to the Http server.</p>
</div>
</div>
<div class="sect2">
<h3 id="http-client-interceptors"><a class="anchor" href="#http-client-interceptors"></a><a class="link" href="#http-client-interceptors">14.2. Http client interceptors</a></h3>
<div class="paragraph">
<p>The client component is able to add custom interceptors that participate in the request/response processing. The interceptors
need to implement the common interface <strong>org.springframework.http.client.ClientHttpRequestInterceptor</strong>.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public HttpClient httpClient() {
    return new HttpClientBuilder()
        .requestUrl("http://localhost:8080/hello")
        .requestMethod(HttpMethod.GET)
        .interceptor(new LoggingClientInterceptor())
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-http:client id="httpClient"
                  request-url="http://localhost:8080/hello"
                  request-method="GET"
                  interceptors="clientInterceptors"/&gt;

&lt;util:list id="clientInterceptors"&gt;
  &lt;bean class="org.citrusframework.http.interceptor.LoggingClientInterceptor"/&gt;
&lt;/util:list&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sample above adds the Citrus logging client interceptor that logs requests and responses exchanged with that client
component. You can add custom interceptor implementations here in order to participate in the request/response message processing.</p>
</div>
</div>
<div class="sect2">
<h3 id="http-rest-server"><a class="anchor" href="#http-rest-server"></a><a class="link" href="#http-rest-server">14.3. Http REST server</a></h3>
<div class="paragraph">
<p>Receiving Http requests requires an Http server listening on a port on your local machine. Citrus offers an embedded Http
server which is capable of handling incoming Http requests. The server accepts client connections and must provide a proper
Http response. In the next section you will see how to simulate server side Http REST service with Citrus.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public HttpServer httpServer() {
    return new HttpServerBuilder()
        .port(8080)
        .autoStart(true)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-http:server id="httpServer"
                port="8080"
                auto-start="true"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus uses an embedded Jetty server that will automatically start when the Citrus context is loaded (auto-start="true").
The basic connector is listening on port <strong>8080</strong> for requests. Test cases can interact with this server instance via message
channels by default. The server provides an inbound channel that holds incoming request messages. The test case can receive
those requests from the channel with a normal receive test action. In a second step the test case can provide a synchronous
response message as reply which will be automatically sent back to the Http client as response.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/figure_008.jpg" alt="figure_008.jpg"></span></p>
</div>
<div class="paragraph">
<p>The figure above shows the basic setup with inbound channel and reply channel. You as a tester should not worry about this
too much. By default, you as a tester just use the server as synchronous endpoint in your test case. This means that you
simply receive a message from the server and send a response back.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("httpServer")
    .message()
    .body("...");

send("httpServer")
    .message()
    .body("...")
    .header(HttpMessageHeaders.HTTP_STATUS_CODE, 200);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="httpServer"&gt;
    &lt;message&gt;
        &lt;data&gt;
          [...]
        &lt;/data&gt;
    &lt;/message&gt;
&lt;/receive&gt;

&lt;send endpoint="httpServer"&gt;
    &lt;message&gt;
        &lt;data&gt;
          [...]
        &lt;/data&gt;
    &lt;/message&gt;
&lt;/send&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we reference the server id in both receive and send actions. The Citrus server instance will automatically
send the response back to the calling Http client. In most cases this is exactly what we want to do - send back a response
message that is specified inside the test. The Http server component by default uses a channel endpoint adapter in order to
forward all incoming requests to an in-memory message channel. This is done completely behind the scenes. The Http server
component provides some more customization possibilities when it comes to endpoint adapter implementations. This topic is
discussed in a separate section <a href="#endpoint-adapter">endpoint-adapter</a>. Up to now we keep it simple by synchronously receiving
and sending messages in the test case.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The default channel endpoint adapter automatically creates an inbound message channel where incoming messages are stored
too internally. So if you need to clean up a server that has already stored some incoming messages you can do this easily by
purging the internal message channel. The message channel follows a naming convention <strong>{serverName}.inbound</strong> where <strong>{serverName}</strong>
is the Spring bean name of the Citrus server endpoint component. If you purge this internal channel in a before test nature
you are sure that obsolete messages on a server instance get purged before each test is executed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So let&#8217;s get back to our mission of providing response messages as server to connected clients. As you might know Http REST
works with some characteristic properties when it comes to send and receive messages. For instance a client can send different
request methods GET, POST, PUT, DELETE, HEAD and so on. The Citrus server may verify this method when receiving client requests.
Therefore we have introduced special Http test actions for server communication. Have a look at a simple example:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">http().server("httpServer")
    .receive()
    .post("/test")
    .message()
    .contentType("application/xml")
    .accept("application/xml")
    .body("&lt;testRequestMessage&gt;" +
            "&lt;text&gt;Hello HttpServer&lt;/text&gt;" +
          "&lt;/testRequestMessage&gt;")
    .header("Authorization", "Basic c29tZVVzZXJuYW1lOnNvbWVQYXNzd29yZA==")
    .header("X-CustomHeaderId", "${custom_header_id}")
    .extract(extract().fromHeaders()
                .header("X-MessageId", "message_id"));

http().server("httpServer")
    .send()
    .response(HttpStatus.OK.value())
    .message()
    .contentType("application/xml")
    .body("&lt;testResponseMessage&gt;" +
            "&lt;text&gt;Hello Citrus&lt;/text&gt;" +
          "&lt;/testResponseMessage&gt;")
    .header("X-CustomHeaderId", "${custom_header_id}")
    .header("X-MessageId", "${message_id}");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:receive-request server="helloHttpServer"&gt;
  &lt;http:POST path="/test"&gt;
    &lt;http:headers content-type="application/xml" accept="application/xml, */*"&gt;
      &lt;http:header name="X-CustomHeaderId" value="${custom_header_id}"/&gt;
      &lt;http:header name="Authorization" value="Basic c29tZVVzZXJuYW1lOnNvbWVQYXNzd29yZA=="/&gt;
    &lt;/http:headers&gt;
    &lt;http:body&gt;
    &lt;http:data&gt;
      &lt;![CDATA[
        &lt;testRequestMessage&gt;
          &lt;text&gt;Hello HttpServer&lt;/text&gt;
        &lt;/testRequestMessage&gt;
      ]]&gt;
    &lt;/http:data&gt;
    &lt;/http:body&gt;
  &lt;/http:POST&gt;
  &lt;http:extract&gt;
    &lt;http:header name="X-MessageId" variable="message_id"/&gt;
  &lt;/http:extract&gt;
&lt;/http:receive-request&gt;

&lt;http:send-response server="helloHttpServer"&gt;
  &lt;http:headers status="200" reason-phrase="OK" version="HTTP/1.1"&gt;
    &lt;http:header name="X-MessageId" value="${message_id}"/&gt;
    &lt;http:header name="X-CustomHeaderId" value="${custom_header_id}"/&gt;
    &lt;http:header name="Content-Type" value="application/xml"/&gt;
  &lt;/http:headers&gt;
  &lt;http:body&gt;
  &lt;http:data&gt;
    &lt;![CDATA[
      &lt;testResponseMessage&gt;
        &lt;text&gt;Hello Citrus&lt;/text&gt;
      &lt;/testResponseMessage&gt;
    ]]&gt;
  &lt;/http:data&gt;
  &lt;/http:body&gt;
&lt;/http:send-response&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We receive a client request and validate that the request method is <strong>POST</strong> on request path <strong>/test</strong> . Now we can validate
special message headers such as <strong>content-type</strong> . In addition to that we can check custom headers and basic authorization
headers. As usual the optional message body is compared to an expected message template. The custom <strong>X-MessageId</strong> header
is saved to a test variable <strong>message_id</strong> for later usage in the response.</p>
</div>
<div class="paragraph">
<p>The response message defines Http typical entities such as <strong>status</strong> and <strong>reason-phrase</strong>. Here the tester can simulate
<strong>404 NOT_FOUND</strong> errors or similar other status codes that get sent back to the client. In our example everything is <strong>OK</strong>
and we send back a response body and some custom header entries.</p>
</div>
<div class="paragraph">
<p>That is basically how Citrus simulates Http server operations. We receive the client request and validate the request properties.
Then we send back a response with an Http status code.</p>
</div>
<div class="paragraph">
<p>This completes the server actions on Http message transport. Now we continue with some more Http specific settings and features.</p>
</div>
</div>
<div class="sect2">
<h3 id="http-headers"><a class="anchor" href="#http-headers"></a><a class="link" href="#http-headers">14.4. Http headers</a></h3>
<div class="paragraph">
<p>When dealing with Http request/response communication we always deal with Http specific headers. The Http protocol defines
a group of header attributes that both client and server need to be able to handle. You can set and validate these Http
headers in Citrus quite easy. Let us have a look at a client operation in Citrus where some Http headers are explicitly
set before the request is sent out.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">http().client("httpClient")
    .send()
    .post()
    .message()
    .contentType("application/xml")
    .accept("application/xml")
    .body("&lt;testRequestMessage&gt;" +
            "&lt;text&gt;Hello HttpServer&lt;/text&gt;" +
          "&lt;/testRequestMessage&gt;")
    .header("X-CustomHeaderId", "${custom_header_id}");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:send-request client="httpClient"&gt;
  &lt;http:POST&gt;
    &lt;http:headers&gt;
        &lt;http:header name="X-CustomHeaderId" value="${custom_header_id}"/&gt;
        &lt;http:header name="Content-Type" value="application/xml"/&gt;
        &lt;http:header name="Accept" value="application/xml"/&gt;
    &lt;/http:headers&gt;
    &lt;http:body&gt;
        &lt;http:payload&gt;
            &lt;testRequestMessage&gt;
                &lt;text&gt;Hello HttpServer&lt;/text&gt;
            &lt;/testRequestMessage&gt;
        &lt;/http:payload&gt;
    &lt;/http:body&gt;
  &lt;/http:POST&gt;
&lt;/http:send-request&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are able to set custom headers (<strong>X-CustomHeaderId</strong>) that go directly into the Http header section of the request. In
addition to that testers can explicitly set Http reserved headers such as <strong>Content-Type</strong> . Fortunately you do not have
to set all headers on your own. Citrus will automatically set the required Http headers for the request. So we have the
following Http request which is sent to the server:</p>
</div>
<div class="listingblock">
<div class="title">Sample Http request</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">POST /test HTTP/1.1
Accept: application/xml
Content-Type: application/xml
X-CustomHeaderId: 123456789
Accept-Charset: macroman
User-Agent: Jakarta Commons-HttpClient/3.1
Host: localhost:8091
Content-Length: 175
&lt;testRequestMessage&gt;
    &lt;text&gt;Hello HttpServer&lt;/text&gt;
&lt;/testRequestMessage&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>On server side testers are interested in validating the Http headers. Within Citrus receive action you simply define the
expected header entries. The Http specific headers are automatically available for validation as you can see in this example:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">http().server("httpServer")
    .receive()
    .post()
    .message()
    .contentType("application/xml")
    .accept("application/xml")
    .body("&lt;testRequestMessage&gt;" +
            "&lt;text&gt;Hello HttpServer&lt;/text&gt;" +
          "&lt;/testRequestMessage&gt;")
    .header("X-CustomHeaderId", "${custom_header_id}");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:receive-request server="httpServer"&gt;
  &lt;http:POST&gt;
    &lt;http:headers&gt;
        &lt;http:header name="X-CustomHeaderId" value="${custom_header_id}"/&gt;
        &lt;http:header name="Content-Type" value="application/xml"/&gt;
        &lt;http:header name="Accept" value="application/xml"/&gt;
    &lt;/http:headers&gt;
    &lt;http:body&gt;
        &lt;http:payload&gt;
            &lt;testRequestMessage&gt;
                &lt;text&gt;Hello HttpServer&lt;/text&gt;
            &lt;/testRequestMessage&gt;
        &lt;/http:payload&gt;
    &lt;/http:body&gt;
  &lt;/http:POST&gt;
&lt;/http:receive-request&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test checks on custom headers and Http specific headers to meet the expected values.</p>
</div>
<div class="paragraph">
<p>Now that we have accepted the client request and validated the contents we are able to send back a proper Http response
message. Same thing here with Http specific headers. The Http protocol defines several headers marking the success or failure
of the server operation. In the test case you can set those headers for the response message with conventional Citrus header
names. See the following example to find out how that works for you.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">http().server("httpServer")
    .send()
    .response(HttpStatus.OK.value())
    .message()
    .contentType("application/xml")
    .body("&lt;testResponseMessage&gt;" +
            "&lt;text&gt;Hello Citrus&lt;/text&gt;" +
          "&lt;/testResponseMessage&gt;")
    .header("X-CustomHeaderId", "${custom_header_id}");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:send-response server="httpServer"&gt;
    &lt;http:headers status="200" reason-phrase="OK"&gt;
        &lt;http:header name="X-CustomHeaderId" value="${custom_header_id}"/&gt;
        &lt;http:header name="Content-Type" value="application/xml"/&gt;
    &lt;/http:headers&gt;
    &lt;http:body&gt;
        &lt;http:payload&gt;
            &lt;testResponseMessage&gt;
                &lt;text&gt;Hello Citrus&lt;/text&gt;
            &lt;/testResponseMessage&gt;
        &lt;/http:payload&gt;
    &lt;/http:body&gt;
&lt;/http:send-response&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once more we set the custom header entry (<strong>X-CustomHeaderId</strong>) and an Http reserved header (<strong>Content-Type</strong>) for the response
message. On top of this we are able to set the response status for the Http response. We use the reserved header names <strong>status</strong>
in order to mark the success of the server operation. With this mechanism we can easily simulate different server behaviour
such as Http error response codes (e.g. 404 - Not found, 500 - Internal error). Let us have a closer look at the generated
response message:</p>
</div>
<div class="listingblock">
<div class="title">Sample Http response</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">HTTP/1.1 200 OK
Content-Type: application/xml;charset=UTF-8
Accept-Charset: macroman
Content-Length: 205
Server: Jetty(7.0.0.pre5)
&lt;testResponseMessage&gt;
    &lt;text&gt;Hello Citrus Client&lt;/text&gt;
&lt;/testResponseMessage&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You do not have to set the reason phrase all the time. It is sufficient to only set the Http status code. Citrus will
automatically add the proper reason phrase for well known Http status codes.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The only thing that is missing right now is the validation of Http status codes when receiving the server response in a
Citrus test case. It is very easy as you can use the Citrus reserved header names for validation, too.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">http().client("httpClient")
    .receive()
    .response(HttpStatus.OK.value())
    .message()
    .contentType("application/xml")
    .body("&lt;testResponseMessage&gt;" +
            "&lt;text&gt;Hello Citrus&lt;/text&gt;" +
          "&lt;/testResponseMessage&gt;")
    .header("X-CustomHeaderId", "${custom_header_id}");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:receive-response client="httpClient"&gt;
    &lt;http:headers status="200" reason-phrase="OK" version="HTTP/1.1"&gt;
        &lt;http:header name="X-CustomHeaderId" value="${custom_header_id}"/&gt;
    &lt;/http:headers&gt;
    &lt;http:body&gt;
        &lt;http:payload&gt;
            &lt;testResponseMessage&gt;
                &lt;text&gt;Hello Citrus&lt;/text&gt;
            &lt;/testResponseMessage&gt;
        &lt;/http:payload&gt;
    &lt;/http:body&gt;
&lt;/http:receive-response&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Be aware of the slight differences in request URI and context path. The context path gives you the web application
context path within the servlet container for your web application. The request URI always gives you the complete path that
was called for this request.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you can see we are able to validate all parts of the initial request endpoint URI the client was calling. This completes
the Http header processing within Citrus. On both client and server side Citrus is able to set and validate Http specific
header entries which is essential for simulating Http communication.</p>
</div>
</div>
<div class="sect2">
<h3 id="http-query-params"><a class="anchor" href="#http-query-params"></a><a class="link" href="#http-query-params">14.5. Http query parameter</a></h3>
<div class="paragraph">
<p>Up to now we have used some of the basic Citrus reserved Http header names (status, version, reason-phrase). In Http RESTful
services some other header names are essential for validation. These are request attributes like query parameters, context
path and request URI. The Citrus server side REST message controller will automatically add all this information to the message
header for you. So all you need to do is validate the header entries in your test.</p>
</div>
<div class="paragraph">
<p>The next example receives an Http GET method request on server side. Here the GET request does not have any message payload,
so the validation just works on the information given in the message header. We assume the client to call <code><a href="http://localhost:8080/app/users?id=123456789" class="bare">http://localhost:8080/app/users?id=123456789</a></code>.
As a tester we need to validate the request method, request URI, context path and the query parameters.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">http()
    .server(httpServer)
    .receive()
    .get("/api/users")
    .message()
    .queryParam("id", "123456789")
    .contentType(MediaType.APPLICATION_XML_VALUE)
    .accept(MediaType.APPLICATION_XML_VALUE)
    .header("Host", "localhost:8080");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:receive-request server="httpServer"&gt;
  &lt;http:GET path="/api/users" context-path="/app"&gt;
    &lt;http:params&gt;
        &lt;http:param name="id" value="123456789"/&gt;
    &lt;/http:params&gt;
    &lt;http:headers content-type="application/xml" accept="application/xml"&gt;
        &lt;http:header name="Host" value="localhost:8080"/&gt;
    &lt;/http:headers&gt;
    &lt;http:body&gt;
        &lt;http:data&gt;&lt;/http:data&gt;
    &lt;/http:body&gt;
  &lt;/http:GET&gt;
&lt;/http:receive-request&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The http server is able to validate incoming Http query parameters. You can add as many parameters as you would like to
verify. Each parameter value is able to use test variables and validation matcher expressions as usual.</p>
</div>
<div class="paragraph">
<p>On the client side we are able to send query parameters in our request.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">http()
    .client(httpClient)
    .send()
    .get("/api/users")
    .message()
    .queryParam("id", "123456789")
    .contentType(MediaType.APPLICATION_XML_VALUE)
    .accept(MediaType.APPLICATION_XML_VALUE);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:send-request client="httpClient"&gt;
  &lt;http:GET path="/app/users"&gt;
    &lt;http:params&gt;
        &lt;http:param name="id" value="123456789"/&gt;
    &lt;/http:params&gt;
    &lt;http:headers content-type="application/xml" accept="application/xml"/&gt;
    &lt;http:body&gt;
        &lt;http:data&gt;&lt;/http:data&gt;
    &lt;/http:body&gt;
  &lt;/http:GET&gt;
&lt;/http:send-request&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The parameters are automatically added to the request URL that is configured on the <code>httpClient</code> component.</p>
</div>
</div>
<div class="sect2">
<h3 id="http-server-interceptors"><a class="anchor" href="#http-server-interceptors"></a><a class="link" href="#http-server-interceptors">14.6. Http server interceptors</a></h3>
<div class="paragraph">
<p>The server component is able to add custom interceptors that participate in the request/response processing. The interceptors
need to implement the common interface <strong>org.springframework.web.servlet.HandlerInterceptor</strong>.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public HttpServer httpServer() {
    return new HttpServerBuilder()
        .port(8080)
        .autoStart(true)
        .interceptor(new LoggingHandlerInterceptor())
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-http:server id="httpServer"
                  port="8080"
                  auto-start="true"
                  interceptors="serverInterceptors"/&gt;

&lt;util:list id="serverInterceptors"&gt;
  &lt;bean class="org.citrusframework.http.interceptor.LoggingHandlerInterceptor"/&gt;
&lt;/util:list&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sample above adds the Citrus logging handler interceptor that logs requests and responses exchanged with that server
component. You can add custom interceptor implementations here in order to participate in the request/response message processing.</p>
</div>
</div>
<div class="sect2">
<h3 id="http-form-urlencoded-data"><a class="anchor" href="#http-form-urlencoded-data"></a><a class="link" href="#http-form-urlencoded-data">14.7. Http form urlencoded data</a></h3>
<div class="paragraph">
<p>HTML form data can be sent to the server using different methods and content types. One of them is a POST method with <strong>x-www-form-urlencoded</strong>
body content. The form data elements are sent to the server using key-value pairs POST data where the form control name is
the key and the control data is the url encoded value.</p>
</div>
<div class="paragraph">
<p>Form urlencoded form data content could look like this:</p>
</div>
<div class="listingblock">
<div class="title">Form urlencoded data</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">password=s%21cr%21t&amp;username=foo</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the form data is automatically encoded. In the example above we transmit two form controls <strong>password</strong> and
<strong>username</strong> with respective values <strong>s$cr$t</strong> and <strong>foo</strong> . In case we would validate this form data in Citrus we are able to
do this with plaintext message validation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("httpServer")
    .message()
    .type(MessageType.PLAINTEXT)
    .body("password=s%21cr%21t&amp;username=${username}")
    .header(HttpMessageHeaders.HTTP_REQUEST_METHOD, HttpMethod.POST.name())
    .header(HttpMessageHeaders.HTTP_REQUEST_URI, "/form-test")
    .header(HttpMessageHeaders.HTTP_CONTENT_TYPE, "application/x-www-form-urlencoded");

send("httpServer")
    .message()
    .header(HttpMessageHeaders.HTTP_STATUS_CODE, 200);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="httpServer"&gt;
  &lt;message type="plaintext"&gt;
    &lt;data&gt;
      &lt;![CDATA[
        password=s%21cr%21t&amp;username=${username}
      ]]&gt;
    &lt;/data&gt;
  &lt;/message&gt;
  &lt;header&gt;
    &lt;element name="citrus_http_method" value="POST"/&gt;
    &lt;element name="citrus_http_request_uri" value="/form-test"/&gt;
    &lt;element name="Content-Type" value="application/x-www-form-urlencoded"/&gt;
  &lt;/header&gt;
&lt;/receive&gt;

&lt;send endpoint="httpServer"&gt;
  &lt;message&gt;
    &lt;data&gt;&lt;/data&gt;
  &lt;/message&gt;
  &lt;header&gt;
    &lt;element name="citrus_http_status_code" value="200"/&gt;
  &lt;/header&gt;
&lt;/send&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Obviously validating these key-value pair character sequences can be hard especially when having HTML forms with lots of
form controls. This is why Citrus provides a special message validator for <strong>x-www-form-urlencoded</strong> contents. First of all
we have to add <strong>citrus-http</strong> module as dependency to our project if we have not done so yet. After that we can add the validator
implementation to the list of message validators used in Citrus.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public FormUrlEncodedMessageValidator formUrlEncodedMessageValidator() {
    return new FormUrlEncodedMessageValidator();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:message-validators&gt;
  &lt;citrus:validator class="org.citrusframework.http.validation.FormUrlEncodedMessageValidator"/&gt;
&lt;/citrus:message-validators&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we are able to receive the urlencoded form data message in a test.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive("httpServer")
    .message()
    .type("x-www-form-urlencoded")
    .body("&lt;form-data xmlns=\"http://www.citrusframework.org/schema/http/message\"&gt;\n" +
            "&lt;content-type&gt;application/x-www-form-urlencoded&lt;/content-type&gt;\n" +
            "&lt;action&gt;/form-test&lt;/action&gt;\n" +
            "&lt;controls&gt;\n" +
                "&lt;control name=\"password\"&gt;\n" +
                    "&lt;value&gt;${password}&lt;/value&gt;\n" +
                "&lt;/control&gt;\n" +
                "&lt;control name=\"username\"&gt;\n" +
                    "&lt;value&gt;${username}&lt;/value&gt;\n" +
                "&lt;/control&gt;\n" +
            "&lt;/controls&gt;\n" +
            "&lt;/form-data&gt;")
    .header(HttpMessageHeaders.HTTP_REQUEST_METHOD, HttpMethod.POST.name())
    .header(HttpMessageHeaders.HTTP_REQUEST_URI, "/form-test")
    .header(HttpMessageHeaders.HTTP_CONTENT_TYPE, "application/x-www-form-urlencoded");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="httpServer"&gt;
  &lt;message type="x-www-form-urlencoded"&gt;
    &lt;payload&gt;
      &lt;form-data xmlns="http://www.citrusframework.org/schema/http/message"&gt;
        &lt;content-type&gt;application/x-www-form-urlencoded&lt;/content-type&gt;
        &lt;action&gt;/form-test&lt;/action&gt;
        &lt;controls&gt;
          &lt;control name="password"&gt;
            &lt;value&gt;${password}&lt;/value&gt;
          &lt;/control&gt;
          &lt;control name="username"&gt;
            &lt;value&gt;${username}&lt;/value&gt;
          &lt;/control&gt;
        &lt;/controls&gt;
      &lt;/form-data&gt;
    &lt;/payload&gt;
  &lt;/message&gt;
  &lt;header&gt;
    &lt;element name="citrus_http_method" value="POST"/&gt;
    &lt;element name="citrus_http_request_uri" value="/form-test"/&gt;
    &lt;element name="Content-Type" value="application/x-www-form-urlencoded"/&gt;
  &lt;/header&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We use a special message type <strong>x-www-form-urlencoded</strong> so the new message validator will take action. The form url encoded
message validator is able to handle a special XML representation of the form data. This enables the very powerful XML
message validation capabilities of Citrus such as ignoring elements and usage of test variables inline.</p>
</div>
<div class="paragraph">
<p>Each form control is translated to a control element with respective name and value properties. The form data is validated
in a more comfortable way as the plaintext message validator would be able to offer.</p>
</div>
</div>
<div class="sect2">
<h3 id="http-error-handling"><a class="anchor" href="#http-error-handling"></a><a class="link" href="#http-error-handling">14.8. Http error handling</a></h3>
<div class="paragraph">
<p>So far we have received response messages with Http status code <strong>200 OK</strong> . How to deal with server errors like <strong>404 Not
Found</strong> or <strong>500 Internal server error</strong> ? The default Http message client error strategy is to propagate server error response
messages to the receive action for validation. We simply check on Http status code and status text for error validation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">http().client("httpClient")
        .send()
        .post()
        .message()
        .body("&lt;testRequestMessage&gt;" +
                "&lt;text&gt;Hello HttpServer&lt;/text&gt;" +
              "&lt;/testRequestMessage&gt;");

http().client("httpClient")
        .receive()
        .response(HttpStatus.FORBIDDEN.value());</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:send-request client="httpClient"&gt;
    &lt;http:POST&gt;
        &lt;http:body&gt;
            &lt;http:payload&gt;
                &lt;testRequestMessage&gt;
                    &lt;text&gt;Hello HttpServer&lt;/text&gt;
                &lt;/testRequestMessage&gt;
            &lt;/http:payload&gt;
        &lt;/http:body&gt;
    &lt;/http:POST&gt;
&lt;/http:send-request&gt;

&lt;http:receive-response client="httpClient"&gt;
    &lt;http:headers status="403" reason-phrase="FORBIDDEN"/&gt;
    &lt;http:body&gt;
        &lt;http:data&gt;&lt;![CDATA[]]&gt;&lt;/http:data&gt;
    &lt;/http:body&gt;
&lt;/http:receive-response&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message data can be empty depending on the server logic for these error situations. If we receive additional error
information as message payload just add validation assertions as usual.</p>
</div>
<div class="paragraph">
<p>Instead of receiving such empty messages with checks on Http status header information we can change the error strategy in
the message sender component in order to automatically raise exceptions on response messages other than <strong>200 OK</strong> . Therefore
we go back to the Http message sender configuration for changing the error strategy.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public HttpClient httpClient() {
    return new HttpClientBuilder()
        .requestUrl("http://localhost:8080/test")
        .errorHandlingStrategy(ErrorHandlingStrategy.THROWS_EXCEPTION)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-http:client id="httpClient"
                  request-url="http://localhost:8080/test"
                  error-strategy="throwsException"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we expect an exception to be thrown because of the error response. Following from that we have to change our test case.
Instead of receiving the error message with receive action we assert the client exception and check on the Http status code
and status text.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">assertException()
    .exception(HttpClientErrorException.class)
    .message("403 Forbidden")
    .when(
        http().client("httpClient")
            .send()
            .post()
            .message()
            .body("&lt;testRequestMessage&gt;" +
                    "&lt;text&gt;Hello HttpServer&lt;/text&gt;" +
                  "&lt;/testRequestMessage&gt;")
    );</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;assert exception="org.springframework.web.client.HttpClientErrorException"
           message="403 Forbidden"&gt;
    &lt;when&gt;
        &lt;http:send-request client="httpClient"&gt;
            &lt;http:body&gt;
                &lt;http:payload&gt;
                    &lt;testRequestMessage&gt;
                        &lt;text&gt;Hello HttpServer&lt;/text&gt;
                    &lt;/testRequestMessage&gt;
                &lt;/http:payload&gt;
            &lt;/http:body&gt;
        &lt;/http:send-request&gt;
    &lt;/when&gt;
&lt;/assert&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both ways of handling Http error messages on client side are valid for expecting the server to raise Http error codes. Choose
the preferred way according to your test project requirements.</p>
</div>
</div>
<div class="sect2">
<h3 id="http-client-basic-authentication"><a class="anchor" href="#http-client-basic-authentication"></a><a class="link" href="#http-client-basic-authentication">14.9. Http client basic authentication</a></h3>
<div class="paragraph">
<p>As a client you may have to authenticate properly in order to access a resource on the server.
In many cases this will be basic authentication with username/password where the credentials are transmitted in the request header section with base64 encoding.</p>
</div>
<div class="paragraph">
<p>The easiest approach to set the <strong>Authorization</strong> header for a basic authentication Http request would be to explicitly set the header in the send action definition.
Of course, you have to use the correct basic authentication header syntax with base64 encoding for the username:password phrase.
See how it works in this simple example.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">http().client("httpClient")
    .send()
    .get()
    .message()
    .header("Authorization", "Basic c29tZVVzZXJuYW1lOnNvbWVQYXNzd29yZA==");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:send-request client="httpClient"&gt;
  &lt;http:GET&gt;
    &lt;http:headers&gt;
      &lt;http:header name="Authorization" value="Basic c29tZVVzZXJuYW1lOnNvbWVQYXNzd29yZA=="/&gt;
    &lt;/http:headers&gt;
  &lt;/http:GET&gt;
&lt;/http:send-request&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus will add this header to the Http requests and the server will read the <strong>Authorization</strong> username and password.
For more convenient base64 encoding you can also use a Citrus function <code>citrus:encodeBase64(username:password)</code>.
See <a href="#functions-encode-base64">functions-encode-base64</a> for more details.</p>
</div>
<div class="paragraph">
<p>Instead of adding the Http <strong>Authorization</strong> header manually you can also enable the basic authentication on the Http client endpoint.
Simply configure the basic authentication credentials on the Citrus Http client component.
Just see the following example and learn how to do that.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public HttpClient httpClient() {
    return new HttpClientBuilder()
        .requestUrl("http://localhost:8080/test")
        .authentication(HttpAuthentication.basic("username", "password"))
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-http:client id="httpClient"
                    request-url="http://localhost:8080/test"
                    request-factory="clientRequestFactory"/&gt;

&lt;bean id="clientRequestFactory"
    class="org.citrusframework.http.security.HttpClientRequestFactoryBean"&gt;
    &lt;constructor-arg&gt;
        &lt;bean class="org.citrusframework.http.security.BasicAuthentication"&gt;
            &lt;constructor-arg value="username"/&gt;
            &lt;constructor-arg value="password"/&gt;
        &lt;/bean&gt;
    &lt;/constructor-arg&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case you need a more powerful configuration of the basic authentication you can also directly use the request factory as a configuration item for basic authentication.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public HttpClient httpClient() {
    return new HttpClientBuilder()
        .requestUrl("http://localhost:8080/test")
        .requestFactory(basicAuthFactory())
        .build();
}

@Bean
public BasicAuthClientHttpRequestFactory basicAuthFactory() {
    BasicAuthClientHttpRequestFactory factory = new BasicAuthClientHttpRequestFactory();

    AuthScope scope = new AuthScope("localhost", "8080", "", "basic");
    factory.setAuthScope(scope);

    UsernamePasswordCredentials credentials = new UsernamePasswordCredentials("username", "password");
    factory.setCredentials(credentials);

    return factory;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-http:client id="httpClient"
                    request-url="http://localhost:8080/test"
                    request-factory="basicAuthFactory"/&gt;

&lt;bean id="basicAuthFactory"
    class="org.citrusframework.http.client.BasicAuthClientHttpRequestFactory"&gt;
  &lt;property name="authScope"&gt;
      &lt;bean class="org.apache.hc.client5.http.auth.AuthScope"&gt;
        &lt;constructor-arg value="localhost"/&gt;
        &lt;constructor-arg value="8080"/&gt;
      &lt;/bean&gt;
  &lt;/property&gt;
  &lt;property name="credentials"&gt;
    &lt;bean class="org.apache.hc.client5.http.auth.UsernamePasswordCredentials"&gt;
        &lt;constructor-arg value="username"/&gt;
        &lt;constructor-arg value="password"/&gt;
    &lt;/bean&gt;
  &lt;/property&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The advantage of setting the basic authentication on the Http client is obvious.
All test actions that reference the client component will automatically use the basic authentication.</p>
</div>
<div class="paragraph">
<p>The above configuration results in Http client requests with authentication headers properly set for basic authentication.
The client request factory takes care of adding the proper basic authentication header to each request that is sent with this
Citrus message sender. Citrus uses preemptive authentication. The message sender only sends a single request to the server
with all authentication information set in the message header. The request which determines the authentication scheme on the
server is skipped. This is why you have to add some auth scope in the client request factory so Citrus can set up an authentication
cache within the Http context in order to have preemptive authentication.</p>
</div>
<div class="paragraph">
<p>As a result of the basic auth client request factory the following example request that is created by the Citrus Http client
has the <strong>Authorization</strong> header set. This is done now automatically for all requests with this Http client.</p>
</div>
<div class="listingblock">
<div class="title">Sample request with basic authentication</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">POST /test HTTP/1.1
Accept: application/xml
Content-Type: application/xml
Accept-Charset: iso-8859-1, us-ascii, utf-8
Authorization: Basic c29tZVVzZXJuYW1lOnNvbWVQYXNzd29yZA==
User-Agent: Jakarta Commons-HttpClient/3.1
Host: localhost:8080
Content-Length: 175
&lt;testRequestMessage&gt;
  &lt;text&gt;Hello HttpServer&lt;/text&gt;
&lt;/testRequestMessage&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="http-server-basic-authentication"><a class="anchor" href="#http-server-basic-authentication"></a><a class="link" href="#http-server-basic-authentication">14.10. Http server basic authentication</a></h3>
<div class="paragraph">
<p>The Citrus Http server is able to configure basic authentication so clients need to authenticate properly when accessing server resources.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public HttpServer httpServer() {
    return new HttpServerBuilder()
        .port(8080)
        .autoStart(true)
        .authentication("/foo/*", HttpAuthentication.basic("username", "password"))
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-http:server id="basicAuthHttpServer"
                port="8080"
                auto-start="true"
                security-handler="securityHandlerFactory"/&gt;

&lt;bean id="securityHandlerFactory" class="org.citrusframework.http.security.HttpSecurityHandlerFactoryBean"&gt;
    &lt;constructor-arg&gt;
        &lt;bean class="org.citrusframework.http.security.BasicAuthentication"&gt;
            &lt;constructor-arg value="username"/&gt;
            &lt;constructor-arg value="password"/&gt;
            &lt;property name="resourcePath" value="/foo/*"/&gt;
        &lt;/bean&gt;
    &lt;/constructor-arg&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case you need a more powerful server configuration you can also set the security handler directly.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public HttpServer httpServer() {
    return new HttpServerBuilder()
        .port(8080)
        .autoStart(true)
        .securityHandler(securityHandler())
        .build();
}

@Bean
public SecurityHandlerFactory securityHandler() {
    SecurityHandlerFactory factory = new SecurityHandlerFactory();

    User user = new User();
    user.setName("citrus");
    user.setPassword("secret");
    user.setRoles("CitrusRole");
    factory.setUsers(Collections.singletonList(user));

    factory.setConstraints(Collections.singletonMap("/foo/*",
                                    new BasicAuthConstraint("CitrusRole")));

    return factory;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-http:server id="basicAuthHttpServer"
                port="8080"
                auto-start="true"
                security-handler="securityHandler"/&gt;

&lt;bean id="securityHandler" class="org.citrusframework.http.security.SecurityHandlerFactory"&gt;
    &lt;property name="users"&gt;
        &lt;list&gt;
            &lt;bean class="org.citrusframework.http.security.User"&gt;
                &lt;property name="name" value="citrus"/&gt;
                &lt;property name="password" value="secret"/&gt;
                &lt;property name="roles" value="CitrusRole"/&gt;
            &lt;/bean&gt;
        &lt;/list&gt;
    &lt;/property&gt;
    &lt;property name="constraints"&gt;
        &lt;map&gt;
            &lt;entry key="/foo/*"&gt;
                &lt;bean class="org.citrusframework.http.security.BasicAuthConstraint"&gt;
                    &lt;constructor-arg value="CitrusRole"/&gt;
                &lt;/bean&gt;
            &lt;/entry&gt;
        &lt;/map&gt;
    &lt;/property&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have set a security handler on the server web container with a constraint on all resources with <code>/foo/*</code>. Following
from that the server requires basic authentication for these resources. The granted users and roles are specified within
the security handler bean definition. Connecting clients have to set the basic auth Http header properly using the correct
user and role for accessing the Citrus server now.</p>
</div>
<div class="paragraph">
<p>You can customize the security handler for your very specific needs (e.g. load users and roles with JDBC from a database).
Just have a look at the code base and inspect the settings and properties offered by the security handler interface.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This mechanism is not restricted to basic authentication only. With other settings you can also set up digest or form-based
authentication constraints very easy.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="http-client-ssl"><a class="anchor" href="#http-client-ssl"></a><a class="link" href="#http-client-ssl">14.11. Http client SSL</a></h3>
<div class="paragraph">
<p>You can use SSL when establishing a client connection with the server.
The Citrus Http client supports a secure connection with these settings.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public HttpClient httpClient() {
    return new HttpClientBuilder()
        .requestUrl("https://localhost:8080/test")
        .secured(HttpSecureConnection.ssl())
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-http:client id="httpClient"
                    request-url="http://localhost:8080/test"
                    connection-manager="sslConnectionManager"/&gt;

&lt;bean id="sslConnectionManager"
    class="org.citrusframework.http.security.HttpClientConnectionManagerFactory"&gt;
    &lt;constructor-arg&gt;
        &lt;bean class="org.citrusframework.http.security.SSLConnection"/&gt;
    &lt;/constructor-arg&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example Http client uses SSL secure connection.
By default, the client will accept any server certificates and hostnames often referred to as trust-all-strategy.</p>
</div>
<div class="paragraph">
<p>You may want to also use a proper trust store to explicitly accept server certificates.
The client by default allows self-signed certificates.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public HttpClient sslHttpClient() {
    return new HttpClientBuilder()
        .requestUrl("https://localhost:8080/test")
        .secured(HttpSecureConnection.ssl()
            .trustStore("path/to/server.jks", "trustStorePassword"))
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-http:client id="sslHttpClient"
                    request-url="http://localhost:8080/test"
                    connection-manager="sslConnectionManager"/&gt;

&lt;bean id="sslConnectionManager"
    class="org.citrusframework.http.security.HttpClientConnectionManagerFactory"&gt;
    &lt;constructor-arg&gt;
        &lt;bean class="org.citrusframework.http.security.SSLConnection"&gt;
            &lt;constructor-arg value="path/to/server.jks"/&gt;
            &lt;constructor-arg value="trustStorePassword"/&gt;
        &lt;/bean&gt;
    &lt;/constructor-arg&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You need to provide a key store file (.jks) and a password to access the certificates located in the store.
The client now will do proper SSL handshake with the server in order to use secure connections.</p>
</div>
</div>
<div class="sect2">
<h3 id="http-server-ssl"><a class="anchor" href="#http-server-ssl"></a><a class="link" href="#http-server-ssl">14.12. Http server SSL</a></h3>
<div class="paragraph">
<p>The Citrus Http server is able to configure a SSL connector so clients need to use secure connections to access the server resources.
The connector</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public HttpServer sslHttpServer() {
    return new HttpServerBuilder()
        .port(8080)
        .autoStart(true)
        .secured(8443, HttpSecureConnection.ssl()
            .keyStore("path/to/server.jks", "keyStorePassword"))
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-http:server id="sslHttpServer"
                port="8080"
                auto-start="true"
                connector="serverConnectorFactory"/&gt;

&lt;bean id="serverConnectorFactory" class="org.citrusframework.http.security.HttpServerConnectorFactory"&gt;
    &lt;constructor-arg&gt;
        &lt;bean class="org.citrusframework.http.security.SSLConnection"&gt;
            &lt;constructor-arg value="path/to/server.jks"/&gt;
            &lt;constructor-arg value="trustStorePassword"/&gt;
            &lt;property name="securePort" value="8443"/&gt;
        &lt;/bean&gt;
    &lt;/constructor-arg&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The server now uses a <code>securePort</code> and a server certificate.
In most cases the certificate in a test environment is self-signed so please make sure to allow self-signed certificates in your clients.</p>
</div>
</div>
<div class="sect2">
<h3 id="http-cookies"><a class="anchor" href="#http-cookies"></a><a class="link" href="#http-cookies">14.13. Http cookies</a></h3>
<div class="paragraph">
<p>Cookies hold any kind of information and are saved as test information on the client side. Http servers are able to instruct
the client (browser) to save a new cookie with name, value and some attributes. This is usually done with a <em>"Set-Cookie"</em> message
header set on the server response message. Citrus is able to add those cookie information in a server response.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Cookie cookie = new Cookie("Token", "${messageId}");
cookie.setPath("/test/cookie.py");
cookie.setSecure(false);
cookie.setDomain("citrusframework.org");
cookie.setMaxAge(86400);

http().server("httpServer")
    .receive()
    .post()
    .message()
    .body("Some request data")
    .header("Operation", "sayHello");

http().server("httpServer")
    .send()
    .response(HttpStatus.OK.value())
    .message()
    .body("Some response body")
    .header("Operation", "sayHello")
    .cookie(cookie);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:receive-request server="httpServer"&gt;
    &lt;http:POST&gt;
        &lt;http:headers&gt;
            &lt;http:header name="Operation" value="getCookie"/&gt;
        &lt;/http:headers&gt;
    &lt;http:body&gt;
        &lt;http:data&gt;
            &lt;![CDATA[
            Some request data
            ]]&gt;
        &lt;/http:data&gt;
    &lt;/http:body&gt;
    &lt;/http:POST&gt;
&lt;/http:receive-request&gt;

&lt;http:send-response server="httpServer"&gt;
    &lt;http:headers status="200" reason-phrase="OK" version="HTTP/1.1"&gt;
        &lt;http:header name="Operation" value="getCookie"/&gt;
        &lt;http:cookie name="Token"
                     value="${messageId}"
                     secure="false"
                     domain="citrusframework.org"
                     path="/test/cookie.py"
                     max-age="86400"/&gt;
    &lt;/http:headers&gt;
    &lt;http:body&gt;
        &lt;http:data&gt;
            &lt;![CDATA[
            Some response body
            ]]&gt;
        &lt;/http:data&gt;
    &lt;/http:body&gt;
&lt;/http:send-response&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sample above receives an Http request with method POST and some request data. The server response is specified with <em>Http 200 OK</em>
and some additional cookie information. The cookie is part of the message header specification and gets a name and value
as well as several other attributes. This response will result in an Http response with the <em>"Set-Cookie"</em> header set:</p>
</div>
<div class="listingblock">
<div class="title">Set cookie header</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Set-Cookie:Token=5877643571;Path=/test/cookie.py;Domain=citrusframework.org;Max-Age=86400</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see test variables are replaced before the cookie is added to the response. The client now is able to receive
the cookie information for validation:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Cookie cookie = new Cookie("Token", "${messageId}");
cookie.setPath("/test/cookie.py");
cookie.setSecure(false);
cookie.setDomain("citrusframework.org");
cookie.setMaxAge(86400);

http().client("echoHttpClient")
    .receive()
    .response(HttpStatus.OK.value())
    .message()
    .body("Some response body")
    .header("Operation", "sayHello")
    .cookie(cookie);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:receive-response server="echoHttpClient"&gt;
  &lt;http:headers status="200" reason-phrase="OK" version="HTTP/1.1"&gt;
  &lt;http:header name="Operation" value="getCookie"/&gt;
  &lt;http:cookie name="Token"
               value="${messageId}"
               secure="false"
               domain="citrusframework.org"
               path="/test/cookie.py"
               max-age="86400"/&gt;
  &lt;/http:headers&gt;
  &lt;http:body&gt;
    &lt;http:data&gt;
      &lt;![CDATA[
        Some response body
      ]]&gt;
    &lt;/http:data&gt;
  &lt;/http:body&gt;
&lt;/http:receive-response&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once again the cookie information is added to the header specification. The Citrus message validation will make sure that
the cookie information is present with all specified attributes.</p>
</div>
<div class="paragraph">
<p>In all further actions the client is able to continue to send the cookie information with name and value:</p>
</div>
<div class="listingblock primary">
<div class="title">Java DSL</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">http().client("echoHttpClient")
    .send()
    .post()
    .fork(true)
    .message()
    .body("Some other request data")
    .header("Operation", "sayHello")
    .cookie(new Cookie("Token", "${messageId}"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:send-request client="echoHttpClient" fork="true"&gt;
  &lt;http:POST&gt;
    &lt;http:headers&gt;
      &lt;http:header name="Operation" value="sayHello"/&gt;
      &lt;http:cookie name="Token" value="${messageId}"/&gt;
    &lt;/http:headers&gt;
    &lt;http:body&gt;
      &lt;http:data&gt;
        &lt;![CDATA[
          Some other request data
        ]]&gt;
      &lt;/http:data&gt;
    &lt;/http:body&gt;
  &lt;/http:POST&gt;
&lt;/http:send-request&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The cookie now is only specified with name and value as the cookie now goes to the <em>"Cookie"</em> request message header.</p>
</div>
<div class="listingblock">
<div class="title">Cookie token</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Cookie:Token=5877643571</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course the Citrus Http server can now also validate the cookie information in a request validation:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">http().server("httpServer")
    .receive()
    .post()
    .message()
    .body("Some other request data")
    .header("Operation", "sayHello")
    .cookie(new Cookie("Token", "${messageId}"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:receive-request client="httpServer"&gt;
  &lt;http:POST&gt;
    &lt;http:headers&gt;
      &lt;http:header name="Operation" value="sayHello"/&gt;
      &lt;http:cookie name="Token" value="${messageId}"/&gt;
    &lt;/http:headers&gt;
    &lt;http:body&gt;
      &lt;http:data&gt;
        &lt;![CDATA[
          Some other request data
        ]]&gt;
      &lt;/http:data&gt;
    &lt;/http:body&gt;
  &lt;/http:POST&gt;
&lt;/http:receive-request&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Citrus message validation will make sure that the cookie is set in the request with respective name and value.</p>
</div>
</div>
<div class="sect2">
<h3 id="http-gzip-compression"><a class="anchor" href="#http-gzip-compression"></a><a class="link" href="#http-gzip-compression">14.14. Http Gzip compression</a></h3>
<div class="paragraph">
<p>Gzip is a very popular compression mechanism for optimizing the message transportation for large content. The Citrus http
client and server components support gzip compression out of the box. This means that you only need to set the specific
encoding headers in your http request/response message.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Accept-Encoding=gzip</dt>
<dd>
<p>Setting for clients when requesting gzip compressed response content. The Http server must support gzip compression then in order to provide the response as zipped byte stream. The Citrus http server component automatically recognizes this header in a request and applies gzip compression to the response.</p>
</dd>
<dt class="hdlist1">Content-Encoding=gzip</dt>
<dd>
<p>When an http server sends compressed message content to the client this header is set to <strong>gzip</strong> in order to mark the compression. The Http client must support gzip compression then in order to unzip the message content. The Citrus http client component automatically recognizes this header in a response and applies gzip unzip logic before passing the message to the test case.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The Citrus client and server automatically take care of gzip compression when those headers are set. In the test case you
do not need to zip or unzip the content then as it is automatically done before.</p>
</div>
<div class="paragraph">
<p>This means that you can request gzipped content from a server with just adding the message header <strong>Accept-Encoding</strong> in
your http request operation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">http().client("gzipClient")
    .send()
    .post()
    .message()
    .body("Some other request data")
    .contentType("text/html")
    .header("Accept-Encoding", "gzip")
    .header("Accept", "text/plain");

http().client("gzipClient")
    .receive()
    .response(HttpStatus.OK.value())
    .message()
    .type(MessageType.PLAINTEXT)
    .contentType("text/plain")
    .body("${text}");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:send-request client="gzipClient"&gt;
  &lt;http:POST&gt;
    &lt;http:headers content-type="text/html"&gt;
      &lt;http:header name="Accept-Encoding" value="gzip"/&gt;
      &lt;http:header name="Accept" value="text/plain"/&gt;
    &lt;/http:headers&gt;
  &lt;/http:POST&gt;
&lt;/http:send-request&gt;

&lt;http:receive-response client="gzipClient"&gt;
    &lt;http:headers status="200" reason-phrase="OK"&gt;
      &lt;http:header name="Content-Type" value="text/plain"/&gt;
    &lt;/http:headers&gt;
    &lt;http:body type="plaintext"&gt;
      &lt;http:data&gt;${text}&lt;/http:data&gt;
    &lt;/http:body&gt;
&lt;/http:receive-response&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the server side if we receive a message and the response should be compressed with Gzip we just have to set the <strong>Content-Encoding</strong>
header in the response operation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">http().server("httpServer")
    .receive()
    .post()
    .message()
    .body("Some other request data")
    .contentType("text/html")
    .header("Accept-Encoding", "gzip")
    .header("Accept", "text/plain");

http().server("httpServer")
    .send()
    .response(HttpStatus.OK.value())
    .message()
    .contentType("text/plain")
    .body("${text}");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http:receive-request server="httpServer"&gt;
    &lt;http:POST path="/echo"&gt;
      &lt;http:headers&gt;
        &lt;http:header name="Content-Type" value="text/html"/&gt;
        &lt;http:header name="Accept-Encoding" value="gzip"/&gt;
        &lt;http:header name="Accept" value="text/plain"/&gt;
      &lt;/http:headers&gt;
    &lt;/http:POST&gt;
&lt;/http:receive-request&gt;

&lt;http:send-response server="httpServer"&gt;
    &lt;http:headers status="200" reason-phrase="OK"&gt;
      &lt;http:header name="Content-Encoding" value="gzip"/&gt;
      &lt;http:header name="Content-Type" value="text/plain"/&gt;
    &lt;/http:headers&gt;
    &lt;http:body&gt;
      &lt;http:data&gt;${text}&lt;/http:data&gt;
    &lt;/http:body&gt;
&lt;/http:send-response&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>So the Citrus server will automatically add gzip compression to the response for us.</p>
</div>
<div class="paragraph">
<p>Of course you can also send gzipped content as a client. Then you would just set the <strong>Content-Encoding</strong> header to <strong>gzip</strong>
in your request. The client will automatically apply compression for you.</p>
</div>
</div>
<div class="sect2">
<h3 id="http-servlet-filters"><a class="anchor" href="#http-servlet-filters"></a><a class="link" href="#http-servlet-filters">14.15. Http servlet filters</a></h3>
<div class="paragraph">
<p>The Citrus http server component supports custom servlet filters that take part in handling an incoming request/response
communication. This might be useful when customizing the basic server behavior such as custom zip/unzip mechanisms. The
custom servlet filters are referenced in the http server component as follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public HttpServer httpServer() {
    return new HttpServerBuilder()
        .port(8080)
        .filters(filters())
        .filterMappings(filterMappings())
        .build();
}

public Map&lt;String, Filter&gt; filters() {
    Map&lt;String, Filter&gt; filters = new HashMap&lt;&gt;();

    filters.put("request-caching-filter", new RequestCachingServletFilter());
    filters.put("gzip-filter", new GzipServletFilter());

    return filters;
}

public Map&lt;String, String&gt; filterMappings() {
    Map&lt;String, String&gt; filterMappings = new HashMap&lt;&gt;();

    filterMappings.put("request-caching-filter", "/*");
    filterMappings.put("gzip-filter", "/gzip/*");

    return filterMappings;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-http:server id="httpServer"
                    port="8080"
                    filters="filters"
                    filter-mappings="filterMappings"/&gt;

&lt;util:map id="filters"&gt;
    &lt;entry key="request-caching-filter"&gt;
        &lt;bean class="org.citrusframework.http.servlet.RequestCachingServletFilter"/&gt;
    &lt;/entry&gt;
    &lt;entry key="gzip-filter"&gt;
        &lt;bean class="org.citrusframework.http.servlet.GzipServletFilter"/&gt;
    &lt;/entry&gt;
&lt;/util:map&gt;

&lt;util:map id="filterMappings"&gt;
    &lt;entry key="request-caching-filter" value="/*"/&gt;
    &lt;entry key="gzip-filter" value="/gzip/*"/&gt;
&lt;/util:map&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The map of filters are specified as normal Spring configuration entries. The server component uses the attribute <code>filters</code>
to reference a set of custom servlet filters. The map holds one to many servlet filter beans each given a name that is also
referenced in the respective servlet mappings. The servlet mappings specify when to apply those filters.</p>
</div>
<div class="paragraph">
<p>This way you can set a very custom servlet filter chain for each request/response communication. As usual the filter implementations
can participate in the request and response handling process.</p>
</div>
<div class="paragraph">
<p>Citrus provides several default servlet implementations that are automatically added to each http server component these
implementations are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">org.citrusframework.http.servlet.RequestCachingServletFilter</dt>
<dd>
<p>caches incoming request data so input streams can be read multiple times during request processing (important when request logging is enabled)</p>
</dd>
<dt class="hdlist1">org.citrusframework.http.servlet.GzipServletFilter</dt>
<dd>
<p>applies Gzip compression when according headers are set and client explicitly asks for compressed request/response communication</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>By the time you define some custom servlet filters or mappings to the server component Citrus will not apply default servlet
filters. This means you always need to construct the whole servlet filter chain including default servlet filters mentioned above.</p>
</div>
</div>
<div class="sect2">
<h3 id="http-servlet-context-customization"><a class="anchor" href="#http-servlet-context-customization"></a><a class="link" href="#http-servlet-context-customization">14.16. Http servlet context customization</a></h3>
<div class="paragraph">
<p>The Citrus Http server uses Spring application context loading on startup. For high customizations you can provide a custom
servlet context file which holds all custom configurations as Spring beans for the server. Here is a sample servlet context
with some basic Spring MVC components and the central HttpMessageController which is responsible for handling incoming requests
(GET, PUT, DELETE, POST, etc.).</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public RequestMappingHandlerMapping citrusHandlerMapping() {
    return new RequestMappingHandlerMapping();
}

@Bean
public RequestMappingHandlerAdapter citrusMethodHandlerAdapter() {
    RequestMappingHandlerAdapter adapter = new RequestMappingHandlerAdapter();

    adapter.setMessageConverters(Collections.singletonList(citrusHttpMessageConverter()));

    return adapter;
}

@Bean
public DelegatingHttpEntityMessageConverter citrusHttpMessageConverter() {
    return new DelegatingHttpEntityMessageConverter();
}

@Bean
public HttpMessageController citrusHttpMessageController() {
    HttpMessageController controller = new HttpMessageController();

    controller.setEndpointAdapter(new EmptyResponseEndpointAdapter());

    return controller;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="citrusHandlerMapping" class="org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping"/&gt;

&lt;bean id="citrusMethodHandlerAdapter" class="org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter"&gt;
  &lt;property name="messageConverters"&gt;
    &lt;util:list id="converters"&gt;
      &lt;ref bean="citrusHttpMessageConverter"/&gt;
    &lt;/util:list&gt;
  &lt;/property&gt;
&lt;/bean&gt;

&lt;bean id="citrusHttpMessageConverter" class="org.citrusframework.http.message.DelegatingHttpEntityMessageConverter"/&gt;

&lt;bean id="citrusHttpMessageController" class="org.citrusframework.http.controller.HttpMessageController"&gt;
  &lt;property name="endpointAdapter"&gt;
      &lt;bean
       class="org.citrusframework.endpoint.adapter.EmptyResponseEndpointAdapter"/&gt;
  &lt;/property&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The beans above are responsible for proper Http server configuration. In general you do not need to adjust those beans,
but we have the possibility to do so which gives us a great customization and extension points. The important part is the
endpoint adapter definition inside the HttpMessageController. Once a client request was accepted the adapter is responsible
for generating a proper response to the client.</p>
</div>
<div class="paragraph">
<p>You can add the custom servlet context as file resource to the Citrus Http server component. Just use the <strong>context-config-location</strong>
attribute as follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public HttpServer httpServer() {
    return new HttpServerBuilder()
        .port(8080)
        .autoStart(true)
        .contextConfigLocation("classpath:org/citrusframework/http/custom-servlet-context.xml")
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-http:server id="helloHttpServer"
      port="8080"
      auto-start="true"
      context-config-location="classpath:org/citrusframework/http/custom-servlet-context.xml"/&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="soap-webservices"><a class="anchor" href="#soap-webservices"></a><a class="link" href="#soap-webservices">15. SOAP WebServices</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>SOAP Web Services over HTTP is a widely used communication scenario in modern enterprise applications. A SOAP Web Service client is posting a SOAP request via HTTP to a server. SOAP via HTTP is a synchronous message protocol by default so the client is waiting synchronously for the response message. Citrus provides both SOAP client and server components in order to meet both directions of this scenario. The components used are very similar to the HTTP components that were discussed in the sections before.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The SOAP WebService components in Citrus are kept in a separate Maven module. So you should add the module as Maven dependency to your project accordingly.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-ws&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="soap-client"><a class="anchor" href="#soap-client"></a><a class="link" href="#soap-client">15.1. SOAP client</a></h3>
<div class="paragraph">
<p>Citrus is able to form a proper SOAP request in order to pass it to the server via HTTP and validate the respective SOAP response message. Let us see how a message client for SOAP looks like in the Spring configuration:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebServiceClient soapClient() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8090/test")
            .timeout(60000L)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebServiceClient soapClient() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8090/test")
            .timeout(60000L)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/ws/config
           http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;

  &lt;citrus-ws:client id="soapClient"
                       request-url="http://localhost:8090/test"
                       timeout="60000"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In order to use the Citrus SOAP WebService support in a Spring beans XML application context you need to include the specific XML configuration schema provided by Citrus. See the <code>citrus-ws</code> prefix - in Spring XML configuration sample above.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The client component uses the <strong>request-url</strong> in order to access the server resource. The client will automatically build a proper SOAP request message including the SOAP envelope, SOAP header and the message payload as SOAP body. This means that you as a tester do not care about SOAP envelope specific logic in the test case. The client endpoint component saves the synchronous SOAP response so the test case can receive this message with a normal receive test action.</p>
</div>
<div class="paragraph">
<p>In detail you as a tester just send and receive using the same client endpoint reference just as you would do with a synchronous JMS or channel communication. In case no response message is available in time according to the timeout settings Citrus raises a timeout error and the test will fail.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The SOAP client component uses a SoapMessageFactory implementation in order to create the SOAP messages. This is a Spring bean added to the Citrus Spring application context. Spring offers several reference implementations as message factories so you can choose one of them (e.g. for SOAP 1.1 or 1.2 implementations).
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public SaajSoapMessageFactory messageFactory() {
    return new SaajSoapMessageFactory();
}

@BindToRegistry
public SaajSoapMessageFactory soap12MessageFactory() {
    SaajSoapMessageFactory messageFactory = new SaajSoapMessageFactory();
    messageFactory.setSoapVersion(SoapVersion.SOAP_12);
    return messageFactory;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SaajSoapMessageFactory messageFactory() {
    return new SaajSoapMessageFactory();
}

@Bean
public SaajSoapMessageFactory soap12MessageFactory() {
    SaajSoapMessageFactory messageFactory = new SaajSoapMessageFactory();
    messageFactory.setSoapVersion(SoapVersion.SOAP_12);
    return messageFactory;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;

    &lt;!-- Default SOAP Message Factory (SOAP 1.1) --&gt;
    &lt;bean id="messageFactory" class="org.springframework.ws.soap.saaj.SaajSoapMessageFactory"/&gt;

    &lt;!-- SOAP 1.2 Message Factory --&gt;
    &lt;bean id="soap12MessageFactory" class="org.springframework.ws.soap.saaj.SaajSoapMessageFactory"&gt;
      &lt;property name="soapVersion"&gt;
        &lt;util:constant static-field="org.springframework.ws.soap.SoapVersion.SOAP_12"/&gt;
      &lt;/property&gt;
    &lt;/bean&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, Citrus will search for a bean with id <strong>'messageFactory'</strong> . In case you intend to use different identifiers you need to tell the SOAP client component which message factory to use:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebServiceClient soapClient() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8090/test")
            .messageFactory(soap12MessageFactory())
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebServiceClient soapClient() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8090/test")
            .messageFactory(soap12MessageFactory())
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/ws/config
           http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;

  &lt;citrus-ws:client id="soapClient"
         request-url="http://localhost:8090/test"
         message-factory="soap12MessageFactory"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Up to now we have used a static endpoint request url for the SOAP message sender. Besides that we can use dynamic endpoint uri in configuration. We just use an endpoint uri resolver instead of the static request url like this:
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebServiceClient soapClient() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8090/test")
            .messageFactory(soap12MessageFactory())
            .endpointResolver(dynamicEndpointResolver())
            .build();
}

@BindToRegistry
public DynamicEndpointUriResolver dynamicEndpointResolver() {
    return new DynamicEndpointUriResolver();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebServiceClient soapClient() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8090/test")
            .messageFactory(soap12MessageFactory())
            .endpointResolver(dynamicEndpointResolver())
            .build();
}

@Bean
public DynamicEndpointUriResolver dynamicEndpointResolver() {
    return new DynamicEndpointUriResolver();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/ws/config
           http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;

  &lt;citrus-ws:client id="soapClient"
              request-url="http://localhost:8090/test"
             endpoint-resolver="dynamicEndpointResolver"
             message-factory="soap12MessageFactory"/&gt;

  &lt;bean id="dynamicEndpointResolver"
       class="org.citrusframework.endpoint.resolver.DynamicEndpointUriResolver"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>dynamicEndpointResolver</strong> bean must implement the EndpointUriResolver interface in order to resolve dynamic endpoint uri values.
Citrus offers a default implementation, the <strong>DynamicEndpointUriResolver</strong>, which uses a specific message header for setting the dynamic endpoint uri for each message.
The message header needs to specify the header <strong>citrus_endpoint_uri</strong> with a valid request uri.
Just like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">.header("citrus_endpoint_uri", "http://localhost:${port}/${context}")</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;headers&gt;
  &lt;header name="citrus_endpoint_uri"
          value="http://localhost:${port}/${context}" /&gt;
&lt;/headers&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">headers:
  - name: citrus_endpoint_uri
    value: "http://localhost:${port}/${context}"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;header&gt;
  &lt;element name="citrus_endpoint_uri"
           value="http://localhost:${port}/${context}" /&gt;
&lt;/header&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see you can use dynamic test variables then in order to build the request uri to use. The SOAP client evaluates the endpoint uri header and sends the message to this server resource. You can use a different uri value then in different test cases and send actions.</p>
</div>
</div>
<div class="sect2">
<h3 id="soap-client-interceptors"><a class="anchor" href="#soap-client-interceptors"></a><a class="link" href="#soap-client-interceptors">15.2. SOAP client interceptors</a></h3>
<div class="paragraph">
<p>The client component is able to add custom interceptors that participate in the request/response processing. The interceptors need to implement the common interface <strong>org.springframework.ws.client.support.interceptor.ClientInterceptor</strong>.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebServiceClient secureSoapClient() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8080/services/ws/todolist")
            .interceptors(clientInterceptors())
            .build();
}

public List&lt;ClientInterceptor&gt; clientInterceptors() {
    Wss4jSecurityInterceptor wss4jSecurityInterceptor = new Wss4jSecurityInterceptor();
    wss4jSecurityInterceptor.setSecurementActions("Timestamp UsernameToken");
    wss4jSecurityInterceptor.setSecurementUsername("admin");
    wss4jSecurityInterceptor.setSecurementPassword("secret");
    return Arrays.asList(wss4jSecurityInterceptor, new LoggingClientInterceptor());
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebServiceClient secureSoapClient() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8080/services/ws/todolist")
            .interceptors(clientInterceptors())
            .build();
}

public List&lt;ClientInterceptor&gt; clientInterceptors() {
    Wss4jSecurityInterceptor wss4jSecurityInterceptor = new Wss4jSecurityInterceptor();
    wss4jSecurityInterceptor.setSecurementActions("Timestamp UsernameToken");
    wss4jSecurityInterceptor.setSecurementUsername("admin");
    wss4jSecurityInterceptor.setSecurementPassword("secret");
    return Arrays.asList(wss4jSecurityInterceptor, new LoggingClientInterceptor());
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/ws/config
           http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;

  &lt;citrus-ws:client id="secureSoapClient"
                  request-url="http://localhost:8080/services/ws/todolist"
                  interceptors="clientInterceptors"/&gt;

  &lt;util:list id="clientInterceptors"&gt;
    &lt;bean class="org.springframework.ws.soap.security.wss4j.Wss4jSecurityInterceptor"&gt;
      &lt;property name="securementActions" value="Timestamp UsernameToken"/&gt;
      &lt;property name="securementUsername" value="admin"/&gt;
      &lt;property name="securementPassword" value="secret"/&gt;
    &lt;/bean&gt;
    &lt;bean class="org.citrusframework.ws.interceptor.LoggingClientInterceptor"/&gt;
  &lt;/util:list&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sample above adds Wss4J WsSecurity interceptors in order to add security constraints to the request messages.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When customizing the interceptor chain all default interceptors (like logging interceptor) are lost. You need to add these interceptors explicitly as shown with the <em>org.citrusframework.ws.interceptor.LoggingClientInterceptor</em> which
is able to log request/response messages during communication.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="soap-server"><a class="anchor" href="#soap-server"></a><a class="link" href="#soap-server">15.3. SOAP server</a></h3>
<div class="paragraph">
<p>Every client needs a server to talk to. When receiving SOAP messages we require a web server instance listening on a port. Citrus is using an embedded Jetty server instance in combination with the Spring Web Service API in order to accept SOAP request calls as a server. See how the Citrus SOAP server is configured in the Spring configuration.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebServiceServer soapServer() {
    return new WebServiceServerBuilder()
            .port(8080)
            .autoStart(true)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebServiceServer soapServer() {
    return new WebServiceServerBuilder()
            .port(8080)
            .autoStart(true)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/ws/config
           http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;

  &lt;citrus-ws:server id="soapServer"
             port="8080"
             auto-start="true"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The server component is able to start automatically when application starts up. In the example above the server is listening for requests on port <strong><em>8080</em></strong> . This setup uses the standard connector configuration for the Jetty server. For detailed customization the Citrus Jetty server configuration also supports explicit connector configurations (@connector and @connectors attributes). For more information please see the Jetty connector documentation.</p>
</div>
<div class="paragraph">
<p>Test cases interact with this server instance via message channels by default. The server component provides an inbound channel that holds incoming request messages. The test case can receive those requests from the channel with a normal receive test action. In a second step the test case can provide a synchronous response message as reply which will be automatically sent back to the calling SOAP client as response.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/figure_010.jpg" alt="figure_010.jpg"></span></p>
</div>
<div class="paragraph">
<p>The figure above shows the basic setup with inbound channel and reply channel. You as a tester should not worry about this too much. By default you as a tester just use the server as synchronous endpoint in your test case. This means that you simply receive a message from the server and send a response back.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapServerTest() {
    when(receive().endpoint(soapServer)
            .message()
                .body("""
                    [...]
                """)
    );

    then(send().endpoint(soapServer)
            .message()
                .body("""
                    [...]
                """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapServerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;receive endpoint="soapServer"&gt;
        &lt;message&gt;
            &lt;body&gt;
                [...]
            &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
      &lt;send endpoint="soapServer"&gt;
        &lt;message&gt;
            &lt;body&gt;
                [...]
            &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapServerTest
actions:
  - receive:
      endpoint: "soapServer"
      message:
        body: |
          [...]
  - send:
      endpoint: "soapServer"
      message:
        body: |
          [...]</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="soapServerTest"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="soapServer"&gt;
            &lt;message&gt;
                &lt;data&gt;
                  [...]
                &lt;/data&gt;
            &lt;/message&gt;
        &lt;/receive&gt;

        &lt;send endpoint="soapServer"&gt;
            &lt;message&gt;
                &lt;data&gt;
                  [...]
                &lt;/data&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we reference the server id in both receive and send actions. The Citrus server instance will automatically send the response back to the calling client. In most cases this is what you need to simulate a SOAP server instance in Citrus. Of course we have some more customization possibilities that we will go over later on. These customizations are optional so you can also skip the next description on endpoint adapters if you are happy with just what you have learned about the SOAP server component in Citrus.</p>
</div>
<div class="paragraph">
<p>Just like the HTTP server component the SOAP server component by default uses the channel endpoint adapter in order to forward all incoming requests to an in-memory message channel. This is done completely behind the scenes. The Citrus configuration has become a lot easier here so you do not have to configure this by default. When nothing else is set the test case does not worry about that setting on the server and just uses the server id reference as synchronous endpoint.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The default channel endpoint adapter automatically creates an inbound message channel where incoming messages are stored too internally. So if you need to clean up a server that has already stored some incoming messages you can do this easily by purging the internal message channel. The message channel follows a naming convention <strong>{serverName}.inbound</strong> where <strong>{serverName}</strong> is the Spring bean name of the Citrus server endpoint component. If you purge this internal channel in a before test nature you are sure that obsolete messages on a server instance get purged before each test is executed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>However, we do not want to lose the great extendability and customizing capabilities of the Citrus server component. This is why you can optionally define the endpoint adapter implementation used by the Citrus SOAP server. We provide several message endpoint adapter implementations for different simulation strategies. With these endpoint adapters you should be able to generate proper SOAP response messages for the client in various ways. Before we have a closer look at the different adapter implementations we want to show how you can set a custom endpoint adapter on the server component.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebServiceServer soapServer() {
    return new WebServiceServerBuilder()
            .port(8080)
            .autoStart(true)
            .endpointAdapter(emptyResponseEndpointAdapter())
            .build();
}

@BindToRegistry
public EmptyResponseEndpointAdapter emptyResponseEndpointAdapter() {
    return new EmptyResponseEndpointAdapter();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebServiceServer soapServer() {
    return new WebServiceServerBuilder()
            .port(8080)
            .autoStart(true)
            .endpointAdapter(emptyResponseEndpointAdapter())
            .build();
}

@Bean
public EmptyResponseEndpointAdapter emptyResponseEndpointAdapter() {
    return new EmptyResponseEndpointAdapter();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/ws/config
           http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;

  &lt;citrus-ws:server id="soapServer"
        port="8080"
        auto-start="true"
        endpoint-adapter="emptyResponseEndpointAdapter"/&gt;

  &lt;citrus:empty-response-adapter id="emptyResponseEndpointAdapter"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this endpoint adapter configuration above we change the Citrus server behavior from scratch. Now the server automatically sends back an empty SOAP response message every time. Setting a custom endpoint adapter implementation with custom logic is as easy as defining a custom endpoint adapter Spring bean and reference it in the server attribute. You can read more about endpoint adapters in <a href="#endpoint-adapter">endpoint-adapter</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="soap-send-and-receive"><a class="anchor" href="#soap-send-and-receive"></a><a class="link" href="#soap-send-and-receive">15.4. SOAP send and receive</a></h3>
<div class="paragraph">
<p>Citrus provides test actions for sending and receiving messages of all kind.
Different message content and different message transports are available to these send and receive actions.
When using SOAP message transport we might need to set special information on those messages.
These are special SOAP headers, SOAP faults and so on.
So we have created a special SOAP test actions for all your SOAP related send and receive operations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In a Spring XML DSL test the <strong>ws:</strong> Citrus namespace is added to your test case, so you can use special send and receive operations in the test.
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapClientTest() {
    when(soap()
        .client(soapClient)
        .send()
            .message()
                .soapAction("MySoapService/sayHello")
                .body("""
                    [...]
                """)
    );

    then(soap()
        .server(soapServer)
        .receive()
            .message()
                .soapAction("MySoapService/sayHello")
                .body("""
                    [...]
                """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapClientTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap client="soapClient"&gt;
        &lt;send-request&gt;
          &lt;message soap-action="MySoapService/sayHello"&gt;
            &lt;body&gt;
              [...]
            &lt;/body&gt;
          &lt;/message&gt;
        &lt;/send-request&gt;
      &lt;/soap&gt;

      &lt;soap server="soapServer"&gt;
        &lt;receive-request&gt;
          &lt;message soap-action="MySoapService/sayHello"&gt;
            &lt;body&gt;
              [...]
            &lt;/body&gt;
          &lt;/message&gt;
        &lt;/receive-request&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapClientTest
actions:
  - soap:
      client: "soapClient"
      sendRequest:
        message:
          soapAction: "MySoapService/sayHello"
          body:
            data: |
              [...]
  - soap:
      server: "soapServer"
      receiveRequest:
        message:
          soapAction: "MySoapService/sayHello"
          body:
            data: |
              [...]</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapClientTest"&gt;
    &lt;actions&gt;
        &lt;ws:send endpoint="soapClient" soap-action="MySoapService/sayHello"&gt;
            &lt;message&gt;
                [...]
            &lt;/message&gt;
        &lt;/ws:send&gt;

        &lt;ws:receive endpoint="soapServer" soap-action="MySoapService/sayHello"&gt;
            &lt;message&gt;
                [...]
            &lt;/message&gt;
        &lt;/ws:receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The special SOAP actions include send/receive actions for both client and server that simplify the usage with SOAP envelopes.</p>
</div>
<div class="hdlist">
<div class="title">SOAP client actions</div>
<table>
<tr>
<td class="hdlist1">
send-request
</td>
<td class="hdlist2">
<p>SOAP client sending SOAP request message content.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
receive-response
</td>
<td class="hdlist2">
<p>SOAP client receiving the SOAP response message content.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
assert-fault
</td>
<td class="hdlist2">
<p>SOAP client expecting a SOAP fault from the server as a response message.</p>
</td>
</tr>
</table>
</div>
<div class="hdlist">
<div class="title">SOAP server actions</div>
<table>
<tr>
<td class="hdlist1">
receive-request
</td>
<td class="hdlist2">
<p>SOAP server receiving a SOAP request message.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
send-response
</td>
<td class="hdlist2">
<p>SOAP server sending a SOAP response message.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
send-fault
</td>
<td class="hdlist2">
<p>SOAP server sending a SOAP fault message as a response.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The special SOAP related send and receive actions can coexist with normal Citrus actions in a test.
In fact, you can mix those action types in your test case.</p>
</div>
<div class="paragraph">
<p>In Spring XML DSL test cases all SOAP test actions use a special namespace <code><a href="http://www.citrusframework.org/schema/ws/testcase" class="bare">http://www.citrusframework.org/schema/ws/testcase</a></code>.</p>
</div>
<div class="paragraph">
<p>The Java DSL provides a special SOAP related fluent method API with the <strong>soap()</strong> entry method.</p>
</div>
</div>
<div class="sect2">
<h3 id="soap-headers"><a class="anchor" href="#soap-headers"></a><a class="link" href="#soap-headers">15.5. SOAP headers</a></h3>
<div class="paragraph">
<p>SOAP defines several header variations that we discuss in the following sections. First of all we deal with the special <strong>SOAP action</strong> header. In case we need to set this SOAP action header we simply need to use the special <strong><em>soap-action</em></strong> attribute in our test. The special header key in combination with an underlying SOAP client endpoint component constructs the SOAP action in the SOAP message.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapClientTest() {
    when(soap()
        .client(soapClient)
        .send()
            .message()
                .soapAction("MySoapService/sayHello")
                .body("""
                    [...]
                """)
    );

    then(soap()
        .server(soapServer)
        .receive()
            .message()
                .soapAction("MySoapService/sayHello")
                .body("""
                    [...]
                """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapClientTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap client="soapClient"&gt;
        &lt;send-request&gt;
          &lt;message soap-action="MySoapService/sayHello"&gt;
            &lt;body&gt;
              [...]
            &lt;/body&gt;
          &lt;/message&gt;
        &lt;/send-request&gt;
      &lt;/soap&gt;

      &lt;soap server="soapServer"&gt;
        &lt;receive-request&gt;
          &lt;message soap-action="MySoapService/sayHello"&gt;
            &lt;body&gt;
              [...]
            &lt;/body&gt;
          &lt;/message&gt;
        &lt;/receive-request&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapClientTest
actions:
  - soap:
      client: "soapClient"
      sendRequest:
        message:
          soapAction: "MySoapService/sayHello"
          body:
            data: |
              [...]
  - soap:
      server: "soapServer"
      receiveRequest:
        message:
          soapAction: "MySoapService/sayHello"
          body:
            data: |
              [...]</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapClientTest"&gt;
    &lt;actions&gt;
      &lt;ws:send endpoint="soapClient" soap-action="MySoapService/sayHello"&gt;
        &lt;message&gt;
            [...]
        &lt;/message&gt;
      &lt;/ws:send&gt;

      &lt;ws:receive endpoint="soapServer" soap-action="MySoapService/sayHello"&gt;
        &lt;message&gt;
            [...]
        &lt;/message&gt;
      &lt;/ws:receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The SOAP action header is added to the message before sending and validated when used in a receive operation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <strong>soap-action</strong> attribute is defined in the special SOAP namespace in Citrus. We recommend to use this namespace for all your send and receive operations that deal with SOAP message content. However, you can also set the special SOAP action header when not using the special SOAP namespace: Just set this header in your test action:
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">.header("citrus_soap_action", "sayHello")</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;headers&gt;
  &lt;header name="citrus_soap_action"
          value="sayHello" /&gt;
&lt;/headers&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">headers:
  - name: citrus_soap_action
    value: "sayHello"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;header&gt;
    &lt;element name="{http://citrusframework.org/sayHello}h1:Operation" value="sayHello"/&gt;
&lt;/header&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Secondly a SOAP message is able to contain customized SOAP headers. These are key-value pairs where the key is a qualified name (QName) and the value a normal String value.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">.header("{http://citrusframework.org/sayHello}h1:Operation", "sayHello")
.header("{http://citrusframework.org/sayHello}h1:Request", "HelloRequest")</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;headers&gt;
  &lt;header name="{http://citrusframework.org/sayHello}h1:Operation"
          value="sayHello" /&gt;
  &lt;header name="{http://citrusframework.org/sayHello}h1:Request"
          value="HelloRequest" /&gt;
&lt;/headers&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">headers:
  - name: "{http://citrusframework.org/sayHello}h1:Operation"
    value: "sayHello"
  - name: "{http://citrusframework.org/sayHello}h1:Request"
    value: "HelloRequest"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;header&gt;
    &lt;element name="{http://citrusframework.org/sayHello}h1:Operation" value="sayHello"/&gt;
    &lt;element name="{http://citrusframework.org/sayHello}h1:Request" value="HelloRequest"/&gt;
&lt;/header&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The key is defined as qualified QName character sequence which has a mandatory XML namespace and a prefix along with a header name. Last but not least a SOAP header can contain whole XML fragment values. The next example shows how to set these XML fragments as SOAP header in Citrus:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">.header("""
  &lt;User xmlns="http://citrusframework.org/schemas/sayHello"&gt;
      &lt;UserId&gt;123456789&lt;/UserId&gt;
      &lt;Handshake&gt;S123456789&lt;/Handshake&gt;
  &lt;/User&gt;
""")</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;headers&gt;
  &lt;header&gt;
    &lt;data&gt;
      &lt;![CDATA[
          &lt;User xmlns="http://citrusframework.org/schemas/sayHello"&gt;
              &lt;UserId&gt;123456789&lt;/UserId&gt;
              &lt;Handshake&gt;S123456789&lt;/Handshake&gt;
          &lt;/User&gt;
      ]]&gt;
    &lt;/data&gt;
  &lt;/header&gt;
&lt;/headers&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">headers:
  - data: |
      &lt;User xmlns="http://citrusframework.org/schemas/sayHello"&gt;
          &lt;UserId&gt;123456789&lt;/UserId&gt;
          &lt;Handshake&gt;S123456789&lt;/Handshake&gt;
      &lt;/User&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;header&gt;
    &lt;data&gt;
      &lt;![CDATA[
          &lt;User xmlns="http://citrusframework.org/schemas/sayHello"&gt;
              &lt;UserId&gt;123456789&lt;/UserId&gt;
              &lt;Handshake&gt;S123456789&lt;/Handshake&gt;
          &lt;/User&gt;
      ]]&gt;
    &lt;/data&gt;
&lt;/header&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use external file resources to set this SOAP header XML fragment as shown in this last example code:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">.header(Resources.of("classpath:request-soap-header.xml"))</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;headers&gt;
  &lt;header file="classpath:request-soap-header.xml"/&gt;
&lt;/headers&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">headers:
  - file: "classpath:request-soap-header.xml"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;header&gt;
    &lt;resource file="classpath:request-soap-header.xml"/&gt;
&lt;/header&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This completes the SOAP header possibilities for sending SOAP messages with Citrus. Of course you can also use these variants in SOAP message header validation. You define expected SOAP headers, SOAP action and XML fragments and Citrus will match incoming requests to that. Just use <strong>citrus_soap_action</strong> header key in your receiving message action and you validate this SOAP header accordingly.</p>
</div>
<div class="paragraph">
<p>When validating SOAP header XML fragments you need to define the whole XML header fragment as expected header data like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapHeaderTest() {
    then(soap()
        .server(soapServer)
        .receive()
            .message()
                .soapAction("MySoapService/sayHello")
                .body("""
                &lt;ResponseMessage xmlns="http://citrusframework.org/schema"&gt;
                  &lt;resultCode&gt;OK&lt;/resultCode&gt;
                &lt;/ResponseMessage&gt;
                """)
                .header("""
                &lt;SOAP-ENV:Header
                    xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
                    &lt;customHeader xmlns="http://citrusframework.org/headerschema"&gt;
                        &lt;correlationId&gt;${correlationId}&lt;/correlationId&gt;
                        &lt;applicationId&gt;${applicationId}&lt;/applicationId&gt;
                        &lt;trackingId&gt;${trackingId}&lt;/trackingId&gt;
                        &lt;serviceId&gt;${serviceId}&lt;/serviceId&gt;
                        &lt;interfaceVersion&gt;1.0&lt;/interfaceVersion&gt;
                        &lt;timestamp&gt;@ignore@&lt;/timestamp&gt;
                    &lt;/customHeader&gt;
                &lt;/SOAP-ENV:Header&gt;
                """)
                .header("citrus_soap_action", "doResponse")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapHeaderTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap server="soapServer"&gt;
        &lt;receive-request&gt;
          &lt;message soap-action="MySoapService/sayHello"&gt;
            &lt;headers&gt;
              &lt;header&gt;
                &lt;data&gt;
                &lt;![CDATA[
                &lt;SOAP-ENV:Header
                    xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
                    &lt;customHeader xmlns="http://citrusframework.org/headerschema"&gt;
                        &lt;correlationId&gt;${correlationId}&lt;/correlationId&gt;
                        &lt;applicationId&gt;${applicationId}&lt;/applicationId&gt;
                        &lt;trackingId&gt;${trackingId}&lt;/trackingId&gt;
                        &lt;serviceId&gt;${serviceId}&lt;/serviceId&gt;
                        &lt;interfaceVersion&gt;1.0&lt;/interfaceVersion&gt;
                        &lt;timestamp&gt;@ignore@&lt;/timestamp&gt;
                    &lt;/customHeader&gt;
                &lt;/SOAP-ENV:Header&gt;
                ]]&gt;
                &lt;/data&gt;
              &lt;/header&gt;
              &lt;header name="citrus_soap_action" value="doResponse"/&gt;
            &lt;/headers&gt;
            &lt;body&gt;
              &lt;data&gt;
              &lt;![CDATA[
                &lt;ResponseMessage xmlns="http://citrusframework.org/schema"&gt;
                  &lt;resultCode&gt;OK&lt;/resultCode&gt;
                &lt;/ResponseMessage&gt;
              ]]&gt;
              &lt;/data&gt;
            &lt;/body&gt;
          &lt;/message&gt;
        &lt;/receive-request&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapHeaderTest
actions:
  - soap:
      server: "soapServer"
      receiveRequest:
        message:
          soapAction: "MySoapService/sayHello"
          body:
            data: |
              &lt;ResponseMessage xmlns="http://citrusframework.org/schema"&gt;
                &lt;resultCode&gt;OK&lt;/resultCode&gt;
              &lt;/ResponseMessage&gt;
          headers:
            - name: citrus_soap_action
              value: doResponse
            - data: |
                &lt;SOAP-ENV:Header
                    xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
                    &lt;customHeader xmlns="http://citrusframework.org/headerschema"&gt;
                        &lt;correlationId&gt;${correlationId}&lt;/correlationId&gt;
                        &lt;applicationId&gt;${applicationId}&lt;/applicationId&gt;
                        &lt;trackingId&gt;${trackingId}&lt;/trackingId&gt;
                        &lt;serviceId&gt;${serviceId}&lt;/serviceId&gt;
                        &lt;interfaceVersion&gt;1.0&lt;/interfaceVersion&gt;
                        &lt;timestamp&gt;@ignore@&lt;/timestamp&gt;
                    &lt;/customHeader&gt;
                &lt;/SOAP-ENV:Header&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapHeaderTest"&gt;
    &lt;actions&gt;
      &lt;receive endpoint="soapServer"&gt;
        &lt;message&gt;
            &lt;data&gt;
            &lt;![CDATA[
            &lt;ResponseMessage xmlns="http://citrusframework.org/schema"&gt;
              &lt;resultCode&gt;OK&lt;/resultCode&gt;
            &lt;/ResponseMessage&gt;
            ]]&gt;
            &lt;/data&gt;
        &lt;/message&gt;
        &lt;header&gt;
            &lt;data&gt;
            &lt;![CDATA[
            &lt;SOAP-ENV:Header
                xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
                &lt;customHeader xmlns="http://citrusframework.org/headerschema"&gt;
                    &lt;correlationId&gt;${correlationId}&lt;/correlationId&gt;
                    &lt;applicationId&gt;${applicationId}&lt;/applicationId&gt;
                    &lt;trackingId&gt;${trackingId}&lt;/trackingId&gt;
                    &lt;serviceId&gt;${serviceId}&lt;/serviceId&gt;
                    &lt;interfaceVersion&gt;1.0&lt;/interfaceVersion&gt;
                    &lt;timestamp&gt;@ignore@&lt;/timestamp&gt;
                &lt;/customHeader&gt;
            &lt;/SOAP-ENV:Header&gt;
            ]]&gt;
            &lt;/data&gt;
            &lt;element name="citrus_soap_action" value="doResponse"/&gt;
        &lt;/header&gt;
      &lt;/receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the SOAP XML header validation can combine header element and XML fragment validation. This is also likely to be used when dealing with WS-Security message headers.</p>
</div>
</div>
<div class="sect2">
<h3 id="soap-http-mime-headers"><a class="anchor" href="#soap-http-mime-headers"></a><a class="link" href="#soap-http-mime-headers">15.6. SOAP HTTP mime headers</a></h3>
<div class="paragraph">
<p>Besides the SOAP specific header elements the HTTP mime headers (e.g. Content-Type, Content-Length, Authorization) might be candidates for validation, too. When using HTTP as transport layer the SOAP message may define those mime headers. The tester is able to send and validate these headers inside the test case, although these HTTP headers are located outside the SOAP envelope. Let us first of all speak about validating the HTTP mime headers. This feature is not enabled by default. We have enabled this in our SOAP server configuration.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebServiceServer soapServer() {
    return new WebServiceServerBuilder()
            .port(8080)
            .autoStart(true)
            .handleMimeHeaders(true)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebServiceServer soapServer() {
    return new WebServiceServerBuilder()
            .port(8080)
            .autoStart(true)
            .handleMimeHeaders(true)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.citrusframework.org/schema/config
       http://www.citrusframework.org/schema/config/citrus-config.xsd
       http://www.citrusframework.org/schema/ws/config
       http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;

  &lt;citrus-ws:server id="soapServer"
        port="8080"
        auto-start="true"
        handle-mime-headers="true"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this configuration Citrus will handle all available mime headers and pass those to the test case for normal header validation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapServerTest() {
    then(soap()
        .server(soapServer)
        .receiveRequest()
            .message()
                .soapAction("MySoapService/sayHello")
                .body("""
                &lt;SoapMessageRequest xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                    &lt;Operation&gt;Validate mime headers&lt;/Operation&gt;
                &lt;/SoapMessageRequest&gt;
                """)
                .header("Content-Type", "application/xml")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapServerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap server="soapServer"&gt;
        &lt;receive-request&gt;
          &lt;message soap-action="MySoapService/sayHello"&gt;
            &lt;body&gt;
              &lt;SoapMessageRequest xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                    &lt;Operation&gt;Validate mime headers&lt;/Operation&gt;
                &lt;/SoapMessageRequest&gt;
            &lt;/body&gt;
            &lt;headers&gt;
              &lt;header name="Content-Type" value="application/xml"/&gt;
            &lt;/headers&gt;
          &lt;/message&gt;
        &lt;/receive-request&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapServerTest
actions:
  - soap:
      server: "soapServer"
      receiveRequest:
        message:
          soapAction: "MySoapService/sayHello"
          body:
            data: |
              &lt;SoapMessageRequest xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                  &lt;Operation&gt;Validate mime headers&lt;/Operation&gt;
              &lt;/SoapMessageRequest&gt;
          headers:
            - name: Content-Type
              value: application/xml</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapServerTest"&gt;
    &lt;actions&gt;
      &lt;ws:receive endpoint="soapServer"&gt;
        &lt;message&gt;
            &lt;payload&gt;
                &lt;SoapMessageRequest xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                    &lt;Operation&gt;Validate mime headers&lt;/Operation&gt;
                &lt;/SoapMessageRequest&gt;
            &lt;/payload&gt;
        &lt;/message&gt;
        &lt;header&gt;
            &lt;element name="Content-Type" value="application/xml"/&gt;
        &lt;/header&gt;
      &lt;/ws:receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The validation of these HTTP mime headers is as usual now that we have enabled the mime header handling in the SOAP server. The transport HTTP headers are available in the header just like the normal SOAP header elements do. So you can validate the headers as usual.</p>
</div>
<div class="paragraph">
<p>So much for receiving and validating HTTP mime message headers with SOAP communication. Now we want to send special mime headers on client side. We overwrite or add mime headers to our sending action. We mark some headers with following prefix <strong><em>"citrus_http</em>"_</strong> . This tells the SOAP client to add these headers to the HTTP header section outside the SOAP envelope. Keep in mind that header elements without this prefix go right into the SOAP header section by default.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapClientTest() {
    when(soap()
        .client(soapClient)
        .send()
            .message()
                .header("citrus_http_operation", "foo")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapClientTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap client="soapClient"&gt;
        &lt;send-request&gt;
          &lt;message&gt;
            &lt;headers&gt;
              &lt;header name="citrus_http_operation" value="foo"/&gt;
            &lt;/headers&gt;
          &lt;/message&gt;
        &lt;/send-request&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapClientTest
actions:
  - soap:
      client: "soapClient"
      sendRequest:
        message:
          headers:
            - name: citrus_http_operation
              value: foo</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapClientTest"&gt;
    &lt;actions&gt;
      &lt;ws:send endpoint="soapClient"&gt;
        [...]
        &lt;header&gt;
          &lt;element name="citrus_http_operation" value="foo"/&gt;
        &lt;/header&gt;
        [...]
      &lt;/ws:send&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The listing above defines an HTTP mime header <strong>operation</strong> . The header prefix <strong><em>citrus_http_</em></strong> is cut off before the header goes into the HTTP header section. With this feature we can decide where exactly our header information is located in our resulting client message.</p>
</div>
</div>
<div class="sect2">
<h3 id="soap-envelope-handling"><a class="anchor" href="#soap-envelope-handling"></a><a class="link" href="#soap-envelope-handling">15.7. SOAP Envelope handling</a></h3>
<div class="paragraph">
<p>By default Citrus will remove the SOAP envelope in message converter. Following from that the Citrus test case is independent from SOAP message formats and is not bothered with handling of SOAP envelope at all. This is great in most cases but sometimes it might be mandatory to also see the whole SOAP envelope inside the test case receive action. Therefore you can keep the SOAP envelope for incoming messages by configuration on the SOAP server side.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebServiceServer soapServer() {
    return new WebServiceServerBuilder()
            .port(8080)
            .autoStart(true)
            .keepSoapEnvelope(true)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebServiceServer soapServer() {
    return new WebServiceServerBuilder()
            .port(8080)
            .autoStart(true)
            .keepSoapEnvelope(true)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.citrusframework.org/schema/config
       http://www.citrusframework.org/schema/config/citrus-config.xsd
       http://www.citrusframework.org/schema/ws/config
       http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;

  &lt;citrus-ws:server id="soapServer"
        port="8080"
        auto-start="true"
        keep-soap-envelope="true"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this configuration Citrus will handle all available mime headers and pass those to the test case for normal header validation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapServerTest() {
    then(soap()
        .server(soapServer)
        .receive()
            .message()
                .body("""
                &lt;SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
                  &lt;SOAP-ENV:Header/&gt;
                  &lt;SOAP-ENV:Body&gt;
                    &lt;SoapMessageRequest xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                    &lt;Operation&gt;Validate mime headers&lt;/Operation&gt;
                    &lt;/SoapMessageRequest&gt;
                  &lt;/SOAP-ENV:Body&gt;
                &lt;/SOAP-ENV:Envelope&gt;
                """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapServerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap server="soapServer"&gt;
        &lt;receive-request&gt;
          &lt;message&gt;
            &lt;body&gt;
              &lt;SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
                  &lt;SOAP-ENV:Header/&gt;
                  &lt;SOAP-ENV:Body&gt;
                    &lt;SoapMessageRequest xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                    &lt;Operation&gt;Validate mime headers&lt;/Operation&gt;
                    &lt;/SoapMessageRequest&gt;
                  &lt;/SOAP-ENV:Body&gt;
              &lt;/SOAP-ENV:Envelope&gt;
            &lt;/body&gt;
          &lt;/message&gt;
        &lt;/receive-request&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapServerTest
actions:
  - soap:
      server: "soapServer"
      receiveRequest:
        message:
          body:
            data: |
              &lt;SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
                  &lt;SOAP-ENV:Header/&gt;
                  &lt;SOAP-ENV:Body&gt;
                    &lt;SoapMessageRequest xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                    &lt;Operation&gt;Validate mime headers&lt;/Operation&gt;
                    &lt;/SoapMessageRequest&gt;
                  &lt;/SOAP-ENV:Body&gt;
              &lt;/SOAP-ENV:Envelope&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapServerTest"&gt;
    &lt;actions&gt;
      &lt;ws:receive endpoint="soapServer"&gt;
        &lt;message&gt;
          &lt;payload&gt;
            &lt;SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
              &lt;SOAP-ENV:Header/&gt;
              &lt;SOAP-ENV:Body&gt;
                &lt;SoapMessageRequest xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                &lt;Operation&gt;Validate mime headers&lt;/Operation&gt;
                &lt;/SoapMessageRequest&gt;
              &lt;/SOAP-ENV:Body&gt;
            &lt;/SOAP-ENV:Envelope&gt;
          &lt;/payload&gt;
        &lt;/message&gt;
      &lt;/ws:receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>So now you are able to validate the whole SOAP envelope as is. This might be of interest in very special cases. As mentioned by default the Citrus server will automatically remove the SOAP envelope and translate the SOAP body to the message payload for straight forward validation inside the test cases.</p>
</div>
</div>
<div class="sect2">
<h3 id="soap-server-interceptors"><a class="anchor" href="#soap-server-interceptors"></a><a class="link" href="#soap-server-interceptors">15.8. SOAP server interceptors</a></h3>
<div class="paragraph">
<p>The Citrus SOAP server supports the concept of interceptors in order to add custom logic to the request/response processing steps. The interceptors need to implement a common interface: <strong>org.springframework.ws.server.EndpointInterceptor</strong>. We are able to customize the interceptor
chain on the server component as follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebServiceServer soapServer() {
    return new WebServiceServerBuilder()
            .port(8080)
            .autoStart(true)
            .interceptors(serverInterceptors())
            .build();
}

public List&lt;SoapEndpointInterceptor&gt; serverInterceptors() {
    SoapMustUnderstandEndpointInterceptor mustUnderstandInterceptor = new SoapMustUnderstandEndpointInterceptor();
    mustUnderstandInterceptor.setAcceptedHeaders("{http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd}Security");

    Wss4jSecurityInterceptor wss4jSecurityInterceptor = new Wss4jSecurityInterceptor();
    wss4jSecurityInterceptor.setValidationActions("Timestamp UsernameToken");
    wss4jSecurityInterceptor.setValidationCallbackHandler(passwordCallbackHandler());

    return Arrays.asList(
            mustUnderstandInterceptor,
            new LoggingEndpointInterceptor(),
            wss4jSecurityInterceptor
    );
}

public SimplePasswordValidationCallbackHandler passwordCallbackHandler() {
    SimplePasswordValidationCallbackHandler handler = new SimplePasswordValidationCallbackHandler();
    handler.setUsersMap(Collections.singletonMap("admin", "secret"));
    return handler;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebServiceServer soapServer() {
    return new WebServiceServerBuilder()
            .port(8080)
            .autoStart(true)
            .interceptors(serverInterceptors())
            .build();
}

public List&lt;SoapEndpointInterceptor&gt; serverInterceptors() {
    SoapMustUnderstandEndpointInterceptor mustUnderstandInterceptor = new SoapMustUnderstandEndpointInterceptor();
    mustUnderstandInterceptor.setAcceptedHeaders("{http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd}Security");

    Wss4jSecurityInterceptor wss4jSecurityInterceptor = new Wss4jSecurityInterceptor();
    wss4jSecurityInterceptor.setValidationActions("Timestamp UsernameToken");
    wss4jSecurityInterceptor.setValidationCallbackHandler(passwordCallbackHandler());

    return Arrays.asList(
            mustUnderstandInterceptor,
            new LoggingEndpointInterceptor(),
            wss4jSecurityInterceptor
    );
}

public SimplePasswordValidationCallbackHandler passwordCallbackHandler() {
    SimplePasswordValidationCallbackHandler handler = new SimplePasswordValidationCallbackHandler();
    handler.setUsersMap(Collections.singletonMap("admin", "secret"));
    return handler;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.citrusframework.org/schema/config
       http://www.citrusframework.org/schema/config/citrus-config.xsd
       http://www.citrusframework.org/schema/ws/config
       http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;

    &lt;citrus-ws:server id="secureSoapServer"
                      port="8080"
                      auto-start="true"
                      interceptors="serverInterceptors"/&gt;

    &lt;util:list id="serverInterceptors"&gt;
      &lt;bean class="org.citrusframework.ws.interceptor.SoapMustUnderstandEndpointInterceptor"&gt;
        &lt;property name="acceptedHeaders"&gt;
          &lt;list&gt;
            &lt;value&gt;{http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd}Security&lt;/value&gt;
          &lt;/list&gt;
        &lt;/property&gt;
      &lt;/bean&gt;
      &lt;bean class="org.citrusframework.ws.interceptor.LoggingEndpointInterceptor"/&gt;
      &lt;bean class="org.springframework.ws.soap.security.wss4j.Wss4jSecurityInterceptor"&gt;
        &lt;property name="validationActions" value="Timestamp UsernameToken"/&gt;
        &lt;property name="validationCallbackHandler"&gt;
          &lt;bean id="passwordCallbackHandler" class="org.springframework.ws.soap.security.wss4j.callback.SimplePasswordValidationCallbackHandler"&gt;
            &lt;property name="usersMap"&gt;
              &lt;map&gt;
                &lt;entry key="admin" value="secret"/&gt;
              &lt;/map&gt;
            &lt;/property&gt;
          &lt;/bean&gt;
        &lt;/property&gt;
      &lt;/bean&gt;
    &lt;/util:list&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The custom interceptors are used to enable WsSecurity features on the soap server component via Wss4J.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When customizing the interceptor chain of the soap server component all default interceptors (like logging interceptors) are lost. You can see that we had to add
the <em>org.citrusframework.ws.interceptor.LoggingEndpointInterceptor</em> explicitly in order to log request/response messages for the server communication.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="soap-1-2"><a class="anchor" href="#soap-1-2"></a><a class="link" href="#soap-1-2">15.9. SOAP 1.2</a></h3>
<div class="paragraph">
<p>By default, Citrus components use SOAP 1.1 version. Fortunately SOAP 1.2 is supported the same way. As we already mentioned before the Citrus SOAP components do use a SOAP message factory for creating messages in SOAP format.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public SaajSoapMessageFactory soapMessageFactory() {
    SaajSoapMessageFactory messageFactory = new SaajSoapMessageFactory();
    messageFactory.setSoapVersion(SoapVersion.SOAP_11);
    return messageFactory;
}

@BindToRegistry
public SaajSoapMessageFactory soap12MessageFactory() {
    SaajSoapMessageFactory messageFactory = new SaajSoapMessageFactory();
    messageFactory.setSoapVersion(SoapVersion.SOAP_12);
    return messageFactory;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SaajSoapMessageFactory soapMessageFactory() {
    SaajSoapMessageFactory messageFactory = new SaajSoapMessageFactory();
    messageFactory.setSoapVersion(SoapVersion.SOAP_11);
    return messageFactory;
}

@Bean
public SaajSoapMessageFactory soap12MessageFactory() {
    SaajSoapMessageFactory messageFactory = new SaajSoapMessageFactory();
    messageFactory.setSoapVersion(SoapVersion.SOAP_12);
    return messageFactory;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.citrusframework.org/schema/config
       http://www.citrusframework.org/schema/config/citrus-config.xsd
       http://www.citrusframework.org/schema/ws/config
       http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;

    &lt;!-- SOAP 1.1 Message Factory --&gt;
    &lt;bean id="soapMessageFactory" class="org.springframework.ws.soap.saaj.SaajSoapMessageFactory"&gt;
      &lt;property name="soapVersion"&gt;
        &lt;util:constant static-field="org.springframework.ws.soap.SoapVersion.SOAP_11"/&gt;
      &lt;/property&gt;
    &lt;/bean&gt;

    &lt;!-- SOAP 1.2 Message Factory --&gt;
    &lt;bean id="soap12MessageFactory" class="org.springframework.ws.soap.saaj.SaajSoapMessageFactory"&gt;
      &lt;property name="soapVersion"&gt;
        &lt;util:constant static-field="org.springframework.ws.soap.SoapVersion.SOAP_12"/&gt;
      &lt;/property&gt;
    &lt;/bean&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the SOAP message factory can either create SOAP 1.1 or SOAP 1.2 messages. This is how Citrus can create both SOAP 1.1 and SOAP 1.2 messages. Of course you can have multiple message factories configured in your project. Just set the message factory on a WebService client or server component in order to define which version should be used.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebServiceClient soap12Client() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8080/echo")
            .timeout(10000L)
            .messageFactory(soap12MessageFactory())
            .build();
}

@BindToRegistry
public WebServiceServer soap12Server() {
    return new WebServiceServerBuilder()
            .port(8080)
            .autoStart(true)
            .messageFactory(soap12MessageFactory())
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebServiceClient soap12Client() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8080/echo")
            .timeout(10000L)
            .messageFactory(soap12MessageFactory())
            .build();
}

@Bean
public WebServiceServer soap12Server() {
    return new WebServiceServerBuilder()
            .port(8080)
            .autoStart(true)
            .messageFactory(soap12MessageFactory())
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.citrusframework.org/schema/config
       http://www.citrusframework.org/schema/config/citrus-config.xsd
       http://www.citrusframework.org/schema/ws/config
       http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;

  &lt;citrus-ws:client id="soap12Client"
            request-url="http://localhost:8080/echo"
            message-factory="soap12MessageFactory"
            timeout="10000"/&gt;

  &lt;citrus-ws:server id="soap12Server"
          port="8080"
          auto-start="true"
          root-parent-context="true"
          message-factory="soap12MessageFactory"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, Citrus components do connect with a message factory called <strong>messageFactory</strong> no matter what SOAP version this factory is using.</p>
</div>
</div>
<div class="sect2">
<h3 id="soap-faults"><a class="anchor" href="#soap-faults"></a><a class="link" href="#soap-faults">15.10. SOAP faults</a></h3>
<div class="paragraph">
<p>SOAP faults describe a failed communication in SOAP WebServices world. Citrus is able to send and receive SOAP fault messages. On server side Citrus can simulate SOAP faults with fault-code, fault-reason, fault-actor and fault-detail. On client side Citrus is able to handle and validate SOAP faults in response messages. The next section describes how to deal with SOAP faults in Citrus.</p>
</div>
</div>
<div class="sect2">
<h3 id="send-soap-faults"><a class="anchor" href="#send-soap-faults"></a><a class="link" href="#send-soap-faults">15.11. Send SOAP faults</a></h3>
<div class="paragraph">
<p>As Citrus simulates SOAP server endpoints you also need to think about sending a SOAP fault to the calling client. In case Citrus receives a SOAP request as a server you can respond with a proper SOAP fault if necessary.</p>
</div>
<div class="paragraph">
<p>Please keep in mind that we use the citrus-ws extension for sending SOAP faults in our test case, as shown in this very simple example:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapFaultTest() {
    then(soap()
            .server(soapServer)
            .sendFault()
                .message()
                    .faultActor("SERVER")
                    .faultCode("{http://citrusframework.org/faults}citrus:TEC-1000")
                    .faultString("Invalid request")
                    .faultDetail("""
                    &lt;FaultDetail xmlns="http://citrusframework.org/schemas/sayHello.xsd"&gt;
                        &lt;MessageId&gt;${messageId}&lt;/MessageId&gt;
                        &lt;CorrelationId&gt;${correlationId}&lt;/CorrelationId&gt;
                        &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                        &lt;Text&gt;Invalid request&lt;/Text&gt;
                    &lt;/FaultDetail&gt;
                    """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapFaultTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap server="soapServer"&gt;
        &lt;send-fault&gt;
          &lt;message fault-code="{http://citrusframework.org/faults}citrus:TEC-1000"
                    fault-string="Invalid request"
                    fault-actor="SERVER"&gt;
            &lt;fault-detail&gt;
              &lt;content&gt;
                &lt;![CDATA[
                &lt;FaultDetail xmlns="http://citrusframework.org/schemas/sayHello.xsd"&gt;
                    &lt;MessageId&gt;${messageId}&lt;/MessageId&gt;
                    &lt;CorrelationId&gt;${correlationId}&lt;/CorrelationId&gt;
                    &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                    &lt;Text&gt;Invalid request&lt;/Text&gt;
                &lt;/FaultDetail&gt;
                ]]&gt;
              &lt;/content&gt;
            &lt;/fault-detail&gt;
          &lt;/message&gt;
        &lt;/send-fault&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapFaultTest
actions:
  - soap:
      server: "soapServer"
      sendFault:
        message:
          faultCode: "{http://citrusframework.org/faults}citrus:TEC-1000"
          faultString: "Invalid request"
          faultActor: "SERVER"
          faultDetails:
            - content: |
                &lt;FaultDetail xmlns="http://citrusframework.org/schemas/sayHello.xsd"&gt;
                    &lt;MessageId&gt;${messageId}&lt;/MessageId&gt;
                    &lt;CorrelationId&gt;${correlationId}&lt;/CorrelationId&gt;
                    &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                    &lt;Text&gt;Invalid request&lt;/Text&gt;
                &lt;/FaultDetail&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapFaultTest"&gt;
    &lt;actions&gt;
      &lt;ws:send-fault endpoint="soapServer"&gt;
        &lt;ws:fault&gt;
            &lt;ws:fault-code&gt;{http://citrusframework.org/faults}citrus:TEC-1000&lt;/ws:fault-code&gt;
            &lt;ws:fault-string&gt;Invalid request&lt;/ws:fault-string&gt;
            &lt;ws:fault-actor&gt;SERVER&lt;/ws:fault-actor&gt;
            &lt;ws:fault-detail&gt;
                &lt;![CDATA[
                    &lt;FaultDetail xmlns="http://citrusframework.org/schemas/sayHello.xsd"&gt;
                        &lt;MessageId&gt;${messageId}&lt;/MessageId&gt;
                        &lt;CorrelationId&gt;${correlationId}&lt;/CorrelationId&gt;
                        &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                        &lt;Text&gt;Invalid request&lt;/Text&gt;
                    &lt;/FaultDetail&gt;
                ]]&gt;
            &lt;/ws:fault-detail&gt;
        &lt;/ws:fault&gt;
      &lt;/ws:send-fault&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example generates a simple SOAP fault that is sent back to the calling client. The fault-actor and the fault-detail elements are optional. Same with the soap action declared in the special Citrus header <strong><em>citrus_soap_action</em></strong> . In the sample above the fault-detail data is placed inline as XML data. As an alternative to that you can also set the fault-detail via external file resource. Just use the <strong><em>file</em></strong> attribute as fault detail instead of the inline CDATA definition.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapFaultTest() {
    then(soap()
            .server(soapServer)
            .sendFault()
                .message()
                    .faultActor("SERVER")
                    .faultCode("{http://citrusframework.org/faults}citrus:TEC-1000")
                    .faultString("Invalid request")
                    .faultDetail(Resources.of("classpath:myFaultDetail.xml"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapFaultTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap server="soapServer"&gt;
        &lt;send-fault&gt;
          &lt;message fault-code="{http://citrusframework.org/faults}citrus:TEC-1000"
                    fault-string="Invalid request"
                    fault-actor="SERVER"&gt;
            &lt;fault-detail&gt;
              &lt;resource file="classpath:myFaultDetail.xml"/&gt;
            &lt;/fault-detail&gt;
          &lt;/message&gt;
        &lt;/send-fault&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapFaultTest
actions:
  - soap:
      server: "soapServer"
      sendFault:
        message:
          faultCode: "{http://citrusframework.org/faults}citrus:TEC-1000"
          faultString: "Invalid request"
          faultActor: "SERVER"
          faultDetails:
            - file: "classpath:myFaultDetail.xml"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapFaultTest"&gt;
    &lt;actions&gt;
      &lt;ws:send-fault endpoint="soapServer"&gt;
        &lt;ws:fault&gt;
            &lt;ws:fault-code&gt;{http://citrusframework.org/faults}citrus:TEC-1000&lt;/ws:fault-code&gt;
            &lt;ws:fault-string&gt;Invalid request&lt;/ws:fault-string&gt;
            &lt;ws:fault-actor&gt;SERVER&lt;/ws:fault-actor&gt;
            &lt;ws:fault-detail file="classpath:myFaultDetail.xml"/&gt;
        &lt;/ws:fault&gt;
      &lt;/ws:send-fault&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated SOAP fault looks like follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">HTTP/1.1 500 Internal Server Error
Accept: text/xml, text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2
SOAPAction: "sayHello"
Content-Type: text/xml; charset=utf-8
Content-Length: 680
Server: Jetty(7.0.0.pre5)

&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
    &lt;SOAP-ENV:Header/&gt;
    &lt;SOAP-ENV:Body&gt;
        &lt;SOAP-ENV:Fault&gt;
            &lt;faultcode xmlns:citrus="http://citrusframework.org/faults"&gt;citrus:TEC-1000&lt;/faultcode&gt;
            &lt;faultstring xml:lang="en"&gt;Invalid request&lt;/faultstring&gt;
            &lt;detail&gt;
                &lt;FaultDetail xmlns="http://citrusframework.org/schemas/sayHello.xsd"&gt;
                    &lt;MessageId&gt;9277832563&lt;/MessageId&gt;
                    &lt;CorrelationId&gt;4346806225&lt;/CorrelationId&gt;
                    &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                    &lt;Text&gt;Invalid request&lt;/Text&gt;
                &lt;/FaultDetail&gt;
            &lt;/detail&gt;
        &lt;/SOAP-ENV:Fault&gt;
    &lt;/SOAP-ENV:Body&gt;
&lt;/SOAP-ENV:Envelope&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="receive-soap-faults"><a class="anchor" href="#receive-soap-faults"></a><a class="link" href="#receive-soap-faults">15.12. Receive SOAP faults</a></h3>
<div class="paragraph">
<p>In case you receive SOAP response messages as a client endpoint you may need to handle and validate SOAP faults in error situations. Citrus can validate SOAP faults with fault-code, fault-actor, fault-string and fault-detail values.</p>
</div>
<div class="paragraph">
<p>As a client we send out a request and receive a SOAP fault as response. By default the client sending action in Citrus throws a specific exception when the SOAP response is a SOAP fault element. This exception is called <strong><em>SoapFaultClientException</em></strong> coming from the Spring API. You as a tester can assert this kind of exception in a test case in order to expect the SOAP error.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapFaultTest() {
    then(assertException()
            .exception(SoapFaultClientException.class)
            .when(
              send()
                .endpoint("soapClient")
                .message()
                    .body("""
                    &lt;SoapFaultForcingRequest xmlns="http://citrusframework.org/schemas/soap"&gt;
                        &lt;Message&gt;This is invalid&lt;/Message&gt;
                    &lt;/SoapFaultForcingRequest&gt;
                    """)
            )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapFaultTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;assert exception="org.springframework.ws.soap.client.SoapFaultClientException"&gt;
        &lt;when&gt;
          &lt;send endpoint="soapClient"&gt;
            &lt;message&gt;
              &lt;body&gt;
                &lt;SoapFaultForcingRequest
                  xmlns="http://citrusframework.org/schemas/soap"&gt;
                    &lt;Message&gt;This is invalid&lt;/Message&gt;
                &lt;/SoapFaultForcingRequest&gt;
              &lt;/body&gt;
            &lt;/message&gt;
          &lt;/send&gt;
        &lt;/when&gt;
      &lt;/assert&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapFaultTest
actions:
  - assert:
      exception: "org.springframework.ws.soap.client.SoapFaultClientException"
      when:
        send:
          endpoint: soapClient
          message:
            body: |
              &lt;SoapFaultForcingRequest xmlns="http://citrusframework.org/schemas/soap"&gt;
                &lt;Message&gt;This is invalid&lt;/Message&gt;
              &lt;/SoapFaultForcingRequest&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapFaultTest"&gt;
    &lt;actions&gt;
        &lt;assert exception="org.springframework.ws.soap.client.SoapFaultClientException"&gt;
          &lt;when&gt;
            &lt;send endpoint="soapClient"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;SoapFaultForcingRequest
                          xmlns="http://citrusframework.org/schemas/soap"&gt;
                            &lt;Message&gt;This is invalid&lt;/Message&gt;
                        &lt;/SoapFaultForcingRequest&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;
          &lt;/when&gt;
        &lt;/assert&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The SOAP message sending action is surrounded by a simple assert action. The asserted exception class is the <strong><em>SoapFaultClientException</em></strong> that we have mentioned before. This means that the test expects the exception to be thrown during the communication. In case the exception is missing the test fails.</p>
</div>
<div class="paragraph">
<p>So far we have used the Citrus core capabilities of asserting an exception. This basic assertion test action is not able to offer direct access to the SOAP fault-code and fault-string values for validation. The basic assert action simply has no access to the actual SOAP fault elements. Fortunately we can use the <strong>citrus-ws</strong> namespace again which offers a special assert action implementation especially designed for SOAP faults in this case.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapFaultTest() {
    then(soap()
            .client(soapClient)
            .assertFault()
                .faultActor("SERVER")
                .faultCode("{http://citrusframework.org/faults}citrus:TEC-1000")
                .faultString("Invalid request")
            .when(
              send()
                .endpoint(soapClient)
                .message()
                    .body("""
                    &lt;SoapFaultForcingRequest xmlns="http://citrusframework.org/schemas/soap"&gt;
                        &lt;Message&gt;This is invalid&lt;/Message&gt;
                    &lt;/SoapFaultForcingRequest&gt;
                    """)
            )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapFaultTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap client="soapClient"&gt;
        &lt;assert-fault fault-actor="SERVER"
                      fault-string="Invalid request"
                      fault-code="{http://citrusframework.org/faults}citrus:TEC-1000"&gt;
          &lt;when&gt;
            &lt;send endpoint="soapClient"&gt;
              &lt;message&gt;
                &lt;body&gt;
                    &lt;SoapFaultForcingRequest
                      xmlns="http://citrusframework.org/schemas/soap"&gt;
                        &lt;Message&gt;This is invalid&lt;/Message&gt;
                    &lt;/SoapFaultForcingRequest&gt;
                &lt;/body&gt;
              &lt;/message&gt;
            &lt;/send&gt;
          &lt;/when&gt;
        &lt;/assert-fault&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapFaultTest
actions:
  - soap:
      client: "soapClient"
      assertFault:
        faultActor: "SERVER"
        faultCode: "{http://citrusframework.org/faults}citrus:TEC-1000"
        faultString: "Invalid request"
        when:
          - send:
              endpoint: soapClient
              message:
                body: |
                  &lt;SoapFaultForcingRequest xmlns="http://citrusframework.org/schemas/soap"&gt;
                    &lt;Message&gt;This is invalid&lt;/Message&gt;
                  &lt;/SoapFaultForcingRequest&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapFaultTest"&gt;
    &lt;actions&gt;
        &lt;ws:assert-fault fault-code="{http://citrusframework.org/faults}TEC-1001"
                   fault-string="Invalid request"&gt;
                   fault-actor="SERVER"&gt;
          &lt;ws:when&gt;
            &lt;send endpoint="soapClient"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;SoapFaultForcingRequest
                          xmlns="http://citrusframework.org/schemas/soap"&gt;
                            &lt;Message&gt;This is invalid&lt;/Message&gt;
                        &lt;/SoapFaultForcingRequest&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;
          &lt;/ws:when&gt;
        &lt;/ws:assert-fault&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The special assert action offers several attributes to validate the expected SOAP fault. Namely these are <strong>"fault-code"</strong>, <strong>"fault-string"</strong> and <strong>"fault-actor"</strong> . The <strong>fault-code</strong> is defined as a QName string and is mandatory for the validation. The fault assertion also supports test variable replacement as usual.</p>
</div>
<div class="paragraph">
<p>The time you use SOAP fault validation you need to tell Citrus how to validate the SOAP faults. Citrus needs an instance of a <strong><em>SoapFaultValidator</em></strong> that we need to add to the Spring application context. By default Citrus is searching for a bean with the id <strong>'soapFaultValidator'</strong> .</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public SimpleSoapAttachmentValidator soapFaultValidator() {
    return new SimpleSoapAttachmentValidator();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SimpleSoapAttachmentValidator soapFaultValidator() {
    return new SimpleSoapAttachmentValidator();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.citrusframework.org/schema/config
       http://www.citrusframework.org/schema/config/citrus-config.xsd
       http://www.citrusframework.org/schema/ws/config
       http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;

  &lt;bean id="soapFaultValidator" class="org.citrusframework.ws.validation.SimpleSoapAttachmentValidator"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus offers several reference implementations for these SOAP fault validators. These are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>org.citrusframework.ws.validation.SimpleSoapAttachmentValidator</p>
</li>
<li>
<p>org.citrusframework.ws.validation.SimpleSoapFaultValidator</p>
</li>
<li>
<p>org.citrusframework.ws.validation.XmlSoapFaultValidator</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Please see the API documentation for details on the available reference implementations. Of course you can also define your own SOAP validator logic (would be great if you could share your ideas!). In the test case you can explicitly choose the validator to use:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapFaultTest() {
    then(soap()
            .client(soapClient)
            .assertFault()
                .faultActor("SERVER")
                .faultCode("{http://citrusframework.org/faults}citrus:TEC-1000")
                .faultString("Invalid request")
                .validator(mySpecialSoapFaultValidator)
            .when(
              // [...]
            )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapFaultTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap client="soapClient"&gt;
        &lt;assert-fault fault-actor="SERVER"
                      fault-string="Invalid request"
                      fault-code="{http://citrusframework.org/faults}citrus:TEC-1000"
                      validator="mySpecialSoapFaultValidator"&gt;
          &lt;when&gt;
            [...]
          &lt;/when&gt;
        &lt;/assert-fault&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapFaultTest
actions:
  - soap:
      client: "soapClient"
      assertFault:
        faultActor: "SERVER"
        faultCode: "{http://citrusframework.org/faults}citrus:TEC-1000"
        faultString: "Invalid request"
        validator: "mySpecialSoapFaultValidator"
        when:
          [...]</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapFaultTest"&gt;
    &lt;actions&gt;
        &lt;ws:assert-fault fault-code="{http://citrusframework.org/faults}TEC-1001"
                          fault-string="Invalid request"
                          fault-validator="mySpecialSoapFaultValidator"&gt;
           [...]
        &lt;/ws:assert-fault&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Another important thing to notice when asserting SOAP faults is the fact, that Citrus needs to have a <strong><em>SoapMessageFactory</em></strong> available in the Spring application context. If you deal with SOAP messaging in general you will already have such a bean in the context.
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public SaajSoapMessageFactory messageFactory() {
    return new SaajSoapMessageFactory();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SaajSoapMessageFactory messageFactory() {
    return new SaajSoapMessageFactory();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;

  &lt;bean id="messageFactory" class="org.springframework.ws.soap.saaj.SaajSoapMessageFactory"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Choose one of Spring&#8217;s reference implementations or some other implementation as SOAP message factory. Citrus will search for a bean with id <strong>'messageFactory'</strong> by default.</p>
</div>
<div class="paragraph">
<p>Citrus is also able to validate SOAP fault details. See the following example for understanding how to do it:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapFaultTest() {
    then(soap()
            .client(soapClient)
            .assertFault()
                .faultActor("SERVER")
                .faultCode("{http://citrusframework.org/faults}citrus:TEC-1000")
                .faultString("Invalid request")
                .faultDetail("""
                &lt;FaultDetail xmlns="http://citrusframework.org/schemas/soap"&gt;
                  &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                  &lt;Text&gt;Invalid request&lt;/Text&gt;
                &lt;/FaultDetail&gt;
                """)
            .when(
              // [...]
            )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapFaultTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap client="soapClient"&gt;
        &lt;assert-fault fault-actor="SERVER"
                      fault-string="Invalid request"
                      fault-code="{http://citrusframework.org/faults}citrus:TEC-1000"&gt;
          &lt;fault-detail&gt;
            &lt;content&gt;
              &lt;![CDATA[
                  &lt;FaultDetail xmlns="http://citrusframework.org/schemas/soap"&gt;
                      &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                      &lt;Text&gt;Invalid request&lt;/Text&gt;
                  &lt;/FaultDetail&gt;
              ]]&gt;
            &lt;/content&gt;
          &lt;/fault-detail&gt;
          &lt;when&gt;
            [...]
          &lt;/when&gt;
        &lt;/assert-fault&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapFaultTest
actions:
  - soap:
      client: "soapClient"
      assertFault:
        faultActor: "SERVER"
        faultCode: "{http://citrusframework.org/faults}citrus:TEC-1000"
        faultString: "Invalid request"
        faultDetails:
          - content: |
              &lt;FaultDetail xmlns="http://citrusframework.org/schemas/soap"&gt;
                  &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                  &lt;Text&gt;Invalid request&lt;/Text&gt;
              &lt;/FaultDetail&gt;
        when:
          [...]</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapFaultTest"&gt;
    &lt;actions&gt;
        &lt;ws:assert-fault fault-code="{http://citrusframework.org/faults}TEC-1001"
                         fault-string="Invalid request"&gt;
            &lt;ws:fault-detail&gt;
              &lt;![CDATA[
                  &lt;FaultDetail xmlns="http://citrusframework.org/schemas/soap"&gt;
                      &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                      &lt;Text&gt;Invalid request&lt;/Text&gt;
                  &lt;/FaultDetail&gt;
              ]]&gt;
            &lt;/ws:fault-detail&gt;
            &lt;ws:when&gt;
                [...]
            &lt;/ws:when&gt;
        &lt;/ws:assert-fault&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The expected SOAP fault detail content is simply added to the <strong>ws:assert</strong> action. The <strong><em>SoapFaultValidator</em></strong> implementation defined in the Spring application context is responsible for checking the SOAP fault detail with validation algorithm. The validator implementation checks the detail content to meet the expected template. Citrus provides some default <strong><em>SoapFaultValidator</em></strong> implementations. Supported algorithms are pure String comparison (<strong>org.citrusframework.ws.validation.SimpleSoapFaultValidator</strong>) as well as XML tree walk-through (<strong>org.citrusframework.ws.validation.XmlSoapFaultValidator</strong>).</p>
</div>
<div class="paragraph">
<p>When using the XML validation algorithm you have the complete power as known from normal message validation in receive actions. This includes schema validation or ignoring elements for instance. On the fault-detail element you are able to add some validation settings such as <strong>schema-validation=enabled/disabled</strong>, custom <strong>schema-repository</strong> and so on.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapFaultTest() {
    then(soap()
            .client(soapClient)
            .assertFault()
                .faultActor("SERVER")
                .faultCode("{http://citrusframework.org/faults}citrus:TEC-1000")
                .faultString("Invalid request")
                .schemaValidation(false)
                .faultDetail("""
                &lt;FaultDetail xmlns="http://citrusframework.org/schemas/soap"&gt;
                  &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                  &lt;Text&gt;Invalid request&lt;/Text&gt;
                &lt;/FaultDetail&gt;
                """)
            .when(
              // [...]
            )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapFaultTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap client="soapClient"&gt;
        &lt;assert-fault fault-actor="SERVER"
                      fault-string="Invalid request"
                      fault-code="{http://citrusframework.org/faults}citrus:TEC-1000"
                      schema-validation="false"&gt;
          &lt;fault-detail&gt;
            &lt;content&gt;
              &lt;![CDATA[
                  &lt;FaultDetail xmlns="http://citrusframework.org/schemas/soap"&gt;
                      &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                      &lt;Text&gt;Invalid request&lt;/Text&gt;
                  &lt;/FaultDetail&gt;
              ]]&gt;
            &lt;/content&gt;
          &lt;/fault-detail&gt;
          &lt;when&gt;
            [...]
          &lt;/when&gt;
        &lt;/assert-fault&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapFaultTest
actions:
  - soap:
      client: "soapClient"
      assertFault:
        faultActor: "SERVER"
        faultCode: "{http://citrusframework.org/faults}citrus:TEC-1000"
        faultString: "Invalid request"
        schemaValidation: false
        faultDetails:
          - content: |
              &lt;FaultDetail xmlns="http://citrusframework.org/schemas/soap"&gt;
                  &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                  &lt;Text&gt;Invalid request&lt;/Text&gt;
              &lt;/FaultDetail&gt;
        when:
          [...]</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapFaultTest"&gt;
    &lt;actions&gt;
        &lt;ws:assert-fault fault-code="{http://citrusframework.org/faults}TEC-1001"
                          fault-string="Invalid request"&gt;
            &lt;ws:fault-detail schema-validation="false"&gt;
              &lt;![CDATA[
                  &lt;FaultDetail xmlns="http://citrusframework.org/schemas/soap"&gt;
                      &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                      &lt;Text&gt;Invalid request&lt;/Text&gt;
                  &lt;/FaultDetail&gt;
              ]]&gt;
            &lt;/ws:fault-detail&gt;
            &lt;ws:when&gt;
                [...]
            &lt;/ws:when&gt;
        &lt;/ws:assert-fault&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please see also the Citrus API documentation for available validator implementations and validation algorithms.</p>
</div>
<div class="paragraph">
<p>So far we have used assert action wrapper in order to catch SOAP fault exceptions and validate the SOAP fault content. Now we have an alternative way of handling SOAP faults in Citrus. With exceptions the send action aborts and we do not have a receive action for the SOAP fault. This might be inadequate if we need to validate the SOAP message content (SOAPHeader and SOAPBody) coming with the SOAP fault. Therefore the web service message sender component offers several fault strategy options. In the following we discuss the propagation of SOAP fault as messages to the receive action as we would do with normal SOAP messages.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebServiceClient soapClient() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8090/test")
            .faultStrategy(ErrorHandlingStrategy.PROPAGATE)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebServiceClient soapClient() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8090/test")
            .faultStrategy(ErrorHandlingStrategy.PROPAGATE)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.citrusframework.org/schema/config
       http://www.citrusframework.org/schema/config/citrus-config.xsd
       http://www.citrusframework.org/schema/ws/config
       http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;

  &lt;citrus-ws:client id="soapClient"
                  request-url="http://localhost:8090/test"
                  fault-strategy="propagateError"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have configured a fault strategy <strong>propagateError</strong> so the message sender will not raise client exceptions but inform the receive action with SOAP fault message contents. By default, the fault strategy raises client exceptions (fault-strategy= <strong>throwsException</strong>).</p>
</div>
<div class="paragraph">
<p>So now that we do not raise exceptions we can leave out the assert action wrapper in our test. Instead we simply use a receive action and validate the SOAP fault like this.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapFaultTest() {
    when(send()
           .endpoint(soapClient)
           .message()
               .body("""
                &lt;SoapFaultForcingRequest xmlns="http://citrusframework.org/schemas/soap"&gt;
                    &lt;Message&gt;This is invalid&lt;/Message&gt;
                &lt;/SoapFaultForcingRequest&gt;
                """)
    );

    then(receive()
            .endpoint(soapClient)
            .message()
                .body("""
                &lt;SOAP-ENV:Fault xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
                    &lt;SOAP-ENV:faultcode xmlns:CITRUS="http://citrus.org/soap"&gt;CITRUS:${soapFaultCode}&lt;/SOAP-ENV:faultcode&gt;
                    &lt;SOAP-ENV:faultstring xml:lang="en"&gt;${soapFaultString}&lt;/SOAP-ENV:faultstring&gt;
                &lt;/SOAP-ENV:Fault&gt;
                """));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapFaultTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="soapClient"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;SoapFaultForcingRequest xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                        &lt;Message&gt;This is invalid&lt;/Message&gt;
                    &lt;/SoapFaultForcingRequest&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="soapClient" timeout="5000"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;SOAP-ENV:Fault xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
                        &lt;SOAP-ENV:faultcode xmlns:CITRUS="http://citrus.org/soap"&gt;CITRUS:${soapFaultCode}&lt;/SOAP-ENV:faultcode&gt;
                        &lt;SOAP-ENV:faultstring xml:lang="en"&gt;${soapFaultString}&lt;/SOAP-ENV:faultstring&gt;
                    &lt;/SOAP-ENV:Fault&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapFaultTest
actions:
  - send:
      endpoint: "soapClient"
      message:
        body:
          data: |
            &lt;SoapFaultForcingRequest xmlns="http://citrusframework.org/schemas/soap"&gt;
                &lt;Message&gt;This is invalid&lt;/Message&gt;
            &lt;/SoapFaultForcingRequest&gt;

  - receive:
      endpoint: "soapClient"
      timeout: 5000
      message:
        body:
          data: |
            &lt;SOAP-ENV:Fault xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
                &lt;SOAP-ENV:faultcode xmlns:CITRUS="http://citrus.org/soap"&gt;CITRUS:${soapFaultCode}&lt;/SOAP-ENV:faultcode&gt;
                &lt;SOAP-ENV:faultstring xml:lang="en"&gt;${soapFaultString}&lt;/SOAP-ENV:faultstring&gt;
            &lt;/SOAP-ENV:Fault&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapFaultTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="soapClient"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                    &lt;SoapFaultForcingRequest xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                        &lt;Message&gt;This is invalid&lt;/Message&gt;
                    &lt;/SoapFaultForcingRequest&gt;
                &lt;/payload&gt;
            &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="soapClient" timeout="5000"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                    &lt;SOAP-ENV:Fault xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
                        &lt;SOAP-ENV:faultcode xmlns:CITRUS="http://citrus.org/soap"&gt;CITRUS:${soapFaultCode}&lt;/SOAP-ENV:faultcode&gt;
                        &lt;SOAP-ENV:faultstring xml:lang="en"&gt;${soapFaultString}&lt;/SOAP-ENV:faultstring&gt;
                    &lt;/SOAP-ENV:Fault&gt;
                &lt;/payload&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>So choose the preferred way of handling SOAP faults either by asserting client exceptions or propagating fault messages to the <code>receive</code> action on a SOAP client.</p>
</div>
</div>
<div class="sect2">
<h3 id="multiple-soap-fault-details"><a class="anchor" href="#multiple-soap-fault-details"></a><a class="link" href="#multiple-soap-fault-details">15.13. Multiple SOAP fault details</a></h3>
<div class="paragraph">
<p>SOAP fault messages can hold multiple SOAP fault detail elements. In the previous sections we have used SOAP fault details in sending and receiving actions as single element. In order to meet the SOAP specification Citrus is also able to handle multiple SOAP fault detail elements in a message. You just use multiple fault-detail elements in your test action like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapFaultTest() {
    then(soap()
            .server(soapServer)
            .sendFault()
                .message()
                    .faultActor("SERVER")
                    .faultCode("{http://citrusframework.org/faults}citrus:TEC-1000")
                    .faultString("Invalid request")
                    .faultDetail("""
                    &lt;FaultDetail xmlns="http://citrusframework.org/schemas/sayHello.xsd"&gt;
                        &lt;MessageId&gt;${messageId}&lt;/MessageId&gt;
                        &lt;CorrelationId&gt;${correlationId}&lt;/CorrelationId&gt;
                        &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                        &lt;Text&gt;Invalid request&lt;/Text&gt;
                    &lt;/FaultDetail&gt;
                    """)
                    .faultDetail("""
                    &lt;ErrorDetail xmlns="http://citrusframework.org/schemas/sayHello.xsd"&gt;
                        &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                    &lt;/ErrorDetail&gt;
                    """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapFaultTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap server="soapServer"&gt;
        &lt;send-fault&gt;
          &lt;message fault-code="{http://citrusframework.org/faults}citrus:TEC-1000"
                    fault-string="Invalid request"
                    fault-actor="SERVER"&gt;
            &lt;fault-detail&gt;
              &lt;content&gt;
                &lt;![CDATA[
                &lt;FaultDetail xmlns="http://citrusframework.org/schemas/sayHello.xsd"&gt;
                    &lt;MessageId&gt;${messageId}&lt;/MessageId&gt;
                    &lt;CorrelationId&gt;${correlationId}&lt;/CorrelationId&gt;
                    &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                    &lt;Text&gt;Invalid request&lt;/Text&gt;
                &lt;/FaultDetail&gt;
                ]]&gt;
              &lt;/content&gt;
              &lt;content&gt;
                &lt;![CDATA[
                &lt;ErrorDetail xmlns="http://citrusframework.org/schemas/sayHello.xsd"&gt;
                    &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                &lt;/ErrorDetail&gt;
                ]]&gt;
              &lt;/content&gt;
            &lt;/fault-detail&gt;
          &lt;/message&gt;
        &lt;/send-fault&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapFaultTest
actions:
  - soap:
      server: "soapServer"
      sendFault:
        message:
          faultCode: "{http://citrusframework.org/faults}citrus:TEC-1000"
          faultString: "Invalid request"
          faultActor: "SERVER"
          faultDetails:
            - content: |
                &lt;FaultDetail xmlns="http://citrusframework.org/schemas/sayHello.xsd"&gt;
                    &lt;MessageId&gt;${messageId}&lt;/MessageId&gt;
                    &lt;CorrelationId&gt;${correlationId}&lt;/CorrelationId&gt;
                    &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                    &lt;Text&gt;Invalid request&lt;/Text&gt;
                &lt;/FaultDetail&gt;
            - content: |
                &lt;ErrorDetail xmlns="http://citrusframework.org/schemas/sayHello.xsd"&gt;
                    &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                &lt;/ErrorDetail&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapFaultTest"&gt;
    &lt;actions&gt;
        &lt;ws:send-fault endpoint="soapServer"&gt;
            &lt;ws:fault&gt;
                &lt;ws:fault-code&gt;{http://citrusframework.org/faults}citrus:TEC-1000&lt;/ws:fault-code&gt;
                &lt;ws:fault-string&gt;Invalid request&lt;/ws:fault-string&gt;
                &lt;ws:fault-actor&gt;SERVER&lt;/ws:fault-actor&gt;
                &lt;ws:fault-detail&gt;
                    &lt;![CDATA[
                        &lt;FaultDetail xmlns="http://citrusframework.org/schemas/sayHello.xsd"&gt;
                            &lt;MessageId&gt;${messageId}&lt;/MessageId&gt;
                            &lt;CorrelationId&gt;${correlationId}&lt;/CorrelationId&gt;
                            &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                            &lt;Text&gt;Invalid request&lt;/Text&gt;
                        &lt;/FaultDetail&gt;
                    ]]&gt;
                &lt;/ws:fault-detail&gt;
                &lt;ws:fault-detail&gt;
                    &lt;![CDATA[
                        &lt;ErrorDetail xmlns="http://citrusframework.org/schemas/sayHello.xsd"&gt;
                            &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                        &lt;/ErrorDetail&gt;
                    ]]&gt;
                &lt;/ws:fault-detail&gt;
            &lt;/ws:fault&gt;
            &lt;ws:header&gt;
                &lt;ws:element name="citrus_soap_action" value="sayHello"/&gt;
            &lt;/ws:header&gt;
        &lt;/ws:send-fault&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will result in following SOAP envelope message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">HTTP/1.1 500 Internal Server Error
Accept: text/xml, text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2
SOAPAction: "sayHello"
Content-Type: text/xml; charset=utf-8
Content-Length: 680
Server: Jetty(7.0.0.pre5)

&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
    &lt;SOAP-ENV:Header/&gt;
    &lt;SOAP-ENV:Body&gt;
        &lt;SOAP-ENV:Fault&gt;
            &lt;faultcode xmlns:citrus="http://citrusframework.org/faults"&gt;citrus:TEC-1000&lt;/faultcode&gt;
            &lt;faultstring xml:lang="en"&gt;Invalid request&lt;/faultstring&gt;
            &lt;detail&gt;
                &lt;FaultDetail xmlns="http://citrusframework.org/schemas/sayHello.xsd"&gt;
                    &lt;MessageId&gt;9277832563&lt;/MessageId&gt;
                    &lt;CorrelationId&gt;4346806225&lt;/CorrelationId&gt;
                    &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                    &lt;Text&gt;Invalid request&lt;/Text&gt;
                &lt;/FaultDetail&gt;
                &lt;ErrorDetail xmlns="http://citrusframework.org/schemas/sayHello.xsd"&gt;
                    &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                &lt;/ErrorDetail&gt;
            &lt;/detail&gt;
        &lt;/SOAP-ENV:Fault&gt;
    &lt;/SOAP-ENV:Body&gt;
&lt;/SOAP-ENV:Envelope&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, we can also expect several fault detail elements when receiving a SOAP fault.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapFaultTest() {
    then(soap()
            .client(soapClient)
            .assertFault()
                .faultActor("SERVER")
                .faultCode("{http://citrusframework.org/faults}citrus:TEC-1000")
                .faultString("Invalid request")
                .faultDetail("""
                &lt;FaultDetail xmlns="http://citrusframework.org/schemas/soap"&gt;
                    &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                    &lt;Text&gt;Invalid request&lt;/Text&gt;
                &lt;/FaultDetail&gt;
                """)
                .faultDetail("""
                &lt;ErrorDetail xmlns="http://citrusframework.org/schemas/soap"&gt;
                    &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                &lt;/ErrorDetail&gt;
                """)
                .when(send()
                    .endpoint(soapClient)
                    // [...]
                )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapFaultTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap server="soapServer"&gt;
        &lt;assert-fault fault-code="{http://citrusframework.org/faults}citrus:TEC-1000"
                      fault-string="Invalid request"&gt;
            &lt;fault-detail&gt;
              &lt;content&gt;
                &lt;![CDATA[
                &lt;FaultDetail xmlns="http://citrusframework.org/schemas/soap"&gt;
                    &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                    &lt;Text&gt;Invalid request&lt;/Text&gt;
                &lt;/FaultDetail&gt;
                ]]&gt;
              &lt;/content&gt;
              &lt;content&gt;
                &lt;![CDATA[
                &lt;ErrorDetail xmlns="http://citrusframework.org/schemas/soap"&gt;
                    &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                &lt;/ErrorDetail&gt;
                ]]&gt;
              &lt;/content&gt;
            &lt;/fault-detail&gt;
            &lt;when&gt;
              &lt;send endpoint="soapClient"&gt;
                [...]
              &lt;/send&gt;
            &lt;/when&gt;
        &lt;/assert-fault&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapFaultTest
actions:
  - soap:
      client: "soapClient"
      assertFault:
        faultCode: "{http://citrusframework.org/faults}citrus:TEC-1000"
        faultString: "Invalid request"
        faultDetails:
          - content: |
              &lt;FaultDetail xmlns="http://citrusframework.org/schemas/soap"&gt;
                &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                &lt;Text&gt;Invalid request&lt;/Text&gt;
              &lt;/FaultDetail&gt;
          - content: |
              &lt;ErrorDetail xmlns="http://citrusframework.org/schemas/soap"&gt;
                &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
              &lt;/ErrorDetail&gt;
        when:
          - send:
              endpoint: soapClient
              # [...]</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapFaultTest"&gt;
    &lt;actions&gt;
        &lt;ws:assert-fault fault-code="{http://citrusframework.org/faults}TEC-1001"
                   fault-string="Invalid request"&gt;
            &lt;ws:fault-detail schema-validation="false"&gt;
              &lt;![CDATA[
                  &lt;FaultDetail xmlns="http://citrusframework.org/schemas/soap"&gt;
                      &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                      &lt;Text&gt;Invalid request&lt;/Text&gt;
                  &lt;/FaultDetail&gt;
              ]]&gt;
            &lt;/ws:fault-detail&gt;
            &lt;ws:fault-detail&gt;
              &lt;![CDATA[
                  &lt;ErrorDetail xmlns="http://citrusframework.org/schemas/soap"&gt;
                      &lt;ErrorCode&gt;TEC-1000&lt;/ErrorCode&gt;
                  &lt;/ErrorDetail&gt;
              ]]&gt;
            &lt;/ws:fault-detail&gt;
            &lt;ws:when&gt;
                &lt;send endpoint="soapClient"&gt;
                    [...]
                &lt;/send&gt;
            &lt;/ws:when&gt;
        &lt;/ws:assert-fault&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we can individually use validation settings for each fault detail. In the example above we disabled schema validation for the first fault detail element.</p>
</div>
</div>
<div class="sect2">
<h3 id="send-http-error-codes-with-soap"><a class="anchor" href="#send-http-error-codes-with-soap"></a><a class="link" href="#send-http-error-codes-with-soap">15.14. Send HTTP error codes with SOAP</a></h3>
<div class="paragraph">
<p>The SOAP server logic in Citrus is able to simulate pure HTTP error codes such as <code>404</code> "Not found" or <code>500</code> "Internal server error".
The good thing is that the Citrus server is able to receive a request for proper validation in a <code>receive</code> action and then simulate HTTP errors on demand.</p>
</div>
<div class="paragraph">
<p>The mechanism on HTTP error code simulation is not different to the usual SOAP request/response handling in Citrus.
We receive the request as usual, and we provide a response.
The HTTP error situation is simulated according to the special HTTP header <strong>citrus_http_status</strong> in the Citrus SOAP response definition.
In case this header is set to a value other than 200 OK the Citrus SOAP server sends an empty SOAP response with HTTP error status code set accordingly.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapFaultTest() {
    then(send()
            .endpoint(soapServer)
            .message()
            .header("citrus_http_status_code", 500L)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapFaultTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;send endpoint="soapServer"&gt;
          &lt;message&gt;
            &lt;body&gt;
              &lt;data/&gt;
            &lt;/body&gt;
            &lt;headers&gt;
              &lt;header name="citrus_http_status_code" value="500"/&gt;
            &lt;/headers&gt;
          &lt;/message&gt;
      &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapFaultTest
actions:
  - send:
      endpoint: "soapServer"
      message:
        body:
          data: {}
        headers:
          - name: "citrus_http_status_code"
            value: 500</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapFaultTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="soapServer"&gt;
            &lt;message&gt;
                &lt;data/&gt;
            &lt;/message&gt;
            &lt;header&gt;
                &lt;element name="citrus_http_status_code" value="500"/&gt;
            &lt;/header&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The SOAP response must be empty and the HTTP status code is set to a value other than 200, like 500. This results in an HTTP error sent to the calling client with error 500 "Internal server error".</p>
</div>
</div>
<div class="sect2">
<h3 id="soap-attachment"><a class="anchor" href="#soap-attachment"></a><a class="link" href="#soap-attachment">15.15. SOAP attachment support</a></h3>
<div class="paragraph">
<p>Citrus is able to add attachments to a SOAP request on client and server side. As usual you can validate the SOAP attachment content on a received SOAP message. The next chapters describe how to handle SOAP attachments in Citrus.</p>
</div>
</div>
<div class="sect2">
<h3 id="send-soap-attachments"><a class="anchor" href="#send-soap-attachments"></a><a class="link" href="#send-soap-attachments">15.16. Send SOAP attachments</a></h3>
<div class="paragraph">
<p>As client Citrus is able to add attachments to the SOAP message. I think it is best to go straight into an example in order to understand how it works.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapClientTest() {
    when(soap()
        .client(soapClient)
        .send()
            .message()
                .body("""
                &lt;SoapMessageWithAttachment xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                    &lt;Operation&gt;Read the attachment&lt;/Operation&gt;
                &lt;/SoapMessageWithAttachment&gt;
                """)
                .attachment("MySoapAttachment", "text/plain", Resources.of("classpath:org/citrusframework/ws/soapAttachment.txt"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapClientTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap client="soapClient"&gt;
        &lt;send-request&gt;
          &lt;message&gt;
            &lt;body&gt;
              &lt;payload&gt;
                &lt;SoapMessageWithAttachment xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                    &lt;Operation&gt;Read the attachment&lt;/Operation&gt;
                &lt;/SoapMessageWithAttachment&gt;
              &lt;/payload&gt;
            &lt;/body&gt;
            &lt;attachment content-id="MySoapAttachment" content-type="text/plain"&gt;
              &lt;resource file="classpath:org/citrusframework/ws/soapAttachment.txt"/&gt;
            &lt;/attachment&gt;
          &lt;/message&gt;
        &lt;/send-request&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapClientTest
actions:
  - soap:
      client: "soapClient"
      sendRequest:
        message:
          body:
            data: |
              &lt;SoapMessageWithAttachment xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                  &lt;Operation&gt;Read the attachment&lt;/Operation&gt;
              &lt;/SoapMessageWithAttachment&gt;
          attachments:
            - contentId: MySoapAttachment
              contentType: "text/plain"
              resource: "classpath:org/citrusframework/ws/soapAttachment.txt"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapClientTest"&gt;
    &lt;actions&gt;
        &lt;ws:send endpoint="soapClient"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                    &lt;SoapMessageWithAttachment xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                        &lt;Operation&gt;Read the attachment&lt;/Operation&gt;
                    &lt;/SoapMessageWithAttachment&gt;
                &lt;/payload&gt;
            &lt;/message&gt;
            &lt;ws:attachment content-id="MySoapAttachment" content-type="text/plain"&gt;
                &lt;ws:resource file="classpath:org/citrusframework/ws/soapAttachment.txt"/&gt;
            &lt;/ws:attachment&gt;
        &lt;/ws:send&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the previous chapters you may have already noticed the <strong>citrus-ws</strong> namespace that stands for the SOAP extensions in Citrus. Please include the <strong>citrus-ws</strong> namespace in your test case as described earlier in this chapter so you can use the attachment support.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The special send action of the SOAP extension namespace is aware of SOAP attachments. The attachment content usually consists of a <strong>content-id</strong>, a <strong>content-type</strong> and the actual content as plain text or binary content. Inside the test case you can use external file resources or inline CDATA sections for the attachment content. As you are familiar with Citrus you may know this already from other actions.</p>
</div>
<div class="paragraph">
<p>Citrus will construct a SOAP message with the SOAP attachment. Currently only one attachment per message is supported.</p>
</div>
</div>
<div class="sect2">
<h3 id="receive-soap-attachments"><a class="anchor" href="#receive-soap-attachments"></a><a class="link" href="#receive-soap-attachments">15.17. Receive SOAP attachments</a></h3>
<div class="paragraph">
<p>When Citrus calls SOAP WebServices as a client we may receive SOAP responses with attachments. The tester can validate those received SOAP messages with attachment content quite easy. As usual let us have a look at an example first.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapClientTest() {
    when(soap()
        .client(soapClient)
        .receive()
            .message()
                .body("""
                &lt;SoapMessageWithAttachment xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                    &lt;Operation&gt;Read the attachment&lt;/Operation&gt;
                &lt;/SoapMessageWithAttachment&gt;
                """)
                .attachment("MySoapAttachment", "text/plain", Resources.of("classpath:org/citrusframework/ws/soapAttachment.txt"))
                .attachmentValidator(mySoapAttachmentValidator)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapClientTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap client="soapClient"&gt;
        &lt;receive-response attachment-validator="mySoapAttachmentValidator"&gt;
          &lt;message&gt;
            &lt;body&gt;
              &lt;payload&gt;
                &lt;SoapMessageWithAttachment xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                    &lt;Operation&gt;Read the attachment&lt;/Operation&gt;
                &lt;/SoapMessageWithAttachment&gt;
              &lt;/payload&gt;
            &lt;/body&gt;
            &lt;attachment content-id="MySoapAttachment" content-type="text/plain"&gt;
              &lt;resource file="classpath:org/citrusframework/ws/soapAttachment.txt"/&gt;
            &lt;/attachment&gt;
          &lt;/message&gt;
        &lt;/receive-response&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapClientTest
actions:
  - soap:
      client: "soapClient"
      receiveResponse:
        validator: mySoapAttachmentValidator
        message:
          body:
            data: |
              &lt;SoapMessageWithAttachment xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                  &lt;Operation&gt;Read the attachment&lt;/Operation&gt;
              &lt;/SoapMessageWithAttachment&gt;
          attachments:
            - contentId: MySoapAttachment
              contentType: "text/plain"
              resource: "classpath:org/citrusframework/ws/soapAttachment.txt"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapClientTest"&gt;
    &lt;actions&gt;
        &lt;ws:receive endpoint="soapClient"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                    &lt;SoapMessageWithAttachmentRequest xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                        &lt;Operation&gt;Read the attachment&lt;/Operation&gt;
                    &lt;/SoapMessageWithAttachmentRequest&gt;
                &lt;/payload&gt;
            &lt;/message&gt;
            &lt;ws:attachment content-id="MySoapAttachment"
                              content-type="text/plain"
                              validator="mySoapAttachmentValidator"&gt;
                &lt;ws:resource file="classpath:org/citrusframework/ws/soapAttachment.txt"/&gt;
            &lt;/ws:attachment&gt;
        &lt;/ws:receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again we use the Citrus SOAP extension namespace with the specific receive action that is aware of SOAP attachment validation. The tester can validate the <strong>content-id</strong>, the <strong>content-type</strong> and the attachment content. Instead of using the external file resource you could also define an expected attachment template directly in the test case as inline CDATA section.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <strong>ws:attachment</strong> element specifies a validator instance. This validator determines how to validate the attachment content. SOAP attachments are not limited to XML content. Plain text content and binary content is possible, too. So each SOAP attachment validating action can use a different <strong><em>SoapAttachmentValidator</em></strong> instance which is responsible for validating and comparing received attachments to expected template attachments. In the Citrus configuration the validator is set as normal Spring bean with the respective identifier.
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public SimpleSoapAttachmentValidator soapAttachmentValidator() {
    return new SimpleSoapAttachmentValidator();
}

@BindToRegistry
public MySoapAttachmentValidator mySoapAttachmentValidator() {
    return new MySoapAttachmentValidator();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SimpleSoapAttachmentValidator soapAttachmentValidator() {
    return new SimpleSoapAttachmentValidator();
}

@Bean
public MySoapAttachmentValidator mySoapAttachmentValidator() {
    return new MySoapAttachmentValidator();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;

    &lt;bean id="soapAttachmentValidator" class="org.citrusframework.ws.validation.SimpleSoapAttachmentValidator"/&gt;
    &lt;bean id="mySoapAttachmentValidator" class="com.company.ws.validation.MySoapAttachmentValidator"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can define several validator instances in the Citrus configuration. The validator with the general id <strong>"soapAttachmentValidator"</strong> is the default validator for all actions that do not explicitly set a validator instance. Citrus offers a set of reference validator implementations. The <strong><em>SimpleSoapAttachmentValidator</em></strong> will use a simple plain text comparison. Of course you are able to add individual validator implementations, too.</p>
</div>
</div>
<div class="sect2">
<h3 id="soap-mtom"><a class="anchor" href="#soap-mtom"></a><a class="link" href="#soap-mtom">15.18. SOAP MTOM support</a></h3>
<div class="paragraph">
<p>MTOM (Message Transmission Optimization Mechanism) enables you to send and receive large SOAP message content using streamed data handlers. This optimizes the resource allocation on server and client side where not all data is loaded into memory when marshalling/unmarshalling the message payload data. In detail MTOM-enabled messages do have a XOP package inside the message payload replacing the actual large content data. The content is then streamed aas separate attachment. Server and client can operate with a data handler providing access to the streamed content. This is very helpful when using large binary content inside a SOAP message for instance.</p>
</div>
<div class="paragraph">
<p>Citrus is able to both send and receive MTOM enabled SOAP messages on client and server. Just use the <strong>mtom-enabled</strong> flag when sending a SOAP message:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapClientTest() {
    when(soap()
        .client(soapMtomClient)
        .send()
            .message()
                .mtomEnabled(true)
                .body("""
                &lt;image:addImage xmlns:image="http://citrusframework.org/imageService/"&gt;
                  &lt;image&gt;cid:IMAGE&lt;/image&gt;
                &lt;/image:addImage&gt;
                """)
                .attachment("IMAGE", "application/octet-stream", Resources.of("classpath:org/citrusframework/hugeImageData.png"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapClientTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap client="soapMtomClient"&gt;
        &lt;send-request&gt;
          &lt;message mtom-enabled="true"&gt;
            &lt;body&gt;
              &lt;payload&gt;
                &lt;image:addImage xmlns:image="http://citrusframework.org/imageService/"&gt;
                  &lt;image&gt;cid:IMAGE&lt;/image&gt;
                &lt;/image:addImage&gt;
              &lt;/payload&gt;
            &lt;/body&gt;
            &lt;attachment content-id="IMAGE" content-type="application/octet-stream"&gt;
              &lt;resource file="classpath:org/citrusframework/hugeImageData.png"/&gt;
            &lt;/attachment&gt;
          &lt;/message&gt;
        &lt;/send-request&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapClientTest
actions:
  - soap:
      client: "soapMtomClient"
      sendRequest:
        message:
          mtomEnabled: true
          body:
            data: |
              &lt;image:addImage xmlns:image="http://citrusframework.org/imageService/"&gt;
                &lt;image&gt;cid:IMAGE&lt;/image&gt;
              &lt;/image:addImage&gt;
          attachments:
            - contentId: IMAGE
              contentType: "application/octet-stream"
              resource: "classpath:org/citrusframework/hugeImageData.png"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapClientTest"&gt;
    &lt;actions&gt;
        &lt;ws:send endpoint="soapMtomClient" mtom-enabled="true"&gt;
          &lt;message&gt;
            &lt;data&gt;
              &lt;![CDATA[
                &lt;image:addImage xmlns:image="http://citrusframework.org/imageService/"&gt;
                  &lt;image&gt;cid:IMAGE&lt;/image&gt;
                &lt;/image:addImage&gt;
              ]]&gt;
            &lt;/data&gt;
          &lt;/message&gt;
          &lt;ws:attachment content-id="IMAGE" content-type="application/octet-stream"&gt;
            &lt;ws:resource file="classpath:org/citrusframework/hugeImageData.png"/&gt;
          &lt;/ws:attachment&gt;
        &lt;/ws:send&gt;
   &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the example above sends a SOAP message that contains a large binary image content. The actual binary image data is referenced with a content id marker <strong>cid:IMAGE</strong> inside the message payload. The actual image content is added as attachment with a separate file resource. Important is here the <strong>content-id</strong> which matches the id marker in the SOAP message payload (<strong>IMAGE</strong>).</p>
</div>
<div class="paragraph">
<p>Citrus builds a proper SOAP MTOM enabled message automatically adding the XOP package inside the message. The binary data is sent as separate SOAP attachment accordingly. The resulting SOAP message looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
  &lt;SOAP-ENV:Header&gt;&lt;/SOAP-ENV:Header&gt;
  &lt;SOAP-ENV:Body&gt;
    &lt;image:addImage xmlns:image="http://citrusframework.org/imageService/"&gt;
      &lt;image&gt;&lt;xop:Include xmlns:xop="http://www.w3.org/2004/08/xop/include" href="cid:IMAGE"/&gt;&lt;/image&gt;
    &lt;/image:addImage&gt;
  &lt;/SOAP-ENV:Body&gt;
&lt;/SOAP-ENV:Envelope&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the server side Citrus is also able to handle MTOM enabled SOAP messages. In a server receive action you can specify the MTOM SOAP attachment content as follows.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapServerTest() {
    when(soap()
        .server(soapMtomServer)
        .receive()
            .message()
                .schemaValidation(false)
                .mtomEnabled(true)
                .body("""
                &lt;image:addImage xmlns:image="http://citrusframework.org/imageService/"&gt;
                  &lt;image&gt;&lt;xop:Include xmlns:xop="http://www.w3.org/2004/08/xop/include" href="cid:IMAGE"/&gt;&lt;/image&gt;
                &lt;/image:addImage&gt;
                """)
                .attachment("IMAGE", "application/octet-stream", Resources.of("classpath:org/citrusframework/hugeImageData.png"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapServerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap server="soapMtomServer"&gt;
        &lt;receive-request&gt;
          &lt;message mtom-enabled="true" schema-validation="false"&gt;
            &lt;body&gt;
              &lt;payload&gt;
                &lt;image:addImage xmlns:image="http://citrusframework.org/imageService/"&gt;
                  &lt;image&gt;&lt;xop:Include xmlns:xop="http://www.w3.org/2004/08/xop/include" href="cid:IMAGE"/&gt;&lt;/image&gt;
                &lt;/image:addImage&gt;
              &lt;/payload&gt;
            &lt;/body&gt;
            &lt;attachment content-id="IMAGE" content-type="application/octet-stream"&gt;
              &lt;resource file="classpath:org/citrusframework/hugeImageData.png"/&gt;
            &lt;/attachment&gt;
          &lt;/message&gt;
        &lt;/send-request&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapServerTest
actions:
  - soap:
      server: "soapMtomServer"
      receiveRequest:
        message:
          schemaValidation: false
          mtomEnabled: true
          body:
            data: |
              &lt;image:addImage xmlns:image="http://citrusframework.org/imageService/"&gt;
                &lt;image&gt;&lt;xop:Include xmlns:xop="http://www.w3.org/2004/08/xop/include" href="cid:IMAGE"/&gt;&lt;/image&gt;
              &lt;/image:addImage&gt;
          attachments:
            - contentId: IMAGE
              contentType: "application/octet-stream"
              resource: "classpath:org/citrusframework/hugeImageData.png"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapServerTest"&gt;
    &lt;actions&gt;
        &lt;ws:receive endpoint="soapMtomServer" mtom-enabled="true"&gt;
          &lt;message schema-validation="false"&gt;
            &lt;data&gt;
              &lt;![CDATA[
                &lt;image:addImage xmlns:image="http://citrusframework.org/imageService/"&gt;
                  &lt;image&gt;&lt;xop:Include xmlns:xop="http://www.w3.org/2004/08/xop/include" href="cid:IMAGE"/&gt;&lt;/image&gt;
                &lt;/image:addImage&gt;
              ]]&gt;
            &lt;/data&gt;
          &lt;/message&gt;
          &lt;ws:attachment content-id="IMAGE" content-type="application/octet-stream"&gt;
            &lt;ws:resource file="classpath:org/citrusframework/hugeImageData.png"/&gt;
          &lt;/ws:attachment&gt;
        &lt;/ws:receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We define the MTOM attachment content as separate SOAP attachment. The <strong>content-id</strong> is referenced somewhere in the SOAP message payload data. At runtime Citrus will add the XOP package definition automatically and perform validation on the message and its streamed MTOM attachment data.</p>
</div>
<div class="paragraph">
<p>Next thing that we have to talk about is inline MTOM data. This means that the content should be added as either <strong>base64Binary</strong> or <strong>hexBinary</strong> encoded String data directly to the message content. See the following example that uses the <strong>mtom-inline</strong> setting:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapClientTest() {
    when(soap()
        .client(soapMtomClient)
        .send()
            .message()
                .mtomEnabled(true)
                .body("""
                &lt;image:addImage xmlns:image="http://citrusframework.org/imageService/"&gt;
                  &lt;image&gt;cid:IMAGE&lt;/image&gt;
                  &lt;icon&gt;cid:ICON&lt;/icon&gt;
                &lt;/image:addImage&gt;
                """)
                .attachment(image())
                .attachment(icon())
    );
}

private SoapAttachment image() {
    SoapAttachment attachment = new SoapAttachment("IMAGE", "application/octet-stream", Resources.of("classpath:org/citrusframework/hugeImageData.png"));
    attachment.setMtomInline(true);
    attachment.setEncodingType("base64Binary");
    return attachment;
}

private SoapAttachment icon() {
    SoapAttachment attachment = new SoapAttachment("ICON", "application/octet-stream", Resources.of("classpath:org/citrusframework/icon.ico"));
    attachment.setMtomInline(true);
    attachment.setEncodingType("hexBinary");
    return attachment;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapClientTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap client="soapMtomClient"&gt;
        &lt;send-request&gt;
          &lt;message mtom-enabled="true"&gt;
            &lt;body&gt;
              &lt;payload&gt;
                &lt;image:addImage xmlns:image="http://citrusframework.org/imageService/"&gt;
                  &lt;image&gt;cid:IMAGE&lt;/image&gt;
                &lt;/image:addImage&gt;
              &lt;/payload&gt;
            &lt;/body&gt;
            &lt;attachment content-id="IMAGE" content-type="application/octet-stream" mtom-inline="true" encoding-type="base64Binary"&gt;
              &lt;resource file="classpath:org/citrusframework/hugeImageData.png"/&gt;
            &lt;/attachment&gt;
            &lt;attachment content-id="ICON" content-type="application/octet-stream" mtom-inline="true" encoding-type="hexBinary"&gt;
              &lt;resource file="classpath:org/citrusframework/icon.ico"/&gt;
            &lt;/attachment&gt;
          &lt;/message&gt;
        &lt;/send-request&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapClientTest
actions:
  - soap:
      client: "soapMtomClient"
      sendRequest:
        message:
          mtomEnabled: true
          body:
            data: |
              &lt;image:addImage xmlns:image="http://citrusframework.org/imageService/"&gt;
                &lt;image&gt;cid:IMAGE&lt;/image&gt;
                &lt;icon&gt;cid:ICON&lt;/icon&gt;
              &lt;/image:addImage&gt;
          attachments:
            - contentId: IMAGE
              contentType: "application/octet-stream"
              mtomInline: true
              encodingType: base64Binary
              resource: "classpath:org/citrusframework/hugeImageData.png"
            - contentId: ICON
              contentType: "application/octet-stream"
              mtomInline: true
              encodingType: hexBinary
              resource: "classpath:org/citrusframework/icon.ico"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapClientTest"&gt;
    &lt;actions&gt;
        &lt;ws:send endpoint="soapMtomClient" mtom-enabled="true"&gt;
          &lt;message&gt;
            &lt;data&gt;
              &lt;![CDATA[
                &lt;image:addImage xmlns:image="http://citrusframework.org/imageService/"&gt;
                  &lt;image&gt;cid:IMAGE&lt;/image&gt;
                  &lt;icon&gt;cid:ICON&lt;/icon&gt;
                &lt;/image:addImage&gt;
              ]]&gt;
            &lt;/data&gt;
          &lt;/message&gt;
          &lt;ws:attachment content-id="IMAGE" content-type="application/octet-stream"
                    mtom-inline="true" encoding-type="base64Binary"&gt;
            &lt;ws:resource file="classpath:org/citrusframework/image.png"/&gt;
          &lt;/ws:attachment&gt;
          &lt;ws:attachment content-id="ICON" content-type="application/octet-stream"
                    mtom-inline="true" encoding-type="hexBinary"&gt;
            &lt;ws:resource file="classpath:org/citrusframework/icon.ico"/&gt;
          &lt;/ws:attachment&gt;
        &lt;/ws:send&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The listing above defines two inline MTOM attachments. The first attachment <strong>cid:IMAGE</strong> uses the encoding type <strong>base64Binary</strong> which is the default. The second attachment <strong>cid:ICON</strong> uses <strong>hexBinary</strong> encoding. Both attachments are added as inline data before the message is sent. The final SOAP message looks like follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
  &lt;SOAP-ENV:Header&gt;&lt;/SOAP-ENV:Header&gt;
  &lt;SOAP-ENV:Body&gt;
    &lt;image:addImage xmlns:image="http://citrusframework.org/imageService/"&gt;
      &lt;image&gt;VGhpcyBpcyBhIGJpbmFyeSBpbWFnZSBhdHRhY2htZW50IQpWYXJpYWJsZXMgJXt0ZXN0fSBzaG91bGQgbm90IGJlIHJlcGxhY2VkIQ==&lt;/image&gt;
      &lt;icon&gt;5468697320697320612062696E6172792069636F6E206174746163686D656E74210A5661726961626C657320257B746573747D2073686F756C64206E6F74206265207265706C6163656421&lt;/icon&gt;
    &lt;/image:addImage&gt;
  &lt;/SOAP-ENV:Body&gt;
&lt;/SOAP-ENV:Envelope&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The image content is a base64Binary String and the icon a hexBinary String. Of course this mechanism also is supported in receive actions on the server side where the expected message content is added as inline MTOM data before validation takes place.</p>
</div>
</div>
<div class="sect2">
<h3 id="soap-client-basic-authentication"><a class="anchor" href="#soap-client-basic-authentication"></a><a class="link" href="#soap-client-basic-authentication">15.19. SOAP client basic authentication</a></h3>
<div class="paragraph">
<p>As a SOAP client you may have to use basic authentication in order to access a server resource. Basic authentication via HTTP stands for username/password authentication where the credentials are transmitted in the HTTP request header section as base64 encoded entry. As Citrus uses the Spring WebService stack we can use the basic authentication support there. We set the user credentials on the HttpClient message sender which is used inside the Spring <strong><em>WebServiceTemplate</em></strong> .</p>
</div>
<div class="paragraph">
<p>Citrus provides a comfortable way to set the HTTP message sender with basic authentication credentials on the <strong><em>WebServiceTemplate</em></strong> . Just see the following example and learn how to do that.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebServiceClient soapClient() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8090/test")
            .messageSender(basicAuthClient())
            .build();
}

public HttpComponents5MessageSender basicAuthClient() {
    HttpComponents5MessageSender messageSender = new HttpComponents5MessageSender();
    messageSender.setAuthScope(new AuthScope("http", "localhost", 8090, null, "basic"));
    messageSender.setCredentials(new UsernamePasswordCredentials("someUsername", "somePassword"));
    return messageSender;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebServiceClient soapClient() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8090/test")
            .messageSender(basicAuthClient())
            .build();
}

public HttpComponents5MessageSender basicAuthClient() {
    HttpComponents5MessageSender messageSender = new HttpComponents5MessageSender();
    messageSender.setAuthScope(new AuthScope("http", "localhost", 8090, null, "basic"));
    messageSender.setCredentials(new UsernamePasswordCredentials("someUsername", "somePassword"));
    return messageSender;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.citrusframework.org/schema/config
       http://www.citrusframework.org/schema/config/citrus-config.xsd
       http://www.citrusframework.org/schema/ws/config
       http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;

    &lt;citrus-ws:client id="soapClient"
                      request-url="http://localhost:8090/test"
                      message-sender="basicAuthClient"/&gt;

    &lt;bean id="basicAuthClient" class="org.springframework.ws.transport.http.HttpComponents5MessageSender"&gt;
      &lt;property name="authScope"&gt;
          &lt;bean class="org.apache.hc.client5.http.auth.AuthScope"&gt;
            &lt;constructor-arg value="http"/&gt;
            &lt;constructor-arg value="localhost"/&gt;
            &lt;constructor-arg value="8090"/&gt;
            &lt;constructor-arg&gt;
              &lt;null/&gt;
            &lt;/constructor-arg&gt;
            &lt;constructor-arg value="basic"/&gt;
          &lt;/bean&gt;
      &lt;/property&gt;
      &lt;property name="credentials"&gt;
        &lt;bean class="org.apache.hc.client5.http.auth.UsernamePasswordCredentials"&gt;
            &lt;constructor-arg value="someUsername"/&gt;
            &lt;constructor-arg value="somePassword"/&gt;
        &lt;/bean&gt;
      &lt;/property&gt;
    &lt;/bean&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above configuration results in SOAP requests with authentication headers properly set for basic authentication.
The special message sender takes care of adding the proper basic authentication header to each request that is sent with this Citrus message sender.
By default, preemptive authentication is used. The message sender only sends a single request to the server with all authentication information set in the message header.
The request which determines the authentication scheme on the server is skipped.
This is why you have to add some auth scope so Citrus can set up an authentication cache within the HTTP context in order to have preemptive authentication.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can also skip the message sender configuration and set the <strong>Authorization</strong> header on each request in your send action definition on your own.
Be aware of setting the header as HTTP mime header using the correct prefix and take care of using the correct basic authentication with base64 encoding for the <strong>username:password</strong> phrase.
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">.header("citrus_http_Authorization", "Basic c29tZVVzZXJuYW1lOnNvbWVQYXNzd29yZA==")</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;headers&gt;
  &lt;header name="citrus_http_Authorization"
          value="Basic c29tZVVzZXJuYW1lOnNvbWVQYXNzd29yZA==" /&gt;
&lt;/headers&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">headers:
  - name: citrus_http_Authorization
    value: "Basic c29tZVVzZXJuYW1lOnNvbWVQYXNzd29yZA=="</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;header&gt;
    &lt;element name="citrus_http_Authorization" value="Basic c29tZVVzZXJuYW1lOnNvbWVQYXNzd29yZA=="/&gt;
&lt;/header&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For base64 encoding you can also use a Citrus function, see <a href="#functions-encode-base64">functions-encode-base64</a></p>
</div>
</div>
<div class="sect2">
<h3 id="soap-server-basic-authentication"><a class="anchor" href="#soap-server-basic-authentication"></a><a class="link" href="#soap-server-basic-authentication">15.20. SOAP server basic authentication</a></h3>
<div class="paragraph">
<p>When providing SOAP WebService server functionality Citrus can also set basic authentication so all clients need to authenticate properly when accessing the server resource.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebServiceServer soapServer() {
    return new WebServiceServerBuilder()
            .port(8080)
            .autoStart(true)
            .securityHandler(basicSecurityHandler())
            .build();
}

private SecurityHandlerFactory basicSecurityHandler() {
    SecurityHandlerFactory securityHandlerFactory = new SecurityHandlerFactory();
    securityHandlerFactory.setUsers(Collections.singletonList(new User("citrus", "secret", new String[] {"CitrusRole"})));
    securityHandlerFactory.setContraints(Collections.singletonMap("/foo/*", new BasicAuthConstraint("CitrusRole")));
    return securityHandlerFactory;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebServiceServer soapServer() {
    return new WebServiceServerBuilder()
            .port(8080)
            .autoStart(true)
            .securityHandler(basicSecurityHandler())
            .build();
}

private SecurityHandlerFactory basicSecurityHandler() {
    SecurityHandlerFactory securityHandlerFactory = new SecurityHandlerFactory();
    securityHandlerFactory.setUsers(Collections.singletonList(new User("citrus", "secret", new String[] {"CitrusRole"})));
    securityHandlerFactory.setContraints(Collections.singletonMap("/foo/*", new BasicAuthConstraint("CitrusRole")));
    return securityHandlerFactory;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.citrusframework.org/schema/config
       http://www.citrusframework.org/schema/config/citrus-config.xsd
       http://www.citrusframework.org/schema/ws/config
       http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;

    &lt;citrus-ws:server id="soapServer"
                 port="8080"
                 auto-start="true"
                 security-handler="basicSecurityHandler"/&gt;

    &lt;bean id="securityHandler" class="org.citrusframework.ws.security.SecurityHandlerFactory"&gt;
        &lt;property name="users"&gt;
            &lt;list&gt;
                &lt;bean class="org.citrusframework.ws.security.User"&gt;
                    &lt;property name="name" value="citrus"/&gt;
                    &lt;property name="password" value="secret"/&gt;
                    &lt;property name="roles" value="CitrusRole"/&gt;
                &lt;/bean&gt;
            &lt;/list&gt;
        &lt;/property&gt;
        &lt;property name="constraints"&gt;
            &lt;map&gt;
                &lt;entry key="/foo/*"&gt;
                    &lt;bean class="org.citrusframework.ws.security.BasicAuthConstraint"&gt;
                        &lt;constructor-arg value="CitrusRole"/&gt;
                    &lt;/bean&gt;
                &lt;/entry&gt;
            &lt;/map&gt;
        &lt;/property&gt;
    &lt;/bean&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have set a security handler on the server web container with a constraint on all resources with <code>/foo/*</code>. Following from that the server requires basic authentication for these resources. The granted users and roles are specified within the security handler bean definition. Connecting clients have to set the basic auth HTTP header properly using the correct user and role for accessing the Citrus server now.</p>
</div>
<div class="paragraph">
<p>You can customize the security handler for your very specific needs (e.g. load users and roles with JDBC from a database). Just have a look at the code base and inspect the settings and properties offered by the security handler interface.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This mechanism is not restricted to basic authentication only. With other settings you can also set up digest or form-based authentication constraints very easy.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ws-addressing"><a class="anchor" href="#ws-addressing"></a><a class="link" href="#ws-addressing">15.21. WS-Addressing support</a></h3>
<div class="paragraph">
<p>The web service stack offers a lot of different technologies and standards within the context of SOAP WebServices. We speak of WS-* specifications in particular. One of these specifications deals with addressing. On client side you may add wsa header information to the request in order to give the server instructions how to deal with SOAP faults for instance.</p>
</div>
<div class="paragraph">
<p>In Citrus WebService client you can add those header information using the common configuration like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebServiceClient soapClient() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8090/test")
            .messageConverter(wsAddressingMessageConverter())
            .build();
}

public WsAddressingMessageConverter wsAddressingMessageConverter() {
    WsAddressingHeaders wsAddressingHeaders = new WsAddressingHeaders();
    wsAddressingHeaders.setVersion(WsAddressingVersion.VERSION200408);
    wsAddressingHeaders.setAction("http://citrus.sample/sayHello");
    wsAddressingHeaders.setFrom("http://citrus.sample/client");
    wsAddressingHeaders.setTo("http://citrus.sample/server");
    wsAddressingHeaders.setFaultTo("http://citrus.sample/fault/resolver");

    return new WsAddressingMessageConverter(wsAddressingHeaders);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebServiceClient soapClient() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8090/test")
            .messageConverter(wsAddressingMessageConverter())
            .build();
}

public WsAddressingMessageConverter wsAddressingMessageConverter() {
    WsAddressingHeaders wsAddressingHeaders = new WsAddressingHeaders();
    wsAddressingHeaders.setVersion(WsAddressingVersion.VERSION200408);
    wsAddressingHeaders.setAction("http://citrus.sample/sayHello");
    wsAddressingHeaders.setFrom("http://citrus.sample/client");
    wsAddressingHeaders.setTo("http://citrus.sample/server");
    wsAddressingHeaders.setFaultTo("http://citrus.sample/fault/resolver");

    return new WsAddressingMessageConverter(wsAddressingHeaders);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.citrusframework.org/schema/config
       http://www.citrusframework.org/schema/config/citrus-config.xsd
       http://www.citrusframework.org/schema/ws/config
       http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;

    &lt;citrus-ws:client id="soapClient"
                     request-url="http://localhost:8090/test"
                     message-converter="wsAddressingMessageConverter"/&gt;

    &lt;bean id="wsAddressingMessageConverter" class="org.citrusframework.ws.message.converter.WsAddressingMessageConverter"&gt;
      &lt;constructor-arg&gt;
        &lt;bean id="wsAddressing200408" class="org.citrusframework.ws.addressing.WsAddressingHeaders"&gt;
            &lt;property name="version" value="VERSION200408"/&gt;
            &lt;property name="action" value="http://citrus.sample/sayHello"/&gt;
            &lt;property name="to" value="http://citrus.sample/server"/&gt;
            &lt;property name="from"&gt;
                &lt;bean class="org.springframework.ws.soap.addressing.core.EndpointReference"&gt;
                    &lt;constructor-arg value="http://citrus.sample/client"/&gt;
                &lt;/bean&gt;
            &lt;/property&gt;
            &lt;property name="replyTo"&gt;
                &lt;bean class="org.springframework.ws.soap.addressing.core.EndpointReference"&gt;
                    &lt;constructor-arg value="http://citrus.sample/client"/&gt;
                &lt;/bean&gt;
            &lt;/property&gt;
            &lt;property name="faultTo"&gt;
                &lt;bean class="org.springframework.ws.soap.addressing.core.EndpointReference"&gt;
                    &lt;constructor-arg value="http://citrus.sample/fault/resolver"/&gt;
                &lt;/bean&gt;
            &lt;/property&gt;
        &lt;/bean&gt;
      &lt;/constructor-arg&gt;
    &lt;/bean&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The WsAddressing header values will be used for all request messages that are sent with the soap client component <em>soapClient</em>. You can overwrite the WsAddressing
header in each send test action in your test though. Just set the special WsAddressing message header on your request. You can use the following message header names in
order to overwrite the default addressing headers specified in the message converter configuration (also see the class <em>org.citrusframework.ws.addressing.WsAddressingMessageHeaders</em>).</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
citrus_soap_ws_addressing_messageId
</td>
<td class="hdlist2">
<p>addressing message id as URI</p>
</td>
</tr>
<tr>
<td class="hdlist1">
citrus_soap_ws_addressing_from
</td>
<td class="hdlist2">
<p>addressing from endpoint reference as URI</p>
</td>
</tr>
<tr>
<td class="hdlist1">
citrus_soap_ws_addressing_to
</td>
<td class="hdlist2">
<p>addressing to URI</p>
</td>
</tr>
<tr>
<td class="hdlist1">
citrus_soap_ws_addressing_action
</td>
<td class="hdlist2">
<p>addressing action URI</p>
</td>
</tr>
<tr>
<td class="hdlist1">
citrus_soap_ws_addressing_replyTo
</td>
<td class="hdlist2">
<p>addressing reply to endpoint reference as URI</p>
</td>
</tr>
<tr>
<td class="hdlist1">
citrus_soap_ws_addressing_faultTo
</td>
<td class="hdlist2">
<p>addressing fault to endpoint reference as URI</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When using these message headers you are able to explicitly overwrite the WsAddressing headers. Test variables are supported of course when specifying the values. Most of the values
are parsed to a URI value at the end so please make sure to use correct URI String representations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The WS-Addressing specification knows several versions. Supported versions are:
</td>
</tr>
</table>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
VERSION10
</td>
<td class="hdlist2">
<p>WS-Addressing 1.0 May 2006</p>
</td>
</tr>
<tr>
<td class="hdlist1">
VERSION200408
</td>
<td class="hdlist2">
<p>August 2004 edition of the WS-Addressing specification</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The addressing headers find a place in the SOAP message header with respective namespaces and values. A possible SOAP request with WS addressing headers looks like follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
    &lt;SOAP-ENV:Header xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/08/addressing"&gt;
        &lt;wsa:To SOAP-ENV:mustUnderstand="1"&gt;http://citrus.sample/server&lt;/wsa:To&gt;
        &lt;wsa:From&gt;
            &lt;wsa:Address&gt;http://citrus.sample/client&lt;/wsa:Address&gt;
        &lt;/wsa:From&gt;
        &lt;wsa:ReplyTo&gt;
            &lt;wsa:Address&gt;http://citrus.sample/client&lt;/wsa:Address&gt;
        &lt;/wsa:ReplyTo&gt;
        &lt;wsa:FaultTo&gt;
            &lt;wsa:Address&gt;http://citrus.sample/fault/resolver&lt;/wsa:Address&gt;
        &lt;/wsa:FaultTo&gt;
        &lt;wsa:Action&gt;http://citrus.sample/sayHello&lt;/wsa:Action&gt;
        &lt;wsa:MessageID&gt;urn:uuid:4c4d8af2-b402-4bc0-a2e3-ad33b910e394&lt;/wsa:MessageID&gt;
    &lt;/SOAP-ENV:Header&gt;
    &lt;SOAP-ENV:Body&gt;
        &lt;cit:HelloRequest xmlns:cit="http://citrus/sample/sayHello"&gt;
            &lt;cit:Text&gt;Hello Citrus!&lt;/cit:Text&gt;
        &lt;/cit:HelloRequest&gt;
    &lt;/SOAP-ENV:Body&gt;
&lt;/SOAP-ENV:Envelope&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
By default, when not set explicitly on the message headers the WsAddressing message id property is automatically generated for each request. You can set the message id generation strategy in the Spring application context message converter configuration:
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public WsAddressingMessageConverter wsAddressingMessageConverter() {
    WsAddressingHeaders wsAddressingHeaders = new WsAddressingHeaders();
    wsAddressingHeaders.setVersion(WsAddressingVersion.VERSION200408);
    wsAddressingHeaders.setAction("http://citrus.sample/sayHello");
    wsAddressingHeaders.setFrom("http://citrus.sample/client");
    wsAddressingHeaders.setTo("http://citrus.sample/server");
    wsAddressingHeaders.setFaultTo("http://citrus.sample/fault/resolver");

    WsAddressingMessageConverter messageConverter = new WsAddressingMessageConverter(wsAddressingHeaders);
    messageConverter.setMessageIdStrategy(new UuidMessageIdStrategy());
    return messageConverter;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public WsAddressingMessageConverter wsAddressingMessageConverter() {
    WsAddressingHeaders wsAddressingHeaders = new WsAddressingHeaders();
    wsAddressingHeaders.setVersion(WsAddressingVersion.VERSION200408);
    wsAddressingHeaders.setAction("http://citrus.sample/sayHello");
    wsAddressingHeaders.setFrom("http://citrus.sample/client");
    wsAddressingHeaders.setTo("http://citrus.sample/server");
    wsAddressingHeaders.setFaultTo("http://citrus.sample/fault/resolver");

    WsAddressingMessageConverter messageConverter = new WsAddressingMessageConverter(wsAddressingHeaders);
    messageConverter.setMessageIdStrategy(new UuidMessageIdStrategy());
    return messageConverter;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="wsAddressingMessageConverter" class="org.citrusframework.ws.message.converter.WsAddressingMessageConverter"&gt;
  &lt;property name="messageIdStrategy"&gt;
    &lt;bean class="org.springframework.ws.soap.addressing.messageid.UuidMessageIdStrategy"/&gt;
  &lt;/property&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the strategy will create a new Java UUID for each request. The strategy also uses a common resource name prefix <em>urn:uuid:</em>. You can overwrite the message id
any time for each request explicitly by setting the message header <em>citrus_soap_ws_addressing_messageId</em> with a respective value on the message in your test.</p>
</div>
</div>
<div class="sect2">
<h3 id="soap-client-fork-mode"><a class="anchor" href="#soap-client-fork-mode"></a><a class="link" href="#soap-client-fork-mode">15.22. SOAP client fork mode</a></h3>
<div class="paragraph">
<p>SOAP over HTTP uses synchronous communication by nature. This means that sending a SOAP message in Citrus over HTTP will automatically block further test actions until the synchronous HTTP response has been received. In test cases this synchronous blocking might cause problems for several reasons. A simple reason would be that you need to do further test actions in parallel to the synchronous HTTP SOAP communication (e.g. simulate another backend system in the test case).</p>
</div>
<div class="paragraph">
<p>You can separate the SOAP send action from the rest of the test case by using the <strong>"fork"</strong> mode. The SOAP client will automatically open a new Java Thread for the synchronous communication and the test is able to continue with execution although the synchronous HTTP SOAP response has not arrived yet.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapClientTest() {
    when(soap()
        .client(soapClient)
        .send()
            .fork(true)
            .message()
                .body("""
                &lt;SoapRequest xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                  &lt;Operation&gt;Do something&lt;/Operation&gt;
                &lt;/SoapRequest&gt;
                """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapClientTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap client="soapClient"&gt;
        &lt;send-request fork="true"&gt;
          &lt;message&gt;
            &lt;body&gt;
              &lt;payload&gt;
                &lt;SoapRequest xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                  &lt;Operation&gt;Do something&lt;/Operation&gt;
                &lt;/SoapRequest&gt;
              &lt;/payload&gt;
            &lt;/body&gt;
          &lt;/message&gt;
        &lt;/send-request&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapClientTest
actions:
  - soap:
      client: "soapClient"
      sendRequest:
        fork: true
        message:
          body:
            data: |
              &lt;SoapRequest xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                &lt;Operation&gt;Do something&lt;/Operation&gt;
              &lt;/SoapRequest&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapClientTest"&gt;
    &lt;actions&gt;
      &lt;ws:send endpoint="soapClient" fork="true"&gt;
          &lt;message&gt;
            &lt;payload&gt;
                &lt;SoapRequest xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                  &lt;Operation&gt;Do something&lt;/Operation&gt;
                &lt;/SoapRequest&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
      &lt;/ws:send&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the <strong>"fork"</strong> mode enabled the test continues with execution while the sending action waits for the synchronous response in a separate Java Thread. You could reach the same behaviour with a complex &lt;parallel&gt;/&lt;sequential&gt; container construct, but forking the send action is much more straight forward.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is highly recommended to use a proper <strong>"timeout"</strong> setting on the SOAP receive action when using fork mode. The forked send operation might take some time and the corresponding receive action might run into failure as the response was has not been received yet. The result would be a broken test because of the missing response message. A proper <strong>"timeout"</strong> setting for the receive action solves this problem as the action waits for this time period and occasionally repeatedly asks for the SOAP response message. The following listing sets the receive timeout to 10 seconds, so the action waits for the forked send action to deliver the SOAP response in time.
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void soapClientTest() {
    when(soap()
        .client(soapClient)
        .receive()
            .timeout(10000L)
            .message()
                .body("""
                &lt;SoapResponse xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                  &lt;Operation&gt;Did something&lt;/Operation&gt;
                  &lt;Success&gt;true&lt;/Success&gt;
                &lt;/SoapResponse&gt;
                """)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SoapClientTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;soap client="soapClient"&gt;
        &lt;receive-response timeout="10000"&gt;
          &lt;message&gt;
            &lt;body&gt;
              &lt;payload&gt;
                &lt;SoapResponse xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                  &lt;Operation&gt;Did something&lt;/Operation&gt;
                  &lt;Success&gt;true&lt;/Success&gt;
                &lt;/SoapResponse&gt;
              &lt;/payload&gt;
            &lt;/body&gt;
          &lt;/message&gt;
        &lt;/send-request&gt;
      &lt;/soap&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SoapClientTest
actions:
  - soap:
      client: "soapClient"
      receiveResponse:
        timeout: 10000
        message:
          body:
            data: |
              &lt;SoapResponse xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                &lt;Operation&gt;Did something&lt;/Operation&gt;
                &lt;Success&gt;true&lt;/Success&gt;
              &lt;/SoapResponse&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ws="http://www.citrusframework.org/schema/ws/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/ws/testcase
          http://www.citrusframework.org/schema/ws/testcase/citrus-ws-testcase.xsd"&gt;

  &lt;testcase name="soapClientTest"&gt;
    &lt;actions&gt;
        &lt;ws:receive endpoint="soapClient" timeout="10000"&gt;
          &lt;message&gt;
            &lt;payload&gt;
                &lt;SoapResponse xmlns="http://citrusframework.org/schemas/sample.xsd"&gt;
                  &lt;Operation&gt;Did something&lt;/Operation&gt;
                  &lt;Success&gt;true&lt;/Success&gt;
                &lt;/SoapResponse&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/ws:receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="soap-servlet-context-customization"><a class="anchor" href="#soap-servlet-context-customization"></a><a class="link" href="#soap-servlet-context-customization">15.23. SOAP servlet context customization</a></h3>
<div class="paragraph">
<p>For highly customized SOAP server components in Citrus you can define a full servlet context configuration file. Here you have the full power to add Spring endpoint mappings and custom endpoint implementations. You can set the custom servlet context as external file resource on the server component:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebServiceServer soapServer() {
    return new WebServiceServerBuilder()
            .contextConfigLocation("classpath:citrus-ws-servlet.xml")
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebServiceServer soapServer() {
    return new WebServiceServerBuilder()
            .contextConfigLocation("classpath:citrus-ws-servlet.xml")
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.citrusframework.org/schema/config
       http://www.citrusframework.org/schema/config/citrus-config.xsd
       http://www.citrusframework.org/schema/ws/config
       http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;

    &lt;citrus-ws:server id="soapServer"
          context-config-location="classpath:citrus-ws-servlet.xml"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let us have a closer look at the context-config-location attribute. This configuration defines the Spring application context file for endpoints, request mappings and other SpringWS specific information. Please see the official SpringWS documentation for details on this Spring based configuration. You can also just copy the following example application context which should work for you in general.</p>
</div>
<div class="listingblock">
<div class="title">citrus-ws-servlet.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;

  &lt;bean id="loggingInterceptor"
    class="org.springframework.ws.server.endpoint.interceptor.PayloadLoggingInterceptor"&gt;
      &lt;description&gt;
          This interceptor logs the message payload.
      &lt;/description&gt;
  &lt;/bean&gt;

  &lt;bean id="helloServicePayloadMapping"
    class="org.springframework.ws.server.endpoint.mapping.PayloadRootQNameEndpointMapping"&gt;
      &lt;property name="mappings"&gt;
          &lt;props&gt;
              &lt;prop
                  key="{http://citrusframework.org/schemas/sayHello}HelloRequest"&gt;
                  helloServiceEndpoint
              &lt;/prop&gt;
          &lt;/props&gt;
      &lt;/property&gt;
      &lt;property name="interceptors"&gt;
          &lt;list&gt;
              &lt;ref bean="loggingInterceptor"/&gt;
          &lt;/list&gt;
      &lt;/property&gt;
  &lt;/bean&gt;

  &lt;bean id="helloServiceEndpoint" class="org.citrusframework.ws.server.WebServiceEndpoint"&gt;
      &lt;property name="endpointAdapter" ref="staticResponseEndpointAdapter"/&gt;
  &lt;/bean&gt;

  &lt;citrus:static-response-adapter id="staticResponseEndpointAdapter"&gt;
      &lt;citrus:payload&gt;
          &lt;![CDATA[
              &lt;HelloResponse xmlns="http://citrusframework.org/schemas/sayHello"&gt;
                  &lt;MessageId&gt;123456789&lt;/MessageId&gt;
                  &lt;CorrelationId&gt;CORR123456789&lt;/CorrelationId&gt;
                  &lt;User&gt;WebServer&lt;/User&gt;
                  &lt;Text&gt;Hello User&lt;/Text&gt;
              &lt;/HelloResponse&gt;
          ]]&gt;
      &lt;/citrus:payload&gt;
      &lt;citrus:header&gt;
          &lt;citrus:element name="{http://citrusframework.org/schemas/samples/sayHello.xsd}ns0:Operation"
                  value="sayHelloResponse"/&gt;
          &lt;citrus:element name="{http://citrusframework.org/schemas/samples/sayHello.xsd}ns0:Request"
                  value="HelloRequest"/&gt;
          &lt;citrus:element name="citrus_soap_action"
                  value="sayHello"/&gt;
      &lt;/citrus:header&gt;
  &lt;/citrus:static-response-adapter&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The program listing above describes a normal SpringWS request mapping with endpoint configurations. The mapping is responsible to forward incoming requests to the endpoint which will handle the request and provide a proper response message. First of all we add a logging interceptor to the context so all incoming requests get logged to the console first. Then we use a payload mapping (PayloadRootQNameEndpointMapping) in order to map all incoming <strong><em>'HelloRequest'</em></strong> SOAP messages to the <strong><em>'helloServiceEndpoint'</em></strong> . Endpoints are of essential nature in Citrus SOAP WebServices implementation. They are responsible for processing a request in order to provide a proper response message that is sent back to the calling client. Citrus uses the endpoint in combination with a message endpoint adapter implementation.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/figure_009.jpg" alt="figure_009.jpg"></span></p>
</div>
<div class="paragraph">
<p>The endpoint works together with the message endpoint adapter that is responsible for providing a response message for the client. The various message endpoint adapter implementations in Citrus were already discussed in <a href="#endpoint-adapter">endpoint-adapter</a>.</p>
</div>
<div class="paragraph">
<p>In this example the <strong><em>'helloServiceEndpoint'</em></strong> uses the <strong><em>'static-response-adapter'</em></strong> which is always returning a static response message. In most cases static responses will not fit the test scenario and you will have to respond more dynamically.</p>
</div>
<div class="paragraph">
<p>Regardless of which message endpoint adapter setup you are using in your test case the endpoint transforms the response into a proper SOAP message. You can add as many request mappings and endpoints as you want to the server context configuration. So you are able to handle different request types with one single Jetty server instance.</p>
</div>
<div class="paragraph">
<p>That&#8217;s it for connecting with SOAP WebServices! We saw how to send and receive SOAP messages with Jetty and Spring WebServices. Have a look at the samples coming with your Citrus archive in order to learn more about the SOAP message handling.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="apache-camel"><a class="anchor" href="#apache-camel"></a><a class="link" href="#apache-camel">16. Apache Camel support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://camel.apache.org">Apache Camel</a> is a fantastic Open Source integration framework that empowers you to quickly
and easily integrate various systems consuming or producing data.</p>
</div>
<div class="paragraph">
<p>Camel implements the enterprise integration patterns for building mediation and routing rules in your software.
With the Camel support in Citrus you are able to directly interact with the 300+ Camel components through route definitions.
You can call Camel routes and receive synchronous response messages from a Citrus test.
You can also simulate the Camel route endpoint with receiving messages and providing simulated response messages.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The camel components in Citrus are located in a separate Maven module.
So you should add the module as Maven dependency to your project accordingly.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-camel&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For XML configurations Citrus provides a special Camel configuration schema that is used in Spring configuration files.
You have to include the <code>citrus-camel</code> namespace in your Spring configuration XML files as follows.</p>
</div>
<div class="listingblock">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:citrus="http://www.citrusframework.org/schema/config"
      xmlns:citrus-camel="http://www.citrusframework.org/schema/camel/config"
      xsi:schemaLocation="
          http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/config
          http://www.citrusframework.org/schema/config/citrus-config.xsd
          http://www.citrusframework.org/schema/camel/config
          http://www.citrusframework.org/schema/camel/config/citrus-camel-config.xsd"&gt;

      [...]

      &lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you are ready to use the Camel configuration elements using the citrus-camel namespace prefix.</p>
</div>
<div class="paragraph">
<p>The next sections explain the Citrus capabilities while working with Apache Camel.</p>
</div>
<div class="sect2">
<h3 id="camel-endpoint"><a class="anchor" href="#camel-endpoint"></a><a class="link" href="#camel-endpoint">16.1. Camel endpoint</a></h3>
<div class="paragraph">
<p>Camel and Citrus both use the endpoint pattern in order to define message destinations.
Users can interact with these endpoints when creating the mediation and routing logic.
The Citrus endpoint component for Camel interaction is defined as follows in your Citrus Spring configuration.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public CamelEndpoint helloCamelEndpoint() {
    return new CamelEndpointBuilder()
        .endpointUri("direct:hello")
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-camel:endpoint id="helloCamelEndpoint"
      endpoint-uri="direct:hello"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The endpoint defines an endpoint uri that will be called when messages are sent/received using the endpoint producer or consumer.
The endpoint uri refers to a Camel route that is located inside a Camel context.
The Camel route should use the respective endpoint uri as <code>from</code> definition.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public CamelContext camelContext() {
    CamelContext context = new DefaultCamelContext();

    context.addRoutes(new RouteBuilder() {
        @Override
        public void configure() throws Exception {
            from("direct:hello")
                .routeId("helloRoute")
                .to("log:org.citrusframework.camel?level=INFO")
                .to("seda:greetings");
        }
    });

    return context;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;camelContext id="camelContext" xmlns="http://camel.apache.org/schema/spring"&gt;
  &lt;route id="helloRoute"&gt;
    &lt;from uri="direct:hello"/&gt;
    &lt;to uri="log:org.citrusframework.camel?level=INFO"/&gt;
    &lt;to uri="seda:greetings-feed"/&gt;
  &lt;/route&gt;
&lt;/camelContext&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above the Camel context is placed as Spring bean.
The context defines a Camel route the Citrus test case can interact with.</p>
</div>
<div class="paragraph">
<p>The Camel context is automatically referenced in the Citrus Camel endpoint.
This is because Citrus will automatically look for a Camel context in the Spring bean configuration.</p>
</div>
<div class="paragraph">
<p>In case you have multiple Camel context instances in your configuration you can explicitly link the endpoint to a
context with <code>camel-context=&quot;camelContext&quot;</code>.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public CamelEndpoint helloCamelEndpoint() {
    return new CamelEndpointBuilder()
        .camelContext(specialCamelContext)
        .endpointUri("direct:hello")
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-camel:endpoint id="helloCamelEndpoint"
      camel-contxt="specialCamelContext"
      endpoint-uri="direct:hello"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This explicitly binds the endpoint to the context named "<em>specialCamelContext</em>".
This configuration would be the easiest setup to use Camel with Citrus as you can add the Camel context straight to the
Spring bean application context and interact with it in Citrus.
Of course, you can also import your Camel context and routes from other Spring bean context files,
or you can start the Camel context routes with Java code.</p>
</div>
<div class="paragraph">
<p>In the example the Camel route is listening on the route endpoint uri <code>direct:hello</code>.
Incoming messages will be logged to the console using a <code>log</code> Camel component.
After that the message is forwarded to a <code>seda</code> Camel component which is a simple queue in memory.</p>
</div>
<div class="paragraph">
<p>The Citrus endpoint can interact with this sample route definition sending messages to the <code>direct:hello</code> endpoint.
The endpoint configuration holds the endpoint uri information that tells Citrus how to access the Camel route.
This endpoint uri can be any Camel endpoint uri that is used in a Camel route.</p>
</div>
<div class="paragraph">
<p>The Camel routes support asynchronous and synchronous message communication patterns.
By default, Citrus uses asynchronous communication with Camel routes.
This means that the Citrus producer sends the exchange message to the route endpoint uri and is finished immediately.
There is no synchronous response to await.
In contrary to that the synchronous endpoint will send and receive a synchronous message on the Camel destination route.
This message exchange pattern is discussed in a later section in this chapter.</p>
</div>
<div class="paragraph">
<p>For now, we have a look on how to use the Citrus Camel endpoint in a test case in order to send a message to the Camel route:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">send(helloCamelEndpoint)
    .message()
    .body("Hello from Citrus!");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;send endpoint="helloCamelEndpoint"&gt;
  &lt;message type="plaintext"&gt;
    &lt;payload&gt;Hello from Citrus!&lt;/payload&gt;
  &lt;/message&gt;
&lt;/send&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the very same Citrus Camel endpoint component to receive messages in your test case, too.
In this situation you would receive a message from the route endpoint.
This is especially designed for queueing endpoint routes such as the Camel seda component.
In our example Camel route above the seda Camel component is called with the endpoint uri <strong>seda:greetings-feed</strong>.</p>
</div>
<div class="paragraph">
<p>This means that the Camel route is sending a message to the <code>seda</code> component.
Citrus is able to receive this route message with an endpoint component like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public CamelEndpoint greetingsFeed() {
    return new CamelEndpointBuilder()
        .endpointUri("seda:greetings-feed")
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-camel:endpoint id="greetingsFeed"
    endpoint-uri="seda:greetings-feed"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the Citrus camel endpoint in your test case receive action in order to consume the message on the seda component.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(greetingsFeed)
    .message()
    .type(MessageType.PLAINTEXT)
    .body("Hello from Citrus!");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="greetingsFeed"&gt;
  &lt;message type="plaintext"&gt;
    &lt;payload&gt;Hello from Citrus!&lt;/payload&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Instead of defining a static Citrus camel component you could also use the dynamic endpoint components in Citrus.
This would enable you to send your message directly using the endpoint uri <strong>direct:news</strong> in your test case.
Read more about this in <a href="#dynamic-endpoint-components">dynamic-endpoint-components</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Citrus is able to send and receive messages with Camel route endpoint uri.
This enables you to invoke a Camel route.
The Camel components used is defined by the endpoint uri as usual.
When interacting with Camel routes you might need to send back some response messages in order to simulate boundary applications.
We will discuss the synchronous communication in the next section.</p>
</div>
</div>
<div class="sect2">
<h3 id="synchronous-camel-endpoint"><a class="anchor" href="#synchronous-camel-endpoint"></a><a class="link" href="#synchronous-camel-endpoint">16.2. Synchronous Camel endpoint</a></h3>
<div class="paragraph">
<p>The synchronous Camel producer sends a message to a route and waits synchronously for the response to arrive.
In Camel this communication is represented with the exchange pattern <strong>InOut</strong>.
The basic configuration for a synchronous Camel endpoint component looks like follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public CamelSyncEndpoint helloCamelEndpoint() {
    return new CamelSyncEndpointBuilder()
        .endpointUri("direct:hello")
        .timeout(1000L)
        .pollingInterval(300L)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-camel:sync-endpoint id="helloCamelEndpoint"
      endpoint-uri="direct:hello"
      timeout="1000"
      polling-interval="300"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Synchronous endpoints poll for synchronous reply messages to arrive.
The poll interval is an optional setting in order to manage the amount of reply message handshake attempts.
Once the endpoint was able to receive the reply message synchronously the test case can receive the reply.
In case the reply message is not available in time we raise some timeout error and the test will fail.</p>
</div>
<div class="paragraph">
<p>In a first test scenario we write a test case that sends a message to the synchronous endpoint and waits for the synchronous
reply message to arrive.
So we have two actions on the same Citrus endpoint, first send then receive.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">send(helloCamelEndpoint)
    .message()
    .type(MessageType.PLAINTEXT)
    .body("Hello from Citrus!");

receive(helloCamelEndpoint)
    .message()
    .type(MessageType.PLAINTEXT)
    .body("This is the reply from Apache Camel!");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;send endpoint="helloCamelEndpoint"&gt;
  &lt;message type="plaintext"&gt;
    &lt;payload&gt;Hello from Citrus!&lt;/payload&gt;
  &lt;/message&gt;
&lt;/send&gt;

&lt;receive endpoint="helloCamelEndpoint"&gt;
  &lt;message type="plaintext"&gt;
    &lt;payload&gt;This is the reply from Apache Camel!&lt;/payload&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next variation deals with the same synchronous communication, but send and receive roles are switched.
Now Citrus receives a message from a Camel route and has to provide a reply message.
We handle this synchronous communication with the same synchronous Apache Camel endpoint component.
Only difference is that we initially start the communication by receiving a message from the endpoint.
Knowing this Citrus is able to send a synchronous response back.
Again just use the same endpoint reference in your test case.
So we have again two actions in our test case, but this time first receive then send.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(helloCamelEndpoint)
    .message()
    .type(MessageType.PLAINTEXT)
    .body("Hello from Apache Camel!");

send(helloCamelEndpoint)
    .message()
    .type(MessageType.PLAINTEXT)
    .body("This is the reply from Citrus!");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="helloCamelEndpoint"&gt;
  &lt;message type="plaintext"&gt;
    &lt;payload&gt;Hello from Apache Camel!&lt;/payload&gt;
  &lt;/message&gt;
&lt;/receive&gt;

&lt;send endpoint="helloCamelEndpoint"&gt;
  &lt;message type="plaintext"&gt;
    &lt;payload&gt;This is the reply from Citrus!&lt;/payload&gt;
  &lt;/message&gt;
&lt;/send&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is pretty simple. Citrus takes care of setting the Camel exchange pattern <strong>InOut</strong> while using synchronous communications.
The Camel routes do respond and Citrus is able to receive the synchronous messages accordingly.
With this pattern you can interact with Camel routes where Citrus simulates synchronous clients and consumers.</p>
</div>
</div>
<div class="sect2">
<h3 id="camel-exchange-headers"><a class="anchor" href="#camel-exchange-headers"></a><a class="link" href="#camel-exchange-headers">16.3. Camel exchange headers</a></h3>
<div class="paragraph">
<p>Camel uses exchanges when sending and receiving messages to and from routes.
These exchanges hold specific information on the communication outcome.
Citrus automatically converts these exchange information to special message header entries.
You can validate those exchange headers then easily in your test case:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(greetingsFeed)
    .message()
    .type(MessageType.PLAINTEXT)
    .body("Hello from Camel!")
    .header("citrus_camel_route_id", "greetings")
    .header("citrus_camel_exchange_id", "ID-local-50532-1402653725341-0-3")
    .header("citrus_camel_exchange_failed", false)
    .header("citrus_camel_exchange_pattern", "InOnly")
    .header("CamelCorrelationId", "ID-local-50532-1402653725341-0-1")
    .header("CamelToEndpoint", "seda://greetings-feed");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="greetingsFeed"&gt;
  &lt;message type="plaintext"&gt;
    &lt;payload&gt;Hello from Camel!&lt;/payload&gt;
  &lt;/message&gt;
  &lt;header&gt;
    &lt;element name="citrus_camel_route_id" value="greetings"/&gt;
    &lt;element name="citrus_camel_exchange_id" value="ID-local-50532-1402653725341-0-3"/&gt;
    &lt;element name="citrus_camel_exchange_failed" value="false"/&gt;
    &lt;element name="citrus_camel_exchange_pattern" value="InOnly"/&gt;
    &lt;element name="CamelCorrelationId" value="ID-local-50532-1402653725341-0-1"/&gt;
    &lt;element name="CamelToEndpoint" value="seda://greetings-feed"/&gt;
  &lt;/header&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to the Camel specific exchange information the Camel exchange does also hold some custom properties.
These properties such as <strong>CamelToEndpoint</strong> or <strong>CamelCorrelationId</strong> are also added automatically to the Citrus message header so can expect them in a <code>receive</code> message action.</p>
</div>
</div>
<div class="sect2">
<h3 id="camel-exception-handling"><a class="anchor" href="#camel-exception-handling"></a><a class="link" href="#camel-exception-handling">16.4. Camel exception handling</a></h3>
<div class="paragraph">
<p>Let us suppose the following route definition:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public CamelContext camelContext() {
    CamelContext context = new DefaultCamelContext();

    context.addRoutes(new RouteBuilder() {
        @Override
        public void configure() throws Exception {
            from("direct:hello")
                .routeId("helloRoute")
                .to("log:org.citrusframework.camel?level=INFO")
                .to("seda:greetings-feed")
                .onException(CitrusRuntimeException.class)
                    .to("seda:exceptions");
        }
    });

    return context;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;camelContext id="camelContext" xmlns="http://camel.apache.org/schema/spring"&gt;
  &lt;route id="helloRoute"&gt;
    &lt;from uri="direct:hello"/&gt;
    &lt;to uri="log:org.citrusframework.camel?level=INFO"/&gt;
    &lt;to uri="seda:greetings-feed"/&gt;
    &lt;onException&gt;
      &lt;exception&gt;org.citrusframework.exceptions.CitrusRuntimeException&lt;/exception&gt;
      &lt;to uri="seda:exceptions"/&gt;
    &lt;/onException&gt;
  &lt;/route&gt;
&lt;/camelContext&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The route has an exception handling block defined that is called as soon as the exchange processing ends up in some error or exception.
With Citrus you can also simulate an exchange exception when sending back a synchronous response to a calling route.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">send(helloCamelEndpoint)
    .message()
    .type(MessageType.PLAINTEXT)
    .body("Something went wrong!")
    .header("citrus_camel_exchange_exception", CitrusRuntimeException.class)
    .header("citrus_camel_exchange_exception_message", "Something went wrong!")
    .header("citrus_camel_exchange_failed", true);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;send endpoint="greetingsFeed"&gt;
  &lt;message type="plaintext"&gt;
    &lt;payload&gt;Something went wrong!&lt;/payload&gt;
  &lt;/message&gt;
  &lt;header&gt;
    &lt;element name="citrus_camel_exchange_exception"
                value="org.citrusframework.exceptions.CitrusRuntimeException"/&gt;
    &lt;element name="citrus_camel_exchange_exception_message" value="Something went wrong!"/&gt;
    &lt;element name="citrus_camel_exchange_failed" value="true"/&gt;
  &lt;/header&gt;
&lt;/send&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This message as response to the <strong>seda:greetings-feed</strong> route would cause Camel to enter the exception handling in the route definition.
The exception handling is activated and calls the error handling route endpoint <strong>seda:exceptions</strong> .
Of course Citrus would be able to receive such an exception exchange validating the exception handling outcome.</p>
</div>
<div class="paragraph">
<p>In such failure scenarios the Camel exchange holds the exception information (<strong>CamelExceptionCaught</strong>) such as causing exception class and error message.
These headers are present in an error scenario and can be validated in Citrus when receiving error messages as follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(errorCamelEndpoint)
    .message()
    .type(MessageType.PLAINTEXT)
    .body("Something went wrong!")
    .header("citrus_camel_route_id", "helloRoute")
    .header("citrus_camel_exchange_failed", true)
    .header("CamelExceptionCaught", "org.citrusframework.exceptions.CitrusRuntimeException: Something went wrong!");</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="errorCamelEndpoint"&gt;
  &lt;message type="plaintext"&gt;
    &lt;payload&gt;Something went wrong!&lt;/payload&gt;
  &lt;/message&gt;
  &lt;header&gt;
    &lt;element name="citrus_camel_route_id" value="helloRoute"/&gt;
    &lt;element name="citrus_camel_exchange_failed" value="true"/&gt;
    &lt;element name="CamelExceptionCaught"
        value="org.citrusframework.exceptions.CitrusRuntimeException: Something went wrong!"/&gt;
  &lt;/header&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This completes the basic exception handling in Citrus when using the Camel endpoints.</p>
</div>
</div>
<div class="sect2">
<h3 id="camel-context-handling"><a class="anchor" href="#camel-context-handling"></a><a class="link" href="#camel-context-handling">16.5. Camel context handling</a></h3>
<div class="paragraph">
<p>In the previous samples we have used the Camel context as Spring bean context that is automatically loaded when Citrus starts up.
Now when using a single Camel context instance Citrus is able to automatically pick this Camel context for route interaction.
If you use more than one Camel context you have to tell the Citrus endpoint component which context to use.
The endpoint offers an optional attribute called <code>camel-context</code>.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public CamelEndpoint newsCamelEndpoint() {
    return new CamelEndpointBuilder()
        .camelContext(newsContext())
        .endpointUri("direct:news")
        .build();
}

@Bean
public CamelContext newsContext() {
    CamelContext context = new DefaultCamelContext();

    context.addRoutes(new RouteBuilder() {
        @Override
        public void configure() throws Exception {
            from("direct:news")
                .routeId("newsRoute")
                .to("log:org.citrusframework.camel?level=INFO")
                .to("seda:news-feed");
        }
    });

    return context;
}

@Bean
public CamelContext helloContext() {
    CamelContext context = new DefaultCamelContext();

    context.addRoutes(new RouteBuilder() {
        @Override
        public void configure() throws Exception {
            from("direct:hello")
                .routeId("helloRoute")
                .to("log:org.citrusframework.camel?level=INFO")
                .to("seda:greetings");
        }
    });

    return context;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-camel:endpoint id="newsCamelEndpoint"
    camel-context="newsContext"
    endpoint-uri="direct:news"/&gt;

&lt;camelContext id="newsContext" xmlns="http://camel.apache.org/schema/spring"&gt;
    &lt;route id="newsRoute"&gt;
      &lt;from uri="direct:news"/&gt;
      &lt;to uri="log:org.citrusframework.camel?level=INFO"/&gt;
      &lt;to uri="seda:news-feed"/&gt;
    &lt;/route&gt;
&lt;/camelContext&gt;

&lt;camelContext id="helloContext" xmlns="http://camel.apache.org/schema/spring"&gt;
  &lt;route id="helloRoute"&gt;
    &lt;from uri="direct:hello"/&gt;
    &lt;to uri="log:org.citrusframework.camel?level=INFO"/&gt;
    &lt;to uri="seda:greetings"/&gt;
  &lt;/route&gt;
&lt;/camelContext&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above we have two Camel context instances loaded.
The endpoint has to pick the context to use with the attribute <strong>camel-context</strong> which resides to the Spring bean id of the Camel context.</p>
</div>
</div>
<div class="sect2">
<h3 id="camel-route-actions"><a class="anchor" href="#camel-route-actions"></a><a class="link" href="#camel-route-actions">16.6. Camel route actions</a></h3>
<div class="paragraph">
<p>Since Citrus 2.4 we introduced some Camel specific test actions that enable easy interaction with Camel routes and the Camel context.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In XML the Camel route test actions do follow a specific XML namespace.
This means you have to add this namespace to the test case when using the actions.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:camel="http://www.citrusframework.org/schema/camel/testcase"
      xsi:schemaLocation="
          http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/camel/testcase
          http://www.citrusframework.org/schema/camel/testcase/citrus-camel-testcase.xsd"&gt;

  [...]

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have added the special Camel namespace with prefix <code>camel</code> you are ready to start using the Camel test actions in your test case.</p>
</div>
<div class="sect3">
<h4 id="create-camel-routes"><a class="anchor" href="#create-camel-routes"></a><a class="link" href="#create-camel-routes">Create Camel routes</a></h4>
<div class="paragraph">
<p>You can create a new Camel route as part of the test using this test action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelRouteActionIT extends TestNGCitrusSpringSupport {

    @Autowired
    private CamelContext camelContext;

    @Test
    @CitrusTest
    public void createCamelRoute() {
        $(camel().camelContext(camelContext)
            .route()
            .create(new RouteBuilder() {
                @Override
                public void configure() throws Exception {
                    from("direct:messages")
                        .routeId("message-tokenizer")
                        .split().tokenize(" ")
                        .to("seda:words");
                }
            }));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="CamelRouteIT"&gt;
  &lt;actions&gt;
      &lt;camel:create-routes&gt;
        &lt;routeContext xmlns="http://camel.apache.org/schema/spring"&gt;
          &lt;route id="message-tokenizer"&gt;
            &lt;from uri="direct:messages"/&gt;
            &lt;split&gt;
              &lt;tokenize token=" "/&gt;
              &lt;to uri="seda:words"/&gt;
            &lt;/split&gt;
          &lt;/route&gt;
        &lt;/routeContext&gt;
      &lt;/camel:create-routes&gt;
  &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above we have used the <strong>camel:create-route</strong> test action that will create new Camel routes at runtime in the Camel context.
The target Camel context is referenced with an automatic context lookup.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The default Camel context name in this lookup is "<em>citrusCamelContext</em>". You can set this default context name via environment variables (<em>CITRUS_CAMEL_CONTEXT_NAME</em>) or system properties (<em>citrus.camel.context.name</em>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If no specific settings are set Citrus will automatically try to look up the Camel context with name "<em>citrusCamelContext</em>" in the Spring bean configuration.
All route operations will target this Camel context then.</p>
</div>
<div class="paragraph">
<p>In addition to that you can skip this lookup and directly reference a target Camel context with the action attribute <strong>camel-context</strong> (used in the second action above).</p>
</div>
</div>
<div class="sect3">
<h4 id="remove-camel-routes"><a class="anchor" href="#remove-camel-routes"></a><a class="link" href="#remove-camel-routes">Remove Camel routes</a></h4>
<div class="paragraph">
<p>You can remove routes from the Camel context as part of the test.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelRouteActionIT extends TestNGCitrusSpringSupport {

    @Autowired
    private CamelContext camelContext;

    @Test
    @CitrusTest
    public void removeCamelRoutes() {
        $(camel().camelContext(camelContext)
            .route()
            .remove("route_1", "route_2", "route_3"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="CamelRouteIT"&gt;
  &lt;actions&gt;
      &lt;camel:remove-routes camel-context="camelContext"&gt;
        &lt;route id="route_1"/&gt;
        &lt;route id="route_2"/&gt;
        &lt;route id="route_3"/&gt;
      &lt;/camel:remove-routes&gt;
  &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="startstop-routes"><a class="anchor" href="#startstop-routes"></a><a class="link" href="#startstop-routes">Start/stop routes</a></h4>
<div class="paragraph">
<p>Next operation we will discuss is the start and stop of existing Camel routes:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelRouteActionIT extends TestNGCitrusSpringSupport {

    @Autowired
    private CamelContext camelContext;

    @Test
    @CitrusTest
    public void startThenStopCamelRoutes() {
        $(camel().camelContext(camelContext)
            .route()
            .start("route_1"));

        $(camel().camelContext(camelContext)
            .route()
            .stop("route_2", "route_3"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="CamelRouteIT"&gt;
  &lt;actions&gt;
      &lt;camel:start-routes camel-context="camelContext"&gt;
        &lt;route id="route_1"/&gt;
      &lt;/camel:start-routes&gt;

      &lt;camel:stop-routes camel-context="camelContext"&gt;
        &lt;route id="route_2"/&gt;
        &lt;route id="route_3"/&gt;
      &lt;/camel:stop-routes&gt;
  &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Starting and stopping Camel routes at runtime is important when temporarily Citrus need to receive a message on a Camel endpoint URI.
We can stop a route, use a Citrus camel endpoint instead for validation and start the route after the test is done.
This way we can also simulate errors and failure scenarios in a Camel route interaction.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="camel-controlbus-actions"><a class="anchor" href="#camel-controlbus-actions"></a><a class="link" href="#camel-controlbus-actions">16.7. Camel controlbus actions</a></h3>
<div class="paragraph">
<p>The Camel controlbus component is a good way to access route statistics and route status information within a Camel context.
Citrus provides controlbus test actions to easily access the controlbus operations at runtime.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelControlBusIT extends TestNGCitrusSpringSupport {

    @Autowired
    private CamelContext camelContext;

    @Test
    @CitrusTest
    public void createCamelRoute() {
        $(camel().camelContext(camelContext)
            .controlbus()
            .route("route_1")
            .status()
            .result(ServiceStatus.Stopped));

        $(camel().camelContext(camelContext)
            .controlbus()
            .route("route_1")
            .start());

        $(camel().camelContext(camelContext)
            .controlbus()
            .route("route_1")
            .status()
            .result(ServiceStatus.Started));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="CamelControlBusIT"&gt;
  &lt;actions&gt;
    &lt;camel:control-bus camel-context="camelContext"&gt;
      &lt;camel:route id="route_1" action="status"/&gt;
      &lt;camel:result&gt;Stopped&lt;/camel:result&gt;
    &lt;/camel:control-bus&gt;

    &lt;camel:control-bus&gt;
      &lt;camel:route id="route_1" action="start"/&gt;
    &lt;/camel:control-bus&gt;

    &lt;camel:control-bus camel-context="camelContext"&gt;
      &lt;camel:route id="route_1" action="status"/&gt;
      &lt;camel:result&gt;Started&lt;/camel:result&gt;
    &lt;/camel:control-bus&gt;

    &lt;camel:control-bus&gt;
      &lt;camel:language type="simple"&gt;${camelContext.stop()}&lt;/camel:language&gt;
    &lt;/camel:control-bus&gt;

    &lt;camel:control-bus camel-context="camelContext"&gt;
      &lt;camel:language type="simple"&gt;${camelContext.getRouteController().getRouteStatus('route_3')}&lt;/camel:language&gt;
      &lt;camel:result&gt;Started&lt;/camel:result&gt;
    &lt;/camel:control-bus&gt;
  &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example test case shows the controlbus access.
As already mentioned you can explicitly reference a target Camel context with <code>camel-context=&quot;camelContext&quot;</code>.
In case no specific context is referenced Citrus will automatically lookup a target Camel context with the default context name "<em>citrusCamelContext</em>".</p>
</div>
<div class="paragraph">
<p>Camel provides two different ways to specify operations and parameters.
The first option is the use of an <strong>action</strong> attribute.
The Camel route id has to be specified as mandatory attribute.
As a result the controlbus action will be executed on the target route during test runtime.
This way we can also start and stop Camel routes in a Camel context.</p>
</div>
<div class="paragraph">
<p>In case a controlbus operation has a result such as the <strong>status</strong> action we can specify a control result that is compared.
Citrus will raise validation exceptions when the results differ.</p>
</div>
<div class="paragraph">
<p>The second option for executing a controlbus action is the language expression.
We can use Camel language expressions on the Camel context for accessing a controlbus operation.
Also, here we can define an optional outcome as expected result.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelControlBusIT extends TestNGCitrusSpringSupport {

    @Autowired
    private CamelContext camelContext;

    @Test
    @CitrusTest
    public void createCamelRoute() {
        $(camel().camelContext(camelContext)
            .controlbus()
            .language("simple", "${camelContext.getRouteStatus('my_route')}")
            .result(ServiceStatus.Stopped));

        $(camel().camelContext(camelContext)
            .controlbus()
            .language("simple", "${camelContext.stop()}"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="CamelControlBusIT"&gt;
  &lt;actions&gt;
    &lt;camel:control-bus camel-context="camelContext"&gt;
      &lt;camel:language type="simple"&gt;${camelContext.getRouteStatus('my_route')}&lt;/camel:language&gt;
      &lt;camel:result&gt;Started&lt;/camel:result&gt;
    &lt;/camel:control-bus&gt;

    &lt;camel:control-bus&gt;
      &lt;camel:language type="simple"&gt;${camelContext.stop()}&lt;/camel:language&gt;
    &lt;/camel:control-bus&gt;
  &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="camel-jbang"><a class="anchor" href="#camel-jbang"></a><a class="link" href="#camel-jbang">16.8. Camel JBang support</a></h3>
<div class="paragraph">
<p>The Apache Camel project offers a great CLI tooling based on <a href="https://www.jbang.dev/">JBang</a>.
You can install the Camel JBang tooling on your local machine as a JBang application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">jbang app install camel@apache/camel</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>--help</code> option will show you all available commands that you can run with Camel JBang.</p>
</div>
<div class="sect3">
<h4 id="run-camel-integrations"><a class="anchor" href="#run-camel-integrations"></a><a class="link" href="#run-camel-integrations">16.8.1. Run Camel integrations</a></h4>
<div class="paragraph">
<p>One of the available commands in Camel JBang is the <code>run</code> command that takes a Camel route as an input and runs the route locally without any prior project setup.</p>
</div>
<div class="paragraph">
<p>Citrus is able to use this capability in a test to run a Camel integration in a separate JBang process.</p>
</div>
<div class="paragraph">
<p>Given the following Camel route written in YAML:</p>
</div>
<div class="listingblock">
<div class="title">Sample Camel route.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- from:
    uri: "timer:tick"
    parameters:
      period: "1000"
      includeMetadata: true
    steps:
      - setBody:
          simple: "{{greeting}} #${header.CamelTimerCounter}"
      - to: "log:info"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Camel route uses a timer component to periodically log a message to the output.
The message is given as a property placeholder <code>greeting</code> and may be set in the <code>application.properties</code>.</p>
</div>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">greeting=Hello from Apache Camel!</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Citrus test is able to run this route with Camel JBang in a separate process:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelJBangTest extends TestNGCitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void shouldRunCamelJBang() {
        when(camel().jbang()
                .run()
                .integration(Resources.fromClasspath("route.yaml", CamelJBangTest.class))
                .withSystemProperty("greeting", "Hello from Apache Camel!"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "CamelJBangTest"
actions:
  - camel:
      jbang:
        run:
          integration:
            file: "classpath:route.yaml"
            systemProperties:
              properties:
                - name: greeting
                  value: Hello from Apache Camel!</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CamelJBangTest" xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;actions&gt;
    &lt;camel&gt;
      &lt;jbang&gt;
        &lt;run&gt;
          &lt;integration file="classpath:route.yaml"&gt;
            &lt;system-properties&gt;
              &lt;property name="greeting" value="Hello from Apache Camel!"/&gt;
            &lt;/system-properties&gt;
          &lt;/integration&gt;
        &lt;/run&gt;
      &lt;/jbang&gt;
    &lt;/camel&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This starts the Camel integration with Camel JBang.
The test waits for the integration to report running status.
You can skip the waiting state with the <code>waitForRunningState=false</code> option.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The test action has an <code>autoRemove</code> option that is enabled by default. This means that the test will automatically stop and remove the Camel integration after the test.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="stop-camel-integrations"><a class="anchor" href="#stop-camel-integrations"></a><a class="link" href="#stop-camel-integrations">16.8.2. Stop Camel integrations</a></h4>
<div class="paragraph">
<p>You may want to explicitly stop the Camel integration.
You can do this with the following action:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelJBangTest extends TestNGCitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void shouldRunCamelJBang() {
        when(camel().jbang()
                .stop()
                .integration("route")
        );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "CamelJBangTest"
actions:
  - camel:
      jbang:
        stop:
          integration: "route"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CamelJBangTest" xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;actions&gt;
    &lt;camel&gt;
      &lt;jbang&gt;
        &lt;stop integration="route"/&gt;
      &lt;/jbang&gt;
    &lt;/camel&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Camel integration to stop is identified by its name. Usually this is the file name without the file extension. You can also specify a name when running the integration and reference this name in the stop action.</p>
</div>
</div>
<div class="sect3">
<h4 id="verify-camel-integrations"><a class="anchor" href="#verify-camel-integrations"></a><a class="link" href="#verify-camel-integrations">16.8.3. Verify Camel integrations</a></h4>
<div class="paragraph">
<p>Each Camel integration reports a state (running or stopped) that Citrus is able to verify. In addition to that the running Camel integration produces a log output that Citrus is able to scan for expected messages.</p>
</div>
<div class="paragraph">
<p>You can do all of this in the <code>verify</code> action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelJBangTest extends TestNGCitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void shouldRunCamelJBang() {
        when(camel().jbang()
                .verify("route")
                .waitForLogMessage("Hello from Apache Camel! #10"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "CamelJBangTest"
actions:
  - camel:
      jbang:
        verify:
          integration: "route"
          logMessage: "Hello from Apache Camel! #10"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CamelJBangTest" xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;actions&gt;
    &lt;camel&gt;
      &lt;jbang&gt;
        &lt;verify integration="route" log-message="Hello from Apache Camel! #10"/&gt;
      &lt;/jbang&gt;
    &lt;/camel&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The action above verifies that the Camel integration is running. Also, the action waits for a log message <code>Hello from Apache Camel! #10</code>.
The action periodically polls the produced log output and searches for the expected log message.</p>
</div>
<div class="paragraph">
<p>The action provides options such as <code>maxAttempts</code> and <code>pollingInterval</code> to stop the waiting period. In case the log message is not found after the maximum number of attempts the test action fails the test.</p>
</div>
</div>
<div class="sect3">
<h4 id="send-messages"><a class="anchor" href="#send-messages"></a><a class="link" href="#send-messages">16.8.4. Send messages</a></h4>
<div class="paragraph">
<p>The Camel Jbang tooling allows you to send messages to running Camel integrations.
You can use the <code>send</code> command to send messages to any running route.</p>
</div>
<div class="paragraph">
<p>Give the following Camel integration that is running in Camel JBang:</p>
</div>
<div class="listingblock">
<div class="title">echo.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- from:
    uri: "direct:echo"
    steps:
      - transform:
          simple: "${body.toUpperCase()}"
      - to: "log:info"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Camel route listens for messages on the <code>direct:echo</code> endpoint.
With Camel JBang you can send messages to this route using the following command:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelJBangTest extends TestNGCitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void shouldSendMessage() {
        when(camel().jbang().cmd()
                    .send()
                    .integration("echo")
                    .body("Hello Camel"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "CamelJBangTest"
actions:
  - camel:
    jbang:
      cmd:
        send:
          integration: "echo"
          body:
            data: "Hello Camel"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CamelJBangTest" xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;actions&gt;
    &lt;camel&gt;
      &lt;jbang&gt;
        &lt;cmd&gt;
          &lt;send integration="echo"&gt;
            &lt;body&gt;
              &lt;data&gt;Hello Camel&lt;/data&gt;
            &lt;/body&gt;
          &lt;/send&gt;
        &lt;/cmd&gt;
      &lt;/jbang&gt;
    &lt;/camel&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The send action connects with the running Camel integration called <code>echo</code> and send the message body <code>Hello Camel</code> to the route.
The send operation automatically uses the <code>direct:echo</code> endpoint because there is only one single route.</p>
</div>
<div class="paragraph">
<p>In case you have multiple routes running with multiple endpoints you can specify the endpoint with the <code>endpoint</code> attribute.</p>
</div>
<div class="paragraph">
<p>Also, you may set some additional message headers.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelJBangTest extends TestNGCitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void shouldSendMessage() {
        when(camel().jbang().cmd()
                    .send()
                    .integration("echo")
                    .endpoint("direct:echo")
                    .header("user", "christoph")
                    .body("Hello Camel"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "CamelJBangTest"
actions:
  - camel:
    jbang:
      cmd:
        send:
          integration: "echo"
          endpoint: "direct:echo"
          headers:
            user: christoph
          body:
            data: "Hello Camel"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CamelJBangTest" xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;actions&gt;
    &lt;camel&gt;
      &lt;jbang&gt;
        &lt;cmd&gt;
          &lt;send integration="echo" endpoint="direct:echo"&gt;
            &lt;headers&gt;
              &lt;header name="user" value="christoph"/&gt;
            &lt;/headers&gt;
            &lt;body&gt;
              &lt;data&gt;Hello Camel&lt;/data&gt;
            &lt;/body&gt;
          &lt;/send&gt;
        &lt;/cmd&gt;
      &lt;/jbang&gt;
    &lt;/camel&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can specify a send timeout with the <code>timeout</code> attribute (by default this is set to 20 seconds).</p>
</div>
<div class="paragraph">
<p>The <code>reply=true/false</code> option makes the send operation wait for a response message from the Camel integration.
The response data is logged to the output.</p>
</div>
<div class="paragraph">
<p>You can also use the Camel JBang send command without a running Camel integration.
This can be used to send messages to any support Camel endpoint.
Just use the endpoint uri setting on the send operation like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelJBangTest extends TestNGCitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void shouldSendMessage() {
        when(camel().jbang().cmd()
                    .send()
                    .uri("kafka:echo?server=localhost:9092")
                    .header("user", "christoph")
                    .body("Hello Camel"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "CamelJBangTest"
actions:
  - camel:
    jbang:
      cmd:
        send:
          uri: "kafka:echo?server=localhost:9092"
          headers:
            user: christoph
          body:
            data: "Hello Camel"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CamelJBangTest" xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;actions&gt;
    &lt;camel&gt;
      &lt;jbang&gt;
        &lt;cmd&gt;
          &lt;send uri="kafka:echo?server=localhost:9092"&gt;
            &lt;headers&gt;
              &lt;header name="user" value="christoph"/&gt;
            &lt;/headers&gt;
            &lt;body&gt;
              &lt;data&gt;Hello Camel&lt;/data&gt;
            &lt;/body&gt;
          &lt;/send&gt;
        &lt;/cmd&gt;
      &lt;/jbang&gt;
    &lt;/camel&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can also use the Kamelets sources to send messages with Camel JBang. The Kamelets provide easy to use properties for comfortable connection options.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please see the Camel JBang send command help for more configuration options.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="camel-jbang-kubernetes"><a class="anchor" href="#camel-jbang-kubernetes"></a><a class="link" href="#camel-jbang-kubernetes">16.9. Camel JBang Kubernetes support</a></h3>
<div class="paragraph">
<p>The Camel JBang integrations are run locally by default as a separate JBang process. In addition to that you may also run the integration in a Kubernetes namespace.</p>
</div>
<div class="paragraph">
<p>This uses the Camel JBang Kubernetes plugin that is able to build a container image and deploy it to a connected Kubernetes namespace.</p>
</div>
<div class="sect3">
<h4 id="deploy-the-camel-integration"><a class="anchor" href="#deploy-the-camel-integration"></a><a class="link" href="#deploy-the-camel-integration">16.9.1. Deploy the Camel integration</a></h4>
<div class="paragraph">
<p>The Camel JBang Kubernetes plugin is able to build a container image from an integration and deploy the integration with a generated Kubernetes manifest.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The following test actions call the Camel Kubernetes plugin. A prerequisite to this is that you are connected to a Kubernetes cluster and a namespace. It is essential to have a Kubernetes command line tooling installed and ready for usage on your local machine.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Citrus provides a test action to call the Camel JBang Kubernetes plugin:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelJBangTest extends TestNGCitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void shouldRunCamelJBang() {
        when(camel().jbang()
                .kubernetes()
                .run()
                .integration(Resources.fromClasspath("route.yaml", CamelJBangTest.class))
                .runtime("quarkus")
                .clusterType("kind")
                .imageBuilder("docker")
                .imageRegistry("localhost:5000")
                .withProperty("greeting=Hello from Apache Camel!")
        );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "CamelJBangTest"
actions:
  - camel:
      jbang:
       kubernetes:
          run:
            integration:
              file: "classpath:route.yaml"
            runtime: "quarkus"
            clusterType: "kind"
            imageBuilder: "docker"
            imageRegistry: "localhost:5000"
            properties:
              - name: greeting
                value: Hello from Apache Camel!</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CamelJBangTest" xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;actions&gt;
    &lt;camel&gt;
      &lt;jbang&gt;
        &lt;kubernetes&gt;
          &lt;run runtime="quarkus"
               cluster-type="kind"
               image-builder="docker"
               image-registry="localhost:5000"&gt;
            &lt;integration file="classpath:route.yaml"/&gt;
            &lt;properties&gt;
              &lt;property name="greeting" value="Hello from Apache Camel!"/&gt;
            &lt;/properties&gt;
          &lt;/run&gt;
        &lt;/kubernetes&gt;
      &lt;/jbang&gt;
    &lt;/camel&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Kubernetes <code>run</code> action receives detailed configuration on how to build the container image and where to push the resulting image.
You may choose the target cluster type and use an external or internal image registry (e.g. quay.io or localhost:5000).</p>
</div>
<div class="paragraph">
<p>The Camel JBang Kubernetes plugin will perform several steps to create the deployment. First of all the plugin creates a project export for the given Camel integration and builds the container image.</p>
</div>
<div class="paragraph">
<p>Also, the plugin generates a Kubernetes manifest that holds all required resources to deploy the integration to a Kubernetes cluster.
The Kubernetes deployment is automatically performed as a last step in this action.</p>
</div>
<div class="paragraph">
<p>The result will be a new Kubernetes deployment in the current namespace that uses the freshly built container image.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Please make sure to connect to a Kubernetes cluster and choose a proper namespace before running the test action. The Kubernetes client will automatically use the current cluster and namespace.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The action has an <code>autoRemove</code> setting that is enabled by default. This means that the Kubernetes deployment is automatically stopped and removed after the test.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="delete-integrations-from-kubernetes"><a class="anchor" href="#delete-integrations-from-kubernetes"></a><a class="link" href="#delete-integrations-from-kubernetes">16.9.2. Delete integrations from Kubernetes</a></h4>
<div class="paragraph">
<p>You can explicitly remove the Camel integration from Kubernetes.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelJBangTest extends TestNGCitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void shouldRunCamelJBang() {
        when(camel().jbang()
                .kubernetes()
                .delete()
                .integration("route")
        );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "CamelJBangTest"
actions:
  - camel:
      jbang:
        kubernetes:
          delete:
            integration: "route"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CamelJBangTest" xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;actions&gt;
    &lt;camel&gt;
      &lt;jbang&gt;
        &lt;kubernetes&gt;
          &lt;delete&gt;
            &lt;integration name="route"/&gt;
          &lt;/delete&gt;
        &lt;/kubernetes&gt;
      &lt;/jbang&gt;
    &lt;/camel&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This deletes the Kubernetes deployment and all resources listed in the Camel integration Kubernetes manifest.</p>
</div>
</div>
<div class="sect3">
<h4 id="verify-integration-on-kubernetes"><a class="anchor" href="#verify-integration-on-kubernetes"></a><a class="link" href="#verify-integration-on-kubernetes">16.9.3. Verify integration on Kubernetes</a></h4>
<div class="paragraph">
<p>Citrus is able to verify the state of a running Camel integration in Kubernetes.
This is the status of the Kubernetes deployment and its pods and containers.
Also, Citrus is able to scan the log output of a Camel integration that is running in Kubernetes.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelJBangTest extends TestNGCitrusSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void shouldRunCamelJBang() {
        when(camel().jbang()
                .kubernetes()
                .verify("route")
                .waitForLogMessage("Hello from Apache Camel! #10"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "CamelJBangTest"
actions:
  - camel:
      jbang:
        kubernetes:
          verify:
            integration: "route"
            logMessage: "Hello from Apache Camel! #10"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CamelJBangTest" xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;actions&gt;
    &lt;camel&gt;
      &lt;jbang&gt;
        &lt;kubernetes&gt;
          &lt;verify integration="route" log-message="Hello from Apache Camel! #10"/&gt;
        &lt;/kubernetes&gt;
      &lt;/jbang&gt;
    &lt;/camel&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The action makes sure to find the Kubernetes deployment and the running Pod.
The action waits for the expected log message and fails when the message is not available in the log output after the maximum number of attempts.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="camel-infra"><a class="anchor" href="#camel-infra"></a><a class="link" href="#camel-infra">16.10. Camel infrastructure services</a></h3>
<div class="paragraph">
<p>The Apache Camel project maintains a huge set of test infrastructure services that you can also start and stop during a Citrus test. See this documentation about the <a href="https://camel.apache.org/manual/test-infra.html">Camel test infra services</a>.</p>
</div>
<div class="paragraph">
<p>The Camel infra services usually start Docker/Podman containers and/or use Testcontainers.</p>
</div>
<div class="paragraph">
<p>See this list of supported infrastructure services in Apache Camel:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Service</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">arangodb</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">artemis (amqp, mqtt, persistent)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">aws (dynamodb, event-bridge, kinesis, s3, sns, sqs, sts, &#8230;&#8203;)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">azure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">chat-script</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">couchbase</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">couchdb</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">elasticsearch</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fhir</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftps</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">google (pub-sub)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hashicorp (vault)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hazelcast</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hive-mq (sparkplug)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafka (redpanda, strimzi)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">microprofile (lra)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">milvus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">minio</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mongodb</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mosquitto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">nats</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ollama</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">openldap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">postgres</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pulsar</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">qdrant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rabbitmq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">redis</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rocketmq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sftp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">smb</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">solr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">torch-serve</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xmpp</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">zookeeper</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can start/stop such an infra service via test actions in Citrus.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelInfraIT extends TestNGCitrusSpringSupport {

    @Test
    @CitrusTest
    public void createInfraService() {
        $(camel()
            .infra()
            .run()
            .service("postgres"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "CamelInfraTest"
actions:
  - camel:
      infra:
        run:
          service: postgres</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CamelInfraIT"
      xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;actions&gt;
    &lt;camel&gt;
      &lt;infra&gt;
        &lt;run service="postgres"/&gt;
      &lt;/infra&gt;
    &lt;/camel&gt;
  &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the infrastructure service is started Citrus exposes connection settings as test variables. You can use the exposed connection settings to create proper clients that connect to the services.</p>
</div>
<div class="paragraph">
<p>The exposed connection settings follow a naming pattern that looks like this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CITRUS_CAMEL_INFRA_SERVICE_&lt;SERVICE_NAME&gt;_&lt;PROPERTY_NAME&gt;</code></p>
</li>
<li>
<p><code>CITRUS_CAMEL_INFRA_SERVICE_&lt;SERVICE_NAME&gt;_&lt;IMPLEMENTATION&gt;_&lt;PROPERTY_NAME&gt;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For instance a infrastructure service called <code>foo</code> that exposes the settings <code>url</code> and <code>port</code> expose the following test variables.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variable</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_CAMEL_INFRA_SERVICE_FOO_URL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_CAMEL_INFRA_SERVICE_FOO_PORT</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can now use these test variables when connecting to the service.
Please see the individual Apache Camel infrastructure services documentation to see which properties get exposed by the service.</p>
</div>
<div class="paragraph">
<p>Some infrastructure services provide multiple implementations (e.g. Kafka provides both Redpanda and Strimzi).</p>
</div>
<div class="paragraph">
<p>You may need to choose the implementation as follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelInfraIT extends TestNGCitrusSpringSupport {

    @Test
    @CitrusTest
    public void createInfraService() {
        $(camel()
            .infra()
            .run()
            .service("kafka")
            .implementation("strimzi"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "CamelInfraTest"
actions:
  - camel:
      infra:
        run:
          service: kafka
          implementation: strimzi</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CamelInfraIT"
      xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;actions&gt;
    &lt;camel&gt;
      &lt;infra&gt;
        &lt;run service="kafka" implementation="strimzi"/&gt;
      &lt;/infra&gt;
    &lt;/camel&gt;
  &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the infrastructure services get automatically removed after the test. You can disable the auto removal when running the service (<code>auto-remove</code> setting).</p>
</div>
<div class="paragraph">
<p>To explicitly stop a running infrastructure service use the following test action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelInfraIT extends TestNGCitrusSpringSupport {

    @Test
    @CitrusTest
    public void createInfraService() {
        $(camel()
            .infra()
            .stop()
            .service("postgres"));
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: "CamelInfraTest"
actions:
  - camel:
      infra:
        stop:
          service: postgres</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CamelInfraIT"
      xmlns="http://citrusframework.org/schema/xml/testcase"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://citrusframework.org/schema/xml/testcase http://citrusframework.org/schema/xml/testcase/citrus-testcase.xsd"&gt;
  &lt;actions&gt;
    &lt;camel&gt;
      &lt;infra&gt;
        &lt;stop service="postgres"/&gt;
      &lt;/infra&gt;
    &lt;/camel&gt;
  &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="camel-endpoint-dsl"><a class="anchor" href="#camel-endpoint-dsl"></a><a class="link" href="#camel-endpoint-dsl">16.11. Camel endpoint DSL</a></h3>
<div class="paragraph">
<p>Since Camel 3 the endpoint DSL provides a convenient way to construct an endpoint uri.
In Citrus you can use the Camel endpoint DSL to send/receive messages in a test.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">$(send(camel().endpoint(seda("test")::getRawUri))
        .message()
        .body("Citrus rocks!"));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The fluent endpoint DSL in Camel allows to build the endpoint uri.
The <code>camel().endpoint(seda("test")::getRawUri)</code> builds the endpoint uri <code>seda:test</code>.
The endpoint DSL provides all settings and properties that you can set for a Camel endpoint component.</p>
</div>
</div>
<div class="sect2">
<h3 id="camel-processor-support"><a class="anchor" href="#camel-processor-support"></a><a class="link" href="#camel-processor-support">16.12. Camel processor support</a></h3>
<div class="paragraph">
<p>Camel implements the concept of processors as enterprise integration pattern.
A processor is able to add custom logic to a Camel route.
Each processor is able to access the Camel exchange that is being processed in the current route.
The processor is able to change the message content (body, headers) as well as the exchange information.</p>
</div>
<div class="paragraph">
<p>The send/receive operations in Citrus also implement the processor concept.
With the Citrus Camel support you can use the very same Camel processor also in a Citrus test action.</p>
</div>
<div class="listingblock primary">
<div class="title">Message processor on send</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelMessageProcessorIT extends TestNGCitrusSpringSupport {

    @Autowired
    private CamelContext camelContext;

    @Test
    @CitrusTest
    public void shouldProcessMessages() {
        $(send(camel().endpoint(seda("test")::getRawUri))
                .message()
                .body("Citrus rocks!")
                .process(processor()
                    .camel()
                    .camelContext(camelContext)
                    .process(exchange -&gt; exchange
                            .getMessage()
                            .setBody(exchange.getMessage().getBody(String.class).toUpperCase())))
        );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above uses a Camel processor to change the exchange and the message content before the message is sent to the endpoint.
This way you can apply custom changes to the message as part of the test action.</p>
</div>
<div class="listingblock primary">
<div class="title">Message processor on receive</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelMessageProcessorIT extends TestNGCitrusSpringSupport {

    @Autowired
    private CamelContext camelContext;

    @Test
    @CitrusTest
    public void shouldProcessMessages() {
        $(send(camel().endpoint(seda("test")::getRawUri))
                .message()
                .body("Citrus rocks!"));

        $(receive(camel().endpoint(seda("test")::getRawUri))
                .process(processor()
                        .camel(camelContext)
                        .process(exchange -&gt; exchange
                                .getMessage()
                                .setBody(exchange.getMessage().getBody(String.class).toUpperCase())))
                .message()
                .type(MessageType.PLAINTEXT)
                .body("CITRUS ROCKS!"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Camel processors are very powerful.
In particular, you can apply transformations of multiple kind.</p>
</div>
<div class="listingblock primary">
<div class="title">Transform processor</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelTransformIT extends TestNGCitrusSpringSupport {

    @Autowired
    private CamelContext camelContext;

    @Test
    @CitrusTest
    public void shouldTransformMessageReceived() {
        $(send(camel().endpoint(seda("hello")::getRawUri))
                .message()
                .body("{\"message\": \"Citrus rocks!\"}")
        );

        $(receive(camel().endpoint(seda("hello")::getRawUri))
                .transform(
                    camel()
                        .camelContext(camelContext)
                        .transform()
                        .jsonpath("$.message"))
                .message()
                .type(MessageType.PLAINTEXT)
                .body("Citrus rocks!"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The transform pattern is able to change the message content before a message is received/sent in Citrus.
The example above applies a JsonPath expression as part of the message processing.
The JsonPath expression evaluates <code>$.message</code> on the Json payload and saves the result as new message body content.
The following message validation expects the plaintext value <code>Citrus rocks!</code>.</p>
</div>
<div class="paragraph">
<p>The message processor is also able to apply a complete route logic as part of the test action.</p>
</div>
<div class="listingblock primary">
<div class="title">Route processor</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelRouteProcessorIT extends TestNGCitrusSpringSupport {

    @Autowired
    private CamelContext camelContext;

    @Test
    @CitrusTest
    public void shouldProcessRoute() {
        CamelRouteProcessor.Builder beforeReceive = camel(camelContext).route(route -&gt;
                route.choice()
                    .when(jsonpath("$.greeting[?(@.language == 'EN')]"))
                        .setBody(constant("Hello!"))
                    .when(jsonpath("$.greeting[?(@.language == 'DE')]"))
                        .setBody(constant("Hallo!"))
                    .otherwise()
                        .setBody(constant("Hi!")));

        $(send(camel().endpoint(seda("greetings")::getRawUri))
                .message()
                .body("{" +
                        "\"greeting\": {" +
                            "\"language\": \"EN\"" +
                        "}" +
                      "}")
        );

        $(receive("camel:" + camel().endpoints().seda("greetings").getUri())
                .process(beforeReceive)
                .message()
                .type(MessageType.PLAINTEXT)
                .body("Hello!"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the complete route logic you have the full power of Camel ready to be used in your send/receive test action.
This enables many capabilities as Camel implements the enterprise integration patterns such as split, choice, enrich and many more.</p>
</div>
</div>
<div class="sect2">
<h3 id="camel-data-format-support"><a class="anchor" href="#camel-data-format-support"></a><a class="link" href="#camel-data-format-support">16.13. Camel data format support</a></h3>
<div class="paragraph">
<p>Camel uses the concept of data format to transform message content in form of marshal/unmarshal operations.
You can use the data formats supported in Camel in Citrus, too.</p>
</div>
<div class="listingblock primary">
<div class="title">Data format marshal/unmarshal</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CamelDataFormatIT extends TestNGCitrusSpringSupport {

    @Autowired
    private CamelContext camelContext;

    @Test
    @CitrusTest
    public void shouldApplyDataFormat() {
        when(send(camel().endpoint(seda("data")::getRawUri))
                .message()
                .body("Citrus rocks!")
                .transform(camel(camelContext)
                        .marshal()
                        .base64())
        );

        then(receive("camel:" + camel().endpoints().seda("data").getUri())
                .transform(camel(camelContext)
                        .unmarshal()
                        .base64())
                .transform(camel(camelContext)
                        .convertBodyTo(String.class))
                .message()
                .type(MessageType.PLAINTEXT)
                .body("Citrus rocks!"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above uses the <code>base64</code> data format provided in Camel to marshal/unmarshal the message content to/from a base64 encoded String.
Camel provides support for many data formats as you can see in the <a href="https://camel.apache.org/components/latest/dataformats/index.html">documentation on data formats</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="message-channels"><a class="anchor" href="#message-channels"></a><a class="link" href="#message-channels">17. Message channel support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Message channels represent the in memory messaging solution in Citrus. Producer and consumer components are linked via channels
exchanging messages in memory. The transport comes from the <a href="https://spring.io/projects/spring-integration">Spring Integration</a> project.</p>
</div>
<div class="paragraph">
<p>This opens up a lot of great possibilities to interact with the Spring Integration transport adapters for FTP, TCP/IP and
so on. In addition to that the message channel support provides us a good way to exchange messages in memory.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The message channel configuration components use the "citrus-si" configuration namespace and schema definition. Include
this namespace into your Spring configuration in order to use the Citrus configuration elements. The namespace URI and schema
location are added to the Spring configuration XML file as follows.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:citrus-si="http://www.citrusframework.org/schema/spring-integration/config"
        xsi:schemaLocation="
            http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.citrusframework.org/schema/spring-integration/config
            http://www.citrusframework.org/schema/spring-integration/config/citrus-spring-integration-config.xsd"&gt;

    [...]

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Right now you are able to use customized Citrus XML elements in order to define the Spring Integration endpoint components.</p>
</div>
<div class="sect2">
<h3 id="channel-endpoint"><a class="anchor" href="#channel-endpoint"></a><a class="link" href="#channel-endpoint">17.1. Channel endpoint</a></h3>
<div class="paragraph">
<p>Citrus offers a channel endpoint component that is able to create producers and consumers. Producer and consumer
send and receive messages both to and from a channel endpoint. By default, the endpoint is asynchronous when configured
in the Citrus context. With this component you are able to access message channels directly:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public ChannelEndpoint helloEndpoint() {
    return new ChannelEndpointBuilder()
        .channel("helloChannel")
        .build();
}

@Bean
public MessageSelectingQueueChannel helloChannel() {
    return new MessageSelectingQueueChannel();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-si:channel-endpoint id="helloEndpoint" channel="helloChannel"/&gt;

&lt;citrus-si:channel id="helloChannel"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Citrus channel endpoint references a Spring Integration channel directly. Inside your test case you can reference the
Citrus endpoint as usual to send and receive messages.</p>
</div>
<div class="paragraph">
<p>The Citrus channel endpoint also supports a customized message channel template that will actually send the messages. The
customized template might give you access to special configuration possibilities.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public ChannelEndpoint helloEndpoint() {
    return new ChannelEndpointBuilder()
        .channel("helloChannel")
        .messagingTemplate(messagingTemplate())
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-si:channel-endpoint id="helloEndpoint"
                            channel="helloChannel"
                            message-channel-template="myMessageChannelTemplate"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message sender is now ready to publish messages on the defined channel. The communication is supposed to be asynchronous,
so the producer is not able to process any reply message. We will deal with synchronous communication and reply messages
later in this chapter. You can reference the id of the endpoint in a send and receive test action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(send("helloEndpoint")
        .message()
        .body("&lt;v1:HelloRequest xmlns:v1=\"http://citrusframework.org/schemas/HelloService.xsd\"&gt;" +
                "&lt;v1:Text&gt;Hello World!&lt;/v1:Text&gt;" +
            "&lt;/v1:HelloRequest&gt;"));

then(receive("helloEndpoint")
        .message()
        .body("&lt;v1:HelloResponse xmlns:v1=\"http://citrusframework.org/schemas/HelloService.xsd\"&gt;" +
                "&lt;v1:Text&gt;Hello Citrus!&lt;/v1:Text&gt;" +
            "&lt;/v1:HelloResponse&gt;"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;send endpoint="helloEndpoint"&gt;
    &lt;message&gt;
        &lt;payload&gt;
            &lt;v1:HelloRequest xmlns:v1="http://citrusframework.org/schemas/HelloService.xsd"&gt;
                &lt;v1:Text&gt;Hello World!&lt;/v1:Text&gt;
            &lt;/v1:HelloRequest&gt;
        &lt;/payload&gt;
    &lt;/message&gt;
&lt;/send&gt;

&lt;receive endpoint="helloEndpoint"&gt;
    &lt;message&gt;
        &lt;payload&gt;
            &lt;v1:HelloResponse xmlns:v1="http://citrusframework.org/schemas/HelloService.xsd"&gt;
                &lt;v1:Text&gt;Hello Citrus!&lt;/v1:Text&gt;
            &lt;/v1:HelloResponse&gt;
        &lt;/payload&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can send and receive messages from the same Spring Integration message channel endpoint. As usual the receiver connects
to the message destination and waits for messages to arrive. The user can set a receive timeout which is set to 5000 milliseconds
by default. In case no message was received in this time frame the receiver raises timeout errors and the test fails.</p>
</div>
</div>
<div class="sect2">
<h3 id="synchronous-channel-endpoints"><a class="anchor" href="#synchronous-channel-endpoints"></a><a class="link" href="#synchronous-channel-endpoints">17.2. Synchronous channel endpoints</a></h3>
<div class="paragraph">
<p>The synchronous channel producer publishes messages and waits synchronously for the response to arrive on a reply channel
destination. The reply channel name is set in the message headers. The counterpart in this communication must send its
reply to that channel. The basic configuration for a synchronous channel endpoint component looks like follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public ChannelSyncEndpoint helloEndpoint() {
    return new ChannelSyncEndpointBuilder()
        .channel("helloChannel")
        .pollingInterval(1000)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-si:channel-sync-endpoint id="helloSyncEndpoint"
                            channel="helloChannel"
                            polling-interval="1000"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Synchronous message channel endpoints usually do poll for synchronous reply messages for processing the reply messages.
The poll interval is an optional setting in order to manage the amount of reply message handshake attempts. When the endpoint
was able to receive the reply message synchronously the test case can verify the reply.</p>
</div>
<div class="paragraph">
<p>In case all polling attempts have failed the action raises a timeout error, and the test will fail.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, the channel endpoint uses temporary reply channel destinations. The temporary reply channels are only
used once for a single communication handshake. The temporary reply channel is deleted automatically.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When sending a message to this endpoint in the first place the producer will wait synchronously for the response message
to arrive on the reply channel. You can receive the reply message in your test case using the same endpoint component. So
we have two actions on the same endpoint, first send then receive.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(send("helloSyncEndpoint")
        .message()
        .body("&lt;v1:HelloRequest xmlns:v1=\"http://citrusframework.org/schemas/HelloService.xsd\"&gt;" +
                "&lt;v1:Text&gt;Hello World!&lt;/v1:Text&gt;" +
            "&lt;/v1:HelloRequest&gt;"));

then(receive("helloSyncEndpoint")
        .message()
        .body("&lt;v1:HelloResponse xmlns:v1=\"http://citrusframework.org/schemas/HelloService.xsd\"&gt;" +
                "&lt;v1:Text&gt;Hello Citrus!&lt;/v1:Text&gt;" +
            "&lt;/v1:HelloResponse&gt;"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;send endpoint="helloSyncEndpoint"&gt;
    &lt;message&gt;
        &lt;payload&gt;
            &lt;v1:HelloRequest xmlns:v1="http://citrusframework.org/schemas/HelloService.xsd"&gt;
                &lt;v1:Text&gt;Hello World!&lt;/v1:Text&gt;
            &lt;/v1:HelloRequest&gt;
        &lt;/payload&gt;
    &lt;/message&gt;
&lt;/send&gt;

&lt;receive endpoint="helloSyncEndpoint"&gt;
    &lt;message&gt;
        &lt;payload&gt;
            &lt;v1:HelloResponse xmlns:v1="http://citrusframework.org/schemas/HelloService.xsd"&gt;
                &lt;v1:Text&gt;Hello Citrus!&lt;/v1:Text&gt;
            &lt;/v1:HelloResponse&gt;
        &lt;/payload&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is how you handle synchronous communication as a sender. You publish messages to a channel and wait for reply messages
on a temporary reply channel. The next section deals with the same synchronous communication, but now Citrus will receive
a request and send a synchronous reply message to a temporary reply channel.</p>
</div>
<div class="paragraph">
<p>As usual the reply channel name is stored in the message headers. Citrus handles this synchronous communication with the
same synchronous channel endpoint component. The handling of temporary reply destinations is done automatically behind
the scenes.</p>
</div>
<div class="paragraph">
<p>So we have again two actions in our test case, but this time first receive then send.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("helloSyncEndpoint")
        .message()
        .body("&lt;v1:HelloRequest xmlns:v1=\"http://citrusframework.org/schemas/HelloService.xsd\"&gt;" +
                "&lt;v1:Text&gt;Hello World!&lt;/v1:Text&gt;" +
            "&lt;/v1:HelloRequest&gt;"));

then(send("helloSyncEndpoint")
        .message()
        .body("&lt;v1:HelloResponse xmlns:v1=\"http://citrusframework.org/schemas/HelloService.xsd\"&gt;" +
                "&lt;v1:Text&gt;Hello Citrus!&lt;/v1:Text&gt;" +
            "&lt;/v1:HelloResponse&gt;"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="helloSyncEndpoint"&gt;
    &lt;message&gt;
        &lt;payload&gt;
            &lt;v1:HelloRequest xmlns:v1="http://citrusframework.org/schemas/HelloService.xsd"&gt;
                &lt;v1:Text&gt;Hello World!&lt;/v1:Text&gt;
            &lt;/v1:HelloRequest&gt;
        &lt;/payload&gt;
    &lt;/message&gt;
&lt;/receive&gt;

&lt;send endpoint="helloSyncEndpoint"&gt;
    &lt;message&gt;
        &lt;payload&gt;
            &lt;v1:HelloResponse xmlns:v1="http://citrusframework.org/schemas/HelloService.xsd"&gt;
                &lt;v1:Text&gt;Hello Citrus!&lt;/v1:Text&gt;
            &lt;/v1:HelloResponse&gt;
        &lt;/payload&gt;
    &lt;/message&gt;
&lt;/send&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="message-channel-selector"><a class="anchor" href="#message-channel-selector"></a><a class="link" href="#message-channel-selector">17.3. Message selectors</a></h3>
<div class="paragraph">
<p>A channel can hold multiple messages at the same time. Usually you receive messages using first-in-first-out pattern. Message
selectors enable you to select messages form that channel so you can pick messages form a channel based on a selector evaluation.</p>
</div>
<div class="paragraph">
<p>Citrus introduces a special queue message channel implementation that support message selectors.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public MessageSelectingQueueChannel helloChannel() {
    return new MessageSelectingQueueChannel();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-si:channel id="orderChannel" capacity="5"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Citrus message channel implementation extends the queue channel implementation from Spring Integration. So we can add
a capacity attribute for this channel. A receive test action makes use of message selectors on header values as described
in <a href="#receive-message-selectors">message-selector</a>.</p>
</div>
<div class="paragraph">
<p>In addition to that we have implemented other message filter possibilities on message channels that we discuss in the next
sections.</p>
</div>
</div>
<div class="sect2">
<h3 id="payload-matching-message-channel-selector"><a class="anchor" href="#payload-matching-message-channel-selector"></a><a class="link" href="#payload-matching-message-channel-selector">17.4. Payload matching selector</a></h3>
<div class="paragraph">
<p>You can select messages based on the payload content. Either you define the expected payload as an exact match in the selector
or you make use of Citrus validation matchers which is more adequate in most scenarios.</p>
</div>
<div class="paragraph">
<p>Assume there are two different plain text messages living on a message channel waiting to be picked up by a consumer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">Hello, welcome!</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">GoodBye, see you next time!</code></pre>
</div>
</div>
<div class="paragraph">
<p>The tester would like to pick up the message starting with <strong>GoodBye</strong> in our test case. The other messages should be left on the
channel as we are not interested in it right now. We can define a payload matching selector in the receive action like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("orderChannelEndpoint")
        .selector(Collections.singletonMap("payload", "@startsWith(GoodBye)@"))
        .message()
        .body("GoodBye, see you next time!"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="orderChannelEndpoint"&gt;
    &lt;selector&gt;
        &lt;element name="payload" value="@startsWith(GoodBye)@"/&gt;
    &lt;/selector&gt;
    &lt;message&gt;
        &lt;payload&gt;GoodBye, see you next time!&lt;/payload&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Citrus receiver picks up the <strong>GoodBye</strong> from the channel selected via the payload matching expression defined in the
selector element. Of course, you can also combine message header selectors and payload matching selectors as shown in this
example below where a message header <strong>sequenceId</strong> is added to the selection logic.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Map&lt;String, String&gt; selectorMap = new HashMap&lt;&gt;();
selectorMap.put("payload", "@startsWith(GoodBye)@");
selectorMap.put("sequenceId", "1234");

when(receive("orderChannelEndpoint")
        .selector(selector)
        .message()
        .body("GoodBye, see you next time!"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;selector&gt;
    &lt;element name="payload" value="@startsWith(GoodBye)@"/&gt;
    &lt;element name="sequenceId" value="1234"/&gt;
&lt;/selector&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="root-qname-message-channel-selector"><a class="anchor" href="#root-qname-message-channel-selector"></a><a class="link" href="#root-qname-message-channel-selector">17.5. Root QName selector</a></h3>
<div class="paragraph">
<p>As a special payload matching selector you can use the XML root QName of your message as selection criteria when dealing
with XML message content. Let&#8217;s see how this works in a small example:</p>
</div>
<div class="paragraph">
<p>We have two different XML messages on a message channel waiting to be picked up by a consumer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;HelloMessage xmlns="http://citrusframework.org/schema"&gt;Hello Citrus&lt;/HelloMessage&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;GoodbyeMessage xmlns="http://citrusframework.org/schema"&gt;Goodbye Citrus&lt;/GoodbyeMessage&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We would like to pick up the <strong>GoodbyeMessage</strong> in our test case. The <strong>HelloMessage</strong> should be left on the message channel
as we are not interested in it right now. We can define a root qname message selector in the receive action like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("orderChannelEndpoint")
        .selector(Collections.singletonMap("root-qname", "GoodbyeMessage"))
        .message()
        .body("&lt;GoodbyeMessage xmlns=\"http://citrusframework.org/schema\"&gt;Goodbye Citrus&lt;/GoodbyeMessage&gt;"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="orderChannelEndpoint"&gt;
    &lt;selector&gt;
        &lt;element name="root-qname" value="GoodbyeMessage"/&gt;
    &lt;/selector&gt;
    &lt;message&gt;
        &lt;payload&gt;
            &lt;GoodbyeMessage xmlns="http://citrusframework.org/schema"&gt;Goodbye Citrus&lt;/GoodbyeMessage&gt;
        &lt;/payload&gt;
    &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Citrus receiver picks up the <strong>GoodbyeMessage</strong> from the channel selected via the root qname of the XML message payload.
Of course, you can also combine message header selectors and root qname selectors as shown in this example below where a
message header <strong>sequenceId</strong> is added to the selection logic.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Map&lt;String, String&gt; selectorMap = new HashMap&lt;&gt;();
selectorMap.put("root-qname", "GoodbyeMessage");
selectorMap.put("sequenceId", "1234");

when(receive("orderChannelEndpoint")
        .selector(selector)
        .message()
        .body("GoodBye, see you next time!"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;selector&gt;
    &lt;element name="root-qname" value="GoodbyeMessage"/&gt;
    &lt;element name="sequenceId" value="1234"/&gt;
&lt;/selector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we deal with XML qname values, we can also use namespaces in our selector root qname selection.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("orderChannelEndpoint")
        .selector(Collections.singletonMap("root-qname", "{http://citrusframework.org/schema}GoodbyeMessage"))
        .message()
        .body("&lt;GoodbyeMessage xmlns=\"http://citrusframework.org/schema\"&gt;Goodbye Citrus&lt;/GoodbyeMessage&gt;"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;selector&gt;
    &lt;element name="root-qname" value="{http://citrusframework.org/schema}GoodbyeMessage"/&gt;
&lt;/selector&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="xpath-message-channel-selector"><a class="anchor" href="#xpath-message-channel-selector"></a><a class="link" href="#xpath-message-channel-selector">17.6. Xpath selector</a></h3>
<div class="paragraph">
<p>It is also possible to evaluate some XPath expression on the message payload in order to select a message from a message
channel. The XPath expression outcome must match an expected value and only then the message is consumed from the channel.</p>
</div>
<div class="paragraph">
<p>The syntax for the XPath expression is to be defined as the element name like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("orderChannelEndpoint")
        .selector(Collections.singletonMap("xpath://Order/status", "pending"))
        .message()
        .body("&lt;Order&gt;&lt;status&gt;pending&lt;/status&gt;&lt;/Order&gt;"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;selector&gt;
    &lt;element name="xpath://Order/status" value="pending"/&gt;
&lt;/selector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message selector looks for order messages with <strong>status="pending"</strong> in the message payload. This means that following
messages would get accepted/declined by the message selector.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;Order&gt;&lt;status&gt;pending&lt;/status&gt;&lt;/Order&gt; &lt;!-- ACCEPTED --&gt;
&lt;Order&gt;&lt;status&gt;finished&lt;/status&gt;&lt;/Order&gt; &lt;!-- NOT ACCEPTED --&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, you can also use XML namespaces in your XPath expressions when selecting messages from channels.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("orderChannelEndpoint")
        .selector(Collections.singletonMap("xpath://ns1:Order/ns1:status", "pending"))
        .message()
        .body("&lt;Order&gt;&lt;status&gt;pending&lt;/status&gt;&lt;/Order&gt;"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;selector&gt;
    &lt;element name="xpath://ns1:Order/ns1:status" value="pending"/&gt;
&lt;/selector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Namespace prefixes must match the incoming message - otherwise the XPath expression will not work as expected. In our example
the message should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;ns1:Order xmlns:ns1="http://citrus.org/schema"&gt;&lt;ns1:status&gt;pending&lt;/ns1:status&gt;&lt;/ns1:Order&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Knowing the correct XML namespace prefix is not always easy. If you are not sure which namespace prefix to choose Citrus
ships with a dynamic namespace replacement for XPath expressions. The XPath expression looks like this and is most flexible:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("orderChannelEndpoint")
        .selector(Collections.singletonMap(
                "xpath://{http://citrus.org/schema}:Order/{http://citrus.org/schema}:status", "pending"))
        .message()
        .body("&lt;Order&gt;&lt;status&gt;pending&lt;/status&gt;&lt;/Order&gt;"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;selector&gt;
    &lt;element name="xpath://{http://citrus.org/schema}:Order/{http://citrus.org/schema}:status"
                value="pending"/&gt;
&lt;/selector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will match all incoming messages regardless the XML namespace prefix that is used.</p>
</div>
</div>
<div class="sect2">
<h3 id="json-path-message-channel-selector"><a class="anchor" href="#json-path-message-channel-selector"></a><a class="link" href="#json-path-message-channel-selector">17.7. JsonPath selector</a></h3>
<div class="paragraph">
<p>It is also possible to evaluate some JsonPath expression on the message payload in order to select a message from a message
channel. The JsonPath expression outcome must match an expected value and only then the message is consumed from the channel.</p>
</div>
<div class="paragraph">
<p>The syntax for the JsonPath expression is to be defined as the element name like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">when(receive("orderChannelEndpoint")
        .selector(Collections.singletonMap("jsonPath:$.order.status", "pending"))
        .message()
        .body("{ \"order\": { \"status\": \"pending\" } }"));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;selector&gt;
    &lt;element name="jsonPath:$.order.status" value="pending"/&gt;
&lt;/selector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message selector looks for order messages with <strong>status="pending"</strong> in the message payload. This means that following messages would get accepted/declined by the message selector.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{ "order": { "status": "pending" } } //ACCEPTED
{ "order": { "status": "finished" } } //NOT ACCEPTED</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="websocket"><a class="anchor" href="#websocket"></a><a class="link" href="#websocket">18. WebSocket support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The WebSocket message protocol builds on top of Http standard and brings bidirectional communication to the Http client-server world. Citrus is able to send and receive messages with WebSocket connections as client and server. The Http server implementation is now able to define multiple WebSocket endpoints. The new Citrus WebSocket client is able to publish and consumer messages via bidirectional WebSocket protocol.</p>
</div>
<div class="paragraph">
<p>The new WebSocket support is located in the module <strong>citrus-websocket</strong> . Therefore we need to add this module to our project as dependency when we are about to use the WebSocket features in Citrus.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
    &lt;artifactId&gt;citrus-websocket&lt;/artifactId&gt;
    &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As Citrus provides a customized WebSocket configuration schema for the Spring application context configuration files we have to add name to the top level <strong>beans</strong> element. Simply include the websocket-config namespace in the configuration XML files as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:citrus="http://www.citrusframework.org/schema/config"
      xmlns:citrus-websocket="http://www.citrusframework.org/schema/websocket/config"
      xsi:schemaLocation="
            http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.citrusframework.org/schema/config
            http://www.citrusframework.org/schema/config/citrus-config.xsd
            http://www.citrusframework.org/schema/websocket/config
            http://www.citrusframework.org/schema/websocket/config/citrus-websocket-config.xsd"&gt;

    [...]

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now our project is ready to use the Citrus WebSocket support. First of all let us send a message via WebSocket connection to some server.</p>
</div>
<div class="sect2">
<h3 id="websocket-client"><a class="anchor" href="#websocket-client"></a><a class="link" href="#websocket-client">18.1. WebSocket client</a></h3>
<div class="paragraph">
<p>On the client side Citrus offers a client component that goes directly to the Spring bean application context. The client needs a server endpoint uri. This is a WebSocket protocol endpoint uri.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebSocketClient helloWebSocketClient() {
    return new WebSocketClientBuilder()
        .requestUrl("http://localhost:8080/hello")
        .timeout(5000L)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebSocketClient helloWebSocketClient() {
    return new WebSocketClientBuilder()
        .requestUrl("http://localhost:8080/hello")
        .timeout(5000L)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-websocket="http://www.citrusframework.org/schema/websocket/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/websocket/config
           http://www.citrusframework.org/schema/websocket/config/citrus-websocket-config.xsd"&gt;

    &lt;citrus-websocket:client id="helloWebSocketClient"
                    url="http://localhost:8080/hello"
                    timeout="5000"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>url</strong> defines the endpoint to send messages to. The server has to be a WebSocket ready web server that supports Http connection upgrade for WebSocket protocols. WebSocket by its nature is an asynchronous bidirectional protocol. This means that the connection between client and server remains open and both server and client can send and receive messages. So when the Citrus client is waiting for a message we need a timeout that stops the asynchronous waiting. The receiving test action and the test case will fail when such a timeout is raised.</p>
</div>
<div class="paragraph">
<p>The WebSocket client will automatically open a connection to the server and ask for a connection upgrade to WebSocket protocol. This handshake is done once when the connection to the server is established. After that the client can push messages to the server and on the other side the server can push messages to the client. Now let&#8217;s first push some messages to the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;send endpoint="helloWebSocketClient"&gt;
  &lt;message&gt;
      &lt;payload&gt;
          &lt;TestMessage&gt;
              &lt;Text&gt;Hello WebSocketServer&lt;/Text&gt;
          &lt;/TestMessage&gt;
      &lt;/payload&gt;
  &lt;/message&gt;
&lt;/send&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The connection handshake and the connection upgrade is done automatically by the client. After that the message is pushed to the server. As WebSocket is a bidirectional protocol we can also receive messages on the WebSocket client. These messages are pushed from server to all connected clients.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="helloWebSocketClient"&gt;
  &lt;message&gt;
      &lt;payload&gt;
          &lt;TestMessage&gt;
              &lt;Text&gt;Hello WebSocketClient&lt;/Text&gt;
          &lt;/TestMessage&gt;
      &lt;/payload&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We just use the very same client endpoint component in a message receive action. The client will wait for messages from the server and once received perform the well known message validation. Here we expect some XML message payload. This completes the client side as we are able to push and consumer messages via WebSocket connections.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Up to now we have used static WebSocket endpoint URIs in our client component configurations. This can be done with a more powerful dynamic endpoint URI in WebSocket client. Similar to the endpoint resolving mechanism in SOAP you can dynamically set the called endpoint uri at test runtime through message header values. By default Citrus will check a specific header entry for dynamic endpoint URI which is simply defined for each message sending action inside the test.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <strong>dynamicEndpointResolver</strong> bean must implement the EndpointUriResolver interface in order to resolve dynamic endpoint uri values. Citrus offers a default implementation, the <strong>DynamicEndpointUriResolver</strong>, which uses a specific message header for setting dynamic endpoint uri. The message header needs to specify the header <strong>citrus_endpoint_uri</strong> with a valid request uri.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;header&gt;
  &lt;element name="citrus_endpoint_uri" value="ws://localhost:8080/customers/${customerId}"/&gt;
&lt;/header&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The specific send action above will send its message to the dynamic endpoint (ws://localhost:8080/customers/${customerId}[ws://localhost:8080/customers/${customerId}]) which is set in the header <strong>citrus_endpoint_uri</strong> .</p>
</div>
</div>
<div class="sect2">
<h3 id="websocket-server-endpoints"><a class="anchor" href="#websocket-server-endpoints"></a><a class="link" href="#websocket-server-endpoints">18.2. WebSocket server endpoints</a></h3>
<div class="paragraph">
<p>On the server side Citrus has a Http server implementation that we can easily start during test runtime. The Http server accepts connections from clients and also supports WebSocket upgrade strategies. This means clients can ask for an upgrade to the WebSocket standard. In this handshake the server will upgrade the connection to WebSocket and afterwards client and server can exchange messages over this connection. This means the connection is kept alive and multiple messages can be exchanged. Let&#8217;s see how WebSocket endpoints are added to a Http server component in Citrus.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebSocketServer helloWebSocketServer() {
    return new WebSocketServerBuilder()
        .port(8080)
        .webSockets(Arrays.asList(
            webSocket1(),
            webSocket2()
        ))
        .autoStart(true)
        .build();
}

private WebSocketEndpoint webSocket1() {
    WebSocketServerEndpointConfiguration webSocketConfig = new WebSocketServerEndpointConfiguration();
    webSocketConfig.setName("websocket1");
    webSocketConfig.setEndpointUri("/test1");
    return new WebSocketEndpoint(webSocketConfig);
}

private WebSocketEndpoint webSocket2() {
    WebSocketServerEndpointConfiguration webSocketConfig = new WebSocketServerEndpointConfiguration();
    webSocketConfig.setName("websocket2");
    webSocketConfig.setEndpointUri("/test2");
    webSocketConfig.setTimeout(10000L);
    return new WebSocketEndpoint(webSocketConfig);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebSocketServer helloWebSocketServer() {
    return new WebSocketServerBuilder()
        .port(8080)
        .webSockets(Arrays.asList(
            webSocket1(),
            webSocket2()
        ))
        .autoStart(true)
        .build();
}

private WebSocketEndpoint webSocket1() {
    WebSocketServerEndpointConfiguration webSocketConfig = new WebSocketServerEndpointConfiguration();
    webSocketConfig.setName("websocket1");
    webSocketConfig.setEndpointUri("/test1");
    return new WebSocketEndpoint(webSocketConfig);
}

private WebSocketEndpoint webSocket2() {
    WebSocketServerEndpointConfiguration webSocketConfig = new WebSocketServerEndpointConfiguration();
    webSocketConfig.setName("websocket2");
    webSocketConfig.setEndpointUri("/test2");
    webSocketConfig.setTimeout(10000L);
    return new WebSocketEndpoint(webSocketConfig);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-websocket="http://www.citrusframework.org/schema/websocket/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/websocket/config
           http://www.citrusframework.org/schema/websocket/config/citrus-websocket-config.xsd"&gt;

    &lt;citrus-websocket:server id="helloWebSocketServer"
            port="8080"
            auto-start="true"&gt;
        &lt;citrus-websocket:endpoints&gt;
            &lt;citrus-websocket:endpoint ref="websocket1"/&gt;
            &lt;citrus-websocket:endpoint ref="websocket2"/&gt;
        &lt;/citrus-websocket:endpoints&gt;
    &lt;/citrus-websocket:server&gt;

    &lt;citrus-websocket:endpoint id="websocket1" path="/test1"/&gt;
    &lt;citrus-websocket:endpoint id="websocket2" path="/test2" timeout="10000"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The embedded Jetty WebSocket server component in Citrus now is able to define multiple WebSocket endpoints. The WebSocket endpoints match to a request path on the server and are referenced by a unique id. Each WebSocket endpoint can follow individual timeout settings. In a test we can use these endpoints directly to receive messages.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void httpWebSocketServerTest() {
    when(receive()
            .endpoint(websocket1)
            .message()
                .body("...")
    );

    then(send()
            .endpoint(websocket1)
            .message()
                .body("...")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="HttpWebSocketServerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;receive endpoint="websocket1"&gt;
        &lt;message&gt;
            &lt;body&gt;
              &lt;data&gt;...&lt;/data&gt;
            &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;

      &lt;send endpoint="websocket1"&gt;
        &lt;message&gt;
            &lt;body&gt;
              &lt;data&gt;...&lt;/data&gt;
            &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: HttpWebSocketServerTest
actions:
  - receive:
      endpoint: "websocket1"
      message:
        body:
          data: {}
  - send:
      endpoint: "websocket1"
      message:
        body:
          data: {}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="httpWebSocketServerTest"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="websocket1"&gt;
            &lt;message&gt;
                &lt;data&gt;...&lt;/data&gt;
            &lt;/message&gt;
        &lt;/receive&gt;

        &lt;send endpoint="websocket1"&gt;
            &lt;message&gt;
                &lt;data&gt;...&lt;/data&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we reference the endpoint id in both receive and send actions. Each WebSocket endpoint holds one or more open connections to its clients. Each message that is sent is pushed to all connected clients. Each client can send messages to the WebSocket endpoint.</p>
</div>
<div class="paragraph">
<p>The WebSocket endpoint component handles connection handshakes automatically and caches all open sessions in memory. By default all connected clients will receive the messages pushed from server. This is done completely behind the scenes. The Citrus server is able to handle multiple WebSocket endpoints with different clients connected to it at the same time. This is why we have to choose the WebSocket endpoint on the server by its identifier when sending and receiving messages.</p>
</div>
<div class="paragraph">
<p>With this WebSocket endpoints we change the Citrus server behavior so that clients can upgrade to WebSocket connection. Now we have a bidirectional connection where the server can push messages to the client and vice versa.</p>
</div>
</div>
<div class="sect2">
<h3 id="websocket-headers"><a class="anchor" href="#websocket-headers"></a><a class="link" href="#websocket-headers">18.3. WebSocket headers</a></h3>
<div class="paragraph">
<p>The WebSocket standard defines some default headers to use during connection upgrade. These headers are made available to the test case in both directions. Citrus will handle these header values with special care when WebSocket support is activated on a server or client. Now WebSocket messages can also be split into multiple pieces. Each message part is pushed separately to the server but still is considered to be a single message payload. The server has to collect and aggregate all messages until a special message header <strong>isLast</strong> is set in one of the message parts.</p>
</div>
<div class="paragraph">
<p>The Citrus WebSocket client can slice messages into several parts.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void webSocketClientTest() {
    when(send()
            .endpoint(webSocketClient)
            .message()
                .type(MessageType.JSON)
                .body("""
                [
                  {
                    "event" : "client_message_1",
                    "timestamp" : "citrus:currentDate()"
                  },
                """)
                .header("citrus_websocket_is_last", false)
    );

    then(send()
            .endpoint(webSocketClient)
            .message()
                .type(MessageType.JSON)
                .body("""
                  {
                    "event" : "client_message_2",
                    "timestamp" : "citrus:currentDate()"
                  }
                ]
                """)
                .header("citrus_websocket_is_last", true)
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="WebSocketClientTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;send endpoint="webSocketClient"&gt;
        &lt;message type="json"&gt;
            &lt;body&gt;
              &lt;data&gt;
              [
                {
                  "event" : "client_message_1",
                  "timestamp" : "citrus:currentDate()"
                },
              &lt;/data&gt;
            &lt;/body&gt;
            &lt;headers&gt;
              &lt;header name="citrus_websocket_is_last" value="false"/&gt;
            &lt;/headers&gt;
        &lt;/message&gt;
      &lt;/send&gt;

      &lt;send endpoint="webSocketClient"&gt;
        &lt;message type="json"&gt;
            &lt;body&gt;
              &lt;data&gt;
                {
                  "event" : "client_message_2",
                  "timestamp" : "citrus:currentDate()"
                }
              ]
              &lt;/data&gt;
            &lt;/body&gt;
            &lt;headers&gt;
              &lt;header name="citrus_websocket_is_last" value="true"/&gt;
            &lt;/headers&gt;
        &lt;/message&gt;
      &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: WebSocketClientTest
actions:
  - send:
      endpoint: "webSocketClient"
      message:
        type: JSON
        body:
          data: |
            [
              {
                "event" : "client_message_1",
                "timestamp" : "citrus:currentDate()"
              },
        headers:
          - name: citrus_websocket_is_last
            value: false
  - send:
      endpoint: "webSocketClient"
      message:
        type: JSON
        body:
          data: |
              {
                "event" : "client_message_2",
                "timestamp" : "citrus:currentDate()"
              }
            ]
        headers:
          - name: citrus_websocket_is_last
            value: true</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="webSocketClientTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="webSocketClient"&gt;
            &lt;message type="json"&gt;
                &lt;data&gt;
                [
                    {
                        "event" : "client_message_1",
                        "timestamp" : "citrus:currentDate()"
                    },
                &lt;/data&gt;
            &lt;/message&gt;
            &lt;header&gt;
                &lt;element name="citrus_websocket_is_last" value="false"/&gt;
            &lt;/header&gt;
        &lt;/send&gt;

        &lt;sleep milliseconds="500"/&gt;

        &lt;send endpoint="webSocketClient"&gt;
            &lt;message type="json"&gt;
                &lt;data&gt;
                    {
                        "event" : "client_message_2",
                        "timestamp" : "citrus:currentDate()"
                    }
                  ]
                &lt;/data&gt;
            &lt;/message&gt;
            &lt;header&gt;
                &lt;element name="citrus_websocket_is_last" value="true"/&gt;
            &lt;/header&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test above has two separate send operations both sending to a WebSocket endpoint.
The first sending action sets the header <strong>citrus_websocket_is_last</strong> to <strong>false</strong> which indicates that the message is not complete yet.
The 2nd send action pushes the rest of the message to the server and set the <strong>citrus_websocket_is_last</strong> header to <strong>true</strong> .
Now the server is able to aggregate the message pieces to a single message payload. The result is a valida JSON array with both events in it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "event" : "client_message_1",
    "timestamp" : "2015-01-01"
  },
  {
    "event" : "client_message_2",
    "timestamp" : "2015-01-01"
  }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the server part in Citrus is able to handle these sliced messages, too. The server will automatically aggregate those message parts before passing it to the test case for validation.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mail"><a class="anchor" href="#mail"></a><a class="link" href="#mail">19. Mail support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sending and receiving mails is the next interest we are going to talk about. When dealing with mail communication you most certainly need to interact with some sort of IMAP or POP mail server. But in Citrus we do not want to manage mails in a personal inbox. We just need to be able to exchange mail messages the persisting in a user inbox is not part of our business.</p>
</div>
<div class="paragraph">
<p>This is why Citrus provides <strong>just</strong> an SMTP mail server which accepts mail messages from clients. Once the SMTP server has accepted an incoming mail it forwards those data to the running test case. In the test case you can receive the incoming mail message and perform message validation as usual. The mail sending part is easy as Citrus offers a mail client that connects to some SMTP server for sending mails to the outside world.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The mail components in Citrus are kept in a separate Maven module. So you should check that the module is available as Maven dependency in your project
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-mail&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read the next section in order to find out more about the mail message support in Citrus.</p>
</div>
<div class="sect2">
<h3 id="mail-client"><a class="anchor" href="#mail-client"></a><a class="link" href="#mail-client">19.1. Mail client</a></h3>
<div class="paragraph">
<p>The mail sending part is quite easy and straight forward. We just need to send a mail message to some SMTP server. So Citrus provides a mail client that sends out mail messages.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public MailClient simpleMailClient() {
    return new MailClientBuilder()
            .host("localhost")
            .port(25025L)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public MailClient simpleMailClient() {
    return new MailClientBuilder()
            .host("localhost")
            .port(25025L)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:citrus="http://www.citrusframework.org/schema/config"
      xmlns:citrus-mail="http://www.citrusframework.org/schema/mail/config"
      xsi:schemaLocation="
          http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/config
          http://www.citrusframework.org/schema/config/citrus-config.xsd
          http://www.citrusframework.org/schema/mail/config
          http://www.citrusframework.org/schema/mail/config/citrus-mail-config.xsd"&gt;

    &lt;citrus-mail:client id="simpleMailClient"
          host="localhost"
          port="25025"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is how a Citrus mail client component is defined in the Spring application context. You can use this client referenced by its id or name in your test case in a message sending action. The client defines a host and port attribute which should connect the client to some SMTP server instance.</p>
</div>
<div class="paragraph">
<p>We all know mail message contents. The mail message has some general properties set by the user:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
from
</td>
<td class="hdlist2">
<p>The message sender mail address</p>
</td>
</tr>
<tr>
<td class="hdlist1">
to
</td>
<td class="hdlist2">
<p>The message recipient mail address. You can add multiple recipients by using a comma separated list.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
cc
</td>
<td class="hdlist2">
<p>Copy recipient mail address. You can add multiple recipients by using a comma separated list.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
bcc
</td>
<td class="hdlist2">
<p>Blind copy recipient mail address. You can add multiple recipients by using a comma separated list.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
subject
</td>
<td class="hdlist2">
<p>Some subject used as mail headline.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As a tester you are able to set these properties in your test case. Citrus defines an XML mail message representation that you can use inside your send action. Let us have a look at this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void mailClientTest() {
    given(send()
            .endpoint(simpleMailClient)
            .message()
            .body("""
            &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                &lt;cc&gt;&lt;/cc&gt;
                &lt;bcc&gt;&lt;/bcc&gt;
                &lt;subject&gt;This is a test mail message&lt;/subject&gt;
                &lt;body&gt;
                    &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                    &lt;content&gt;Hello Citrus mail server!&lt;/content&gt;
                &lt;/body&gt;
            &lt;/mail-message&gt;
            """));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="MailClientTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;send endpoint="simpleMailClient"&gt;
        &lt;message&gt;
            &lt;body&gt;
                &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                    &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                    &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                    &lt;cc&gt;&lt;/cc&gt;
                    &lt;bcc&gt;&lt;/bcc&gt;
                    &lt;subject&gt;This is a test mail message&lt;/subject&gt;
                    &lt;body&gt;
                        &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                        &lt;content&gt;Hello Citrus mail server!&lt;/content&gt;
                    &lt;/body&gt;
                &lt;/mail-message&gt;
            &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: MailClientTest
actions:
  - send:
      endpoint: "simpleMailClient"
      message:
        body: |
          &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                &lt;cc&gt;&lt;/cc&gt;
                &lt;bcc&gt;&lt;/bcc&gt;
                &lt;subject&gt;This is a test mail message&lt;/subject&gt;
                &lt;body&gt;
                    &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                    &lt;content&gt;Hello Citrus mail server!&lt;/content&gt;
                &lt;/body&gt;
          &lt;/mail-message&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
  &lt;testcase name="mailClientTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="simpleMailClient"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                    &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                        &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                        &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                        &lt;cc&gt;&lt;/cc&gt;
                        &lt;bcc&gt;&lt;/bcc&gt;
                        &lt;subject&gt;This is a test mail message&lt;/subject&gt;
                        &lt;body&gt;
                            &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                            &lt;content&gt;Hello Citrus mail server!&lt;/content&gt;
                        &lt;/body&gt;
                    &lt;/mail-message&gt;
                &lt;/payload&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The basic XML mail message representation defines a list of basic mail properties such as <strong>from</strong>, <strong>to</strong> or <strong>subject</strong> . In addition to that we define a text body which is either plain text or HTML. You can specify the content type of the mail body very easy (e.g. text/plain or text/html). By default, Citrus uses <strong>text/plain</strong> content type.</p>
</div>
<div class="paragraph">
<p>Now when dealing with mail messages you often come to use multipart structures for attachments. In Citrus you can define attachment content as base64 character sequence. The Citrus mail client will automatically create a proper multipart mail mime message using the content types and body parts specified.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void mailClientTest() {
    given(send()
            .endpoint(simpleMailClient)
            .message()
            .body("""
            &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                &lt;cc&gt;&lt;/cc&gt;
                &lt;bcc&gt;&lt;/bcc&gt;
                &lt;subject&gt;This is a test mail message&lt;/subject&gt;
                &lt;body&gt;
                    &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                    &lt;content&gt;Hello Citrus mail server!&lt;/content&gt;
                    &lt;attachments&gt;
                        &lt;attachment&gt;
                            &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                            &lt;content&gt;This is attachment data&lt;/content&gt;
                            &lt;fileName&gt;attachment.txt&lt;/fileName&gt;
                        &lt;/attachment&gt;
                    &lt;/attachments&gt;
                &lt;/body&gt;
            &lt;/mail-message&gt;
            """));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="MailClientTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;send endpoint="simpleMailClient"&gt;
        &lt;message&gt;
            &lt;body&gt;
                &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                    &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                    &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                    &lt;cc&gt;&lt;/cc&gt;
                    &lt;bcc&gt;&lt;/bcc&gt;
                    &lt;subject&gt;This is a test mail message&lt;/subject&gt;
                    &lt;body&gt;
                        &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                        &lt;content&gt;Hello Citrus mail server!&lt;/content&gt;
                        &lt;attachments&gt;
                            &lt;attachment&gt;
                                &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                                &lt;content&gt;This is attachment data&lt;/content&gt;
                                &lt;fileName&gt;attachment.txt&lt;/fileName&gt;
                            &lt;/attachment&gt;
                        &lt;/attachments&gt;
                    &lt;/body&gt;
                &lt;/mail-message&gt;
            &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: MailClientTest
actions:
  - send:
      endpoint: "simpleMailClient"
      message:
        body: |
          &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                &lt;cc&gt;&lt;/cc&gt;
                &lt;bcc&gt;&lt;/bcc&gt;
                &lt;subject&gt;This is a test mail message&lt;/subject&gt;
                &lt;body&gt;
                    &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                    &lt;content&gt;Hello Citrus mail server!&lt;/content&gt;
                    &lt;attachments&gt;
                        &lt;attachment&gt;
                            &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                            &lt;content&gt;This is attachment data&lt;/content&gt;
                            &lt;fileName&gt;attachment.txt&lt;/fileName&gt;
                        &lt;/attachment&gt;
                    &lt;/attachments&gt;
                &lt;/body&gt;
          &lt;/mail-message&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
  &lt;testcase name="mailClientTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="simpleMailClient"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                    &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                        &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                        &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                        &lt;cc&gt;&lt;/cc&gt;
                        &lt;bcc&gt;&lt;/bcc&gt;
                        &lt;subject&gt;This is a test mail message&lt;/subject&gt;
                        &lt;body&gt;
                            &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                            &lt;content&gt;Hello Citrus mail server!&lt;/content&gt;
                            &lt;attachments&gt;
                                &lt;attachment&gt;
                                    &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                                    &lt;content&gt;This is attachment data&lt;/content&gt;
                                    &lt;fileName&gt;attachment.txt&lt;/fileName&gt;
                                &lt;/attachment&gt;
                            &lt;/attachments&gt;
                        &lt;/body&gt;
                    &lt;/mail-message&gt;
                &lt;/payload&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>That completes the basic mail client capabilities. But wait we have not talked about error scenarios where mail communication results in error. When running into mail error scenarios we have to handle the error respectively with exception handling. When the mail server responded with errors Citrus will raise mail exceptions automatically and your test case fails accordingly.</p>
</div>
<div class="paragraph">
<p>As a tester you can catch and assert these mail exceptions verifying your error scenario.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void mailClientTest() {
    given(assertException()
            .exception(MailSendException.class)
            .when(send()
                .endpoint(simpleMailClient)
                .message()
                .body("""
                &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                    [...]
                &lt;/mail-message&gt;
                """)
            ));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="MailClientTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;assert exception="org.springframework.mail.MailSendException"&gt;
        &lt;when&gt;
          &lt;send endpoint="simpleMailClient"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                        [...]
                    &lt;/mail-message&gt;
                &lt;/body&gt;
            &lt;/message&gt;
          &lt;/send&gt;
      &lt;/when&gt;
      &lt;/assert&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: MailClientTest
actions:
  - assert:
      exception: "org.springframework.mail.MailSendException"
      when:
        send:
          endpoint: "simpleMailClient"
          message:
            body: |
              &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                    [...]
              &lt;/mail-message&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
  &lt;testcase name="mailClientTest"&gt;
    &lt;actions&gt;
        &lt;assert exception="org.springframework.mail.MailSendException"&gt;
            &lt;when&gt;
                &lt;send endpoint="simpleMailClient"&gt;
                    &lt;message&gt;
                        &lt;payload&gt;
                            &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                                [...]
                            &lt;/mail-message&gt;
                        &lt;/payload&gt;
                    &lt;/message&gt;
                &lt;/send&gt;
            &lt;/when&gt;
        &lt;/assert&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We assert the <strong><em>MailSendException</em></strong> from Spring to be thrown while sending the mail message to the SMTP server. With exception message validation you are able to expect very specific mail send errors on the client side. This is how you can handle some sort of error situation returned by the mail server. Speaking of mail servers we need to also talk about providing a mail server endpoint in Citrus for clients. This is part of our next section.</p>
</div>
</div>
<div class="sect2">
<h3 id="mail-server"><a class="anchor" href="#mail-server"></a><a class="link" href="#mail-server">19.2. Mail server</a></h3>
<div class="paragraph">
<p>Consuming mail messages is a more complicated task as we need to have some sort of server that clients can connect to. In your mail client software you typically point to some IMAP or POP inbox and receive mails from that endpoint. In Citrus we do not want to manage a whole personal mail inbox such as IMAP or POP would provide. We just need an SMTP server endpoint for clients to send mails to. The SMTP server accepts mail messages and forwards those to a running test case for further validation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We have no user inbox where incoming mails are stored. The mail server just forwards incoming mails to the running test for validation. After the test the incoming mail message is gone.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And this is exactly what the Citrus mail server is capable of. The server is a very lightweight SMTP server. All incoming mail client connections are accepted by default and the mail data is converted into a Citrus XML mail interface representation. The XML mail message is then passed to the running test for validation.</p>
</div>
<div class="paragraph">
<p>Let us have a look at the Citrus mail server component and how you can add it to the Spring application context.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public MailServer simpleMailServer() {
    return new MailServerBuilder()
            .port(25025L)
            .autoStart(true)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public MailServer simpleMailServer() {
    return new MailServerBuilder()
            .port(25025L)
            .autoStart(true)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-mail:server id="simpleMailServer"
      port="25025"
      auto-start="true"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The mail server component receives several properties such as <strong>port</strong> or <strong>auto-start</strong> . Citrus starts an in-memory SMTP server that clients can connect to.</p>
</div>
<div class="paragraph">
<p>In your test case you can then receive the incoming mail messages on the server in order to perform the well known XML validation mechanisms within Citrus. The message header and the payload contain all mail information so you can verify the content with expected templates as usual:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void mailServerTest() {
    when(receive()
            .endpoint(simpleMailServer)
            .message()
            .body("""
            &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                &lt;cc&gt;&lt;/cc&gt;
                &lt;bcc&gt;&lt;/bcc&gt;
                &lt;subject&gt;This is a test mail message&lt;/subject&gt;
                &lt;body&gt;
                    &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                    &lt;content&gt;Hello Citrus mail server!&lt;/content&gt;
                &lt;/body&gt;
            &lt;/mail-message&gt;
            """)
            .header("citrus_mail_from", "christoph@citrusframework.com")
            .header("citrus_mail_to", "dev@citrusframework.com")
            .header("citrus_mail_subject", "This is a test mail message")
            .header("citrus_mail_content_type", "text/plain; charset=utf-8"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="MailServerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;receive endpoint="simpleMailServer"&gt;
        &lt;message&gt;
            &lt;body&gt;
                &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                    &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                    &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                    &lt;cc&gt;&lt;/cc&gt;
                    &lt;bcc&gt;&lt;/bcc&gt;
                    &lt;subject&gt;This is a test mail message&lt;/subject&gt;
                    &lt;body&gt;
                        &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                        &lt;content&gt;Hello Citrus mail server!&lt;/content&gt;
                    &lt;/body&gt;
                &lt;/mail-message&gt;
            &lt;/body&gt;
            &lt;headers&gt;
                &lt;header name="citrus_mail_from" value="christoph@citrusframework.com"/&gt;
                &lt;header name="citrus_mail_to" value="dev@citrusframework.com"/&gt;
                &lt;header name="citrus_mail_subject" value="This is a test mail message"/&gt;
                &lt;header name="citrus_mail_content_type" value="text/plain; charset=utf-8"/&gt;
            &lt;/headers&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: MailServerTest
actions:
  - receive:
      endpoint: "simpleMailServer"
      message:
        body: |
          &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                &lt;cc&gt;&lt;/cc&gt;
                &lt;bcc&gt;&lt;/bcc&gt;
                &lt;subject&gt;This is a test mail message&lt;/subject&gt;
                &lt;body&gt;
                    &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                    &lt;content&gt;Hello Citrus mail server!&lt;/content&gt;
                &lt;/body&gt;
          &lt;/mail-message&gt;
        headers:
        - name: "citrus_mail_from"
          value: "christoph@citrusframework.com"
        - name: "citrus_mail_to"
          value: "dev@citrusframework.com"
        - name: "citrus_mail_subject"
          value: "This is a test mail message"
        - name: "citrus_mail_content_type"
          value: "text/plain; charset=utf-8"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
  &lt;testcase name="mailServerTest"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="simpleMailServer"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                    &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                        &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                        &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                        &lt;cc&gt;&lt;/cc&gt;
                        &lt;bcc&gt;&lt;/bcc&gt;
                        &lt;subject&gt;This is a test mail message&lt;/subject&gt;
                        &lt;body&gt;
                            &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                            &lt;content&gt;Hello Citrus mail server!&lt;/content&gt;
                        &lt;/body&gt;
                    &lt;/mail-message&gt;
                &lt;/payload&gt;
            &lt;/message&gt;
            &lt;header&gt;
                &lt;element name="citrus_mail_from" value="christoph@citrusframework.com"/&gt;
                &lt;element name="citrus_mail_to" value="dev@citrusframework.com"/&gt;
                &lt;element name="citrus_mail_subject" value="This is a test mail message"/&gt;
                &lt;element name="citrus_mail_content_type" value="text/plain; charset=utf-8"/&gt;
            &lt;/header&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The general mail properties such as <strong>from</strong>, <strong>to</strong>, <strong>subject</strong> are available as elements in the mail payload and in the message header information. The message header names do start with a common Citrus mail prefix <strong>citrus_mail</strong> . Following from that you can verify these special mail message headers in your test as shown above. Citrus offers following mail headers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>citrus_mail_from</p>
</li>
<li>
<p>citrus_mail_to</p>
</li>
<li>
<p>citrus_mail_cc</p>
</li>
<li>
<p>citrus_mail_bcc</p>
</li>
<li>
<p>citrus_mail_subject</p>
</li>
<li>
<p>citrus_mail_replyTo</p>
</li>
<li>
<p>citrus_mail_date</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to that Citrus converts the incoming mail data to a special XML mail representation which is passed as message payload to the test. The mail body parts are represented as body and optional attachment elements. As this is plain XML you can verify the mail message content as usual using Citrus variables, functions and validation matchers.</p>
</div>
<div class="paragraph">
<p>Regardless of how the mail message has passed the validation the Citrus SMTP mail server will automatically respond with success codes (SMTP 250 OK) to the calling client. This is the basic Citrus mail server behavior where all client connections are accepted an all mail messages are responded with SMTP 250 OK response codes.</p>
</div>
<div class="paragraph">
<p>Now in more advanced usage scenarios the tester may want to control the mail communication outcome. User can force some error scenarios where mail clients are not accepted or mail communication should fail with some SMTP error state for instance.</p>
</div>
<div class="paragraph">
<p>By using a more advanced mail server setup the tester gets more power to sending back mail server response codes to the mail client. Just use the advanced mail adapter implementation in your mail server component configuration:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public MailServer advancedMailServer() {
    return new MailServerBuilder()
            .port(25025L)
            .autoAccept(false)
            .splitMultipart(true)
            .autoStart(true)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public MailServer advancedMailServer() {
    return new MailServerBuilder()
            .port(25025L)
            .autoAccept(false)
            .splitMultipart(true)
            .autoStart(true)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-mail:server id="advancedMailServer"
      auto-accept="false"
      split-multipart="true"
      port="25025"
      auto-start="true"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have disabled the <strong>auto-accept</strong> mode on the mail server. This means that we have to do some additional steps in your test case to accept the incoming mail message first. So we can decide in our test case whether to accept or decline the incoming mail message for a more powerful test. You accept/decline a mail message with a special XML accept request/response exchange in your test case:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void mailServerTest() {
    when(receive()
            .endpoint(advancedMailServer)
            .message()
            .body("""
            &lt;accept-request xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
            &lt;/accept-request&gt;
            """));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="MailServerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;receive endpoint="advancedMailServer"&gt;
        &lt;message&gt;
            &lt;body&gt;
                &lt;accept-request xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                    &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                    &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                &lt;/accept-request&gt;
            &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: MailServerTest
actions:
  - receive:
      endpoint: "advancedMailServer"
      message:
        body: |
          &lt;accept-request xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
          &lt;/accept-request&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
  &lt;testcase name="mailServerTest"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="advancedMailServer"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                    &lt;accept-request xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                        &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                        &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                    &lt;/accept-request&gt;
                &lt;/payload&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>So before receiving the actual mail message we receive this simple accept-request in our test. The accept request gives us the message <strong>from</strong> and <strong>to</strong> resources of the mail message. Now the test decides to also decline a mail client connection. You can simulate that the server does not accept the mail client connection by sending back a negative accept response.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void mailServerTest() {
    given(send()
            .endpoint(advancedMailClient)
            .message()
            .body("""
            &lt;accept-response xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                &lt;accept&gt;true&lt;/accept&gt;
            &lt;/accept-response&gt;
            """));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="MailServerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;send endpoint="advancedMailClient"&gt;
        &lt;message&gt;
            &lt;body&gt;
                &lt;accept-response xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                    &lt;accept&gt;true&lt;/accept&gt;
                &lt;/accept-response&gt;
            &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: MailServerTest
actions:
  - send:
      endpoint: "advancedMailClient"
      message:
        body: |
          &lt;accept-response xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                &lt;accept&gt;true&lt;/accept&gt;
          &lt;/accept-response&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
  &lt;testcase name="mailServerTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="advancedMailServer"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                    &lt;accept-response xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                        &lt;accept&gt;true&lt;/accept&gt;
                    &lt;/accept-response&gt;
                &lt;/payload&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Depending on the accept outcome the mail client will receive an error response with proper error codes. If you accept the mail message with a positive accept response the next step in your test receives the actual mail message as we have seen it before in this chapter.</p>
</div>
<div class="paragraph">
<p>Now besides not accepting a mail message in the first place you can als simulate another error scenario with the mail server. In this scenario the mail server should respond with some sort of SMTP error code after accepting the message. This is done with a special mail response message like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void mailServerTest() {
    when(receive()
            .endpoint(advancedMailServer)
            .message()
            .body("""
            &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                &lt;cc&gt;&lt;/cc&gt;
                &lt;bcc&gt;&lt;/bcc&gt;
                &lt;subject&gt;This is a test mail message&lt;/subject&gt;
                &lt;body&gt;
                    &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                    &lt;content&gt;Hello Citrus mail server!&lt;/content&gt;
                &lt;/body&gt;
            &lt;/mail-message&gt;
            """));

    then(send()
            .endpoint(advancedMailServer)
            .message()
            .body("""
            &lt;mail-response xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                &lt;code&gt;443&lt;/code&gt;
                &lt;message&gt;Failed!&lt;/message&gt;
            &lt;/mail-response&gt;
            """));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="MailServerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;receive endpoint="advancedMailServer"&gt;
        &lt;message&gt;
            &lt;body&gt;
                &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                    &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                    &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                    &lt;cc&gt;&lt;/cc&gt;
                    &lt;bcc&gt;&lt;/bcc&gt;
                    &lt;subject&gt;This is a test mail message&lt;/subject&gt;
                    &lt;body&gt;
                        &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                        &lt;content&gt;Hello Citrus mail server!&lt;/content&gt;
                    &lt;/body&gt;
                &lt;/mail-message&gt;
            &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;

      &lt;send endpoint="advancedMailServer"&gt;
        &lt;message&gt;
            &lt;body&gt;
                &lt;mail-response xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                    &lt;code&gt;443&lt;/code&gt;
                    &lt;message&gt;Failed!&lt;/message&gt;
                &lt;/mail-response&gt;
            &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: MailServerTest
actions:
  - receive:
      endpoint: "advancedMailServer"
      message:
        body: |
          &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                &lt;cc&gt;&lt;/cc&gt;
                &lt;bcc&gt;&lt;/bcc&gt;
                &lt;subject&gt;This is a test mail message&lt;/subject&gt;
                &lt;body&gt;
                    &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                    &lt;content&gt;Hello Citrus mail server!&lt;/content&gt;
                &lt;/body&gt;
          &lt;/mail-message&gt;
  - send:
      endpoint: "advancedMailServer"
      message:
        body: |
          &lt;mail-response xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                &lt;code&gt;443&lt;/code&gt;
                &lt;message&gt;Failed!&lt;/message&gt;
          &lt;/mail-response&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
  &lt;testcase name="mailServerTest"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="advancedMailServer"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                    &lt;mail-message xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                        &lt;from&gt;christoph@citrusframework.com&lt;/from&gt;
                        &lt;to&gt;dev@citrusframework.com&lt;/to&gt;
                        &lt;cc&gt;&lt;/cc&gt;
                        &lt;bcc&gt;&lt;/bcc&gt;
                        &lt;subject&gt;This is a test mail message&lt;/subject&gt;
                        &lt;body&gt;
                            &lt;contentType&gt;text/plain; charset=utf-8&lt;/contentType&gt;
                            &lt;content&gt;Hello Citrus mail server!&lt;/content&gt;
                        &lt;/body&gt;
                    &lt;/mail-message&gt;
                &lt;/payload&gt;
            &lt;/message&gt;
        &lt;/receive&gt;

        &lt;send endpoint="advancedMailServer"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                    &lt;mail-response xmlns="http://www.citrusframework.org/schema/mail/message"&gt;
                        &lt;code&gt;443&lt;/code&gt;
                        &lt;message&gt;Failed!&lt;/message&gt;
                    &lt;/mail-response&gt;
                &lt;/payload&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see from the example above we first accept the connection and receive the mail content as usual. Now the test returns a negative mail response with some error code reason set. The Citrus SMTP communication will then fail and the calling mail client receives the respective error.</p>
</div>
<div class="paragraph">
<p>If you skip the negative mail response the server will automatically respond with positive SMTP response codes to the calling client.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ftp"><a class="anchor" href="#ftp"></a><a class="link" href="#ftp">20. FTP support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>With Citrus it is possible to start your own ftp server for accepting incoming client requests. You can also use Citrus as an FTP client to send FTP commands. The next sections deal with FTP connectivity.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The FTP components in Citrus are maintained in their own Maven module. So you should add the module as Maven dependency to your project accordingly.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-ftp&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="ftp-client"><a class="anchor" href="#ftp-client"></a><a class="link" href="#ftp-client">20.1. FTP client</a></h3>
<div class="paragraph">
<p>We want to use Citrus to connect to some FTP server as a client sending commands such as creating a directory or listing files. Citrus offers a client component doing exactly this FTP client connection.</p>
</div>
<div class="listingblock primary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public FtpClient ftpClient() {
    return CitrusEndpoints.ftp()
            .client()
            .port(2222)
            .username("citrus")
            .password("admin")
            .timeout(10000L)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ftp="http://www.citrusframework.org/schema/ftp/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/http/config
           http://www.citrusframework.org/schema/ftp/config/citrus-ftp-config.xsd"&gt;

    &lt;citrus-ftp:client id="ftpClient"
          host="localhost"
          port="2222"
          username="admin"
          password="admin"
          timeout="10000"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Citrus provides a customized FTP configuration schema for the Spring XML application context configurations.
Simply include the <code>citrus-ftp</code> namespace in the configuration XML files as seen in the example above.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The configuration above describes a Citrus ftp client connected to a ftp server with <code><a href="ftp://localhost:22222" class="bare">ftp://localhost:22222</a></code>. For authentication username and password are defined as well as the global connection timeout. The client will automatically send username and password for proper authentication to the server when opening a new connection.</p>
</div>
<div class="sect3">
<h4 id="ftp-client-commands"><a class="anchor" href="#ftp-client-commands"></a><a class="link" href="#ftp-client-commands">20.1.1. FTP client commands</a></h4>
<div class="paragraph">
<p>In a test case you are now able to use the client to push commands to the server.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void ftpMessageTest() {
    $(send(ftpClient)
        .message(FtpMessage.command(FTPCmd.MKD).arguments("test"))
    );

    CommandResult result = new CommandResult();
    result.setSuccess(true);
    result.setReplyCode(String.valueOf(257));
    result.setReplyString("@contains(\"/test\" created)@");

    $(receive(ftpClient)
        .message(FtpMessage.result(result))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="FtpMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="ftpClient"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;ftp:command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:signal&gt;MKD&lt;/ftp:signal&gt;
                            &lt;ftp:arguments&gt;test&lt;/ftp:arguments&gt;
                        &lt;/ftp:command&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="ftpClient"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;ftp:command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                            &lt;ftp:reply-code&gt;257&lt;/ftp:reply-code&gt;
                            &lt;ftp:reply-string&gt;257 "/test" created.&lt;/ftp:reply-string&gt;
                        &lt;/ftp:command-result&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: FtpMessageTest
actions:
  - send:
      endpoint: "ftpClient"
      message:
        body: |
          &lt;ftp:command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
            &lt;ftp:signal&gt;MKD&lt;/ftp:signal&gt;
            &lt;ftp:arguments&gt;test&lt;/ftp:arguments&gt;
          &lt;/ftp:command&gt;
  - receive:
      endpoint: "ftpClient"
      message:
        body: |
          &lt;ftp:command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
            &lt;ftp:reply-code&gt;257&lt;/ftp:reply-code&gt;
            &lt;ftp:reply-string&gt;257 "/test" created.&lt;/ftp:reply-string&gt;
          &lt;/ftp:command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="FtpMessageTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="ftpClient"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;ftp:command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:signal&gt;MKD&lt;/ftp:signal&gt;
                            &lt;ftp:arguments&gt;test&lt;/ftp:arguments&gt;
                        &lt;/ftp:command&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;

            &lt;receive endpoint="ftpClient"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;ftp:command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                            &lt;ftp:reply-code&gt;257&lt;/ftp:reply-code&gt;
                            &lt;ftp:reply-string&gt;257 "/test" created.&lt;/ftp:reply-string&gt;
                        &lt;/ftp:command-result&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see most of the ftp communication parameters are specified in a ftp command message. Citrus automatically converts those information to proper FTP commands and response messages.</p>
</div>
</div>
<div class="sect3">
<h4 id="ftp-client-store"><a class="anchor" href="#ftp-client-store"></a><a class="link" href="#ftp-client-store">20.1.2. Store files</a></h4>
<div class="paragraph">
<p>The client is able to store files on the server using file transfer.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void ftpMessageTest() {
    $(send(ftpClient)
        .message(FtpMessage.put("test/hello.txt", DataType.ASCII).arguments(""))
    );

    PutCommandResult result = new PutCommandResult();
    result.setSuccess(true);
    result.setReplyCode(String.valueOf(226));
    result.setReplyString("@contains(Transfer complete)@");

    $(receive(ftpClient)
        .message(FtpMessage.result(result))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="FtpMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="ftpClient"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;ftp:put-command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
                            &lt;ftp:target path="/test/hello.txt"/&gt;
                        &lt;/ftp:put-command&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="ftpClient"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;ftp:put-command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                            &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
                            &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
                        &lt;/ftp:put-command-result&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: FtpMessageTest
actions:
  - send:
      endpoint: "ftpClient"
      message:
        body: |
          &lt;ftp:put-command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
            &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
            &lt;ftp:target path="/test/hello.txt"/&gt;
          &lt;/ftp:put-command&gt;
  - receive:
      endpoint: "ftpClient"
      message:
        body: |
          &lt;ftp:put-command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
            &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
            &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
          &lt;/ftp:put-command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="FtpMessageTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="ftpClient"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;ftp:put-command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
                            &lt;ftp:target path="/test/hello.txt"/&gt;
                        &lt;/ftp:put-command&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;

            &lt;receive endpoint="ftpClient"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;ftp:put-command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                            &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
                            &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
                        &lt;/ftp:put-command-result&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The file store operation uses the put command as message payload when sending the file request. The file content is loaded from external file resource. You can choose the transfer type <code>ASCII</code> and <code>BINARY</code>.
When the file is stored on server side we receive a success result message with respective reply code and string for validation.</p>
</div>
</div>
<div class="sect3">
<h4 id="ftp-client-retrieve"><a class="anchor" href="#ftp-client-retrieve"></a><a class="link" href="#ftp-client-retrieve">20.1.3. Retrieve files</a></h4>
<div class="paragraph">
<p>We are able to retrieve files from an FTP server. We need to specify the target file path that we want to get on the server user home directory.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void ftpMessageTest() {
    $(send(ftpClient)
        .message(FtpMessage.get("test/hello.txt", "target/test/hello.txt", DataType.ASCII))
    );

    $(receive(ftpClient)
        .message(FtpMessage.result(getRetrieveFileCommandResult("target/test/hello.txt", new ClassPathResource("test/hello.txt"))))
    );
}

private GetCommandResult getRetrieveFileCommandResult(String path, Resource content) throws IOException {
    GetCommandResult result = new GetCommandResult();
    result.setSuccess(true);
    result.setReplyCode(String.valueOf(226));
    result.setReplyString("@contains('Transfer complete')@");

    GetCommandResult.File entryResult = new GetCommandResult.File();
    entryResult.setPath(path);
    entryResult.setData(FileUtils.readToString(content));
    result.setFile(entryResult);

    return result;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="FtpMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="ftpClient"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;ftp:get-command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
                            &lt;ftp:target path="target/test/hello.txt"/&gt;
                        &lt;/ftp:get-command&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="ftpClient"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;ftp:get-command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                            &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
                            &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
                            &lt;ftp:file path="target/test/hello.txt"&gt;
                              &lt;ftp:data&gt;citrus:readFile('classpath:test/hello.txt')&lt;/ftp:data&gt;
                            &lt;/ftp:file&gt;
                        &lt;/ftp:get-command-result&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: FtpMessageTest
actions:
  - send:
      endpoint: "ftpClient"
      message:
        body: |
          &lt;ftp:get-command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
            &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
            &lt;ftp:target path="target/test/hello.txt"/&gt;
          &lt;/ftp:get-command&gt;
  - receive:
      endpoint: "ftpClient"
      message:
        body: |
          &lt;ftp:get-command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
            &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
            &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
            &lt;ftp:file path="target/test/hello.txt"&gt;
              &lt;ftp:data&gt;citrus:readFile('classpath:test/hello.txt')&lt;/ftp:data&gt;
            &lt;/ftp:file&gt;
          &lt;/ftp:get-command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="FtpMessageTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="ftpClient"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;ftp:get-command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
                            &lt;ftp:target path="target/test/hello.txt"/&gt;
                        &lt;/ftp:get-command&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;

            &lt;receive endpoint="ftpClient"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;ftp:get-command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                            &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
                            &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
                            &lt;ftp:file path="target/test/hello.txt"&gt;
                              &lt;ftp:data&gt;citrus:readFile('classpath:test/hello.txt')&lt;/ftp:data&gt;
                            &lt;/ftp:file&gt;
                        &lt;/ftp:get-command-result&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When file transfer is complete we are able to verify the file content in a command result. The file content is provided as data string.</p>
</div>
</div>
<div class="sect3">
<h4 id="ftp-client-list"><a class="anchor" href="#ftp-client-list"></a><a class="link" href="#ftp-client-list">20.1.4. List files</a></h4>
<div class="paragraph">
<p>Listing files on the server is possible with the list command.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void ftpMessageTest() {
    $(send(ftpClient)
        .message(FtpMessage.list("test"))
    );

    $(receive(ftpClient)
        .message(FtpMessage.result(getListCommandResult("hello.txt")))
    );
}

private ListCommandResult getListCommandResult(String ... fileNames) {
    ListCommandResult result = new ListCommandResult();
    result.setSuccess(true);
    result.setReplyCode(String.valueOf(226));
    result.setReplyString("@contains('Closing data connection')@");

    ListCommandResult.Files expectedFiles = new ListCommandResult.Files();

    for (String fileName : fileNames) {
        ListCommandResult.Files.File entry = new ListCommandResult.Files.File();
        entry.setPath(fileName);
        expectedFiles.getFiles().add(entry);
    }

    result.setFiles(expectedFiles);

    return result;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="FtpMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="ftpClient"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;ftp:list-command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:target path="test" /&gt;
                        &lt;/ftp:list-command&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="ftpClient"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;ftp:list-command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                            &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
                            &lt;ftp:reply-string&gt;@contains('Closing data connection')@&lt;/ftp:reply-string&gt;
                            &lt;ftp:files&gt;
                              &lt;ftp:file path="hello.txt"/&gt;
                            &lt;/ftp:files&gt;
                        &lt;/ftp:list-command-result&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: FtpMessageTest
actions:
  - send:
      endpoint: "ftpClient"
      message:
        body: |
          &lt;ftp:list-command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
            &lt;ftp:target path="test" /&gt;
          &lt;/ftp:list-command&gt;
  - receive:
      endpoint: "ftpClient"
      message:
        body: |
          &lt;ftp:list-command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
            &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
            &lt;ftp:reply-string&gt;@contains('Closing data connection')@&lt;/ftp:reply-string&gt;
            &lt;ftp:files&gt;
              &lt;ftp:file path="hello.txt"/&gt;
            &lt;/ftp:files&gt;
          &lt;/ftp:list-command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="FtpMessageTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="ftpClient"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;ftp:list-command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:target path="test" /&gt;
                        &lt;/ftp:list-command&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;

            &lt;receive endpoint="ftpClient"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;ftp:list-command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                            &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
                            &lt;ftp:reply-string&gt;@contains('Closing data connection')@&lt;/ftp:reply-string&gt;
                            &lt;ftp:files&gt;
                              &lt;ftp:file path="hello.txt"/&gt;
                            &lt;/ftp:files&gt;
                        &lt;/ftp:list-command-result&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Listing files results in a command result that gives us the list of files on the server directory. We are able to verify that list with respective file paths.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ftp-server"><a class="anchor" href="#ftp-server"></a><a class="link" href="#ftp-server">20.2. FTP server</a></h3>
<div class="paragraph">
<p>Now that we are able to access FTP as a client we might also want to simulate the server side. Therefore Citrus offers a server component that is listening on a port for incoming FTP connections. The server has a default home directory on the local file system specified. But you can also define home directories per user. For now let us have a look at the server configuration component:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public FtpServer ftpListServer() {
    return CitrusEndpoints.ftp()
            .server()
            .port(2222)
            .autoLogin(true)
            .autoStart(true)
            .autoHandleCommands(Stream.of(FTPCmd.MKD.getCommand(),
                                          FTPCmd.PORT.getCommand(),
                                          FTPCmd.TYPE.getCommand()).collect(Collectors.joining(",")))
            .userManagerProperties(new ClassPathResource("citrus.ftp.user.properties"))
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public FtpServer ftpListServer() {
    return CitrusEndpoints.ftp()
            .server()
            .port(2222)
            .autoLogin(true)
            .autoStart(true)
            .autoHandleCommands(Stream.of(FTPCmd.MKD.getCommand(),
                                          FTPCmd.PORT.getCommand(),
                                          FTPCmd.TYPE.getCommand()).collect(Collectors.joining(",")))
            .userManagerProperties(new ClassPathResource("citrus.ftp.user.properties"))
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-ftp:server id="ftpServer"
      port="2222"
      auto-start="true"
      auto-handle-commands="MKD,PORT,TYPE"
      user-manager-properties="classpath:ftp.server.properties"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The ftp server configuration is quite simple. The server starts automatically and binds to a port. With <code>autoLogin</code> and <code>autoHandleCommands</code> we can specify the behavior of the server.
When <code>autoLogin</code> is enabled the server will automatically accept user login requests. With <code>autoHandleCommands</code> we can set a list of commands that should also be handled automatically so we do not
have to verify those commands in a test case. The server will automatically respond with a positive command result then.</p>
</div>
<div class="paragraph">
<p>The user configuration is read from a <strong>user-manager-property</strong> file. Let us have a look at the content of this user management file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># Password is "admin"
ftpserver.user.admin.userpassword=c7ad44cbad762a5da0a452f9e854fdc1e0e7a52a38015f23f3eab1d80b931dd472634dfac71cd34ebc35d16ab7fb8a90c81f975113d6c7538dc69dd8de9077ec
ftpserver.user.admin.homedirectory=target/ftp/user/admin
ftpserver.user.admin.enableflag=true
ftpserver.user.admin.writepermission=true
ftpserver.user.admin.maxloginnumber=0
ftpserver.user.admin.maxloginperip=0
ftpserver.user.admin.idletime=0
ftpserver.user.admin.uploadrate=0
ftpserver.user.admin.downloadrate=0

ftpserver.user.anonymous.userpassword=
ftpserver.user.anonymous.homedirectory=target/ftp/user/anonymous
ftpserver.user.anonymous.enableflag=true
ftpserver.user.anonymous.writepermission=false
ftpserver.user.anonymous.maxloginnumber=20
ftpserver.user.anonymous.maxloginperip=2
ftpserver.user.anonymous.idletime=300
ftpserver.user.anonymous.uploadrate=4800
ftpserver.user.anonymous.downloadrate=4800</code></pre>
</div>
</div>
<div class="paragraph">
<p>The FTP server defines two accounts <code>citrus</code> and <code>anonymous</code>. Clients may authenticate to the server using these credentials. Based on the user account
we can set a user workspace home directory. The server will save incoming stored files to this directory and the server will read retrieved files from that
home directory.</p>
</div>
<div class="paragraph">
<p>In case you want to setup some files in that directory in order to provide it to clients, please copy those files to that home directory prior to the test.</p>
</div>
<div class="paragraph">
<p>The ftp-client connects to the server using the user credentials and is then able to store and retrieve files in a test.</p>
</div>
<div class="paragraph">
<p>You are able to define as many user for the ftp server as you like. In addition to that you have plenty of configuration possibilities per user. Citrus uses the Apache ftp server implementation.
So for more details on configuration capabilities please consult the official Apache ftp server documentation.</p>
</div>
<div class="paragraph">
<p>The following listings show how to handle incoming commands representing different file operation such as store and retrieve. In the test we indicate the server response that we would link the server to respond with. Positive command results accept the client command and execute the command. As we have a fully qualified ftp server running the client can store, retrieve files and create and change directories.
All incoming commands result in a file system change in the user home directory. So stored files are stored in that working directory and retrieved files are read form that directory. In the test case we only receive the commands for validation purpose and to indicate server
success or failure response.</p>
</div>
<div class="sect3">
<h4 id="ftp-server-command"><a class="anchor" href="#ftp-server-command"></a><a class="link" href="#ftp-server-command">20.2.1. FTP server commands</a></h4>
<div class="paragraph">
<p>Now we would like to use the server in a test case. Each operation that arrives on the server is automatically forwarded to the test case for validation. This means that we can
verify any command on the server by using a normal receive action in our test.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void ftpMessageTest() {
    $(receive(ftpServer)
        .message(FtpMessage.command(FTPCmd.MKD).arguments("test"))
    );

    $(send(ftpServer)
        .message(FtpMessage.success())
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="FtpMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="ftpServer"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;ftp:command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:signal&gt;MKD&lt;/ftp:signal&gt;
                            &lt;ftp:arguments&gt;/test&lt;/ftp:arguments&gt;
                        &lt;/ftp:command&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;

        &lt;send endpoint="ftpServer"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;ftp:command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                        &lt;/ftp:command-result&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: FtpMessageTest
actions:
  - receive:
      endpoint: "ftpServer"
      message:
        body: |
          &lt;ftp:command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
            &lt;ftp:signal&gt;MKD&lt;/ftp:signal&gt;
            &lt;ftp:arguments&gt;/test&lt;/ftp:arguments&gt;
          &lt;/ftp:command&gt;
  - send:
      endpoint: "ftpServer"
      message:
        body: |
          &lt;ftp:command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
          &lt;/ftp:command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="FtpMessageTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="ftpServer"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;ftp:command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:signal&gt;MKD&lt;/ftp:signal&gt;
                            &lt;ftp:arguments&gt;/test&lt;/ftp:arguments&gt;
                        &lt;/ftp:command&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/receive&gt;

            &lt;send endpoint="ftpServer"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;ftp:command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                        &lt;/ftp:command-result&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The receive action uses the command signal and argument for validation. In the sample above we receive a <code>MKD</code> signal with argument <code>/test</code> which implies a create directory command. The server respectively the
test case is now able to simulate the response for this command. We respond with a success command result. Following from that the Citrus FTP server implementation will create that directory in the user home directory
and respond to the client with a proper success message.</p>
</div>
<div class="paragraph">
<p>Of course you can also simulate error scenarios here. Just respond in the test with a negative command result.</p>
</div>
</div>
<div class="sect3">
<h4 id="ftp-server-store"><a class="anchor" href="#ftp-server-store"></a><a class="link" href="#ftp-server-store">20.2.2. Store files</a></h4>
<div class="paragraph">
<p>Clients are able to store files on the server component. Each file store operation is executed in the user home directory when the command result is successful. In a test you can verify the <code>STOR</code> signal coming from the client.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void ftpMessageTest() {
    $(receive(ftpServer)
        .message(FtpMessage.command(FTPCmd.STOR).arguments("/test/hello.txt"))
    );

    $(send(ftpServer)
        .message(FtpMessage.success())
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="FtpMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="ftpServer"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;ftp:command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:signal&gt;STOR&lt;/ftp:signal&gt;
                            &lt;ftp:arguments&gt;/test/hello.txt&lt;/ftp:arguments&gt;
                        &lt;/ftp:command&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;

        &lt;send endpoint="ftpServer"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;ftp:command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                        &lt;/ftp:command-result&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: FtpMessageTest
actions:
  - receive:
      endpoint: "ftpServer"
      message:
        body: |
          &lt;ftp:command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
            &lt;ftp:signal&gt;STOR&lt;/ftp:signal&gt;
            &lt;ftp:arguments&gt;/test/hello.txt&lt;/ftp:arguments&gt;
          &lt;/ftp:command&gt;
  - send:
      endpoint: "ftpServer"
      message:
        body: |
          &lt;ftp:command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
          &lt;/ftp:command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="FtpMessageTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="ftpServer"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;ftp:command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:signal&gt;STOR&lt;/ftp:signal&gt;
                            &lt;ftp:arguments&gt;/test/hello.txt&lt;/ftp:arguments&gt;
                        &lt;/ftp:command&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/receive&gt;

            &lt;send endpoint="ftpServer"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;ftp:command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                        &lt;/ftp:command-result&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that you should find a new file in the user home directory with the given file path. The file transfer is automatically handled by the Citrus FTP server component.</p>
</div>
</div>
<div class="sect3">
<h4 id="ftp-server-retrieve"><a class="anchor" href="#ftp-server-retrieve"></a><a class="link" href="#ftp-server-retrieve">20.2.3. Retrieve files</a></h4>
<div class="paragraph">
<p>Clients should be able to get files from the server by using get/retrieve commands. In the request the client needs to give the target file path based on the user home directory.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void ftpMessageTest() {
    $(receive(ftpServer)
        .message(FtpMessage.command(FTPCmd.RETR).arguments("/test/hello.txt"))
    );

    $(send(ftpServer)
        .message(FtpMessage.success())
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="FtpMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="ftpServer"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;ftp:command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:signal&gt;RETR&lt;/ftp:signal&gt;
                            &lt;ftp:arguments&gt;/test/hello.txt&lt;/ftp:arguments&gt;
                        &lt;/ftp:command&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;

        &lt;send endpoint="ftpServer"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;ftp:command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                        &lt;/ftp:command-result&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: FtpMessageTest
actions:
  - receive:
      endpoint: "ftpServer"
      message:
        body: |
          &lt;ftp:command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
            &lt;ftp:signal&gt;RETR&lt;/ftp:signal&gt;
            &lt;ftp:arguments&gt;/test/hello.txt&lt;/ftp:arguments&gt;
          &lt;/ftp:command&gt;
  - send:
      endpoint: "ftpServer"
      message:
        body: |
          &lt;ftp:command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
          &lt;/ftp:command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="FtpMessageTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="ftpServer"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;ftp:command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:signal&gt;RETR&lt;/ftp:signal&gt;
                            &lt;ftp:arguments&gt;/test/hello.txt&lt;/ftp:arguments&gt;
                        &lt;/ftp:command&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/receive&gt;

            &lt;send endpoint="ftpServer"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;ftp:command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                        &lt;/ftp:command-result&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The file request is verified with proper signal and arguments. When the server command result is positive the Citrus FTP server will transfer the file content to the calling client.</p>
</div>
</div>
<div class="sect3">
<h4 id="ftp-server-list"><a class="anchor" href="#ftp-server-list"></a><a class="link" href="#ftp-server-list">20.2.4. List files</a></h4>
<div class="paragraph">
<p>When clients request for listing files on the server we get a list command on the server.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void ftpMessageTest() {
    $(receive(ftpServer)
        .message(FtpMessage.command(FTPCmd.LIST).arguments("test"))
    );

    $(send(ftpServer)
        .message(FtpMessage.success())
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="FtpMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="ftpServer"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;ftp:command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:signal&gt;LIST&lt;/ftp:signal&gt;
                            &lt;ftp:arguments&gt;test&lt;/ftp:arguments&gt;
                        &lt;/ftp:command&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;

        &lt;send endpoint="ftpServer"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;ftp:command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                        &lt;/ftp:command-result&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: FtpMessageTest
actions:
  - receive:
      endpoint: "ftpServer"
      message:
        body: |
          &lt;ftp:command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
            &lt;ftp:signal&gt;LIST&lt;/ftp:signal&gt;
            &lt;ftp:arguments&gt;test&lt;/ftp:arguments&gt;
          &lt;/ftp:command&gt;
  - send:
      endpoint: "ftpServer"
      message:
        body: |
          &lt;ftp:command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
          &lt;/ftp:command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="FtpMessageTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="ftpServer"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;ftp:command xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:signal&gt;LIST&lt;/ftp:signal&gt;
                            &lt;ftp:arguments&gt;test&lt;/ftp:arguments&gt;
                        &lt;/ftp:command&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/receive&gt;

            &lt;send endpoint="ftpServer"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;ftp:command-result xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
                            &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                        &lt;/ftp:command-result&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the list command is verified with proper signal and arguments that specifies the target folder to list the files for. When the command result is positive the
FTP server implementation will send back a proper list command result for that given directory in the user home directory.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sftp"><a class="anchor" href="#sftp"></a><a class="link" href="#sftp">21. SFTP/SCP support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>With Citrus it is possible to start your own sftp server for accepting incoming client requests. You can also use Citrus as a SFTP client to send FTP commands. The next sections deal with SFTP connectivity.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The SFTP components in Citrus are maintained in their own Maven module. So you should add the module as Maven dependency to your project accordingly.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-ftp&lt;/artifactId&gt;
  &lt;version&gt;2.7.6&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="sftp-client"><a class="anchor" href="#sftp-client"></a><a class="link" href="#sftp-client">21.1. SFTP client</a></h3>
<div class="paragraph">
<p>We want to use Citrus to connect to some FTP server using secure file transfer and authentication. Citrus offers a client component doing exactly this SFTP client connection.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public SftpClient sftpClient() {
    return CitrusEndpoints.sftp()
            .client()
            .strictHostChecking(false)
            .port(2222)
            .username("citrus")
            .privateKeyPath("classpath:ssh/citrus.priv")
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SftpClient sftpClient() {
    return CitrusEndpoints.sftp()
            .client()
            .strictHostChecking(false)
            .port(2222)
            .username("citrus")
            .privateKeyPath("classpath:ssh/citrus.priv")
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-sftp="http://www.citrusframework.org/schema/sftp/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/sftp/config
           http://www.citrusframework.org/schema/sftp/config/citrus-sftp-config.xsd"&gt;

    &lt;citrus-sftp:client id="sftpClient"
           strict-host-checking="false"
           port="2222"
           username="citrus"
           private-key-path="classpath:ssh/citrus.priv"
           timeout="10000"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Citrus provides a customized SFTP configuration schema for the Spring XML application context configurations.
Simply include the <code>citrus-sftp</code> namespace in the configuration XML files as seen in the example above.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The configuration above describes a Citrus sftp client. The sftp-client connects to the server using the user credentials
and/or the private key authentication. The client will automatically authenticate to the server when opening a new connection.
As the Citrus stfp client supports various authentication methods, the following order is default: <code>publickey,password,keyboard-interactive</code>.
You&#8217;re able to configure the default order with the <code>preferred-authentications</code> attribute in XML or the
<code>preferredAuthentications</code> method in Java.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public SftpClient sftpClient() {
    return CitrusEndpoints.sftp()
            .client()
            .strictHostChecking(false)
            .port(2222)
            .username("citrus")
            .privateKeyPath("classpath:ssh/citrus.priv")
            .preferredAuthentications("publickey,password,gssapi-with-mic,keyboard-interactive")
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SftpClient sftpClient() {
    return CitrusEndpoints.sftp()
            .client()
            .strictHostChecking(false)
            .port(2222)
            .username("citrus")
            .privateKeyPath("classpath:ssh/citrus.priv")
            .preferredAuthentications("publickey,password,gssapi-with-mic,keyboard-interactive")
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-sftp="http://www.citrusframework.org/schema/sftp/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/sftp/config
           http://www.citrusframework.org/schema/sftp/config/citrus-sftp-config.xsd"&gt;

    &lt;citrus-sftp:client id="sftpClient"
           strict-host-checking="false"
           port="2222"
           username="citrus"
           private-key-path="classpath:ssh/citrus.priv",
           preferred-authentications="publickey,password,gssapi-with-mic,keyboard-interactive"
           timeout="10000"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="sftp-client-commands"><a class="anchor" href="#sftp-client-commands"></a><a class="link" href="#sftp-client-commands">21.1.1. SFTP client commands</a></h4>
<div class="paragraph">
<p>In a test case you are now able to use the client to push commands to the server.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sftpTest() {
    when(send()
        .endpoint(sftpClient)
        .message(FtpMessage.command(FTPCmd.MKD).arguments("test"))
    );

    CommandResult result = new CommandResult();
    result.setSuccess(true);
    result.setReplyCode(String.valueOf(257));
    result.setReplyString("257 Pathname created");

    then(receive()
        .endpoint(sftpClient)
        .message(FtpMessage.result(result))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SftpTest" xmlns="http://citrusframework.org/schema/xml/testcase"
                                xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
    &lt;actions&gt;
      &lt;send endpoint="sftpClient"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:command&gt;
                &lt;ftp:signal&gt;MKD&lt;/ftp:signal&gt;
                &lt;ftp:arguments&gt;test&lt;/ftp:arguments&gt;
              &lt;/ftp:command&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
      &lt;receive endpoint="sftpClient"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                &lt;ftp:reply-code&gt;257&lt;/ftp:reply-code&gt;
                &lt;ftp:reply-string&gt;257 Pathname created&lt;/ftp:reply-string&gt;
              &lt;/ftp:command-result&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SftpTest
actions:
  - send:
      endpoint: sftpClient
      message:
        body:
          data: |
            &lt;ftp:command&gt;
              &lt;ftp:signal&gt;MKD&lt;/ftp:signal&gt;
              &lt;ftp:arguments&gt;test&lt;/ftp:arguments&gt;
            &lt;/ftp:command&gt;
  - receive:
      endpoint: sftpClient
      message:
        body:
          data: |
            &lt;ftp:command-result&gt;
              &lt;ftp:success&gt;true&lt;/ftp:success&gt;
              &lt;ftp:reply-code&gt;257&lt;/ftp:reply-code&gt;
              &lt;ftp:reply-string&gt;257 Pathname created&lt;/ftp:reply-string&gt;
            &lt;/ftp:command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/ftp/message
              http://www.citrusframework.org/schema/ftp/citrus-ftp-message.xsd"&gt;
  &lt;testcase name="SftpTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="sftpClient"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:command&gt;
                &lt;ftp:signal&gt;MKD&lt;/ftp:signal&gt;
                &lt;ftp:arguments&gt;test&lt;/ftp:arguments&gt;
              &lt;/ftp:command&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="sftpClient"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                &lt;ftp:reply-code&gt;257&lt;/ftp:reply-code&gt;
                &lt;ftp:reply-string&gt;257 Pathname created&lt;/ftp:reply-string&gt;
              &lt;/ftp:command-result&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see most of the sftp communication parameters are specified in a ftp command message. Citrus automatically converts those information to proper FTP commands and response messages.</p>
</div>
</div>
<div class="sect3">
<h4 id="sftp-client-store"><a class="anchor" href="#sftp-client-store"></a><a class="link" href="#sftp-client-store">21.1.2. Store files</a></h4>
<div class="paragraph">
<p>The client is able to store files on the server using file transfer.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sftpTest() {
    when(send()
        .endpoint(sftpClient)
        .message(FtpMessage.put("test/hello.txt", DataType.ASCII).arguments(""))
    );

    PutCommandResult result = new PutCommandResult();
    result.setSuccess(true);
    result.setReplyCode(String.valueOf(226));
    result.setReplyString("@contains(Transfer complete)@");

    then(receive()
        .endpoint(sftpClient)
        .message(FtpMessage.result(result))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SftpTest" xmlns="http://citrusframework.org/schema/xml/testcase"
                                xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
    &lt;actions&gt;
      &lt;send endpoint="sftpClient"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:put-command&gt;
                &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
                &lt;ftp:target path="/test/hello.txt"/&gt;
              &lt;/ftp:put-command&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
      &lt;receive endpoint="sftpClient"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:put-command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
                &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
              &lt;/ftp:put-command-result&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SftpTest
actions:
  - send:
      endpoint: sftpClient
      message:
        body:
          data: |
            &lt;ftp:put-command&gt;
              &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
              &lt;ftp:target path="/test/hello.txt"/&gt;
            &lt;/ftp:put-command&gt;
  - receive:
      endpoint: sftpClient
      message:
        body:
          data: |
            &lt;ftp:put-command-result&gt;
              &lt;ftp:success&gt;true&lt;/ftp:success&gt;
              &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
              &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
            &lt;/ftp:put-command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/ftp/message
              http://www.citrusframework.org/schema/ftp/citrus-ftp-message.xsd"&gt;
  &lt;testcase name="SftpTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="sftpClient"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:put-command&gt;
                &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
                &lt;ftp:target path="/test/hello.txt"/&gt;
              &lt;/ftp:put-command&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="sftpClient"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:put-command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
                &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
              &lt;/ftp:put-command-result&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The file store operation uses the put command as message payload when sending the file request. The file content is loaded from external file resource. You can choose the transfer type <code>ASCII</code> and <code>BINARY</code>.
When the file is stored on server side we receive a success result message with respective reply code and string for validation.</p>
</div>
</div>
<div class="sect3">
<h4 id="sftp-client-retrieve"><a class="anchor" href="#sftp-client-retrieve"></a><a class="link" href="#sftp-client-retrieve">21.1.3. Retrieve files</a></h4>
<div class="paragraph">
<p>We are able to retrieve files from a SFTP server. We need to specify the target file path that we want to get on the server user home directory.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sftpTest() {
    when(send()
        .endpoint(sftpClient)
        .message(FtpMessage.get("test/hello.txt", "target/test/hello.txt", DataType.ASCII))
    );

    then(receive()
        .endpoint(sftpClient)
        .message(FtpMessage.result(getRetrieveFileCommandResult("target/test/hello.txt", new ClassPathResource("test/hello.txt"))))
    );
}

private GetCommandResult getRetrieveFileCommandResult(String path, Resource content) throws IOException {
    GetCommandResult result = new GetCommandResult();
    result.setSuccess(true);
    result.setReplyCode(String.valueOf(226));
    result.setReplyString("@contains('Transfer complete')@");

    GetCommandResult.File entryResult = new GetCommandResult.File();
    entryResult.setPath(path);
    entryResult.setData(FileUtils.readToString(content));
    result.setFile(entryResult);

    return result;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SftpTest" xmlns="http://citrusframework.org/schema/xml/testcase"
                                xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
    &lt;actions&gt;
      &lt;send endpoint="sftpClient"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:get-command&gt;
                &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
                &lt;ftp:target path="target/test/hello.txt"/&gt;
              &lt;/ftp:get-command&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
      &lt;receive endpoint="sftpClient"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:get-command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
                &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
                &lt;ftp:file path="target/test/hello.txt"&gt;
                  &lt;ftp:data&gt;citrus:readFile('classpath:test/hello.txt')&lt;/ftp:data&gt;
                &lt;/ftp:file&gt;
              &lt;/ftp:get-command-result&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SftpTest
actions:
  - send:
      endpoint: sftpClient
      message:
        body:
          data: |
            &lt;ftp:get-command&gt;
              &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
              &lt;ftp:target path="target/test/hello.txt"/&gt;
            &lt;/ftp:get-command&gt;
  - receive:
      endpoint: sftpClient
      message:
        body:
          data: |
            &lt;ftp:get-command-result&gt;
              &lt;ftp:success&gt;true&lt;/ftp:success&gt;
              &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
              &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
              &lt;ftp:file path="target/test/hello.txt"&gt;
                &lt;ftp:data&gt;citrus:readFile('classpath:test/hello.txt')&lt;/ftp:data&gt;
              &lt;/ftp:file&gt;
            &lt;/ftp:get-command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/ftp/message
              http://www.citrusframework.org/schema/ftp/citrus-ftp-message.xsd"&gt;
  &lt;testcase name="SftpTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="sftpClient"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:get-command&gt;
                &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
                &lt;ftp:target path="target/test/hello.txt"/&gt;
              &lt;/ftp:get-command&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="sftpClient"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:get-command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
                &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
                &lt;ftp:file path="target/test/hello.txt"&gt;
                  &lt;ftp:data&gt;citrus:readFile('classpath:test/hello.txt')&lt;/ftp:data&gt;
                &lt;/ftp:file&gt;
              &lt;/ftp:get-command-result&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When file transfer is complete we are able to verify the file content in a command result. The file content is provided as data string.</p>
</div>
</div>
<div class="sect3">
<h4 id="sftp-client-list"><a class="anchor" href="#sftp-client-list"></a><a class="link" href="#sftp-client-list">21.1.4. List files</a></h4>
<div class="paragraph">
<p>Listing files on the server is possible with the list command.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sftpTest() {
    when(send()
        .endpoint(sftpClient)
        .message(FtpMessage.list("test"))
    );

    then(receive()
        .endpoint(sftpClient)
        .message(FtpMessage.result(getListCommandResult("hello.txt")))
    );
}

private ListCommandResult getListCommandResult(String ... fileNames) {
    ListCommandResult result = new ListCommandResult();
    result.setSuccess(true);
    result.setReplyCode(String.valueOf(226));
    result.setReplyString("@contains('Closing data connection')@");

    ListCommandResult.Files.File currentDir = new ListCommandResult.Files.File();
    currentDir.setPath(".");
    expectedFiles.getFiles().add(currentDir);

    ListCommandResult.Files.File parentDir = new ListCommandResult.Files.File();
    parentDir.setPath("..");
    expectedFiles.getFiles().add(parentDir);

    ListCommandResult.Files expectedFiles = new ListCommandResult.Files();

    for (String fileName : fileNames) {
        ListCommandResult.Files.File entry = new ListCommandResult.Files.File();
        entry.setPath(fileName);
        expectedFiles.getFiles().add(entry);
    }

    result.setFiles(expectedFiles);

    return result;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SftpTest" xmlns="http://citrusframework.org/schema/xml/testcase"
                                xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
    &lt;actions&gt;
      &lt;send endpoint="sftpClient"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:list-command&gt;
                &lt;ftp:target path="test" /&gt;
              &lt;/ftp:list-command&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
      &lt;receive endpoint="sftpClient"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:list-command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                &lt;ftp:reply-code&gt;150&lt;/ftp:reply-code&gt;
                &lt;ftp:reply-string&gt;List files complete&lt;/ftp:reply-string&gt;
                &lt;ftp:files&gt;
                  &lt;ftp:file path="."/&gt;
                  &lt;ftp:file path=".."/&gt;
                  &lt;ftp:file path="hello.txt"/&gt;
                &lt;/ftp:files&gt;
              &lt;/ftp:list-command-result&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SftpTest
actions:
  - send:
      endpoint: sftpClient
      message:
        body:
          data: |
            &lt;ftp:list-command&gt;
              &lt;ftp:target path="test" /&gt;
            &lt;/ftp:list-command&gt;
  - receive:
      endpoint: sftpClient
      message:
        body:
          data: |
            &lt;ftp:list-command-result&gt;
              &lt;ftp:success&gt;true&lt;/ftp:success&gt;
              &lt;ftp:reply-code&gt;150&lt;/ftp:reply-code&gt;
              &lt;ftp:reply-string&gt;List files complete&lt;/ftp:reply-string&gt;
              &lt;ftp:files&gt;
                &lt;ftp:file path="."/&gt;
                &lt;ftp:file path=".."/&gt;
                &lt;ftp:file path="hello.txt"/&gt;
              &lt;/ftp:files&gt;
            &lt;/ftp:list-command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/ftp/message
              http://www.citrusframework.org/schema/ftp/citrus-ftp-message.xsd"&gt;
  &lt;testcase name="SftpTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="sftpClient"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:list-command&gt;
                &lt;ftp:target path="test" /&gt;
              &lt;/ftp:list-command&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="sftpClient"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:list-command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                &lt;ftp:reply-code&gt;150&lt;/ftp:reply-code&gt;
                &lt;ftp:reply-string&gt;List files complete&lt;/ftp:reply-string&gt;
                &lt;ftp:files&gt;
                  &lt;ftp:file path="."/&gt;
                  &lt;ftp:file path=".."/&gt;
                  &lt;ftp:file path="hello.txt"/&gt;
                &lt;/ftp:files&gt;
              &lt;/ftp:list-command-result&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Listing files results in a command result that gives us the list of files on the server directory. We are able to verify that list with respective file paths.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sftp-server"><a class="anchor" href="#sftp-server"></a><a class="link" href="#sftp-server">21.2. SFTP server</a></h3>
<div class="paragraph">
<p>Now that we are able to access SFTP as a client we might also want to simulate the server side. Therefore Citrus offers a server component that is listening on a port for incoming SFTP connections. The server has a default home directory on the local file system specified. But you can also define home directories per user. For now let us have a look at the server configuration component:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public SftpServer sftpServer() {
    return CitrusEndpoints.sftp()
            .server()
            .port(2222)
            .autoStart(true)
            .user("citrus")
            .password("admin")
            .allowedKeyPath("classpath:ssh/citrus_pub.pem")
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SftpServer sftpServer() {
    return CitrusEndpoints.sftp()
            .server()
            .port(2222)
            .autoStart(true)
            .user("citrus")
            .password("admin")
            .allowedKeyPath("classpath:ssh/citrus_pub.pem")
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-sftp="http://www.citrusframework.org/schema/sftp/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/sftp/config
           http://www.citrusframework.org/schema/sftp/config/citrus-sftp-config.xsd"&gt;


    &lt;citrus-sftp:server id="sftpServer"
                   port="2222"
                   auto-start="true"
                   user="citrus"
                   password="admin"
                   allowed-key-path="classpath:ssh/citrus_pub.pem"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>sftpServer</strong> is a small but fully qualified SFTP server implementation in Citrus. The server receives a <code>user</code> that defines the user account and its home directory. All commands
will be performed in this user home directory. You can set the user home directory using the <code>userHomePath</code> attribute on the server. By default this is a directory located in <code>${user.dir}/target/{serverName}/home/{user}</code>.</p>
</div>
<div class="paragraph">
<p>In case you want to setup some files in that directory in order to provide it to clients, please copy those files to that home directory prior to the test. The server adds the public key to the list of allowed keys.</p>
</div>
<div class="paragraph">
<p>The following listings show how to handle incoming commands representing different file operation such as store and retrieve. In the test we indicate the server response that we would link the server to respond with. Positive command results accept the client command and execute the command. As we have a fully qualified sftp server running the client can store, retrieve files and create and change directories.
All incoming commands result in a file system change in the user home directory. So stored files are stored in that working directory and retrieved files are read form that directory. In the test case we only receive the commands for validation purpose and to indicate server
success or failure response.</p>
</div>
<div class="sect3">
<h4 id="sftp-server-command"><a class="anchor" href="#sftp-server-command"></a><a class="link" href="#sftp-server-command">21.2.1. SFTP server commands</a></h4>
<div class="paragraph">
<p>Now we would like to use the server in a test case. Each operation that arrives on the server is automatically forwarded to the test case for validation. This means that we can
verify any command on the server by using a normal receive action in our test.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sftpTest() {
    when(receive()
        .endpoint(sftpServer)
        .message(FtpMessage.command(FTPCmd.MKD).arguments("test"))
    );

    then(send()
        .endpoint(sftpServer)
        .message(FtpMessage.success())
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SftpTest" xmlns="http://citrusframework.org/schema/xml/testcase"
                                xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
    &lt;actions&gt;
      &lt;receive endpoint="sftpServer"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:command&gt;
                &lt;ftp:signal&gt;MKD&lt;/ftp:signal&gt;
                &lt;ftp:arguments&gt;test&lt;/ftp:arguments&gt;
              &lt;/ftp:command&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
      &lt;send endpoint="sftpServer"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
              &lt;/ftp:command-result&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SftpTest
actions:
  - receive:
      endpoint: sftpServer
      message:
        body:
          data: |
            &lt;ftp:command&gt;
              &lt;ftp:signal&gt;MKD&lt;/ftp:signal&gt;
              &lt;ftp:arguments&gt;test&lt;/ftp:arguments&gt;
            &lt;/ftp:command&gt;
  - send:
      endpoint: sftpServer
      message:
        body:
          data: |
            &lt;ftp:command-result&gt;
              &lt;ftp:success&gt;true&lt;/ftp:success&gt;
            &lt;/ftp:command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/ftp/message
              http://www.citrusframework.org/schema/ftp/citrus-ftp-message.xsd"&gt;
  &lt;testcase name="SftpTest"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="sftpServer"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:command&gt;
                &lt;ftp:signal&gt;MKD&lt;/ftp:signal&gt;
                &lt;ftp:arguments&gt;/test&lt;/ftp:arguments&gt;
              &lt;/ftp:command&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/receive&gt;

        &lt;send endpoint="sftpServer"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
              &lt;/ftp:command-result&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>receive</code> action uses the command signal and argument for validation. In the sample above we receive a <code>MKD</code> signal with argument <code>/test</code> which implies a create directory command. The server respectively the
test case is now able to simulate the response for this command. We respond with a success command result. Following from that the Citrus SFTP server implementation will create that directory in the user home directory
and respond to the client with a proper success message.</p>
</div>
<div class="paragraph">
<p>Of course, you can also simulate error scenarios here. Just respond in the test with a negative command result.</p>
</div>
</div>
<div class="sect3">
<h4 id="sftp-server-store"><a class="anchor" href="#sftp-server-store"></a><a class="link" href="#sftp-server-store">21.2.2. Store files</a></h4>
<div class="paragraph">
<p>Clients are able to store files on the server component. Each file store operation is executed in the user home directory when the command result is successful. In a test you can verify the <code>STOR</code> signal coming from the client.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sftpTest() {
    when(receive()
        .endpoint(sftpServer)
        .message(put("@ignore@","/test/hello.txt", DataType.ASCII))
    );

    then(send()
        .endpoint(sftpServer)
        .message(FtpMessage.success())
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SftpTest" xmlns="http://citrusframework.org/schema/xml/testcase"
                                xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
    &lt;actions&gt;
      &lt;receive endpoint="sftpServer"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:put-command&gt;
                &lt;ftp:signal&gt;STOR&lt;/ftp:signal&gt;
                &lt;ftp:file path="@ignore@" type="ASCII"/&gt;
                &lt;ftp:target path="/test/hello.txt"/&gt;
              &lt;/ftp:put-command&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
      &lt;send endpoint="sftpServer"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
              &lt;/ftp:command-result&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SftpTest
actions:
  - receive:
      endpoint: sftpServer
      message:
        body:
          data: |
            &lt;ftp:put-command&gt;
              &lt;ftp:signal&gt;STOR&lt;/ftp:signal&gt;
              &lt;ftp:file path="@ignore@" type="ASCII"/&gt;
              &lt;ftp:target path="/test/hello.txt"/&gt;
            &lt;/ftp:put-command&gt;
  - send:
      endpoint: sftpServer
      message:
        body:
          data: |
            &lt;ftp:command-result&gt;
              &lt;ftp:success&gt;true&lt;/ftp:success&gt;
            &lt;/ftp:command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/ftp/message
              http://www.citrusframework.org/schema/ftp/citrus-ftp-message.xsd"&gt;
  &lt;testcase name="SftpTest"&gt;
    &lt;actions&gt;
        &lt;echo&gt;
          &lt;message&gt;Store file on server&lt;/message&gt;
        &lt;/echo&gt;

        &lt;receive endpoint="sftpServer"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:put-command&gt;
                &lt;ftp:signal&gt;STOR&lt;/ftp:signal&gt;
                &lt;ftp:file path="@ignore@" type="ASCII"/&gt;
                &lt;ftp:target path="/test/hello.txt"/&gt;
              &lt;/ftp:put-command&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/receive&gt;

        &lt;send endpoint="sftpServer"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
              &lt;/ftp:command-result&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that you should find a new file in the user home directory with the given file path. The file transfer is automatically handled by the Citrus SFTP server component.</p>
</div>
</div>
<div class="sect3">
<h4 id="sftp-server-retrieve"><a class="anchor" href="#sftp-server-retrieve"></a><a class="link" href="#sftp-server-retrieve">21.2.3. Retrieve files</a></h4>
<div class="paragraph">
<p>Clients should be able to get files from the server by using get/retrieve commands. In the request the client needs to give the target file path based on the user home directory.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sftpTest() {
    when(receive()
        .endpoint(sftpServer)
        .message(FtpMessage.get("/test/hello.txt", "@ignore@", DataType.ASCII))
    );

    then(send()
        .endpoint(sftpServer)
        .message(FtpMessage.success())
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SftpTest" xmlns="http://citrusframework.org/schema/xml/testcase"
                                xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
    &lt;actions&gt;
      &lt;receive endpoint="sftpServer"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:get-command&gt;
                &lt;ftp:signal&gt;RETR&lt;/ftp:signal&gt;
                &lt;ftp:file path="/test/hello.txt" type="ASCII"/&gt;
                &lt;ftp:target path="@ignore@"/&gt;
              &lt;/ftp:get-command&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
      &lt;send endpoint="sftpServer"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
              &lt;/ftp:command-result&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SftpTest
actions:
  - receive:
      endpoint: sftpServer
      message:
        body:
          data: |
            &lt;ftp:get-command&gt;
              &lt;ftp:signal&gt;RETR&lt;/ftp:signal&gt;
              &lt;ftp:file path="/test/hello.txt" type="ASCII"/&gt;
              &lt;ftp:target path="@ignore@"/&gt;
            &lt;/ftp:get-command&gt;
  - send:
      endpoint: sftpServer
      message:
        body:
          data: |
            &lt;ftp:command-result&gt;
              &lt;ftp:success&gt;true&lt;/ftp:success&gt;
            &lt;/ftp:command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/ftp/message
              http://www.citrusframework.org/schema/ftp/citrus-ftp-message.xsd"&gt;
  &lt;testcase name="SftpTest"&gt;
    &lt;actions&gt;
        &lt;echo&gt;
          &lt;message&gt;Retrieve file from server&lt;/message&gt;
        &lt;/echo&gt;

        &lt;receive endpoint="sftpServer"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:get-command&gt;
                &lt;ftp:signal&gt;RETR&lt;/ftp:signal&gt;
                &lt;ftp:file path="/test/hello.txt" type="ASCII"/&gt;
                &lt;ftp:target path="@ignore@"/&gt;
              &lt;/ftp:get-command&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/receive&gt;

        &lt;send endpoint="sftpServer"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
              &lt;/ftp:command-result&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The file request is verified with proper signal and arguments. When the server command result is positive the Citrus SFTP server will transfer the file content to the calling client.</p>
</div>
</div>
<div class="sect3">
<h4 id="sftp-server-list"><a class="anchor" href="#sftp-server-list"></a><a class="link" href="#sftp-server-list">21.2.4. List files</a></h4>
<div class="paragraph">
<p>When clients request for listing files on the server we get a list command on the server.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void sftpTest() {
    when(receive()
        .endpoint(sftpServer)
        .message(FtpMessage.command(FTPCmd.LIST).arguments("test"))
    );

    then(send()
        .endpoint(sftpServer)
        .message(FtpMessage.success())
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SftpTest" xmlns="http://citrusframework.org/schema/xml/testcase"
                                xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
    &lt;actions&gt;
      &lt;receive endpoint="sftpServer"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:command&gt;
                &lt;ftp:signal&gt;LIST&lt;/ftp:signal&gt;
                &lt;ftp:arguments&gt;test&lt;/ftp:arguments&gt;
              &lt;/ftp:command&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
      &lt;send endpoint="sftpServer"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
              &lt;/ftp:command-result&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SftpTest
actions:
  - receive:
      endpoint: sftpServer
      message:
        body:
          data: |
            &lt;ftp:command&gt;
              &lt;ftp:signal&gt;LIST&lt;/ftp:signal&gt;
              &lt;ftp:arguments&gt;test&lt;/ftp:arguments&gt;
            &lt;/ftp:command&gt;
  - send:
      endpoint: sftpServer
      message:
        body:
          data: |
            &lt;ftp:command-result&gt;
              &lt;ftp:success&gt;true&lt;/ftp:success&gt;
            &lt;/ftp:command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/ftp/message
              http://www.citrusframework.org/schema/ftp/citrus-ftp-message.xsd"&gt;
  &lt;testcase name="SftpTest"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="sftpServer"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:command&gt;
                &lt;ftp:signal&gt;LIST&lt;/ftp:signal&gt;
                &lt;ftp:arguments&gt;test&lt;/ftp:arguments&gt;
              &lt;/ftp:command&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/receive&gt;

        &lt;send endpoint="sftpServer"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
              &lt;/ftp:command-result&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the list command is verified with proper signal and arguments that specifies the target folder to list the files for. When the command result is positive the
SFTP server implementation will send back a proper list command result for that given directory in the user home directory.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scp-client"><a class="anchor" href="#scp-client"></a><a class="link" href="#scp-client">21.3. SCP client</a></h3>
<div class="paragraph">
<p>We want to use Citrus to connect to some FTP server using secure file copy with SCP. Citrus offers a client component doing exactly this SCP client connection.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public ScpClient scpClient() {
    return CitrusEndpoints.scp()
            .client()
            .port(2222)
            .username("citrus")
            .password("admin")
            .privateKeyPath("classpath:ssh/citrus.priv")
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public ScpClient scpClient() {
    return CitrusEndpoints.scp()
            .client()
            .port(2222)
            .username("citrus")
            .password("admin")
            .privateKeyPath("classpath:ssh/citrus.priv")
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus-scp="http://www.citrusframework.org/schema/scp/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/scp/config
           http://www.citrusframework.org/schema/scp/config/citrus-scp-config.xsd"&gt;

    &lt;citrus-scp:client id="scpClient"
               port="2222"
               username="citrus"
               password="admin"
               private-key-path="classpath:ssh/citrus.priv"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Citrus provides a customized SCP configuration schema for the Spring XML application context configuration files.
Simply include the <code>citrus-scp</code> namespace in the configuration XML files as seen in the example above.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The configuration above describes a Citrus scp client. The scp-client connects to the server using the user credentials and/or the private key authentication. The client will automatically authenticate to the server when opening a new connection.</p>
</div>
<div class="sect3">
<h4 id="scp-client-store"><a class="anchor" href="#scp-client-store"></a><a class="link" href="#scp-client-store">21.3.1. Store files</a></h4>
<div class="paragraph">
<p>The client is able to store files on the server using file transfer.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void scpTest() {
    when(send()
        .endpoint(scpClient)
        .message(FtpMessage.put("test/hello.txt", DataType.ASCII).arguments(""))
    );

    PutCommandResult result = new PutCommandResult();
    result.setSuccess(true);
    result.setReplyCode(String.valueOf(226));
    result.setReplyString("@contains(Transfer complete)@");

    then(receive()
        .endpoint(scpClient)
        .message(FtpMessage.result(result))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ScpTest" xmlns="http://citrusframework.org/schema/xml/testcase"
                                xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
    &lt;actions&gt;
      &lt;send endpoint="scpClient"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:put-command&gt;
                &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
                &lt;ftp:target path="/test/hello.txt"/&gt;
              &lt;/ftp:put-command&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
      &lt;receive endpoint="scpClient"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:put-command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
                &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
              &lt;/ftp:put-command-result&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ScpTest
actions:
  - send:
      endpoint: scpClient
      message:
        body:
          data: |
            &lt;ftp:put-command&gt;
              &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
              &lt;ftp:target path="/test/hello.txt"/&gt;
            &lt;/ftp:put-command&gt;
  - receive:
      endpoint: scpClient
      message:
        body:
          data: |
            &lt;ftp:put-command-result&gt;
              &lt;ftp:success&gt;true&lt;/ftp:success&gt;
              &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
              &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
            &lt;/ftp:put-command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/ftp/message
              http://www.citrusframework.org/schema/ftp/citrus-ftp-message.xsd"&gt;
  &lt;testcase name="ScpTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="scpClient"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:put-command&gt;
                &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
                &lt;ftp:target path="/test/hello.txt"/&gt;
              &lt;/ftp:put-command&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="scpClient"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:put-command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
                &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
              &lt;/ftp:put-command-result&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The file store operation uses the put command as message payload when sending the file request. The file content is loaded from external file resource. You can choose the transfer type <code>ASCII</code> and <code>BINARY</code>.
When the file is stored on server side we receive a success result message with respective reply code and string for validation.</p>
</div>
</div>
<div class="sect3">
<h4 id="scp-client-retrieve"><a class="anchor" href="#scp-client-retrieve"></a><a class="link" href="#scp-client-retrieve">21.3.2. Retrieve files</a></h4>
<div class="paragraph">
<p>We are able to retrieve files from a SFTP server. We need to specify the target file path that we want to get on the server user home directory.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void scpTest() {
    when(send()
        .endpoint(scpClient)
        .message(FtpMessage.get("test/hello.txt", "target/test/hello.txt", DataType.ASCII))
    );

    then(receive()
        .endpoint(scpClient)
        .message(FtpMessage.result(getRetrieveFileCommandResult("target/test/hello.txt", new ClassPathResource("test/hello.txt"))))
    );
}

private GetCommandResult getRetrieveFileCommandResult(String path, Resource content) throws IOException {
    GetCommandResult result = new GetCommandResult();
    result.setSuccess(true);
    result.setReplyCode(String.valueOf(226));
    result.setReplyString("@contains('Transfer complete')@");

    GetCommandResult.File entryResult = new GetCommandResult.File();
    entryResult.setPath(path);
    entryResult.setData(FileUtils.readToString(content));
    result.setFile(entryResult);

    return result;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ScpTest" xmlns="http://citrusframework.org/schema/xml/testcase"
                                xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"&gt;
    &lt;actions&gt;
      &lt;send endpoint="scpClient"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:get-command&gt;
                &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
                &lt;ftp:target path="target/test/hello.txt"/&gt;
              &lt;/ftp:get-command&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
      &lt;receive endpoint="scpClient"&gt;
        &lt;message&gt;
          &lt;body&gt;
            &lt;payload&gt;
              &lt;ftp:get-command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
                &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
                &lt;ftp:file path="target/test/hello.txt"&gt;
                  &lt;ftp:data&gt;citrus:readFile('classpath:test/hello.txt')&lt;/ftp:data&gt;
                &lt;/ftp:file&gt;
              &lt;/ftp:get-command-result&gt;
            &lt;/payload&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ScpTest
actions:
  - send:
      endpoint: scpClient
      message:
        body:
          data: |
            &lt;ftp:get-command&gt;
              &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
              &lt;ftp:target path="target/test/hello.txt"/&gt;
            &lt;/ftp:get-command&gt;
  - receive:
      endpoint: scpClient
      message:
        body:
          data: |
            &lt;ftp:get-command-result&gt;
              &lt;ftp:success&gt;true&lt;/ftp:success&gt;
              &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
              &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
              &lt;ftp:file path="target/test/hello.txt"&gt;
                &lt;ftp:data&gt;citrus:readFile('classpath:test/hello.txt')&lt;/ftp:data&gt;
              &lt;/ftp:file&gt;
            &lt;/ftp:get-command-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:ftp="http://www.citrusframework.org/schema/ftp/message"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/ftp/message
              http://www.citrusframework.org/schema/ftp/citrus-ftp-message.xsd"&gt;
  &lt;testcase name="ScpTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="scpClient"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:get-command&gt;
                &lt;ftp:file path="test/hello.txt" type="ASCII"/&gt;
                &lt;ftp:target path="target/test/hello.txt"/&gt;
              &lt;/ftp:get-command&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="scpClient"&gt;
          &lt;message&gt;
            &lt;payload&gt;
              &lt;ftp:get-command-result&gt;
                &lt;ftp:success&gt;true&lt;/ftp:success&gt;
                &lt;ftp:reply-code&gt;226&lt;/ftp:reply-code&gt;
                &lt;ftp:reply-string&gt;@contains('Transfer complete')@&lt;/ftp:reply-string&gt;
                &lt;ftp:file path="target/test/hello.txt"&gt;
                  &lt;ftp:data&gt;citrus:readFile('classpath:test/hello.txt')&lt;/ftp:data&gt;
                &lt;/ftp:file&gt;
              &lt;/ftp:get-command-result&gt;
            &lt;/payload&gt;
          &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When file transfer is complete we are able to verify the file content in a command result. The file content is provided as data string.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="file"><a class="anchor" href="#file"></a><a class="link" href="#file">22. File support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In chapter <a href="#message-channels">message-channels</a> we have discussed the native Spring Integration channel support which enables Citrus to interact with all Spring Integration messaging adapter implementations. This is a fantastic way to extend Citrus for additional transports. This interaction now comes handy when writing and reading files from the file system in Citrus.</p>
</div>
<div class="sect2">
<h3 id="write-files"><a class="anchor" href="#write-files"></a><a class="link" href="#write-files">22.1. Write files</a></h3>
<div class="paragraph">
<p>We want to use the Spring Integration file adapter for both reading and writing files with a local directory. Citrus can easily connect to this file adapter implementation with its message channel support. Citrus message sender and receiver speak to message channels that are connected to the Spring Integration file adapters.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public ChannelEndpointAdapter fileEndpoint() {
    ChannelSyncEndpointConfiguration endpointConfiguration = new ChannelSyncEndpointConfiguration();
    endpointConfiguration.setChannelName("fileChannel");
    return new ChannelEndpointAdapter(endpointConfiguration);
}

@BindToRegistry
public MessageChannel fileChannel() {
    return new DirectChannel();
}

@BindToRegistry
public FileWritingMessageHandler fileOutboundAdapter() {
    FileWritingMessageHandler messageHandler = new FileWritingMessageHandler(new File("some/directory"));
    messageHandler.setOutboundChannel(fileChannel());
    return messageHandler;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public ChannelEndpointAdapter fileEndpoint() {
    ChannelSyncEndpointConfiguration endpointConfiguration = new ChannelSyncEndpointConfiguration();
    endpointConfiguration.setChannelName("fileChannel");
    return new ChannelEndpointAdapter(endpointConfiguration);
}

@Bean
public MessageChannel fileChannel() {
    return new DirectChannel();
}

@Bean
public FileWritingMessageHandler fileOutboundAdapter() {
    FileWritingMessageHandler messageHandler = new FileWritingMessageHandler(new File("some/directory"));
    messageHandler.setOutboundChannel(fileChannel());
    return messageHandler;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
        &lt;beans xmlns="http://www.springframework.org/schema/beans"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:citrus="http://www.citrusframework.org/schema/config"
        xmlns:citrus-si="http://www.citrusframework.org/schema/spring-integration/config"
        xmlns:si="http://www.springframework.org/schema/integration"
        xmlns:si-file="http://www.springframework.org/schema/integration/file"
        xsi:schemaLocation="http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.citrusframework.org/schema/config
            http://www.citrusframework.org/schema/config/citrus-config.xsd
            http://www.citrusframework.org/schema/spring-integration/config
            http://www.citrusframework.org/schema/spring-integration/config/citrus-spring-integration-config.xsd
            http://www.springframework.org/schema/integration
            http://www.springframework.org/schema/integration/spring-integration.xsd
            http://www.springframework.org/schema/integration/file
            http://www.springframework.org/schema/integration/file/spring-integration-file.xsd"&gt;

    &lt;citrus-si:channel-endpoint id="fileEndpoint" channel="fileChannel"/&gt;

    &lt;si-file:outbound-channel-adapter id="fileOutboundAdapter"
          channel="fileChannel"
          directory="file:some/directory"/&gt;

    &lt;si:channel id="fileChannel"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration above describes a Citrus message channel endpoint connected to a Spring Integration outbound file adapter that writes messages to a storage directory.
With this combination you are able to write files to a directory in your Citrus test case.
The test case uses the channel endpoint in its send action and the endpoint interacts with the Spring Integration file adapter so sending out the file.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Spring Integration file adapter configuration component adds new namespaces (<code>si</code>, <code>si-file</code>, <code>citrus-si</code>) to the Spring XML application context. Please see the individual XML schema locations for details of the supported component in these namespaces.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="read-files"><a class="anchor" href="#read-files"></a><a class="link" href="#read-files">22.2. Read files</a></h3>
<div class="paragraph">
<p>The next program listing shows a possible inbound file communication. So the Spring Integration file inbound adapter will read files from a storage directory and publish the file contents to a message channel. Citrus can then receive those files as messages in a test case via the channel endpoint and validate the file contents for instance.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public ChannelEndpointAdapter fileEndpoint() {
    ChannelSyncEndpointConfiguration endpointConfiguration = new ChannelSyncEndpointConfiguration();
    endpointConfiguration.setChannelName("fileChannel");
    return new ChannelEndpointAdapter(endpointConfiguration);
}

@BindToRegistry
public MessageChannel fileChannel() {
    return new DirectChannel();
}

@BindToRegistry
public FileWritingMessageHandler fileOutboundAdapter() {
    FileWritingMessageHandler messageHandler = new FileWritingMessageHandler(new File("some/directory"));
    messageHandler.setOutboundChannel(fileChannel());
    return messageHandler;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public ChannelEndpointAdapter fileEndpoint() {
    ChannelSyncEndpointConfiguration endpointConfiguration = new ChannelSyncEndpointConfiguration();
    endpointConfiguration.setChannelName("fileChannel");
    return new ChannelEndpointAdapter(endpointConfiguration);
}

@Bean
public MessageChannel fileChannel() {
    return new DirectChannel();
}

@Bean
public FileReadingMessageSource fileInboundAdapter() {
    FileReadingMessageSource messageSource = new FileReadingMessageSource();
    messageSource.setDirectory(new File("some/directory"));
    messageSource.setInboundChannel(fileChannel());
    return messageSource;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
        &lt;beans xmlns="http://www.springframework.org/schema/beans"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:citrus="http://www.citrusframework.org/schema/config"
        xmlns:citrus-si="http://www.citrusframework.org/schema/spring-integration/config"
        xmlns:si="http://www.springframework.org/schema/integration"
        xmlns:si-file="http://www.springframework.org/schema/integration/file"
        xsi:schemaLocation="http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.citrusframework.org/schema/config
            http://www.citrusframework.org/schema/config/citrus-config.xsd
            http://www.citrusframework.org/schema/spring-integration/config
            http://www.citrusframework.org/schema/spring-integration/config/citrus-spring-integration-config.xsd
            http://www.springframework.org/schema/integration
            http://www.springframework.org/schema/integration/spring-integration.xsd
            http://www.springframework.org/schema/integration/file
            http://www.springframework.org/schema/integration/file/spring-integration-file.xsd"&gt;

  &lt;citrus-si:channel-endpoint id="fileEndpoint" channel="fileChannel"/&gt;

  &lt;si-file:inbound-channel-adapter  id="fileInboundAdapter"
        channel="fileChannel"
        directory="file:some/directory"&gt;
    &lt;si:poller fixed-rate="100"/&gt;
  &lt;/si-file:inbound-channel-adapter&gt;

  &lt;si:channel id="fileChannel"&gt;
    &lt;si:queue capacity="25"/&gt;
    &lt;si:interceptors&gt;
        &lt;bean class="org.springframework.integration.transformer.MessageTransformingChannelInterceptor"&gt;
            &lt;constructor-arg&gt;
                &lt;bean class="org.springframework.integration.file.transformer.FileToStringTransformer"/&gt;
            &lt;/constructor-arg&gt;
        &lt;/bean&gt;
    &lt;/si:interceptors&gt;
  &lt;/si:channel&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The file inbound adapter constructs Java file objects as the message payload by default. Citrus can only work on String message payloads. So we need a file transformer that converts the file objects to String payloads representing the file&#8217;s content.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This file adapter example shows how easy Citrus can work hand in hand with Spring Integration adapter implementations. The message channel support is a fantastic way to extend the transport and protocol support in Citrus by connecting with the very good Spring Integration adapter implementations. Have a closer look at the Spring Integration project for more details and other adapter implementations that you can use with Citrus integration testing.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="selenium"><a class="anchor" href="#selenium"></a><a class="link" href="#selenium">23. Selenium support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://www.seleniumhq.org/">Selenium</a> is a very popular tool for testing user interfaces with browser automation. Citrus is able to integrate with the Selenium Java API in order to execute Selenium commands.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Selenium test components in Citrus are kept in a separate Maven module. If not already done, you have to include the module as Maven dependency to your project
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-selenium&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="selenium-browser"><a class="anchor" href="#selenium-browser"></a><a class="link" href="#selenium-browser">23.1. Selenium browser</a></h3>
<div class="paragraph">
<p>Selenium uses browser automation in order to simulate the user interact with web applications. You can configure the Selenium browser and web driver as Spring bean.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public SeleniumBrowser seleniumBrowser() {
    return new SeleniumBrowserBuilder()
            .type("firefox")
            .startPage("http://citrusframework.org")
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SeleniumBrowser seleniumBrowser() {
    return new SeleniumBrowserBuilder()
            .type("firefox")
            .startPage("http://citrusframework.org")
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus-selenium="http://www.citrusframework.org/schema/selenium/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/selenium/config
           http://www.citrusframework.org/schema/selenium/config/citrus-selenium-config.xsd"&gt;

  &lt;citrus-selenium:browser id="seleniumBrowser"
                type="firefox"
                start-page="http://citrusframework.org"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Citrus provides a "citrus-selenium" configuration namespace and schema definition for Selenium related Spring bean components and actions. Include this namespace into your Spring configuration in order to use the Citrus Selenium configuration elements. The namespace URI and schema location are added to the Spring configuration XML.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Selenium browser component supports different browser types for the commonly used browsers out in the wild.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>htmlunit</strong></p>
</li>
<li>
<p><strong>firefox</strong></p>
</li>
<li>
<p><strong>safari</strong></p>
</li>
<li>
<p><strong>chrome</strong></p>
</li>
<li>
<p><strong>googlechrome</strong></p>
</li>
<li>
<p><strong>internet explorer</strong></p>
</li>
<li>
<p><strong>edge</strong></p>
</li>
<li>
<p><strong>custom</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Html unit is the default browser type and represents a headless browser that executed without displaying the graphical user interface. In case you need a totally different browser or
you need to customize the Selenium web driver you can use the <em>type="custom"</em> in combination with a web driver reference:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public SeleniumBrowser seleniumBrowser() {
    return new SeleniumBrowserBuilder()
            .type("custom")
            .webDriver(operaWebDriver())
            .build();
}

@BindToRegistry
public OperaDriver operaWebDriver() {
    return new OperaDriver();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SeleniumBrowser seleniumBrowser() {
    return new SeleniumBrowserBuilder()
            .type("custom")
            .webDriver(operaWebDriver())
            .build();
}

@Bean
public OperaDriver operaWebDriver() {
    return new OperaDriver();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus-selenium="http://www.citrusframework.org/schema/selenium/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/selenium/config
           http://www.citrusframework.org/schema/selenium/config/citrus-selenium-config.xsd"&gt;

  &lt;citrus-selenium:browser id="seleniumBrowser"
                type="custom"
                web-driver="operaWebDriver"/&gt;

  &lt;bean id="operaWebDriver" class="org.openqa.selenium.opera.OperaDriver"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now Citrus is using the customized Selenium web driver implementation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When using Firefox as browser you may also want to set the optional properties <strong>firefox-profile</strong> and <strong>version</strong>.
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public SeleniumBrowser seleniumBrowser() {
    return new SeleniumBrowserBuilder()
            .type("firefox")
            .firefoxProfile(firefoxProfile())
            .version("FIREFOX_38")
            .startPage("http://citrusframework.org")
            .build();
}

@BindToRegistry
public FirefoxProfile firefoxProfile() {
    return new FirefoxProfile();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SeleniumBrowser seleniumBrowser() {
    return new SeleniumBrowserBuilder()
            .type("firefox")
            .firefoxProfile(firefoxProfile())
            .version("FIREFOX_38")
            .startPage("http://citrusframework.org")
            .build();
}

@Bean
public FirefoxProfile firefoxProfile() {
    return new FirefoxProfile();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus-selenium="http://www.citrusframework.org/schema/selenium/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/selenium/config
           http://www.citrusframework.org/schema/selenium/config/citrus-selenium-config.xsd"&gt;

  &lt;citrus-selenium:browser id="mySeleniumBrowser"
                type="firefox"
                firefox-profile="firefoxProfile"
                version="FIREFOX_38"
                start-page="http://citrusframework.org"/&gt;

  &lt;bean id="firefoxProfile" class="org.openqa.selenium.firefox.FirefoxProfile"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now Citrus is able to execute Selenium operations as a user.</p>
</div>
</div>
<div class="sect2">
<h3 id="selenium-actions"><a class="anchor" href="#selenium-actions"></a><a class="link" href="#selenium-actions">23.2. Selenium actions</a></h3>
<div class="paragraph">
<p>We have several Citrus test actions each representing a Selenium command.
These actions can be part of a Citrus test case.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
private SeleniumBrowser seleniumBrowser;

@CitrusTest
public void seleniumTest() {
    selenium().start(seleniumBrowser);

    selenium().navigate("http://localhost:8080");

    selenium().find().element(By.id("header")
                .tagName("h1")
                .enabled(true)
                .displayed(true)
                .text("Welcome!")
                .style("font-size", "40px"));

    selenium().click().element(By.linkText("Click Me!"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SeleniumTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;selenium&gt;
        &lt;start browser="webBrowser"/&gt;
      &lt;/selenium&gt;

      &lt;selenium&gt;
        &lt;navigate page="http://localhost:8080"/&gt;
      &lt;/selenium&gt;

      &lt;selenium&gt;
        &lt;find&gt;
          &lt;element tag-name="h1"/&gt;
          &lt;validate text="Welcome!"&gt;
            &lt;styles&gt;
              &lt;style name="font-size" value="40px"/&gt;
            &lt;/styles&gt;
          &lt;/validate&gt;
        &lt;/find&gt;
      &lt;/selenium&gt;

      &lt;selenium&gt;
        &lt;click&gt;
          &lt;element id="ok-button"/&gt;
        &lt;/click&gt;
      &lt;/selenium&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SeleniumTest
actions:
  - selenium:
      browser: webBrowser
      start: {}
  - selenium:
      navigate:
        page: "http://localhost:8080"
  - selenium:
      find:
        element:
          tag-name: "h1"
        validate:
          text: "Welcome!"
          styles:
            - name: "font-size"
              value: "40px"
  - selenium:
      click:
        element:
          id: "ok-button"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:selenium="http://www.citrusframework.org/schema/selenium/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/selenium/testcase
              http://www.citrusframework.org/schema/selenium/testcase/citrus-selenium-testcase.xsd"&gt;

    &lt;testcase name="SeleniumTest"&gt;
        &lt;actions&gt;
          &lt;selenium:start browser="webBrowser"/&gt;

          &lt;selenium:navigate page="http://localhost:8080"/&gt;

          &lt;selenium:find&gt;
            &lt;selenium:element tag-name="h1" text="Welcome!"&gt;
              &lt;selenium:styles&gt;
                &lt;selenium:style name="font-size" value="40px"/&gt;
              &lt;/selenium:styles&gt;
            &lt;/selenium:element&gt;
          &lt;/selenium:find&gt;

          &lt;selenium:click&gt;
            &lt;selenium:element id="ok-button"/&gt;
          &lt;/selenium:click&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In Spring XML test cases there is special selenium namespace with prefix <strong>selenium:</strong> for special Selenium related test actions.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this very simple example we first start the Selenium browser instance.
After that we can continue to use Selenium commands without browser attribute explicitly set.
Citrus knows which browser instance is currently active and will automatically use this opened browser instance.
Next in this example we find some element on the displayed page by its tag-name and text. We also validate the element style <em>font-size</em> to meet the expected value <em>40px</em> in this step.</p>
</div>
<div class="paragraph">
<p>In addition to that the example performs a click operation on the element with the id <em>ok-button</em>.
Selenium supports element find operations on different properties:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
id
</td>
<td class="hdlist2">
<p>finds element based on the <em>id</em> attribute</p>
</td>
</tr>
<tr>
<td class="hdlist1">
name
</td>
<td class="hdlist2">
<p>finds element based on the <em>name</em> attribute</p>
</td>
</tr>
<tr>
<td class="hdlist1">
tag-name
</td>
<td class="hdlist2">
<p>finds element based on the <em>tag name</em></p>
</td>
</tr>
<tr>
<td class="hdlist1">
class-name
</td>
<td class="hdlist2">
<p>finds element based on the css <em>class name</em></p>
</td>
</tr>
<tr>
<td class="hdlist1">
link-text
</td>
<td class="hdlist2">
<p>finds link element based on the <em>link-text</em></p>
</td>
</tr>
<tr>
<td class="hdlist1">
xpath
</td>
<td class="hdlist2">
<p>finds element based on XPath evaluation in the DOM</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Based on that we can execute several Selenium commands in a test case and validate the results such as web elements.
Citrus supports the following Selenium commands with respective test actions:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
selenium:start
</td>
<td class="hdlist2">
<p>Start the browser instance</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:find
</td>
<td class="hdlist2">
<p>Finds element on current page and validates element properties</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:click
</td>
<td class="hdlist2">
<p>Performs click operation on element</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:hover
</td>
<td class="hdlist2">
<p>Performs hover operation on element</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:navigate
</td>
<td class="hdlist2">
<p>Navigates to new page url (including history back, forward and refresh)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:set-input
</td>
<td class="hdlist2">
<p>Finds input element and sets value</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:check-input
</td>
<td class="hdlist2">
<p>Finds checkbox element and sets/unsets value</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:dropdown-select
</td>
<td class="hdlist2">
<p>Finds dropdown element and selects single or multiple value/s</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:fill-form
</td>
<td class="hdlist2">
<p>Fills form with given values and optionally submits form afterwards. Supports setting multiple fields at the same time.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:page
</td>
<td class="hdlist2">
<p>Instantiate page object with dependency injection and execute page action with verification</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:open
</td>
<td class="hdlist2">
<p>Open new window</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:close
</td>
<td class="hdlist2">
<p>Close window by given name</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:switch
</td>
<td class="hdlist2">
<p>Switch focus to window with given name</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:wait-until
</td>
<td class="hdlist2">
<p>Wait for element to be <em>hidden</em> or <em>visible</em></p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:alert
</td>
<td class="hdlist2">
<p>Access current alert dialog (with action <em>access</em> or <em>dismiss</em>)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:screenshot
</td>
<td class="hdlist2">
<p>Makes screenshot of current page</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:store-file
</td>
<td class="hdlist2">
<p>Store file to temporary browser directory</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:get-stored-file
</td>
<td class="hdlist2">
<p>Gets stored file from temporary browser directory</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:javascript
</td>
<td class="hdlist2">
<p>Execute Javascript code in browser</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:clear-cache
</td>
<td class="hdlist2">
<p>Clear browser cache and all cookies</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium:stop
</td>
<td class="hdlist2">
<p>Stops the browser instance</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s have a closer look at the different Selenium test actions supported in Citrus.</p>
</div>
</div>
<div class="sect2">
<h3 id="start-stop-browser"><a class="anchor" href="#start-stop-browser"></a><a class="link" href="#start-stop-browser">23.3. Start/stop browser</a></h3>
<div class="paragraph">
<p>You can start and stop the browser instance with a test action. This instantiates a new browser window and prepares everything for interacting with the web
interface.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void seleniumTest() {
    selenium().start(seleniumBrowser);
    // Do something in browser
    selenium().stop(seleniumBrowser);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SeleniumTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;selenium&gt;
        &lt;start browser="seleniumBrowser"/&gt;
      &lt;/selenium&gt;
      &lt;!-- Do something in browser --&gt;
      &lt;selenium&gt;
        &lt;stop browser="seleniumBrowser"/&gt;
      &lt;/selenium&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SeleniumTest
actions:
  - selenium:
      browser: seleniumBrowser
      start: {}
  # Do something in browser
  - selenium:
      browser: seleniumBrowser
      stop: {}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:selenium="http://www.citrusframework.org/schema/selenium/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/selenium/testcase
              http://www.citrusframework.org/schema/selenium/testcase/citrus-selenium-testcase.xsd"&gt;
  &lt;testcase name="SeleniumTest"&gt;
    &lt;actions&gt;
      &lt;selenium:start browser="seleniumBrowser"/&gt;
      &lt;!-- Do something in browser --&gt;
      &lt;selenium:stop browser="seleniumBrowser"/&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>After starting a browser instance Citrus will automatically use this very same browser instance in all further Selenium actions. This mechanism is based on a test variable (<strong>selenium_browser</strong>) that
is automatically set. All other test actions are able to load the current browser instance by reading this test variable before execution. In case you need to explicitly use
a different browser instance than the active instance you can add the <strong>browser</strong> attribute to all Selenium test actions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is a good idea to start and stop the browser instance before each test case. This makes sure that tests are also executable in single run and it always sets up a new browser instance so tests
will not influence each other.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="find"><a class="anchor" href="#find"></a><a class="link" href="#find">23.4. Find</a></h3>
<div class="paragraph">
<p>The find element test action searches for an element on the current page. The element is specified by one of the following settings:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
id
</td>
<td class="hdlist2">
<p>finds element based on the <em>id</em> attribute</p>
</td>
</tr>
<tr>
<td class="hdlist1">
name
</td>
<td class="hdlist2">
<p>finds element based on the <em>name</em> attribute</p>
</td>
</tr>
<tr>
<td class="hdlist1">
tag-name
</td>
<td class="hdlist2">
<p>finds element based on the <em>tag name</em></p>
</td>
</tr>
<tr>
<td class="hdlist1">
class-name
</td>
<td class="hdlist2">
<p>finds element based on the css <em>class name</em></p>
</td>
</tr>
<tr>
<td class="hdlist1">
link-text
</td>
<td class="hdlist2">
<p>finds link element based on the <em>link-text</em></p>
</td>
</tr>
<tr>
<td class="hdlist1">
xpath
</td>
<td class="hdlist2">
<p>finds element based on XPath evaluation in the DOM</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The find element action will automatically fail in case there is no such element on the current page. In case the element is found you can add additional attributes and properties
for further element validation:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void seleniumTest() {
    selenium().find().element(By.tagName("h1"))
        .text("Welcome!")
        .style("font-size", "40px");

    selenium().find().element(By.id("ok-button"))
        .tagName("button")
        .enabled(true)
        .displayed(true)
        .text("Ok")
        .style("color", "red")
        .attribute("type", "submit");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SeleniumTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;selenium&gt;
        &lt;find&gt;
          &lt;element tag-name="h1"/&gt;
          &lt;validate text="Welcome!"&gt;
            &lt;styles&gt;
              &lt;style name="font-size" value="40px"/&gt;
            &lt;/styles&gt;
          &lt;/validate&gt;
        &lt;/find&gt;
      &lt;/selenium&gt;

      &lt;selenium&gt;
        &lt;find&gt;
          &lt;element id="ok-button"/&gt;
          &lt;validate text="Ok" enabled="true" displayed="true"&gt;
            &lt;attributes&gt;
              &lt;attribute name="type" value="submit"/&gt;
            &lt;/attributes&gt;
          &lt;/validate&gt;
        &lt;/find&gt;
      &lt;/selenium&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SeleniumTest
actions:
  - selenium:
      find:
        element:
          tag-name: "h1"
        validate:
          text: "Welcome!"
          styles:
            - name: "font-size"
              value: "40px"
  - selenium:
      find:
        element:
          id: "ok-button"
        validate:
          text: "Ok"
          displayed: true
          enabled: true
          attributes:
            - name: "type"
              value: "submit"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:selenium="http://www.citrusframework.org/schema/selenium/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/selenium/testcase
              http://www.citrusframework.org/schema/selenium/testcase/citrus-selenium-testcase.xsd"&gt;
  &lt;testcase name="SeleniumTest"&gt;
    &lt;actions&gt;
        &lt;selenium:find&gt;
          &lt;selenium:element tag-name="h1" text="Welcome!"&gt;
            &lt;selenium:styles&gt;
              &lt;selenium:style name="font-size" value="40px"/&gt;
            &lt;/selenium:styles&gt;
          &lt;/selenium:element&gt;
        &lt;/selenium:find&gt;

        &lt;selenium:find&gt;
          &lt;selenium:element id="ok-button" text="Ok" enabled="true" displayed="true"&gt;
            &lt;selenium:attributes&gt;
              &lt;selenium:attribute name="type" value="submit"/&gt;
            &lt;/selenium:attributes&gt;
          &lt;/selenium:element&gt;
        &lt;/selenium:find&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above finds the <strong>h1</strong> element by its tag name and validates the text and css style attributes. Secondly the <strong>ok-button</strong> is validated with expected
enabled, displayed, text, style and attribute values. The elements must be present on the current page and all expected element properties have to match. Otherwise the test action and the test case
is failing with validation errors.</p>
</div>
</div>
<div class="sect2">
<h3 id="click"><a class="anchor" href="#click"></a><a class="link" href="#click">23.5. Click</a></h3>
<div class="paragraph">
<p>The action performs a click operation on the element.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void seleniumTest() {
    selenium().click().element(By.linkText("Click Me!"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SeleniumTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;selenium&gt;
        &lt;click&gt;
          &lt;element&gt;
            &lt;property name="link-text" value="Click Me!"/&gt;
          &lt;/element&gt;
        &lt;/click&gt;
      &lt;/selenium&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SeleniumTest
actions:
  - selenium:
      click:
        element:
          property:
            name: "link-text"
            value: "Click Me!"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:selenium="http://www.citrusframework.org/schema/selenium/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/selenium/testcase
              http://www.citrusframework.org/schema/selenium/testcase/citrus-selenium-testcase.xsd"&gt;
  &lt;testcase name="SeleniumTest"&gt;
    &lt;actions&gt;
        &lt;selenium:click&gt;
          &lt;selenium:element link-text="Click Me!"/&gt;
        &lt;/selenium:click&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="hover"><a class="anchor" href="#hover"></a><a class="link" href="#hover">23.6. Hover</a></h3>
<div class="paragraph">
<p>The action performs a hover operation on the element.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void seleniumTest() {
    selenium().hover().element(By.linkText("Find Me!"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SeleniumTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;selenium&gt;
        &lt;hover&gt;
          &lt;element&gt;
            &lt;property name="link-text" value="Find Me!"/&gt;
          &lt;/element&gt;
        &lt;/hover&gt;
      &lt;/selenium&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SeleniumTest
actions:
  - selenium:
      hover:
        element:
          property:
            name: "link-text"
            value: "Find Me!"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:selenium="http://www.citrusframework.org/schema/selenium/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/selenium/testcase
              http://www.citrusframework.org/schema/selenium/testcase/citrus-selenium-testcase.xsd"&gt;
  &lt;testcase name="SeleniumTest"&gt;
    &lt;actions&gt;
        &lt;selenium:hover&gt;
          &lt;selenium:element link-text="Find Me!"/&gt;
        &lt;/selenium:hover&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="form-input-actions"><a class="anchor" href="#form-input-actions"></a><a class="link" href="#form-input-actions">23.7. Form input actions</a></h3>
<div class="paragraph">
<p>The following actions are used to access form input elements such as text fields, checkboxes and dropdown lists.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void seleniumTest() {
    selenium().setInput("Citrus")
            .element(By.name("username"));

    selenium().checkInput(true)
            .element(By.xpath("//input[@type='checkbox']"));

    selenium().select("happy")
            .element(By.id("user-mood"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SeleniumTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;selenium&gt;
        &lt;set-input value="Citrus"&gt;
          &lt;element name="username"/&gt;
        &lt;/set-input&gt;
      &lt;/selenium&gt;

      &lt;selenium&gt;
        &lt;check-input checked="true"&gt;
          &lt;element xpath="//input[@type='checkbox']"/&gt;
        &lt;/set-input&gt;
      &lt;/selenium&gt;

      &lt;selenium&gt;
        &lt;dropdown-select option="happy"&gt;
          &lt;element id="user-mood"/&gt;
        &lt;/dropdown-select&gt;
      &lt;/selenium&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SeleniumTest
actions:
  - selenium:
      set-input:
        value: "Citrus"
        element:
          name: "username"
  - selenium:
      check-input:
        checked: true
        element:
          xpath: |
            xpath="//input[@type='checkbox']"
  - selenium:
      dropdown-select:
        option: "happy"
        element:
          id: "user-mood"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:selenium="http://www.citrusframework.org/schema/selenium/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/selenium/testcase
              http://www.citrusframework.org/schema/selenium/testcase/citrus-selenium-testcase.xsd"&gt;
  &lt;testcase name="SeleniumTest"&gt;
    &lt;actions&gt;
        &lt;selenium:set-input value="Citrus"&gt;
          &lt;selenium:element name="username"/&gt;
        &lt;/selenium:set-input&gt;

        &lt;selenium:check-input checked="true"&gt;
          &lt;selenium:element xpath="//input[@type='checkbox']"/&gt;
        &lt;/selenium:check-input&gt;

        &lt;selenium:dropdown-select option="happy"&gt;
          &lt;selenium:element id="user-mood"/&gt;
        &lt;/selenium:dropdown-select&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The actions above select dropdown options and set user input on text fields and checkboxes. As usual the form elements are selected by some properties such as
ids, names or xpath expressions.</p>
</div>
</div>
<div class="sect2">
<h3 id="form-fill-actions"><a class="anchor" href="#form-fill-actions"></a><a class="link" href="#form-fill-actions">23.8. Fill form</a></h3>
<div class="paragraph">
<p>The fill form action sets multiple form fields with given values and optionally submits the form afterwards.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void seleniumTest() {
    selenium().fillForm()
        .field("username", "foo_user")
        .field("password", "${secret}")
        .submit("save");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SeleniumTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;selenium&gt;
        &lt;fill-form submit="save"&gt;
          &lt;fields&gt;
            &lt;field id="username" value="foo_user"/&gt;
            &lt;field id="password" value="${secret}"/&gt;
          &lt;/fields&gt;
        &lt;/fill-form&gt;
      &lt;/selenium&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SeleniumTest
actions:
  - selenium:
      fill-form:
        submit: "save"
        fields:
          - id: "username"
            value: "foo_user"
          - id: "password"
            value: "${secret}"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:selenium="http://www.citrusframework.org/schema/selenium/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/selenium/testcase
              http://www.citrusframework.org/schema/selenium/testcase/citrus-selenium-testcase.xsd"&gt;
  &lt;testcase name="SeleniumTest"&gt;
    &lt;actions&gt;
        &lt;selenium:fill-form submit="save"&gt;
          &lt;selenium:fields&gt;
            &lt;selenium:field id="username" value="foo_user"/&gt;
            &lt;selenium:field id="password" value="${secret}"/&gt;
          &lt;/selenium:fields&gt;
        &lt;/selenium:fill-form&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The actions above set the form fields identified by its id and sets the given values. The actions supports input fields, checkboxes and drop-down select controls. Optionally the form gets submitted by clicking on the given submit button once all fields are set.</p>
</div>
<div class="paragraph">
<p>The user also has the opportunity to set the form fields via Json object where each property in the Json object represents a form field.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void seleniumTest() {
    selenium().fillForm()
        .fromJson("""
        {
          "username": "foo_user",
          "password": "secret"
        }
        """)
        .submit(By.id("save"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SeleniumTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;selenium&gt;
        &lt;fill-form submit="save"&gt;
          &lt;json&gt;
          {
            "username": "foo_user",
            "password": "secret"
          }
          &lt;/json&gt;
        &lt;/fill-form&gt;
      &lt;/selenium&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SeleniumTest
actions:
  - selenium:
      fill-form:
        submit: "save"
        json: |
          {
            "username": "foo_user",
            "password": "secret"
          }</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:selenium="http://www.citrusframework.org/schema/selenium/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/selenium/testcase
          http://www.citrusframework.org/schema/selenium/testcase/citrus-selenium-testcase.xsd"&gt;
  &lt;testcase name="SeleniumTest"&gt;
    &lt;actions&gt;
        &lt;selenium:fill-form submit="save"&gt;
            &lt;selenium:json&gt;
              {
                "username": "foo_user",
                "password": "secret"
              }
            &lt;/selenium:json&gt;
        &lt;/selenium:fill-form&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will set the form fields <code>username</code> and <code>password</code> with the given values before submitting the form.</p>
</div>
</div>
<div class="sect2">
<h3 id="page-actions"><a class="anchor" href="#page-actions"></a><a class="link" href="#page-actions">23.9. Page actions</a></h3>
<div class="paragraph">
<p>Page objects are a well known pattern when using Selenium. The page objects define elements that the page is working with. In addition to that the
page objects define actions that can be executed from outside. This object-oriented approach for accessing pages and their elements is a very good idea.
Let&#8217;s have a look at a sample page object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class UserFormPage implements WebPage {

    @FindBy(id = "userForm")
    private WebElement form;

    @FindBy(id = "username")
    private WebElement userName;

    /**
     * Sets the username.
     */
    public void setUserName(String value, TestContext context) {
        userName.clear();
        userName.sendKeys(value);
    }

    /**
     * Submits the form.
     */
    public void submit(TestContext context) {
        form.submit();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the page object is a Java POJO that implements the <strong>WebPage</strong> interface. The page defines <strong>WebElement</strong> members. These are automatically
injected by Citrus and Selenium based on the <strong>FindBy</strong> annotation. Now the test case is able to load that page object and execute some action methods on the page such as
<em>setUserName</em> or <em>submit</em>.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void seleniumTest() {
    selenium().page(UserFormPage.class)
            .argument("Citrus")
            .execute("setUserName");

    selenium().page(UserFormPage.class)
            .execute("submit");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SeleniumTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;selenium&gt;
        &lt;page action="setUserName"
              type="org.citrusframework.selenium.pages.UserFormPage"&gt;
          &lt;arguments&gt;
            &lt;argument&gt;Citrus&lt;/argument&gt;
          &lt;/arguments&gt;
        &lt;/page&gt;
      &lt;/selenium&gt;
      &lt;selenium&gt;
        &lt;page action="submit"
              type="org.citrusframework.selenium.pages.UserFormPage"/&gt;
      &lt;/selenium&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SeleniumTest
actions:
  - selenium:
      page:
        type: "org.citrusframework.selenium.pages.UserFormPage"
        action: "setUserName"
        argument: Citrus
  - selenium:
      page:
        type: "org.citrusframework.selenium.pages.UserFormPage"
        action: "submit"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:selenium="http://www.citrusframework.org/schema/selenium/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/selenium/testcase
          http://www.citrusframework.org/schema/selenium/testcase/citrus-selenium-testcase.xsd"&gt;
  &lt;testcase name="SeleniumTest"&gt;
    &lt;actions&gt;
        &lt;selenium:page action="setUserName"
            type="org.citrusframework.selenium.pages.UserFormPage"&gt;
          &lt;selenium:arguments&gt;
            &lt;selenium:argument&gt;Citrus&lt;/selenium:argument&gt;
          &lt;/selenium:arguments&gt;
        &lt;/selenium:page&gt;

        &lt;selenium:page action="submit"
            type="org.citrusframework.selenium.pages.UserFormPage"/&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The page object class is automatically loaded and instantiated with dependency injection for all <em>FindBy</em> annotated web elements. After that the action method is executed.
The action methods can also have method parameters as seen in <em>setUserName</em>. The value parameter is automatically set when calling the method.</p>
</div>
<div class="paragraph">
<p>Methods can also use the optional parameter <em>TestContext</em>. With this context you can access the current test context with all test variables for instance. This method parameter
should always be the last parameter.</p>
</div>
</div>
<div class="sect2">
<h3 id="page-validation"><a class="anchor" href="#page-validation"></a><a class="link" href="#page-validation">23.10. Page validation</a></h3>
<div class="paragraph">
<p>We can also use page object for validation purpose. The page object is loaded and instantiated as described in previous section. Then the page validator
is called. The validator performs assertions and validation operations with the page object. Let&#8217;s see a sample page validator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class UserFormValidator implements PageValidator&lt;UserFormPage&gt; {

    @Override
    public void validate(UserFormPage webPage, SeleniumBrowser browser, TestContext context) {
        Assert.isTrue(webPage.getUserName() != null);
        Assert.isTrue(StringUtils.hasText(webPage.getUserName().getAttribute("value")));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The page validator is called with the web page instance, the browser and the test context. The validator should assert page objects and web elements for
validation purpose. In a test case we can call the validator to validate the page.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
private UserFormValidator userFormValidator;

@CitrusTest
public void seleniumTest() {
    selenium().page(UserFormPage.class)
            .execute("validate")
            .validator(userFormValidator);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SeleniumTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;selenium&gt;
        &lt;page action="validate"
              validator="userFormValidator"
              type="org.citrusframework.selenium.pages.UserFormPage"/&gt;
      &lt;/selenium&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SeleniumTest
actions:
  - selenium:
      page:
        type: "org.citrusframework.selenium.pages.UserFormPage"
        action: "validate"
        validator: "userFormValidator"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:selenium="http://www.citrusframework.org/schema/selenium/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/selenium/testcase
          http://www.citrusframework.org/schema/selenium/testcase/citrus-selenium-testcase.xsd"&gt;
  &lt;spring:bean id ="userFormValidator" class="org.citrusframework.selenium.pages.UserFormValidator"/&gt;

  &lt;testcase name="SeleniumTest"&gt;
    &lt;actions&gt;
        &lt;selenium:page type="org.citrusframework.selenium.pages.UserFormPage"
               action="validate"
               validator="userFormValidator"/&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of using a separate validator class you can also put the validation method to the page object itself.
Then page object and validation is done within the same class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class UserFormPage implements WebPage, PageValidator&lt;UserFormPage&gt; {

    @FindBy(id = "userForm")
    private WebElement form;

    @FindBy(id = "username")
    private WebElement userName;

    /**
     * Sets the username.
     */
    public void setUserName(String value, TestContext context) {
        userName.clear();
        userName.sendKeys(value);
    }

    /**
     * Submits the form.
     */
    public void submit(TestContext context) {
        form.submit();
    }

    @Override
    public void validate(UserFormPage webPage, SeleniumBrowser browser, TestContext context) {
        Assert.isTrue(userName != null);
        Assert.isTrue(StringUtils.hasText(userName.getAttribute("value")));
        Assert.isTrue(form != null);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="wait"><a class="anchor" href="#wait"></a><a class="link" href="#wait">23.11. Wait</a></h3>
<div class="paragraph">
<p>Sometimes it is required to wait for an element to appear or disappear on the current page. The wait action will wait a given time for the element status
to be <em>visible</em> or <em>hidden</em>.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void seleniumTest() {
    selenium().waitUntil()
            .hidden()
            .element(By.id("info-dialog"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SeleniumTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;selenium&gt;
        &lt;wait until="hidden"&gt;
          &lt;element id="info-dialog"/&gt;
        &lt;/wait&gt;
      &lt;/selenium&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SeleniumTest
actions:
  - selenium:
      wait-until:
        condition: "hidden"
        element:
          id: "info-dialog"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:selenium="http://www.citrusframework.org/schema/selenium/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/selenium/testcase
          http://www.citrusframework.org/schema/selenium/testcase/citrus-selenium-testcase.xsd"&gt;
  &lt;testcase name="SeleniumTest"&gt;
    &lt;actions&gt;
        &lt;selenium:wait until="hidden"&gt;
            &lt;selenium:element id="info-dialog"/&gt;
        &lt;/selenium:wait&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example waits for the element <em>info-dialog</em> to disappear. The time to wait is 5000 milliseconds by default. You can set the timeout on the action. Due
to Selenium limitations the minimum wait time is 1000 milliseconds.</p>
</div>
</div>
<div class="sect2">
<h3 id="navigate"><a class="anchor" href="#navigate"></a><a class="link" href="#navigate">23.12. Navigate</a></h3>
<div class="paragraph">
<p>The action navigates to a new page either by using a new relative path or a complete new Http URL.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void seleniumTest() {
    selenium().navigate("http://localhost:8080");

    selenium().navigate("help");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SeleniumTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;selenium&gt;
        &lt;navigate page="http://localhost:8080"/&gt;
      &lt;/selenium&gt;

      &lt;selenium&gt;
        &lt;navigate page="help"/&gt;
      &lt;/selenium&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SeleniumTest
actions:
  - selenium:
      navigate:
        page: "http://localhost:8080"
  - selenium:
      navigate:
        page: "help"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:selenium="http://www.citrusframework.org/schema/selenium/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/selenium/testcase
          http://www.citrusframework.org/schema/selenium/testcase/citrus-selenium-testcase.xsd"&gt;
  &lt;testcase name="SeleniumTest"&gt;
    &lt;actions&gt;
        &lt;selenium:navigate page="http://localhost:8080"/&gt;

        &lt;selenium:navigate page="help"/&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sample above describes a new page with new Http URL. The browser will navigate to this new page. All further Selenium actions are performed on this new
page. The second navigation action opens the relative page <em>help</em> so the new page URL is <code><a href="http://localhost:8080/help" class="bare">http://localhost:8080/help</a></code>.</p>
</div>
<div class="paragraph">
<p>Navigation is always done on the active browser window. You can manage the opened windows as described in next section.</p>
</div>
</div>
<div class="sect2">
<h3 id="window-actions"><a class="anchor" href="#window-actions"></a><a class="link" href="#window-actions">23.13. Window actions</a></h3>
<div class="paragraph">
<p>Selenium is able to manage multiple windows. So you can open, close and switch active windows in a Citrus test.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void seleniumTest() {
    selenium().open().window("my_window");
    selenium().focus().window("my_window");
    selenium().close().window("my_window");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SeleniumTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;selenium&gt;
        &lt;open-window name="my_window"/&gt;
        &lt;switch-window name="my_window"/&gt;
        &lt;close-window name="my_window"/&gt;
      &lt;/selenium&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SeleniumTest
actions:
  - selenium:
      open-window:
        name: "my_window"
  - selenium:
      switch-window:
        name: "my_window"
  - selenium:
      close-window:
        name: "my_window"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:selenium="http://www.citrusframework.org/schema/selenium/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/selenium/testcase
          http://www.citrusframework.org/schema/selenium/testcase/citrus-selenium-testcase.xsd"&gt;
  &lt;testcase name="SeleniumTest"&gt;
    &lt;actions&gt;
        &lt;selenium:open-window name="my_window"/&gt;
        &lt;selenium:switch-window name="my_window"/&gt;
        &lt;selenium:close-window name="my_window"/&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When a new window is opened Selenium creates a window handle for us. This window handle is saved as test variable using a given window name. So after opening the window you can access the
window by its name in further actions. All upcoming Selenium actions will take place in this new active window. Of course the test actions will fail as soon as the window with that given
name is missing. Citrus uses default window names that are automatically used as test variables:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
selenium_active_window
</td>
<td class="hdlist2">
<p>the active window handle</p>
</td>
</tr>
<tr>
<td class="hdlist1">
selenium_last_window
</td>
<td class="hdlist2">
<p>the last window handle when switched to other window</p>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="alert"><a class="anchor" href="#alert"></a><a class="link" href="#alert">23.14. Alert</a></h3>
<div class="paragraph">
<p>We are able to access the alert dialog on the current page. Citrus will validate the displayed dialog text and accept or dismiss of the dialog.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void seleniumTest() {
    selenium().alert()
                .text("Hello!")
                .accept();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SeleniumTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;selenium&gt;
        &lt;alert text="Hello!" accept="true"/&gt;
      &lt;/selenium&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SeleniumTest
actions:
  - selenium:
      alert:
        accept: true
        text: "Hello!"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:selenium="http://www.citrusframework.org/schema/selenium/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/selenium/testcase
          http://www.citrusframework.org/schema/selenium/testcase/citrus-selenium-testcase.xsd"&gt;
  &lt;testcase name="SeleniumTest"&gt;
    &lt;actions&gt;
        &lt;selenium:alert accept="true"&gt;
          &lt;selenium:alert-text&gt;Hello!&lt;/selenium:alert-text&gt;
        &lt;/selenium:alert&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The alert dialog text is validated when expected text is given on the test action. The user can decide to accept or dismiss the dialog. After that the dialog should be closed.
In case the test action fails to find an open alert dialog the test action raises runtime errors and the test will fail.</p>
</div>
</div>
<div class="sect2">
<h3 id="make-screenshot"><a class="anchor" href="#make-screenshot"></a><a class="link" href="#make-screenshot">23.15. Make screenshot</a></h3>
<div class="paragraph">
<p>You can execute this action in case you want to take a screenshot of the current page. This action only works with browsers that actually display the user interface. The action will not have any effect
when executed with Html unit web driver in headless mode.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void seleniumTest() {
    selenium().screenhsot();

    selenium().screenhsot("target");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SeleniumTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;selenium&gt;
        &lt;screenshot/&gt;
      &lt;/selenium&gt;

      &lt;selenium&gt;
        &lt;screenshot output-dir="target"/&gt;
      &lt;/selenium&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SeleniumTest
actions:
  - selenium:
      screenshot: {}
  - selenium:
      screenshot:
        output-dir: "target"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:selenium="http://www.citrusframework.org/schema/selenium/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/selenium/testcase
          http://www.citrusframework.org/schema/selenium/testcase/citrus-selenium-testcase.xsd"&gt;
  &lt;testcase name="SeleniumTest"&gt;
    &lt;actions&gt;
        &lt;selenium:screenshot/&gt;

        &lt;selenium:screenshot output-dir="target"/&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test action has an optional parameter <em>output-dir</em> which represents the output directory where the screenshot is saved to.</p>
</div>
</div>
<div class="sect2">
<h3 id="temporary-storage-firefox"><a class="anchor" href="#temporary-storage-firefox"></a><a class="link" href="#temporary-storage-firefox">23.16. Temporary storage (Firefox)</a></h3>
<div class="paragraph">
<p><strong>Important</strong> This action only works with Firefox web driver! Other browsers are not working with the temporary download storage.</p>
</div>
<div class="paragraph">
<p>The browser uses a temporary storage for downloaded files. We can access this temporary storage during a test case.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void seleniumTest() {
    selenium().store("classpath:download/file.txt");
    selenium().getStored("file.txt");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SeleniumTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;selenium&gt;
        &lt;store-file file-path="classpath:download/file.txt"/&gt;
        &lt;get-stored-file file-name="file.txt"/&gt;
      &lt;/selenium&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SeleniumTest
actions:
  - selenium:
      store-file:
        file-path: "classpath:download/file.txt"
  - selenium:
      get-stored-file:
        file-name: "file.txt"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:selenium="http://www.citrusframework.org/schema/selenium/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/selenium/testcase
          http://www.citrusframework.org/schema/selenium/testcase/citrus-selenium-testcase.xsd"&gt;
  &lt;testcase name="SeleniumTest"&gt;
    &lt;actions&gt;
        &lt;selenium:store-file file-path="classpath:download/file.txt"/&gt;
        &lt;selenium:get-stored-file file-name="file.txt"/&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the test case is able to store new files to the temporary browser storage. We have to give the file path as classpath
or file system path. When reading the temporary file storage we need to specify the file name that we want to access in the temporary storage. The
temporary storage is not capable of subdirectories all files are stored directly to the storage in one single directory.</p>
</div>
<div class="paragraph">
<p>In case the stored file is not found by that name the test action fails with respective errors. On the other hand when the file is found in temporary storage
Citrus will automatically create a new test variable <strong>selenium_download_file</strong> which contains the file name as value.</p>
</div>
</div>
<div class="sect2">
<h3 id="clear-browser-cache"><a class="anchor" href="#clear-browser-cache"></a><a class="link" href="#clear-browser-cache">23.17. Clear browser cache</a></h3>
<div class="paragraph">
<p>When clearing the browser cache all cookies and temporary files will be deleted.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void seleniumTest() {
    selenium().clearCache();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="SeleniumTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;selenium&gt;
        &lt;clear-cache/&gt;
      &lt;/selenium&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: SeleniumTest
actions:
  - selenium:
      clear-cache: {}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:selenium="http://www.citrusframework.org/schema/selenium/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/schema/selenium/testcase
          http://www.citrusframework.org/schema/selenium/testcase/citrus-selenium-testcase.xsd"&gt;
  &lt;testcase name="SeleniumTest"&gt;
    &lt;actions&gt;
        &lt;selenium:clear-cache/&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="vert-x-event-bus"><a class="anchor" href="#vert-x-event-bus"></a><a class="link" href="#vert-x-event-bus">24. Vert.x event bus support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vert.x is an application platform for the JVM that provides a network event bus for lightweight scalable messaging solutions. The Citrus Vert.x
components do participate on that event bus messaging as producer or consumer. With these components you can access Vert.x instances
available in your network in order to test those Vert.x applications in some integration test scenario.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Vert.x components in Citrus are kept in a separate Maven module. So you should add the module as Maven dependency to your project accordingly.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-vertx&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next sections discuss sending and receiving operations on the Vert.x event bus with Citrus.</p>
</div>
<div class="sect2">
<h3 id="vert-x-endpoint"><a class="anchor" href="#vert-x-endpoint"></a><a class="link" href="#vert-x-endpoint">24.1. Vert.x endpoint</a></h3>
<div class="paragraph">
<p>As usual Citrus uses an endpoint component in order to specify some message destination to send and receive messages to and from.
The Vert.x endpoint component is defined as follows in your Citrus Spring configuration.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public VertxEndpoint simpleVertxEndpoint() {
    return new VertxEndpointBuilder()
        .host("localhost")
        .port(5001)
        .pubSubDomain(false)
        .address("news-feed")
        .build();
}

private VertxInstanceFactory vertxInstanceFactory() {
    return new CachingVertxInstanceFactory();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public VertxEndpoint simpleVertxEndpoint() {
    return new VertxEndpointBuilder()
        .host("localhost")
        .port(5001)
        .pubSubDomain(false)
        .address("news-feed")
        .build();
}

private VertxInstanceFactory vertxInstanceFactory() {
    return new CachingVertxInstanceFactory();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-vertx="http://www.citrusframework.org/schema/vertx/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/vertx/config
           http://www.citrusframework.org/schema/vertx/config/citrus-vertx-config.xsd"&gt;

    &lt;citrus-vertx:endpoint id="simpleVertxEndpoint"
          host="localhost"
          port="5001"
          pub-sub-domain="false"
          address="news-feed"/&gt;

    &lt;bean id="vertxInstanceFactory" class="org.citrusframework.vertx.factory.CachingVertxInstanceFactory"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Citrus provides a special Vert.x configuration schema that is used in our Spring Xml bean configurations.
You have to include the <code>citrus-vertx</code> namespace in your Spring configuration XML files as seen in the example above.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The endpoint holds some general information how to access the Vert.x event bus. Host and port values define the Vert.x Hazelcast
cluster hostname and port. Citrus starts a new Vert.x instance using this cluster. So all other Vert.x instances connected to this
cluster host will receive the event bus messages from Citrus during the test. In your test case you can use this endpoint component
referenced by its id or name in order to send and receive messages on the event bus address <strong>news-feed</strong> . In Vert.x the event bus
address defines the destination for event consumers to listen on. As already mentioned cluster hostname and port are optional, so
Citrus will use <strong>localhost</strong> and a new random port on the cluster host if nothing is specified.</p>
</div>
<div class="paragraph">
<p>The Vert.x event bus supports publish-subscribe and point-to-point message communication patterns. By default the <strong>pubSubDomain</strong> in
Citrus is false so the event bus sender will initiate a point-to-point communication on the event bus address. This means that only
one single consumer on the event bus address will receive the message. If there are more consumers on the address the first to come
wins and receives the message. In contrary to that the publish-subscribe scenario would deliver the message to all available consumers
on the event bus address simultaneously. You can enable the <strong>pubSubDomain</strong> on the Vert.x endpoint component for this communication pattern.</p>
</div>
<div class="paragraph">
<p>The Vert.x endpoint needs an instance factory implementation in order to create the embedded Vert.x instance. By default the bean name
<strong>vertxInstanceFactory</strong> is recognized by all Vert.x endpoint components. We will talk about Vert.x instance factories in more detail
later on in this chapter.</p>
</div>
<div class="paragraph">
<p>As message content you can send and receive JSON objects or simple character sequences to the event bus. Let us have a look at a
simple sample sending action that uses the new Vert.x endpoint component:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void vertxTest() {
    then(send()
            .endpoint(simpleVertxEndpoint)
            .message()
                .type(MessageType.PLAINTEXT)
                .body("Hello from Citrus!")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="VertxTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;send endpoint="simpleVertxEndpoint"&gt;
        &lt;message type="plaintext"&gt;
            &lt;body&gt;
              &lt;data&gt;Hello from Citrus!&lt;/data&gt;
            &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: VertxTest
actions:
  - send:
      endpoint: "simpleVertxEndpoint"
      message:
        type: PLAINTEXT
        body:
          data: "Hello from Citrus!"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="vertxTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="simpleVertxEndpoint"&gt;
          &lt;message type="plaintext"&gt;
            &lt;payload&gt;Hello from Citrus!&lt;/payload&gt;
          &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the Vert.x Citrus endpoint is bidirectional you can also receive messages from the event bus.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void vertxTest() {
    then(receive()
            .endpoint(simpleVertxEndpoint)
            .message()
                .type(MessageType.PLAINTEXT)
                .body("Hello from Vert.x!")
                .header("citrus_vertx_address", "news-feed")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="VertxTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;receive endpoint="simpleVertxEndpoint"&gt;
        &lt;message type="plaintext"&gt;
            &lt;body&gt;
              &lt;data&gt;Hello from Vert.x!&lt;/data&gt;
            &lt;/body&gt;
            &lt;headers&gt;
              &lt;header name="citrus_vertx_address" value="news-feed"/&gt;
            &lt;/headers&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: VertxTest
actions:
  - receive:
      endpoint: "simpleVertxEndpoint"
      message:
        type: PLAINTEXT
        body:
          data: "Hello from Vert.x!"
        headers:
          - name: citrus_vertx_address
            value: news-feed</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="vertxTest"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="simpleVertxEndpoint"&gt;
          &lt;message type="plaintext"&gt;
            &lt;payload&gt;Hello from Vert.x!&lt;/payload&gt;
          &lt;/message&gt;
          &lt;header&gt;
            &lt;element name="citrus_vertx_address" value="news-feed"/&gt;
          &lt;/header&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus automatically adds some special message headers to the message, so you can validate the Vert.x event bus address.
This completes the simple send and receive operations on a Vert.x event bus.
Now let&#8217;s move on to synchronous endpoints where Citrus waits for a reply on the event bus.</p>
</div>
</div>
<div class="sect2">
<h3 id="synchronous-vert-x-endpoint"><a class="anchor" href="#synchronous-vert-x-endpoint"></a><a class="link" href="#synchronous-vert-x-endpoint">24.2. Synchronous Vert.x endpoint</a></h3>
<div class="paragraph">
<p>The synchronous Vert.x event bus producer sends a message and waits synchronously for the response to arrive on some reply address destination.
The reply address name is generated automatically and set in the request message header attributes so the receiving counterpart in this
communication can send its reply to that event bus address. The basic configuration for a synchronous Vert.x endpoint component looks like follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public VertxSnycEndpoint vertxSyncEndpoint() {
    return new VertxSyncEndpointBuilder()
        .timeout(1000)
        .address("hello")
        .pollingInterval(300)
        .build();
}

private VertxInstanceFactory vertxInstanceFactory() {
    return new CachingVertxInstanceFactory();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public VertxSnycEndpoint vertxSyncEndpoint() {
    return new VertxSyncEndpointBuilder()
        .timeout(1000)
        .address("hello")
        .pollingInterval(300)
        .build();
}

private VertxInstanceFactory vertxInstanceFactory() {
    return new CachingVertxInstanceFactory();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-vertx="http://www.citrusframework.org/schema/vertx/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/vertx/config
           http://www.citrusframework.org/schema/vertx/config/citrus-vertx-config.xsd"&gt;

    &lt;citrus-vertx:sync-endpoint id="vertxSyncEndpoint"
          address="hello"
          timeout="1000"
          polling-interval="300"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Synchronous endpoints poll for synchronous reply messages to arrive on the event bus reply address. The poll interval is an optional
setting in order to manage the amount of reply message handshake attempts. Once the endpoint was able to receive the reply message
synchronously the test case can receive the reply. In case all message handshake attempts do fail because the reply message is not
available in time we raise some timeout error and the test will fail.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Vert.x endpoint uses temporary reply address destinations. The temporary reply address in generated and is only used once
for a single communication handshake. After that the reply address is dismissed again.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When sending a message to the synchronous Vert.x endpoint the producer will wait synchronously for the response message to arrive
on the reply address. You can receive the reply message in your test case using the same endpoint component. So we have two actions
on the same endpoint, first send then receive.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void vertxTest() {
    when(send()
            .endpoint(vertxSyncEndpoint)
            .message()
                .type(MessageType.PLAINTEXT)
                .body("Hello from Citrus!")
    );

    then(receive()
            .endpoint(vertxSyncEndpoint)
            .message()
                .type(MessageType.PLAINTEXT)
                .body("Hello from Vert.x!")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="VertxTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;send endpoint="vertxSyncEndpoint"&gt;
        &lt;message type="plaintext"&gt;
            &lt;body&gt;
              &lt;data&gt;Hello from Citrus!&lt;/data&gt;
            &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;

      &lt;receive endpoint="vertxSyncEndpoint"&gt;
        &lt;message type="plaintext"&gt;
            &lt;body&gt;
              &lt;data&gt;Hello from Vert.x!&lt;/data&gt;
            &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: VertxTest
actions:
  - send:
      endpoint: "vertxSyncEndpoint"
      message:
        type: PLAINTEXT
        body:
          data: "Hello from Citrus!"
  - receive:
      endpoint: "vertxSyncEndpoint"
      message:
        type: PLAINTEXT
        body:
          data: "Hello from Vert.x!"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="vertxTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="vertxSyncEndpoint"&gt;
          &lt;message type="plaintext"&gt;
            &lt;payload&gt;Hello from Citrus!&lt;/payload&gt;
          &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="vertxSyncEndpoint"&gt;
          &lt;message type="plaintext"&gt;
            &lt;payload&gt;Hello from Vert.x!&lt;/payload&gt;
          &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the last section we saw that synchronous communication is based on reply messages on temporary reply event bus address. We saw that
Citrus is able to send messages to event bus address and wait for reply messages to arrive. This next section deals with the same synchronous
communication, but send and receive roles are switched. Now Citrus receives a message and has to send a reply message to a temporary reply address.</p>
</div>
<div class="paragraph">
<p>We handle this synchronous communication with the same synchronous Vert.x endpoint component. Only difference is that we initially
start the communication by receiving a message from the endpoint. Knowing this Citrus is able to send a synchronous response back.
Again just use the same endpoint reference in your test case. The handling of the temporary reply address is done automatically behind the scenes.
So we have again two actions in our test case, but this time first receive then send.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void vertxTest() {
    when(receive()
            .endpoint(vertxSyncEndpoint)
            .message()
                .type(MessageType.PLAINTEXT)
                .body("Hello from Vert.x!")
    );

    then(send()
            .endpoint(vertxSyncEndpoint)
            .message()
                .type(MessageType.PLAINTEXT)
                .body("This is the reply from Citrus!")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="VertxTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;receive endpoint="vertxSyncEndpoint"&gt;
        &lt;message type="plaintext"&gt;
            &lt;body&gt;
              &lt;data&gt;Hello from Vert.x!&lt;/data&gt;
            &lt;/body&gt;
        &lt;/message&gt;
      &lt;/receive&gt;

      &lt;send endpoint="vertxSyncEndpoint"&gt;
        &lt;message type="plaintext"&gt;
            &lt;body&gt;
              &lt;data&gt;This is the reply from Citrus!&lt;/data&gt;
            &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: VertxTest
actions:
  - receive:
      endpoint: "vertxSyncEndpoint"
      message:
        type: PLAINTEXT
        body:
          data: "Hello from Vert.x!"
  - send:
      endpoint: "vertxSyncEndpoint"
      message:
        type: PLAINTEXT
        body:
          data: "This is the reply from Citrus!"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="vertxTest"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="vertxSyncEndpoint"&gt;
          &lt;message type="plaintext"&gt;
            &lt;payload&gt;Hello from Vert.x!&lt;/payload&gt;
          &lt;/message&gt;
        &lt;/receive&gt;

        &lt;send endpoint="vertxSyncEndpoint"&gt;
          &lt;message type="plaintext"&gt;
            &lt;payload&gt;This is the reply from Citrus!&lt;/payload&gt;
          &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The synchronous message endpoint for Vert.x event bus communication will handle all reply address destinations and provide those behind the scenes.</p>
</div>
</div>
<div class="sect2">
<h3 id="vert-x-instance-factory"><a class="anchor" href="#vert-x-instance-factory"></a><a class="link" href="#vert-x-instance-factory">24.3. Vert.x instance factory</a></h3>
<div class="paragraph">
<p>Citrus starts an embedded Vert.x instance at runtime in order to participate in the Vert.x cluster. Within this cluster multiple Vert.x
instances are connected via the event bus. For starting the Vert.x event bus Citrus uses a cluster hostname and port definition. You can
customize this cluster host in order to connect to a very special cluster in your network.</p>
</div>
<div class="paragraph">
<p>Now Citrus needs to manage the Vert.x instances created during the test run. By default Citrus will look for an instance factory bean
named <strong>vertxInstanceFactory</strong> . You can choose the factory implementation to use in your project. By default you can use the caching factory
implementation that caches the Vert.x instances so we do not connect more than one Vert.x instance to the same cluster host.
Citrus offers following instance factory implementations:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">org.citrusframework.vertx.factory.CachingVertxInstanceFactory</dt>
<dd>
<p>default implementation that reuses the Vert.x instance based on given
cluster host and port. With this implementation we ensure to connect a single Citrus Vert.x instance to a cluster host.</p>
</dd>
<dt class="hdlist1">org.citrusframework.vertx.factory.SingleVertxInstanceFactory</dt>
<dd>
<p>creates a single Vert.x instance and reuses this instance for all endpoints.
You can also set your very custom Vert.x instance via configuration for custom Vert.x instantiation.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The instance factory implementations do implement the <strong><em>VertxInstanceFactory</em></strong> interface. So you can also provide your very special implementation.
By default, Citrus looks for a bean named <strong>vertxInstanceFactory</strong> but you can also define your very special factory implementation onm an endpoint component.
The Vert.x instance factory is set on the Vert.x endpoint as follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public VertxEndpoint vertxHelloEndpoint() {
    return new VertxEndpointBuilder()
        .address("news-feed")
        .vertxInstanceFactory(singleVertxInstanceFactory())
        .build();
}

private VertxInstanceFactory singleVertxInstanceFactory() {
    return new CachingVertxInstanceFactory();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public VertxEndpoint vertxHelloEndpoint() {
    return new VertxEndpointBuilder()
        .address("news-feed")
        .vertxInstanceFactory(singleVertxInstanceFactory())
        .build();
}

private VertxInstanceFactory singleVertxInstanceFactory() {
    return new SingleVertxInstanceFactory();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-vertx="http://www.citrusframework.org/schema/vertx/config"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.citrusframework.org/schema/config
       http://www.citrusframework.org/schema/config/citrus-config.xsd
       http://www.citrusframework.org/schema/vertx/config
       http://www.citrusframework.org/schema/vertx/config/citrus-vertx-config.xsd"&gt;

    &lt;citrus-vertx:endpoint id="vertxHelloEndpoint"
          address="news-feed"
          vertx-factory="singleVertxInstanceFactory"/&gt;

    &lt;bean id="singleVertxInstanceFactory"
          class="org.citrusframework.vertx.factory.SingleVertxInstanceFactory"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jdbc"><a class="anchor" href="#jdbc"></a><a class="link" href="#jdbc">25. JDBC support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Database communication is an essential part of many applications, when persistent data storage is required.
May it be orders, customer data, product recommendations or product information, if persistent storage is in place,
the data contains a certain business value. Therefore it&#8217;s important that your software handles your persistent storage
the right way. To ensure that, Citrus offers a JDBC server endpoint that allows you to verify the communication between
your application and a real database server which is accessible via the Citrus-JDBC-Driver.</p>
</div>
<div class="paragraph">
<p>To enable the JDBC support for your test project, you&#8217;ll have to add the following dependency.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-jdbc&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
  &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="jdbc-driver"><a class="anchor" href="#jdbc-driver"></a><a class="link" href="#jdbc-driver">25.1. The Citrus-JDBC-Driver</a></h3>
<div class="paragraph">
<p>The Citrus-JDBC-Driver is a JDBC conform driver that realizes the communication with the Citrus-JDBC-Server. To be able
to use Citrus-JDBC within a CI/CD setup, we recommend to ensure that your software is able to exchange the JDBC driver
by configuration. The Citrus-JDBC-Driver is available on maven central under
<code>org.citrusframework.citrus-db-driver</code>. After the driver has been downloaded and configured to be used by your
application, please make sure that the driver configuration matches the Citrus-JDBC-Server configuration in your
tests.</p>
</div>
<div class="listingblock">
<div class="title">Example jdbc driver configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;systemProperties&gt;
    &lt;systemProperty&gt;
      &lt;name&gt;todo.persistence.type&lt;/name&gt;
      &lt;value&gt;jdbc&lt;/value&gt;
    &lt;/systemProperty&gt;
    &lt;systemProperty&gt;
      &lt;name&gt;todo.jdbc.driverClassName&lt;/name&gt;
      &lt;value&gt;org.citrusframework.db.driver.JdbcDriver&lt;/value&gt;
    &lt;/systemProperty&gt;
    &lt;systemProperty&gt;
      &lt;name&gt;todo.jdbc.url&lt;/name&gt;
      &lt;value&gt;jdbc:citrus:http://localhost:3306/testdb&lt;/value&gt;
    &lt;/systemProperty&gt;
&lt;/systemProperties&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Citrus-JDBC-Server matching the driver config</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JdbcServer jdbcServer() {
    return CitrusEndpoints.jdbc()
        .server()
        .host("localhost")
        .databaseName("testdb")
        .port(3306)
        .build();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jdbc-server"><a class="anchor" href="#jdbc-server"></a><a class="link" href="#jdbc-server">25.2. The Citrus-JDBC-Server</a></h3>
<div class="paragraph">
<p>To setup a JDBC endpoint within your tests, just configure it as any other endpoint via e.g.  XML, Spring Bean or by
Citrus Annotations.</p>
</div>
<div class="listingblock primary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JdbcServer jdbcServer() {
    return CitrusEndpoints.jdbc()
        .server()
        .host("localhost")
        .databaseName("testdb")
        .port(4567)
        .timeout(10000L)
        .autoStart(true)
        .autoTransactionHandling(false)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-jdbc:server id="testServer"
                      host="citrus-jdbc-test-server"
                      port="4567"
                      database-name="test-db"
                      max-connections="50"
                      auto-start="true"/&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Citrus Annotations</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusEndpoint
@JdbcServerConfig(
            databaseName = "testdb",
            autoStart = true,
            port = 4567)
private JdbcServer jdbcServer;</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that configuration has been done, you&#8217;ll be able to use the Server within your tests to receive and send messages
from or to your system under test.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Test
@CitrusTest
public void testAddTodoEntry() {
    variable("todoName", "citrus:concat('todo_', citrus:randomNumber(4))");
    variable("todoDescription", "Description: ${todoName}");

    http()
        .client(todoClient)
        .send()
        .post("/todolist")
        .fork(true)
        .contentType("application/x-www-form-urlencoded")
        .payload("title=${todoName}&amp;description=${todoDescription}");

    receive(jdbcServer)
        .messageType(MessageType.JSON)
        .message(JdbcMessage.execute(
            "@startsWith('INSERT INTO todo_entries (id, title, description, done) VALUES (?, ?, ?, ?)')@"));<i class="conum" data-value="1"></i><b>(1)</b>

    send(jdbcServer)
        .message(JdbcMessage.result().rowsUpdated(1));<i class="conum" data-value="2"></i><b>(2)</b>

    http()
        .client(todoClient)
        .receive()
        .response(HttpStatus.FOUND.value());

    http()
        .client(todoClient)
        .send()
        .get("/todolist")
        .fork(true)
        .accept("text/html");

    receive(jdbcServer)
            .message(JdbcMessage.execute("SELECT id, title, description FROM todo_entries"));<i class="conum" data-value="3"></i><b>(3)</b>

    send(jdbcServer)
        .messageType(MessageType.JSON)
        .message(JdbcMessage.result().dataSet("[ {" +
                    "\"id\": \"" + UUID.randomUUID().toString() + "\"," +
                    "\"title\": \"${todoName}\"," +
                    "\"description\": \"${todoDescription}\"," +
                    "\"done\": \"false\"" +
                "} ]"));<i class="conum" data-value="4"></i><b>(4)</b>

    http()
        .client(todoClient)
        .receive()
        .response(HttpStatus.OK.value())
        .messageType(MessageType.XHTML)
        .xpath("(//xh:li[@class='list-group-item']/xh:span)[last()]", "${todoName}");
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Expects a <code>INSERT</code> statement matching the given expression.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Responds with a result set stating, that one row has been updated/created.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Expects a <code>SELECT</code> statement matching the given statement.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Responds with the DataSet specified as JSON string.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="jdbc-server-transactions"><a class="anchor" href="#jdbc-server-transactions"></a><a class="link" href="#jdbc-server-transactions">25.2.1. Transactions</a></h4>
<div class="paragraph">
<p>When it comes to complex modifications of your database, transactions are commonly used.
Citrus is able to verify the behavior of your system under test concerning start, commit and rollback
actions of transactions. The verification of transactions has to be enabled in the server Citrus-JDBC-Server
configuration. For more information, please have a look at the <a href="#jdbc-server-configuration">Configuration</a> section.</p>
</div>
<div class="listingblock">
<div class="title">Verifying transaction commit</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(jdbcServer)
    .message(JdbcMessage.startTransaction());<i class="conum" data-value="1"></i><b>(1)</b>

receive(jdbcServer)
    .message(JdbcMessage.execute("@startsWith('INSERT INTO todo_entries (id, title, description, done) VALUES (?, ?, ?, ?)')@"));

send(jdbcServer)
    .message(JdbcMessage.result().rowsUpdated(1));

receive(jdbcServer)
    .message(JdbcMessage.commitTransaction());<i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Verify, that the transaction has been started.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Verify, that the modification of the database has been committed.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is also possible to simulate an erroneous modification including the verification of a rollback.</p>
</div>
<div class="listingblock">
<div class="title">Verifiying transaction rollback</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(jdbcServer)
    .message(JdbcMessage.startTransaction());<i class="conum" data-value="1"></i><b>(1)</b>

receive(jdbcServer)
    .message(JdbcMessage.execute("@startsWith('INSERT INTO todo_entries (id, title, description, done) VALUES (?, ?, ?, ?)')@"));

send(jdbcServer)
    .message(JdbcMessage.result().exception("Could not execute something"));

receive(jdbcServer)
    .message(JdbcMessage.rollbackTransaction());<i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Verify, that the transaction has been started.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Verify, that a rollback occurred after the database exception has been send.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-server-prepared-statements"><a class="anchor" href="#jdbc-server-prepared-statements"></a><a class="link" href="#jdbc-server-prepared-statements">25.2.2. Prepared statements</a></h4>
<div class="paragraph">
<p>Because prepared statements work slightly different than simple database queries, the validation of those is also
slightly different. Currently, Citrus offers you the possibility to verify that your application has created the
correct prepared statement, that it was executed with the correct parameters and that it has been closed.</p>
</div>
<div class="listingblock">
<div class="title">Verifying prepared statement</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(jdbcServer)
    .message(JdbcMessage.createPreparedStatement("INSERT INTO todo_entries (id, title, description, done) VALUES (?, ?, ?, ?)"));<i class="conum" data-value="1"></i><b>(1)</b>

receive(jdbcServer)
    .message(JdbcMessage.execute(
        "INSERT INTO todo_entries (id, title, description, done) VALUES (?, ?, ?, ?) - (1,sample,A sample todo,false)"));<i class="conum" data-value="2"></i><b>(2)</b>

receive(jdbcServer)
    .message(JdbcMessage.closeStatement());<i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Verify that the given prepared statement has been created.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Verify that the statement has been executed with the parameters <code>1,sample,A sample todo,false</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Verify that the statement has been closed.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please notice, that the verification of <code>createPreparedStatement</code> and <code>closeStatement</code> messages has to be activated
via configuration. For more information, please have a look at the <a href="#jdbc-server-configuration">Configuration</a> section.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-server-callable-statements"><a class="anchor" href="#jdbc-server-callable-statements"></a><a class="link" href="#jdbc-server-callable-statements">25.2.3. Callable statements / stored procedures</a></h4>
<div class="paragraph">
<p>As well as prepared statements, callable statements are different from simple queries. Callable statements are used
on jdbc level to access stored procedures, functions, etc. on the database server.</p>
</div>
<div class="listingblock">
<div class="title">Verifying callable statement</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(jdbcServer)
    .message(JdbcMessage.createCallableStatement("{CALL limitedToDoList(?)}"));<i class="conum" data-value="1"></i><b>(1)</b>

receive(jdbcServer)
    .message(JdbcMessage.execute("{CALL limitedToDoList(?)} - (1)"));<i class="conum" data-value="2"></i><b>(2)</b>

send(jdbcServer)
    .messageType(MessageType.XML)
    .message(JdbcMessage.result().dataSet("" +
            "&lt;dataset&gt;" +
                "&lt;row&gt;" +
                    "&lt;id&gt;1&lt;/id&gt;"+
                    "&lt;title&gt;sample&lt;/title&gt;"+
                    "&lt;description&gt;A sample todo&lt;/description&gt;" +
                    "&lt;done&gt;false&lt;/done&gt;" +
                 "&lt;/row&gt;" +
                "&lt;/dataset&gt;"));

receive(jdbcServer)
    .message(JdbcMessage.closeStatement());<i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Verify that the given callable statement has been created.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Verify that the statement has been executed with the parameter <code>1</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Verify that the statement has been closed.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you might have noticed, callable statements and prepared statements have nearly the same workflow in Citrus. The only
difference is the creation of the statement itself. It is also the case that the verification of
<code>createCallableStatement</code> and <code>closeStatement</code> messages has to be activated via configuration. For more information,
please have a look at the <a href="#jdbc-server-configuration">Configuration</a> section.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-server-configuration"><a class="anchor" href="#jdbc-server-configuration"></a><a class="link" href="#jdbc-server-configuration">25.2.4. Configuration</a></h4>
<div class="paragraph">
<p>As already mentioned, you&#8217;re able to configure the JDBC endpoint in different ways (XML, Spring Bean, etc. ).
The following properties are available to configure the server for your test scenario.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 18.1818%;">
<col style="width: 18.1818%;">
<col style="width: 18.1818%;">
<col style="width: 45.4546%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Mandatory</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Only required for XML configuration.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">auto connect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Determines whether the server should automatically accept connection related messages or validate them.
This includes <code>openConnection</code> and <code>closeConnection</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">auto create statement</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Determines whether the server should automatically accept statement related messages or validate them.
This includes <code>createStatement</code>, <code>createPreparedStatement</code>, <code>createCallableStatement</code> and <code>closeStatement</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">auto transaction handling</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Determines whether the server should automatically accept transaction related messages or validate them.
This includes <code>startTransaction</code>, <code>commitTransaction</code> and <code>rollbackTransaction</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">auto handle queries</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Collection of system queries for different databases</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Determines whether the server should automatically respond with a positive answer for matching queries, e.g. <code>SELECT USER FROM DUAL</code>. You can override the currently defined validation queries when setting <code>citrus.jdbc.auto.handle.query</code> system property within the citrus-application.properties. The property value is expected to be a  semicolon separated list of regex patterns. Every query can be specified as a regular expression, e.g. <code>SELECT.*FROM DUAL;SELECT \\w;</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">host</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The hostname of the server. There has to be a valid route between the test suite, the system under test and the
database server.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4567</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The port the server listens to.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">database name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The database name to work on</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">max connections</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The maximum amount of open connections to be accepted by the server.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">polling interval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">500</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Polling interval when waiting for synchronous reply message to arrive.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5000</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Send/receive timeout setting</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">debug logging</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Determines whether the inbound channel debug logging should be enabled.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In addition, there are advanced configuration possibilities to customize the behavior of the JDBC server.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 18.1818%;">
<col style="width: 18.1818%;">
<col style="width: 18.1818%;">
<col style="width: 45.4546%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Mandatory</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">correlator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DefaultMessageCorrelator</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A MessageCorrelator implementation to identify messages.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">endpoint adapter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JdbcEndpointAdapterController</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>An Endpoint adapter implementation creating the messages for validation.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="jdbc-message"><a class="anchor" href="#jdbc-message"></a><a class="link" href="#jdbc-message">25.3. JdbcMessage</a></h3>
<div class="paragraph">
<p>The JdbcMessage class is the central location to specifying your expected inbound and outbound communication for the
JDBC endpoint.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 41.6666%;">
<col style="width: 16.6666%;">
<col style="width: 41.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Message</th>
<th class="tableblock halign-left valign-top">receive/send</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.openConnection(Properties properties)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">receive</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>States that a connection has been opened with the given properties. The evaluation of connections has to be enabled
via the endpoint configuration.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.closeConnection()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">receive</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>States that the connection has been closed. The evaluation of connections has to be enabled
via the endpoint configuration.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.createStatement()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">receive</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>States that a statement has been created. The evaluation of statement handling has to be enabled via the endpoint
configuration.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.createPreparedStatement(String sql)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">receive</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>States that a SQL statement matching the given expression has been created. The evaluation of statement handling
has to be enabled via the endpoint configuration.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.createCallableStatement(String sql)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">receive</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>States that a callable statement referencing a function or procedure that is matching the given expression has been
created. The evaluation of statement handling has to be enabled via the endpoint configuration.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.closeStatement()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">receive</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>States that a statement has been closed. The evaluation of statement handling has to be enabled via the endpoint
configuration.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.execute(String sql)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">receive</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>States that a SQL statement matching the given expression has been executed.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.startTransaction()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">receive</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>States that a transaction start has been received. The evaluation of transaction handling has to be enabled via
the endpoint configuration.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.commitTransaction()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">receive</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>States that a commit for a transaction has been received. The evaluation of transaction handling has to be enabled via
the endpoint configuration.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.rollbackTransaction()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">receive</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>States that a rollback of the transaction has been received. The evaluation of transaction handling has to be enabled
via the endpoint configuration.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.result()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">send</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sends a positive empty result to the system under test.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.result(boolean success)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">send</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sends empty result to the system under test which is a success or a failure based on the given boolean value.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.exception(String exceptionText)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">send</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sends an exception to the system under test. Regarding the driver documentation, the error will be an SQLException.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.rowsUpdated(int number)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">send</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sends a positive result to the system under test where the payload is the number of updated rows.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.dataSet(DataSet dataSet)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">send</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sends a positive result to the system under test where the payload is the specified DataSet.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.dataSet(String dataSet)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">send</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sends a positive result to the system under test where the payload is the specified DataSet. To use this, you have
to specify the format of the dataSet String. Please refer to the section <a href="#jdbc-message-dataset-parsing">DataSet parsing</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.dataSet(Resource dataSet)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">send</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sends a positive result to the system under test where the payload is the content of the specified resource.
To use this, you have to specify the format of the dataSet String. Please refer to the section
<a href="#jdbc-message-dataset-parsing">DataSet parsing</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.success()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">send</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sends a positive empty result to the system under test.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JdbcMessage.error()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">send</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sends an empty error result to the system under test.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="jdbc-message-dataset-parsing"><a class="anchor" href="#jdbc-message-dataset-parsing"></a><a class="link" href="#jdbc-message-dataset-parsing">25.3.1. DataSet parsing</a></h4>
<div class="paragraph">
<p>Citrus provides different ways to prepare the response DataSets for your system under test. You can specify your
DataSets as Java Objects, as XML or JSON Strings or as resource file containing your XML or JSON DataSet as text.</p>
</div>
<div class="listingblock">
<div class="title">Java dataset creation example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Row sheldon = new Row();
sheldon.getValues().put("id", "1");
sheldon.getValues().put("name", "Sheldon");
sheldon.getValues().put("profession", "physicist");

Row leonard = new Row();
leonard.getValues().put("id", "2");
leonard.getValues().put("name", "Leonard");
leonard.getValues().put("profession", "physicist");
leonard.getValues().put("email", "leo@bigbangtheory.org");

Row penny = new Row();
penny.getValues().put("id", "3");
penny.getValues().put("name", "Penny");
penny.getValues().put("profession", "this_and_that");

Table table = new Table("user");
table.getRows().add(sheldon);
table.getRows().add(leonard);
table.getRows().add(penny);

DataSet userDataSet = new TableDataSetProducer(table).produce();

send(jdbcServer).message(JdbcMessage.result().dataSet(userDataSet));</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you use the XML or JSON notation as string or within a resource, you&#8217;ll have to specify that in your test setup.</p>
</div>
<div class="listingblock">
<div class="title">Java json dataset creation example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(jdbcServer)
                .message(JdbcMessage.execute("SELECT id, title, description FROM todo_entries"));

send(jdbcServer)
        .messageType(MessageType.JSON)<i class="conum" data-value="1"></i><b>(1)</b>
        .message(JdbcMessage.result().dataSet("[ {" +
                    "\"id\": \"" + UUID.randomUUID().toString() + "\"," +
                    "\"title\": \"${todoName}\"," +
                    "\"description\": \"${todoDescription}\"," +
                    "\"done\": \"false\"" +
                "} ]"));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Tells Citrus that the response has to be interpreted as JSON.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Java xml dataset creation example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">receive(jdbcServer)
        .message(JdbcMessage.execute("SELECT id, title, description FROM todo_entries"));
send(jdbcServer)
        .messageType(MessageType.XML)<i class="conum" data-value="1"></i><b>(1)</b>
        .message(JdbcMessage.result().dataSet("" +
                "&lt;dataset&gt;" +
                    "&lt;row&gt;" +
                        "&lt;id&gt;${todoId}&lt;/id&gt;"+
                        "&lt;title&gt;${todoName}&lt;/title&gt;"+
                        "&lt;description&gt;${todoDescription}&lt;/description&gt;" +
                        "&lt;done&gt;false&lt;/done&gt;" +
                     "&lt;/row&gt;" +
                "&lt;/dataset&gt;"));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Tells Citrus that the response has to be interpreted as XML.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Technically it is not required to specify the messages as <code>MessageType.XML</code>, because the default message type
in citrus currently <strong>is</strong> XML. Nevertheless we highly recommend to specify the message type. This will ensure that your
tests sustain future changes.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="docker"><a class="anchor" href="#docker"></a><a class="link" href="#docker">26. Docker support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Citrus provides configuration components and test actions for interaction with a Docker daemon. The Citrus docker client component will execute Docker commands for container management such as start, stop, build, inspect and so on. The Docker client by default uses the Docker remote REST API. As a user you can execute Docker commands as part of a Citrus test and validate possible command results.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Docker test components in Citrus are kept in a separate Maven module. If not already done, you have to include the module as Maven dependency to your project
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-docker&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus provides a "citrus-docker" configuration namespace and schema definition for Docker related components and actions. Include this namespace into your Spring configuration in order to use the Citrus Docker configuration elements. The namespace URI and schema location are added to the Spring configuration XML file as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus-docker="http://www.citrusframework.org/schema/docker/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/docker/config
           http://www.citrusframework.org/schema/docker/config/citrus-docker-config.xsd"&gt;

    [...]

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that you are able to use customized Citrus XML elements in order to define the Spring beans.</p>
</div>
<div class="sect2">
<h3 id="docker-client"><a class="anchor" href="#docker-client"></a><a class="link" href="#docker-client">26.1. Docker client</a></h3>
<div class="paragraph">
<p>Citrus operates with the Docker remote REST API in order to interact with the Docker daemon. The Docker client is defined as Spring bean component in the configuration as follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public DockerClient dockerClient() {
    return new DockerClientBuilder().build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public DockerClient dockerClient() {
    return new DockerClientBuilder().build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-docker:client id="dockerClient"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Docker client component above is using all default configuration values. By default, Citrus is searching the system properties as well as environment variables for default Docker settings such as:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
DOCKER_HOST
</td>
<td class="hdlist2">
<p>tcp://localhost:2376</p>
</td>
</tr>
<tr>
<td class="hdlist1">
DOCKER_CERT_PATH
</td>
<td class="hdlist2">
<p>~/.docker/machine/machines/default</p>
</td>
</tr>
<tr>
<td class="hdlist1">
DOCKER_TLS_VERIFY
</td>
<td class="hdlist2">
<p>1</p>
</td>
</tr>
<tr>
<td class="hdlist1">
DOCKER_MACHINE_NAME
</td>
<td class="hdlist2">
<p>default</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In case these settings are not settable in your environment you can also use explicit settings in the Docker client component:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public DockerClient dockerClient() {
    return new DockerClientBuilder()
            .url("tcp://localhost:2376")
            .version("1.20")
            .username("user")
            .password("s!cr!t")
            .email("user@foo.bar")
            .registry("https://index.docker.io/v1/")
            .certPath("/path/to/some/cert/directory")
            .configPath("/path/to/some/config/directory")
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public DockerClient dockerClient() {
    return new DockerClientBuilder()
            .url("tcp://localhost:2376")
            .version("1.20")
            .username("user")
            .password("s!cr!t")
            .email("user@foo.bar")
            .registry("https://index.docker.io/v1/")
            .certPath("/path/to/some/cert/directory")
            .configPath("/path/to/some/config/directory")
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-docker:client id="dockerClient"
            url="tcp://localhost:2376"
            version="1.20"
            username="user"
            password="s!cr!t"
            email="user@foo.bar"
            registry="https://index.docker.io/v1/"
            cert-path="/path/to/some/cert/directory"
            config-path="/path/to/some/config/directory"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now Citrus is able to access the Docker remote API for executing commands such as start, stop, build, inspect and so on.</p>
</div>
</div>
<div class="sect2">
<h3 id="docker-commands"><a class="anchor" href="#docker-commands"></a><a class="link" href="#docker-commands">26.2. Docker commands</a></h3>
<div class="paragraph">
<p>We have several Citrus test actions each representing a Docker command.
These actions can be part of a test case where you can manage Docker containers inside the test.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void dockerTest() {
    when(docker().ping());

    then(docker().version()
        .validateCommandResult(new CommandResultCallback&lt;Version&gt;() {
            @Override
            public void doWithCommandResult(Version version, TestContext context) {
                Assert.assertEquals(version.getApiVersion(), "1.21");
            }
    }));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="DockerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;docker&gt;
        &lt;ping/&gt;
      &lt;/docker&gt;

      &lt;docker&gt;
        &lt;version/&gt;
      &lt;/docker&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: DockerTest
actions:
  - docker:
      ping: {}

  - docker:
      version: {}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:docker="http://www.citrusframework.org/schema/docker/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/docker/testcase
              http://www.citrusframework.org/schema/docker/testcase/citrus-docker-testcase.xsd"&gt;
  &lt;testcase name="DockerTest"&gt;
    &lt;actions&gt;
      &lt;docker:ping&gt;&lt;/docker:ping&gt;

      &lt;docker:version&gt;
        &lt;docker:expect&gt;
          &lt;docker:result&gt;
            &lt;![CDATA[
              {
                "Version":"1.8.3",
                "ApiVersion":"1.21",
                "GitCommit":"@ignore@",
                "GoVersion":"go1.4.2",
                "Os":"darwin",
                "Arch":"amd64",
                "KernelVersion":"@ignore@"
              }
            ]]&gt;
          &lt;/docker:result&gt;
        &lt;/docker:expect&gt;
      &lt;/docker:version&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We added a special docker namespace in Spring XML with the prefix <strong>docker:</strong> so now we can start to add Docker test actions to the test case:
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this very simple example we first ping the Docker daemon to make sure we have connectivity up and running. After that we get the Docker version information. The second action shows an important concept when executing Docker commands in Citrus. As a tester we might be interested in validating the command result. So we can specify an optional <strong>docker:result</strong> which is usually in JSON data format. As usual we can use test variables here and ignore some values explicitly such as the <strong>GitCommit</strong> value.</p>
</div>
<div class="paragraph">
<p>Based on that we can execute several Docker commands in a test case:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void dockerTest() {
    variable("imageId", "busybox");
    variable("containerName", "citrus_box");

    given(docker().pull()
        .image("${imageId}")
        .tag("latest"));

    when(docker().create()
        .image("${imageId}")
        .containerName("${containerName}")
        .cmd("top")
        .validateCommandResult(new CommandResultCallback&lt;CreateContainerResponse&gt;() {
            @Override
            public void doWithCommandResult(CreateContainerResponse result, TestContext context) {
                Assert.assertNull(result.getWarnings());
                context.getVariables().put("containerId", result.getId());
            }
        })
    );

    then(docker().start()
        .containerName("${containerName}")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="DockerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;docker&gt;
        &lt;pull/&gt;
      &lt;/docker&gt;

      &lt;docker&gt;
        &lt;create/&gt;
      &lt;/docker&gt;

      &lt;docker&gt;
        &lt;start/&gt;
      &lt;/docker&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: DockerTest
actions:
  - docker:
      pull: {}

  - docker:
      create: {}

  - docker:
      start: {}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:docker="http://www.citrusframework.org/schema/docker/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/docker/testcase
              http://www.citrusframework.org/schema/docker/testcase/citrus-docker-testcase.xsd"&gt;
  &lt;testcase name="DockerTest"&gt;
    &lt;variables&gt;
      &lt;variable name="imageId" value="busybox"/&gt;
      &lt;variable name="containerName" value="citrus_box"/&gt;
    &lt;/variables&gt;

    &lt;actions&gt;
      &lt;docker:pull image="${imageId}"
                    tag="latest"/&gt;

      &lt;docker:create image="${imageId}"
                      name="${containerName}"
                      cmd="top"&gt;
        &lt;docker:expect&gt;
            &lt;docker:result&gt;
                &lt;![CDATA[
                  {"Id":"@variable(containerId)@","Warnings":null}
                ]]&gt;
            &lt;/docker:result&gt;
        &lt;/docker:expect&gt;
      &lt;/docker:create&gt;

      &lt;docker:start container="${containerName}"/&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example we pull a Docker image, build a new container out of this image and start the container. As you can see each Docker command action offers attributes such as <strong>container</strong>, <strong>image</strong> or <strong>tag</strong> . These are command settings that are available on the Docker command specification. Read more about the Docker commands and the specific settings in official Docker API reference guide.</p>
</div>
<div class="paragraph">
<p>Citrus supports the following Docker commands with respective test actions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>docker:pull</strong></p>
</li>
<li>
<p><strong>docker:build</strong></p>
</li>
<li>
<p><strong>docker:create</strong></p>
</li>
<li>
<p><strong>docker:start</strong></p>
</li>
<li>
<p><strong>docker:stop</strong></p>
</li>
<li>
<p><strong>docker:wait</strong></p>
</li>
<li>
<p><strong>docker:ping</strong></p>
</li>
<li>
<p><strong>docker:version</strong></p>
</li>
<li>
<p><strong>docker:inspect</strong></p>
</li>
<li>
<p><strong>docker:remove</strong></p>
</li>
<li>
<p><strong>docker:info</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some of the Docker commands can be executed both on container and image targets such as <strong>docker:inspect</strong> or <strong>docker:remove</strong> . The command action then offers both <strong>container</strong> and <strong>image</strong> attributes so the user can choose the target of the command operation to be a container or an image.</p>
</div>
<div class="paragraph">
<p>The Java DSL Docker commands provide an optional Docker <strong>CommandResultCallback</strong> that is called with the unmarshalled command result object. In the example above the <em>Version</em> model object is passed as argument to the callback. So the tester can access the command result and validate its properties with assertions.</p>
</div>
<div class="paragraph">
<p>By default, Citrus tries to find a Docker client component within the Citrus Spring application context. If not present Citrus will instantiate a default docker client with all default settings. You can also explicitly set the docker client instance when using the Java DSL Docker command actions:</p>
</div>
<div class="listingblock">
<div class="title">Java DSL</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
private DockerClient dockerClient;

@CitrusTest
public void dockerTest() {
    docker().client(dockerClient).version()
        .validateCommandResult(new CommandResultCallback&lt;Version&gt;() {
            @Override
            public void doWithCommandResult(Version version, TestContext context) {
                Assert.assertEquals(version.getApiVersion(), "1.20");
            }
    });

    docker().client(dockerClient).ping();

    docker().client(dockerClient).start("my_container");
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ssh"><a class="anchor" href="#ssh"></a><a class="link" href="#ssh">27. SSH support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the spirit of other Citrus mock services, there is support for simulating an external SSH server as well as for connecting to SSH servers as a client during the test execution. Citrus translates SSH requests and responses to simple XML documents for better validation with the common Citrus mechanisms.</p>
</div>
<div class="paragraph">
<p>This means that the Citrus test case does not deal with pure SSH protocol commands. Instead of this we use the powerful XML validation capabilities in Citrus when dealing with the simple XML documents that represent the SSH request/response data.</p>
</div>
<div class="paragraph">
<p>Let us clarify this with a little example. Once the real SSH server daemon is fired up within Citrus we accept an SSH EXEC request for instance. The request is translated into an XML message of the following format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;ssh-request xmlns="http://www.citrusframework.org/schema/ssh/message"&gt;
  &lt;command&gt;cat - | sed -e 's/Hello/Hello SSH/'&lt;/command&gt;
  &lt;stdin&gt;Hello World&lt;/stdin&gt;
&lt;/ssh-request&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This message can be validated with the usual Citrus mechanism in a receive test action. If you do not know how to do this, please read one of the sections about XML message validation in this reference guide first. Now after having received this request message the respective SSH response should be provided as appropriate answer. This is done with a message sending action on a reply handler as it is known from synchronous http message communication in Citrus for instance. The SSH XML representation of a response message looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;ssh-response xmlns="http://www.citrusframework.org/schema/ssh/message"&gt;
  &lt;stdout&gt;Hello SSH World&lt;/stdout&gt;
  &lt;stderr&gt;&lt;/stderr&gt;
  &lt;exit&gt;0&lt;/exit&gt;
&lt;/ssh-response&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Besides simulating a full-featured SSH server, Citrus also provides SSH client functionality. This client uses the same request message pattern, which is translated into a real SSH call to an SSH server. The SSH response received is also translated into an XML message as shown above so we can validate it with known validation mechanisms in Citrus.</p>
</div>
<div class="paragraph">
<p>Both, SSH server and client along with their configuration options are described in the following two sections.</p>
</div>
<div class="sect2">
<h3 id="ssh-client"><a class="anchor" href="#ssh-client"></a><a class="link" href="#ssh-client">27.1. SSH Client</a></h3>
<div class="paragraph">
<p>A Citrus SSH client is useful for testing against a real SSH server. So Citrus is able to invoke SSH commands on the external server and validate the SSH response accordingly. The test case does not deal with the pure SSH protocol within this communication. The Citrus SSH client component expects a customized XML representation and automatically translates these request messages into a real SSH call to a specific host. Once the synchronous SSH response was received the result gets translated back to the XML response message representation. On this translated response we can easily apply the validation steps by the usual Citrus means.</p>
</div>
<div class="paragraph">
<p>The SSH client components receive its configuration in the Spring application context as usual. We can use the special SSH module namespace for easy configuration:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public SshClient sshClient() {
    return new SshClientBuilder()
        .host("localhost")
        .port(9072)
        .user("roland")
        .privateKeyPath("classpath:org/citrusframework/ssh/test_user.priv")
        .strictHostChecking(false)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SshClient sshClient() {
    return new SshClientBuilder()
        .host("localhost")
        .port(9072)
        .user("roland")
        .privateKeyPath("classpath:org/citrusframework/ssh/test_user.priv")
        .strictHostChecking(false)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus-ssh="http://www.citrusframework.org/schema/ssh/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/ssh/config
           http://www.citrusframework.org/schema/ssh/config/citrus-ssh-config.xsd"&gt;

    &lt;citrus-ssh:client id="sshClient"
           port="9072"
           user="roland"
           private-key-path="classpath:org/citrusframework/ssh/test_user.priv"
           strict-host-checking="false"
           host="localhost"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Similar to the other Citrus modules (http, soap), a Citrus SSH server and client is configured in Citrus Spring application context.
There is a dedicated <strong>ssh</strong> namespace available for all ssh Citrus components.
The namespace declaration goes into the Spring XML bean configuration top-level element as usual.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The SSH client receives several attributes, these are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
id
</td>
<td class="hdlist2">
<p>Id identifying the bean and used as reference from with test descriptions. (e.g. id="sshClient")</p>
</td>
</tr>
<tr>
<td class="hdlist1">
host
</td>
<td class="hdlist2">
<p>Host to connect to for sending an SSH Exec request. Default is 'localhost' (e.g. host="localhost")
port: Port to use. Default is 2222 (e.g. port="9072")</p>
</td>
</tr>
<tr>
<td class="hdlist1">
private-key-path
</td>
<td class="hdlist2">
<p>Path to a private key, which can be either a plain file path or a class resource if prefixed with 'classpath' (e.g. private-key-path="classpath:test_user.priv")</p>
</td>
</tr>
<tr>
<td class="hdlist1">
private-key-password
</td>
<td class="hdlist2">
<p>Optional password for the private key (e.g. password="s!cr!t")</p>
</td>
</tr>
<tr>
<td class="hdlist1">
user
</td>
<td class="hdlist2">
<p>User used for connecting to the SSH server (e.g. user="roland")</p>
</td>
</tr>
<tr>
<td class="hdlist1">
password
</td>
<td class="hdlist2">
<p>Password used for password based authentication. Might be combined with "private-key-path" in which case both authentication mechanism are tried (e.g. password=&quot;ps!st)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
strict-host-checking
</td>
<td class="hdlist2">
<p>Whether the host key should be verified by looking it up in a 'known_hosts' file. Default is false (e.g. strict-host-checking="true")</p>
</td>
</tr>
<tr>
<td class="hdlist1">
known-hosts-path
</td>
<td class="hdlist2">
<p>Path to a known hosts file. If prefixed with 'classpath:' this file is looked up as a resource in the classpath (e.g. known-hosts-path="/etc/ssh/known_hosts")</p>
</td>
</tr>
<tr>
<td class="hdlist1">
command-timeout
</td>
<td class="hdlist2">
<p>Timeout in milliseconds for how long to wait for the SSH command to complete. Default is 5 minutes (e.g. command-timeout="300000")</p>
</td>
</tr>
<tr>
<td class="hdlist1">
connection-timeout
</td>
<td class="hdlist2">
<p>Timeout in milliseconds for how long to for a connectiuon to connect. Default is 1 minute (e.g. connection-timeout="60000")</p>
</td>
</tr>
<tr>
<td class="hdlist1">
actor
</td>
<td class="hdlist2">
<p>Actor used for switching groups of actions (e.g. actor="ssh-mock")</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once defines as client component in the Spring application context test cases can reference the client in every send test action.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;send endpoint="sshClient"&gt;
  &lt;message&gt;
    &lt;payload&gt;
        &lt;ssh-request xmlns="http://www.citrusframework.org/schema/ssh/message"&gt;
          &lt;command&gt;shutdown&lt;/command&gt;
          &lt;stdin&gt;input&lt;/stdin&gt;
        &lt;/ssh-request&gt;
    &lt;/payload&gt;
  &lt;/message&gt;
&lt;/send&gt;

&lt;receive endpoint="sshClient"&gt;
  &lt;message&gt;
    &lt;payload&gt;
        &lt;ssh-response xmlns="http://www.citrusframework.org/schema/ssh/message"&gt;
            &lt;stdout&gt;Hello Citrus&lt;/stdout&gt;
            &lt;stderr/&gt;
            &lt;exit&gt;0&lt;/exit&gt;
        &lt;/ssh-response&gt;
    &lt;/payload&gt;
  &lt;/message&gt;
&lt;/receive&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we use usual send and receive test actions. The XML SSH representation helps us to specify the request and response data for validation. This way you can call SSH commands against an external SSH server and validate the response data.</p>
</div>
</div>
<div class="sect2">
<h3 id="ssh-server"><a class="anchor" href="#ssh-server"></a><a class="link" href="#ssh-server">27.2. SSH Server</a></h3>
<div class="paragraph">
<p>Now that we have used Citrus on the client side we can also use Citrus SSH server module in order to provide a full stacked SSH server daemon. We can accept SSH client connections and provide proper response messages as an answer.</p>
</div>
<div class="paragraph">
<p>Given the above SSH module namespace declaration, adding a new SSH server is quite simple:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public SshServer sshServer() {
    return new SshServerBuilder()
        .port(9072)
        .user("roland")
        .allowedKeyPath("classpath:org/citrusframework/ssh/test_user_pub.pem")
        .endpointAdapter(sshEndpointAdapter())
        .autoStart(true)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SshServer sshServer() {
    return new SshServerBuilder()
        .port(9072)
        .user("roland")
        .allowedKeyPath("classpath:org/citrusframework/ssh/test_user_pub.pem")
        .endpointAdapter(sshEndpointAdapter())
        .autoStart(true)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus-ssh="http://www.citrusframework.org/schema/ssh/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/ssh/config
           http://www.citrusframework.org/schema/ssh/config/citrus-ssh-config.xsd"&gt;

    &lt;citrus-ssh:server id="sshServer"
             allowed-key-path="classpath:org/citrusframework/ssh/test_user_pub.pem"
             user="roland"
             port="9072"
             auto-start="true"
             endpoint-adapter="sshEndpointAdapter"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>endpoint-adapter</strong> is the handler which receives the SSH request as messages (in the request format described above). Endpoint adapter implementations are fully described in <a href="#http-rest-server">http-server</a>All adapters described there are supported in SSH server module, too.</p>
</div>
<div class="paragraph">
<p>The <code>&lt;citrus-ssh:server&gt;</code> supports the following attributes:</p>
</div>
<div class="hdlist">
<div class="title">SSH Server Attributes:</div>
<table>
<tr>
<td class="hdlist1">
id
</td>
<td class="hdlist2">
<p>Name of the SSH server which identifies it unique within the Citrus Spring context (e.g. id="sshServer")</p>
</td>
</tr>
<tr>
<td class="hdlist1">
host-key-path
</td>
<td class="hdlist2">
<p>Path to PEM encoded key pair (public and private key) which is used as host key. By default, a standard, pre-generate, fixed keypair is used. The path can be specified either as a file path, or, if prefixed with <strong>classpath:</strong> is looked up from within the classpath. The path the is relative from to the top-level package, so no leading slash should be used (e.g. hist-key-path=&quot;/etc/citrus_ssh_server.pem)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
user-home-path
</td>
<td class="hdlist2">
<p>Path to user home directory. If not set ${user.dir}/target/{serverName}/home/{user} is used by default.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
user
</td>
<td class="hdlist2">
<p>User which is allowed to connect (e.g. user="roland")</p>
</td>
</tr>
<tr>
<td class="hdlist1">
allowed-key-path
</td>
<td class="hdlist2">
<p>Path to an SSH public key stored in PEM format. These are the keys, which are allowed to connect to the SSH server when publickey authentication is used. It seves the same purpose as authorized_keys for standard SSH installations. The path can be specified either as a file path, or, if prefixed with <strong>classpath:</strong> is looked up from within the classpath. The path the is relative from to the top-level package, so no leading slash should be used (e.g. allowed-key-path=&quot;classpath:test_user_pub.pem)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
password
</td>
<td class="hdlist2">
<p>Password which should be used when password authentication is used. Both publickey authentication and password based authentication can be used together in which case both methods are tried in turn (e.g. password="s!cr!t")</p>
</td>
</tr>
<tr>
<td class="hdlist1">
host
</td>
<td class="hdlist2">
<p>Host address (e.g. localhost)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
port
</td>
<td class="hdlist2">
<p>Port on which to listen. The SSH server will bind on localhost to this port (e.g. port="9072")</p>
</td>
</tr>
<tr>
<td class="hdlist1">
auto-start
</td>
<td class="hdlist2">
<p>Whether to start this SSH server automatically. Default is <strong>true</strong> . If set to <strong>false</strong>, a test action is responsible for starting/stopping the server (e.g. auto-start="true")</p>
</td>
</tr>
<tr>
<td class="hdlist1">
endpoint-adapter
</td>
<td class="hdlist2">
<p>Bean reference to an endpoint adapter which processes the incoming SSH request. The message format for the request and response are described above (e.g. endpoint-adapter="sshEndpointAdapter")</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the SSH server component is added to the Spring application context with a proper endpoint adapter like the MessageChannel forwarding adapter we can receive incoming requests in a test case and provide a respone message for the client.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;receive endpoint="sshServer"&gt;
  &lt;message&gt;
    &lt;payload&gt;
        &lt;ssh-request xmlns="http://www.citrusframework.org/schema/ssh/message"&gt;
           &lt;command&gt;shutdown&lt;/command&gt;
           &lt;stdin&gt;input&lt;/stdin&gt;
        &lt;/ssh-request&gt;
    &lt;/payload&gt;
  &lt;/message&gt;
&lt;/receive&gt;

&lt;send endpoint="sshServer"&gt;
  &lt;message&gt;
    &lt;payload&gt;
        &lt;ssh-response xmlns="http://www.citrusframework.org/schema/ssh/message"&gt;
            &lt;stdout&gt;Hello Citrus&lt;/stdout&gt;
            &lt;exit&gt;0&lt;/exit&gt;
        &lt;/ssh-response&gt;
    &lt;/payload&gt;
  &lt;/message&gt;
&lt;/send&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rmi"><a class="anchor" href="#rmi"></a><a class="link" href="#rmi">28. RMI support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>RMI stands for Remote Method Invocation and is a standard way of calling Java method interfaces where caller and callee (client and server) are not located within the same JVM. So the object passed to the method as argument as well as the method return value are transmitted over the wire.</p>
</div>
<div class="paragraph">
<p>As a client Citrus is able to connect to some RMI registry that exposes some remote interfaces. As a server Citrus implements such an RMI registry and handles incoming method calls with providing the respective return value.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The RMI components in Citrus are kept in a separate Maven module. So you should check that the module is available as Maven dependency in your project
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-rmi&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read the next section in order to find out more about the RMI message support in Citrus.</p>
</div>
<div class="sect2">
<h3 id="rmi-client"><a class="anchor" href="#rmi-client"></a><a class="link" href="#rmi-client">28.1. RMI client</a></h3>
<div class="paragraph">
<p>On the client side we want to call e remote interface. We need to specify the method to call as well as all method arguments. The respective method return value is receivable within the test case for validation. Citrus provides a client component for RMI that sends out service invocation calls.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public RmiClient rmiClient1() {
    return new RmiClientBuilder()
        .host("localhost")
        .port(1099)
        .binding("newsService")
        .build();
}

@BindToRegistry
public RmiClient rmiClient2() {
    return new RmiClientBuilder()
        .serverUrl("rmi://localhost:1099/newsService")
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public RmiClient rmiClient1() {
    return new RmiClientBuilder()
        .host("localhost")
        .port(1099)
        .binding("newsService")
        .build();
}

@Bean
public RmiClient rmiClient2() {
    return new RmiClientBuilder()
        .serverUrl("rmi://localhost:1099/newsService")
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus-rmi="http://www.citrusframework.org/schema/rmi/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/rmi/config
           http://www.citrusframework.org/schema/rmi/config/citrus-rmi-config.xsd"&gt;

    &lt;citrus-rmi:client id="rmiClient1"
          host="localhost"
          port="1099"
          binding="newsService"/&gt;

    &lt;citrus-rmi:client id="rmiClient2"
          server-url="rmi://localhost:1099/newsService"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As usual, Citrus provides a customized rmi configuration schema that is used in Spring XML bean configurations.
Simply include the <code>citrus-rmi</code> namespace in the configuration XML files as seen in the example above.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The client component in the Spring application context receives host and port configuration of a valid RMI service registry. Either by specifying a proper server url or by giving host, port and binding properties. The service binding is the name of the service that we would like to address in the registry. Now we are ready to use this client referenced by its id or name in a test case for a message sending action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void rmiMessageTest() {
    $(send(rmiClient)
        .message(RmiMessage.invocation(NewsService.class, "getNews"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="RmiMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="rmiClient"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;service-invocation xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
                          &lt;remote&gt;org.citrusframework.rmi.remote.NewsService&lt;/remote&gt;
                          &lt;method&gt;getNews&lt;/method&gt;
                        &lt;/service-invocation&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: RmiMessageTest
actions:
  - send:
      endpoint: "rmiClient"
      message:
        body: |
          &lt;service-invocation xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
              &lt;remote&gt;org.citrusframework.rmi.remote.NewsService&lt;/remote&gt;
              &lt;method&gt;getNews&lt;/method&gt;
          &lt;/service-invocation&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="RmiMessageTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="rmiClient"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;service-invocation xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
                          &lt;remote&gt;org.citrusframework.rmi.remote.NewsService&lt;/remote&gt;
                          &lt;method&gt;getNews&lt;/method&gt;
                        &lt;/service-invocation&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are using the usual Citrus send message action referencing the <strong>rmiClient</strong> as endpoint. The message payload is a special Citrus message that defines the service invocation. We define the <strong>remote</strong> interface as well as the <strong>method</strong> to call. Citrus RMI client component will be able to interpret this message content and call the service method.</p>
</div>
<div class="paragraph">
<p>The method return value is receivable for validation using the very same client endpoint.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void rmiMessageTest() {
    $(receive(rmiClient)
        .message(RmiMessage.result("This is news from RMI!"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="RmiMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="rmiClient"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;service-result xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
                          &lt;object type="java.lang.String" value="This is news from RMI!"/&gt;
                        &lt;/service-result&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: RmiMessageTest
actions:
  - receive:
      endpoint: "rmiClient"
      message:
        body: |
          &lt;service-result xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
              &lt;object type="java.lang.String" value="This is news from RMI!"/&gt;
          &lt;/service-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="RmiMessageTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="rmiClient"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;service-result xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
                          &lt;object type="java.lang.String" value="This is news from RMI!"/&gt;
                        &lt;/service-result&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the sample above we receive the service result and expect a <strong>java.lang.String</strong> object return value. The return value content is also validated within the service result payload.</p>
</div>
<div class="paragraph">
<p>Of course we can also deal with method arguments.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void rmiMessageTest() {
    $(send(rmiClient)
        .message(RmiMessage.invocation(NewsService.class, "setNews")
              .argument("This is breaking news!"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="RmiMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="rmiClient"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;service-invocation xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
                            &lt;remote&gt;org.citrusframework.rmi.remote.NewsService&lt;/remote&gt;
                            &lt;method&gt;setNews&lt;/method&gt;
                            &lt;args&gt;
                              &lt;arg value="This is breaking news!"/&gt;
                            &lt;/args&gt;
                        &lt;/service-invocation&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: RmiMessageTest
actions:
  - send:
      endpoint: "rmiClient"
      message:
        body: |
          &lt;service-invocation xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
                &lt;remote&gt;org.citrusframework.rmi.remote.NewsService&lt;/remote&gt;
                &lt;method&gt;setNews&lt;/method&gt;
                &lt;args&gt;
                  &lt;arg value="This is breaking news!"/&gt;
                &lt;/args&gt;
          &lt;/service-invocation&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="RmiMessageTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="rmiClient"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;service-invocation xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
                            &lt;remote&gt;org.citrusframework.rmi.remote.NewsService&lt;/remote&gt;
                            &lt;method&gt;setNews&lt;/method&gt;
                            &lt;args&gt;
                              &lt;arg value="This is breaking news!"/&gt;
                            &lt;/args&gt;
                        &lt;/service-invocation&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This completes the basic remote service call. Citrus invokes the remote interface method and validates the method return value. As a tester you might also face errors and exceptions when calling the remote interface method. You can catch and assert these remote exceptions verifying your error scenario.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void rmiMessageTest() {
    $(assertException()
        .exception(java.rmi.RemoteException.class)
        .when(
            send(rmiClient)
                .message(RmiMessage.invocation(NewsService.class, "setNews")
                        .argument("This is breaking news!"))
        )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="RmiMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;assert exception="java.rmi.RemoteException"&gt;
            &lt;when&gt;
                &lt;send endpoint="rmiClient"&gt;
                    &lt;message&gt;
                        &lt;body&gt;
                            &lt;payload&gt;
                                &lt;service-invocation xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
                                    &lt;remote&gt;org.citrusframework.rmi.remote.NewsService&lt;/remote&gt;
                                    &lt;method&gt;setNews&lt;/method&gt;
                                    &lt;args&gt;
                                      &lt;arg value="This is breaking news!"/&gt;
                                    &lt;/args&gt;
                                &lt;/service-invocation&gt;
                            &lt;/payload&gt;
                        &lt;/body&gt;
                    &lt;/message&gt;
                &lt;/send&gt;
            &lt;/when&gt;
        &lt;/assert&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: RmiMessageTest
actions:
  - assert:
      exception: "java.rmi.RemoteException"
      when:
        - send:
            endpoint: "rmiClient"
            message:
              body: |
                &lt;service-invocation xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
                      &lt;!-- ... --&gt;
                &lt;/service-invocation&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="RmiMessageTest"&gt;
        &lt;actions&gt;
            &lt;assert exception="java.rmi.RemoteException"&gt;
                &lt;when&gt;
                    &lt;send endpoint="rmiClient"&gt;
                        &lt;message&gt;
                            &lt;payload&gt;
                                &lt;service-invocation xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
                                    &lt;!-- ... --&gt;
                                &lt;/service-invocation&gt;
                            &lt;/payload&gt;
                        &lt;/message&gt;
                    &lt;/send&gt;
                &lt;/when&gt;
            &lt;/assert&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We assert the <strong><em>RemoteException</em></strong> to be thrown while calling the remote service method. This is how you can handle some sort of error situation while calling remote services. In the next section we will handle RMI communication where Citrus provides the remote interfaces.</p>
</div>
</div>
<div class="sect2">
<h3 id="rmi-server"><a class="anchor" href="#rmi-server"></a><a class="link" href="#rmi-server">28.2. RMI server</a></h3>
<div class="paragraph">
<p>On the server side Citrus needs to provide remote interfaces with methods callable for clients. This means that Citrus needs to support all your remote interfaces with method arguments and return values. The Citrus RMI server is able to bind your remote interfaces to a service registry. All incoming RMI client method calls are automatically accepted and the method arguments are converted into a Citrus XML service invocation representation. The RMI method call is then passed to the running test for validation.</p>
</div>
<div class="paragraph">
<p>Let us have a look at the Citrus RMI server component and how you can add it to the Spring application context.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public RmiServer rmiServer() {
    return new RmiServerBuilder()
        .host("localhost")
        .port(1099)
        .remoteInterfaces(org.citrusframework.rmi.remote.NewsService.class)
        .binding("newsService")
        .createRegistry(true)
        .autoStart(true)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public RmiServer rmiServer() {
    return new RmiServerBuilder()
        .host("localhost")
        .port(1099)
        .remoteInterfaces(org.citrusframework.rmi.remote.NewsService.class)
        .binding("newsService")
        .createRegistry(true)
        .autoStart(true)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus-rmi="http://www.citrusframework.org/schema/rmi/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/rmi/config
           http://www.citrusframework.org/schema/rmi/config/citrus-rmi-config.xsd"&gt;

    &lt;citrus-rmi:server id="rmiServer"
          host="localhost"
          port="1099"
          interface="org.citrusframework.rmi.remote.NewsService"
          binding="newService"
          create-registry="true"
          auto-start="true"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The RMI server component uses properties such as <strong>host</strong> and <strong>port</strong> to define the service registry. By default Citrus will connect to this service registry and bind its remote interfaces to it. With the attribute <strong>create-registry</strong> Citrus can also create the registry for you.</p>
</div>
<div class="paragraph">
<p>You have to give Citrus the fully qualified remote interface name so Citrus can bind it to the service registry and handle incoming method calls properly. In your test case you can then receive the incoming method calls on the server in order to perform validation steps.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void rmiMessageTest() {
    $(receive(rmiServer)
        .message(RmiMessage.invocation(NewsService.class, "getNews"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="RmiMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="rmiServer"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;service-invocation xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
                          &lt;remote&gt;org.citrusframework.rmi.remote.NewsService&lt;/remote&gt;
                          &lt;method&gt;getNews&lt;/method&gt;
                        &lt;/service-invocation&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
                &lt;headers&gt;
                    &lt;header name="citrus_rmi_interface" value="org.citrusframework.rmi.remote.NewsService"/&gt;
                    &lt;header name="citrus_rmi_method" value="getNews"/&gt;
                &lt;/headers&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: RmiMessageTest
actions:
  - receive:
      endpoint: "rmiServer"
      message:
        body: |
          &lt;service-invocation xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
              &lt;remote&gt;org.citrusframework.rmi.remote.NewsService&lt;/remote&gt;
              &lt;method&gt;getNews&lt;/method&gt;
          &lt;/service-invocation&gt;
        headers:
          - name: citrus_rmi_interface
            value: "org.citrusframework.rmi.remote.NewsService"
          - name: citrus_rmi_method
            value: "getNews"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="RmiMessageTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="rmiServer"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;service-invocation xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
                          &lt;remote&gt;org.citrusframework.rmi.remote.NewsService&lt;/remote&gt;
                          &lt;method&gt;getNews&lt;/method&gt;
                        &lt;/service-invocation&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
                &lt;header&gt;
                    &lt;element name="citrus_rmi_interface" value="org.citrusframework.rmi.remote.NewsService"/&gt;
                    &lt;element name="citrus_rmi_method" value="getNews"/&gt;
                &lt;/header&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see Citrus converts the incoming service invocation to a special XML representation which is passed as message payload to the test. As this is plain XML you can verify the RMI message content as usual using Citrus variables, functions and validation matchers.</p>
</div>
<div class="paragraph">
<p>Since we have received the method call we need to provide some return value for the client. As usual we can specify the method return value with some XML representation.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void rmiMessageTest() {
    $(send(rmiServer)
        .message(RmiMessage.result("This is news from RMI!"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="RmiMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="rmiServer"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;service-result xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
                            &lt;object type="java.lang.String" value="This is news from RMI!"/&gt;
                        &lt;/service-result&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: RmiMessageTest
actions:
  - send:
      endpoint: "rmiServer"
      message:
        body: |
          &lt;service-result xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
            &lt;object type="java.lang.String" value="This is news from RMI!"/&gt;
          &lt;/service-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="RmiMessageTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="rmiServer"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;service-result xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
                            &lt;object type="java.lang.String" value="This is news from RMI!"/&gt;
                        &lt;/service-result&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service result is defined as object with a <strong>type</strong> and <strong>value</strong> . The Citrus RMI remote interface method will return this value to the calling client. This would complete the successful remote service invocation. At this point we also have to think of choosing to raise some remote exception as service outcome.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void rmiMessageTest() {
    $(send(rmiServer)
        .message(RmiMessage.exception("Something went wrong"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="RmiMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="rmiServer"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;service-result xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
                            &lt;exception&gt;Something went wrong&lt;/exception&gt;
                        &lt;/service-result&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: RmiMessageTest
actions:
  - send:
      endpoint: "rmiServer"
      message:
        body: |
          &lt;service-result xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
            &lt;exception&gt;Something went wrong&lt;/exception&gt;
          &lt;/service-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="RmiMessageTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="rmiServer"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;service-result xmlns="http://www.citrusframework.org/schema/rmi/message"&gt;
                            &lt;exception&gt;Something went wrong&lt;/exception&gt;
                        &lt;/service-result&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above Citrus will not return some object as service result but raise a <strong>java.rmi.RemoteException</strong> with respective error message as specified in the test case. The calling client will receive the exception accordingly.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jmx"><a class="anchor" href="#jmx"></a><a class="link" href="#jmx">29. JMX support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>JMX is a standard Java API for making beans accessible to others in terms of management and remote configuration. JMX is the short term for Java Management Extensions and is often used in JEE application servers to manage bean attributes and operations from outside (e.g. another JVM). A managed bean server hosts multiple managed beans for JMX access. Remote connections to JMX can be realized with RMI (Remote method invocation) capabilities.</p>
</div>
<div class="paragraph">
<p>Citrus is able to connect to JMX managed beans as client and server. As a client Citrus can invoke managed bean operations and read write managed bean attributes. As a server Citrus is able to expose managed beans as mbean server. Clients can access those Citrus managed beans and get proper response objects as result. Doing so you can use the JVM platform managed bean server or some RMI registry for providing remote access.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The JMX components in Citrus are kept in a separate Maven module. So you should check that the module is available as Maven dependency in your project
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-jmx&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next sections describe the JMX message support in Citrus in more detail.</p>
</div>
<div class="sect2">
<h3 id="jmx-client"><a class="anchor" href="#jmx-client"></a><a class="link" href="#jmx-client">29.1. JMX client</a></h3>
<div class="paragraph">
<p>On the client side we want to call some managed bean by either accessing managed attributes with read/write or by invoking a managed bean operation. For proper mbean server connectivity we should specify a client component for JMX that sends out mbean invocation calls.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public JmxClient jmxClient() {
    return new JmxClientBuilder()
        .serverUrl("platform")
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmxClient jmxClient() {
    return new JmxClientBuilder()
        .serverUrl("platform")
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-jmx="http://www.citrusframework.org/schema/jmx/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/jmx/config
           http://www.citrusframework.org/schema/jmx/config/citrus-jmx-config.xsd"&gt;

    &lt;citrus-jmx:client id="jmxClient"
            server-url="platform"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As usual Citrus provides a customized jmx configuration schema that is used in Spring XML bean configurations.
Simply include the <code>citrus-jmx</code> namespace in the configuration XML files as seen in the example above.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The client component specifies the target managed bean server that we want to connect to. In this example we are using the JVM platform mbean server. This means we are able to access all JVM managed beans such as Memory, Threading and Logging. In addition to that we can access all custom managed beans that were exposed to the platform mbean server.</p>
</div>
<div class="paragraph">
<p>In most cases you may want to access managed beans on a different JVM or application server. So we need some remote connection to the foreign mbean server.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public JmxClient jmxClient() {
    return new JmxClientBuilder()
        .serverUrl("service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi")
        .username("user")
        .password("s!cr!t")
        .autoReconnect(true)
        .delayOnReconnect(5000L)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmxClient jmxClient() {
    return new JmxClientBuilder()
        .serverUrl("service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi")
        .username("user")
        .password("s!cr!t")
        .autoReconnect(true)
        .delayOnReconnect(5000L)
        .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-jmx="http://www.citrusframework.org/schema/jmx/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/jmx/config
           http://www.citrusframework.org/schema/jmx/config/citrus-jmx-config.xsd"&gt;

    &lt;citrus-jmx:client id="jmxClient"
          server-url="service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi"
          username="user"
          password="s!cr!t"
          auto-reconnect="true"
          delay-on-reconnect="5000"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example above we connect to a remote mbean server via RMI using the default RMI registry <strong>localhost:1099</strong> and the service name <strong>jmxrmi</strong> . Citrus is able to handle different remote transport protocols. Just define those in the <strong>server-url</strong> .</p>
</div>
<div class="paragraph">
<p>Now that we have set up the client component we can use it in a test case to access a managed bean.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void jmxMessageTest() {
    $(send(jmxClient)
        .message(JmxMessage.invocation("java.lang:type=Memory")
            .attribute("Verbose"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="JmxMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="jmxClient"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;mbean-invocation xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
                          &lt;mbean&gt;java.lang:type=Memory&lt;/mbean&gt;
                          &lt;attribute name="Verbose"/&gt;
                        &lt;/mbean-invocation&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: JmxMessageTest
actions:
  - send:
      endpoint: "jmxClient"
      message:
        body: |
          &lt;mbean-invocation xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
              &lt;mbean&gt;java.lang:type=Memory&lt;/mbean&gt;
              &lt;attribute name="Verbose"/&gt;
          &lt;/mbean-invocation&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="JmxMessageTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="jmxClient"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;mbean-invocation xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
                          &lt;mbean&gt;java.lang:type=Memory&lt;/mbean&gt;
                          &lt;attribute name="Verbose"/&gt;
                        &lt;/mbean-invocation&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we just used a normal send action referencing the jmx client component that we have just added. The message payload is an XML representation of the managed bean access. This is a special Citrus XML representation. Citrus will convert this XML payload to the actuel managed bean access. In the example above we try to access a managed bean with object name <strong>java.lang:type=Memory</strong> . The object name is defined in JMX specification and consists of a key <strong>java.lang:type</strong> and a value <strong>Memory</strong> . So we identify the managed bean on the server by its type.</p>
</div>
<div class="paragraph">
<p>Now that we have access to the managed bean we can read its managed attributes such as <strong>Verbose</strong> . This is a boolean type attribute so the mbean invocation result will be a respective Boolean object. We can validate the managed bean attribute access in a receive action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void jmxMessageTest() {
    $(receive(jmxClient)
        .message(JmxMessage.result(false))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="JmxMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="jmxClient"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;mbean-result xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
                          &lt;object type="java.lang.Boolean" value="false"/&gt;
                        &lt;/mbean-result&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: JmxMessageTest
actions:
  - receive:
      endpoint: "jmxClient"
      message:
        body: |
          &lt;mbean-result xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
              &lt;object type="java.lang.Boolean" value="false"/&gt;
          &lt;/mbean-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="JmxMessageTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="jmxClient"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;mbean-result xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
                          &lt;object type="java.lang.Boolean" value="false"/&gt;
                        &lt;/mbean-result&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the sample above we receive the mbean result and expect a <strong>java.lang.Boolean</strong> object return value. The return value content is also validated within the mbean result payload.</p>
</div>
<div class="paragraph">
<p>Some managed bean attributes might also be settable for us. So we can define the attribute access as write operation by specifying a value in the send action payload.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void jmxMessageTest() {
    $(send(jmxClient)
        .message(JmxMessage.invocation("java.lang:type=Memory")
            .attribute("Verbose", true))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="JmxMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="jmxClient"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;mbean-invocation xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
                          &lt;mbean&gt;java.lang:type=Memory&lt;/mbean&gt;
                          &lt;attribute name="Verbose" value="true" type="java.lang.Boolean"/&gt;
                        &lt;/mbean-invocation&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: JmxMessageTest
actions:
  - send:
      endpoint: "jmxClient"
      message:
        body: |
          &lt;mbean-invocation xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
              &lt;mbean&gt;java.lang:type=Memory&lt;/mbean&gt;
              &lt;attribute name="Verbose" value="true" type="java.lang.Boolean"/&gt;
          &lt;/mbean-invocation&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="JmxMessageTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="jmxClient"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;mbean-invocation xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
                          &lt;mbean&gt;java.lang:type=Memory&lt;/mbean&gt;
                          &lt;attribute name="Verbose" value="true" type="java.lang.Boolean"/&gt;
                        &lt;/mbean-invocation&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we have write access to the managed attribute <strong>Verbose</strong> . We do specify the value and its type <strong>java.lang.Boolean</strong> . This is how we can set attribute values on managed beans.</p>
</div>
<div class="paragraph">
<p>Last not least we are able to access managed bean operations.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void jmxMessageTest() {
    $(send(jmxClient)
        .message(JmxMessage.invocation("org.citrusframework.jmx.mbean:type=HelloBean")
            .operation("sayHello")
            .parameter("Hello JMX!"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="JmxMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="jmxClient"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;mbean-invocation xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
                          &lt;mbean&gt;org.citrusframework.jmx.mbean:type=HelloBean&lt;/mbean&gt;
                          &lt;operation name="sayHello"&gt;
                            &gt;parameter&gt;
                              &gt;param type="java.lang.String" value="Hello JMX!"/&gt;
                            &gt;/parameter&gt;
                          &gt;/operation&gt;
                        &lt;/mbean-invocation&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: JmxMessageTest
actions:
  - send:
      endpoint: "jmxClient"
      message:
        body: |
          &lt;mbean-invocation xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
              &lt;mbean&gt;org.citrusframework.jmx.mbean:type=HelloBean&lt;/mbean&gt;
              &lt;operation name="sayHello"&gt;
                &gt;parameter&gt;
                  &gt;param type="java.lang.String" value="Hello JMX!"/&gt;
                &gt;/parameter&gt;
              &gt;/operation&gt;
          &lt;/mbean-invocation&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="JmxMessageTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="jmxClient"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;mbean-invocation xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
                          &lt;mbean&gt;org.citrusframework.jmx.mbean:type=HelloBean&lt;/mbean&gt;
                          &lt;operation name="sayHello"&gt;
                            &gt;parameter&gt;
                              &gt;param type="java.lang.String" value="Hello JMX!"/&gt;
                            &gt;/parameter&gt;
                          &gt;/operation&gt;
                        &lt;/mbean-invocation&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above we access a custom managed bean and invoke its operation <strong>sayHello</strong> . We are also using operation parameters for the invocation. This should call the managed bean operation and return its result if any as usual.</p>
</div>
<div class="paragraph">
<p>This completes the basic JMX managed bean access as client. Now we also want to discuss the server side were Citrus is able to provide managed beans for others</p>
</div>
</div>
<div class="sect2">
<h3 id="jmx-server"><a class="anchor" href="#jmx-server"></a><a class="link" href="#jmx-server">29.2. JMX server</a></h3>
<div class="paragraph">
<p>The server side is always a little bit more tricky because we need to simulate custom managed bean access as a server. First of all Citrus provides a server component that specifies the connection properties for clients such as transport protocols, ports and mbean object names. Let&#8217;s create a new server that accepts incoming requests via RMI on a remote registry <strong>localhost:1099</strong> .</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public JmxServer jmxServer() {
    return new JmxServerBuilder()
        .serverUrl("service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi")
        .mbeans(jmxBeans())
        .build();
}

private List&lt;ManagedBeanDefinition&gt; jmxBeans() {
    return Arrays.asList(
        helloBean(),
        newsBean()
    );
}

private ManagedBeanDefinition helloBean() {
    ManagedBeanDefinition managedBeanDefinition = new ManagedBeanDefinition();
    managedBeanDefinition.setType(org.citrusframework.jmx.mbean.HelloBean.class);
    return managedBeanDefinition;
}

private ManagedBeanDefinition newsBean() {
    ManagedBeanDefinition managedBeanDefinition = new ManagedBeanDefinition();
    managedBeanDefinition.setType(org.citrusframework.jmx.mbean.NewsBean.class);
    managedBeanDefinition.setObjectDomain("org.citrusframework.news");
    managedBeanDefinition.setObjectName("name=News");
    return managedBeanDefinition;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmxServer jmxServer() {
    return new JmxServerBuilder()
        .serverUrl("service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi")
        .mbeans(jmxBeans())
        .build();
}

private List&lt;ManagedBeanDefinition&gt; jmxBeans() {
    return Arrays.asList(
        helloBean(),
        newsBean()
    );
}

private ManagedBeanDefinition helloBean() {
    ManagedBeanDefinition managedBeanDefinition = new ManagedBeanDefinition();
    managedBeanDefinition.setType(org.citrusframework.jmx.mbean.HelloBean.class);
    return managedBeanDefinition;
}

private ManagedBeanDefinition newsBean() {
    ManagedBeanDefinition managedBeanDefinition = new ManagedBeanDefinition();
    managedBeanDefinition.setType(org.citrusframework.jmx.mbean.NewsBean.class);
    managedBeanDefinition.setObjectDomain("org.citrusframework.news");
    managedBeanDefinition.setObjectName("name=News");
    return managedBeanDefinition;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-jmx="http://www.citrusframework.org/schema/jmx/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/jmx/config
           http://www.citrusframework.org/schema/jmx/config/citrus-jmx-config.xsd"&gt;

    &lt;citrus-jmx:server id="jmxServer"
        server-url="service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi"&gt;
        &lt;citrus-jmx:mbeans&gt;
            &lt;citrus-jmx:mbean type="org.citrusframework.jmx.mbean.HelloBean"/&gt;
            &lt;citrus-jmx:mbean type="org.citrusframework.jmx.mbean.NewsBean" objectDomain="org.citrusframework.news" objectName="name=News"/&gt;
        &lt;/citrus-jmx:mbeans&gt;
    &lt;/citrus-jmx:server&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As usual, we define a <strong>server-url</strong> that controls the JMX connector access to the mbean server. In this example above we open a JMX RMI connector for clients using the registry <strong>localhost:1099</strong> and the service name <strong>jmxrmi</strong> By default Citrus will not attempt to create this registry automatically so the registry has to be present before the server start up. With the optional server property <strong>create-registry</strong> set to <strong>true</strong> you can auto create the registry when the server starts up. These properties do only apply when using a remote JMX connector server.</p>
</div>
<div class="paragraph">
<p>Besides using the whole server-url as property we can also construct the connection by host, port, protocol and binding properties.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public JmxServer jmxServer() {
    return new JmxServerBuilder()
        .host("localhost")
        .port(1099)
        .protocol("rmi")
        .binding("jmxrmi")
        .mbeans(jmxBeans())
        .build();
}

private List&lt;ManagedBeanDefinition&gt; jmxBeans() {
    return Arrays.asList(
        helloBean(),
        newsBean()
    );
}

private ManagedBeanDefinition helloBean() {
    ManagedBeanDefinition managedBeanDefinition = new ManagedBeanDefinition();
    managedBeanDefinition.setType(org.citrusframework.jmx.mbean.HelloBean.class);
    return managedBeanDefinition;
}

private ManagedBeanDefinition newsBean() {
    ManagedBeanDefinition managedBeanDefinition = new ManagedBeanDefinition();
    managedBeanDefinition.setType(org.citrusframework.jmx.mbean.NewsBean.class);
    managedBeanDefinition.setObjectDomain("org.citrusframework.news");
    managedBeanDefinition.setObjectName("name=News");
    return managedBeanDefinition;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmxServer jmxServer() {
    return new JmxServerBuilder()
        .host("localhost")
        .port(1099)
        .protocol("rmi")
        .binding("jmxrmi")
        .mbeans(jmxBeans())
        .build();
}

private List&lt;ManagedBeanDefinition&gt; jmxBeans() {
    return Arrays.asList(
        helloBean(),
        newsBean()
    );
}

private ManagedBeanDefinition helloBean() {
    ManagedBeanDefinition managedBeanDefinition = new ManagedBeanDefinition();
    managedBeanDefinition.setType(org.citrusframework.jmx.mbean.HelloBean.class);
    return managedBeanDefinition;
}

private ManagedBeanDefinition newsBean() {
    ManagedBeanDefinition managedBeanDefinition = new ManagedBeanDefinition();
    managedBeanDefinition.setType(org.citrusframework.jmx.mbean.NewsBean.class);
    managedBeanDefinition.setObjectDomain("org.citrusframework.news");
    managedBeanDefinition.setObjectName("name=News");
    return managedBeanDefinition;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-jmx="http://www.citrusframework.org/schema/jmx/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/jmx/config
           http://www.citrusframework.org/schema/jmx/config/citrus-jmx-config.xsd"&gt;

    &lt;citrus-jmx:server id="jmxServer"
          host="localhost"
          port="1099"
          protocol="rmi"
          binding="jmxrmi"&gt;
        &lt;citrus-jmx:mbeans&gt;
            &lt;citrus-jmx:mbean type="org.citrusframework.jmx.mbean.HelloBean"/&gt;
            &lt;citrus-jmx:mbean type="org.citrusframework.jmx.mbean.NewsBean" objectDomain="org.citrusframework.news" objectName="name=News"/&gt;
        &lt;/citrus-jmx:mbeans&gt;
    &lt;/citrus-jmx:server&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>On last thing to mention is that we could have also used <strong>platform</strong> as server-url in order to use the JVM platform mbean server instead.</p>
</div>
<div class="paragraph">
<p>Now that we clarified the connectivity we need to talk about how to define the managed beans that are available on our JMX mbean server. This is done as nested <strong>mbean</strong> configuration elements. Here the managed bean definitions describe the managed bean with its objectDomain, objectName, operations and attributes. The most convenient way of defining such managed bean definitions is to give a bean type which is the fully qualified class name of the managed bean. Citrus will use the package name and class name for proper objectDomain and objectName construction.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a closer look at the first mbean definition in the example above. So the first managed bean is defined by its class name <strong>org.citrusframework.jmx.mbean.HelloBean</strong> and therefore is accessible using the objectName <strong>org.citrusframework.jmx.mbean:type=HelloBean</strong> . In addition to that Citrus will read the class information such as available methods, getters and setters for constructing a proper MBeanInfo. In the second managed bean definition in our example we have used additional custom objectDomain and objectName values. So the <strong>NewsBean</strong> will be accessible with <strong>org.citrusframework.news:name=News</strong> on the managed bean server.</p>
</div>
<div class="paragraph">
<p>This is how we can define the bindings of managed beans and what clients need to search for when finding and accessing the managed beans on the server. When clients try to find the managed beans they have to use proper objectNames accordingly. ObjectNames that are not defined on the server will be rejected with managed bean not found error.</p>
</div>
<div class="paragraph">
<p>Right now we have to use the qualified class name of the managed bean in the definition. What happens if we do not have access to that mbean class or if there is not managed bean interface available at all? Citrus provides a generic managed bean that is able to handle any managed bean interaction. The generic bean implementation needs to know the managed operations and attributes though. So let&#8217;s define a new generic managed bean on our server:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public JmxServer jmxServer() {
    return new JmxServerBuilder()
        .serverUrl("service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi")
        .mbeans(jmxBeans())
        .build();
}

private List&lt;ManagedBeanDefinition&gt; jmxBeans() {
    return Arrays.asList(
        fooBean()
    );
}

private ManagedBeanDefinition fooBean() {
    ManagedBeanDefinition managedBeanDefinition = new ManagedBeanDefinition();
    managedBeanDefinition.setObjectDomain("foo.object.domain");
    managedBeanDefinition.setObjectName("type=FooBean");

    ManagedBeanInvocation.Operation fooOp = new ManagedBeanInvocation.Operation();
    fooOp.setName("fooOp");

    ManagedBeanInvocation.Parameter fooOpParams = new ManagedBeanInvocation.Parameter();
    OperationParam p1 = new OperationParam();
    p1.setType(String.class.getName());
    p1.setType(Integer.class.getName());
    fooOpParams.getParameter().add(p1);
    fooOp.setParameter(fooOpParams);

    ManagedBeanInvocation.Operation barOp = new ManagedBeanInvocation.Operation();
    barOp.setName("barOp");

    managedBeanDefinition.getOperations().add(fooOp);
    managedBeanDefinition.getOperations().add(barOp);

    ManagedBeanInvocation.Attribute fooAttr = new ManagedBeanInvocation.Attribute();
    fooAttr.setName("fooAttr");
    fooAttr.setType(String.class.getName());

    ManagedBeanInvocation.Attribute barAttr = new ManagedBeanInvocation.Attribute();
    barAttr.setName("barAttr");
    barAttr.setType(Boolean.class.getName());

    managedBeanDefinition.getAttributes().add(fooAttr);
    managedBeanDefinition.getAttributes().add(barAttr);

    return managedBeanDefinition;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmxServer jmxServer() {
    return new JmxServerBuilder()
        .serverUrl("service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi")
        .mbeans(jmxBeans())
        .build();
}

private List&lt;ManagedBeanDefinition&gt; jmxBeans() {
    return Arrays.asList(
        fooBean()
    );
}

private ManagedBeanDefinition fooBean() {
    ManagedBeanDefinition managedBeanDefinition = new ManagedBeanDefinition();
    managedBeanDefinition.setObjectDomain("foo.object.domain");
    managedBeanDefinition.setObjectName("type=FooBean");

    ManagedBeanInvocation.Operation fooOp = new ManagedBeanInvocation.Operation();
    fooOp.setName("fooOp");

    ManagedBeanInvocation.Parameter fooOpParams = new ManagedBeanInvocation.Parameter();
    OperationParam p1 = new OperationParam();
    p1.setType(String.class.getName());
    p1.setType(Integer.class.getName());
    fooOpParams.getParameter().add(p1);
    fooOp.setParameter(fooOpParams);

    ManagedBeanInvocation.Operation barOp = new ManagedBeanInvocation.Operation();
    barOp.setName("barOp");

    managedBeanDefinition.getOperations().add(fooOp);
    managedBeanDefinition.getOperations().add(barOp);

    ManagedBeanInvocation.Attribute fooAttr = new ManagedBeanInvocation.Attribute();
    fooAttr.setName("fooAttr");
    fooAttr.setType(String.class.getName());

    ManagedBeanInvocation.Attribute barAttr = new ManagedBeanInvocation.Attribute();
    barAttr.setName("barAttr");
    barAttr.setType(Boolean.class.getName());

    managedBeanDefinition.getAttributes().add(fooAttr);
    managedBeanDefinition.getAttributes().add(barAttr);

    return managedBeanDefinition;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-jmx="http://www.citrusframework.org/schema/jmx/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd
           http://www.citrusframework.org/schema/jmx/config
           http://www.citrusframework.org/schema/jmx/config/citrus-jmx-config.xsd"&gt;

    &lt;citrus-jmx:server id="jmxServer"
        server-url="service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi"&gt;
        &lt;citrus-jmx:mbeans&gt;
            &lt;citrus-jmx:mbean name="fooBean" objectDomain="foo.object.domain" objectName="type=FooBean"&gt;
                &lt;citrus-jmx:operations&gt;
                    &lt;citrus-jmx:operation name="fooOp"&gt;
                        &lt;citrus-jmx:parameter&gt;
                            &lt;citrus-jmx:param type="java.lang.String"/&gt;
                            &lt;citrus-jmx:param type="java.lang.Integer"/&gt;
                        &lt;/citrus-jmx:parameter&gt;
                    &lt;/citrus-jmx:operation&gt;
                    &lt;citrus-jmx:operation name="barOp"/&gt;
                &lt;/citrus-jmx:operations&gt;
                &lt;citrus-jmx:attributes&gt;
                    &lt;citrus-jmx:attribute name="fooAttr" type="java.lang.String"/&gt;
                    &lt;citrus-jmx:attribute name="barAttr" type="java.lang.Boolean"/&gt;
                &lt;/citrus-jmx:attributes&gt;
            &lt;/citrus-jmx:mbean&gt;
        &lt;/citrus-jmx:mbeans&gt;
    &lt;/citrus-jmx:server&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generic bean definition needs to define all operations and attributes that are available for access. Up to now we are restricted to using Java base types when defining operation parameter and attribute return types. There is actually no way to define more complex return types. Nevertheless Citrus is now able to expose the managed bean for client access without having to know the actual managed bean implementation.</p>
</div>
<div class="paragraph">
<p>Now we can use the server component in a test case to receive some incoming managed bean access.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void jmxMessageTest() {
    $(receive(jmxServer)
        .message(JmxMessage.invocation("org.citrusframework.jmx.mbean:type=HelloBean")
            .operation("sayHello")
            .parameter("Hello JMX!"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="JmxMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="jmxServer"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;mbean-invocation xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
                          &lt;mbean&gt;org.citrusframework.jmx.mbean:type=HelloBean&lt;/mbean&gt;
                          &lt;operation name="sayHello"&gt;
                            &gt;parameter&gt;
                              &gt;param type="java.lang.String" value="Hello JMX!"/&gt;
                            &gt;/parameter&gt;
                          &lt;/operation&gt;
                        &lt;/mbean-invocation&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: JmxMessageTest
actions:
  - receive:
      endpoint: "jmxServer"
      message:
        body: |
          &lt;mbean-invocation xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
              &lt;mbean&gt;org.citrusframework.jmx.mbean:type=HelloBean&lt;/mbean&gt;
              &lt;operation name="sayHello"&gt;
                &gt;parameter&gt;
                  &gt;param type="java.lang.String" value="Hello JMX!"/&gt;
                &gt;/parameter&gt;
              &lt;/operation&gt;
          &lt;/mbean-invocation&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="JmxMessageTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="jmxServer"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;mbean-invocation xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
                          &lt;mbean&gt;org.citrusframework.jmx.mbean:type=HelloBean&lt;/mbean&gt;
                          &lt;operation name="sayHello"&gt;
                            &gt;parameter&gt;
                              &gt;param type="java.lang.String" value="Hello JMX!"/&gt;
                            &gt;/parameter&gt;
                          &lt;/operation&gt;
                        &lt;/mbean-invocation&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/receive&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this very first example we expect a managed bean access to the bean <strong>org.citrusframework.jmx.mbean:type=HelloBean</strong> . We further expect the operation <strong>sayHello</strong> to be called with respective parameter values. Now we have to define the operation result that will be returned to the calling client as operation result.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void jmxMessageTest() {
    $(send(jmxServer)
        .message(JmxMessage.result("Hello from JMX!"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="JmxMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="jmxServer"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;mbean-result xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
                            &lt;object type="java.lang.String" value="Hello from JMX!"/&gt;
                        &lt;/mbean-result&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: JmxMessageTest
actions:
  - send:
      endpoint: "jmxServer"
      message:
        body: |
          &lt;mbean-result xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
            &lt;object type="java.lang.String" value="Hello from JMX!"/&gt;
          &lt;/mbean-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="JmxMessageTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="jmxServer"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;mbean-result xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
                            &lt;object type="java.lang.String" value="Hello from JMX!"/&gt;
                        &lt;/mbean-result&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The operation returns a String <strong>Hello from JMX!</strong> . This is how we can expect operation calls on managed beans. Now we already have seen that managed beans also expose attributes. The next example is handling incoming attribute read access.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void jmxMessageTest() {
    $(receive(jmxServer)
        .message(JmxMessage.invocation("org.citrusframework.news:name=News")
            .attribute("newsCount"))
    );

    $(send(jmxServer)
        .message(JmxMessage.result(100))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="JmxMessageTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="jmxServer"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;mbean-invocation xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
                          &lt;mbean&gt;org.citrusframework.news:name=News&lt;/mbean&gt;
                            &gt;attribute name="newsCount"/&gt;
                        &lt;/mbean-invocation&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
        &lt;send endpoint="jmxServer"&gt;
            &lt;message&gt;
                &lt;body&gt;
                    &lt;payload&gt;
                        &lt;mbean-result xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
                            &lt;object type="java.lang.Integer" value="100"/&gt;
                        &lt;/mbean-result&gt;
                    &lt;/payload&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: JmxMessageTest
actions:
  - receive:
      endpoint: "jmxServer"
      message:
        body: |
          &lt;mbean-invocation xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
              &lt;mbean&gt;org.citrusframework.news:name=News&lt;/mbean&gt;
                &gt;attribute name="newsCount"/&gt;
          &lt;/mbean-invocation&gt;
  - send:
      endpoint: "jmxServer"
      message:
        body: |
          &lt;mbean-result xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
            &lt;object type="java.lang.Integer" value="100"/&gt;
          &lt;/mbean-result&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="JmxMessageTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="jmxServer"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;mbean-invocation xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
                          &lt;mbean&gt;org.citrusframework.news:name=News&lt;/mbean&gt;
                            &gt;attribute name="newsCount"/&gt;
                        &lt;/mbean-invocation&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/receive&gt;

            &lt;send endpoint="jmxServer"&gt;
                &lt;message&gt;
                    &lt;payload&gt;
                        &lt;mbean-result xmlns="http://www.citrusframework.org/schema/jmx/message"&gt;
                            &lt;object type="java.lang.Integer" value="100"/&gt;
                        &lt;/mbean-result&gt;
                    &lt;/payload&gt;
                &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>receive</code> action expects read access to the <strong>NewsBean</strong> attribute <strong>newsCount</strong> and returns a result object of type <strong>java.lang.Integer</strong> . This way we can expect all attribute access to our managed beans. Write operations will have an attribute value specified.</p>
</div>
<div class="paragraph">
<p>This completes the JMX server capabilities with managed bean access on operations and attributes.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="zookeeper"><a class="anchor" href="#zookeeper"></a><a class="link" href="#zookeeper">30. Zookeeper support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Citrus provides configuration components and test actions for interacting with Zookeeper.
The Citrus Zookeeper client component executes commands like create-node, check node-exists, delete-node, get node-data or set node-data.
As a user you can execute Zookeeper commands as part of a Citrus test and validate possible command results.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Zookeeper test components in Citrus are kept in a separate Maven module.
If not already done, you have to include the module as Maven dependency to your project
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
      &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
      &lt;artifactId&gt;citrus-zookeeper&lt;/artifactId&gt;
      &lt;version&gt;${citrus.version}&lt;/version&gt;
      &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="zookeeper-client"><a class="anchor" href="#zookeeper-client"></a><a class="link" href="#zookeeper-client">30.1. Zookeeper client</a></h3>
<div class="paragraph">
<p>Before you can interact with a Zookeeper server you have to configure the Zookeeper client.
A sample configuration is provided below describing the configuration options available:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public ZooClient zookeeperClient() {
    ZooClientConfig configuration = new ZooClientConfig();
    configuration.setUrl("http://localhost:21118");
    configuration.setTimeout(2000L);
    return new ZooClient(configuration);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public ZooClient zookeeperClient() {
    ZooClientConfig configuration = new ZooClientConfig();
    configuration.setUrl("http://localhost:21118");
    configuration.setTimeout(2000L);
    return new ZooClient(configuration);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus-zookeeper="http://www.citrusframework.org/schema/zookeeper/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/zookeeper/config
           http://www.citrusframework.org/schema/zookeeper/config/citrus-zookeeper-config.xsd"&gt;

    &lt;citrus-zookeeper:client id="zookeeperClient"
                               url="http://localhost:21118"
                               timeout="2000"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Citrus provides a "citrus-zookeeper" configuration namespace and schema definition for Zookeeper related components and actions.
Include this namespace into your Spring XML bean configuration in order to use the Citrus zookeeper configuration elements.
The namespace URI and schema location are added to the Spring configuration XML file as seen in the example above.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is a typical client configuration for connecting to a Zookeeper server.
Now you are able to execute several commands.
These commands will be sent to the Zookeeper server for execution.</p>
</div>
</div>
<div class="sect2">
<h3 id="zookeeper-commands"><a class="anchor" href="#zookeeper-commands"></a><a class="link" href="#zookeeper-commands">30.2. Zookeeper commands</a></h3>
<div class="paragraph">
<p>See below all available Zookeeper commands that a Citrus client is able to execute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">info: Retrieves the current state of the client connection
create: Creates a znode in a specified path of the ZooKeeper namespace
delete: Deletes a znode from a specified path of the ZooKeeper namespace
exists: Checks if a znode exists in the path
children: Gets a list of children of a znode
get: Gets the data associated with a znode
set: Sets/writes data into the data field of a znode</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next example shows some of these features in action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void testZookeeper() {
    variable("randomString", "citrus:randomString(10)");

    zookeeper()
        .create("/${randomString}", "foo")
        .acl("OPEN_ACL_UNSAFE")
        .mode("PERSISTENT")
        .validateCommandResult(new CommandResultCallback&lt;ZooResponse&gt;() {
            @Override
            public void doWithCommandResult(ZooResponse result, TestContext context) {
                Assert.assertEquals(result.getResponseData().get("path"), context.replaceDynamicContentInString("/${randomString}"));
            }
        });

    zookeeper()
        .get("/${randomString}")
        .validateCommandResult(new CommandResultCallback&lt;ZooResponse&gt;() {
            @Override
            public void doWithCommandResult(ZooResponse result, TestContext context) {
                Assert.assertEquals(result.getResponseData().get("version"), 0);
            }
        });

    zookeeper()
        .set("/${randomString}", "bar");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:zookeeper="http://www.citrusframework.org/schema/zookeeper/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/zookeeper/testcase
              http://www.citrusframework.org/schema/zookeeper/testcase/citrus-zookeeper-testcase.xsd"&gt;

  &lt;testcase name="ScpTest"&gt;
    &lt;actions&gt;
        &lt;zookeeper:create zookeeper-client="zookeeperClient" path="/${randomString}" acl="OPEN_ACL_UNSAFE" mode="PERSISTENT"&gt;
          &lt;zookeeper:data&gt;foo&lt;/zookeeper:data&gt;
          &lt;zookeeper:expect&gt;
            &lt;zookeeper:result&gt;
              &lt;![CDATA[
                {
                  "responseData":{
                      "path":"/${randomString}"
                  }
                }
              ]]&gt;
            &lt;/zookeeper:result&gt;
          &lt;/zookeeper:expect&gt;
        &lt;/zookeeper:create&gt;

        &lt;zookeeper:get zookeeper-client="zookeeperClient" path="/${randomString}"&gt;
          &lt;zookeeper:expect&gt;
            &lt;zookeeper:result&gt;
              &lt;![CDATA[
              {
                "responseData":{
                  "data":"foo"
                }
              }
              ]]&gt;
            &lt;/zookeeper:result&gt;
          &lt;/zookeeper:expect&gt;
        &lt;/zookeeper:getData&gt;

        &lt;zookeeper:set zookeeper-client="zookeeperClient" path="/${randomString}"&gt;
          &lt;zookeeper:data&gt;bar&lt;/zookeeper:data&gt;
        &lt;/zookeeper:setData&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We added the Zookeeper specific namespace with prefix <strong>zookeeper:</strong> in the Spring XML application context,
so now we can start to add special Zookeeper related test actions to the test case.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The examples above create a new znode in Zookeeper using a <strong>randomString</strong> as path.
We can get and set the data with expecting and validating the result of the Zookeeper server.
This is basically the idea of integrating Zookepper operations to a Citrus test.
This opens the gate to manage Zookeeper related entities within a Citrus test.
We can manipulate and validate the znodes on the Zookeeper instance.</p>
</div>
<div class="paragraph">
<p>Zookeeper keeps its nodes in a hierarchical storage.
This means a znode can have children and we can add and remove those.
In Citrus you can get all children of a znode and manage those within the test:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void testZookeeper() {
    zookeeper()
        .create("/${randomString}/child1", "")
        .acl("OPEN_ACL_UNSAFE")
        .mode("PERSISTENT")
        .validateCommandResult(new CommandResultCallback&lt;ZooResponse&gt;() {
            @Override
            public void doWithCommandResult(ZooResponse result, TestContext context) {
                Assert.assertEquals(result.getResponseData().get("path"), context.replaceDynamicContentInString("/${randomString}/child1"));
            }
        });

    zookeeper()
        .create("/${randomString}/child2", "")
        .acl("OPEN_ACL_UNSAFE")
        .mode("PERSISTENT")
        .validateCommandResult(new CommandResultCallback&lt;ZooResponse&gt;() {
            @Override
            public void doWithCommandResult(ZooResponse result, TestContext context) {
                Assert.assertEquals(result.getResponseData().get("path"), context.replaceDynamicContentInString("/${randomString}/child2"));
            }
        });

    zookeeper()
        .children("/${randomString}")
        .validateCommandResult(new CommandResultCallback&lt;ZooResponse&gt;() {
            @Override
            public void doWithCommandResult(ZooResponse result, TestContext context) {
                Assert.assertEquals(result.getResponseData().get("children").toString(), "[child1, child2]");
            }
        });
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xmlns:zookeeper="http://www.citrusframework.org/schema/zookeeper/testcase"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
              http://www.citrusframework.org/schema/zookeeper/testcase
              http://www.citrusframework.org/schema/zookeeper/testcase/citrus-zookeeper-testcase.xsd"&gt;

  &lt;testcase name="ScpTest"&gt;
    &lt;actions&gt;
        &lt;zookeeper:create zookeeper-client="zookeeperClient" path="/${randomString}/child1" acl="OPEN_ACL_UNSAFE" mode="EPHEMERAL"&gt;
          &lt;zookeeper:data&gt;&lt;/zookeeper:data&gt;
          &lt;zookeeper:expect&gt;
            &lt;zookeeper:result&gt;
              &lt;![CDATA[
                {
                  "responseData":{
                      "path":"/${randomString}/child1"
                  }
                }
              ]]&gt;
            &lt;/zookeeper:result&gt;
          &lt;/zookeeper:expect&gt;
        &lt;/zookeeper:create&gt;

        &lt;zookeeper:create zookeeper-client="zookeeperClient" path="/${randomString}/child2" acl="OPEN_ACL_UNSAFE" mode="EPHEMERAL"&gt;
          &lt;zookeeper:data&gt;&lt;/zookeeper:data&gt;
          &lt;zookeeper:expect&gt;
            &lt;zookeeper:result&gt;
              &lt;![CDATA[
                {
                  "responseData":{
                      "path":"/${randomString}/child2"
                  }
                }
              ]]&gt;
            &lt;/zookeeper:result&gt;
          &lt;/zookeeper:expect&gt;
        &lt;/zookeeper:create&gt;

        &lt;zookeeper:children zookeeper-client="zookeeperClient" path="/${randomString}"&gt;
          &lt;zookeeper:expect&gt;
            &lt;zookeeper:result&gt;
              &lt;![CDATA[
                {
                  "responseData":{
                      "children":["child1","child2"]
                  }
                }
              ]]&gt;
            &lt;/zookeeper:result&gt;
          &lt;/zookeeper:expect&gt;
        &lt;/zookeeper:children&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dynamic-endpoint-components"><a class="anchor" href="#dynamic-endpoint-components"></a><a class="link" href="#dynamic-endpoint-components">31. Dynamic endpoint components</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Endpoints represent the central components in Citrus to send or receive a message on some destination. Usually endpoints get defined in the basic Citrus Spring application context configuration as Spring bean components. In some cases this might be over engineering as the tester just wants to send or receive a message. In particular this is done when doing sanity checks in server endpoints while debugging a certain scenario.</p>
</div>
<div class="paragraph">
<p>With endpoint components you are able to create the Citrus endpoint for sending and receiving a message at test runtime. There is no additional configuration or Spring bean component needed. You just use the endpoint uri in a special naming convention and Citrus will create the endpoint for you. Let us see a first example of this scenario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="DynamicEndpointTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="jms:Hello.Queue?timeout=10000"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                [...]
                &lt;/payload&gt;
            &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="jms:Hello.Response.Queue?timeout=5000"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                [...]
                &lt;/payload&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the endpoint uri just goes into the test case action in substitution to the usual endpoint reference name. Instead of referencing a bean id that points to the previously configured Citrus endpoint we use the endpoint uri directly. The endpoint uri should give all information to create the endpoint at runtime. In the example above we use a keyword <strong>jms:</strong> which tells Citrus that we need to create a JMS message endpoint. Secondly we give the JMS destination name <strong>Hello.Queue</strong> which is a mandatory part of the endpoint uri when using the JMS component. The optional timeout parameter completed the uri. Citrus is able to create the JMS endpoint at runtime sending the message to the defined destination via JMS.</p>
</div>
<div class="paragraph">
<p>Of course this mechanism is not limited to JMS endpoints. We can use all default Citrus message transports in the endpoint uri. Just pick the right keyword that defines the message transport to use. Here is a list of supported keywords:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
jms
</td>
<td class="hdlist2">
<p>Creates a JMS endpoint for sending and receiving message to a queue or topic</p>
</td>
</tr>
<tr>
<td class="hdlist1">
channel
</td>
<td class="hdlist2">
<p>Creates a channel endpoint for sending and receiving messages using an in memory Spring Integration message channel</p>
</td>
</tr>
<tr>
<td class="hdlist1">
http
</td>
<td class="hdlist2">
<p>Creates an HTTP client for sending a request to some server URL synchronously waiting for the response message</p>
</td>
</tr>
<tr>
<td class="hdlist1">
ws
</td>
<td class="hdlist2">
<p>Creates a Web Socket client for sending messages to or receiving messages from a Web Socket server</p>
</td>
</tr>
<tr>
<td class="hdlist1">
soap
</td>
<td class="hdlist2">
<p>Creates a SOAP WebService client that send a proper SOAP message to the server URL and waits for the synchronous response to arrive</p>
</td>
</tr>
<tr>
<td class="hdlist1">
ssh
</td>
<td class="hdlist2">
<p>Creates a new ssh client for publishing a command to the server</p>
</td>
</tr>
<tr>
<td class="hdlist1">
mail
</td>
<td class="hdlist2">
<p>or smtp: Creates a new mail client for sending a mail mime message to an SMTP server</p>
</td>
</tr>
<tr>
<td class="hdlist1">
camel
</td>
<td class="hdlist2">
<p>Creates a new Apache Camel endpoint for sending and receiving Camel exchanges both to and from Camel routes.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
vertx
</td>
<td class="hdlist2">
<p>or eventbus: Creates a new Vert.x instance sending and receiving messages with the network event bus</p>
</td>
</tr>
<tr>
<td class="hdlist1">
rmi
</td>
<td class="hdlist2">
<p>Creates a new RMI client instance sending and receiving messages for method invocation on remote interfaces</p>
</td>
</tr>
<tr>
<td class="hdlist1">
jmx
</td>
<td class="hdlist2">
<p>Creates a new JMX client instance sending and receiving messages to and from a managed bean server.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Depending on the message transport we have to add mandatory parameters to the endpoint uri. In the JMS example we had to specify the destination name. The mandatory parameters are always part of the endpoint uri. Optional parameters can be added as key value pairs to the endpoint uri. The available parameters depend on the endpoint keyword that you have chosen. See these example endpoint uri expressions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">    jms:queuename?connectionFactory=specialConnectionFactory&amp;timeout=10000
    jms:topic:topicname?connectionFactory=topicConnectionFactory
    jms:sync:queuename?connectionFactory=specialConnectionFactory&amp;pollingInterval=100&amp;replyDestination=myReplyDestination

    channel:channelName
    channel:sync:channelName
    channel:channelName?timeout=10000&amp;channelResolver=myChannelResolver

    http:localhost:8088/test
    http://localhost:8088/test
    http:localhost:8088?requestMethod=GET&amp;timeout=10000&amp;errorHandlingStrategy=throwsException&amp;requestFactory=myRequestFactory
    http://localhost:8088/test?requestMethod=DELETE&amp;customParam=foo

    websocket:localhost:8088/test
    websocket://localhost:8088/test
    ws:localhost:8088/test
    ws://localhost:8088/test

    soap:localhost:8088/test
    soap:localhost:8088?timeout=10000&amp;errorHandlingStrategy=propagateError&amp;messageFactory=myMessageFactory

    mail:localhost:25000
    smtp://localhost:25000
    smtp://localhost?timeout=10000&amp;username=foo&amp;password=1234&amp;mailMessageMapper=myMapper

    ssh:localhost:2200
    ssh://localhost:2200?timeout=10000&amp;strictHostChecking=true&amp;user=foo&amp;password=12345678

    rmi://localhost:1099/someService
    rmi:localhost/someService&amp;timeout=10000

    jmx:rmi:///jndi/rmi://localhost:1099/someService
    jmx:platform&amp;timeout=10000

    camel:direct:address
    camel:seda:address
    camel:jms:queue:someQueue?connectionFactory=myConnectionFactory
    camel:activemq:queue:someQueue?concurrentConsumers=5&amp;destination.consumer.prefetchSize=50
    camel:controlbus:route?routeId=myRoute&amp;action=status

    vertx:addressName
    vertx:addressName?port=10105&amp;timeout=10000&amp;pubSubDomain=true
    vertx:addressName?vertxInstanceFactory=vertxFactory</code></pre>
</div>
</div>
<div class="paragraph">
<p>The optional parameters get directly set as endpoint configuration. You can use primitive values as well as Spring bean id references. Citrus will automatically detect the target parameter type and resolve the value to a Spring bean in the application context if necessary. If you use some unknown parameter Citrus will raise an exception at runtime as the endpoint could not be created properly.</p>
</div>
<div class="paragraph">
<p>In synchronous communication we have to reuse endpoint components in order to receive synchronous messages on reply destinations. This is a problem when using dynamic endpoints as the endpoints get created at runtime. Citrus uses a caching of endpoints that get created at runtime. Following from that we have to use the exact same endpoint uri in your test case in order to get the cached endpoint instance. With this little trick synchronous communication will work just as it is done with static endpoint components. Have a look at this sample test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="DynamicEndpointTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="jms:sync:Hello.Sync.Queue"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                [...]
                &lt;/payload&gt;
            &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="jms:sync:Hello.Sync.Queue"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                [...]
                &lt;/payload&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we used the exact dynamic endpoint uri in both send and receive actions. Citrus is then able to reuse the same dynamic endpoint and the synchronous reply will be received as expected. However the reuse of exactly the same endpoint uri might get annoying as we also have to copy endpoint uri parameters and so on.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="DynamicEndpointTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="http://localhost:8080/HelloService?user=1234567"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                [...]
                &lt;/payload&gt;
            &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="http://localhost:8080/HelloService?user=1234567"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                [...]
                &lt;/payload&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have to use the exact same endpoint uri when receiving the synchronous service response. This is not very straight forward. This is why Citrus also supports dynamic endpoint names. With a special endpoint uri parameter called <strong>endpointName</strong> you can name the dynamic endpoint. In a corresponding receive action you just use the endpoint name as reference which makes life easier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="DynamicEndpointTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="http://localhost:8080/HelloService?endpointName=myHttpClient"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                [...]
                &lt;/payload&gt;
            &lt;/message&gt;
        &lt;/send&gt;

        &lt;receive endpoint="http://localhost?endpointName=myHttpClient"&gt;
            &lt;message&gt;
                &lt;payload&gt;
                [...]
                &lt;/payload&gt;
            &lt;/message&gt;
        &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>So we can reference the dynamic endpoint with the given name. The internal <strong>endpointName</strong> uri parameter is automatically removed before sending out messages. Once again the dynamic endpoint uri mechanism provides a fast way to write test cases in Citrus with less configuration. But you should consider to use the static endpoint components defined in the basic Spring bean application context for endpoints that are heavily reused in multiple test cases.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="endpoint-adapter"><a class="anchor" href="#endpoint-adapter"></a><a class="link" href="#endpoint-adapter">32. Endpoint adapter</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Endpoint adapter help to customize the behavior of a Citrus server such as HTTP or SOAP web servers. As the servers get started with the Citrus context they are ready to receive incoming client requests. Now there are different ways to process these incoming requests and to provide a proper response message. By default the server will forward the incoming request to an in-memory message channel where a test can receive the message and provide a synchronous response. This message channel handling is done automatically behind the scenes so the tester does not care about these things. The tester just uses the server directly as endpoint reference in the test case. This is the default behaviour. In addition to that you can define custom endpoint adapters on the Citrus server in order to change this default behavior.</p>
</div>
<div class="paragraph">
<p>You set the custom endpoint adapter directly on the server configuration as follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public HttpServer helloHttpServer() {
    return new HttpServerBuilder()
        .port(8080)
        .autoStart(true)
        .endpointAdapter("emptyResponseEndpointAdapter")
        .build();
}

@BindToRegistry
public EmptyResponseEndpointAdapter emptyResponseEndpointAdapter() {
    return new EmptyResponseEndpointAdapter();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public HttpServer helloHttpServer() {
    return new HttpServerBuilder()
        .port(8080)
        .autoStart(true)
        .endpointAdapter("emptyResponseEndpointAdapter")
        .build();
}

@Bean
public EmptyResponseEndpointAdapter emptyResponseEndpointAdapter() {
    return new EmptyResponseEndpointAdapter();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-http:server id="helloHttpServer"
    port="8080"
    auto-start="true"
    endpoint-adapter="emptyResponseEndpointAdapter"/&gt;

&lt;citrus:empty-response-adapter id="emptyResponseEndpointAdapter"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let us have a closer look at the provided endpoint adapter implementations.</p>
</div>
<div class="sect2">
<h3 id="empty-response-endpoint-adapter"><a class="anchor" href="#empty-response-endpoint-adapter"></a><a class="link" href="#empty-response-endpoint-adapter">32.1. Empty response endpoint adapter</a></h3>
<div class="paragraph">
<p>This is the simplest endpoint adapter you can think of. It simply provides an empty success response using the HTTP response code <strong>200</strong> . The adapter does not need any configurations or properties as it simply responds with an empty HTTP response.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public EmptyResponseEndpointAdapter emptyResponseEndpointAdapter() {
    return new EmptyResponseEndpointAdapter();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public EmptyResponseEndpointAdapter emptyResponseEndpointAdapter() {
    return new EmptyResponseEndpointAdapter();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:empty-response-adapter id="emptyResponseEndpointAdapter"/&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="static-response-endpoint-adapter"><a class="anchor" href="#static-response-endpoint-adapter"></a><a class="link" href="#static-response-endpoint-adapter">32.2. Static response endpoint adapter</a></h3>
<div class="paragraph">
<p>The next more complex endpoint adapter will always return a static response message.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public StaticResponseEndpointAdapter staticEndpointAdapter() {
    StaticResponseEndpointAdapter endpointAdapter = new StaticResponseEndpointAdapter();
    endpointAdapter.setMessagePayload("""
    &lt;HelloResponse
        xmlns="http://citrusframework.org/schemas/samples/sayHello.xsd"&gt;
          &lt;MessageId&gt;123456789&lt;/MessageId&gt;
          &lt;CorrelationId&gt;Cx1x123456789&lt;/CorrelationId&gt;
          &lt;Text&gt;Hello User&lt;/Text&gt;
    &lt;/HelloResponse&gt;
    """);

    endpointAdapter.getMessageHeader().put("Operation", "sayHello");
    endpointAdapter.getMessageHeader().put("MessageId", "123456789");
    return endpointAdapter;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public StaticResponseEndpointAdapter staticEndpointAdapter() {
    StaticResponseEndpointAdapter endpointAdapter = new StaticResponseEndpointAdapter();
    endpointAdapter.setMessagePayload("""
    &lt;HelloResponse
        xmlns="http://citrusframework.org/schemas/samples/sayHello.xsd"&gt;
          &lt;MessageId&gt;123456789&lt;/MessageId&gt;
          &lt;CorrelationId&gt;Cx1x123456789&lt;/CorrelationId&gt;
          &lt;Text&gt;Hello User&lt;/Text&gt;
    &lt;/HelloResponse&gt;
    """);

    endpointAdapter.getMessageHeader().put("Operation", "sayHello");
    endpointAdapter.getMessageHeader().put("MessageId", "123456789");
    return endpointAdapter;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:static-response-adapter id="staticEndpointAdapter"&gt;
    &lt;citrus:payload&gt;
        &lt;![CDATA[
          &lt;HelloResponse
            xmlns="http://citrusframework.org/schemas/samples/sayHello.xsd"&gt;
              &lt;MessageId&gt;123456789&lt;/MessageId&gt;
              &lt;CorrelationId&gt;Cx1x123456789&lt;/CorrelationId&gt;
              &lt;Text&gt;Hello User&lt;/Text&gt;
          &lt;/HelloResponse&gt;
        ]]&gt;
    &lt;/citrus:payload&gt;
    &lt;citrus:header&gt;
        &lt;citrus:element name="Operation" value="sayHello"/&gt;
        &lt;citrus:element name="MessageId" value="123456789"/&gt;
    &lt;/citrus:header&gt;
 &lt;/citrus:static-response-adapter&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The endpoint adapter is configured with a static message payload and static response header values. The response to the client is therefore always the same.
You can add dynamic values by using Citrus functions such as <strong>randomString</strong> or <strong>randomNumber</strong>.
Also, we are able to use values of the actual request message that has triggered the response adapter.
The request is available via the local message store. In combination with Xpath or JsonPath functions we can map values from the actual request.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public StaticResponseEndpointAdapter staticEndpointAdapter() {
    StaticResponseEndpointAdapter endpointAdapter = new StaticResponseEndpointAdapter();
    endpointAdapter.setMessagePayload("""
    &lt;HelloResponse
        xmlns="http://citrusframework.org/schemas/samples/sayHello.xsd"&gt;
          &lt;MessageId&gt;citrus:randomNumber(10)&lt;/MessageId&gt;
          &lt;CorrelationId&gt;citrus:xpath(citrus:message(request.body()), '/hello:HelloRequest/hello:CorrelationId')&lt;/CorrelationId&gt;
          &lt;Text&gt;Hello User&lt;/Text&gt;
    &lt;/HelloResponse&gt;
    """);

    endpointAdapter.getMessageHeader().put("Operation", "sayHello");
    endpointAdapter.getMessageHeader().put("MessageId", "123456789");
    return endpointAdapter;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public StaticResponseEndpointAdapter staticEndpointAdapter() {
    StaticResponseEndpointAdapter endpointAdapter = new StaticResponseEndpointAdapter();
    endpointAdapter.setMessagePayload("""
    &lt;HelloResponse
        xmlns="http://citrusframework.org/schemas/samples/sayHello.xsd"&gt;
          &lt;MessageId&gt;citrus:randomNumber(10)&lt;/MessageId&gt;
          &lt;CorrelationId&gt;citrus:xpath(citrus:message(request.body()), '/hello:HelloRequest/hello:CorrelationId')&lt;/CorrelationId&gt;
          &lt;Text&gt;Hello User&lt;/Text&gt;
    &lt;/HelloResponse&gt;
    """);

    endpointAdapter.getMessageHeader().put("Operation", "sayHello");
    endpointAdapter.getMessageHeader().put("MessageId", "123456789");
    return endpointAdapter;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:static-response-adapter id="staticEndpointAdapter"&gt;
    &lt;citrus:payload&gt;
        &lt;![CDATA[
          &lt;HelloResponse
            xmlns="http://citrusframework.org/schemas/samples/sayHello.xsd"&gt;
              &lt;MessageId&gt;citrus:randomNumber(10)&lt;/MessageId&gt;
              &lt;CorrelationId&gt;citrus:xpath(citrus:message(request.body()), '/hello:HelloRequest/hello:CorrelationId')&lt;/CorrelationId&gt;
              &lt;Text&gt;Hello User&lt;/Text&gt;
          &lt;/HelloResponse&gt;
        ]]&gt;
    &lt;/citrus:payload&gt;
    &lt;citrus:header&gt;
        &lt;citrus:element name="Operation" value="sayHello"/&gt;
        &lt;citrus:element name="MessageId" value="citrus:randomNumber(10)"/&gt;
    &lt;/citrus:header&gt;
 &lt;/citrus:static-response-adapter&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above maps the <strong>CorrelationId</strong> of the <strong>HelloRequest</strong> message to the response with Xpath function. The local message store automatically has the message named
<strong>request</strong> stored so we can access the payload with this message name.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
XML is namespace specific so we need to use the namespace prefix <strong>hello</strong> in the Xpath expression. The namespace prefix should evaluate to a global namespace entry in the global
Citrus <a href="#xml-validation-namespaces">namespace</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="request-dispatching-endpoint-adapter"><a class="anchor" href="#request-dispatching-endpoint-adapter"></a><a class="link" href="#request-dispatching-endpoint-adapter">32.3. Request dispatching endpoint adapter</a></h3>
<div class="paragraph">
<p>The idea behind the request dispatching endpoint adapter is that the incoming requests are dispatched to several other endpoint adapters. The decision which endpoint adapter should handle the actual request is done depending on some adapter mapping. The mapping is done based on the payload or header data of the incoming request. A mapping strategy evaluates a mapping key using the incoming request. You can think of an XPath expression that evaluates to the mapping key for instance. The endpoint adapter that maps to the mapping key is then called to handle the request.</p>
</div>
<div class="paragraph">
<p>So the request dispatching endpoint adapter is able to dynamically call several other endpoint adapters based on the incoming request message at runtime. This is very powerful. The next example uses the request dispatching endpoint adapter with a XPath mapping key extractor.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public RequestDispatchingEndpointAdapter dispatchingEndpointAdapter() {
    RequestDispatchingEndpointAdapter endpointAdapter = new RequestDispatchingEndpointAdapter();

    XPathPayloadMappingKeyExtractor mappingKeyExtractor = new XPathPayloadMappingKeyExtractor();
    mappingKeyExtractor.setXpathExpression("//TestMessage/Operation/*");
    endpointAdapter.setMappingKeyExtractor(mappingKeyExtractor);

    SimpleMappingStrategy mappingStrategy = new SimpleMappingStrategy();
    mappingStrategy.setAdapterMappings("sayHello", helloEndpointAdapter());
    endpointAdapter.setMappingStrategy(mappingStrategy);
    return endpointAdapter;
}

@BindToRegistry
public StaticResponseEndpointAdapter helloEndpointAdapter() {
    StaticResponseEndpointAdapter endpointAdapter = new StaticResponseEndpointAdapter();
    endpointAdapter.setMessagePayload("""
    &lt;HelloResponse
        xmlns="http://citrusframework.org/schemas/samples/sayHello.xsd"&gt;
        &lt;MessageId&gt;123456789&lt;/MessageId&gt;
        &lt;Text&gt;Hello User&lt;/Text&gt;
    &lt;/HelloResponse&gt;
    """);
    return endpointAdapter;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public RequestDispatchingEndpointAdapter dispatchingEndpointAdapter() {
    RequestDispatchingEndpointAdapter endpointAdapter = new RequestDispatchingEndpointAdapter();

    XPathPayloadMappingKeyExtractor mappingKeyExtractor = new XPathPayloadMappingKeyExtractor();
    mappingKeyExtractor.setXpathExpression("//TestMessage/Operation/*");
    endpointAdapter.setMappingKeyExtractor(mappingKeyExtractor);

    SimpleMappingStrategy mappingStrategy = new SimpleMappingStrategy();
    mappingStrategy.setAdapterMappings("sayHello", helloEndpointAdapter());
    endpointAdapter.setMappingStrategy(mappingStrategy);
    return endpointAdapter;
}

@Bean
public StaticResponseEndpointAdapter helloEndpointAdapter() {
    StaticResponseEndpointAdapter endpointAdapter = new StaticResponseEndpointAdapter();
    endpointAdapter.setMessagePayload("""
    &lt;HelloResponse
        xmlns="http://citrusframework.org/schemas/samples/sayHello.xsd"&gt;
        &lt;MessageId&gt;123456789&lt;/MessageId&gt;
        &lt;Text&gt;Hello User&lt;/Text&gt;
    &lt;/HelloResponse&gt;
    """);
    return endpointAdapter;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:dispatching-endpoint-adapter id="dispatchingEndpointAdapter"
         mapping-key-extractor="mappingKeyExtractor"
         mapping-strategy="mappingStrategy"/&gt;

&lt;bean id="mappingStrategy"
  class="org.citrusframework.endpoint.adapter.mapping.SimpleMappingStrategy"&gt;
    &lt;property name="adapterMappings"&gt;
      &lt;map&gt;
          &lt;entry key="sayHello" ref="helloEndpointAdapter"/&gt;
      &lt;/map&gt;
    &lt;/property&gt;
&lt;/bean&gt;

&lt;bean id="mappingKeyExtractor"
  class="org.citrusframework.endpoint.adapter.mapping.XPathPayloadMappingKeyExtractor"&gt;
    &lt;property name="xpathExpression" value="//TestMessage/Operation/*"/&gt;
&lt;/bean&gt;

&lt;citrus:static-response-adapter id="helloEndpointAdapter"&gt;
    &lt;citrus:payload&gt;
        &lt;![CDATA[
            &lt;HelloResponse
                xmlns="http://citrusframework.org/schemas/samples/sayHello.xsd"&gt;
                &lt;MessageId&gt;123456789&lt;/MessageId&gt;
                &lt;Text&gt;Hello User&lt;/Text&gt;
            &lt;/HelloResponse&gt;
        ]]&gt;
    &lt;/citrus:payload&gt;
&lt;/citrus:static-response-adapter&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The XPath mapping key extractor expression decides for each request which mapping key to use in order to find a proper endpoint adapter through the mapping strategy. The endpoint adapters available in the application context are mapped via their bean id. For instance an incoming request with a matching element <strong><em>//TestMessage/Operation/sayHello</em></strong> would be handled by the endpoint adapter bean that is registered in the mapping strategy as "sayHello" key. The available endpoint adapters are configured in the same Spring application context.</p>
</div>
<div class="paragraph">
<p>Citrus provides several default mapping key extractor implementations.</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
HeaderMappingKeyExtractor
</td>
<td class="hdlist2">
<p>Reads a special header entry and uses its value as mapping key</p>
</td>
</tr>
<tr>
<td class="hdlist1">
SoapActionMappingKeyExtractor
</td>
<td class="hdlist2">
<p>Uses the soap action header entry as mapping key</p>
</td>
</tr>
<tr>
<td class="hdlist1">
XPathPayloadMappingKeyExtractor
</td>
<td class="hdlist2">
<p>Evaluates a XPath expression on the request payload and uses the result as mapping key</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In addition to that we need a mapping strategy. Citrus provides following default implementations.</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
SimpleMappingStrategy
</td>
<td class="hdlist2">
<p>Simple key value map with endpoint adapter references</p>
</td>
</tr>
<tr>
<td class="hdlist1">
BeanNameMappingStrategy
</td>
<td class="hdlist2">
<p>Loads the endpoint adapter Spring bean with the given id matching the mapping key</p>
</td>
</tr>
<tr>
<td class="hdlist1">
ContextLoadingMappingStrategy
</td>
<td class="hdlist2">
<p>Same as BeanNameMappingStrategy but loads a separate application context defined by external file resource</p>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="channel-endpoint-adapter"><a class="anchor" href="#channel-endpoint-adapter"></a><a class="link" href="#channel-endpoint-adapter">32.4. Channel endpoint adapter</a></h3>
<div class="paragraph">
<p>The channel connecting endpoint adapter is the default adapter used in all Citrus server components.
Indeed, this adapter also provides the most flexibility.
This adapter forwards incoming requests to a channel destination.
The adapter is waiting for a proper response on a reply destination synchronously.
With the channel endpoint components you can read the requests on the channel and provide a proper response on the reply destination.</p>
</div>
<div class="paragraph">
<p>This special adapter comes with the <strong>citrus-spring-integration</strong> module. So you have to add the module to your project as a dependency.
The Maven module for <strong>citrus-spring-integration</strong> goes to the Maven POM file as normal project dependency.</p>
</div>
<div class="listingblock">
<div class="title">Maven module dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-spring-integration&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can add the Spring integration channel endpoint adapter component to the bean registry.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public ChannelEndpointAdapter channelEndpointAdapter() {
    ChannelSyncEndpointConfiguration endpointConfiguration = new ChannelSyncEndpointConfiguration();
    endpointConfiguration.setChannelName("inbound.channel");
    endpointConfiguration.setTimeout(2500L);
    return new ChannelEndpointAdapter(endpointConfiguration);
    return endpointAdapter;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public ChannelEndpointAdapter channelEndpointAdapter() {
    ChannelSyncEndpointConfiguration endpointConfiguration = new ChannelSyncEndpointConfiguration();
    endpointConfiguration.setChannelName("inbound.channel");
    endpointConfiguration.setTimeout(2500L);
    return new ChannelEndpointAdapter(endpointConfiguration);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:citrus-si="http://www.citrusframework.org/schema/spring-integration/config"
        xsi:schemaLocation="
            http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.citrusframework.org/schema/spring-integration/config
            http://www.citrusframework.org/schema/spring-integration/config/citrus-spring-integration-config.xsd"&gt;

  &lt;citrus-si:channel-endpoint-adapter id="channelEndpointAdapter"
              channel-name="inbound.channel"
              timeout="2500"/&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For the Spring XML bean configuration Citrus provides a <code>citrus-si</code> configuration namespace and schema definition for Spring integration related components and features. Include this namespace into your Spring configuration in order to use the Citrus Spring integration configuration elements. The namespace URI and schema location are added to the Spring configuration XML file.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="jms-endpoint-adapter"><a class="anchor" href="#jms-endpoint-adapter"></a><a class="link" href="#jms-endpoint-adapter">32.5. JMS endpoint adapter</a></h3>
<div class="paragraph">
<p>Another powerful endpoint adapter is the JMS connecting adapter implementation.
This adapter forwards incoming requests to a JMS destination and waits for a proper response on a reply destination.
A JMS endpoint can access the requests internally and provide a proper response on the reply destination.
So this adapter is very flexible to provide proper response messages.</p>
</div>
<div class="paragraph">
<p>This special adapter comes with the <strong>citrus-jms</strong> module. So you have to add the module to your project as a dependency.
The Maven module for <strong>citrus-jms</strong> goes to the Maven POM file as normal project dependency.</p>
</div>
<div class="listingblock">
<div class="title">Maven module dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-jms&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can add the JMS endpoint adapter component to the bean registry.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public JmsEndpointAdapter jmsEndpointAdapter() {
    JmsSyncEndpointConfiguration endpointConfiguration = new JmsSyncEndpointConfiguration();
    endpointConfiguration.setDestinationName("JMS.Queue.Requests.In");
    endpointConfiguration.setReplyDestinationName("JMS.Queue.Requests.In");
    endpointConfiguration.setConnectionFactory(jmsConnectionFactory());
    endpointConfiguration.setTimeout(2500L);
    return new JmsEndpointAdapter(endpointConfiguration);
}

@BindToRegistry
public ActiveMQConnectionFactory jmsConnectionFactory() {
    ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory();
    connectionFactory.setBrokerURL("tcp://localhost:61616");
    return connectionFactory;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmsEndpointAdapter jmsEndpointAdapter() {
    JmsSyncEndpointConfiguration endpointConfiguration = new JmsSyncEndpointConfiguration();
    endpointConfiguration.setDestinationName("JMS.Queue.Requests.In");
    endpointConfiguration.setReplyDestinationName("JMS.Queue.Requests.In");
    endpointConfiguration.setConnectionFactory(jmsConnectionFactory());
    endpointConfiguration.setTimeout(2500L);
    return new JmsEndpointAdapter(endpointConfiguration);
}

@Bean
public ActiveMQConnectionFactory jmsConnectionFactory() {
    ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory();
    connectionFactory.setBrokerURL("tcp://localhost:61616");
    return connectionFactory;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:citrus-jms="http://www.citrusframework.org/schema/jms/config"
        xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.citrusframework.org/schema/jms/config
        http://www.citrusframework.org/schema/jms/config/citrus-jms-config.xsd"&gt;

    &lt;citrus-jms:endpoint-adapter id="jmsEndpointAdapter"
                  destination-name="JMS.Queue.Requests.In"
                  reply-destination-name="JMS.Queue.Response.Out"
                  connection-factory="jmsConnectionFactory"
                  timeout="2500"/&gt;

    &lt;bean id="jmsConnectionFactory" class="org.apache.activemq.artemis.jms.client.ActiveMQConnectionFactory"&gt;
      &lt;property name="brokerURL" value="tcp://localhost:61616"/&gt;
    &lt;/bean&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For the Spring XML bean configuration Citrus provides a <code>citrus-jms</code> configuration namespace and schema definition for JMS related components and features. Include this namespace into your Spring configuration in order to use the Citrus JMS configuration elements. The namespace URI and schema location are added to the Spring configuration XML file.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="connectors"><a class="anchor" href="#connectors"></a><a class="link" href="#connectors">33. Connectors</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Connectors are quite similar to <a href="#endpoints">endpoints</a>.
The modules connect Citrus to a certain technology or framework rather than implementing a message transport (client and server) like endpoints usually do.</p>
</div>
<div class="paragraph">
<p>Connectors typically provide a client side only implementation that enable Citrus to interact with a service or framework (e.g. Docker, Kubernetes, Knative, Selenium, OpenAPI specification).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="openapi"><a class="anchor" href="#openapi"></a><a class="link" href="#openapi">34. OpenAPI support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://www.openapis.org/">OpenAPI</a> is a popular specification language to describe HTTP APIs and its exposure to clients.
Citrus is able to leverage the specification to auto generate client and server request/response message data.
The generated message data follows the rules of a given operation in the specification.
In particular, the message body is generated from the given Json schema rules in that specification.
This way users may do contract-driven testing where the client and the server ensure the conformity with the contract to obey to the same specification rules.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The OpenAPI support in Citrus get enabled by adding a separate Maven module as dependency to your project
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-openapi&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="openapi-specification"><a class="anchor" href="#openapi-specification"></a><a class="link" href="#openapi-specification">34.1. OpenAPI specification</a></h3>
<div class="paragraph">
<p>The OpenAPI test actions in Citrus uses a specification which usually is a json or yaml document shared between the components.</p>
</div>
<div class="paragraph">
<p>Sometimes the specification gets exposed by a server application via HTTP endpoint.
You can directly load the specification from the HTTP URL.
Or you may just point the OpenAPI components to a local specification file.</p>
</div>
<div class="paragraph">
<p>Citrus supports OpenAPI on both client and server components so the next sections will describe the usage for each of those.</p>
</div>
</div>
<div class="sect2">
<h3 id="openapi-client"><a class="anchor" href="#openapi-client"></a><a class="link" href="#openapi-client">34.2. OpenAPI client</a></h3>
<div class="paragraph">
<p>On the client side Citrus uses the OpenAPI specification to generate a proper HTTP request that is sent to the server.
The user just gives a valid operationId from the specification every thing else is automatically generated.
The Citrus client message will use the proper request path (e.g. <code>/petstore/v3/pet</code>) and Content-Type (e.g. <code>applicaiton/json</code>) according to the specification rules.</p>
</div>
<div class="paragraph">
<p>Of course, you can also validate the HTTP response message with auto generated validation.
The user just gives the expected HTTP status code that is also described in the specification (e.g. 200 OK).
The response data used as expected message content is then also generated from the specification.</p>
</div>
<div class="paragraph">
<p>As an example the following OpenAPI specification defines the operation <code>getPetById</code>.</p>
</div>
<div class="listingblock">
<div class="title">petstore-v3.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">openapi: 3.0.2
info:
  title: Petstore
  version: 1.0.1
servers:
  - url: 'http://localhost/petstore/v3/'
paths:
  '/pet/{petId}':
    get:
      operationId: getPetById
      parameters:
        - name: petId
          description: ID of pet to return
          schema:
            format: int64
            type: integer
          in: path
          required: true
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pet'
        '404':
          description: Pet not found
      summary: Find pet by ID
      description: Returns a single pet
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The operation defines the HTTP GET request on <code>/pet/{petId}</code> and the response <code>200</code> OK that delivers the <code>#/components/schemas/Pet</code> Json object to the calling client as a response.</p>
</div>
<div class="paragraph">
<p>The Json schema for the pet defines all properties on the object.</p>
</div>
<div class="listingblock">
<div class="title">Pet Json schema</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">Pet:
  required:
    - category
    - name
    - status
  type: object
  properties:
    id:
      format: int64
      type: integer
    category:
      $ref: '#/components/schemas/Category'
    name:
      type: string
      example: doggie
    photoUrls:
      type: array
      items:
        type: string
    tags:
      type: array
      items:
        $ref: '#/components/schemas/Tag'
    status:
      description: pet status in the store
      enum:
        - available
        - pending
        - sold
      type: string
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a testcase Citrus is able to leverage this information in order to send a proper request and validate the response based on the OpenAPI specification.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private final HttpClient httpClient = new HttpClientBuilder()
            .requestUrl("http://localhost:%d".formatted(port))
            .build();

private final OpenApiSpecification petstoreSpec = OpenApiSpecification.from(
            Resources.create("classpath:org/citrusframework/openapi/petstore/petstore-v3.json"));

@CitrusTest
public void openApiClientTest() {
    when(openapi(petstoreSpec)
                .client(httpClient)
                .send("getPetById"));

    then(openapi(petstoreSpec)
                .client(httpClient)
                .receive("getPetById", HttpStatus.OK));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="OpenApiClientTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;variables&gt;
        &lt;variable name="petstoreSpec" value="classpath:org/citrusframework/openapi/petstore/petstore-v3.json"/&gt;
    &lt;/variables&gt;
    &lt;actions&gt;
        &lt;openapi specification="${petstoreSpec}" client="httpClient"&gt;
          &lt;send-request operation="getPetById"/&gt;
        &lt;/openapi&gt;

        &lt;openapi specification="${petstoreSpec}" client="httpClient"&gt;
          &lt;receive-response operation="getPetById" status="200"/&gt;
        &lt;/openapi&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: OpenApiClientTest
variables:
  - name: petstoreSpec
    value: classpath:org/citrusframework/openapi/petstore/petstore-v3.yaml
actions:
  - openapi:
      specification: ${petstoreSpec}
      client: "httpClient"
      sendRequest:
        operation: getPetById
  - openapi:
      specification: ${petstoreSpec}
      client: "httpClient"
      receiveResponse:
        operation: getPetById
        status: 200</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this very first example The client uses the OpenAPI specification to generate a proper GET HTTP request for the <code>getPetById</code> operation.
The request is sent to the server using the request URL path <code>/petstore/v3/pet/${petId}</code> as declared in the OpenAPI specification.</p>
</div>
<div class="paragraph">
<p>The resulting HTTP response from the server is verified on the client by giving the operationId and the expected status <code>200</code>.
The OpenAPI client generates the expected control message from the given Json schema in the OpenAPI specification.</p>
</div>
<div class="paragraph">
<p>The generated control message contains validation matchers and expressions as follows.</p>
</div>
<div class="listingblock">
<div class="title">Generated control message body</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "id": "@isNumber()@",
  "name": "@notEmpty()@",
  "category": {
    "id": "@isNumber()@",
    "name": "@notEmpty()@"
  },
  "photoUrls": "@notEmpty()@",
  "tags":  "@ignore@",
  "status": "@matches(sold|pending|available)@"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This control message meets the rules defined by the OpenAPI Json schema specification for the pet object.
For instance the enum field <code>status</code> is validated with a matching expression.
In case the OpenAPI specification changes the generated control message will change accordingly.</p>
</div>
<div class="paragraph">
<p>This completes the client side OpenAPI support.
Now let&#8217;s have a closer look at the server side OpenAPI support in the next section.</p>
</div>
</div>
<div class="sect2">
<h3 id="openapi-server"><a class="anchor" href="#openapi-server"></a><a class="link" href="#openapi-server">34.3. OpenAPI server</a></h3>
<div class="paragraph">
<p>On the server side Citrus is able to verify incoming requests based on the OpenAPI specification.
The expected request message content as well as the expected resource URL path and the Content-Type are automatically validated.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private final HttpServer httpServer = new HttpServerBuilder()
            .port(port)
            .timeout(5000L)
            .autoStart(true)
            .defaultStatus(HttpStatus.NO_CONTENT)
            .build();

private final OpenApiSpecification petstoreSpec = OpenApiSpecification.from(
            Resources.create("classpath:org/citrusframework/openapi/petstore/petstore-v3.json"));

@CitrusTest
public void openApiClientTest() {
    when(openapi(petstoreSpec)
                .server(httpServer)
                .receive("addPet"));

    then(openapi(petstoreSpec)
                .server(httpServer)
                .send("addPet", HttpStatus.CREATED));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="OpenApiClientTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;variables&gt;
        &lt;variable name="petstoreSpec" value="classpath:org/citrusframework/openapi/petstore/petstore-v3.json"/&gt;
    &lt;/variables&gt;
    &lt;actions&gt;
        &lt;openapi specification="${petstoreSpec}" server="httpServer"&gt;
          &lt;receive-request operation="addPet"/&gt;
        &lt;/openapi&gt;

        &lt;openapi specification="${petstoreSpec}" server="httpServer"&gt;
          &lt;send-response operation="addPet" status="200"/&gt;
        &lt;/openapi&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: OpenApiClientTest
variables:
  - name: petstoreSpec
    value: classpath:org/citrusframework/openapi/petstore/petstore-v3.yaml
actions:
  - openapi:
      specification: ${petstoreSpec}
      server: "httpServer"
      receiveRequest:
        operation: addPet
  - openapi:
      specification: ${petstoreSpec}
      server: "httpServer"
      sendResponse:
        operation: addPet
        status: 200</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above uses the <code>addPet</code> operation defined in the OpenAPI specification.
The operation expects a HTTP POST request with a pet object as message payload.
The OpenAPI server generates an expected Json message body according to the specification.
This ensures that the incoming client request meets the Json schema rules for the pet object.
Also, the server will verify the HTTP request method, the Content-Type header as well as the used resource path <code>/petstore/v3/pet</code>.</p>
</div>
<div class="paragraph">
<p>The given HTTP status code defines the response that should be sent by the server.
The server will generate a proper response according to the OpenAPI specification.
This also includes a potential response message body (e.g. pet object).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jbang"><a class="anchor" href="#jbang"></a><a class="link" href="#jbang">35. JBang support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>With <a href="https://jbang.dev/">JBang</a> you can run your <code>.java</code> files directly in your shell - instantly without tedious setup.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The JBang support in Citrus gets enabled by adding a separate Maven module as a dependency to your project
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-jbang-connector&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You may wonder why is there another module named <code>citrus-jbang</code>! What is the difference compared to the <code>citrus-jbang-connector</code> module? The <code>citrus-jbang</code> module represents the Citrus JBang app that you can use in JBang to run Citrus tests without any prior setup. The <code>citrus-jbang-connector</code> module provides the JBang support to use JBang as part of a test case, for instance in the form of a test action that runs JBang scripts.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="jbang-action"><a class="anchor" href="#jbang-action"></a><a class="link" href="#jbang-action">35.1. JBang action</a></h3>
<div class="paragraph">
<p>The JBang test action runs a script or JBang application with a spawned process.
You can call any JBang CLI command and run your JBang app.
JBang is called with the Java process API so the JBang CLI binary is executed and the command output is saved for later reference.
You can verify the command output with an expected output and you can also verify the exit code of the spawned process.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void jBangScriptTest() {
    when(jbang()
            .app("myApp")
            .command("getUsers")
            .arg("--username", "FooUser"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="JBangScriptTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;jbang app="myApp" command="getUsers"&gt;
          &lt;args&gt;
            &lt;arg name="--username" value="FooUser"/&gt;
          &lt;/args&gt;
        &lt;/jbang&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: JBangScriptTest
actions:
  - jbang:
      app: "myApp"
      command: "getUsers"
      args:
        - name: "--username"
          value: "FooUser"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test above calls the JBang app <code>myApp</code> with the <code>getUsers</code> command.
The call is similar to a command line statement like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">$ jbang myApp getUsers --username=FooUser</code></pre>
</div>
</div>
<div class="paragraph">
<p>The app <code>myApp</code> represents a JBang application that has been installed previously in JBang (for instance from a GitHub repository that holds a <code>jbang-catalog.json</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">$ jbang app install myApp@github-user/repository</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kubernetes"><a class="anchor" href="#kubernetes"></a><a class="link" href="#kubernetes">36. Kubernetes support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://kubernetes.io/">Kubernetes</a> is one of the hottest management platforms for containerized applications these days.
Kubernetes lets you deploy, scale and manage your Docker containers on the platform.
You get features like auto-scaling, self-healing, service discovery and load balancing.</p>
</div>
<div class="paragraph">
<p>Citrus provides interaction with the Kubernetes REST API to access the Kubernetes cluster and its resources within a Citrus test case.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Kubernetes test components in Citrus are kept in a separate Maven module. If not already done, you have to include the module as Maven dependency to your project
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-kubernetes&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-client"><a class="anchor" href="#kubernetes-client"></a><a class="link" href="#kubernetes-client">36.1. Kubernetes client</a></h3>
<div class="paragraph">
<p>Citrus operates with the Kubernetes remote REST API in order to interact with the Kubernetes platform.
The Kubernetes client component holds the configuration to connect to a Kubernetes cluster:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public KubernetesClient k8sClient() {
    return new KubernetesClientBuilder()
                .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public KubernetesClient k8sClient() {
    return new KubernetesClientBuilder()
                .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-k8s:client id="k8sClient"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Kubernetes client is based on the <a href="https://github.com/fabric8io/kubernetes-client">Fabric8 Java Kubernetes client</a> implementation.
Following from that the component can be configured in various ways.
By default, the client reads the system properties as well as environment variables for default Kubernetes settings such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>kubernetes.master</strong> / <strong>KUBERNETES_MASTER</strong></p>
</li>
<li>
<p><strong>kubernetes.api.version</strong> / <strong>KUBERNETES_API_VERSION</strong></p>
</li>
<li>
<p><strong>kubernetes.trust.certificates</strong> / <strong>KUBERNETES_TRUST_CERTIFICATES</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you set these properties in your environment the client component will automatically pick up the configuration settings.
Also, when using <code>kubectl</code> command line locally the client may automatically use the stored user authentication settings from there.</p>
</div>
<div class="paragraph">
<p>For a complete list of settings and explanation of those please refer to the <a href="https://github.com/fabric8io/kubernetes-client">Fabric8 client documentation</a>.</p>
</div>
<div class="paragraph">
<p>In case you need to set the client configuration explicitly on your environment you can also use explicit settings on the Kubernetes client component:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public KubernetesClient k8sClient() {
    return new KubernetesClientBuilder()
                .client(fabric8Client)
                .url("http://localhost:8843")
                .version("v1")
                .username("user")
                .password("s!cr!t")
                .namespace("user_namespace")
                .messageConverter(messageConverter)
                .objectMapper("objectMapper")
                .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public KubernetesClient k8sClient() {
    return new KubernetesClientBuilder()
                .client(fabric8Client)
                .url("http://localhost:8843")
                .version("v1")
                .username("user")
                .password("s!cr!t")
                .namespace("user_namespace")
                .messageConverter(messageConverter)
                .objectMapper("objectMapper")
                .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-k8s:client id="k8sClient"
              client="fabric8Client"
              url="http://localhost:8843"
              version="v1"
              username="user"
              password="s!cr!t"
              namespace="user_namespace"
              message-converter="messageConverter"
              object-mapper="objectMapper"/&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You have the option to set an <code>oauthToken</code> for the client instead of using <code>username</code> and <code>password</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now Citrus is able to access the Kubernetes remote API for executing commands such as list-pods, watch-services and so on.
Citrus provides a set of actions that perform a Kubernetes command via REST.
The results usually get validated in the Citrus test as usual.</p>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-actions"><a class="anchor" href="#kubernetes-actions"></a><a class="link" href="#kubernetes-actions">36.2. Kubernetes actions</a></h3>
<div class="paragraph">
<p>Citrus provides a set of test actions specifically designed to manage resources on the Kubernetes cluster.
Each test action requires a reference to the Kubernetes client.
Usually this client is created once in the bean registry and used by many test actions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All resources created on the Kubernetes cluster will be automatically removed by Citrus after the test.
You can disable this default behavior via system property setting or environment variables (<code>citrus.kubernetes.auto.remove.resources=false</code> or <code>CITRUS_KUBERNETES_AUTO_REMOVE_RESOURCES=false</code>)
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-create-labels"><a class="anchor" href="#kubernetes-create-labels"></a><a class="link" href="#kubernetes-create-labels">36.3. Create Labels</a></h3>
<div class="paragraph">
<p>Resources in Kubernetes are able to expose labels as part of the resource metadata.
You can set labels on existing Kubernetes resources with this test action:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void createLabelsTest() {
    given(kubernetes()
            .client(k8sClient)
            .pods()
            .addLabel("my-pod")
            .label("test", "citrus")
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CreateLabelsTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
        &lt;create-labels type="POD" resource="my-pod"&gt;
          &lt;labels&gt;
            &lt;label name="test" value="citrus"/&gt;
          &lt;/labels&gt;
        &lt;/create-labels&gt;
      &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: CreateLabelsTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      createLabels:
        type: "POD"
        resource: "my-pod"
        labels:
          - name: "test"
            value: "citrus"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-create-annotations"><a class="anchor" href="#kubernetes-create-annotations"></a><a class="link" href="#kubernetes-create-annotations">36.4. Create Annotations</a></h3>
<div class="paragraph">
<p>Resources in Kubernetes are able to expose annotations as part of the resource metadata.
You can set annotations on existing Kubernetes resources with this test action:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void createAnnotationsTest() {
    given(kubernetes()
            .client(k8sClient)
            .pods()
            .addAnnotation("my-pod")
            .annotation("test", "citrus")
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CreateAnnotationsTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
        &lt;create-annotations type="POD" resource="my-pod"&gt;
          &lt;annotations&gt;
            &lt;annotation name="test" value="citrus"/&gt;
          &lt;/annotations&gt;
        &lt;/create-annotations&gt;
      &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: CreateAnnotationsTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      createAnnotations:
        type: "POD"
        resource: "my-pod"
        labels:
          - name: "test"
            value: "citrus"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-create-service"><a class="anchor" href="#kubernetes-create-service"></a><a class="link" href="#kubernetes-create-service">36.5. Create Service</a></h3>
<div class="paragraph">
<p>You can create a Kubernetes service resource with this test action:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void createServiceTest() {
    given(kubernetes()
            .client(k8sClient)
            .services()
            .create("my-service")
            .portMapping(80, 8080)
            .withPodSelector(Collections.singletonMap("test", "citrus"))
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CreateServiceTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
        &lt;create-service name="my-service"&gt;
          &lt;ports&gt;
            &lt;port-mapping port="80" target-port="8080"/&gt;
          &lt;/ports&gt;
          &lt;selector&gt;
            &lt;label name="test" value="citrus"/&gt;
          &lt;/selector&gt;
        &lt;/create-service&gt;
      &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: CreateServiceTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      createService:
        name: "my-service"
        ports:
          - port: "80"
            targetPort: "8080"
        selector:
          labels:
            - name: "test"
              value: "citrus"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service is able to define port mappings as well as pod selectors based on labels.
This exposes the service as a Kubernetes resource on the connected cluster in the given namespace.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The Kubernetes service test action will automatically bind this service to a local HttpServer instance on the given port mapping.
As a result the HttpServer instance is created and started as part of the test action.
The HttpServer instance is added to the bean registry for further reference.
The default HttpServer bean name is <code>citrus-k8s-service</code> or the service name chosen for the Kubernetes service.
You can reference the HttpServer in following test actions to receive requests from the Kubernetes service.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The behavior to auto create the HttpServer instance can be disabled via system property or environment variable setting (<code>citrus.kubernetes.auto.create.server.binding=false</code> or <code>CITRUS_KUBERNETES_AUTO_CREATE_SERVER_BINDING=false</code> )
You can also customize the HttpServer instance by referencing a previously created server from the bean registry.
In this case the auto creation is skipped for this test action and the custom server reference is used.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-connect-service"><a class="anchor" href="#kubernetes-connect-service"></a><a class="link" href="#kubernetes-connect-service">36.6. Connect with Service</a></h3>
<div class="paragraph">
<p>Every Kubernetes Deployment is able to expose a service to other resources on the cluster so clients are able to call the service endpoint.
Usually Kubernetes service exposes this endpoint to internal clients only (e.g. service type is ClusterIP).
Internal client means that the client connects from within the same cluster (e.g. from another pod).
Following from that your test that runs on your local machine may not have access to the Kubernetes service endpoint.</p>
</div>
<div class="paragraph">
<p>The solution for that is to connect to the Kubernetes service as part of the Citrus test.
This enables the access to such a Kubernetes service.
The service connection uses a port forward to the Kubernetes service and the underlying Kubernetes pod.
You can then use a local port on your machine to access the Kubernetes service.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void connectServiceTest() {
    given(kubernetes()
            .client(k8sClient)
            .services()
            .connect("my-service")
            .portMapping(8080, 31234)
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ServiceConnectTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
  &lt;actions&gt;
    &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
      &lt;connect&gt;
        &lt;service name="my-service" port="8080" local-port="31234"/&gt;
      &lt;/connect&gt;
    &lt;/kubernetes&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ServiceConnectTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      connect:
        service:
          name: "my-service"
          port: 8080
          localPort: 31234</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service connect test action creates a new port forward using a local port on your machine connecting to the exposed port on the service.
The user is able to define the port mapping with a fixed local port and the target exposed port on the Kubernetes service.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can also skip the local port setting to choose a random local port.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This opens the connection of your local machine to the Kubernetes service so sending requests to the local endpoint will invoke the service on the Kubernetes cluster.
The port forward is kept open for the rest of your test or until you explicitly disconnect.</p>
</div>
<div class="paragraph">
<p>The connect test action automatically creates a new Http client instance and stores this in the Citrus registry.
You can use the client in following test actions to connect to the new port forward service endpoint.
As usual, you can reference the client by its name in the Citrus registry.
The name of the Http client instance that connects to the new port forward service uses a default pattern: <code>&lt;service-name&gt;.client</code>.</p>
</div>
<div class="paragraph">
<p>In our example the client is stored in the Citrus registry with the name <code>my-service.client</code>.
You can use the client in a normal Http test action to call the new port forward service.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void connectServiceTest() {
    when(http()
        .client("my-service.client")
        .send()
        .get()
    );

    then(http()
        .client("my-service.client")
        .receive()
        .response(HttpStatus.OK.value())
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ServiceConnectTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
  &lt;actions&gt;
    &lt;http client="my-service.client"&gt;
      &lt;send-request&gt;
        &lt;GET/&gt;
      &lt;/send-request&gt;
    &lt;/http&gt;

    &lt;http client="my-service.client"&gt;
      &lt;receive-response&gt;
        &lt;response status="200" reason-phrase="OK"/&gt;
      &lt;/receive-response&gt;
    &lt;/http&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ServiceConnectTest
actions:
  - http:
      client: "my-service.client"
      sendRequest:
        GET: {}
  - http:
      client: "httpClient"
      receiveResponse:
        status: 200
        reasonPhrase: OK</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of using the default generated Http client name you can also explicitly specify a client name.
Citrus will search create the client and add it to the Citrus registry with that name.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The Kubernetes service port forward may require special permissions on your Kubernetes cluster. Please make sure to connect with a proper user that is able to create the port forward. On Kubernetes platforms such as Minikube or Kind this is given by default. On other cluster types you may need to set up special permissions for your local Kubernetes user.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The port forward connection is automatically closed when the test ends. This is done with an explicit disconnect test action that is run in the finally section of the current test. In case you need to keep the port forward connection open you can disable the <code>auto-remove</code> option on the connect test action.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-disconnect-service"><a class="anchor" href="#kubernetes-disconnect-service"></a><a class="link" href="#kubernetes-disconnect-service">36.7. Disconnect from Service</a></h3>
<div class="paragraph">
<p>By default, the port forward service connection is closed automatically when the test ends.
In case you need to explicitly close the port forward connection you can do so with the following test action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void connectServiceTest() {
    given(kubernetes()
            .client(k8sClient)
            .services()
            .disconnect("my-service")
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ServiceConnectTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
  &lt;actions&gt;
    &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
      &lt;disconnect&gt;
        &lt;service name="my-service"/&gt;
      &lt;/disconnect&gt;
    &lt;/kubernetes&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ServiceConnectTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      disconnect:
        service:
          name: "my-service"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This closes the port forward to the Kubernetes service immediately.</p>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-create-config-map"><a class="anchor" href="#kubernetes-create-config-map"></a><a class="link" href="#kubernetes-create-config-map">36.8. Create ConfigMap</a></h3>
<div class="paragraph">
<p>You can create a Kubernetes config map with this test action:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void createConfigMapTest() {
    given(kubernetes()
            .client(k8sClient)
            .configMaps()
            .create("my-config-map")
            .properties(Collections.singletonMap("username", "foo"))
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CreateConfigMapTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
        &lt;create-config-map name="my-config-map"&gt;
          &lt;properties&gt;
            &lt;property name="username" value="foo"/&gt;
          &lt;/properties&gt;
        &lt;/create-config-map&gt;
      &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: CreateConfigMapTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      createConfigMap:
        name: "my-config-map"
        properties:
          - name: username
            value: foo</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to load the properties from a file resource:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void createConfigMapTest() {
    given(kubernetes()
            .client(k8sClient)
            .configMaps()
            .create("my-config-map")
            .fromFile(Resources.create("application.properties"))
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CreateConfigMapTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
        &lt;create-config-map name="my-config-map" file="application.properties"/&gt;
      &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: CreateConfigMapTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      createConfigMap:
        name: "my-config-map"
        file: "application.properties"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-create-secret"><a class="anchor" href="#kubernetes-create-secret"></a><a class="link" href="#kubernetes-create-secret">36.9. Create Secret</a></h3>
<div class="paragraph">
<p>You can create a Kubernetes secret with this test action:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void createSecretTest() {
    given(kubernetes()
            .client(k8sClient)
            .secrets()
            .create("my-secret")
            .properties(Collections.singletonMap("password", "top_secret"))
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CreateSecretTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
        &lt;create-secret name="my-secret"&gt;
          &lt;properties&gt;
            &lt;property name="password" value="top_secret"/&gt;
          &lt;/properties&gt;
        &lt;/create-secret&gt;
      &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: CreateSecretTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      createSecret:
        name: "my-secret"
        properties:
          - name: password
            value: top_secret</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to load the properties from a file resource:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void createSecretTest() {
    given(kubernetes()
            .client(k8sClient)
            .secrets()
            .create("my-secret")
            .fromFile(Resources.create("credentials.properties"))
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CreateSecretTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
        &lt;create-secret name="my-secret" file="credentials.properties"/&gt;
      &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: CreateSecretTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      createSecret:
        name: "my-secret"
        file: "credentials.properties"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-create-resources"><a class="anchor" href="#kubernetes-create-resources"></a><a class="link" href="#kubernetes-create-resources">36.10. Create Resources</a></h3>
<div class="paragraph">
<p>You can create standards Kubernetes resources such as Pods as part of the test.
The easiest way to define the resource specification is to give a YAML file that represents the resource.</p>
</div>
<div class="paragraph">
<p>Of course, you can use Citrus test variables in the resource specification.</p>
</div>
<div class="listingblock">
<div class="title">pod.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  name: my-pod
  labels:
    name: my-pod
spec:
  containers:
    - name: nginx
      image: nginx
      ports:
        - containerPort: 80</code></pre>
</div>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void createPodResourceTest() {
    given(kubernetes()
            .client(k8sClient)
            .resources()
            .create()
            .resource(Resources.create("pod.yaml"))
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CreatePodResourceTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
        &lt;create-resource file="pod.yaml"/&gt;
      &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: CreatePodResourceTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      createResource:
        file: "pod.yaml"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-delete-resources"><a class="anchor" href="#kubernetes-delete-resources"></a><a class="link" href="#kubernetes-delete-resources">36.11. Delete Resources</a></h3>
<div class="paragraph">
<p>You can delete any resource on the Kubernetes cluster.
Of course your client connection needs to have sufficient permissions to perform the delete operation.
The Kubernetes resource that should be deleted is identified by its name and an optional namespace.</p>
</div>
<div class="paragraph">
<p>The next example deletes a service resource identified by its name.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void deleteServiceTest() {
    given(kubernetes()
            .client(k8sClient)
            .services()
            .delete("my-service")
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="DeleteServiceTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
        &lt;delete-service name="my-service"/&gt;
      &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: DeleteServiceTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      deleteService:
        name: "my-service"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an alternative to that you can also use a resource specification to delete the resource.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void deletePodResourceTest() {
    given(kubernetes()
            .client(k8sClient)
            .resources()
            .delete()
            .resource(Resources.create("pod.yaml"))
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="DeletePodResourceTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
        &lt;delete-resource file="pod.yaml"/&gt;
      &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: DeletePodResourceTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      deleteResource:
        file: "pod.yaml"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-create-custom-resource"><a class="anchor" href="#kubernetes-create-custom-resource"></a><a class="link" href="#kubernetes-create-custom-resource">36.12. Create Custom Resource</a></h3>
<div class="paragraph">
<p>Given the following Kubernetes custom resource:</p>
</div>
<div class="listingblock">
<div class="title">foo.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: citrus.dev/v1
kind: Foo
metadata:
  name: my-foo
  labels:
    test: citrus
spec:
  message: Hello</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can create the Kubernetes custom resource with this test action:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void createCustomResourceTest() {
    given(kubernetes()
            .client(k8sClient)
            .customResources()
            .create()
            .kind("Foo")
            .apiVersion("citrus.dev/v1")
            .file("foo.yaml")
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CreateCustomResourceTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
        &lt;create-custom-resource kind="Foo" api-version="citrus.dev/v1" file="foo.yaml" /&gt;
      &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: CreateCustomResourceTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      createCustomResource:
        kind: "Foo"
        apiVersion: "citrus.dev/v1"
        file: "foo.yaml"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When you have access to a Fabric8 Java model that represents the custom resource you can use the Java type to specify the Kind and ApiVersion while creating the resource.
Also, you can use a Java object instance directly to create the resource with the Fabric8 Kubernetes client.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-delete-custom-resources"><a class="anchor" href="#kubernetes-delete-custom-resources"></a><a class="link" href="#kubernetes-delete-custom-resources">36.13. Delete Custom Resource</a></h3>
<div class="paragraph">
<p>When you want to delete a Kubernetes custom resource you need to specify the Kind as well as the ApiVersion in combination with the resource name on the cluster.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void createCustomResourceTest() {
    given(kubernetes()
            .client(k8sClient)
            .customResources()
            .delete()
            .kind("Foo")
            .apiVersion("citrus.dev/v1")
            .name("foo")
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="DeleteCustomResourceTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
        &lt;delete-custom-resource kind="Foo" api-version="citrus.dev/v1" name="foo" /&gt;
      &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: DeleteCustomResourceTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      deleteCustomResource:
        kind: "Foo"
        apiVersion: "citrus.dev/v1"
        name: "foo"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When you have access to a Fabric8 Java model that represents the custom resource you can use the Java type to specify the Kind and ApiVersion while deleting the resource.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-verify-custom-resources"><a class="anchor" href="#kubernetes-verify-custom-resources"></a><a class="link" href="#kubernetes-verify-custom-resources">36.14. Verify Custom Resource</a></h3>
<div class="paragraph">
<p>You can verify the ready condition status for a Kubernetes custom resource.
Usually the custom resource exposes a Status sub-resource with that expose a ready condition.
You can verify this condition as part of a test like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void verifyCustomResourceTest() {
    given(kubernetes()
            .client(k8sClient)
            .customResources()
            .verify("foo")
            .kind("Foo")
            .apiVersion("citrus.dev/v1")
            .isReady()
            .maxAttempts(2)
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="VerifyCustomResourceTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
        &lt;verify-custom-resource kind="Foo" api-version="citrus.dev/v1" name="foo" condition="Ready" /&gt;
      &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: VerifyCustomResourceTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      verifyCustomResource:
        kind: "Foo"
        apiVersion: "citrus.dev/v1"
        name: "foo"
        condition: "Ready"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Instead of specifying the resource name you can also use a label expression (name=value) to identify the custom resource on the cluster namespace.
Citrus tries to find the resource with the matching label.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-verify-pods"><a class="anchor" href="#kubernetes-verify-pods"></a><a class="link" href="#kubernetes-verify-pods">36.15. Verify Pod Status</a></h3>
<div class="paragraph">
<p>Each Pod in Kubernetes exposes its Ready state condition as well as the phase (Running, Error, Initializing, Terminating, &#8230;&#8203;).
You can verify this Pod status in your test case:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void verifyPodTest() {
    given(kubernetes()
            .client(k8sClient)
            .pods()
            .verify("my-pod")
            .isRunning()
            .maxAttempts(2)
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="VerifyPodTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
        &lt;verify-pod name="my-pod" phase="Running" /&gt;
      &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: VerifyPodTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      verifyPod:
        name: "my-pod"
        phase: "Running"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When asserting the <code>Running</code> phase the verification also checks for all containers in the Pod to expose the condition <code>Ready</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-verify-pod-logs"><a class="anchor" href="#kubernetes-verify-pod-logs"></a><a class="link" href="#kubernetes-verify-pod-logs">36.16. Verify Pod Logs</a></h3>
<div class="paragraph">
<p>You can read and verify the Pod logs as part of the test.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void verifyPodTest() {
    given(kubernetes()
            .client(k8sClient)
            .pods()
            .verify("my-pod")
            .isRunning()
            .waitForLogMessage("Something interesting")
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="VerifyPodTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
        &lt;verify-pod name="my-pod" phase="Running" log-message="Something interesting"/&gt;
      &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: VerifyPodTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      verifyPod:
        name: "my-pod"
        phase: "Running"
        logMessage: "Something interesting"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This action scans the Pod logs for a message <code>Something interesting</code>.
As soon as the log message has been located in the Pod logs the test action finishes with success.
The action waits for the log message to appear in the Pod logs for given amount of time with a specified polling attempt configuration.</p>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-agent"><a class="anchor" href="#kubernetes-agent"></a><a class="link" href="#kubernetes-agent">36.17. Kubernetes Citrus agent</a></h3>
<div class="paragraph">
<p>The Citrus agent is a way to run tests as part of the Kubernetes platform.
You can deploy the Citrus agent on the Kubernetes cluster.
Usually the agent exposes a REST service endpoint so clients are then able to inject Citrus tests for execution.</p>
</div>
<div class="paragraph">
<p>The Citrus agent runs as part of the Kubernetes cluster, so it has access to Kubernetes resources on the same namespace.
This means the tests that run with the agent are able to access resources such as Knative eventing brokers, Services, ConfigMaps, Secrets and many more.</p>
</div>
<div class="sect3">
<h4 id="kubernetes-agent-connect"><a class="anchor" href="#kubernetes-agent-connect"></a><a class="link" href="#kubernetes-agent-connect">36.17.1. Agent connect</a></h4>
<div class="paragraph">
<p>You can connect to a Citrus agent service as part of your test like follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void agentConnectTest() {
    given(kubernetes()
            .client(k8sClient)
            .agent()
            .connect()
            .service("citrus-agent")
            .localPort(12345)
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="AgentConnectTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
        &lt;agent&gt;
          &lt;connect name="citrus-agent" local-port="12345"/&gt;
        &lt;/agent&gt;
      &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: AgentConnectTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      agent:
        connect:
          name: "citrus-agent"
          localPort: 12345</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The agent connect test action connects to the Citrus agent service on the given Kubernetes namespace.
In case the Citrus agent application has been deployed already and the exposed service is available the test action connects to the service via local port forwarding (see also the section about <a href="#kubernetes-connect-service">connecting with a Kubernetes Service</a>).
This means that you will be able to trigger test runs on the agent with calling REST operations on the local endpoint.</p>
</div>
<div class="paragraph">
<p>In case the Citrus agent application is not present on the Kubernetes cluster the connect test action will automatically create the deployment on the given namespace.
The deployment includes a ConfigMap that holds the test case sources (e.g. in the form of a <code>test-jar</code> Java archive).
The agent deployment specification will mount the test sources into the agent Pod via volume mounts, so you can run the tests from the <code>test-jar</code> Java archive.</p>
</div>
<div class="paragraph">
<p>Also, the action creates a new Kubernetes service that exposes the agent REST API and the Web UI.
Once the connection is done you can start triggering test actions and test runs on the Citrus agent.</p>
</div>
</div>
<div class="sect3">
<h4 id="kubernetes-agent-run"><a class="anchor" href="#kubernetes-agent-run"></a><a class="link" href="#kubernetes-agent-run">36.17.2. Agent run</a></h4>
<div class="paragraph">
<p>When the local test is connected to the Kubernetes Citrus agent you can trigger the test execution on the agent.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void agentRunTest() {
    given(agent()
            .run()
            .sourceFile("classpath:my-test.groovy"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="AgentRunTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;agent&gt;
        &lt;run&gt;
          &lt;source file="classpath:my-test.groovy"/&gt;
        &lt;/run&gt;
      &lt;/agent&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: AgentRunTest
actions:
  - agent:
      source:
        file: "classpath:my-test.groovy"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test source code can be any of the supported domain specific languages (e.g. XML, YAML, Java, Groovy, Cucumber).
The example above loads a Groovy test source code file.
The test actions will be sent to the Citrus agent and executed as a test within the agent runtime.
The test results are validated for success outcome and in case the remote test execution fails the local Citrus agent run action will also fail accordingly.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When using XML and YAML tests you can also leverage the possibility to use inline test actions as part of the Citrus agent run action
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: AgentRunTest
actions:
  - agent:
      run:
        actions:
          - echo:
              message: Citrus rocks!</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="AgentRunTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;agent&gt;
        &lt;run&gt;
          &lt;actions&gt;
            &lt;echo message="Citrus rocks!"/&gt;
          &lt;/actions&gt;
        &lt;/run&gt;
      &lt;/agent&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>All nested test actions within the Citrus agent run action will be run on the connected remote Citrus agent.</p>
</div>
</div>
<div class="sect3">
<h4 id="kubernetes-agent-disconnect"><a class="anchor" href="#kubernetes-agent-disconnect"></a><a class="link" href="#kubernetes-agent-disconnect">36.17.3. Agent disconnect</a></h4>
<div class="paragraph">
<p>You can explicitly disconnect from the Citrus agent service.
This terminates the local port forward and also removes the Citrus agent deployment and all dependent resources from the current Kubernetes namespace.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void agentDisconnectTest() {
    given(kubernetes()
            .client(k8sClient)
            .agent()
            .disconnect()
            .service("citrus-agent")
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="AgentDisconnectTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
        &lt;agent&gt;
          &lt;disconnect name="citrus-agent"/&gt;
        &lt;/agent&gt;
      &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: AgentDisconnectTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      agent:
        disconnect:
          name: "citrus-agent"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-spring"><a class="anchor" href="#kubernetes-spring"></a><a class="link" href="#kubernetes-spring">36.18. Spring bean config</a></h3>
<div class="paragraph">
<p>Citrus provides a "citrus-kubernetes" configuration namespace and schema definition for Kubernetes related components and actions.
Include this namespace into your Spring configuration in order to use the Citrus Kubernetes configuration elements.</p>
</div>
<div class="sect3">
<h4 id="kubernetes-spring-config"><a class="anchor" href="#kubernetes-spring-config"></a><a class="link" href="#kubernetes-spring-config">36.18.1. Spring XML config namespace</a></h4>
<div class="paragraph">
<p>The namespace URI and schema location are added to the Spring configuration XML file as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus-k8s="http://www.citrusframework.org/schema/kubernetes/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/kubernetes/config
           http://www.citrusframework.org/schema/kubernetes/config/citrus-kubernetes-config.xsd"&gt;

    [...]

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that you are able to use customized Citrus XML elements in order to define the Spring beans.</p>
</div>
</div>
<div class="sect3">
<h4 id="kubernetes-spring-test"><a class="anchor" href="#kubernetes-spring-test"></a><a class="link" href="#kubernetes-spring-test">36.18.2. Spring XML testcase namespace</a></h4>
<div class="paragraph">
<p>We have several Citrus test actions each representing a Kubernetes command.
These actions can be part of a test case where you can manage Kubernetes pods inside the test.
As a prerequisite we have to enable the Kubernetes specific test actions in our XML test as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:k8s="http://www.citrusframework.org/schema/kubernetes/testcase"
        xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.citrusframework.org/schema/kubernetes/testcase
        http://www.citrusframework.org/schema/kubernetes/testcase/citrus-kubernetes-testcase.xsd"&gt;

    [...]

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We added a special kubernetes namespace with prefix <strong>k8s:</strong> so now we can start to add Kubernetes test actions to the test case:</p>
</div>
<div class="listingblock">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="KubernetesCommandIT"&gt;
    &lt;actions&gt;
      &lt;k8s:info client="myK8sClient"&gt;
        &lt;k8s:validate&gt;
          &lt;k8s:result&gt;{
            "result": {
              "clientVersion": "1.4.27",
              "apiVersion": "v1",
              "kind":"Info",
              "masterUrl": "${masterUrl}",
              "namespace": "test"
            }
          }&lt;/k8s:result&gt;
        &lt;/k8s:validate&gt;
      &lt;/k8s:info&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this very simple example we first ping the Kubernetes REST API to make sure we have connectivity up and running.
The info command connects the REST API and returns a list of status information of the Kubernetes client.</p>
</div>
<div class="paragraph">
<p>Based on that we can execute several Kubernetes commands in a test case and validate the Json results.</p>
</div>
<div class="paragraph">
<p>Citrus supports the following Kubernetes API commands with respective test actions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>k8s:info</strong></p>
</li>
<li>
<p><strong>k8s:list-pods</strong></p>
</li>
<li>
<p><strong>k8s:get-pod</strong></p>
</li>
<li>
<p><strong>k8s:delete-pod</strong></p>
</li>
<li>
<p><strong>k8s:list-services</strong></p>
</li>
<li>
<p><strong>k8s:get-service</strong></p>
</li>
<li>
<p><strong>k8s:delete-service</strong></p>
</li>
<li>
<p><strong>k8s:list-namespaces</strong></p>
</li>
<li>
<p><strong>k8s:list-events</strong></p>
</li>
<li>
<p><strong>k8s:list-endpoints</strong></p>
</li>
<li>
<p><strong>k8s:list-nodes</strong></p>
</li>
<li>
<p><strong>k8s:list-replication-controllers</strong></p>
</li>
<li>
<p><strong>k8s:watch-pods</strong></p>
</li>
<li>
<p><strong>k8s:watch-services</strong></p>
</li>
<li>
<p><strong>k8s:watch-namespaces</strong></p>
</li>
<li>
<p><strong>k8s:watch-nodes</strong></p>
</li>
<li>
<p><strong>k8s:watch-replication-controllers</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will discuss these commands in detail in the following sections.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-commands"><a class="anchor" href="#kubernetes-commands"></a><a class="link" href="#kubernetes-commands">36.19. Kubernetes commands</a></h3>
<div class="paragraph">
<p>The Citrus test may use Kubernetes commands that get run as test actions.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void kubernetesTest() {
    kubernetes().info()
        .validate(new CommandResultCallback&lt;InfoResult&gt;() {
            @Override
            public void doWithCommandResult(InfoResult info, TestContext context) {
                Assert.assertEquals(info.getApiVersion(), "v1");
            }
    });

    kubernetes().pods()
                .list()
                .withoutLabel("running")
                .label("app", "myApp");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="KubernetesCommandIT"&gt;
    &lt;actions&gt;
      &lt;k8s:info&gt;
        &lt;k8s:validate&gt;
          &lt;k8s:result&gt;{
            "result": {
              "clientVersion": "1.4.27",
              "apiVersion": "v1",
              "kind":"Info",
              "masterUrl": "${masterUrl}",
              "namespace": "test"
            }
          }&lt;/k8s:result&gt;
        &lt;/k8s:validate&gt;
      &lt;/k8s:info&gt;

      &lt;k8s:list-pods&gt;
        &lt;k8s:validate&gt;
          &lt;k8s:result&gt;{
            "result": {
              "apiVersion":"v1",
              "kind":"PodList",
              "metadata":"@ignore@",
              "items":[]
            }
          }&lt;/k8s:result&gt;
          &lt;k8s:element path="$.result.items.size()" value="0"/&gt;
        &lt;/k8s:validate&gt;
      &lt;/k8s:list-pods&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this very simple example we first ping the Kubernetes REST API to make sure we have connectivity up and running.
The info command connects the REST API and returns a list of status information of the Kubernetes client.
After that we get the list of available Kubernetes pods.</p>
</div>
<div class="paragraph">
<p>As a tester we might be interested in validating the command results.
So we can specify an optional <strong>k8s:result</strong> which is usually in Json format.
With that we can apply the full Citrus Json validation power to the Kubernetes results.
As usual, we can use test variables here and ignore some values explicitly such as the <strong>metadata</strong> value.
Also, JsonPath expression validation and Json test message validation features in Citrus come in here to validate the results.</p>
</div>
<div class="paragraph">
<p>The Java DSL Kubernetes commands provide an optional <strong>KubernetesCommandResultCallback</strong> that is automatically called with the unmarshalled command result object.
In the example above the <em>InfoResult</em> model object is passed as argument to the callback.
So the tester can access the command result and validate its properties with assertions.</p>
</div>
<div class="paragraph">
<p>The option of Lamdba expressions allows us to use some syntactical sugar in Java when using the <strong>KubernetesCommandResultCallback</strong>.</p>
</div>
<div class="listingblock">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void kubernetesTest() {
    kubernetes().info()
                .validate((info, context) -&gt; Assert.assertEquals(info.getApiVersion(), "v1"));
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, Citrus tries to find a Kubernetes client component within the Citrus Spring application context.
If not present Citrus will instantiate a default kubernetes client with all default settings.
You can also explicitly set the kubernetes client instance when using the Java DSL Kubernetes command actions:
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
private KubernetesClient k8sClient;

@CitrusTest
public void kubernetesTest() {
    kubernetes().client(k8sClient)
                .info()
                .validate((info, context) -&gt; Assert.assertEquals(info.getApiVersion(), "v1"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="KubernetesCommandIT"&gt;
    &lt;actions&gt;
      &lt;k8s:info client="k8sClient"&gt;
        &lt;k8s:validate&gt;
          &lt;k8s:result&gt;{
            "result": {
              "clientVersion": "1.4.27",
              "apiVersion": "v1",
              "kind":"Info",
              "masterUrl": "${masterUrl}",
              "namespace": "test"
            }
          }&lt;/k8s:result&gt;
        &lt;/k8s:validate&gt;
      &lt;/k8s:info&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="info-command"><a class="anchor" href="#info-command"></a><a class="link" href="#info-command">36.19.1. Info command</a></h4>
<div class="paragraph">
<p>The info command just gets the client connection settings and provides them as a Json result to the action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void infoTest() {
    kubernetes().info()
                .validate((info, context) -&gt; Assert.assertEquals(info.getApiVersion(), "v1"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;k8s:info client="myK8sClient"&gt;
  &lt;k8s:validate&gt;
    &lt;k8s:result&gt;{
      "result": {
        "clientVersion": "1.4.27",
        "apiVersion": "v1",
        "kind":"Info",
        "masterUrl": "${masterUrl}",
        "namespace": "test"
      }
    }&lt;/k8s:result&gt;
  &lt;/k8s:validate&gt;
&lt;/k8s:info&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="list-resources"><a class="anchor" href="#list-resources"></a><a class="link" href="#list-resources">36.19.2. List resources</a></h4>
<div class="paragraph">
<p>We can list Kubernetes resources such as pods, services, endpoints and replication controllers.
The list can be filtered by several properties such as</p>
</div>
<div class="ulist">
<ul>
<li>
<p>label</p>
</li>
<li>
<p>namespace</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The test action is able to define respective filters to the list, so we get only pods the match the given attributes:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void listPodsTest() {
    kubernetes()
        .client(k8sClient)
        .pods()
        .list()
        .label("app=todo")
        .validate("$..status.phase", "Running")
        .validate((pods, context) -&gt; {
            Assert.assertFalse(CollectionUtils.isEmpty(pods.getResult().getItems()));
        });
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;k8s:list-pods label="app=todo"&gt;
    &lt;k8s:validate&gt;
      &lt;k8s:result&gt;{
        "result": {
          "apiVersion":"${apiVersion}",
          "kind":"PodList",
          "metadata":"@ignore@",
          "items":"@ignore@"
        }
      }&lt;/k8s:result&gt;
      &lt;k8s:element path="$.result.items.size()" value="1"/&gt;
      &lt;k8s:element path="$..status.phase" value="Running"/&gt;
    &lt;/k8s:validate&gt;
&lt;/k8s:list-pods&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we are able to give the pod label that is searched for in list of all pods.
The list returned is validated either by giving an expected Json message or by adding JsonPath expressions with expected values to check.</p>
</div>
<div class="paragraph">
<p>In Java DSL we can add a validation result callback that is provided with the unmarshalled result object for validation. Besides <em>label</em> filtering we can also specify the <em>namespace</em>
and the pod <em>name</em> to search for.</p>
</div>
<div class="paragraph">
<p>You can also define multiple labels as comma delimited list:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void listServicesTest() {
    kubernetes()
        .client(k8sClient)
        .services()
        .list()
        .label("stage!=test,provider=fabric8")
        .namespace("default");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;k8s:list-services label="stage!=test,provider=fabric8" namespace="default"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we have combined to label filters <code>stage!=test</code> and <code>provider=fabric8</code> on pods in namespace <code>default</code>.
The first label filter is negated so the label <code>stage</code> should <strong>not</strong> be <code>test</code> here.</p>
</div>
</div>
<div class="sect3">
<h4 id="list-nodes-and-namespaces"><a class="anchor" href="#list-nodes-and-namespaces"></a><a class="link" href="#list-nodes-and-namespaces">36.19.3. List nodes and namespaces</a></h4>
<div class="paragraph">
<p>Nodes and namespaces are special resources that are not filtered by their namespace as they are more global resources. The rest is pretty similar to listing pods or services. We can
add filters such as <code>name</code> and <code>label</code>.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void listPodsTest() {
    kubernetes()
        .client(k8sClient)
        .namespaces()
        .list()
        .label("provider=citrus")
        .validate((pods, context) -&gt; {
            Assert.assertFalse(CollectionUtils.isEmpty(pods.getResult().getItems()));
        });
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;k8s:list-namespaces label="provider=citrus"&gt;
    &lt;k8s:validate&gt;
      &lt;k8s:element path="$.result.items.size()" value="1"/&gt;
    &lt;/k8s:validate&gt;
&lt;/k8s:list-namespaces&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="get-resources"><a class="anchor" href="#get-resources"></a><a class="link" href="#get-resources">36.19.4. Get resources</a></h4>
<div class="paragraph">
<p>We can get a very special Kubernetes resource such as a pod or service for detailed validation of that resource.
We need to specify a resource name in order to select the resource from list of available resources in Kubernetes.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void getPodsTest() {
    kubernetes()
        .client(k8sClient)
        .pods()
        .get("citrus_pod")
        .validate("$..status.phase", "Running")
        .validate((pod, context) -&gt; {
            Assert.assertEquals(pods.getResult().getStatus().getPhase(), "Running");
        });
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;k8s:get-pod name="citrus_pod"&gt;
    &lt;k8s:validate&gt;
      &lt;k8s:result&gt;{
      "result": {
        "apiVersion":"${apiVersion}",
        "kind":"Pod",
        "metadata": {
            "annotations":"@ignore@",
            "creationTimestamp":"@ignore@",
            "finalizers":[],
            "generateName":"@startsWith('hello-minikube-')@",
            "labels":{
              "pod-template-hash":"@ignore@",
              "run":"hello-minikube"
            },
            "name":"${podName}",
            "namespace":"default",
            "ownerReferences":"@ignore@",
            "resourceVersion":"@ignore@",
            "selfLink":"/api/${apiVersion}/namespaces/default/pods/${podName}",
            "uid":"@ignore@"
        },
        "spec": {
          "containers": [{
            "args":[],
            "command":[],
            "env":[],
            "image":"gcr.io/google_containers/echoserver:1.4",
            "imagePullPolicy":"IfNotPresent",
            "name":"hello-minikube",
            "ports":[{
              "containerPort":8080,
              "protocol":"TCP"
            }],
            "resources":{},
            "terminationMessagePath":"/dev/termination-log",
            "volumeMounts":"@ignore@"
          }],
          "dnsPolicy":"ClusterFirst",
          "imagePullSecrets":"@ignore@",
          "nodeName":"minikube",
          "restartPolicy":"Always",
          "securityContext":"@ignore@",
          "serviceAccount":"default",
          "serviceAccountName":"default",
          "terminationGracePeriodSeconds":30,
          "volumes":"@ignore@"
        },
        "status": "@ignore@"
      }
      }&lt;/k8s:result&gt;
      &lt;k8s:element path="$..status.phase" value="Running"/&gt;
    &lt;/k8s:validate&gt;
&lt;/k8s:get-pod&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we are able to get the complete pod information from Kubernetes.
The result is validated with Json message validator in Citrus.
This means we can use <em>@ignore@</em> as well as test variables and JsonPath expressions.</p>
</div>
</div>
<div class="sect3">
<h4 id="create-resources"><a class="anchor" href="#create-resources"></a><a class="link" href="#create-resources">36.19.5. Create resources</a></h4>
<div class="paragraph">
<p>We can create new Kubernetes resources within a Citrus test.
This is very important in case we need to set up new pods or services for the test run.
You can create new resources by giving a <code>.yaml</code> file holding all information how to create the new resource.
See the following sample YAML for a new pod and service:</p>
</div>
<div class="listingblock">
<div class="title">pod.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: Pod
apiVersion: v1
metadata:
  name: hello-netty-${randomId}
  namespace: default
  labels:
    server: hello-netty
spec:
  containers:
    - name: hello-netty
      image: netty
      imagePullPolicy: IfNotPresent
      ports:
        - containerPort: 8080
          protocol: TCP
  restartPolicy: Always
  terminationGracePeriodSeconds: 30
  dnsPolicy: ClusterFirst
  serviceAccountName: default
  serviceAccount: default
  nodeName: minikube</code></pre>
</div>
</div>
<div class="paragraph">
<p>This YAML file specifies a new resource of kind <em>Pod</em>.
We define the metadata as well as all containers that are part of this pod.
The container is build from <em>jetty:9.3</em> Docker image that should be pulled automatically from Docker Hub registry.
We also expose port 8080 as <em>containerPort</em> so the upcoming service configuration can provide this port to clients as Kubernetes service.</p>
</div>
<div class="listingblock">
<div class="title">service.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: Service
apiVersion: v1
metadata:
  name: hello-netty
  namespace: default
  labels:
    service: hello-netty
spec:
  ports:
    - protocol: TCP
      port: 8080
      targetPort: 8080
      nodePort: 31123
  selector:
    server: hello-netty
  type: NodePort
  sessionAffinity: None</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service resource maps the port <em>8080</em> and selects all pods with label <em>server=hello-netty</em>.
This makes the jetty container available to clients.
The service type is <em>NodePort</em> which means that clients outside of Kubernetes are also able to access the service by using the port <em>nodePort=31123</em>.
We can use Citrus functions such as <em>randomNumber</em> in the YAML files.</p>
</div>
<div class="paragraph">
<p>In the test case we can use these YAML files to create the resources in Kubernetes:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void createPodsTest() {
    kubernetes()
        .pods()
        .create(new ClassPathResource("templates/hello-netty-pod.yml"))
        .namespace("default");

    kubernetes()
        .services()
        .create(new ClassPathResource("templates/hello-service.yml"))
        .namespace("default");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="KubernetesIT"&gt;
  &lt;actions&gt;
    &lt;k8s:create-pod namespace="default"&gt;
      &lt;k8s:template file="classpath:templates/hello-netty-pod.yml"/&gt;
    &lt;/k8s:create-pod&gt;

    &lt;k8s:create-service namespace="default"&gt;
      &lt;k8s:template file="classpath:templates/hello-service.yml"/&gt;
    &lt;/k8s:create-service&gt;
  &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Creating new resources may take some time to finish.
Kubernetes will have to pull images, build containers and start up everything.
The <code>create</code> action is not waiting synchronously for all that to have happened.
Therefore, we might add a list-pods action that waits for the new resources to appear.</p>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;repeat-onerror-until-true condition="@assertThat(greaterThan(9))@" auto-sleep="1000"&gt;
  &lt;k8s:list-pods label="server=hello-netty"&gt;
    &lt;k8s:validate&gt;
      &lt;k8s:element path="$.result.items.size()" value="1"/&gt;
      &lt;k8s:element path="$..status.phase" value="Running"/&gt;
    &lt;/k8s:validate&gt;
  &lt;/k8s:list-pods&gt;
&lt;/repeat-onerror-until-true&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this repeat on error action we wait for the new <em>server=hello-netty</em> labeled pod to be in state <em>Running</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="delete-resources"><a class="anchor" href="#delete-resources"></a><a class="link" href="#delete-resources">36.19.6. Delete resources</a></h4>
<div class="paragraph">
<p>With that command we are able to delete a resource in Kubernetes.
Up to now deletion of pods and services is supported.
We have to give a name of the resource that we want to delete.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void deletePodsTest() {
    kubernetes()
        .pods()
        .delete("citrus_pod")
        .validate((result, context) -&gt; Assert.assertTrue(result.getResult().getSuccess()));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;k8s:delete-pod name="citrus_pod"&gt;
    &lt;k8s:validate&gt;
      &lt;k8s:element path="$.result.success" value="true"/&gt;
    &lt;/k8s:validate&gt;
&lt;/k8s:delete-pod&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="watch-resources"><a class="anchor" href="#watch-resources"></a><a class="link" href="#watch-resources">36.19.7. Watch resources</a></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The watch operation is still in experimental state and may face severe adjustments and improvements in near future.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When using a watch command we add a subscription to change events on a Kubernetes resources.
So we can watch resources such as pods, services for future changes.
Each change on that resource triggers a new watch event result that we can expect and validate.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void listPodsTest() {
    kubernetes()
        .pods()
        .watch()
        .label("provider=citrus")
        .validate((watchEvent, context) -&gt; {
            Assert.assertFalse(watchEvent.hasError());
            Assert.assertEquals(((WatchEventResult) watchEvent).getAction(), Watcher.Action.DELETED);
        });
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;k8s:watch-pods label="provider=citrus"&gt;
    &lt;k8s:validate&gt;
      &lt;k8s:element path="$.action" value="DELETED"/&gt;
    &lt;/k8s:validate&gt;
&lt;/k8s:watch-pods&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The watch command may be triggered several times for multiple changes on the respective Kubernetes resource.
The watch action will always handle one single event result.
The first event trigger is forwarded to the action validation.
All further watch events on that same resource are ignored.
This means that you may need multiple watch actions in your test case in case you expect multiple watch events to be triggered.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-command-bus"><a class="anchor" href="#kubernetes-command-bus"></a><a class="link" href="#kubernetes-command-bus">36.20. Kubernetes command bus</a></h3>
<div class="paragraph">
<p>We have seen how to access the Kubernetes remote REST API by using special Citrus test actions in a test.
As an alternative to that we can also use more generic send/receive actions in Citrus for accessing the Kubernetes API.</p>
</div>
<div class="paragraph">
<p>The next example shows this in action:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void kubernetesSendReceiveTest() {
    send(k8sClient)
        .message()
        .body("""
        { "command": "info" }
        """);

    receive(k8sClient)
        .message()
        .body("""
        {
          "command": "info",
          "result": {
            "clientVersion": "1.4.27",
            "apiVersion": "v1",
            "kind":"Info",
            "masterUrl": "${masterUrl}",
            "namespace": "test"
          }
        }
        """);

    send(k8sClient)
        .message()
        .body("""
        { "command": "list-pods" }
        """);

    receive(k8sClient)
        .message()
        .body("""
        {
          "command": "list-pods",
          "result": {
            "apiVersion":"v1",
            "kind":"PodList",
            "metadata":"@ignore@",
            "items":[]
          }
        }
        """)
        .validate(validate().json().expression("$.result.items.size()", 0));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="KubernetesSendReceiveIT"&gt;
    &lt;actions&gt;
      &lt;send endpoint="k8sClient"&gt;
        &lt;message&gt;
          &lt;data&gt;
            { "command": "info" }
          &lt;/data&gt;
        &lt;/message&gt;
      &lt;/send&gt;

      &lt;receive endpoint="k8sClient"&gt;
        &lt;message type="json"&gt;
          &lt;data&gt;
          {
            "command": "info",
            "result": {
                "clientVersion": "1.4.27",
                "apiVersion": "v1",
                "kind":"Info",
                "masterUrl": "${masterUrl}",
                "namespace": "test"
            }
          }
          &lt;/data&gt;
        &lt;/message&gt;
      &lt;/receive&gt;

      &lt;echo&gt;
        &lt;message&gt;List all pods&lt;/message&gt;
      &lt;/echo&gt;

      &lt;send endpoint="k8sClient"&gt;
        &lt;message&gt;
          &lt;data&gt;
            { "command": "list-pods" }
          &lt;/data&gt;
        &lt;/message&gt;
      &lt;/send&gt;

      &lt;receive endpoint="k8sClient"&gt;
        &lt;message type="json"&gt;
          &lt;data&gt;
          {
            "command": "list-pods",
            "result": {
                  "apiVersion":"v1",
                  "kind":"PodList",
                  "metadata":"@ignore@",
                  "items":[]
            }
          }
          &lt;/data&gt;
          &lt;validate path="$.result.items.size()" value="0"/&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
    &lt;/actions&gt;
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we can use the send/receive actions to call Kubernetes API commands and receive the respective results in Json format, too.
This gives us the well known Json validation mechanism in Citrus in order to validate the results from Kubernetes.
This way you can load Kubernetes resources verifying its state and properties.
Of course JsonPath expressions also come in here in order to validate Json elements explicitly.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="knative"><a class="anchor" href="#knative"></a><a class="link" href="#knative">37. Knative support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Knative lets you build Serverless and Event Driven applications on the cloud. The project knows the two main components Knative Serving and Knative Eventing.</p>
</div>
<div class="paragraph">
<p>Citrus as a test framework is able to interact with Knative to manage and leverage Serving and Eventing resources on a Kubernetes cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Knative support in Citrus is enabled by adding a separate Maven module as a dependency to your project
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-knative&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="knative-client"><a class="anchor" href="#knative-client"></a><a class="link" href="#knative-client">37.1. Knative client</a></h3>
<div class="paragraph">
<p>Citrus interacts with Knative resources on the Kubernetes cluster.
This means we need to connect as a client to a Kubernetes cluster as part of the test.
Citrus uses the Fabric8 Knative client implementation for this connection.
You can create and configure the client once and reuse the client instance in multiple test cases.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public KubernetesClient kubernetesClient() {
    return new KubernetesClientBuilder().build();
}

@BindToRegistry
public KnativeClient knativeClient() {
    return kubernetesClient().adapt(KnativeClient.class);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public KubernetesClient kubernetesClient() {
    return new KubernetesClientBuilder().build();
}

@Bean
public KnativeClient knativeClient() {
    return kubernetesClient().adapt(KnativeClient.class);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Fabric8 Knative client is based on the Kubernetes client implementation.
You can bind the client instances as beans to the Citrus bean registry.
You may then reference and inject the client to your tests using the <code>@CitrusResource</code> annotation.
Spring beans may be autowired to the test case as usual with <code>@Autowired</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="knative-broker"><a class="anchor" href="#knative-broker"></a><a class="link" href="#knative-broker">37.2. Knative broker</a></h3>
<div class="paragraph">
<p>Citrus is able to create Knative Eventing broker resources as part of the test.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void knativeBrokerTest() {
    given(knative()
            .client(knativeClient)
            .brokers()
            .create("my-broker")
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="KnativeBrokerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;knative client="knativeClient" namespace="test"&gt;
          &lt;create-broker name="my-broker"/&gt;
        &lt;/knative&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: KnativeBrokerTest
actions:
  - knative:
      client: "knativeClient"
      namespace: "test"
      createBroker:
        name: "my-broker"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test above creates a new Knative broker resource in the given namespace.
In the following you can connect to the broker to produce and consume events.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Citrus automatically removes the created Knative resources after the test. This is the default behavior that makes Citrus delete resources such as the Knative broker even when the test has finished in failure state. However, you can disable the auto removal by setting this system property or environment variable: <code>citrus.knative.auto.remove.resources=false</code> or <code>CITRUS_KNATIVE_AUTO_REMOVE_RESOURCES=false</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also disable the auto removal of the Knative broker on the test action, too:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void knativeBrokerTest() {
    given(knative()
            .client(knativeClient)
            .brokers()
            .create("my-broker")
            .autoRemoveResources(false)
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="knative-broker-verify"><a class="anchor" href="#knative-broker-verify"></a><a class="link" href="#knative-broker-verify">37.3. Verify broker status</a></h3>
<div class="paragraph">
<p>The test may also verify that a broker is running and ready on a given Kubernetes namespace.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void knativeBrokerTest() {
    given(knative()
            .client(knativeClient)
            .brokers()
            .verify("my-broker")
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="KnativeBrokerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;knative client="knativeClient" namespace="test"&gt;
          &lt;verify-broker name="my-broker"/&gt;
        &lt;/knative&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: KnativeBrokerTest
actions:
  - knative:
      client: "knativeClient"
      namespace: "test"
      verifyBroker:
        name: "my-broker"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="knative-send-event"><a class="anchor" href="#knative-send-event"></a><a class="link" href="#knative-send-event">37.4. Send events</a></h3>
<div class="paragraph">
<p>Once a Knative broker is available we can start to produce some events with a Citrus test.
Knative uses the CloudEvent data format out of the box.
The test is able to set the CloudEvent attributes as well as the event data when pushing the event to the broker.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void produceEventTest() {
    when(knative()
            .event()
            .send()
            .brokerUrl("http://my-cluster.svc.cluster.local/my-namespace/my-broker")
            .eventData("""
            { "message": "Hello Knative event!" }
            """));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ProduceEventTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;knative namespace="test"&gt;
          &lt;send-event broker="http://my-cluster.svc.cluster.local/my-namespace/my-broker"&gt;
            &lt;event&gt;
              &lt;data&gt;{ "message": "Hello Knative event!" }&lt;/data&gt;
            &lt;/event&gt;
          &lt;/send-event&gt;
        &lt;/knative&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ProduceEventTest
actions:
    - knative:
      namespace: "test"
      sendEvent:
        broker: "my-broker"
        event:
          data: |
            { "message": "Hello Knative event!" }</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This action produces a new Knative event with some CloudEvent attributes default values set.
The Http request to the Knative broker looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>POST http://my-cluster.svc.cluster.local/my-namespace/my-broker
Accept:text/plain, application/json, application/*+json, */*
Host:broker-ingress.knative-eventing.svc.cluster.local
Content-Type:application/json
Ce-Id:2818d613-bc75-4b25-b570-b825bbe33378
Ce-Type:org.citrusframework.event.test
Ce-Specversion:1.0
Ce-Source:citrus-test
Content-Length:54

{ "message": "Hello Knative event!" }</pre>
</div>
</div>
<div class="paragraph">
<p>You can see the CloudEvent attributes set with <code>Ce-*</code> headers.
You can customize these attributes on the send event test action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void produceEventTest() {
    when(knative()
            .event()
            .send()
            .brokerUrl("http://my-cluster.svc.cluster.local/my-namespace/my-broker")
            .attribute("ce-type", "org.citrusframework.knative.event")
            .eventData("""
            { "message": "Hello Knative event!" }
            """));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ProduceEventTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;knative namespace="test"&gt;
          &lt;send-event broker="http://my-cluster.svc.cluster.local/my-namespace/my-broker"&gt;
            &lt;event&gt;
              &lt;ce-attributes&gt;
                &lt;ce-attribute name="ce-type" value="org.citrusframework.knative.event"/&gt;
              &lt;/ce-attributes&gt;
              &lt;data&gt;{ "message": "Hello Knative event!" }&lt;/data&gt;
            &lt;/event&gt;
          &lt;/send-event&gt;
        &lt;/knative&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ProduceEventTest
actions:
    - knative:
      namespace: "test"
      sendEvent:
        broker: "my-broker"
        event:
          data: |
            { "message": "Hello Knative event!" }
          attributes:
            - name: ce-type
              value: "org.citrusframework.knative.event"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="knative-receive-event"><a class="anchor" href="#knative-receive-event"></a><a class="link" href="#knative-receive-event">37.5. Receive events</a></h3>
<div class="paragraph">
<p>The Knative broker dispatches events by invoking services.
Usually this service is an arbitrary Kubernetes Service resource or any addressable resource on the Kubernetes cluster.
The events that should be consumed by a service gets specified in a Knative Trigger resource.</p>
</div>
<div class="paragraph">
<p>This means we need to consume Knative events with a Kubernetes service resource.
Citrus provides special Kubernetes support that enables you to create a Kubernetes service resource on the cluster.
Read more about it in chapter <a href="#kubernetes">Kubernetes support</a>.</p>
</div>
<div class="paragraph">
<p>You can create the Kubernetes service as follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void createServiceTest() {
    given(kubernetes()
            .client(k8sClient)
            .service()
            .create("my-service")
            .portMapping(80, 8080)
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CreateServiceTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;kubernetes client="k8sClient" namespace="my-namespace"&gt;
          &lt;create-service name="my-service"&gt;
            &lt;ports&gt;
              &lt;port-mapping port="80" target-port="8080"/&gt;
            &lt;/ports&gt;
          &lt;/create-service&gt;
        &lt;/kubernetes&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: CreateServiceTest
actions:
  - kubernetes:
      client: "k8sClient"
      namespace: "my-namespace"
      createService:
        name: "my-service"
        ports:
          - port: "80"
            targetPort: "8080"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates the Kubernetes service named <code>my-service</code> in the namespace <code>my-namespace</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The test requires a local HttServer instance to actually receive the requests on the given port mapping.
Citrus automatically creates this local HttpServer instance.
Please make sure to choose a free port on your host machine when defining the port mapping.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Before creating the HttpServer instance as part of the Kubernetes test action Citrus tries to resolve the HttpServer instance from the Citrus bean registry. This means you can also predefine the HttpServer instance as a usual bean in the registry.
Just give the server name as an additional attribute to the Kubernetes service create test action so Citrus knows which server instance should be resolved via the bean registry.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This creates a proper Kubernetes service and binds it to the local port where the local HttpServer instance is listening for incoming requests.
Before we can start to actually consume events we need to create a Knative Trigger resource.
You can create the Trigger resource as part of the test, too:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void createTriggerTest() {
    given(knative()
            .client(knativeClient)
            .trigger()
            .create("my-trigger")
            .broker("my-broker")
            .service("my-service")
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CreateTriggerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;knative client="knativeClient" namespace="my-namespace"&gt;
        &lt;create-trigger name="my-trigger" broker="my-broker" service="my-service"/&gt;
      &lt;/knative&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: CreateTriggerTest
actions:
  - knative:
      client: "knativeClient"
      namespace: "my-namespace"
      createTrigger:
        name: "my-trigger"
        broker: "my-broker"
        service: "my-service"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Trigger resource receives the broker name that should be used as a source of events and the service name as a subject to being invoked when an event gets dispatched.
The trigger name and the namespace defines where the Trigger resource is created on the Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>You add a filter to the Trigger resource to filter events on CloudEvent attributes.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void createTriggerTest() {
    given(knative()
            .client(knativeClient)
            .trigger()
            .create("my-trigger")
            .broker("my-broker")
            .service("my-service")
            .filter("type", "my.very.specific.event.type")
            .inNamespace("my-namespace"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="CreateTriggerTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;knative client="knativeClient" namespace="my-namespace"&gt;
        &lt;create-trigger name="my-trigger" broker="my-broker" service="my-service"&gt;
          &lt;filter&gt;
            &lt;attribute name="type" value="my.very.specific.event.type"/&gt;
          &lt;/filter&gt;
        &lt;/create-trigger&gt;
      &lt;/knative&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: CreateTriggerTest
actions:
  - knative:
      client: "knativeClient"
      namespace: "my-namespace"
      createTrigger:
        name: "my-trigger"
        broker: "my-broker"
        service: "my-service"
        filter:
          attributes:
            - name: type
              value: "my.very.specific.event.type"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The filter is set on the CloudeEvent type attribute so the trigger will only dispatch events with this specific type.
The created Trigger resource looks like follows:</p>
</div>
<div class="listingblock">
<div class="title">Knative Trigger</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: eventing.knative.dev/v1
kind: Trigger
metadata:
  name: my-trigger
spec:
  broker: default
  filter:
    attributes:
      type: my.very.specific.event.type
  subscriber:
    ref:
      apiVersion: v1
      kind: Service
      name: my-service</code></pre>
</div>
</div>
<div class="paragraph">
<p>This completes all resources that we need to consume events from the Knative eventing broker.
The following test action receives and verifies a Knative event with an expected CloudEvent message holding expected attributes and event data.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void consumeEventTest() {
    when(knative()
            .event()
            .receive()
            .serviceName("my-service")
            .attribute("ce-type", "org.citrusframework.knative.event")
            .eventData("""
            {
                "message": "Hello Knative event!"
            }
            """));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ConsumeEventTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;knative namespace="my-namespace"&gt;
          &lt;receive-event service="my-service"&gt;
            &lt;event&gt;
              &lt;ce-attributes&gt;
                &lt;ce-attribute name="ce-type" value="org.citrusframework.knative.event"/&gt;
              &lt;/ce-attributes&gt;
              &lt;data&gt;{ "message": "Hello Knative event!" }&lt;/data&gt;
            &lt;/event&gt;
          &lt;/receive-event&gt;
        &lt;/knative&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ConsumeEventTest
actions:
    - knative:
      namespace: "my-namespace"
      receiveEvent:
        service: "my-service"
        event:
          data: |
            { "message": "Hello Knative event!" }
          attributes:
            - name: ce-type
              value: "org.citrusframework.knative.event"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="knative-channels"><a class="anchor" href="#knative-channels"></a><a class="link" href="#knative-channels">37.6. Knative channels</a></h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect2">
<h3 id="knative-subscription"><a class="anchor" href="#knative-subscription"></a><a class="link" href="#knative-subscription">37.7. Knative subscription</a></h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testcontainers"><a class="anchor" href="#testcontainers"></a><a class="link" href="#testcontainers">38. Testcontainers support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://testcontainers.com/">Testcontainers</a> leverage Docker containers in your tests to provide lightweight infrastructure instances such
as databases, message brokers and web browsers. Anything that you can run in a Docker container is subject to be managed by Testcontainers in your test. Citrus as a framework is able to start/stop your Testcontainers instances as part of the test.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Testcontainers support is enabled by adding a separate Maven module as a project dependency
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-testcontainers&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="testcontainers-action"><a class="anchor" href="#testcontainers-action"></a><a class="link" href="#testcontainers-action">38.1. Start and stop Testcontainers</a></h3>
<div class="paragraph">
<p>The Testcontainers test action runs a container and exposes its connection settings as test variables.
You can start any Docker container image as a Testcontainers instance.
The Testcontainers project provides many modules that represent different test infrastructure technologies.</p>
</div>
<div class="paragraph">
<p>Each of those modules can be started in Citrus with a special test action:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void testcontainersTest() {
    given(testcontainers()
            .start()
            .image("busybox:latest")
            .containerName("busybox-container")
            .withCommand("echo", "Hello", "World")
            .withLabel("app", "citrus"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="TestcontainersTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;testcontainers&gt;
          &lt;start&gt;
            &lt;container name="busybox-container" image="busybox:latest" command="echo Hello World"&gt;
              &lt;labels&gt;
                &lt;label name="app" value="citrus"/&gt;
              &lt;/labels&gt;
            &lt;/container&gt;
          &lt;/start&gt;
        &lt;/testcontainers&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: TestcontainersTest
actions:
  - testcontainers:
      start:
        container:
          name: "busybox-container"
          image: "busybox:latest"
          command: "echo Hello World"
          labels:
            - name: app
              value: citrus</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the test example uses the Docker image name <code>busybox:latest</code> to start the Testcontainer instance.
You can set labels, annotations as well as the command that is run as entry point when starting the container.</p>
</div>
<div class="paragraph">
<p>You can also leverage the Testcontainers API to specify the container details:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void testcontainersTest() {
    GenericContainer&lt;?&gt; busyBox = new GenericContainer("busybox:latest")
                .withCommand("echo", "Hello World");

    given(testcontainers()
            .start()
            .container("my-container", busyBox));
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The Citrus test automatically exposes connection details of the running Testcontainers instance.
The connection settings get exposed in the form of test variables.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>These are the test variables that get exposed representing connection settings for the Testcontainers instance.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variable</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_&lt;CONTAINER_NAME&gt;_HOST</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_&lt;CONTAINER_NAME&gt;_PORT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_&lt;CONTAINER_NAME&gt;_CONTAINER_IP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_&lt;CONTAINER_NAME&gt;_CONTAINER_ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_&lt;CONTAINER_NAME&gt;_CONTAINER_NAME</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can use these test variables in the test to access the details of the running Testcontainers instance.
Special containers may expose additional connection settings such as user credentials, endpoint URLs, managed ports and so on.
Read about this in the individual supported Testcontainers module sections that follow in this guide.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Each Testcontainers instance that is started from Citrus is automatically removed after the test. This is the default behavior. However, you can disable the auto removal by setting this system property or environment variable: <code>citrus.testcontainers.auto.remove.resources=false</code> or <code>CITRUS_TESTCONTAINERS_AUTO_REMOVE_RESOURCES=false</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also disable the auto removal of the started Testcontainers started by Citrus:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void testcontainersTest() {
    GenericContainer&lt;?&gt; busyBox = new GenericContainer("busybox:latest")
                .withCommand("echo", "Hello World");

    given(testcontainers()
            .start()
            .autoRemove(false)
            .container("my-container", busyBox));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This keeps the started Testcontainers instance running even after the test has finished.
When the whole test suite is finished the Testcontainers library may automatically stop and remove the container.</p>
</div>
<div class="paragraph">
<p>You can explicitly stop a running Testcontainers instance by its name with this test action:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void testcontainersTest() {
    given(testcontainers()
            .stop()
            .containerName("busybox-container"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="TestcontainersTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;testcontainers&gt;
          &lt;stop name="busybox-container"/&gt;
        &lt;/testcontainers&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: TestcontainersTest
actions:
  - testcontainers:
      stop:
        name: "busybox-container"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is how you can manage any Docker image as a Testcontainers instance.
Citrus also provides special support for test infrastructure Testcontainers modules such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>PostgreSQL</p>
</li>
<li>
<p>MongoDB</p>
</li>
<li>
<p>LocalStack</p>
</li>
<li>
<p>Kafka</p>
</li>
<li>
<p>Redpanda</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following sections deal with these special Testcontainers modules.</p>
</div>
</div>
<div class="sect2">
<h3 id="testcontainers-postgresql"><a class="anchor" href="#testcontainers-postgresql"></a><a class="link" href="#testcontainers-postgresql">38.2. PostgreSQL</a></h3>
<div class="paragraph">
<p>You can start a PostgreSQL instance with the following test action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void testcontainersTest() {
    given(testcontainers()
            .postgreSQL()
            .start()
            .initScript(Resources.create("db.init.sql")));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="TestcontainersTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;testcontainers&gt;
          &lt;start&gt;
            &lt;postgresql&gt;
              &lt;init-script file="classpath:db.init.sql"/&gt;
            &lt;/postgresql&gt;
          &lt;/start&gt;
        &lt;/testcontainers&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: TestcontainersTest
actions:
  - testcontainers:
      start:
        postgresql:
          initScript:
            file: "db.init.sql"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the test example the PostgreSQL Testcontainers module is started.
The given init script is used to initialize the database on startup.</p>
</div>
<div class="paragraph">
<p>Citrus exposes special test variables that represent connection settings for the PostgreSQL container:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variable</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_POSTGRESQL_HOST</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_POSTGRESQL_CONTAINER_IP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_POSTGRESQL_CONTAINER_ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_POSTGRESQL_CONTAINER_NAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_POSTGRESQL_SERVICE_PORT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_POSTGRESQL_PORT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_POSTGRESQL_LOCAL_URL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_POSTGRESQL_SERVICE_LOCAL_URL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_POSTGRESQL_SERVICE_NAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_POSTGRESQL_SERVICE_URL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_POSTGRESQL_URL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_POSTGRESQL_DRIVER</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_POSTGRESQL_DB_NAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_POSTGRESQL_USERNAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_POSTGRESQL_PASSWORD</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In addition to that the Citrus test action exposes a DataSource that connects to the PostgreSQL database and binds it as abean to the Citrus registry.
This means that you can resolve the data source bean via the test context reference resolver.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can set the name of the exposed data source bean on each Citrus Testcontainers test action for PostgreSQL.
By default, Citrus exposed the data source bean with the name <code>postgreSQL</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="testcontainers-mongodb"><a class="anchor" href="#testcontainers-mongodb"></a><a class="link" href="#testcontainers-mongodb">38.3. MongoDB</a></h3>
<div class="paragraph">
<p>You can start a MongoDB instance with the following test action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void testcontainersTest() {
    given(testcontainers()
            .mongodb()
            .start());
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="TestcontainersTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;testcontainers&gt;
          &lt;start&gt;
            &lt;mongodb/&gt;
          &lt;/start&gt;
        &lt;/testcontainers&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: TestcontainersTest
actions:
  - testcontainers:
      start:
        mongodb: {}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the test example the MongoDB Testcontainers module is started.
Citrus exposes special test variables that represent connection settings for the MongoDB container:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variable</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_MONGODB_HOST</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_MONGODB_CONTAINER_IP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_MONGODB_CONTAINER_ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_MONGODB_CONTAINER_NAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_MONGODB_LOCAL_URL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_MONGODB_SERVICE_PORT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_MONGODB_PORT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_MONGODB_SERVICE_LOCAL_URL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_MONGODB_SERVICE_NAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_MONGODB_SERVICE_URL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_MONGODB_URL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_MONGODB_CONNECTION_STRING</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can use these test variables to connect to the MongoDB Testcontainers instance.</p>
</div>
</div>
<div class="sect2">
<h3 id="testcontainers-localstack"><a class="anchor" href="#testcontainers-localstack"></a><a class="link" href="#testcontainers-localstack">38.4. LocalStack</a></h3>
<div class="paragraph">
<p>The LocalStack Testcontainers module allows you to start lightweight Amazon WebServices such as AWS S3, AWS SQS, AWS SNS or AWS Kinesis.
You can start a LocslStack instance with the following test action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void testcontainersTest() {
    given(testcontainers()
            .localstack()
            .start()
            .withService(LocalStackContainer.Service.S3));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="TestcontainersTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;testcontainers&gt;
          &lt;start&gt;
            &lt;localstack services="S3"/&gt;
          &lt;/start&gt;
        &lt;/testcontainers&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: TestcontainersTest
actions:
  - testcontainers:
      start:
        localstack:
          services:
            - "S3"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each LocalStack instance receives a list of services that should be enabled.
In the example above the AWS S3 service is enabled.</p>
</div>
<div class="sect3">
<h4 id="testcontainers-localstack-settings"><a class="anchor" href="#testcontainers-localstack-settings"></a><a class="link" href="#testcontainers-localstack-settings">38.4.1. Exposed connection settings</a></h4>
<div class="paragraph">
<p>Citrus exposes special test variables that represent connection settings for the LocalStack container:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variable</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_LOCALSTACK_HOST</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_LOCALSTACK_CONTAINER_IP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_LOCALSTACK_CONTAINER_ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_LOCALSTACK_CONTAINER_NAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_LOCALSTACK_REGION</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_LOCALSTACK_ACCESS_KEY</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_LOCALSTACK_SECRET_KEY</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_LOCALSTACK_SERVICE_PORT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_LOCALSTACK_SERVICE_LOCAL_URL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_LOCALSTACK_SERVICE_NAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_LOCALSTACK_SERVICE_URL</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For each enabled service on the LocalStack instance these variables are exposed:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variable</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_LOCALSTACK_&lt;SERVICE_NAME&gt;_URL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_LOCALSTACK_&lt;SERVICE_NAME&gt;_LOCAL_URL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_LOCALSTACK_&lt;SERVICE_NAME&gt;_PORT</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="testcontainers-localstack-auto-clients"><a class="anchor" href="#testcontainers-localstack-auto-clients"></a><a class="link" href="#testcontainers-localstack-auto-clients">38.4.2. Service client auto creation</a></h4>
<div class="paragraph">
<p>The Citrus LocalStack container action is able to automatically create clients for the enabled services.</p>
</div>
<div class="paragraph">
<p>By default, Citrus creates the client instances and stores them in the bean Citrus registry. You can then reference the clients by their name.</p>
</div>
<div class="paragraph">
<p>The following services support auto creation of clients:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>S3 ("s3Client")</p>
</li>
<li>
<p>SNS ("snsClient")</p>
</li>
<li>
<p>SQS ("sqsClient")</p>
</li>
<li>
<p>KINESIS (kinesisClient)</p>
</li>
<li>
<p>DYNAMODB (dnyamodbClient)</p>
</li>
<li>
<p>EVENT_BRIDGE("eventbridgeClient")</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For instance the S3 service creates a client instance called <code>s3Client</code>. The clients are automatically configured with the container service settings such as endpointUri, accessKey, secretKey and region for S3.</p>
</div>
<div class="paragraph">
<p>The underlying client factory is able to handle specific options. For the S3 client factory for instance this is a comma separated list of bucket names to auto create S3 buckets.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void testcontainersTest() {
    given(testcontainers()
            .localstack()
            .start()
            .withService(LocalStackContainer.Service.S3))
            .withOption("buckets", "my_bucket_name,another_bucket_name");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="TestcontainersTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;testcontainers&gt;
          &lt;start&gt;
            &lt;localstack services="S3"&gt;
              &lt;options&gt;
                &lt;option name="buckets" value="my_bucket_name,another_bucket_name"/&gt;
              &lt;/options&gt;
            &lt;/localstack&gt;
          &lt;/start&gt;
        &lt;/testcontainers&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: TestcontainersTest
actions:
  - testcontainers:
      start:
        localstack:
          services:
            - "S3"
          options:
            buckets: "my_bucket_name,another_bucket_name"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please see this list of supported options on the individual client factories:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Client</th>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">s3Client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">buckets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comma separated list of bucket names that get auto created</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sqsClient</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">queues</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comma separated list of queue names that get auto created</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">snsClient</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">topics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comma separated list of topic names that get auto created</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">kinesisClient</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">streams</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comma separated list of stream names that get auto created</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">kinesisClient</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;stream_name&gt;.shard.count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shard count set on the given stream</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dynamodbClient</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tables</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comma separated list of table names that get auto created.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dynamodbClient</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;table_name&gt;.id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Id attribute name set on the table as a primary id.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dynamodbClient</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;table_name&gt;.view.type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">View type set on the table stream specification (default=NEW_AND_OLD_IMAGES).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dynamodbClient</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;table_name&gt;.read.capacity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read capacity set as provisioned throughput (default=1).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dynamodbClient</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;table_name&gt;.write.capacity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write capacity set as provisioned throughput (default=1).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">eventbridgeClient</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">eventBusNames</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comma separated list of event bus names that get auto created</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="testcontainers-localstack-clients"><a class="anchor" href="#testcontainers-localstack-clients"></a><a class="link" href="#testcontainers-localstack-clients">38.4.3. Custom service clients</a></h4>
<div class="paragraph">
<p>You can use the exposed connections settings in the test variables to connect to the LocalStack Testcontainers instance.</p>
</div>
<div class="paragraph">
<p>As an example this S3 client connects to the LocalStack Testcontainers instance and creates a test bucket:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private S3Client createS3Client(TestContext context) {
    S3Client s3 = S3Client
            .builder()
            .endpointOverride(URI.create(context.getVariable("${CITRUS_TESTCONTAINERS_LOCALSTACK_S3_URL}")))
            .credentialsProvider(StaticCredentialsProvider.create(
                    AwsBasicCredentials.create(
                            context.getVariable("${CITRUS_TESTCONTAINERS_LOCALSTACK_ACCESS_KEY}"),
                            context.getVariable("${CITRUS_TESTCONTAINERS_LOCALSTACK_SECRET_KEY}"))
            ))
            .forcePathStyle(true)
            .region(Region.of(context.getVariable("${CITRUS_TESTCONTAINERS_LOCALSTACK_REGION}")))
            .build();

    s3.createBucket(b -&gt; b.bucket(context.getVariable("${aws.s3.bucketNameOrArn}")));

    return s3;
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can access the Citrus TesContext via <code>@CitrusResource</code> injection in your test class or method.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="testcontainers-kafka"><a class="anchor" href="#testcontainers-kafka"></a><a class="link" href="#testcontainers-kafka">38.5. Kafka</a></h3>
<div class="paragraph">
<p>You can start a Kafka instance with the following test action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void testcontainersTest() {
    given(testcontainers()
            .kafka()
            .start());
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="TestcontainersTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;testcontainers&gt;
          &lt;start&gt;
            &lt;kafka/&gt;
          &lt;/start&gt;
        &lt;/testcontainers&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: TestcontainersTest
actions:
  - testcontainers:
      start:
        kafka: {}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the test example the Kafka Testcontainers module is started.
Citrus exposes special test variables that represent connection settings for the Kafka container:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variable</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_KAFKA_HOST</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_KAFKA_CONTAINER_IP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_KAFKA_CONTAINER_ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_KAFKA_CONTAINER_NAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_KAFKA_LOCAL_BOOTSTRAP_SERVERS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_KAFKA_SERVICE_PORT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_KAFKA_PORT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_KAFKA_SERVICE_LOCAL_BOOTSTRAP_SERVERS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_KAFKA_SERVICE_NAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_KAFKA_SERVICE_BOOTSTRAP_SERVERS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_KAFKA_BOOTSTRAP_SERVERS</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can use these test variables to connect to the Kafka Testcontainers instance.</p>
</div>
</div>
<div class="sect2">
<h3 id="testcontainers-redpanda"><a class="anchor" href="#testcontainers-redpanda"></a><a class="link" href="#testcontainers-redpanda">38.6. Redpanda</a></h3>
<div class="paragraph">
<p>You can start a Redpanda instance with the following test action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void testcontainersTest() {
    given(testcontainers()
            .redpanda()
            .start());
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="TestcontainersTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;testcontainers&gt;
          &lt;start&gt;
            &lt;redpanda/&gt;
          &lt;/start&gt;
        &lt;/testcontainers&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: TestcontainersTest
actions:
  - testcontainers:
      start:
        redpanda: {}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the test example the Redpanda Testcontainers module is started.
Citrus exposes special test variables that represent connection settings for the Redpanda container:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variable</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_REDPANDA_HOST</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_REDPANDA_CONTAINER_IP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_REDPANDA_CONTAINER_ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_REDPANDA_CONTAINER_NAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_REDPANDA_LOCAL_BOOTSTRAP_SERVERS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_REDPANDA_SERVICE_PORT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_REDPANDA_PORT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_REDPANDA_SERVICE_LOCAL_BOOTSTRAP_SERVERS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_REDPANDA_SERVICE_NAME</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_REDPANDA_SERVICE_BOOTSTRAP_SERVERS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TESTCONTAINERS_REDPANDA_BOOTSTRAP_SERVERS</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can use these test variables to connect to the Redpanda Testcontainers instance.</p>
</div>
</div>
<div class="sect2">
<h3 id="testcontainers-compose"><a class="anchor" href="#testcontainers-compose"></a><a class="link" href="#testcontainers-compose">38.7. Docker compose</a></h3>
<div class="paragraph">
<p>The Testcontainers project provides the opportunity to interact with Docker compose.
In Citrus you can start a Docker compose specification (<code>compose.yaml</code>) as part of the test.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
By default, the Testcontainers compose container uses your local Docker compose executable binary. This means you need to have Docker compose installed on your machine. You can verify the installation with (<code>docker compose version</code>).
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If for some reason you are not able to install Docker compose you may also disable the <code>useComposeBinary</code> setting in Citrus (e.g. via System property or environment variable). The Testcontainers library will then use arbitrary Docker containers in combination with an ambassador container that stars and manages the services defined in the Docker compose specification.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A Docker compose specification may look like this:</p>
</div>
<div class="listingblock">
<div class="title">compose.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">services:
  web:
    image: nginx:latest
    ports:
      - '8080:80'
    volumes:
      - ./html:/usr/share/nginx/html:ro</code></pre>
</div>
</div>
<div class="paragraph">
<p>The specification defines one or more services that are started as part of the <code>compose up</code> command:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void composeTest() {
    given(testcontainers()
            .compose()
            .up()
            .file("compose.yaml"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ComposeTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;testcontainers&gt;
          &lt;compose&gt;
            &lt;up file="compose.yaml"/&gt;
          &lt;/compose&gt;
        &lt;/testcontainers&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ComposeTest
actions:
  - testcontainers:
      compose:
        up:
          file: "compose.yaml"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Docker containers started with Docker compose will be automatically stopped and removed after the test.
You can change this behavior by setting one of the System property or environment variable settings: <code>citrus.testcontainers.compose.auto.remove.resources=false</code> or <code>CITRUS_TESTCONTAINERS_COMPOSE_AUTO_REMOVE_RESOURCES=false</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You may explicitly stop all Docker containers with the <code>compose down</code> command:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void composeTest() {
    given(testcontainers()
            .compose()
            .down());
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ComposeTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;testcontainers&gt;
          &lt;compose&gt;
            &lt;down/&gt;
          &lt;/compose&gt;
        &lt;/testcontainers&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ComposeTest
actions:
  - testcontainers:
      compose:
        down: {}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- NOT SUPPORTED --&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <code>compose down</code> test action searches for a single Testcontainers compose container that has been started before.
In case you are operating with multiple <code>compose up</code> commands in a test you may identify each of those compose containers with a unique name and reference this name in the <code>compose down</code> test action.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="functions"><a class="anchor" href="#functions"></a><a class="link" href="#functions">39. Functions</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The test framework will offer several functions that are useful throughout the test execution. The functions will always return a string value that is ready for use as variable value or directly inside a text message.</p>
</div>
<div class="paragraph">
<p>A set of functions is usually combined to a function library. The library has a prefix that will identify the functions inside the test case. The default test framework function library uses a default prefix (citrus). You can write your own function library using your own prefix in order to extend the test framework functionality whenever you want.</p>
</div>
<div class="paragraph">
<p>The library is built in the Spring configuration and contains a set of functions that are of public use.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public FunctionLibrary testFunctionLibrary() {
    FunctionLibrary library = new FunctionLibrary();
    library.setName("test");
    library.setPrefix("foo:");
    library.getMembers().put("randomNumber", new RandomNumberFunction());
    library.getMembers().put("randomString", new RandomStringFunction());
    library.getMembers().put("customFunction", customFunctionBean());
    return library;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public FunctionLibrary testFunctionLibrary() {
    FunctionLibrary library = new FunctionLibrary();
    library.setName("test");
    library.setPrefix("foo:");
    library.getMembers().put("randomNumber", new RandomNumberFunction());
    library.getMembers().put("randomString", new RandomStringFunction());
    library.getMembers().put("customFunction", customFunctionBean());
    return library;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd"&gt;

    &lt;citrus:function-library id="testFunctionLibrary" prefix="foo:"&gt;
              &lt;citrus:function name="randomNumber" class="org.citrusframework.functions.RandomNumberFunction"/&gt;
              &lt;citrus:function name="randomString" class="org.citrusframework.functions.RandomStringFunction"/&gt;
              &lt;citrus:function name="customFunction" ref="customFunctionBean"/&gt;
              ...
    &lt;/citrus:function-library&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the library defines one-to-many functions either referenced as normal Spring bean or by its implementing Java class name. Citrus constructs the library, and you are able to use the functions in your test case with the leading library prefix just like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">foo:randomNumber()
foo:randomString()
foo:customFunction()</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can add custom function implementations and custom function libraries. Just use a custom prefix for your library. The default Citrus function library uses the <strong>citrus:</strong> prefix.In the next chapters the default functions offered by the framework will be described in detail.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="functions-concat"><a class="anchor" href="#functions-concat"></a><a class="link" href="#functions-concat">39.1. concat()</a></h3>
<div class="paragraph">
<p>The function will combine several string tokens to a single string value. This means that you can combine a static text value with a variable value for instance. A first example should clarify the usage:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void concatFunctionTest() {
    variable("date", "citrus:currentDate(yyyy-MM-dd)");
    variable("text", "Hello Test Framework!");

    then(echo().message("citrus:concat('Today is: ', ${date}, ' right!?')"));
    then(echo().message("citrus:concat('Text is: ', ${text})"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="ConcatFunctionTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
  &lt;variables&gt;
    &lt;variable name="date" value="citrus:currentDate(yyyy-MM-dd)" /&gt;
    &lt;variable name="text" value="Hello Test Framework!" /&gt;
  &lt;/variables&gt;
  &lt;actions&gt;
    &lt;echo&gt;
      &lt;message&gt;
        citrus:concat('Today is: ', ${date}, ' right!?')
      &lt;/message&gt;
    &lt;/echo&gt;
    &lt;echo&gt;
      &lt;message&gt;
        citrus:concat('Text is: ', ${text})
      &lt;/message&gt;
    &lt;/echo&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: ConcatFunctionTest
variables:
  - name: date
    value: "citrus:currentDate(yyyy-MM-dd)"
  - name: text
    value: "Hello Test Framework!"
actions:
  - echo:
      message: "citrus:concat('Today is: ', ${date}, ' right!?')"
  - echo:
      message: "citrus:concat('Text is: ', ${text})"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;

    &lt;testcase name="concatFunctionTest"&gt;
        &lt;variables&gt;
            &lt;variable name="date" value="citrus:currentDate(yyyy-MM-dd)" /&gt;
            &lt;variable name="text" value="Hello Test Framework!" /&gt;
        &lt;/variables&gt;
        &lt;actions&gt;
            &lt;echo&gt;
                &lt;message&gt;
                    citrus:concat('Today is: ', ${date}, ' right!?')
                &lt;/message&gt;
            &lt;/echo&gt;
            &lt;echo&gt;
                &lt;message&gt;
                    citrus:concat('Text is: ', ${text})
                &lt;/message&gt;
            &lt;/echo&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please do not forget to mark static text with single quote signs. There is no limitation for string tokens to be combined.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">citrus:concat('Text1', 'Text2', 'Text3', ${text}, 'Text5', …, 'TextN')</code></pre>
</div>
</div>
<div class="paragraph">
<p>The function can be used wherever variables can be used. For instance when validating XML elements via XPath expressions in a <code>receive</code> test action.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void functionsTest() {
    when(receive()
        .endpoint(someEndpoint)
        .validate(validate().xpath()
                    .expression("//element/element", "citrus:concat('Cx1x', ${generatedId})"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="FunctionsTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
  &lt;actions&gt;
    &lt;receive endpoint="someEndpoint"&gt;
      &lt;validate path="//element/element" value="citrus:concat('Cx1x', ${generatedId})"/&gt;
    &lt;/receive&gt;
  &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: FunctionsTest
actions:
  - receive:
      endpoint: "soapClient"
      message:
        body:
          data: {}
        expression:
          - path: "//element/element"
            value: "citrus:concat('Cx1x', ${generatedId})"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans.xsd
              http://www.citrusframework.org/schema/testcase
              http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;

  &lt;testcase name="functionsTest"&gt;
    &lt;actions&gt;
      &lt;receive endpoint="someEndpoint"&gt;
        &lt;message&gt;
            &lt;validate path="//element/element" value="citrus:concat('Cx1x', ${generatedId})"/&gt;
        &lt;/message&gt;
      &lt;/receive&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="functions-substring"><a class="anchor" href="#functions-substring"></a><a class="link" href="#functions-substring">39.2. substring()</a></h3>
<div class="paragraph">
<p>The function will have three parameters.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>String to work on</p>
</li>
<li>
<p>Starting index</p>
</li>
<li>
<p>End index (optional)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let us have a look at a simple example for this function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;
        citrus:substring('Hello Test Framework', 6)
    &lt;/message&gt;
&lt;/echo&gt;
&lt;echo&gt;
    &lt;message&gt;
        citrus:substring('Hello Test Framework', 0, 5)
    &lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Function output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Test Framework
Hello</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="functions-stringlength"><a class="anchor" href="#functions-stringlength"></a><a class="link" href="#functions-stringlength">39.3. stringLength()</a></h3>
<div class="paragraph">
<p>The function will calculate the number of characters in a string representation and return the number.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;citrus:stringLength('Hello Test Framework')&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Function output:</p>
</div>
<div class="paragraph">
<p><strong>20</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-translate"><a class="anchor" href="#functions-translate"></a><a class="link" href="#functions-translate">39.4. translate()</a></h3>
<div class="paragraph">
<p>This function will replace regular expression matching values inside a string representation with a specified replacement string.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;
        citrus:translate('H.llo Test Fr.mework', '\.', 'a')
    &lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the second parameter will be a regular expression. The third parameter will be a simple replacement string value.</p>
</div>
<div class="paragraph">
<p>Function output:</p>
</div>
<div class="paragraph">
<p><strong>Hello Test Framework</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-substring-before"><a class="anchor" href="#functions-substring-before"></a><a class="link" href="#functions-substring-before">39.5. substringBefore()</a></h3>
<div class="paragraph">
<p>The function will search for the first occurrence of a specified string and will return the substring before that occurrence. Let us have a closer look in a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;
        citrus:substringBefore('Test/Framework', '/')
    &lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the specific example the function will search for the ‘/’ character and return the string before that index.</p>
</div>
<div class="paragraph">
<p>Function output:</p>
</div>
<div class="paragraph">
<p><strong>Test</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-substring-after"><a class="anchor" href="#functions-substring-after"></a><a class="link" href="#functions-substring-after">39.6. substringAfter()</a></h3>
<div class="paragraph">
<p>The function will search for the first occurrence of a specified string and will return the substring after that occurrence. Let us clarify this with a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;
        citrus:substringAfter('Test/Framework', '/')
    &lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar to the substringBefore function the ‘/’ character is found in the string. But now the remaining string is returned by the function meaning the substring after this character index.</p>
</div>
<div class="paragraph">
<p>Function output:</p>
</div>
<div class="paragraph">
<p><strong>Framework</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-round"><a class="anchor" href="#functions-round"></a><a class="link" href="#functions-round">39.7. round()</a></h3>
<div class="paragraph">
<p>This is a simple mathematical function that will round decimal numbers representations to their nearest non-decimal number.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;citrus:round('3.14')&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Function output:</p>
</div>
<div class="paragraph">
<p><strong>3</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-floor"><a class="anchor" href="#functions-floor"></a><a class="link" href="#functions-floor">39.8. floor()</a></h3>
<div class="paragraph">
<p>This function will round down decimal number values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;citrus:floor('3.14')&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Function output:</p>
</div>
<div class="paragraph">
<p><strong>3.0</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-ceiling"><a class="anchor" href="#functions-ceiling"></a><a class="link" href="#functions-ceiling">39.9. ceiling()</a></h3>
<div class="paragraph">
<p>Similar to floor function, but now the function will round up the decimal number values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;citrus:ceiling('3.14')&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Function output:</p>
</div>
<div class="paragraph">
<p><strong>4.0</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-random-number"><a class="anchor" href="#functions-random-number"></a><a class="link" href="#functions-random-number">39.10. randomNumber()</a></h3>
<div class="paragraph">
<p>The random number function will provide you the opportunity to generate random number strings containing positive number letters. There is a singular Boolean parameter for that function describing whether the generated number should have exactly the amount of digits. Default value for this padding flag will be true.</p>
</div>
<div class="paragraph">
<p>Next example will show the function usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variables&gt;
    &lt;variable name="rndNumber1" value="citrus:randomNumber(10)"/&gt;
    &lt;variable name="rndNumber2" value="citrus:randomNumber(10, true)"/&gt;
    &lt;variable name="rndNumber2" value="citrus:randomNumber(10, false)"/&gt;
    &lt;variable name="rndNumber3" value="citrus:randomNumber(3, false)"/&gt;
&lt;/variables&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Function output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">8954638765
5003485980
6387650
65</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="function-random-number-generator"><a class="anchor" href="#function-random-number-generator"></a><a class="link" href="#function-random-number-generator">39.11. randomNumberGenerator()</a></h3>
<div class="paragraph">
<p>This function is the big brother of randomNumber it generates a random numeric value with customizable decimal precision and range.
It provides options to control the minimum and maximum values, inclusivity, and numerical multiples of the generated number.</p>
</div>
<div class="paragraph">
<p>The function accepts up to six parameters, which influence the generated number:</p>
</div>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Decimal places (optional, default: 0)</p>
<div class="ulist">
<ul>
<li>
<p>Defines the number of decimal places in the generated number.</p>
</li>
<li>
<p>A value of 0 results in an integer output.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Minimum value (optional, default: -1,000,000)</p>
<div class="ulist">
<ul>
<li>
<p>The lower bound for the generated number.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Maximum value (optional, default: 1,000,000)</p>
<div class="ulist">
<ul>
<li>
<p>The upper bound for the generated number.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Exclude minimum (optional, default: false)</p>
<div class="ulist">
<ul>
<li>
<p>If true, the generated number will never be exactly the minimum value.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Exclude maximum (optional, default: false)</p>
<div class="ulist">
<ul>
<li>
<p>If true, the generated number will never be exactly the maximum value.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Multiple of (optional)</p>
<div class="ulist">
<ul>
<li>
<p>If provided, the generated number will be a multiple of this value.</p>
</li>
<li>
<p>If no valid multiple exists within the given range, the function may return Infinity.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Format pattern (optional)</p>
<div class="ulist">
<ul>
<li>
<p>If no pattern is specified a plain string representation of the number will be returned.</p>
</li>
<li>
<p>e.g. "<mark>,<mark></mark>.000", "<mark>.000", "</mark>.</mark>#E0"</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">XML Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variables&gt;
    &lt;variable name="rndNum1" value="${citrus:randomNumberGenerator()}"/&gt;
    &lt;variable name="rndNum2" value="${citrus:randomNumberGenerator(2)}"/&gt;
    &lt;variable name="rndNum3" value="${citrus:randomNumberGenerator(3, -10, 10)}"/&gt;
    &lt;variable name="rndNum4" value="${citrus:randomNumberGenerator(0, 100, 200, true, false)}"/&gt;
    &lt;variable name="rndNum5" value="${citrus:randomNumberGenerator(2, 0, 100, false, true, 5)}"/&gt;
    &lt;variable name="rndNum5" value="${citrus:randomNumberGenerator(0, 10000000, 1000000000, false, false, null, #.###E0)}"/&gt;
&lt;/variables&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Function Output Examples</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">157
23.78
-5.462
101
15.00</code></pre>
</div>
</div>
<div class="paragraph">
<p>If no parameters are provided, the function generates a random integer between -1,000,000 and 1,000,000.</p>
</div>
<div class="paragraph">
<p>If decimal places are specified, the number will be formatted accordingly.</p>
</div>
<div class="paragraph">
<p>If multiple of is set, the generated number will always be a multiple of the given value within the range.</p>
</div>
<div class="paragraph">
<p>If minimum or maximum values are excluded, the function ensures that the output never equals these boundaries.</p>
</div>
</div>
<div class="sect2">
<h3 id="functions-random-string"><a class="anchor" href="#functions-random-string"></a><a class="link" href="#functions-random-string">39.12. randomString()</a></h3>
<div class="paragraph">
<p>This function will generate a random string representation with a defined length.</p>
</div>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Length  of the generated string. (Required, no default value)</p>
</li>
<li>
<p>Case of the generated letters. (Optional, default: MIXED)</p>
<div class="ulist">
<ul>
<li>
<p>Possible values: UPPERCASE, LOWERCASE, MIXED.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Digits characters (0-9) included. (Optional, default: false)</p>
<div class="ulist">
<ul>
<li>
<p>If set to true, digits will be part of the output.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Minimum number of characters in the generated string. (Optional, default: length)</p>
<div class="ulist">
<ul>
<li>
<p>This value must be positive or zero and less than or equal to the total length.</p>
</li>
<li>
<p>If smaller than the length, the generated string will have a random length between the minimum and the specified length.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variables&gt;
    &lt;variable name="rndString0" value="${citrus:randomString(10)}"/&gt;
    &lt;variable name="rndString1" value="citrus:randomString(10)"/&gt;
    &lt;variable name="rndString2" value="citrus:randomString(10, UPPERCASE)"/&gt;
    &lt;variable name="rndString3" value="citrus:randomString(10, LOWERCASE)"/&gt;
    &lt;variable name="rndString4" value="citrus:randomString(10, MIXED)"/&gt;
    &lt;variable name="rndString4" value="citrus:randomString(10, MIXED, true)"/&gt;
    &lt;variable name="rndString4" value="citrus:randomString(10, MIXED, true, 2)"/&gt;
&lt;/variables&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Function output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">HrGHOdfAer
AgSSwedetG
JSDFUTTRKU
dtkhirtsuz
Vt567JkA32
Vt56</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="functions-random-pattern"><a class="anchor" href="#functions-random-pattern"></a><a class="link" href="#functions-random-pattern">39.13. randomPattern()</a></h3>
<div class="paragraph">
<p>This function generates a random string that matches the given regular expression pattern.
It utilizes the <a href="https://github.com/mifmif/Generex">Generex library</a> to produce valid strings based on the provided regex.</p>
</div>
<div class="paragraph">
<p>The function takes one parameter, which is the regular expression pattern to generate the string from.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variables&gt;
    &lt;variable name="rndPattern1" value="${citrus:randomPattern('[A-Z]{5}')}"/&gt;
    &lt;variable name="rndPattern2" value="${citrus:randomPattern('[0-9]{3}-[A-Z]{2}')}"/&gt;
    &lt;variable name="rndPattern3" value="${citrus:randomPattern('[a-z]{4}[0-9]{2}')}"/&gt;
    &lt;variable name="rndPattern4" value="${citrus:randomPattern('[A-Za-z0-9]{8,12}')}"/&gt;
&lt;/variables&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Function output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">ABCDE
735-RT
bcda42
TgH56yJk12</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated string strictly adheres to the provided regex pattern.
The function supports character ranges, quantifiers, and grouping as per standard Java regex syntax.
If an invalid regex is provided, an error will be thrown.
An error might also be thrown for very complex regex, which cannot be handled by the Generex library.</p>
</div>
</div>
<div class="sect2">
<h3 id="functions-random-enum-value"><a class="anchor" href="#functions-random-enum-value"></a><a class="link" href="#functions-random-enum-value">39.14. randomEnumValue()</a></h3>
<div class="paragraph">
<p>This function returns one of its supplied arguments.
Furthermore, you can specify a custom function with a configured list of values (the enumeration).
The function will randomly return an entry when called without arguments.
This promotes code reuse and facilitates refactoring.</p>
</div>
<div class="paragraph">
<p>In the next sample the function is used to set a httpStatusCode variable to one of the given HTTP status codes (200, 401, 500)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variable name="httpStatusCode" value="citrus:randomEnumValue('200', '401', '500')" /&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As mentioned before you can define a custom function for your very specific needs in order to easily manage a list of predefined values like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public FunctionLibrary myCustomFunctionLibrary() {
    FunctionLibrary library = new FunctionLibrary();
    library.setName("custom");
    library.setPrefix("custom:");
    library.getMembers().put("randomHttpStatusCode", randomHttpStatusCode());
    return library;
}

private RandomEnumValueFunction randomHttpStatusCode() {
    RandomEnumValueFunction function = new RandomEnumValueFunction();
    function.setValues(Arrays.asList("200", "500", "401"));
    return function;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public FunctionLibrary myCustomFunctionLibrary() {
    FunctionLibrary library = new FunctionLibrary();
    library.setName("custom");
    library.setPrefix("custom:");
    library.getMembers().put("randomHttpStatusCode", randomHttpStatusCode());
    return library;
}

private RandomEnumValueFunction randomHttpStatusCode() {
    RandomEnumValueFunction function = new RandomEnumValueFunction();
    function.setValues(Arrays.asList("200", "500", "401"));
    return function;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd"&gt;

    &lt;citrus:function-library id="myCustomFunctionLibrary" prefix="custom:"&gt;
        &lt;citrus:function name="randomHttpStatusCode" ref="randomHttpStatusCodeFunction"/&gt;
    &lt;/citrus:function-library&gt;

    &lt;bean id="randomHttpStatusCodeFunction" class="org.citrusframework.functions.core.RandomEnumValueFunction"&gt;
      &lt;property name="values"&gt;
        &lt;list&gt;
          &lt;value&gt;200&lt;/value&gt;
          &lt;value&gt;500&lt;/value&gt;
          &lt;value&gt;401&lt;/value&gt;
        &lt;/list&gt;
      &lt;/property&gt;
    &lt;/bean&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have added a custom function library with a custom function definition. The custom function "randomHttpStatusCode" randomly chooses an HTTP status code each time it is called. Inside the test you can use the function like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variable name="httpStatusCode" value="custom:randomHttpStatusCode()" /&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="functions-current-date"><a class="anchor" href="#functions-current-date"></a><a class="link" href="#functions-current-date">39.15. currentDate()</a></h3>
<div class="paragraph">
<p>This function will definitely help you when accessing the current date. Some examples will show the usage in detail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;&lt;message&gt;citrus:currentDate()&lt;/message&gt;&lt;/echo&gt;
&lt;echo&gt;&lt;message&gt;citrus:currentDate('yyyy-MM-dd')&lt;/message&gt;&lt;/echo&gt;
&lt;echo&gt;&lt;message&gt;citrus:currentDate('yyyy-MM-dd HH:mm:ss')&lt;/message&gt;&lt;/echo&gt;
&lt;echo&gt;&lt;message&gt;citrus:currentDate('yyyy-MM-dd'T'hh:mm:ss')&lt;/message&gt;&lt;/echo&gt;
&lt;echo&gt;&lt;message&gt;citrus:currentDate('yyyy-MM-dd HH:mm:ss', '+1y')&lt;/message&gt;&lt;/echo&gt;
&lt;echo&gt;&lt;message&gt;citrus:currentDate('yyyy-MM-dd HH:mm:ss', '+1M')&lt;/message&gt;&lt;/echo&gt;
&lt;echo&gt;&lt;message&gt;citrus:currentDate('yyyy-MM-dd HH:mm:ss', '+1d')&lt;/message&gt;&lt;/echo&gt;
&lt;echo&gt;&lt;message&gt;citrus:currentDate('yyyy-MM-dd HH:mm:ss', '+1h')&lt;/message&gt;&lt;/echo&gt;
&lt;echo&gt;&lt;message&gt;citrus:currentDate('yyyy-MM-dd HH:mm:ss', '+1m')&lt;/message&gt;&lt;/echo&gt;
&lt;echo&gt;&lt;message&gt;citrus:currentDate('yyyy-MM-dd HH:mm:ss', '+1s')&lt;/message&gt;&lt;/echo&gt;
&lt;echo&gt;&lt;message&gt;citrus:currentDate('yyyy-MM-dd HH:mm:ss', '-1y')&lt;/message&gt;&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the currentDate function provides two parameters. First parameter describes the date format string. The second will define a date offset string containing year, month, days, hours, minutes or seconds that will be added or subtracted to or from the actual date value.</p>
</div>
<div class="paragraph">
<p>Function output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">01.09.2009
2009-09-01
2009-09-01 12:00:00
2009-09-01T12:00:00</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="functions-uppercase"><a class="anchor" href="#functions-uppercase"></a><a class="link" href="#functions-uppercase">39.16. upperCase()</a></h3>
<div class="paragraph">
<p>This function converts any string to upper case letters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;citrus:upperCase('Hello Test Framework')&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Function output:</p>
</div>
<div class="paragraph">
<p><strong>HELLO TEST FRAMEWORK</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-lowercase"><a class="anchor" href="#functions-lowercase"></a><a class="link" href="#functions-lowercase">39.17. lowerCase()</a></h3>
<div class="paragraph">
<p>This function converts any string to lower case letters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;citrus:lowerCase('Hello Test Framework')&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Function output:</p>
</div>
<div class="paragraph">
<p><strong>hello test framework</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-average"><a class="anchor" href="#functions-average"></a><a class="link" href="#functions-average">39.18. average()</a></h3>
<div class="paragraph">
<p>The function will sum up all specified number values and divide the result through the number of values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variable name="avg" value="citrus:average('3', '4', '5')"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>avg = <strong>4.0</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-minimum"><a class="anchor" href="#functions-minimum"></a><a class="link" href="#functions-minimum">39.19. minimum()</a></h3>
<div class="paragraph">
<p>This function returns the minimum value in a set of number values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variable name="min" value="citrus:minimum('3', '4', '5')"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>min = <strong>3.0</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-maximum"><a class="anchor" href="#functions-maximum"></a><a class="link" href="#functions-maximum">39.20. maximum()</a></h3>
<div class="paragraph">
<p>This function returns the maximum value in a set of number values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variable name="max" value="citrus:maximum('3', '4', '5')"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>max = <strong>5.0</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-sum"><a class="anchor" href="#functions-sum"></a><a class="link" href="#functions-sum">39.21. sum()</a></h3>
<div class="paragraph">
<p>The function will sum up all number values. The number values can also be negative.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variable name="sum" value="citrus:sum('3', '4', '5')"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>sum = <strong>12.0</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-absolute"><a class="anchor" href="#functions-absolute"></a><a class="link" href="#functions-absolute">39.22. absolute()</a></h3>
<div class="paragraph">
<p>The function will return the absolute number value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variable name="abs" value="citrus:absolute('-3')"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>abs = <strong>3.0</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-map-value"><a class="anchor" href="#functions-map-value"></a><a class="link" href="#functions-map-value">39.23. mapValue()</a></h3>
<div class="paragraph">
<p>This function implementation maps string keys to string values. This is very helpful when the used key is randomly chosen at runtime and the corresponding value is not defined during the design time.</p>
</div>
<div class="paragraph">
<p>The following function library defines a custom function for mapping HTTP status codes to the corresponding messages:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public FunctionLibrary myCustomFunctionLibrary() {
    FunctionLibrary library = new FunctionLibrary();
    library.setName("custom");
    library.setPrefix("custom:");
    library.getMembers().put("randomHttpStatusCode", randomHttpStatusCode());
    return library;
}

private RandomEnumValueFunction randomHttpStatusCode() {
    RandomEnumValueFunction function = new RandomEnumValueFunction();
    function.setValues(Arrays.asList("200", "500", "401"));
    return function;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public FunctionLibrary myCustomFunctionLibrary() {
    FunctionLibrary library = new FunctionLibrary();
    library.setName("custom");
    library.setPrefix("custom:");
    library.getMembers().put("getHttpStatusMessage", httpStatusMessageFunction());
    return library;
}

private MapValueFunction httpStatusMessageFunction() {
    MapValueFunction function = new MapValueFunction();
    function.getValues().put("200", "OK");
    function.getValues().put("401", "Unauthorized");
    function.getValues().put("500", "Internal Server Error");
    return function;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.citrusframework.org/schema/config
       http://www.citrusframework.org/schema/config/citrus-config.xsd"&gt;


    &lt;citrus:function-library id="myCustomFunctionLibrary" prefix="custom:"&gt;
          &lt;citrus-function name="getHttpStatusMessage" ref="httpStatusMessageFunction"/&gt;
    &lt;/citrus:function-library&gt;

    &lt;bean id="httpStatusMessageFunction" class="org.citrusframework.functions.core.MapValueFunction"&gt;
      &lt;property name="values"&gt;
        &lt;map&gt;
          &lt;entry key="200" value="OK" /&gt;
          &lt;entry key="401" value="Unauthorized" /&gt;
          &lt;entry key="500" value="Internal Server Error" /&gt;
        &lt;/map&gt;
      &lt;/property&gt;
    &lt;/bean&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example the function sets the variable httpStatusMessage to the 'Internal Server Error' string dynamically at runtime. The test only knows the HTTP status code and does not care about spelling and message locales.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variable name="httpStatusCodeMessage" value="custom:getHttpStatusMessage('500')" /&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="functions-random-uuid"><a class="anchor" href="#functions-random-uuid"></a><a class="link" href="#functions-random-uuid">39.24. randomUUID()</a></h3>
<div class="paragraph">
<p>The function will generate a random Java UUID.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variable name="uuid" value="citrus:randomUUID()"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>uuid = <strong>98fbd7b0-832e-4b85-b9d2-e0113ee88356</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-encode-base64"><a class="anchor" href="#functions-encode-base64"></a><a class="link" href="#functions-encode-base64">39.25. encodeBase64()</a></h3>
<div class="paragraph">
<p>The function will encode a string to binary data using base64 hexadecimal encoding.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variable name="encoded" value="citrus:encodeBase64('Hallo Testframework')"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>encoded = <strong>VGVzdCBGcmFtZXdvcms=</strong></p>
</div>
<div class="paragraph">
<p>It also has an optional charset parameter that is used for encoding the input string, with UTF-8 as its default value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variable name="encoded" value="citrus:encodeBase64('Hallo Testframework', 'UTF-8')"/&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="functions-decode-base64"><a class="anchor" href="#functions-decode-base64"></a><a class="link" href="#functions-decode-base64">39.26. decodeBase64()</a></h3>
<div class="paragraph">
<p>The function will decode binary data to a character sequence using base64 hexadecimal decoding.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variable name="decoded" value="citrus:decodeBase64('VGVzdCBGcmFtZXdvcms=')"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>decoded = <strong>Hallo Testframework</strong></p>
</div>
<div class="paragraph">
<p>It also has an optional charset parameter that is used for encoding the input string, with UTF-8 as its default value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variable name="decoded" value="citrus:decodeBase64('VGVzdCBGcmFtZXdvcms=', 'UTF-8')"/&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="functions-escape-xml"><a class="anchor" href="#functions-escape-xml"></a><a class="link" href="#functions-escape-xml">39.27. escapeXml()</a></h3>
<div class="paragraph">
<p>If you want to deal with escaped XML in your test case you may want to use this function. It automatically escapes all XML special characters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;
        &lt;![CDATA[
            citrus:escapeXml('&lt;Message&gt;Hallo Test Framework&lt;/Message&gt;')
        ]]&gt;
    &lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>&lt;Message&gt;Hallo Test Framework&lt;/Message&gt;</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-escape-json"><a class="anchor" href="#functions-escape-json"></a><a class="link" href="#functions-escape-json">39.28. escapeJson()</a></h3>
<div class="paragraph">
<p>If you want to deal with escaped JSON in your test case you may want to use this function.
It automatically escapes all JSON special characters (especially double quotes).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;
        &lt;![CDATA[
            {
                "kafkaClientConfiguration": {
                    "bootstrapServers": ["${kafkaBootstrapServer}"]
                },
                "messageBody": "citrus:escapeJson("{"exampleJson": "exampleValue"}")"
            }
        ]]&gt;
    &lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="functions-cdata-section"><a class="anchor" href="#functions-cdata-section"></a><a class="link" href="#functions-cdata-section">39.29. cdataSection()</a></h3>
<div class="paragraph">
<p>Usually we use CDATA sections to define message payload data inside a testcase. We might run into problems when the payload itself contains CDATA sections as nested CDATA sections are prohibited by XML nature. In this case the next function ships very usefull.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variable name="cdata" value="citrus:cdataSection('payload')"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>cdata = <code>&lt;![CDATA[payload]]&gt;</code></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-digest-auth-header"><a class="anchor" href="#functions-digest-auth-header"></a><a class="link" href="#functions-digest-auth-header">39.30. digestAuthHeader()</a></h3>
<div class="paragraph">
<p>Digest authentication is a commonly used security algorithm, especially in Http communication and SOAP WebServices. Citrus offers a function to generate a digest authentication principle used in the Http header section of a message.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variable name="digest"
  value="citrus:digestAuthHeader('username', 'password', 'authRealm', 'acegi',
                            'POST', 'http://127.0.0.1:8080', 'citrus', 'md5')"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A possible digest authentication header value looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;Digest username=foo,realm=arealm,nonce=MTMzNT,
uri=http://127.0.0.1:8080,response=51f98c,opaque=b29a30,algorithm=md5&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use these digest headers in messages sent by Citrus like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;header&gt;
  &lt;element name="citrus_http_Authorization"
    value="vflig:digestAuthHeader('${username}','${password}','${authRealm}',
                            '${nonceKey}','POST','${uri}','${opaque}','${algorithm}')"/&gt;
&lt;/header&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will set a Http Authorization header with the respective digest in the request message. So your test is ready for client digest authentication.</p>
</div>
</div>
<div class="sect2">
<h3 id="functions-localhost-address"><a class="anchor" href="#functions-localhost-address"></a><a class="link" href="#functions-localhost-address">39.31. localHostAddress()</a></h3>
<div class="paragraph">
<p>Test cases may use the local host address for some reason (e.g. used as authentication principle). As the tests may run on different machines at the same time we can not use static host addresses. The provided function localHostAddress() reads the local host name dynamically at runtime.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;variable name="address" value="citrus:localHostAddress()"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A possible value is either the host name as used in DNS entry or an IP address value:</p>
</div>
<div class="paragraph">
<p>address = <code>&lt;192.168.2.100&gt;</code></p>
</div>
</div>
<div class="sect2">
<h3 id="functions-change-date"><a class="anchor" href="#functions-change-date"></a><a class="link" href="#functions-change-date">39.32. changeDate()</a></h3>
<div class="paragraph">
<p>This function works with date values and manipulates those at runtime by adding or removing a date value offset. You can manipulate several date fields such as: year, month, day, hour, minute or second.</p>
</div>
<div class="paragraph">
<p>Let us clarify this with a simple example for this function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;citrus:changeDate('01.01.2000', '+1y+1M+1d')&lt;/message&gt;
&lt;/echo&gt;
&lt;echo&gt;
    &lt;message&gt;citrus:changeDate(citrus:currentDate(), '-1M')&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Function output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">02.02.2001
13.04.2013</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the change date function works on static date values or dynamic variable values or functions like <strong>citrus:currentDate()</strong> . By default the change date function requires a date format such as the current date function ('dd.MM.yyyy'). You can also define a custom date format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;citrus:changeDate('2000-01-10', '-1M-1d', 'yyyy-MM-dd')&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Function output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">1999-12-09</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this you are able to manipulate all date values of static or dynamic nature at test runtime.</p>
</div>
</div>
<div class="sect2">
<h3 id="functions-read-file"><a class="anchor" href="#functions-read-file"></a><a class="link" href="#functions-read-file">39.33. readFile()</a></h3>
<div class="paragraph">
<p>The <strong>readFile</strong> function reads a file resource from given file path and loads the complete file content as function result. The file path can be a system file path as well as a classpath file resource. The file path can have test variables as part of the path or file name. In addition to that the file content can also have test variable values and other functions.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see this function in action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;citrus:readFile('classpath:some/path/to/file.txt')&lt;/message&gt;
&lt;/echo&gt;
&lt;echo&gt;
    &lt;message&gt;citrus:readFile(${filePath})&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The function reads the file content and places the content at the position where the function has been called. This means that you can also use this function as part of Strings and message payloads for instance. This is a very powerful way to extract large message parts to separate file resources. Just add the <strong>readFile</strong> function somewhere to the message content and Citrus will load the extra file content and place it right into the message payload for you.</p>
</div>
<div class="paragraph">
<p>This function has a second and a third optional parameter that can be used for the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>2nd parameter: a boolean value to indicate that the returned value should be base64 encoded. Defaults to false.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;message&gt;citrus:readFile('classpath:some/path/to/file.txt', true)&lt;/message&gt;</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>3rd parameter: a boolean value to indicate that a dynamic replacement (Citrus variables, functions, etc.) should be performed before the content is base64 encoded. Defaults to false.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;message&gt;citrus:readFile('classpath:some/path/to/file.txt', true, true)&lt;/message&gt;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="functions-message"><a class="anchor" href="#functions-message"></a><a class="link" href="#functions-message">39.34. message()</a></h3>
<div class="paragraph">
<p>When messages are exchanged in Citrus the content is automatically saved to an in memory storage for further access in the test case. That means that functions and test actions can access the messages
that have been sent or received within the test case. The <strong>message</strong> function loads a message content from that message store. The message is identified by its name. Receive and send actions usually define
the message name. Now we can load the message payload with that name.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see this function in action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;citrus:message(myRequest.body())&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The function above loads the message named <strong>myRequest</strong> from the local memory store. This requires a send or receive action to have handled the message before in the same test case.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void messageNameTest() {
    send("someEndpoint")
        .message()
        .name("myRequest")
        .body("Some payload");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="MessageNameTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;send endpoint="someEndpoint"&gt;
        &lt;message name="myRequest"&gt;
          &lt;body&gt;
            &lt;data&gt;Some payload&lt;/data&gt;
          &lt;/body&gt;
        &lt;/message&gt;
      &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: MessageNameTest
actions:
  - send:
      endpoint: someEndpoint
      name: myRequest
      message:
        body:
          data: "Some payload"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;
  &lt;testcase name="MessageNameTest"&gt;
    &lt;actions&gt;
        &lt;send endpoint="someEndpoint"&gt;
          &lt;message name="myRequest"&gt;
            &lt;payload&gt;Some payload&lt;/payload&gt;
          &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The name of the message is important. Otherwise the message can not be found in the local message store. Note: a message can either be received or sent with a name in order to be stored
in the local message store. The <strong>message</strong> function is then able to access the message by its name. In the first example the <strong>body()</strong> has been loaded. Of course we can also access header information.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void messageNameTest() {
    echo().message("citrus:message(myRequest.header('Operation'))");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="MessageNameTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;echo message="citrus:message(myRequest.header('Operation'))"/&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: MessageNameTest
actions:
  - echo:
      message: "citrus:message(myRequest.header('Operation'))"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;
  &lt;testcase name="MessageNameTest"&gt;
    &lt;actions&gt;
        &lt;echo&gt;
            &lt;message&gt;citrus:message(myRequest.header('Operation'))&lt;/message&gt;
        &lt;/echo&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sample above loads the header <strong>Operation</strong> of the message.</p>
</div>
<div class="paragraph">
<p>In Java DSL the message store is also accessible over the TestContext.</p>
</div>
</div>
<div class="sect2">
<h3 id="functions-xpath"><a class="anchor" href="#functions-xpath"></a><a class="link" href="#functions-xpath">39.35. xpath()</a></h3>
<div class="paragraph">
<p>The <strong>xpath</strong> function evaluates a Xpath expressions on some XML source and returns the expression result as String.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void xpathTest() {
    echo()
        .message("""
        citrus:xpath('&lt;message&gt;&lt;id&gt;1000&lt;/id&gt;&lt;/text&gt;Some text content&lt;/text&gt;&lt;/message&gt;', '/message/id')
        """);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="XpathTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;echo&gt;
        &lt;message&gt;
        &lt;![CDATA[
        citrus:xpath('&lt;message&gt;&lt;id&gt;1000&lt;/id&gt;&lt;/text&gt;Some text content&lt;/text&gt;&lt;/message&gt;', '/message/id')
        ]]&gt;
        &lt;/message&gt;
      &lt;/echo&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: XpathTest
actions:
  - echo:
      message: |
        citrus:xpath('&lt;message&gt;&lt;id&gt;1000&lt;/id&gt;&lt;/text&gt;Some text content&lt;/text&gt;&lt;/message&gt;', '/message/id')</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;
  &lt;testcase name="XpathTest"&gt;
    &lt;actions&gt;
        &lt;echo&gt;
            &lt;message&gt;
            &lt;![CDATA[
            citrus:xpath('&lt;message&gt;&lt;id&gt;1000&lt;/id&gt;&lt;/text&gt;Some text content&lt;/text&gt;&lt;/message&gt;', '/message/id')
            ]]&gt;
            &lt;/message&gt;
        &lt;/echo&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The XML source is given as first function parameter and can be loaded in different ways. In the example above a static XML source has been used. We could load the XML content from
external file or just use a test variable.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void xpathTest() {
    echo()
        .message("""
        citrus:xpath(citrus:readFile('some/path/to/file.xml'), '/message/id')
        """);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="XpathTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;echo&gt;
        &lt;message&gt;
        &lt;![CDATA[
        citrus:xpath(citrus:readFile('some/path/to/file.xml'), '/message/id')
        ]]&gt;
        &lt;/message&gt;
      &lt;/echo&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: XpathTest
actions:
  - echo:
      message: |
        citrus:xpath(citrus:readFile('some/path/to/file.xml'), '/message/id')</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;
  &lt;testcase name="XpathTest"&gt;
    &lt;actions&gt;
        &lt;echo&gt;
            &lt;message&gt;
            &lt;![CDATA[
            citrus:xpath(citrus:readFile('some/path/to/file.xml'), '/message/id')
            ]]&gt;
            &lt;/message&gt;
        &lt;/echo&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also accessing the local message store is valid here:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void xpathTest() {
    echo()
        .message("""
        citrus:xpath(citrus:message(myRequest.body()), '/message/id')
        """);
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="XpathTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
      &lt;echo&gt;
        &lt;message&gt;
        &lt;![CDATA[
        citrus:xpath(citrus:message(myRequest.body()), '/message/id')
        ]]&gt;
        &lt;/message&gt;
      &lt;/echo&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: XpathTest
actions:
  - echo:
      message: |
        citrus:xpath(citrus:message(myRequest.body()), '/message/id')</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
          xmlns:spring="http://www.springframework.org/schema/beans"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;
  &lt;testcase name="XpathTest"&gt;
    &lt;actions&gt;
        &lt;echo&gt;
            &lt;message&gt;
            &lt;![CDATA[
            citrus:xpath(citrus:message(myRequest.body()), '/message/id')
            ]]&gt;
            &lt;/message&gt;
        &lt;/echo&gt;
    &lt;/actions&gt;
  &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This combination is quite powerful as all previously exchanged messages in the test are automatically stored to the local message store. Reusing dynamic message values from other messages
becomes very easy then.</p>
</div>
</div>
<div class="sect2">
<h3 id="functions-jsonpath"><a class="anchor" href="#functions-jsonpath"></a><a class="link" href="#functions-jsonpath">39.36. jsonPath()</a></h3>
<div class="paragraph">
<p>The <strong>jsonPath</strong> function evaluates a JsonPath expressions on some JSON source and returns the expression result as String.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;&lt;![CDATA[citrus:jsonPath('{ "message": { "id": 1000, "text": "Some text content" } }', '$.message.id')]]&gt;&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JSON source is given as first function parameter and can be loaded in different ways. In the example above a static JSON source has been used. We could load the JSON content from
external file or just use a test variable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;&lt;![CDATA[citrus:jsonPath(${jsonSource}, '$.message.id')]]&gt;&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JSON source may also be specified in multiple parameters, in which case the arguments except the last one are concatenated with commas,
and will be treated as the JSON source. The last parameter is always treated as the JSON path expression.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;&lt;![CDATA[citrus:jsonPath('{ "message": { "id": 1000', '"text": "Some text content" } }', '$.message.id')]]&gt;&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, the parts <code>{ "message": { "id": 1000</code> and <code>"text": "Some text content" } }</code> will form the JSON source
as <code>{ "message": { "id": 1000, "text": "Some text content" } }</code>.</p>
</div>
<div class="paragraph">
<p>Also accessing the local message store is valid here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;&lt;![CDATA[citrus:jsonPath(citrus:message(myRequest.body()), '$.message.id')]]&gt;&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This combination is quite powerful as all previously exchanged messages in the test are automatically stored to the local message store. Reusing dynamic message values from other messages
becomes very easy then.</p>
</div>
</div>
<div class="sect2">
<h3 id="functions-url-encode"><a class="anchor" href="#functions-url-encode"></a><a class="link" href="#functions-url-encode">39.37. urlEncode()/urlDecode()</a></h3>
<div class="paragraph">
<p>The <strong>urlEncode</strong> function takes a String and performs proper URL encoding. The result is a URL encoded String that is using proper character escaping for Http.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;&lt;![CDATA[citrus:urlEncode('foo@citrusframework', 'UTF-8')]]&gt;&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above function takes the String <code>foo@citrusframework.org</code> and performs proper URL encoding resulting in <code>foo%40citrusframework</code>.</p>
</div>
<div class="paragraph">
<p>Same logic applies to the <code>urlDecode()</code> function that will read an encoded String replacing all escaped characters to the normal String representation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;&lt;![CDATA[citrus:urlDecode('foo%40citrusframework', 'UTF-8')]]&gt;&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>UTF-8</code> charset is used during URL encoding operation and is optional as the default is <code>UTF-8</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="functions-system-properties"><a class="anchor" href="#functions-system-properties"></a><a class="link" href="#functions-system-properties">39.38. systemProperty()</a></h3>
<div class="paragraph">
<p>The <strong>systemProperty</strong> function resolves a System property expression at test runtime. The resulting value is returned as function result. In case the System property is not available in the JVM an optional default value is used.
In case no default value is given the function will fail with errors.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;&lt;![CDATA[citrus:systemProperty('user.name', 'my-default')]]&gt;&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="functions-env-settings"><a class="anchor" href="#functions-env-settings"></a><a class="link" href="#functions-env-settings">39.39. env()</a></h3>
<div class="paragraph">
<p>The <strong>env</strong> function can be used to access an environment specific property at test runtime. The environment property can be a variable set on the underlying operating system. Also the <code>env()</code> function is able to access
the Spring environment settings (see <code>org.springframework.core.env.Environment</code>).</p>
</div>
<div class="paragraph">
<p>As the Spring environment is also able to resolve System properties you can use this function in this manner, too.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;&lt;![CDATA[citrus:env('USER_NAME', 'my-default')]]&gt;&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default value is optional and provides an error fallback in case the environment setting is not available. In case no default value is provided the function will fail with errors.</p>
</div>
</div>
<div class="sect2">
<h3 id="functions-unix-timestamp"><a class="anchor" href="#functions-unix-timestamp"></a><a class="link" href="#functions-unix-timestamp">39.40. unixTimestamp()</a></h3>
<div class="paragraph">
<p><strong>unixTimestamp</strong> is a parameterless function that simply returns the current epoch timestamp as seconds.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;echo&gt;
    &lt;message&gt;&lt;![CDATA[citrus:unixTimestamp()]]&gt;&lt;/message&gt;
&lt;/echo&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="validation-matcher"><a class="anchor" href="#validation-matcher"></a><a class="link" href="#validation-matcher">40. Validation Matchers</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Message validation in Citrus is essential. The framework offers several validation mechanisms for different message types and formats. With test variables we are able to check for simple value equality. We ensure that message entries are equal to predefined expected values. Validation matcher add powerful assertion functionality on top of that. You just can use the predefined validation matcher functionalities in order to perform more complex assertions like <strong>contains</strong> or <strong>isNumber</strong> in your validation statements.</p>
</div>
<div class="paragraph">
<p>The following sections describe the Citrus default validation matcher implementations that are ready for usage. The matcher implementations should cover the basic assertions on character sequences and numbers. Of course you can add custom validation matcher implementations in order to meet your very specific validation assertions, too.</p>
</div>
<div class="paragraph">
<p>First of all let us have a look at a validation matcher statement in action so we understand how to use them in a test case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;message&gt;
    &lt;payload&gt;
        &lt;RequestMessage&gt;
            &lt;MessageBody&gt;
                &lt;Customer&gt;
                    &lt;Id&gt;@greaterThan(0)@&lt;/Id&gt;
                    &lt;Name&gt;@equalsIgnoreCase('foo')@&lt;/Name&gt;
                &lt;/Customer&gt;
            &lt;/MessageBody&gt;
        &lt;/RequestMessage&gt;
    &lt;/payload&gt;
&lt;/message&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The listing above describes a normal message validation block inside a receive test action. We use some inline message payload template as CDATA. As you know Citrus will compare the actual message payload to this expected template in DOM tree comparison. In addition to that you can simply include validation matcher statements. The message element <strong>Id</strong> is automatically validated to be a number greater than zero and the <strong>Name</strong> character sequence is supposed to match 'foo' ignoring case spelling considerations.</p>
</div>
<div class="paragraph">
<p>Please note the special validation matcher syntax. The statements are surrounded with '@' markers and are identified by some unique name. The optional parameters passed to the matcher implementation state the expected values to match.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can use validation matcher with all validation mechanisms - not only with XML validation. Plaintext, JSON, SQL result set validation are also supported.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A set of validation matcher implementations is usually combined to a validation matcher library. The library has a prefix that will identify the validation matcher inside the test case. The default test framework validation matcher library uses a default prefix (citrus). You can write your own validation matcher library using your own prefix in order to extend the test framework functionality whenever you want.</p>
</div>
<div class="paragraph">
<p>The library is built in the Spring configuration and contains a set of validation matchers that are of public use.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public ValidationMatcherLibrary testMatcherLibrary() {
    ValidationMatcherLibrary library = new ValidationMatcherLibrary();
    library.setName("test");
    library.setPrefix("foo:");
    library.getMembers().put("isNumber", new IsNumberValidationMatcher());
    library.getMembers().put("contains", new ContainsValidationMatcher());
    library.getMembers().put("customMatcher", customMatcherBean());
    return library;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public ValidationMatcherLibrary testMatcherLibrary() {
    ValidationMatcherLibrary library = new ValidationMatcherLibrary();
    library.setName("test");
    library.setPrefix("foo:");
    library.getMembers().put("isNumber", new IsNumberValidationMatcher());
    library.getMembers().put("contains", new ContainsValidationMatcher());
    library.getMembers().put("customMatcher", customMatcherBean());
    return library;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.citrusframework.org/schema/config
           http://www.citrusframework.org/schema/config/citrus-config.xsd"&gt;

    &lt;citrus:validation-matcher-library id="testMatcherLibrary" prefix="foo:"&gt;
          &lt;citrus:matcher name="isNumber" class="org.citrusframework.validation.matcher.core.IsNumberValidationMatcher"/&gt;
          &lt;citrus:matcher name="contains" class="org.citrusframework.validation.matcher.core.ContainsValidationMatcher"/&gt;
          &lt;citrus:matcher name="customMatcher" ref="customMatcherBean"/&gt;
          ...
    &lt;/citrus:validation-matcher-library&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the library defines one to many validation matcher members either referenced as normal Spring bean or by its implementing Java class name. Citrus constructs the library, and you are able to use the validation matcher in your test case with the leading library prefix just like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">@foo:isNumber()@
@foo:contains()@
@foo:customMatcher()@</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can add custom validation matcher implementations and custom validation matcher libraries. Just use a custom prefix for your library. The default Citrus validation matcher library uses no prefix. See now the following sections describing the default validation matcher in Citrus.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="matcher-ignore"><a class="anchor" href="#matcher-ignore"></a><a class="link" href="#matcher-ignore">40.1. ignore()</a></h3>
<div class="paragraph">
<p>The ignore validation matcher is a special matcher that ignores the value and is always positive in its outcome. You should use the ignore validation matcher when
only validating the pure existence of an element. The value is ignored but the element has to be present in the message payload.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;message&gt;
    &lt;payload&gt;
        &lt;RequestMessage&gt;
            &lt;MessageBody&gt;
                &lt;Customer&gt;
                    &lt;Id&gt;@ignore()@&lt;/Id&gt;
                    &lt;Name&gt;@equalsIgnoreCase('foo')@&lt;/Name&gt;
                &lt;/Customer&gt;
            &lt;/MessageBody&gt;
        &lt;/RequestMessage&gt;
    &lt;/payload&gt;
&lt;/message&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The ignore validation matcher is the only validation matcher that is able to skip the function parameter body. So you can use both <code>@ignore()@</code> and <code>@ignore@</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="matcher-matches-xml"><a class="anchor" href="#matcher-matches-xml"></a><a class="link" href="#matcher-matches-xml">40.2. matchesXml()</a></h3>
<div class="paragraph">
<p>The XML validation matcher implementation is the possibly most exciting one, as we can validate nested XML with full validation power (e.g. ignoring elements, variable support). The matcher checks a nested XML fragment to compare against expected XML. For instance we receive the following XML message payload for validation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;GetCustomerMessage&gt;
      &lt;CustomerDetails&gt;
          &lt;Id&gt;5&lt;/Id&gt;
          &lt;Name&gt;Christoph&lt;/Name&gt;
          &lt;Configuration&gt;
          &lt;![CDATA[
            &lt;config&gt;
                &lt;premium&gt;true&lt;/premium&gt;
                &lt;last-login&gt;2012-02-24T23:34:23&lt;/last-login&gt;
                &lt;link&gt;http://citrusframework.org/customer/5&lt;/link&gt;
            &lt;/config&gt;
          ]]&gt;
          &lt;/Configuration&gt;
      &lt;/CustomerDetails&gt;
&lt;/GetCustomerMessage&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the message payload contains some configuration as nested XML data in a CDATA section. We could validate this CDATA section as static character sequence comparison, true. But the &lt;last-login&gt; timestamp changes its value continuously. This breaks the static validation for CDATA elements in XML. Fortunately the new XML validation matcher provides a solution for us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;message&gt;
    &lt;payload&gt;
        &lt;GetCustomerMessage&gt;
            &lt;CustomerDetails&gt;
                &lt;Id&gt;5&lt;/Id&gt;
                &lt;Name&gt;Christoph&lt;/Name&gt;
                &lt;Configuration&gt;
                  citrus:cdataSection(@matchesXml('&lt;config&gt;
                    &lt;premium&gt;${isPremium}&lt;/premium&gt;
                    &lt;last-login&gt;@ignore@&lt;/last-login&gt;
                    &lt;link&gt;http://citrusframework.org/customer/5&lt;/link&gt;
                  &lt;/config&gt;')@)
                &lt;/Configuration&gt;
            &lt;/CustomerDetails&gt;
        &lt;/GetCustomerMessage&gt;
    &lt;/payload&gt;
&lt;/message&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the validation matcher you are able to validate the nested XML with full validation power. Ignoring elements is possible and we can also use variables in our control XML.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Nested CDATA elements within other CDATA sections are not allowed by XML standard. This is why we create the nested CDATA section on the fly with the function cdataSection().
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="matcher-equals-ignore-case"><a class="anchor" href="#matcher-equals-ignore-case"></a><a class="link" href="#matcher-equals-ignore-case">40.3. equalsIgnoreCase()</a></h3>
<div class="paragraph">
<p>This matcher implementation checks for equality without any case spelling considerations. The matcher expects a single parameter as the expected character sequence to check for.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;value&gt;@equalsIgnoreCase('foo')@&lt;/value&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="matcher-contains"><a class="anchor" href="#matcher-contains"></a><a class="link" href="#matcher-contains">40.4. contains()</a></h3>
<div class="paragraph">
<p>This matcher searches for a character sequence inside the actual value. If the character sequence is not found somewhere the matcher starts complaining.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;value&gt;@contains('foo')@&lt;/value&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The validation matcher also exists in a case-insensitive variant.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;value&gt;@containsIgnoreCase('foo')@&lt;/value&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="matcher-startswith"><a class="anchor" href="#matcher-startswith"></a><a class="link" href="#matcher-startswith">40.5. startsWith()</a></h3>
<div class="paragraph">
<p>The matcher implementation asserts that the given value starts with a character sequence otherwise the matcher will arise some error.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;value&gt;@startsWith('foo')@&lt;/value&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="matcher-endswith"><a class="anchor" href="#matcher-endswith"></a><a class="link" href="#matcher-endswith">40.6. endsWith()</a></h3>
<div class="paragraph">
<p>Ends with matcher validates a value to end with a given character sequence.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;value&gt;@endsWith('foo')@&lt;/value&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="matcher-matches"><a class="anchor" href="#matcher-matches"></a><a class="link" href="#matcher-matches">40.7. matches()</a></h3>
<div class="paragraph">
<p>You can check a value to meet a regular expression with this validation matcher. This is for instance very useful for email address validation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;value&gt;@matches('[a-z0-9]')@&lt;/value&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="matcher-matches-date-pattern"><a class="anchor" href="#matcher-matches-date-pattern"></a><a class="link" href="#matcher-matches-date-pattern">40.8. matchesDatePattern()</a></h3>
<div class="paragraph">
<p>Date values are always difficult to check for equality. Especially when you have millisecond timestamps to deal with. Therefore the date pattern validation matcher should have some improvement for you. You simply validate the date format pattern instead of checking for total equality.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;value&gt;@matchesDatePattern('yyyy-MM-dd')@&lt;/value&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example listing uses a date format pattern that is expected. The actual date value is parsed according to this pattern and may cause errors in case the value is not a valid date matching the desired format.</p>
</div>
</div>
<div class="sect2">
<h3 id="matcher-isnumber"><a class="anchor" href="#matcher-isnumber"></a><a class="link" href="#matcher-isnumber">40.9. isNumber()</a></h3>
<div class="paragraph">
<p>Checking on values to be of numeric nature is essential. The actual value must be a numeric number otherwise the matcher raises errors. The matcher implementation does not evaluate any parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;value&gt;@isNumber()@&lt;/value&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="matcher-lowerthan"><a class="anchor" href="#matcher-lowerthan"></a><a class="link" href="#matcher-lowerthan">40.10. lowerThan()</a></h3>
<div class="paragraph">
<p>This matcher checks a number to be lower than a given threshold value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;value&gt;@lowerThan(5)@&lt;/value&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="matcher-greaterthan"><a class="anchor" href="#matcher-greaterthan"></a><a class="link" href="#matcher-greaterthan">40.11. greaterThan()</a></h3>
<div class="paragraph">
<p>The matcher implementation will check on numeric values to be greater than a minimum value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;value&gt;@greaterThan(5)@&lt;/value&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="matcher-isweekday"><a class="anchor" href="#matcher-isweekday"></a><a class="link" href="#matcher-isweekday">40.12. isWeekday()</a></h3>
<div class="paragraph">
<p>The matcher works on date values and checks that a given date evaluates to the expected day of the week. The user defines the expected day by its name in uppercase characters. The matcher fails in case the given date is another week day than expected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;someDate&gt;@isWeekday('MONDAY')@&lt;/someDate&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Possible values for the expected day of the week are: MONDAY, TUESDAY, WEDNESDAY, THURSDAY, FRIDAY, SATURDAY or SUNDAY.</p>
</div>
<div class="paragraph">
<p>The field value has to be a date value otherwise the matcher will fail to parse the date. The matcher requires a date format which is <strong>dd.MM.yyyy</strong> by default. You can change this date format as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;someDate&gt;@isWeekday(MONDAY('yyyy-MM-dd'))@&lt;/someDate&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the matcher uses the custom date format in order to parse the date value for evaluation. The validation matcher also works with date time values. In this case you have to give a valid date time format respectively (e.g. FRIDAY('yyyy-MM-dd&#8217;T&#8217;hh:mm:ss')).</p>
</div>
</div>
<div class="sect2">
<h3 id="matcher-variable"><a class="anchor" href="#matcher-variable"></a><a class="link" href="#matcher-variable">40.13. variable()</a></h3>
<div class="paragraph">
<p>This is a very special validation matcher. Instead of performing a validation logic you can save the actual value passed to the validation matcher as new test variable. This comes very handy as you can use the matcher wherever you want: JSON message payloads, XML message payloads, headers and so on.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;value&gt;@variable('foo')@&lt;/value&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The validation matcher creates a new variable <strong>foo</strong> with the actual element value as variable value. When leaving out the control value the field name itself is used as variable name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;date&gt;@variable()@&lt;/date&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates a new variable <strong>date</strong> with the actual element value as variable value.</p>
</div>
</div>
<div class="sect2">
<h3 id="matcher-daterange"><a class="anchor" href="#matcher-daterange"></a><a class="link" href="#matcher-daterange">40.14. dateRange()</a></h3>
<div class="paragraph">
<p>The matcher works on date values and checks that a given date is within the expected date range. The user defines the expected date range by specifying a from-date, a to-date and optionally a date format. The matcher fails when the given date lies outside the expected date range.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;someDate&gt;@dateRange('01-12-2015', '31-12-2015', 'dd-MM-yyyy')@&lt;/someDate&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Possible valid values would be 'some date' &gt;= '01-12-2015' and 'some date' &lt;= '31-12-2015'</p>
</div>
<div class="paragraph">
<p>The date-format is optional and when omitted it is assumed that all dates match the default date format <strong>yyyy-MM-dd</strong> . When specifying a custom date format use Java&#8217;s date format as a reference for valid date formats. Only dates were used in the example above but we could just as easily used date and time as shown in the example below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;someDate&gt;@dateRange('2015.12.01 07:00:00', '2015.12.01 19:00:00', 'yyyy.MM.dd HH:mm:ss')@&lt;/someDate&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="matcher-assert-that"><a class="anchor" href="#matcher-assert-that"></a><a class="link" href="#matcher-assert-that">40.15. assertThat()</a></h3>
<div class="paragraph">
<p>Hamcrest is a very powerful matcher library with extraordinary matcher implementations. You can use Hamcrest matchers also as Citrus validation matchers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;someValue&gt;@assertThat(equalTo(foo))@&lt;/someValue&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the listing above we are using the <strong>equalTo()</strong> matcher. All Hamcrest matchers are surrounded by an <strong>assertThat</strong> expression. You are able to combine several Hamcrest matchers then in order to construct very powerful validation logic. See the following examples on what is possible then:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;someValue&gt;@assertThat(equalTo(value))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(not(equalTo(other))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(is(not(other)))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(not(is(other)))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(equalToIgnoringCase(VALUE))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(containsString(lue))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(not(containsString(other)))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(startsWith(val))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(endsWith(lue))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(anyOf(startsWith(val), endsWith(lue)))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(allOf(startsWith(val), endsWith(lue)))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(isEmptyString())@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(not(isEmptyString()))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(isEmptyOrNullString())@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(nullValue())@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(notNullValue())@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(empty())@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(not(empty())@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(greaterThan(4))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(allOf(greaterThan(4), lessThan(6), not(lessThan(5)))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(is(not(greaterThan(5))))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(greaterThanOrEqualTo(5))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(lessThan(5))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(not(lessThan(1)))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(lessThanOrEqualTo(4))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(hasSize(5))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(closeTo(9.0))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(closeTo(9.0, 0.5))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(isIn(foo, bar))@&lt;/someValue&gt;
&lt;someValue&gt;@assertThat(isOneOf(foo, bar))@&lt;/someValue&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus will automatically perform validation matchers on the element value. Only if all matchers are satisfied the validation will pass.</p>
</div>
</div>
<div class="sect2">
<h3 id="matcher-ignore-new-line"><a class="anchor" href="#matcher-ignore-new-line"></a><a class="link" href="#matcher-ignore-new-line">40.16. ignoreNewLine()</a></h3>
<div class="paragraph">
<p>This matcher implementation checks for equality with prior normalization of all new line characters. This includes new line types CR, LF and CRLF as well as multiple new lines in value and control value. So when using
this validation matcher all new line characters are removed prior to checking for equality.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s assume that we have a value with new lines that we want to validate using the matcher implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">&lt;value&gt;This
is
a
value with lots of
new lines&lt;/value&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now skip all new line characters in your control value using the <code>ignoreNewLine</code> matcher.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;value&gt;@ignoreNewLine('This is a value with lots of new lines')@&lt;/value&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the new line characters are not breaking the validation. The other whitespace characters remain untouched though.</p>
</div>
</div>
<div class="sect2">
<h3 id="matcher-trim-whitespace"><a class="anchor" href="#matcher-trim-whitespace"></a><a class="link" href="#matcher-trim-whitespace">40.17. trim()</a></h3>
<div class="paragraph">
<p>This trim matcher will remove leading and trailing whitespaces before checking for equality.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s assume that we have a value with leading and trailing whitespaces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">&lt;value&gt;
This is a value   &lt;/value&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now skip all leading and trailing whitespaces in your control value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;value&gt;@trim('This is a value')@&lt;/value&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="matcher-trim-all-whitespace"><a class="anchor" href="#matcher-trim-all-whitespace"></a><a class="link" href="#matcher-trim-all-whitespace">40.18. trimAllWhitespaces()</a></h3>
<div class="paragraph">
<p>Sometimes it is necessary to check equality of some value without caring for whitespaces at all. The matcher implementation will remove all whitespaces before checking for equality.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">&lt;value&gt;   some value   &lt;/value&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now skip all whitespaces in your control value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;value&gt;@trimAllWhitespaces('somevalue')@&lt;/value&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="matcher-is-uuid-v4"><a class="anchor" href="#matcher-is-uuid-v4"></a><a class="link" href="#matcher-is-uuid-v4">40.19. isUUIDv4()</a></h3>
<div class="paragraph">
<p>This validation matcher checks if a valid UUID version 4 is present.
Given the <code>&lt;variable name="validUuid" value="653ce6fd-dca4-4672-bbc0-16e2b74b8b81"/&gt;</code>, usage is as following.</p>
</div>
<div class="listingblock">
<div class="title">Example <code>isUUIDv4()</code> validation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;actions&gt;
    &lt;send endpoint="helloEndpoint"&gt;
        &lt;message&gt;
            &lt;data&gt;Hello Citrus!&lt;/data&gt;
        &lt;/message&gt;
        &lt;header&gt;
            &lt;element name="message-id" value="${validUuid}"/&gt;
        &lt;/header&gt;
    &lt;/send&gt;

    &lt;receive endpoint="helloEndpoint"&gt;
        &lt;message type="plaintext"&gt;
            &lt;data&gt;Hello Citrus!&lt;/data&gt;
        &lt;/message&gt;
        &lt;header&gt;
            &lt;element name="message-id" value="@isUUIDv4()@"/&gt;
        &lt;/header&gt;
    &lt;/receive&gt;
&lt;/actions&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="agent"><a class="anchor" href="#agent"></a><a class="link" href="#agent">41. Citrus agent</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Citrus agent provides a way to run tests as part of the Docker container environment and as part of the Kubernetes platform.</p>
</div>
<div class="paragraph">
<p>The agent ships as a web application and users are able to run Citrus tests on demand.
Usually the agent application runs as a Docker container or Kubernetes deployment so that the agent is able to access internal platform services such as Knative eventing brokers or a service resources exposed only to the current Kubernetes namespace.</p>
</div>
<div class="paragraph">
<p>The agent application exposes a REST service API for clients to inject tests and trigger test runs.</p>
</div>
<div class="sect2">
<h3 id="agent-service"><a class="anchor" href="#agent-service"></a><a class="link" href="#agent-service">41.1. Agent REST service API</a></h3>
<div class="paragraph">
<p>As a web application the agent exposes several REST endpoints.
Http clients are able to trigger test runs and inspect the remote test results.</p>
</div>
<div class="paragraph">
<p>At service startup the agent will automatically run all tests that can be found according to certain criteria.
The agent performs a test scan looking for available tests on multiple sources applying multiple search criteria:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>name pattern: Tests that should be executed must match one of the given class name patterns (e.g. <code>.*IT</code>)</p>
</li>
<li>
<p>packages: List of packages to scan in the agent classpath. All tests matching the given name patterns will be executed.</p>
</li>
<li>
<p>source files: List of source file paths to test sources (e.g. XML, YAML, Cucumber feature). All sources found will be run.</p>
</li>
<li>
<p>test-jar: A provided Java archive holding test classes for execution. All previous test filters (e.g. name patterns, package filters) get applied while scanning classes in this JAR.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
A test-jar that holds all tests and its dependencies can be injected into the agent application classpath. When using a Docker container image this injection may be accomplished through Docker volumes. In Kubernetes the test-jar injection may be done via ConfigMaps and volume mounts on the citrus-agent deployment.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The citrus-agent may also run tests on demand rather than on startup.
The agent provides a REST service endpoint to trigger a test run.
Each call to the service API may use different settings and test run criteria (e.g. name patterns, packages, source files).</p>
</div>
<div class="paragraph">
<p>The agent REST API provides these operations:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. REST service operations</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operation</th>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/health</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides general agent service status as a Json object (UP: true/false)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/run</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Triggers a new test run. The request query parameters may define the test run settings (e.g. name pattern, packages, source files). The operation blocks until the test run is finished and the response represents the test result summary using proper Http response codes for failure (500 INTERNAL_SERVER_ERROR) and success (200 OK).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/run</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">POST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Triggers a new test run. The request body may be a test configuration object that specifies the test run (e.g. name pattern, packages, source files). The operation blocks until the test run is finished and the response represents the test result summary using proper Http response codes for failure (500 INTERNAL_SERVER_ERROR) and success (200 OK).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/run</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as GET/POST run operation but the call is not blocking until the test run is finished. Instead of this clients may inspect the test results calling/polling the <code>/results</code> service endpoint.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/results</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get cumulated test results for this agent. This represents the overall test results for all tests that have been run on this agent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/results/latest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the most recent test results for the latest test run. This also includes results from a pending test run which may deliver partial test results (Http response code partial 206). This way clients can check on when the current test run is finished or still pending.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/results/clear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clear the cumulated test results to start fresh.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/results/files</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get test results files that have been created as part of the test run. This includes JUnit test reports and HTML Citrus test suite reports.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="agent-configuration"><a class="anchor" href="#agent-configuration"></a><a class="link" href="#agent-configuration">41.2. Configuration</a></h3>
<div class="paragraph">
<p>The agent reads general settings on startup from system properties and environment variables.
The environment settings are well suited for both usual Java runtime environment and containerized runtime environments such as Docker containers or Kubernetes deployments.</p>
</div>
<div class="paragraph">
<p>The Citrus agent application supports the following settings.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. System properties</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">System properties</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.agent.name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of this agent instance. Default value is <code>citrus-agent</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.agent.server.port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The port to listen on for incoming client requests. Default port is <code>4567</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.agent.test.engine</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default engine used to run tests on this agent. One of junit, junit5, testng, cucumber. Default is <code>junit5</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.agent.time.to.live</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time to wait after the tests have run as part of the startup procedure. Default is <code>-1</code> which means indefinite.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.agent.system.exit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should use system exit to mark test failure (e.g. system exit = -1). Default is <code>false</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.agent.skip.tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test execution should bee skipped at server startup. Default is <code>false</code> which means that all tests found are automatically run as part of the server startup procedure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.agent.includes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of test name patterns to include in test runs. The server searches for tests matching these patterns when running all available tests. Default patterns are <code>["^.<strong>IT$", "^.*ITCase$", "^IT.</strong>$"]</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.agent.packages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of packages to include in test scan.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.agent.default.properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comma separated list of key-value pairs that represent default system properties for a test run.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.agent.test.sources</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of test source paths to run. This may be paths to XML, YAML, Cucumber feature files that the agent should run as part of a test run.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.agent.config.class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean configuration class to load as part of a test run.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.agent.test.jar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path to a test Java archive that hold tests for a test run. Default value is <code>classpath:citrus-agent-tests.jar</code>. The test-jar execution is skipped when the file does not exist.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Same properties are settable via environment variables.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Environment variables</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Environment variable</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_AGENT_NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of this agent instance. Default value is <code>citrus-agent</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_AGENT_SERVER_PORT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The port to listen on for incoming client requests. Default port is <code>4567</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_AGENT_TEST_ENGINE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default engine used to run tests on this agent. One of junit, junit5, testng, cucumber. Default is <code>junit5</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_AGENT_TIME_TO_LIVE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time to wait after the tests have run as part of the startup procedure. Default is <code>-1</code> which means indefinite.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_AGENT_SYSTEM_EXIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should use system exit to mark test failure (e.g. system exit = -1). Default is <code>false</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_AGENT_SKIP_TESTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test execution should bee skipped at server startup. Default is <code>false</code> which means that all tests found are automatically run as part of the server startup procedure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_AGENT_INCLUDES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of test name patterns to include in test runs. The server searches for tests matching these patterns when running all available tests. Default patterns are <code>["^.<strong>IT$", "^.*ITCase$", "^IT.</strong>$"]</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_AGENT_PACKAGES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of packages to include in test scan.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_AGENT_DEFAULT_PROPERTIES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comma separated list of key-value pairs that represent default system properties for a test run.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_AGENT_TEST_SOURCES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of test source paths to run. This may be paths to XML, YAML, Cucumber feature files that the agent should run as part of a test run.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_AGENT_CONFIG_CLASS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean configuration class to load as part of a test run.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_AGENT_TEST_JAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path to a test Java archive that hold tests for a test run. Default value is <code>classpath:citrus-agent-tests.jar</code>. The test-jar execution is skipped when the file does not exist.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="agent-ui"><a class="anchor" href="#agent-ui"></a><a class="link" href="#agent-ui">41.3. Web UI</a></h3>
<div class="paragraph">
<p>The Citrus agent application provides a Web user interface for clients to inspect previous test runs.
You can access the user interface pointing your browser to the exposed server port.
By default, when running the agent service locally (e.g. via JBang) the exposed Web UI endpoint is <a href="http://localhost:4567">http://localhost:4567</a>.</p>
</div>
<div class="paragraph">
<p>When run on Docker or Kubernetes the exposed port may be mapped to a local port or Service resource that you can access with the browser.</p>
</div>
</div>
<div class="sect2">
<h3 id="agent-docker-image"><a class="anchor" href="#agent-docker-image"></a><a class="link" href="#agent-docker-image">41.4. Docker container image</a></h3>
<div class="paragraph">
<p>The Citrus agent also ships as a Docker container image that you can use to run the agent as a Docker container or as part of a Kubernetes deployment.
The Docker image is available on this <a href="https://quay.io/repository/citrusframework/citrus-agent">Quay.io repository</a>.</p>
</div>
<div class="paragraph">
<p>You can use the image in a Kubernetes deployment:</p>
</div>
<div class="listingblock">
<div class="title">Citrus agent deployment</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/managed-by: citrus
    app.kubernetes.io/name: citrus-agent
  name: citrus-agent
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: citrus-agent
  template:
    metadata:
      labels:
        app.kubernetes.io/managed-by: citrus
        app.kubernetes.io/name: citrus-agent
    spec:
      containers:
      - name: citrus-agent
        env:
        - name: CITRUS_AGENT_SERVER_PORT
          value: "8080"
        image: quay.io/citrusframework/citrus-agent:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Deployment may use the environment variables to customize the Citrus agent application. The container exposes the Http port so you can access the Web UI with a Service resource.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can inject a test jar that contains the tests to run with the agent. Just use a ConfigMap with the archive as binary content and mount the JAR into the Citrus agent pod with volumes.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Test jar ConfigMap</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: citrus-agent-resources
  labels:
    app.kubernetes.io/managed-by: citrus
    app.kubernetes.io/name: citrus-agent
binaryData:
  citrus-agent-tests.jar: |
    [...]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Citrus agent with volumes</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/managed-by: citrus
    app.kubernetes.io/name: citrus-agent
  name: citrus-agent
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: citrus-agent
  template:
    metadata:
      labels:
        app.kubernetes.io/managed-by: citrus
        app.kubernetes.io/name: citrus-agent
    spec:
      containers:
      - name: citrus-agent
        env:
        - name: CITRUS_AGENT_TEST_JAR
          value: /deployments/resources/citrus-agent-tests.jar
        - name: CITRUS_AGENT_SERVER_PORT
          value: "8080"
        image: quay.io/citrusframework/citrus-agent:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        volumeMounts:
        - mountPath: /deployments/resources
          name: resources
      volumes:
      - name: resources
        configMap:
          defaultMode: 420
          name: citrus-agent-resources</code></pre>
</div>
</div>
<div class="paragraph">
<p>The volume mount adds the binary content from the ConfigMap to the Pod and the Citrus agent application will be able to run the tests from that Java archive.</p>
</div>
<div class="paragraph">
<p>You may also use a ConfigMap that holds other test sources such as XML, YAML, Groovy or Cucumber test files.</p>
</div>
</div>
<div class="sect2">
<h3 id="agent-jbang"><a class="anchor" href="#agent-jbang"></a><a class="link" href="#agent-jbang">41.5. Agent JBang commands</a></h3>
<div class="paragraph">
<p>The JBang integration is a perfect way to run the agent locally suited very well for rapid prototyping.</p>
</div>
<div class="paragraph">
<p>The Citrus JBang command line tooling supports several agent related commands:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. JBang agent commands</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">command</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">agent start</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start the Citrus agent application as a local JBang process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">agent stop</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stop the current agent process.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="agent-maven-plugin"><a class="anchor" href="#agent-maven-plugin"></a><a class="link" href="#agent-maven-plugin">41.6. Maven plugin</a></h3>
<div class="paragraph">
<p>The Citrus agent provides a Maven plugin that you can include into your project build lifecycle.
You can use the plugin to build a <code>test-jar</code> from your local test sources.
The plugin will then start a new Citrus agent service (e.g. in Kubernetes) and run the tests from the <code>test-jar</code> artifact.
The plugin waits for the remote test execution to finish and provides the test results to the local Maven build.</p>
</div>
<div class="paragraph">
<p>The Citrus agent Maven plugin provides these goals to execute:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Goals</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Goal</th>
<th class="tableblock halign-left valign-top">Build phase</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">test-jar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">package</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Builds a test JAR artifact from your test scoped sources</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">start</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pre-integration-test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create and run a new Citrus agent application instance (locally via JBang, as a Docker container or as a Kubernetes deployment)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">run</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">integration-test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run the tests from the test-jar artifact in the agent service (e.g. the tests run as part of the Kubernetes platform)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">stop</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">post-integration-test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stop the agent service</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">verify</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">verify</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Verify the remote test results and make sure that tests have executed successfully</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Each Maven plugin goal is bound to a default Maven build lifecycle phase.
Like the Maven failsafe plugin the Citrus agent plugin binds its goals to the Maven <code>integration-test</code> phases in the build lifecycle.</p>
</div>
<div class="paragraph">
<p>The agent plugin makes sure to run the <code>post-integration-test</code> phase even when tests are failing.
The plugin propagates the remote test execution results to the local Maven build so the <code>verify</code> goal is able to fail the build in case of failed tests.</p>
</div>
<div class="paragraph">
<p>A typical usage example for the Citrus agent Maven plugin looks like follows:</p>
</div>
<div class="listingblock">
<div class="title">Maven POM</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;plugin&gt;
  &lt;groupId&gt;org.citrusframework.mvn&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-agent-maven-plugin&lt;/artifactId&gt;
  &lt;version&gt;${project.version}&lt;/version&gt;
  &lt;configuration&gt;
    &lt;run&gt;
      &lt;async&gt;true&lt;/async&gt;
    &lt;/run&gt;
    &lt;kubernetes&gt;
      &lt;enabled&gt;true&lt;/enabled&gt;
    &lt;/kubernetes&gt;
  &lt;/configuration&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;id&gt;citrus-agent-tests&lt;/id&gt;
      &lt;goals&gt;
        &lt;goal&gt;test-jar&lt;/goal&gt;
        &lt;goal&gt;start&lt;/goal&gt;
        &lt;goal&gt;test&lt;/goal&gt;
        &lt;goal&gt;stop&lt;/goal&gt;
        &lt;goal&gt;verify&lt;/goal&gt;
      &lt;/goals&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above uses the Citrus agent Maven plugin amd binds its individual goals to the Maven build lifecycle.
In this example the Kubernetes support is enabled.
This means that the Citrus agent service will be started as a Deployment on the current Kubernetes cluster.
Please make sure to connect to the Kubernetes cluster before the Maven build (e.g. via <code>kubectl</code>).</p>
</div>
<div class="paragraph">
<p>The plugin uses the Kubernetes client to create the agent service as a deployment.
It creates a ConfigMap from the built test-jar Java archive and makes sure the agent service has access to it (e.g. via volume mounts).
It connects to the service and triggers the test run on the agent.
It waits for the tes run to finish properly and the remote test results are propagated to the local Maven build.
It verifies the test results and makes the local Maven build fail in case of test failures or errors.
It automatically removes the Citrus agent service deployment and its related resources from the Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>When the local Maven build is successful you can be sure that all tests have run successful on the agent.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="data-dictionaries"><a class="anchor" href="#data-dictionaries"></a><a class="link" href="#data-dictionaries">42. Data dictionaries</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Data dictionaries in Citrus provide a new way to manipulate message payload data before a message is sent or received. The dictionary defines a set of keys and respective values. Just like every other dictionary it is used to translate things. In our case we translate message data elements.</p>
</div>
<div class="paragraph">
<p>You can translate common message elements that are used widely throughout your domain model. As Citrus deals with different types of message data (e.g. XML, JSON) we have different dictionary implementations that are described in the next sections.</p>
</div>
<div class="sect2">
<h3 id="xml-data-dictionaries"><a class="anchor" href="#xml-data-dictionaries"></a><a class="link" href="#xml-data-dictionaries">42.1. XML data dictionaries</a></h3>
<div class="paragraph">
<p>As you would expect XML data dictionaries can be used together with XML formatted message payloads. To do so a dictionary has to be added to the basic Citrus Spring application context which will make the dictionary visible to all test cases:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public NodeMappingDataDictionary nodeMappingDataDictionary() {
    NodeMappingDataDictionary dictionary = new NodeMappingDataDictionary();
    dictionary.getMappings().put("TestMessage.MessageId", "${messageId}");
    dictionary.getMappings().put("TestMessage.CorrelationId", "${correlationId}");
    dictionary.getMappings().put("TestMessage.User", "Christoph");
    dictionary.getMappings().put("TestMessage.TimeStamp", "citrus:currentDate()");
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public NodeMappingDataDictionary nodeMappingDataDictionary() {
    NodeMappingDataDictionary dictionary = new NodeMappingDataDictionary();
    dictionary.getMappings().put("TestMessage.MessageId", "${messageId}");
    dictionary.getMappings().put("TestMessage.CorrelationId", "${correlationId}");
    dictionary.getMappings().put("TestMessage.User", "Christoph");
    dictionary.getMappings().put("TestMessage.TimeStamp", "citrus:currentDate()");
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:xml-data-dictionary id="nodeMappingDataDictionary"&gt;
  &lt;citrus:mappings&gt;
    &lt;citrus:mapping path="TestMessage.MessageId" value="${messageId}"/&gt;
    &lt;citrus:mapping path="TestMessage.CorrelationId" value="${correlationId}"/&gt;
    &lt;citrus:mapping path="TestMessage.User" value="Christoph"/&gt;
    &lt;citrus:mapping path="TestMessage.TimeStamp" value="citrus:currentDate()"/&gt;
  &lt;/citrus:mappings&gt;
&lt;/citrus:xml-data-dictionary&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the dictionary is nothing but a normal Spring bean definition. The <strong>NodeMappingDataDictionary</strong> implementation receives a map of key value pairs where the key is a message element path expression. For XML payloads the message element tree is traversed so the path expression is built for an exact message element inside the payload. When matched the respective value is set according to the value stored within the dictionary.</p>
</div>
<div class="paragraph">
<p>Alternatively the key-value mappings can be defined in an external file and a reference to the file can be provided:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public NodeMappingDataDictionary nodeMappingDataDictionary() {
    NodeMappingDataDictionary dictionary = new NodeMappingDataDictionary();
    dictionary.setMappingFile("classpath:sample-dictionary.properties");
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public NodeMappingDataDictionary nodeMappingDataDictionary() {
    NodeMappingDataDictionary dictionary = new NodeMappingDataDictionary();
    dictionary.setMappingFile("classpath:sample-dictionary.properties");
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:xml-data-dictionary id="nodeMappingDataDictionary"&gt;
  &lt;citrus:mapping-file path="classpath:sample-dictionary.properties"/&gt;
&lt;/citrus:xml-data-dictionary&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The mapping file content just looks like a normal property file in Java:</p>
</div>
<div class="listingblock">
<div class="title">sample-dictionary.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">TestMessage.MessageId=${messageId}
TestMessage.CorrelationId=${correlationId}
TestMessage.User=Christoph
TestMessage.TimeStamp=citrus:currentDate()</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can set any message element value inside the XML message payload. The path expression also supports XML attributes. Just use the attribute name as the last part of the path expression. Let us have a closer look at a sample XML message payload with attributes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;TestMessage&gt;
  &lt;User name="Christoph" age="18"/&gt;
&lt;/TestMessage&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using this sample XML payload we can access the attributes in the data dictionary as follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public NodeMappingDataDictionary nodeMappingDataDictionary() {
    NodeMappingDataDictionary dictionary = new NodeMappingDataDictionary();
    dictionary.getMappings().put("TestMessage.User.name", "${userName}");
    dictionary.getMappings().put("TestMessage.User.age", "${userAge}");
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public NodeMappingDataDictionary nodeMappingDataDictionary() {
    NodeMappingDataDictionary dictionary = new NodeMappingDataDictionary();
    dictionary.getMappings().put("TestMessage.User.name", "${userName}");
    dictionary.getMappings().put("TestMessage.User.age", "${userAge}");
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:xml-data-dictionary id="nodeMappingDataDictionary"&gt;
  &lt;citrus:mappings&gt;
    &lt;citrus:mapping path="TestMessage.User.name" value="${userName}"/&gt;
    &lt;citrus:mapping path="TestMessage.User.age" value="${userAge}"/&gt;
  &lt;/citrus:mappings&gt;
&lt;/citrus:xml-data-dictionary&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>NodeMappingDataDictionary</strong> implementation is easy to use and can be used with most basic XML payloads.</p>
</div>
<div class="paragraph">
<p>For more complex XML payloads where more flexibility is required the XPath data dictionaries may be better suited:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public NodeMappingDataDictionary nodeMappingDataDictionary() {
    NodeMappingDataDictionary dictionary = new NodeMappingDataDictionary();
    dictionary.setMappingFile("classpath:sample-dictionary.properties");
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public NodeMappingDataDictionary nodeMappingDataDictionary() {
    NodeMappingDataDictionary dictionary = new NodeMappingDataDictionary();
    dictionary.setMappingFile("classpath:sample-dictionary.properties");
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:xpath-data-dictionary id="xpathMappingDataDictionary"&gt;
  &lt;citrus:mappings&gt;
    &lt;citrus:mapping path="//TestMessage/MessageId" value="${messageId}"/&gt;
    &lt;citrus:mapping path="//TestMessage/CorrelationId" value="${correlationId}"/&gt;
    &lt;citrus:mapping path="//TestMessage/User" value="Christoph"/&gt;
    &lt;citrus:mapping path="//TestMessage/User/@id" value="123"/&gt;
    &lt;citrus:mapping path="//TestMessage/TimeStamp" value="citrus:currentDate()"/&gt;
  &lt;/citrus:mappings&gt;
&lt;/citrus:xpath-data-dictionary&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As expected XPath mapping expressions are more powerful and can better handle complex scenarios with XML namespaces, attributes and node lists. Just like the node mapping dictionary the XPath mapping dictionary also supports variables, functions and an external mapping file.</p>
</div>
<div class="paragraph">
<p>XPath works fine with namespaces. In general it is good practice to define a namespace context where you map namespace URI values with prefix values. So your XPath expression is more precise and evaluation is strict. In Citrus the <strong>NamespaceContextBuilder</strong> which is also added as a normal Spring bean to the application context manages namespaces used in your XPath expressions. See our XML and XPath chapters in this documentation for detailed description how to accomplish fail-safe XPath expressions with namespaces.</p>
</div>
<div class="paragraph">
<p>This completes the XML data dictionary usage in Citrus. Later on we will see some more advanced data dictionary scenarios where we will discuss the usage of dictionary scopes and mapping strategies. But before that let us have a look at other message formats like JSON messages.</p>
</div>
</div>
<div class="sect2">
<h3 id="json-data-dictionaries"><a class="anchor" href="#json-data-dictionaries"></a><a class="link" href="#json-data-dictionaries">42.2. JSON data dictionaries</a></h3>
<div class="paragraph">
<p>JSON data dictionaries complement with XML data dictionaries. As usual we have to add the JSON data dictionary to the basic Spring application context first. Once this is done the data dictionary automatically applies for all JSON message payloads in Citrus. This means that all JSON messages sent and received get translated with the JSON data dictionary implementation.</p>
</div>
<div class="paragraph">
<p>Citrus uses message types in order to evaluate which data dictionary may fit to the message that is currently processed. As usual you can define the message type directly in your test case as attribute inside the sending and receiving message action.</p>
</div>
<div class="paragraph">
<p>Let us see a simple dictionary for JSON data:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public JsonPathMappingDataDictionary jsonMappingDataDictionary() {
    JsonPathMappingDataDictionary dictionary = new JsonPathMappingDataDictionary();
    dictionary.getMappings().put("TestMessage.MessageId", "${messageId}");
    dictionary.getMappings().put("TestMessage.CorrelationId", "${correlationId}");
    dictionary.getMappings().put("TestMessage.User", "Christoph");
    dictionary.getMappings().put("TestMessage.TimeStamp", "citrus:currentDate()");
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JsonPathMappingDataDictionary jsonMappingDataDictionary() {
    JsonPathMappingDataDictionary dictionary = new JsonPathMappingDataDictionary();
    dictionary.getMappings().put("TestMessage.MessageId", "${messageId}");
    dictionary.getMappings().put("TestMessage.CorrelationId", "${correlationId}");
    dictionary.getMappings().put("TestMessage.User", "Christoph");
    dictionary.getMappings().put("TestMessage.TimeStamp", "citrus:currentDate()");
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:json-data-dictionary id="jsonMappingDataDictionary"&gt;
  &lt;citrus:mappings&gt;
    &lt;citrus:mapping path="TestMessage.MessageId" value="${messageId}"/&gt;
    &lt;citrus:mapping path="TestMessage.CorrelationId" value="${correlationId}"/&gt;
    &lt;citrus:mapping path="TestMessage.User" value="Christoph"/&gt;
    &lt;citrus:mapping path="TestMessage.TimeStamp" value="citrus:currentDate()"/&gt;
  &lt;/citrus:mappings&gt;
&lt;/citrus:json-data-dictionary&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message path expressions do look very similar to those used in XML data dictionaries. Here the path expression keys do apply to the JSON object graph. See the following sample JSON data which perfectly applies to the dictionary expressions above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "TestMessage": {
      "MessageId": "1122334455",
      "CorrelationId": "100000001",
      "User": "Christoph",
      "TimeStamp": 1234567890
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The path expressions will match a very specific message element inside the JSON object graph. The dictionary will automatically set the message element values then. The path expressions are easy to use as you can traverse the JSON object graph very easy.</p>
</div>
<div class="paragraph">
<p>Of course the data dictionary does also support test variables, functions. Also very interesting is the usage of JSON arrays. A JSON array element is referenced in a data dictionary like this:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public JsonPathMappingDataDictionary jsonMappingDataDictionary() {
    JsonPathMappingDataDictionary dictionary = new JsonPathMappingDataDictionary();
    dictionary.getMappings().put("TestMessage.Users[0]", "Christoph");
    dictionary.getMappings().put("TestMessage.Users[1]", "Julia");
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JsonPathMappingDataDictionary jsonMappingDataDictionary() {
    JsonPathMappingDataDictionary dictionary = new JsonPathMappingDataDictionary();
    dictionary.getMappings().put("TestMessage.Users[0]", "Christoph");
    dictionary.getMappings().put("TestMessage.Users[1]", "Julia");
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:json-data-dictionary id="jsonMappingDataDictionary"&gt;
  &lt;citrus:mappings&gt;
    &lt;citrus:mapping path="TestMessage.Users[0]" value="Christoph"/&gt;
    &lt;citrus:mapping path="TestMessage.Users[1]" value="Julia"/&gt;
  &lt;/citrus:mappings&gt;
&lt;/citrus:json-data-dictionary&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>Users</strong> element is a JSON array, so we can access the elements with index. Nesting JSON objects and arrays is also supported so you can also handle more complex JSON data.</p>
</div>
<div class="paragraph">
<p>The <strong>JsonMappingDataDictionary</strong> implementation is easy to use and fits the basic needs for JSON data dictionaries. The message element path expressions are very simple and do fit basic needs.
However, when more complex JSON payloads apply for translation we might reach the boundaries here.</p>
</div>
<div class="paragraph">
<p>For more complex JSON message payloads JsonPath data dictionaries are very effective:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public JsonPathMappingDataDictionary jsonMappingDataDictionary() {
    JsonPathMappingDataDictionary dictionary = new JsonPathMappingDataDictionary();
    dictionary.getMappings().put("$.TestMessage.MessageId", "${messageId}");
    dictionary.getMappings().put("$..CorrelationId", "${correlationId}");
    dictionary.getMappings().put("$..Users[0]", "Christoph");
    dictionary.getMappings().put("$.TestMessage.TimeStamp", "citrus:currentDate()");
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JsonPathMappingDataDictionary jsonMappingDataDictionary() {
    JsonPathMappingDataDictionary dictionary = new JsonPathMappingDataDictionary();
    dictionary.getMappings().put("$.TestMessage.MessageId", "${messageId}");
    dictionary.getMappings().put("$..CorrelationId", "${correlationId}");
    dictionary.getMappings().put("$..Users[0]", "Christoph");
    dictionary.getMappings().put("$.TestMessage.TimeStamp", "citrus:currentDate()");
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:json-path-data-dictionary id="jsonMappingDataDictionary"&gt;
  &lt;citrus:mappings&gt;
    &lt;citrus:mapping path="$.TestMessage.MessageId" value="${messageId}"/&gt;
    &lt;citrus:mapping path="$..CorrelationId" value="${correlationId}"/&gt;
    &lt;citrus:mapping path="$..Users[0]" value="Christoph"/&gt;
    &lt;citrus:mapping path="$.TestMessage.TimeStamp" value="citrus:currentDate()"/&gt;
  &lt;/citrus:mappings&gt;
&lt;/citrus:json-path-data-dictionary&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>JsonPath mapping expressions are way more powerful and can also handle very complex scenarios. You can apply for all elements named <em>CorrelationId</em> in one single entry for instance.</p>
</div>
</div>
<div class="sect2">
<h3 id="dictionary-scopes"><a class="anchor" href="#dictionary-scopes"></a><a class="link" href="#dictionary-scopes">42.3. Dictionary scopes</a></h3>
<div class="paragraph">
<p>Now that we have learned how to add data dictionaries to Citrus we need to discuss some advanced topics. Data dictionary scopes do define the boundaries where the dictionary may apply. By default, data dictionaries are global scope dictionaries. This means that the data dictionary applies to all messages sent and received with Citrus. Of course message types are considered so XML data dictionaries do only apply to XML message types. However, global scope dictionaries will be activated throughout all test cases and actions.</p>
</div>
<div class="paragraph">
<p>You can overwrite the dictionary scope. For instance in order to use an explicit scope. When this is done the dictionary wil not apply automatically but the user has to explicitly set the data dictionary in sending or receiving test action. This way you can activate the dictionary to a very special set of test actions.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public NodeMappingDataDictionary nodeMappingDataDictionary() {
    NodeMappingDataDictionary dictionary = new NodeMappingDataDictionary();
    dictionary.setMappingFile("classpath:sample-dictionary.properties");
    dictionary.setGlobalScope(false);
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public NodeMappingDataDictionary nodeMappingDataDictionary() {
    NodeMappingDataDictionary dictionary = new NodeMappingDataDictionary();
    dictionary.setMappingFile("classpath:sample-dictionary.properties");
    dictionary.setGlobalScope(false);
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:xml-data-dictionary id="specialDataDictionary" global-scope="false"&gt;
  &lt;citrus:mapping-file path="classpath:sample-dictionary.properties"/&gt;
&lt;/citrus:xml-data-dictionary&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We set the global scope property to <strong>false</strong> so the dictionary is handled in explicit scope. This means that you have to set the data dictionary explicitly in your test actions:</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void dictionaryTest() {
    $(send(myEndpoint)
        .message()
        .body("&lt;TestMessage&gt;Hello Citrus&lt;/TestMessage&gt;")
        .dictionary("specialDataDictionary"));
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="DictionaryTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;send endpoint="myEndpoint"&gt;
            &lt;message data-dictionary="specialDataDictionary"&gt;
                &lt;body&gt;
                    &lt;data&gt;
                    &lt;![CDATA[
                        &lt;TestMessage&gt;Hello Citrus&lt;/TestMessage&gt;
                    ]]&gt;
                    &lt;/data&gt;
                &lt;/body&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: DictionaryTest
actions:
  - send:
      endpoint: "myEndpoint"
      message:
        dataDictionary: specialDataDictionary
        body: |
          &lt;TestMessage&gt;Hello Citrus&lt;/TestMessage&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="DictionaryTest"&gt;
        &lt;actions&gt;
            &lt;send endpoint="myEndpoint"&gt;
                &lt;message data-dictionary="specialDataDictionary"&gt;
                    &lt;data&gt;
                    &lt;![CDATA[
                        &lt;TestMessage&gt;Hello Citrus&lt;/TestMessage&gt;
                    ]]&gt;
                    &lt;/data&gt;
                &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sample above is a sending test action with an explicit data dictionary reference set. Before sending the message the dictionary is asked for translation. So all matching message element values will be set by the dictionary accordingly. Other global data dictionaries do also apply for this message but the explicit dictionary will always overwrite the message element values.</p>
</div>
</div>
<div class="sect2">
<h3 id="path-mapping-strategies"><a class="anchor" href="#path-mapping-strategies"></a><a class="link" href="#path-mapping-strategies">42.4. Path mapping strategies</a></h3>
<div class="paragraph">
<p>Another advanced topic about data dictionaries is the path mapping strategy. When using simple path expressions the default strategy is always <strong>EXACT</strong> . This means that the path expression has to evaluate exactly to a message element within the payload data. And only this exact message element is translated.</p>
</div>
<div class="paragraph">
<p>You can set your own path mapping strategy in order to change this behavior. For instance another mapping strategy would be <strong>STARS_WITH</strong> . All elements are translated that start with a certain path expression. Let us clarify this with an example:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public NodeMappingDataDictionary nodeMappingDataDictionary() {
    NodeMappingDataDictionary dictionary = new NodeMappingDataDictionary();
    dictionary.getMappings().put("TestMessage.Property", "citrus:randomString()");
    dictionry.setPathMappingStrategy(PathMappingStrategy.STARTS_WITH);
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public NodeMappingDataDictionary nodeMappingDataDictionary() {
    NodeMappingDataDictionary dictionary = new NodeMappingDataDictionary();
    dictionary.getMappings().put("TestMessage.Property", "citrus:randomString()");
    dictionry.setPathMappingStrategy(PathMappingStrategy.STARTS_WITH);
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:xml-data-dictionary id="nodeMappingDataDictionary" mapping-strategy="STARTS_WITH"&gt;
  &lt;citrus:mappings&gt;
    &lt;citrus:mapping path="TestMessage.Property" value="citrus:randomString()"/&gt;
  &lt;/citrus:mappings&gt;
&lt;/citrus:xml-data-dictionary&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now with the path mapping strategy set to <strong>STARS_WITH</strong> all message element path expressions starting with <strong>TestMessage.Property</strong> will find translation in this dictionary. Following sample message payload would be translated accordingly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;TestMessage&gt;
    &lt;Property&gt;XXX&lt;/Property&gt;
    &lt;PropertyName&gt;XXX&lt;/PropertyName&gt;
    &lt;PropertyValue&gt;XXX&lt;/PropertyValue&gt;
&lt;/TestMessage&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>All child elements of <strong>TestMessage</strong> starting with <strong>Property</strong> will be translated with this data dictionary. In the resulting message payload Citrus will use a random string as value for these elements as we used the <strong>citrus:randomString()</strong> function in the dictionary mapping.</p>
</div>
<div class="paragraph">
<p>The next mapping strategy would be <strong>ENDS_WITH</strong> . No surprises here - this mapping strategy looks for message elements that end with a certain path expression. Again a simple example will clarify this for you.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public NodeMappingDataDictionary nodeMappingDataDictionary() {
    NodeMappingDataDictionary dictionary = new NodeMappingDataDictionary();
    dictionary.getMappings().put("Id", "citrus:randomNumber()");
    dictionry.setPathMappingStrategy(PathMappingStrategy.ENDS_WITH);
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public NodeMappingDataDictionary nodeMappingDataDictionary() {
    NodeMappingDataDictionary dictionary = new NodeMappingDataDictionary();
    dictionary.getMappings().put("Id", "citrus:randomNumber()");
    dictionry.setPathMappingStrategy(PathMappingStrategy.ENDS_WITH);
    return dictionary;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus:xml-data-dictionary id="nodeMappingDataDictionary" mapping-strategy="ENDS_WITH"&gt;
  &lt;citrus:mappings&gt;
    &lt;citrus:mapping path="Id" value="citrus:randomNumber()"/&gt;
  &lt;/citrus:mappings&gt;
&lt;/citrus:xml-data-dictionary&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again let us see some sample message payload for this dictionary usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;TestMessage&gt;
  &lt;RequestId&gt;XXX&lt;/RequestId&gt;
  &lt;Properties&gt;
    &lt;Property&gt;
      &lt;PropertyId&gt;XXX&lt;/PropertyId&gt;
      &lt;PropertyValue&gt;XXX&lt;/PropertyValue&gt;
    &lt;/Property&gt;
    &lt;Property&gt;
      &lt;PropertyId&gt;XXX&lt;/PropertyId&gt;
      &lt;PropertyValue&gt;XXX&lt;/PropertyValue&gt;
    &lt;/Property&gt;
  &lt;/Properties&gt;
&lt;/TestMessage&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this sample all message elements ending with <strong>Id</strong> would be translated with a random number. No matter where in the message tree the elements are located. This is quite useful but also very powerful. So be careful to use this strategy in global data dictionaries as it may translate message elements that you would not expect in the first place.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="test-actors"><a class="anchor" href="#test-actors"></a><a class="link" href="#test-actors">43. Test actors</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The concept of test actors is a way to enable/disable a group of tests actions and message endpoints based on configuration.
Test actors help you to use the same tests in different environments where some of the participating services may be available or need to be simulated by Citrus.
In particular in end-to-end test scenarios some interface partners may be deployed and ready for participating in the test.
In other environments no interface partners are available and Citrus needs to simulate all interfaces accordingly.
Test actors allows us to use the very same test definition in both environments by just adjusting the Citrus configuration.</p>
</div>
<div class="paragraph">
<p>Usually Citrus simulates all interface partners within a test case which is great for continuous integration testing where just the System Under Test is deployed and all surrounding infrastructure and partners get simulated.
In end-to-end integration test scenarios some of our interface partners may be deployed and online.
Some other interface partners still require Citrus simulation logic.</p>
</div>
<div class="paragraph">
<p>It would be great if we were able to reuse the Citrus integration tests in all of these described test environments.
The Citrus test describes the complete test flow of messages, we only have to remove the simulated send/receive actions for those interface partner applications that are deployed and available in an end-to-end test setup.</p>
</div>
<div class="paragraph">
<p>With test actors we have the opportunity to link test actions, in particular send/receive message actions, to a named actor.
The test actor can be enabled/disabled via configuration and following from that all linked test actions are enabled/disabled, too.</p>
</div>
<div class="paragraph">
<p>This means the same Citrus test case is runnable with different test actor configurations where some services are deployed as real applications and others may require simulation by Citrus.</p>
</div>
<div class="sect2">
<h3 id="test-actors-create"><a class="anchor" href="#test-actors-create"></a><a class="link" href="#test-actors-create">43.1. Create test actors</a></h3>
<div class="paragraph">
<p>First thing to do is to define one or more test actors in the Citrus configuration.
A test actor represents a participating party (e.g. interface partner, backend application, service).</p>
</div>
<div class="paragraph">
<p>We define the test actors as beans and add them to the Citrus bean registry.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry(name = "travel_agency")
public TestActor travelAgencyActor() {
    return new TestActor("travel_agency");
}

@BindToRegistry(name = "royal_airline")
public TestActor royalAirlineActor() {
    return new TestActor("royal_airline");
}

@BindToRegistry(name = "smart_ariline")
public TestActor smartAirlineActor() {
    return new TestActor("smart_ariline");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean(name = "travel_agency")
public TestActor travelAgencyActor() {
    return new TestActor("travel_agency");
}

@Bean(name = "royal_airline")
public TestActor royalAirlineActor() {
    return new TestActor("royal_airline");
}

@Bean(name = "smart_ariline")
public TestActor smartAirlineActor() {
    return new TestActor("smart_ariline");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns:spring="http://www.springframework.org/schema/beans"
              xmlns:citrus="http://www.citrusframework.org/schema/config"&gt;
    &lt;citrus:actor id="travel_agency" name="TRAVEL_AGENCY"/&gt;
    &lt;citrus:actor id="royal_airline" name="ROYAL_AIRLINE"/&gt;
    &lt;citrus:actor id="smart_ariline" name="SMART_AIRLINE"/&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The listing above defines three test actors participating in our test scenario.
A <code>travel_agency</code> application which is simulated by Citrus as a calling client, the <code>smart_airline</code> application and a <code>royal_airline</code> application.
Now we have the test actors defined we can link those to message sender/receiver instances and/or test actions within our test case.</p>
</div>
</div>
<div class="sect2">
<h3 id="test-actors-reference"><a class="anchor" href="#test-actors-reference"></a><a class="link" href="#test-actors-reference">43.2. Reference test actors</a></h3>
<div class="paragraph">
<p>We need to reference the test actor and set it on a message send or receive action in our test case.
We can do this in two different ways.
First of all we can set a test actor reference on a message endpoint.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public JmsSyncEndpoint royalAirlineBookingEndpoint() {
    return JmsEndpoints.jms()
                .synchronous()
                .destination("${royal.airline.request.queue}")
                .actor(royalAirlineActor())
                .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public JmsSyncEndpoint royalAirlineBookingEndpoint() {
    return JmsEndpoints.jms()
                .synchronous()
                .destination("${royal.airline.request.queue}")
                .actor(royalAirlineActor())
                .build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-jms:sync-endpoint id="royalAirlineBookingEndpoint"
        destination-name="${royal.airline.request.queue}"
        actor="royal_airline"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now all test actions that are using this message endpoint are linked to the test actor.
In addition to that you can also explicitly link test actions to a test actor.</p>
</div>
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CitrusTest
public void airlineTest() {
    $(receive("royalAirlineBookingEndpoint")
        .message()
        .body("...")
        .actor("royal_airline")
    );

    $(send("royalAirlineBookingEndpoint")
        .message()
        .body("...")
        .actor("royal_airline")
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;test name="AirlineTest" xmlns="http://citrusframework.org/schema/xml/testcase"&gt;
    &lt;actions&gt;
        &lt;receive endpoint="royalAirlineBookingEndpoint" actor="royal_airline"&gt;
            &lt;message&gt;
                &lt;!-- ... --&gt;
            &lt;/message&gt;
        &lt;/receive&gt;

        &lt;send endpoint="royalAirlineBookingEndpoint" actor="royal_airline"&gt;
            &lt;message&gt;
                &lt;!-- ... --&gt;
            &lt;/message&gt;
        &lt;/send&gt;
    &lt;/actions&gt;
&lt;/test&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: AirlineTest
actions:
  - receive:
      endpoint: "royalAirlineBookingEndpoint"
      actor: "royal_airline"
      message: {}
  - send:
      endpoint: "royalAirlineBookingEndpoint"
      actor: "royal_airline"
      message: {}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"&gt;
    &lt;testcase name="AirlineTest"&gt;
        &lt;actions&gt;
            &lt;receive endpoint="royalAirlineBookingEndpoint" actor="royal_airline"&gt;
                &lt;message&gt;
                    &lt;!-- ... --&gt;
                &lt;/message&gt;
            &lt;/receive&gt;

            &lt;send endpoint="royalAirlineBookingEndpoint" actor="royal_airline"&gt;
                &lt;message&gt;
                    &lt;!-- ... --&gt;
                &lt;/message&gt;
            &lt;/send&gt;
        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This explicitly links the test actor named <code>royal_ariline</code> to test actions.
The test actor may be enabled/disabled according to the test environment.
All linked test actions and message endpoints will be skipped when the referenced test actor is disabled.</p>
</div>
</div>
<div class="sect2">
<h3 id="test-actors-disable"><a class="anchor" href="#test-actors-disable"></a><a class="link" href="#test-actors-disable">43.3. Disable test actors</a></h3>
<div class="paragraph">
<p>By default, test actors are enabled.
In some environments it may be required to disable the test actor and all its linked test actions and message endpoints though.</p>
</div>
<div class="paragraph">
<p>In the airline example usually both airline applications are simulated in the integration tests.
Assume that there is a test environment where one of the simulated applications (e.g. the <code>royal_airline</code> application) is available as a real application instance deployed.
In this scenario the Citrus tests should skip all simulated message interactions for the <code>royal_airline</code> application and the real application instance in the test environment should consume the messages instead.</p>
</div>
<div class="paragraph">
<p>This is easy as we have linked all send/receive actions to one of our test actors.
So we can disable the <code>royal_airline</code> test actor in our configuration:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry(name = "travel_agency")
public TestActor travelAgencyActor() {
    return new TestActor("travel_agency");
}

@BindToRegistry(name = "royal_airline")
public TestActor royalAirlineActor() {
    TestActor royalAirlineActor = new TestActor("royal_airline");
    royalAirlineActor.setDisabled(true);
    return royalAirlineActor;
}

@BindToRegistry(name = "smart_ariline")
public TestActor smartAirlineActor() {
    return new TestActor("smart_ariline");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean(name = "travel_agency")
public TestActor travelAgencyActor() {
    return new TestActor("travel_agency");
}

@Bean(name = "royal_airline")
public TestActor royalAirlineActor() {
    TestActor royalAirlineActor = new TestActor("royal_airline");
    royalAirlineActor.setDisabled(true);
    return royalAirlineActor;
}

@Bean(name = "smart_ariline")
public TestActor smartAirlineActor() {
    return new TestActor("smart_ariline");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns:spring="http://www.springframework.org/schema/beans"
              xmlns:citrus="http://www.citrusframework.org/schema/config"&gt;
    &lt;citrus:actor id="travel_agency" name="TRAVEL_AGENCY"/&gt;
    &lt;citrus:actor id="royal_airline" name="ROYAL_AIRLINE" disabled="true"/&gt;
    &lt;citrus:actor id="smart_ariline" name="SMART_AIRLINE"/&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any test action linked to this test actor <code>royal_airline</code> is now skipped in the test execution.
The real <code>royal_airline</code> application available in our test scenario will handle the requests instead.
The <code>travel_agency</code> and the <code>smart_airline</code> applications still get simulated by Citrus.</p>
</div>
<div class="paragraph">
<p>This is a perfect way of reusing integration tests in different test scenarios where you enable and disable simulated participating parties in Citrus.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Server ports may be of special interest when dealing with different test scenarios.
You may have to also disable a Citrus embedded Jetty server instance in order to avoid port binding conflicts.
You may have to wire endpoint URIs accordingly before executing a test.
The real life application may not use the same port and IP address as the Citrus embedded servers for simulation.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="test-actors-environment-setting"><a class="anchor" href="#test-actors-environment-setting"></a><a class="link" href="#test-actors-environment-setting">43.4. Test actor environment settings</a></h3>
<div class="paragraph">
<p>You can enable/disable the test actor also by using System property or environment variable settings.
The property and environment variable names follow a specific formatting that includes the test actor name:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>citrus.test.actor.&lt;name&gt;.enabled=true/false</code></p>
</li>
<li>
<p><code>CITRUS_TEST_ACTOR_&lt;NAME&gt;_ENABLED=true/false</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When the environment setting is available on the test host the test actor with the referenced name is enabled/disabled.</p>
</div>
<div class="paragraph">
<p>You can set these properties in the <code>citrus-application.properties</code> for instance:</p>
</div>
<div class="listingblock">
<div class="title">citrus-application.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">citrus.test.actor.royal_airline.enabled=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>This disables the test actor named <code>royal_airline</code> and skips all its linked test actions and message endpoints.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="test-suite-actions"><a class="anchor" href="#test-suite-actions"></a><a class="link" href="#test-suite-actions">44. Test suite actions</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>A test framework should also provide the functionality to do some work before and after the test run.
Typical tasks in the section before or after a test could be preparing data in a database or starting/stopping a service.
These tasks fit best into the initialization or cleanup phase of Citrus.</p>
</div>
<div class="sect2">
<h3 id="before-suite"><a class="anchor" href="#before-suite"></a><a class="link" href="#before-suite">44.1. Before suite</a></h3>
<div class="paragraph">
<p>You can influence the behavior of a whole test run in the initialization phase of the test suite.
Before any of the tests has started this section is executed once for the whole test run.
See the next code example to find out how it works with actions that take place before the first test is executed:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class BeanConfiguration {

    @BindToRegistry
    public SequenceBeforeSuite beforeSuite() {
        return new SequenceBeforeSuite.Builder()
                .actions(
                    echo().message("This is run before suite")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class BeanConfiguration {
    @Bean
    public SequenceBeforeSuite beforeSuite() {
        return new SequenceBeforeSuite.Builder()
                .actions(
                    echo().message("This is run before suite")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xmlns:citrus="http://www.citrusframework.org/schema/config"
              xmlns:citrus-test="http://www.citrusframework.org/schema/testcase"
              xsi:schemaLocation="http://www.springframework.org/schema/beans
                  http://www.springframework.org/schema/beans/spring-beans.xsd
                  http://www.citrusframework.org/schema/config
                  http://www.citrusframework.org/schema/config/citrus-config.xsd
                  http://www.citrusframework.org/schema/testcase
                  http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;

    &lt;citrus:before-suite id="actionsBeforeSuite"&gt;
        &lt;citrus:actions&gt;
            &lt;!-- list of actions before suite --&gt;
            &lt;citrus-test:echo&gt;
              &lt;citrus-test:message&gt;This is run before suite&lt;/message&gt;
            &lt;/citrus-test:echo&gt;
        &lt;/citrus:actions&gt;
    &lt;/citrus:before-suite&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is important to notice that the Citrus Spring bean XML configuration components belong to a separate namespace <code>citrus:http://www.citrusframework.org/schema/config</code>. You need to add the namespace declaration to the Spring bean XML root element of configuration file accordingly.
Test actions use a different namespace <code>citrus-test:http://www.citrusframework.org/schema/testcase</code> so we need to include both namespaces.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Citrus configuration component holds a list of Citrus test actions that get executed before the test suite.
You can add all Citrus test actions here as you would do in a normal test case definition.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class BeanConfiguration {

    @BindToRegistry
    public SequenceBeforeSuite beforeSuite() {
        return new SequenceBeforeSuite.Builder()
                .actions(
                    sql().dataSource(testDataSource)
                        .statement("CREATE TABLE PERSON (ID integer, NAME char(250))")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class BeanConfiguration {
    @Bean
    public SequenceBeforeSuite beforeSuite() {
        return new SequenceBeforeSuite.Builder()
                .actions(
                    sql().dataSource(testDataSource)
                        .statement("CREATE TABLE PERSON (ID integer, NAME char(250))")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xmlns:citrus="http://www.citrusframework.org/schema/config"
              xmlns:citrus-test="http://www.citrusframework.org/schema/testcase"
              xsi:schemaLocation="http://www.springframework.org/schema/beans
                  http://www.springframework.org/schema/beans/spring-beans.xsd
                  http://www.citrusframework.org/schema/config
                  http://www.citrusframework.org/schema/config/citrus-config.xsd
                  http://www.citrusframework.org/schema/testcase
                  http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;

    &lt;citrus:before-suite id="actionsBeforeSuite"&gt;
        &lt;citrus:actions&gt;
            &lt;!-- list of actions before suite --&gt;
            &lt;citrus-test:sql datasource="testDataSource"&gt;
                &lt;citrus-test:statement&gt;CREATE TABLE PERSON (ID integer, NAME char(250))&lt;/citrus-test:statement&gt;
            &lt;/citrus-test:sql&gt;
        &lt;/citrus:actions&gt;
    &lt;/citrus:before-suite&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above uses an SQL test action to access the database and create a table <code>PERSON</code> which is obviously needed in our test cases.
You can think of several actions here to prepare the tst infrastructure before the suite.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Citrus offers special startup and shutdown actions that may start and stop server implementations automatically. This might be helpful when dealing with Http servers or other service containers. You can also think of starting/stopping a message broker (e.g. Kafka) before a test run.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Users may have multiple configuration components declared to run in the before suite phase.
You can use different ids to separate the beans in the Citrus of Spring bean registry.</p>
</div>
<div class="paragraph">
<p>By default, Citrus scans for all available before suite containers and runs them sequentially.
You can restrict the before suite action container execution by adding a filter criteria on the suite name, a test group name, environment variables or system properties:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class BeanConfiguration {

    @BindToRegistry
    public SequenceBeforeSuite beforeSuite() {
        return new SequenceBeforeSuite.Builder()
                .onSuite("databaseSuite")
                .onTestGroup("e2e")
                .actions(
                    sql().dataSource(testDataSource)
                        .statement("CREATE TABLE PERSON (ID integer, NAME char(250))")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class BeanConfiguration {
    @Bean
    public SequenceBeforeSuite beforeSuite() {
        return new SequenceBeforeSuite.Builder()
                .onSuite("databaseSuite")
                .onTestGroup("e2e")
                .actions(
                    sql().dataSource(testDataSource)
                        .statement("CREATE TABLE PERSON (ID integer, NAME char(250))")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xmlns:citrus="http://www.citrusframework.org/schema/config"
              xmlns:citrus-test="http://www.citrusframework.org/schema/testcase"
              xsi:schemaLocation="http://www.springframework.org/schema/beans
                  http://www.springframework.org/schema/beans/spring-beans.xsd
                  http://www.citrusframework.org/schema/config
                  http://www.citrusframework.org/schema/config/citrus-config.xsd
                  http://www.citrusframework.org/schema/testcase
                  http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;

    &lt;citrus:before-suite id="actionsBeforeSuite" suites="databaseSuite" groups="e2e"&gt;
        &lt;citrus:actions&gt;
            &lt;!-- list of actions before suite --&gt;
            &lt;citrus-test:sql datasource="testDataSource"&gt;
                &lt;citrus-test:statement&gt;CREATE TABLE PERSON (ID integer, NAME char(250))&lt;/citrus-test:statement&gt;
            &lt;/citrus-test:sql&gt;
        &lt;/citrus:actions&gt;
    &lt;/citrus:before-suite&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above before suite container is only executed with the test suite called <code>databaseSuite</code>.
Also, it adds a filter on the test group that should match the group name <code>e2e</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Test groups are only supported when using the TestNG as a testing engine.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can define multiple suite names and test groups with comma-delimited strings as an attribute value.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Environment variables or system properties are defined as a list of key-value pairs.
When such a filter criteria is present the specified variables and properties have to be set in the environment with the respective value.
In case the property value is left out in the configuration the System property must simply exist on the in order to enable the before suite container.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class BeanConfiguration {

    @BindToRegistry
    public SequenceBeforeSuite beforeSuite() {
        return new SequenceBeforeSuite.Builder()
                .whenEnv("GITHUB_ENV", "")
                .whenSystemProperty("test-stage", "e2e")
                .actions(
                    sql().dataSource(testDataSource)
                        .statement("CREATE TABLE PERSON (ID integer, NAME char(250))")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class BeanConfiguration {
    @Bean
    public SequenceBeforeSuite beforeSuite() {
        return new SequenceBeforeSuite.Builder()
                .whenEnv("GITHUB_ENV", "")
                .whenSystemProperty("test-stage", "e2e")
                .actions(
                    sql().dataSource(testDataSource)
                        .statement("CREATE TABLE PERSON (ID integer, NAME char(250))")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xmlns:citrus="http://www.citrusframework.org/schema/config"
              xmlns:citrus-test="http://www.citrusframework.org/schema/testcase"
              xsi:schemaLocation="http://www.springframework.org/schema/beans
                  http://www.springframework.org/schema/beans/spring-beans.xsd
                  http://www.citrusframework.org/schema/config
                  http://www.citrusframework.org/schema/config/citrus-config.xsd
                  http://www.citrusframework.org/schema/testcase
                  http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;

    &lt;citrus:before-suite id="actionsBeforeSuite"&gt;
        &lt;citrus:env&gt;
          &lt;citrus:property name="GITHUB_ENV"/&gt;
        &lt;/citrus:env&gt;
        &lt;citrus:system&gt;
          &lt;citrus:property name="test-stage" value="e2e"/&gt;
        &lt;/citrus:system&gt;
        &lt;citrus:actions&gt;
            &lt;!-- list of actions before suite --&gt;
            &lt;citrus-test:sql datasource="testDataSource"&gt;
                &lt;citrus-test:statement&gt;CREATE TABLE PERSON (ID integer, NAME char(250))&lt;/citrus-test:statement&gt;
            &lt;/citrus-test:sql&gt;
        &lt;/citrus:actions&gt;
    &lt;/citrus:before-suite&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above the before suite container is restricted to environments with <code>GITHUB_ENV</code> property set.
Also, the system property <code>test-stage</code> must be set to the value <code>e2e</code>.
Otherwise, the before suite container execution is skipped for this environment.</p>
</div>
</div>
<div class="sect2">
<h3 id="after-suite"><a class="anchor" href="#after-suite"></a><a class="link" href="#after-suite">44.2. After suite</a></h3>
<div class="paragraph">
<p>A test may run some actions to clean up the test environment after the test.
Just like the before suite is keen to prepare data before the suite is executed, you can add tasks to the test run after the last test in the test suite is finished.
This means that the after suite actions are run once after the last test.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is a good idea to clean up the test environment after the test run. For instance, you can purge all JMS destinations and Kafka topics or clean up the database after the test run. This avoids errors in follow-up test runs where left over test data may influence upcoming tests.
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class BeanConfiguration {

    @BindToRegistry
    public SequenceBeforeSuite afterSuite() {
        return new SequenceAfterSuite.Builder()
                .actions(
                    echo().message("This is run after suite")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class BeanConfiguration {
    @Bean
    public SequenceAfterSuite afterSuite() {
        return new SequenceAfterSuite.Builder()
                .actions(
                    echo().message("This is run after suite")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xmlns:citrus="http://www.citrusframework.org/schema/config"
              xmlns:citrus-test="http://www.citrusframework.org/schema/testcase"
              xsi:schemaLocation="http://www.springframework.org/schema/beans
                                  http://www.springframework.org/schema/beans/spring-beans.xsd
                                  http://www.citrusframework.org/schema/config
                                  http://www.citrusframework.org/schema/config/citrus-config.xsd
                                  http://www.citrusframework.org/schema/testcase
                                  http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;

    &lt;citrus:after-suite id="actionsAfterSuite"&gt;
        &lt;citrus:actions&gt;
            &lt;!-- list of actions after suite --&gt;
            &lt;citrus-test:echo&gt;
              &lt;citrus-test:message&gt;This is run after suite&lt;/message&gt;
            &lt;/citrus-test:echo&gt;
        &lt;/citrus:actions&gt;
    &lt;/citrus:after-suite&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The after suite configuration component receives a unique id and holds one to many test actions as nested configuration elements.</p>
</div>
<div class="paragraph">
<p>Users may have multiple configuration components declared to run in the after suite phase.
You can use different ids to separate the beans in the Citrus of Spring bean registry.</p>
</div>
<div class="paragraph">
<p>By default, Citrus scans for all available after suite containers and runs them sequentially.
You can restrict the after suite action container execution by adding a filter criteria on the suite name, a test group name, environment variables or system properties. Please refer to the before suite examples in this guide to see how it works.</p>
</div>
</div>
<div class="sect2">
<h3 id="before-test"><a class="anchor" href="#before-test"></a><a class="link" href="#before-test">44.3. Before test</a></h3>
<div class="paragraph">
<p>You may have tasks that need to run before each test is executed.
Just like you have prepared some data in the actions before the whole test suite you can do the same before each test.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is reasonable to clean up the test environment also between the tests (e.g. purge all JMS queues or Kafka topics).
In case a previous test fails some messages might be left in the message queues. Also, a failing test may leave the database in a dirty state.
The next test may be confronted with these invalid messages and data state. You can avoid these follow-up test failures with a good clean up before a test.
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class BeanConfiguration {

    @BindToRegistry
    public SequenceBeforeSuite beforeTest() {
        return new SequenceBeforeTest.Builder()
                .actions(
                    echo().message("This is run before test")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class BeanConfiguration {
    @Bean
    public SequenceBeforeTest beforeTest() {
        return new SequenceBeforeTest.Builder()
                .actions(
                    echo().message("This is run before test")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xmlns:citrus="http://www.citrusframework.org/schema/config"
              xmlns:citrus-test="http://www.citrusframework.org/schema/testcase"
              xsi:schemaLocation="http://www.springframework.org/schema/beans
                                  http://www.springframework.org/schema/beans/spring-beans.xsd
                                  http://www.citrusframework.org/schema/config
                                  http://www.citrusframework.org/schema/config/citrus-config.xsd
                                  http://www.citrusframework.org/schema/testcase
                                  http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;

    &lt;citrus:before-test id="actionsBeforeTest"&gt;
        &lt;citrus:actions&gt;
            &lt;!-- list of actions before test --&gt;
            &lt;citrus-test:echo&gt;
              &lt;citrus-test:message&gt;This is run before test&lt;/message&gt;
            &lt;/citrus-test:echo&gt;
        &lt;/citrus:actions&gt;
    &lt;/citrus:before-test&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The before test configuration component receives a unique id and a list of test actions that get executed before a test case is started.
The component receives usual test action definitions just like you would write them in a normal test case definition.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is important to notice that the Citrus Spring bean XML configuration components belong to a separate namespace <code>citrus:http://www.citrusframework.org/schema/config</code>. You need to add the namespace declaration to the Spring bean XML root element of configuration file accordingly.
Test actions use a different namespace <code>citrus-test:http://www.citrusframework.org/schema/testcase</code> so we need to include both namespaces.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The echo test action in the example above is now executed before each test in our test suite run.
Also notice that we can restrict the before test container execution on certain filter criteria.
We can restrict the execution based on the test name, package, test groups and environment or system properties.</p>
</div>
<div class="paragraph">
<p>See following example how this works:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class BeanConfiguration {

    @BindToRegistry
    public SequenceBeforeSuite beforeTest() {
        return new SequenceBeforeTest.Builder()
                .onTests("*_Ok_Test")
                .onPackage("org.citrusframework.longrunning.*")
                .actions(
                    echo().message("This is run before test")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class BeanConfiguration {
    @Bean
    public SequenceBeforeTest beforeTest() {
        return new SequenceBeforeTest.Builder()
                .onTests("*_Ok_Test")
                .onPackage("org.citrusframework.longrunning.*")
                .actions(
                    echo().message("This is run before test")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xmlns:citrus="http://www.citrusframework.org/schema/config"
              xmlns:citrus-test="http://www.citrusframework.org/schema/testcase"
              xsi:schemaLocation="http://www.springframework.org/schema/beans
                                  http://www.springframework.org/schema/beans/spring-beans.xsd
                                  http://www.citrusframework.org/schema/config
                                  http://www.citrusframework.org/schema/config/citrus-config.xsd
                                  http://www.citrusframework.org/schema/testcase
                                  http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;

    &lt;citrus:before-test id="actionsBeforeTest" test="*_Ok_Test" package="org.citrusframework.longrunning.*"&gt;
        &lt;citrus:actions&gt;
            &lt;!-- list of actions before test --&gt;
            &lt;citrus-test:echo&gt;
              &lt;citrus-test:message&gt;This is run before test&lt;/message&gt;
            &lt;/citrus-test:echo&gt;
        &lt;/citrus:actions&gt;
    &lt;/citrus:before-test&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an example the above before test component is only executed for test cases that match the name pattern <code>\*_Ok_Test</code> and that match the package <code>org.citrusframework.longrunning.*</code>.</p>
</div>
<div class="paragraph">
<p>You can also filter based on environment variables or system properties.
When specified the properties have to be present in the test environment with the respective value.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class BeanConfiguration {

    @BindToRegistry
    public SequenceBeforeTest beforeTest() {
        return new SequenceBeforeTest.Builder()
                .whenEnv("GITHUB_ENV", "")
                .whenSystemProperty("test-stage", "e2e")
                .actions(
                    sql().dataSource(testDataSource)
                        .statement("CREATE TABLE PERSON (ID integer, NAME char(250))")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class BeanConfiguration {
    @Bean
    public SequenceBeforeTest beforeTest() {
        return new SequenceBeforeTest.Builder()
                .whenEnv("GITHUB_ENV", "")
                .whenSystemProperty("test-stage", "e2e")
                .actions(
                    sql().dataSource(testDataSource)
                        .statement("CREATE TABLE PERSON (ID integer, NAME char(250))")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xmlns:citrus="http://www.citrusframework.org/schema/config"
              xmlns:citrus-test="http://www.citrusframework.org/schema/testcase"
              xsi:schemaLocation="http://www.springframework.org/schema/beans
                                  http://www.springframework.org/schema/beans/spring-beans.xsd
                                  http://www.citrusframework.org/schema/config
                                  http://www.citrusframework.org/schema/config/citrus-config.xsd
                                  http://www.citrusframework.org/schema/testcase
                                  http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;

    &lt;citrus:before-test id="actionsBeforeTest"&gt;
        &lt;citrus:env&gt;
          &lt;citrus:property name="GITHUB_ENV"/&gt;
        &lt;/citrus:env&gt;
        &lt;citrus:system&gt;
          &lt;citrus:property name="test-stage" value="e2e"/&gt;
        &lt;/citrus:system&gt;
        &lt;citrus:actions&gt;
            &lt;!-- list of actions before suite --&gt;
            &lt;citrus-test:sql datasource="testDataSource"&gt;
                &lt;citrus-test:statement&gt;CREATE TABLE PERSON (ID integer, NAME char(250))&lt;/citrus-test:statement&gt;
            &lt;/citrus-test:sql&gt;
        &lt;/citrus:actions&gt;
    &lt;/citrus:before-test&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above the before test container is restricted to environments with <code>GITHUB_ENV</code> property set.
Also, the system property <code>test-stage</code> must be set to the value <code>e2e</code>.
Otherwise, the before test container execution is skipped for this environment.</p>
</div>
</div>
<div class="sect2">
<h3 id="after-test"><a class="anchor" href="#after-test"></a><a class="link" href="#after-test">44.4. After test</a></h3>
<div class="paragraph">
<p>The same logic that applies to the <code>before-test</code> configuration component can be done after each test.
The <code>after-test</code> configuration component defines test actions executed after each test.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class BeanConfiguration {

    @BindToRegistry
    public SequenceAfterSuite afterTest() {
        return new SequenceAfterTest.Builder()
                .actions(
                    echo().message("This is run after test")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class BeanConfiguration {
    @Bean
    public SequenceAfterTest afterTest() {
        return new SequenceAfterTest.Builder()
                .actions(
                    echo().message("This is run after test")
                );
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xmlns:citrus="http://www.citrusframework.org/schema/config"
              xmlns:citrus-test="http://www.citrusframework.org/schema/testcase"
              xsi:schemaLocation="http://www.springframework.org/schema/beans
                                  http://www.springframework.org/schema/beans/spring-beans.xsd
                                  http://www.citrusframework.org/schema/config
                                  http://www.citrusframework.org/schema/config/citrus-config.xsd
                                  http://www.citrusframework.org/schema/testcase
                                  http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;

    &lt;citrus:after-test id="actionsBeforeTest"&gt;
        &lt;citrus:actions&gt;
            &lt;!-- list of actions after test --&gt;
            &lt;citrus-test:echo&gt;
              &lt;citrus-test:message&gt;This is run after test&lt;/message&gt;
            &lt;/citrus-test:echo&gt;
        &lt;/citrus:actions&gt;
    &lt;/citrus:after-test&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The after test configuration component receives a unique id and a list of test actions that get executed after a test case is finished.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Notice that the after test actions are executed no matter what result (success or failure) the test case has produced.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The after suite container component receives usual test action definitions just like you would write them in a normal test case definition.
Of course, you can also restrict the after suite container execution based on filter criteria on the test name, test groups, environment variables and system properties.</p>
</div>
<div class="paragraph">
<p>Please see the explanations in the previous section about before test actions to see how it works.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="customize-meta-information"><a class="anchor" href="#customize-meta-information"></a><a class="link" href="#customize-meta-information">45. Customize meta information</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Test cases in Citrus are usually provided with some meta information like the author’s name or the date of creation. In Citrus you are able to extend this test case meta information with your own very specific criteria.</p>
</div>
<div class="paragraph">
<p>By default a test case comes shipped with meta information that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;testcase name="PwdChange_OK_1_Test"&gt;
    &lt;meta-info&gt;
        &lt;author&gt;Christoph&lt;/author&gt;
        &lt;creationdate&gt;2010-01-18&lt;/creationdate&gt;
        &lt;status&gt;FINAL&lt;/status&gt;
        &lt;last-updated-by&gt;Christoph&lt;/last-updated-by&gt;
        &lt;last-updated-on&gt;2010-01-18T15:00:00&lt;/last-updated-on&gt;
    &lt;/meta-info&gt;

    [...]
&lt;/testcase&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can quite easily add data to this section in order to meet your individual testing strategy. Let us have a simple example to show how it is done.</p>
</div>
<div class="paragraph">
<p>First of all we define a custom XSD schema describing the new elements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;schema xmlns="http://www.w3.org/2001/XMLSchema"
        xmlns:tns="http://www.citrusframework.org/samples/my-testcase-info"
        targetNamespace="http://www.citrusframework.org/samples/my-testcase-info"
        elementFormDefault="qualified"&gt;

    &lt;element name="requirement" type="string"/&gt;
    &lt;element name="pre-condition" type="string"/&gt;
    &lt;element name="result" type="string"/&gt;
    &lt;element name="classification" type="string"/&gt;
&lt;/schema&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have four simple elements (<strong>requirement</strong>, <strong>pre-condition</strong>, <strong>result</strong> and <strong>classification</strong>) all typed as string. These new elements later go into the test case meta information section.</p>
</div>
<div class="paragraph">
<p>After we added the new XML schema file to the classpath of our project we need to announce the schema to Spring. As you might know already a Citrus test case is nothing else but a simple Spring configuration file with customized XML schema support. If we add new elements to a test case Spring needs to know the XML schema for parsing the test case configuration file. See the <strong>spring.schemas</strong> file usually placed in the META-INF/spring.schemas in your project.</p>
</div>
<div class="paragraph">
<p>The file content for our example will look like follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">http://www.citrusframework.org/samples/my-testcase-info/my-testcase-info.xsd=org/citrusframework/schemas/my-testcase-info.xsd</code></pre>
</div>
</div>
<div class="paragraph">
<p>So now we are finally ready to use the new meta-info elements inside the test case:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
    xmlns:spring="http://www.springframework.org/schema/beans"
    xmlns:custom="http://www.citrusframework.org/samples/my-testcase-info"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.citrusframework.org/schema/testcase
          http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd
          http://www.citrusframework.org/samples/my-testcase-info
          http://www.citrusframework.org/samples/my-testcase-info/my-testcase-info.xsd"&gt;

    &lt;testcase name="PwdChange_OK_1_Test"&gt;
        &lt;meta-info&gt;
            &lt;author&gt;Christoph&lt;/author&gt;
            &lt;creationdate&gt;2010-01-18&lt;/creationdate&gt;
            &lt;status&gt;FINAL&lt;/status&gt;
            &lt;last-updated-by&gt;Christoph&lt;/last-updated-by&gt;
            &lt;last-updated-on&gt;2010-01-18T15:00:00&lt;/last-updated-on&gt;
            &lt;custom:requirement&gt;REQ10001&lt;/custom:requirement&gt;
            &lt;custom:pre-condition&gt;Existing user, sufficient rights&lt;/custom:pre-condition&gt;
            &lt;custom:result&gt;Password reset in database&lt;/custom:result&gt;
            &lt;custom:classification&gt;PasswordChange&lt;/custom:classification&gt;
        &lt;/meta-info&gt;

        [...]
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We use a separate namespace declaration with a custom namespace prefix “custom” in order to declare the new XML schema to our test case. Of course you can pick a namespace url and prefix that fits best for your project.As you see it is quite easy to add custom meta information to your Citrus test case. The customized elements may be precious for automatic reporting. XSL transformations for instance are able to read those meta information elements in order to generate automatic test reports and documentation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also declare our new XML schema in the Eclipse preferences section as user specific XML catalog entry. Then even the schema code completion in your Eclipse XML editor will be available for our customized meta-info elements.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reporting-and-test-results"><a class="anchor" href="#reporting-and-test-results"></a><a class="link" href="#reporting-and-test-results">46. Reporting and Test Results</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The framework generates different reports and results after a test run for you.
These report and result pages will help you to get an overview of the test cases that were executed and which one were failing.
They&#8217;re being generated into <code>target/citrus-reports</code> by default, but that can be changed by setting the <code>citrus.report.directory</code> property to the desired location.
E.g. it could be set to <code>citrus.report.directory=build/citrus-reports</code> for <a href="#setup-gradle">Gradle</a> builds.</p>
</div>
<div class="paragraph">
<p>In the following chapters, we&#8217;ll provide an overview of the three standard loggers available in Citrus. It&#8217;s important to note that in Spring, you have the flexibility to replace these standard loggers with your own implementations. This can be achieved by registering custom implementations, as demonstrated in the following code snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public static class OverrideReporterConfiguration {

    @Bean
    public LoggingReporter citrusLoggingReporter() {
        return new OverrideLoggingReporter();
    }

    @Bean
    public JUnitReporter citrusJunitReporter() {
        return new OverrideJUnitReporter();
    }

    @Bean
    public HtmlReporter citrusHtmlReporter() {
        return new OverrideHtmlReporter();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that you need to allow spring bean overriding to load this configuration as such. It&#8217;s worth noting that bean overriding is not recommended by Spring.
Thus the following properties are provided to deactivate standard reporters as needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">citrus.default.logging.reporter.enabled=false
citrus.default.junit.reporter.enabled=false
citrus.default.html.reporter.enabled=false</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="console-logging"><a class="anchor" href="#console-logging"></a><a class="link" href="#console-logging">46.1. Console logging</a></h3>
<div class="paragraph">
<p>During the test run the framework will provide a huge amount of information that is printed out to the console. This includes current test progress, validation results and error information. This enables the user to quickly supervise the test run progress. Failures in tests will be printed to the console just the time the error occurred. The detailed stack trace information and the detailed error messages are helpful to get the idea what went wrong.</p>
</div>
<div class="paragraph">
<p>As the console output might be limited to a defined buffer limit, the user may not be able to follow the output to the very beginning of the test run. Therefore the framework additionally prints all information to a log file according to the logging configuration.</p>
</div>
<div class="paragraph">
<p>The logging mechanism uses the SLF4J logging framework. SLF4J is independent of logging framework implementations on the market. So in case you use Log4J logging framework the specified log file path as well as logging levels can be freely configured in the respective log4j.xml file in your project. At the end of a test run the combined test results get printed to both console and log file. The overall test results look like following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">CITRUS TEST RESULTS

  [...]
  HelloService_Ok_1             : SUCCESS
  HelloService_Ok_2             : SUCCESS
  EchoService_Ok_1              : SUCCESS
  EchoService_Ok_2              : SUCCESS
  EchoService_TempError_1       : SUCCESS
  EchoService_AutomaticRetry_1 : SUCCESS
  [...]

  Found 175 test cases to execute
  Skipped 0 test cases (0.0%)
  Executed 175 test cases
  Tests failed:         0 (0.0%)
  Tests successfully: 175 (100.0%)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Failed tests will be marked as failed in the result list. The framework will give a short description of the error cause while the detailed stack trace information can be found in the log messages that were made during the test run.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">HelloService_Ok_3 : failed - Exception is Action timed out</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="junit-reports"><a class="anchor" href="#junit-reports"></a><a class="link" href="#junit-reports">46.2. JUnit reports</a></h3>
<div class="paragraph">
<p>As tests are executed as TestNG test cases, the framework will also generate JUnit compliant XML and HTML reports. JUnit test reports are very popular and find support in many build management and development tools. In general the Citrus test reports give you an overall picture of all tests and tell you which of them were failing.</p>
</div>
<div class="paragraph">
<p>Build management tools like Jenkins can easily import and display the generated JUnit XML results. Please have a look at the TestNG and JUnit documentation for more information about this topic as well as the build management tools (e.g. Jenkins) to find out how to integrate the tests results.</p>
</div>
</div>
<div class="sect2">
<h3 id="html-reports"><a class="anchor" href="#html-reports"></a><a class="link" href="#html-reports">46.3. HTML reports</a></h3>
<div class="paragraph">
<p>Citrus creates HTML reports after each test run. The report provides detailed information on the test run with a summary of all test results. You can find the report after a test run in the directory <strong><em>${project.build.directory}/citrus-reports</em></strong> .</p>
</div>
<div class="paragraph">
<p>The report consists of two parts. The test summary on top shows the total number executed tests. The main part lists all test cases with detailed information. With this report you immediately identify all tests that were failing. Each test case is marked in color according to its result outcome.</p>
</div>
<div class="paragraph">
<p>The failed tests give detailed error information with error messages and Java StackTrace information. In addition to that the report tries to find the test action inside the XML test part that failed in execution. With the failing code snippet you can see where the test stopped.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
JavaScript should be active in your web browser. This is to enable the detailed information which comes to you in form of tooltips like test author or description. If you want to access the tooltips JavaScript should be enabled in your browser.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The HTML reports are customizable by system properties. Use following properties e.g. in your <strong>citrus.properties</strong> file:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
citrus.html.report.enabled
</td>
<td class="hdlist2">
<p>Enables/disables HTML report generation (default= <strong><em>true</em></strong>).</p>
</td>
</tr>
<tr>
<td class="hdlist1">
citrus.html.report.directory
</td>
<td class="hdlist2">
<p>Output directory path (default= <strong><em>${project.build.directory}/citrus-reports</em></strong>).</p>
</td>
</tr>
<tr>
<td class="hdlist1">
citrus.html.report.file
</td>
<td class="hdlist2">
<p>File name for the report file (default= <strong><em>citrus-test-results.html</em></strong>).</p>
</td>
</tr>
<tr>
<td class="hdlist1">
citrus.html.report.template
</td>
<td class="hdlist2">
<p>Template HTML file with placeholders for report results.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
citrus.html.report.detail.template
</td>
<td class="hdlist2">
<p>Template file for detailed test results.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
citrus.html.report.logo
</td>
<td class="hdlist2">
<p>File resource path pointing to an image that is added to top of HTML report.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The HTML report is based on a template file that is customizable to your special needs. The default templates can be found in <a href="https://github.com/citrusframework/citrus/tree/master/modules/citrus-core/src/main/resources/org/citrusframework/report">report-templates sources</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration"><a class="anchor" href="#configuration"></a><a class="link" href="#configuration">47. Configuration options</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>You have several options to customize your Citrus project. Citrus uses default settings that can be overwritten to some
extent. As a framework Citrus internally works with components organized in a central context (e.g. the Spring application
context). Citrus registers components in the context in order to share those with the test execution runtime. You can
customize the behavior of these components over environment variables and system properties.</p>
</div>
<div class="sect2">
<h3 id="configuration-environment-settings"><a class="anchor" href="#configuration-environment-settings"></a><a class="link" href="#configuration-environment-settings">47.1. Environment settings</a></h3>
<div class="paragraph">
<p>Citrus as an application reads general settings from system properties and environment variables. The Citrus framework
settings initialize on the startup and evaluate environment settings in favor of using default values.</p>
</div>
<div class="paragraph">
<p>The environment settings are well suited for both usual Java runtime environment and containerized runtime environments
such as Docker or Kubernetes. The following settings do support this kind of environment configuration.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. System properties</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">System properties</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.application.properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File location for application property file that holds other settings. These properties get loaded as system properties on startup. (default="classpath:citrus-application.properties")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.java.config</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Class name for custom Java configuration (default=null)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.file.encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default file encoding used in Citrus when reading and writing file content (default=Charset.defaultCharset())</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.default.message.type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default message type for validating payloads (default="XML")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.test.name.variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default test name variable that is automatically created for each test (default="citrus.test.name")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.test.package.variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default test package variable that is automatically created for each test (default="citrus.test.package")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.default.src.directory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default test source directory (default="src/test/")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.xml.file.name.pattern</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File name patterns used for XML test file package scan (default="/**/*Test.xml,/**/*IT.xml")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.java.file.name.pattern</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File name patterns used for Java test sources package scan (default="/**/*Test.java,/**/*IT.java")</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Same properties are settable via environment variables.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Environment variables</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Environment variable</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_APPLICATION_PROPERTIES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File location for application property file that holds other settings. These properties get loaded as system properties on startup. (default="classpath:citrus-application.properties")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_JAVA_CONFIG</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Class name for custom Java configuration (default=null)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_FILE_ENCODING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default file encoding used in Citrus when reading and writing file content (default=Charset.defaultCharset())</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_DEFAULT_MESSAGE_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default message type for validating payloads (default="XML")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TEST_NAME_VARIABLE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default test name variable that is automatically created for each test (default="citrus.test.name")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_TEST_PACKAGE_VARIABLE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default test package variable that is automatically created for each test (default="citrus.test.package")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_DEFAULT_SRC_DIRECTORY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default test source directory (default="src/test/")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_XML_FILE_NAME_PATTERN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File name patterns used for XML test file package scan (default="/**/*Test.xml,/**/*IT.xml")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_JAVA_FILE_NAME_PATTERN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File name patterns used for Java test sources package scan (default="/**/*Test.java,/**/*IT.java")</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="configuration-property-binding"><a class="anchor" href="#configuration-property-binding"></a><a class="link" href="#configuration-property-binding">47.2. Property binding support</a></h3>
<div class="paragraph">
<p>The Citrus project defines components and endpoints in the form of beans in the Citrus registry, which is either the Java configuration or a Spring bean configuration. The beans in the registry provide properties that you can overwrite with environment variables and system properties.</p>
</div>
<div class="paragraph">
<p>Each bean that is added to the Citrus registry is being post processed with the Citrus property binding support.
Users can overwrite these properties on components, endpoints and endpoint configuration with environment specific settings.</p>
</div>
<div class="paragraph">
<p>The Citrus property binding support follows a naming convention that looks like follows:</p>
</div>
<div class="listingblock">
<div class="title">Environment variables</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">CITRUS_COMPONENT_&lt;COMPONENT_NAME&gt;_&lt;PROPERTY_NAME&gt;=&lt;VALUE&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, specific to endpoints the naming convention looks like this:</p>
</div>
<div class="listingblock">
<div class="title">Environment variables</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">CITRUS_ENDPOINT_&lt;ENDPOINT_NAME&gt;_&lt;PROPERTY_NAME&gt;=&lt;VALUE&gt;
CITRUS_ENDPOINT_CONFIG_&lt;ENDPOINT_NAME&gt;_&lt;PROPERTY_NAME&gt;=&lt;VALUE&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>According to that users can also use system property settings that follow the same rules:</p>
</div>
<div class="listingblock">
<div class="title">System properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">citrus.component.&lt;component-name&gt;.&lt;property-name&gt;=&lt;value&gt;
citrus.endpoint.&lt;endpoint-name&gt;.&lt;property-name&gt;=&lt;value&gt;
citrus.endpoint.config.&lt;endpoint-name&gt;.&lt;property-name&gt;=&lt;value&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The difference of using <code>CITRUS_ENDPOINT</code> compared to using <code>CITRUS_ENDPOINT_CONFIG</code> is that the latter targets the specific endpoint configuration of the bean. The former will just set properties on the endpoint itself.</p>
</div>
<div class="paragraph">
<p>The component or endpoint name references the bean name that is used to store the object into the Citrus registry.
The property name is the name of the setter method available on the object (without the <code>set</code> prefix)</p>
</div>
<div class="paragraph">
<p>Given an endpoint named <code>foo</code> with a <code>setPort(int port)</code> method the environment setting to overwrite the property would be like this:</p>
</div>
<div class="listingblock">
<div class="title">Environment variable</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">CITRUS_ENDPOINT_FOO_PORT=12345</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">System property</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">citrus.endpoint.foo.port=12345</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the bean name or the property name uses camel case style you have multiple ways to represent this in the environment settings.</p>
</div>
<div class="paragraph">
<p>As an example the given endpoint named <code>myBean</code> exposes the method <code>setRequestUrl(String url)</code>.
You have multiple ways to set this property:</p>
</div>
<div class="listingblock">
<div class="title">Environment variable</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">CITRUS_ENDPOINT_MYBEAN_REQUESTURL=http://whatever

CITRUS_ENDPOINT_MY_BEAN_REQUEST_URL=http://whatever</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">System properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">citrus.endpoint.myBean.requestUrl=http://whatever

citrus.endpoint.myBean.request-url=http://whatever</code></pre>
</div>
</div>
<div class="paragraph">
<p>The property bindings may reference other beans in the Citrus registry.
Given a bean named <code>myLog</code> of type <code>org.citrusframework.LogModifier</code>, that is stored to the Citrus registry, you can be reference the bean with the <code>#bean:</code> prefix like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">CITRUS_ENDPOINT_FOO_LOG_MODIFIER=#bean:myLog</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will resolve the bean named <code>myLog</code> from the Citrus registry and set this as a reference on the endpoint <code>foo</code> with the <code>setLogModifier()</code> method.</p>
</div>
<div class="paragraph">
<p>The property binding support is enabled by default for components, endpoints and endpoint configuration.
You can disable the bindings with the environment setting:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. System properties</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">System properties</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.env.var.property.binding.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set this to <code>false</code> to disable the property binding completely.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.component.property.binding.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set this to <code>false</code> to disable the property binding for components.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.endpoint.property.binding.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set this to <code>false</code> to disable the property binding for endpoints.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Environment variables</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Environment variable</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_ENV_VAR_PROPERTY_BINDING_ENABLED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set this to <code>false</code> to disable the property binding completely.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_COMPONENT_PROPERTY_BINDING_ENABLED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set this to <code>false</code> to disable the property binding for components.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_ENDPOINT_PROPERTY_BINDING_ENABLED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set this to <code>false</code> to disable the property binding for endpoints.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="configuration-spring"><a class="anchor" href="#configuration-spring"></a><a class="link" href="#configuration-spring">47.3. Spring configuration settings</a></h3>
<div class="paragraph">
<p>When spring framework is enabled in Citrus you can set specific settings regarding the Spring
application context.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. System properties</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">System properties</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.spring.application.context</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File location for Spring XML configurations (default="classpath*:citrus-context.xml")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">citrus.spring.java.config</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Class name for Spring Java config (default=null)</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. Environment variables</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Environment variable</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_SPRING_APPLICATION_CONTEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File location for Spring XML configurations (default="classpath*:citrus-context.xml")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CITRUS_SPRING_JAVA_CONFIG</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Class name for Spring Java config (default=null)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="configuration-property-file"><a class="anchor" href="#configuration-property-file"></a><a class="link" href="#configuration-property-file">47.4. Property file settings</a></h3>
<div class="paragraph">
<p>As mentioned in the previous section Citrus as a framework references some basic settings from system environment properties
or variables. You can overwrite these settings in a central property file which is loaded at the very beginning of the
Citrus runtime.</p>
</div>
<div class="paragraph">
<p>The properties in that file are automatically loaded as Java system properties. Just add a property file named
<strong>citrus-application.properties</strong> to your project classpath. This property file contains customized settings such as:</p>
</div>
<div class="listingblock">
<div class="title">citrus-application.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">citrus.spring.application.context=classpath*:citrus-custom-context.xml
citrus.spring.java.config=org.citrusframework.config.MyCustomConfig
citrus.file.encoding=UTF-8
citrus.default.message.type=XML
citrus.xml.file.name.pattern=/**/*Test.xml,/**/*IT.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus automatically loads these application properties at the startup. All properties are also settable with Java system
properties directly. The location of the <code>citrus-application.properties</code> file is customizable with the system property
<code>citrus.application.properties or environment variable `CITRUS_APPLICATION_PROPERTIES</code>.
          `
.Custom property file location.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">CITRUS_APPLICATION_PROPERTIES=file:/custom/path/to/citrus-application.properties</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can use <strong>classpath:</strong> and <strong>file:</strong> path prefix in order to give locate a classpath or file-system resource.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-support"><a class="anchor" href="#spring-support"></a><a class="link" href="#spring-support">48. Spring support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Spring framework provides an awesome set of projects, libraries and tools and is a wide spread and well appreciated
framework for Java. The dependency injection and IoC concepts introduced with Spring are awesome.</p>
</div>
<div class="paragraph">
<p>Citrus is able to work with Spring in terms of loading central components as Spring beans as part of a Spring application
context. In the following you can use Spring autowiring and configuration in your tests.</p>
</div>
<div class="paragraph">
<p>Read the following chapters to know more about how to use Citrus together with Spring.</p>
</div>
<div class="sect2">
<h3 id="spring-xml-config"><a class="anchor" href="#spring-xml-config"></a><a class="link" href="#spring-xml-config">48.1. Spring XML application context</a></h3>
<div class="paragraph">
<p>Citrus supports the Spring framework as IoC container in order to load all components as Spring beans in a central
application context. By default, Citrus loads basic components as Spring beans in a Spring Java config class.</p>
</div>
<div class="paragraph">
<p>With Spring in place it is very easy to change/add custom bean components in the Spring application context. Citrus
searches for custom Spring application context files in your project and adds these bean definitions to the Spring
application context.</p>
</div>
<div class="paragraph">
<p>By default, Citrus looks for custom XML Spring application context files in this location: <code>classpath*:citrus-context.xml</code>.
So you can just add this file named <strong>citrus-context.xml</strong> to your project classpath and Citrus will load all Spring beans
automatically.</p>
</div>
<div class="paragraph">
<p>The location of this file can be customized by setting a System property <code>citrus.spring.application.context</code> or the environment
variable <code>CITRUS_SPRING_APPLICATION_CONTEXT</code>.</p>
</div>
<div class="listingblock">
<div class="title">Custom Spring XML bean definition context.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">CITRUS_SPRING_APPLICATION_CONTEXT=file:/custom/path/to/custom-beans.xml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">custom-beans.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.citrusframework.org/schema/config
            http://www.citrusframework.org/schema/config/citrus-config.xsd
            http://www.springframework.org/schema/context
            http://www.springframework.org/schema/context/spring-context.xsd"&gt;

  &lt;!-- Add your bean definitions here --&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The file <code>custom-beans.xml</code> should provide a normal Spring bean XML configuration. You can add Spring beans as usual and
you can use the Citrus XML components provided by the schemas like <code>xmlns:citrus="http://www.citrusframework.org/schema/config"</code>.</p>
</div>
<div class="paragraph">
<p>Citrus provides several schemas for custom Spring XML components. These are described in more detail in the respective
chapters and sections in this reference guide.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can also use import statements in this Spring application context in order to load other configuration files.
So you are free to modularize your configuration in several files that get loaded by Citrus.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="spring-java-config"><a class="anchor" href="#spring-java-config"></a><a class="link" href="#spring-java-config">48.2. Spring Java config</a></h3>
<div class="paragraph">
<p>You can also use pure Java code to load Spring beans as a configuration. Citrus is able to load the Spring beans from a
configuration class. Please define the configuration class with the System property <code>citrus.spring.java.config</code> or with
the environment variable <code>CITRUS_SPRING_JAVA_CONFIG</code>.</p>
</div>
<div class="listingblock">
<div class="title">Custom Spring Java configuration class.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">CITRUS_SPRING_JAVA_CONFIG=custom.package.to.MyCustomConfig</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus loads the given Spring bean configuration class in <strong>MyCustomConfig.class</strong> and adds all defined Spring beans to the
application context. See the following example for custom Spring Java configuration:</p>
</div>
<div class="listingblock">
<div class="title">MyCustomConfig.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.TestCase;
import org.citrusframework.report.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class MyCustomConfig {

    @Bean(name = "plusMinusTestReporter")
    public TestReporter plusMinusTestReporter() {
        return new PlusMinusTestReporter();
    }

    /**
     * Sample test reporter.
     */
    private static class PlusMinusTestReporter extends AbstractTestReporter {

        @Override
        public void generate(TestResults testResults) {
            StringBuilder testReport = new StringBuilder();

            testResults.doWithResults(result -&gt; {
                if (result.isSuccess()) {
                    testReport.append("+");
                } else if (result.isFailed()) {
                    testReport.append("-");
                } else {
                    testReport.append("o");
                }
            });

            LoggerFactory.getLogger(PlusMinusTestReporter.class).info(testReport.toString());
        }
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can mix XML and Java based Spring bean configuration. Citrus loads both sources and adds beans to the Spring bean
application context during start.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tools"><a class="anchor" href="#tools"></a><a class="link" href="#tools">49. Tools</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the following sections we have a closer into various tooling available for Citrus.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tools-cucumber-steps"><a class="anchor" href="#tools-cucumber-steps"></a><a class="link" href="#tools-cucumber-steps">50. Cucumber Steps</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Citrus is able to use the Cucumber runtime to execute BDD feature files as tests.
Read more about the section about <a href="#runtimes-cucumber">Cucumber integration with Citrus</a>.</p>
</div>
<div class="paragraph">
<p>Cucumber feature files follow the Gherkin Given-When-Then syntax where each line in a feature file is backed by a step implementation.
The step implementation represents the actual runtime logic executed with the feature step.</p>
</div>
<div class="paragraph">
<p>Citrus provides a set of default ready-to-use step implementations that you can just add to your feature file.
The predefined steps leverage Citrus endpoints and test actions to perform integration testing with proper message exchange and validation.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you want to use the predefined Citrus step implementations, please make sure to include the extra glue package as follows:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">MyFeatureIT.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RunWith(Cucumber.class)
@CucumberOptions(
    extraGlue = { "org.citrusframework.cucumber" },
    plugin = { "pretty", "org.citrusframework.cucumber.CitrusReporter" } )
public class MyFeatureIT {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an alternative you may declare the glue package in <code>cucumber.properties</code> in your project.</p>
</div>
<div class="listingblock">
<div class="title">cucumber.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">cucumber.object-factory=org.citrusframework.cucumber.backend.CitrusObjectFactory
cucumber.glue=org.citrusframework.cucumber
cucumber.plugin=pretty,org.citrusframework.cucumber.CitrusReporter</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Citrus step implementations require a special Cucumber object factory <code>org.citrusframework.cucumber.backend.CitrusObjectFactory</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See the following step implementations that enable you to cover various areas of messaging and integration testing.</p>
</div>
<div class="sect2">
<h3 id="tools-cucumber-steps-standard"><a class="anchor" href="#tools-cucumber-steps-standard"></a><a class="link" href="#tools-cucumber-steps-standard">50.1. Standard steps</a></h3>
<div class="paragraph">
<p>The standard steps in Citrus provide a lot of basic functionality that you can just use in your feature files. The functionality is shipped as
predefined steps that you add to a feature as you write your test.</p>
</div>
<div class="paragraph">
<p>Most of the standard steps do leverage capabilities of the underlying test framework Citrus such as creating test variables or printing messages
to the log output.</p>
</div>
<div class="sect3">
<h4 id="steps-core-variables"><a class="anchor" href="#steps-core-variables"></a><a class="link" href="#steps-core-variables">50.1.1. Create variables</a></h4>
<div class="paragraph">
<p>Test variables represent the fundamental concept to own test data throughout your test. Once a variable has been created
you can reference its value in many places in Citrus. You can add a new identifier as a variable and reference
its value in many places such as message headers, body content, SQL statements and many more.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^variable {name} is \"{value}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given variable orderId is "1001"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will create the variable <code>orderId</code> in the current test context. All subsequent steps and operations may reference the variable with the expression <code>${orderId}</code>.
Citrus makes sure to replace the variable placeholder with its actual value before sending out messages and before validating incoming messages. As already mentioned
you can use the variable placeholder expression in many places such as message headers and body content:</p>
</div>
<div class="listingblock">
<div class="title">Variable placeholder in a Json payload</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "id": "${orderId}",
  "name": "Watermelon",
  "amount": 10
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can create multiple variables in one single step using:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^variables$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given variables
  | orderId  | 1001      |
  | name     | Pineapple |</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also load variables from an external property file resource.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load variables {file}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load variables {file}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The given <code>{file}</code> should be a property file holding one to many test variables with key and value.</p>
</div>
<div class="listingblock">
<div class="title">variable.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">greeting=Hola
name=Christoph
text=Citrus rocks!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes variables values are too big to write them directly into the feature file (e.g. large request/response body data).
In this case you may want to load the variable value from an external file.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load variable {name} from {file}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load variable {name} from {file}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step loads the file content as a String value and references it as a new test variable with the given name.</p>
</div>
<div class="listingblock">
<div class="title">Load test variable from file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load variable body from request.json
Then log 'Sending request body: ${body}'</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-core-log"><a class="anchor" href="#steps-core-log"></a><a class="link" href="#steps-core-log">50.1.2. Log steps</a></h4>
<div class="paragraph">
<p>Logging a message to the output can be helpful in terms of debugging and/or to give information about the context of an operation.</p>
</div>
<div class="paragraph">
<p>Citrus provides following steps to add log output:</p>
</div>
<div class="listingblock">
<div class="title">@Then("^(?:log|print) '{text}'$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then print 'Citrus provides Cloud native BDD testing!'
And log 'Citrus rocks!'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The steps are printing log messages to the output using INFO level. The text that is printed supports test variables
and functions. All placeholders will be replaced before logging.</p>
</div>
<div class="paragraph">
<p>You can also use multiline log messages as shown in the next example.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^(?:log|print)$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given print
"""
Hello users!

Citrus provides Cloud Native BDD testing on Kubernetes!
"""</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-core-sleep"><a class="anchor" href="#steps-core-sleep"></a><a class="link" href="#steps-core-sleep">50.1.3. Sleep</a></h4>
<div class="paragraph">
<p>The <code>sleep</code> step lets the test run wait for a given amount of time (in milliseconds). During the sleep no action will be performed and the subsequent steps are postponed respectively.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^sleep$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then sleep</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above step performs a sleep with the default time of 5000 milliseconds.</p>
</div>
<div class="paragraph">
<p>You can also provide the duration to sleep in milliseconds or ISO 8601 format.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^sleep {time} ms$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then sleep 2500 ms</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step receives a numeric parameter that represents the amount of time (in milliseconds) to wait.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^sleep {hours}h {minutes}min {seconds}sec {milliseconds}ms$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then sleep 1h 25min 15sec 500ms</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tools-cucumber-steps-camel"><a class="anchor" href="#tools-cucumber-steps-camel"></a><a class="link" href="#tools-cucumber-steps-camel">50.2. Apache Camel steps</a></h3>
<div class="paragraph">
<p>Apache Camel is a very popular enterprise integration library that provides a huge set of ready to use components and
endpoints for you to connect with different messaging transports. Also, many data formats are supported in Camel so you will be able
to incorporate with almost any software interface exchanging data over the wire.</p>
</div>
<div class="paragraph">
<p>Citrus adds steps to use Apache Camel as part of a test. You are able to send and receive messages with Camel components and make
use of the enterprise integration patterns and data formats implemented in Apache Camel.</p>
</div>
<div class="sect3">
<h4 id="steps-camel-context"><a class="anchor" href="#steps-camel-context"></a><a class="link" href="#steps-camel-context">50.2.1. Create Camel context</a></h4>
<div class="paragraph">
<p>The Camel context is a central place to add routes and manage Camel capabilities and services. You can start a new default
(empty) Camel context using the following step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Default|New) Camel context$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Default Camel context</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will setup and start a new Camel context as part og the current test scenario. You can now create and add routes to this
context. In case you have special configuration and/or some default routes that you need to initialize as part of the
context you can provide a Camel Spring bean configuration in the Camel context step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^New Spring Camel context$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given New Spring Camel context
"""
&lt;beans xmlns="http://www.springframework.org/schema/beans"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                          http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd"&gt;
  &lt;camelContext id="helloContext" xmlns="http://camel.apache.org/schema/spring"&gt;
    &lt;route id="helloRoute"&gt;
      &lt;from uri="direct:hello"/&gt;
      &lt;to uri="log:org.citrusframework.camel?level=INFO"/&gt;
      &lt;split&gt;
        &lt;tokenize token=" "/&gt;
        &lt;to uri="seda:tokens"/&gt;
      &lt;/split&gt;
    &lt;/route&gt;
  &lt;/camelContext&gt;
&lt;/beans&gt;
"""</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-camel-routes-create"><a class="anchor" href="#steps-camel-routes-create"></a><a class="link" href="#steps-camel-routes-create">50.2.2. Create Camel routes</a></h4>
<div class="paragraph">
<p>In Apache Camel you need to create routes in order to start producing/consuming data from endpoints. The routes can be defined
in XML or Groovy.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Camel route {name}.xml")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Camel route hello.xml
"""
&lt;route&gt;
  &lt;from uri="direct:hello"/&gt;
  &lt;to uri="log:org.citrusframework.camel?level=INFO"/&gt;
  &lt;split&gt;
    &lt;tokenize token=" "/&gt;
    &lt;to uri="seda:tokens"/&gt;
  &lt;/split&gt;
&lt;/route&gt;
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to XML route definitions Citrus also supports the Groovy DSL.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Camel route {name}.groovy")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Camel route hello.groovy
"""
from("direct:hello")
 .to("log:org.citrusframework.camel?level=${logLevel}")
 .split(body().tokenize(" "))
   .to("seda:tokens")
 .end()
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above steps create the Camel routes and automatically starts them in the current context. The given routes start
to consume messages from the endpoint <code>direct:hello</code>.</p>
</div>
<div class="paragraph">
<p>You can also load the Camel route from a file resource.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load Camel route path/to/{name}.{language}")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load Camel route hello.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>Currently, the languages <code>xml</code> and <code>groovy</code> are supported.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-camel-routes-manage"><a class="anchor" href="#steps-camel-routes-manage"></a><a class="link" href="#steps-camel-routes-manage">50.2.3. Start/stop Camel routes</a></h4>
<div class="paragraph">
<p>We are able to explicitly start and stop routes in the current context.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^start Camel route {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then start Camel route {name}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The given name references a route in the current Camel context. This starts the route and
consumes messages from the enpoint URI.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^stop Camel route {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then stop Camel route {name}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After stopping a route the route will not consume any messages on the given endpoint URI.</p>
</div>
<div class="paragraph">
<p>In case a Camel route is not needed anymore you can also remove it from the current Camel context.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^remove Camel route {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then remove Camel route {name}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-camel-send"><a class="anchor" href="#steps-camel-send"></a><a class="link" href="#steps-camel-send">50.2.4. Send messages via Camel</a></h4>
<div class="paragraph">
<p>We can send exchanges using any Camel endpoint URI. The endpoint URI can point to an external
component or to a route in the current Camel context and trigger its processing logic. The exchange body
is given as single or multiline body content.</p>
</div>
<div class="listingblock">
<div class="title">@When("^send Camel exchange to\\(\"{endpoint_uri}\"\\) with body: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send Camel exchange to("direct:hello") with body: Hello Camel!</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step sends an exchange with the body <code>Hello Camel!</code>. You can also use
multiline body content with the following step:</p>
</div>
<div class="listingblock">
<div class="title">@When("^send Camel exchange to\\(\"{endpoint_uri}\"\\) with body$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send Camel exchange to("direct:hello") with body
"""
Hello Camel!

This is a multiline content!
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to a body content the Camel exchange also defines a set of message headers. You can use a data table to specify message headers
when sending a message.</p>
</div>
<div class="listingblock">
<div class="title">@When("^send Camel exchange to\\(\"{endpoint_uri}\"\\) with body and headers: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send Camel exchange to("direct:hello") with body and headers Hello Camel!
    | id        | 1234     |
    | operation | sayHello |</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-camel-receive"><a class="anchor" href="#steps-camel-receive"></a><a class="link" href="#steps-camel-receive">50.2.5. Receive messages via Camel</a></h4>
<div class="paragraph">
<p>The Citrus test is able to receive messages from a Camel endpoint URI in order to verify
the message content (header and body) with an expected control message.</p>
</div>
<div class="paragraph">
<p>Once the message
is received Citrus makes use of the powerful message validation capabilities of Citrus to make sure
that the content is as expected.</p>
</div>
<div class="listingblock">
<div class="title">@When("^receive Camel exchange from\\(\"{endpoint_uri}\"\\) with body: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When receive Camel exchange from("seda:tokens") with body: Hello</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step receives an exchange from the endpoint URI <code>seda:tokens</code> and
verifies the body to be equal to <code>Hello</code>. See the next example on how
to validate a multiline message body content.</p>
</div>
<div class="listingblock">
<div class="title">@When("^receive Camel exchange from\\(\"{endpoint_uri}\"\\) with body$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When receive Camel exchange from("seda:tokens") with body
"""
{
  "message": "Hello Camel!"
}
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also verify a set of message headers that must be present on the received exchange.
Once again we use a data table to define the message headers. This time we provide expected message
header values.</p>
</div>
<div class="listingblock">
<div class="title">@When("^receive Camel exchange from\\(\"{endpoint_uri}\"\\) with body and headers: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When receive Camel exchange from("seda:tokens") with body and headers: Hello
    | id        | 1234     |
    | operation | sayHello |</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-camel-exchange"><a class="anchor" href="#steps-camel-exchange"></a><a class="link" href="#steps-camel-exchange">50.2.6. Define Camel exchanges</a></h4>
<div class="paragraph">
<p>In the previous steps we have seen how to send and receive messages to anf from
Camel endpoint URIs. We have used the exchange body and header in a single step so far.</p>
</div>
<div class="paragraph">
<p>In some cases it might be a better option to use multiple steps for defining the complete exchange
data upfront. The actual send/receive operation then takes place in a separate step.</p>
</div>
<div class="paragraph">
<p>The following examples should clarify the usage.</p>
</div>
<div class="paragraph">
<p>@Given("^Camel exchange message header {name}=\"{value}\"$")</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Camel exchange message header {name}="{value}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sets a message header on the exchange. We can also use a data table to set multiple headers
in one single step:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Camel exchange message headers$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Camel exchange message headers
    | id        | 1234     |
    | operation | sayHello |</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we can also set the body in another step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Camel exchange body$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Camel exchange body: Hello Camel!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiline body content is also supported.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Camel exchange body$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Camel exchange body
"""
{
  "message": "Hello Camel!"
}
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the body is getting too big it may be a better idea to load the content from an external file resource:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load Camel exchange body {file}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load Camel exchange body {file}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step loads the body content from the given file resource.</p>
</div>
<div class="paragraph">
<p>Now that we have specified the exchange headers and body content we can send or receive that specific
echange in a separate step.</p>
</div>
<div class="listingblock">
<div class="title">@When("^send Camel exchange to\\(\"{endpoint_uri}\"\\)$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">send Camel exchange to("{endpoint_uri}")</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">@When("^receive Camel exchange from\\(\"{endpoint_uri}\"\\)$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">receive Camel exchange from("{endpoint_uri}")</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the previous section we have covered a 2nd approach to send and receive messages
with Apache Camel. You specify the exchange in multiple steps first and then send/receive
the exchange to/from and endpoint URI in a separate step.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-camel-settings"><a class="anchor" href="#steps-camel-settings"></a><a class="link" href="#steps-camel-settings">50.2.7. Basic Camel settings</a></h4>
<div class="listingblock">
<div class="title">@Given("^Camel consumer timeout is {time}(?: ms| milliseconds)$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Camel consumer timeout is {time} milliseconds</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sets the default timeout for all Camel components that consume data from messaging transports. After that time the test
will fail with a timeout exception when no message has been received.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-camel-resources"><a class="anchor" href="#steps-camel-resources"></a><a class="link" href="#steps-camel-resources">50.2.8. Manage Camel resources</a></h4>
<div class="paragraph">
<p>The Apache Camel steps are able to create resources such as routes. By default these resources get removed automatically after the test scenario.</p>
</div>
<div class="paragraph">
<p>The auto removal of Camel resources can be turned off with the following step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Disable auto removal of Camel resources$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Disable auto removal of Camel resources</code></pre>
</div>
</div>
<div class="paragraph">
<p>Usually this step is a <code>Background</code> step for all scenarios in a feature file. This way multiple scenarios can work on the very same Camel resources and share
integrations.</p>
</div>
<div class="paragraph">
<p>There is also a separate step to explicitly enable the auto removal.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Enable auto removal of Camel resources$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Enable auto removal of Camel resources</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, all Camel resources are automatically removed after each scenario.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tools-cucumber-steps-groovy"><a class="anchor" href="#tools-cucumber-steps-groovy"></a><a class="link" href="#tools-cucumber-steps-groovy">50.3. Groovy steps</a></h3>
<div class="paragraph">
<p>The Groovy support in Citrus adds ways to configure the framework with bean configurations and test actions via
Groovy script snippets. In particular, you can add customized endpoints that send/receive data over various
messaging transports.</p>
</div>
<div class="paragraph">
<p>The Groovy script support is there to cover specific use cases where you hit limitations with the predefined
conventional BDD steps. Of course the syntax and handling of the Groovy scripts are less human-readable and more
developer-coherent.</p>
</div>
<div class="sect3">
<h4 id="steps-groovy-configuration-script"><a class="anchor" href="#steps-groovy-configuration-script"></a><a class="link" href="#steps-groovy-configuration-script">50.3.1. Bean configuration</a></h4>
<div class="paragraph">
<p>Many steps use Citrus components behind the scenes. The Citrus components are configurable through a Groovy domain specific language.
You can add endpoints and other components as Citrus framework configuration like follows:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:create|new) configuration$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given create configuration
"""
&lt;&lt;Groovy DSL&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the next example the step uses a Groovy domain specific language to define a new Http server endpoint.</p>
</div>
<div class="listingblock">
<div class="title">Http server endpoint configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Scenario: Endpoint script config
  Given URL: http://localhost:18080
  Given create configuration
  """
  citrus {
      endpoints {
          http {
              server('helloServer') {
                  port = 18080
                  autoStart = true
              }
          }
      }
  }
  """
  When send GET /hello
  Then receive HTTP 200 OK</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration step creates a new Citrus endpoint named <code>helloServer</code> with given properties (<code>port</code>, <code>autoStart</code>) in form of a Groovy configuration script.
The endpoint is a Http server Citrus component that is automatically started listening on the given port. In the following the scenario can send messages to that server endpoint.</p>
</div>
<div class="paragraph">
<p>The Groovy configuration script adds Citrus components to the test context and supports following elements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>endpoints</code>: Configure Citrus endpoint components that can be used to exchange data over various messaging transports</p>
</li>
<li>
<p><code>queues</code>: In memory queues to handle message forwarding for incoming messages</p>
</li>
<li>
<p><code>beans</code>: Custom beans configuration (e.g. data source, SSL context, request factory) that can be used in Citrus endpoint components</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s quickly have a look at a bean configuration where a new JDBC data source is added to the test suite.</p>
</div>
<div class="listingblock">
<div class="title">JDBC data source configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Scenario: Bean configuration
  Given create configuration
  """
  citrus {
      beans {
          dataSource(org.apache.commons.dbcp2.BasicDataSource) {
              driverClassName = "org.h2.Driver"
              url = "jdbc:h2:mem:camel"
              username = "sa"
              password = ""
          }
      }
  }
  """</code></pre>
</div>
</div>
<div class="paragraph">
<p>The data source will be added as a bean named <code>dataSource</code> and can be referenced in all Citrus SQL test actions.</p>
</div>
<div class="paragraph">
<p>All Groovy configuration scripts that we have seen so far can also be loaded from external file resources, too.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load configuration {file_path}\\.groovy$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load configuration {file_path}.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>The file content is loaded as a Groovy configuration DSL. The next code sample shows such a configuration script.</p>
</div>
<div class="listingblock">
<div class="title">citrus.configuration.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">citrus {
    queues {
        queue('say-hello')
    }

    endpoints {
        direct {
            asynchronous {
                name = 'hello'
                queue = 'say-hello'
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-groovy-endpoint-script"><a class="anchor" href="#steps-groovy-endpoint-script"></a><a class="link" href="#steps-groovy-endpoint-script">50.3.2. Endpoint configuration</a></h4>
<div class="paragraph">
<p>Endpoints describe an essential part in terms of messaging integration during a test. There are multiple ways to add custom endpoints
to a test. Endpoint Groovy scripts is one comfortable way to add custom endpoint configurations
in a test scenario. You can do so with the following step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:create|new) endpoint {name}\\.groovy$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given("^(?:create|new) endpoint {name}.groovy
"""
&lt;&lt;Groovy DSL&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step receives a unique name for the endpoint and a Groovy DSL that sepcifies the endpoint component with all its properties.
In the following sample a new Http server endpoint component will be created.</p>
</div>
<div class="listingblock">
<div class="title">Create new Http server endpoint</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Scenario: Create Http endpoint
  Given URL: http://localhost:18081
  Given create endpoint helloServer.groovy
  """
  http()
    .server()
    .port(18081)
    .autoStart(true)
  """
  When send GET /hello
  Then receive HTTP 200 OK</code></pre>
</div>
</div>
<div class="paragraph">
<p>The scenario creates a new Http server endpoint named <code>helloServer</code>. This server component can be used directly in the
scenario to receive and verify messages sent to that endpoint.</p>
</div>
<div class="paragraph">
<p>You can also load the endpoint configuration from an external file resources.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load endpoint {file_path}\\.groovy$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given("^load endpoint {file_path}.groovy$")</code></pre>
</div>
</div>
<div class="paragraph">
<p>The referenced file should contain the endpoint Groovy DSL.</p>
</div>
<div class="listingblock">
<div class="title">Create endpoint from file resource</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Scenario: Load endpoint
  Given URL: http://localhost:18088
  Given load endpoint fooServer.groovy
  When send GET /hello
  Then receive HTTP 200 OK</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">fooServer.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">http()
    .server()
    .port(18088)
    .autoStart(true)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-groovy-action-script"><a class="anchor" href="#steps-groovy-action-script"></a><a class="link" href="#steps-groovy-action-script">50.3.3. Test actions</a></h4>
<div class="paragraph">
<p>Citrus provides a huge set of predefined test actions that users can add to the Gherkin feature files out of the box.
However, there might be situations where you want to run a customized test action code as a step in your feature scenario.</p>
</div>
<div class="paragraph">
<p>With the Groovy script support in Citrus you can add such customized test actions via script snippets:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:create|new) actions {name}\\.groovy$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given create actions {name}.groovy$")
"""
&lt;&lt;Groovy DSL&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Groovy test action DSL script receives a unique <code>{name}</code>. You can reference this name later in the test in order to
apply the defined actions. When applied to the test the defined actions are executed. A sample will show how it is done.</p>
</div>
<div class="listingblock">
<div class="title">Create test actions with a script</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Scenario: Custom test actions
  Given create actions basic.groovy
  """
  $actions {
    $(echo('Hello from Groovy script'))
    $(delay().seconds(1))

    $(createVariables()
        .variable('foo', 'bar'))

    $(echo('Variable foo=${foo}'))
  }
  """
  Then apply basic.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above defines the test actions with the Groovy DSL under the name <code>basic.groovy</code>. Later in the test the actions are executed with the
<code>apply</code> step.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^(?:apply|verify) actions {name}\\.groovy$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then apply actions {name}.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>Users familiar with Citrus will notice immediately that the action script is using the Citrus actions DSL to describe
what should be done when running the Groovy script as part of the test.</p>
</div>
<div class="paragraph">
<p>The Citrus action DSL is quite powerful and allows you to perform complex actions such as iterations, conditionals and
send/receive operations as shown in the next sample.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Scenario: Messaging actions
  Given create actions messaging.groovy
  """
  $actions {
    $(send('direct:myQueue')
      .payload('Hello from Groovy script!'))

    $(receive('direct:myQueue')
      .payload('Hello from Groovy script!'))
  }
  """
  Then apply actions messaging.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an alternative to write the Groovy DSL directly into the test feature file you can also laod the test action script
from external file resources.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load actions {file_name}\\.groovy$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load actions {file_name}.groovy$")</code></pre>
</div>
</div>
<div class="paragraph">
<p>The file name is the name of the action script. So you can use the file name to apply the script in the test for execution.</p>
</div>
<div class="listingblock">
<div class="title">Apply Groovy script</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then apply actions {file_name}.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use a shortcut syntax to directly call a test action.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^${{action_code})$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then $(echo('Hello from Groovy script!'))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will add a new <code>echo</code> test action and run the action. The action code uses a Groovy script that defines the test action
by using the common Citrus test action domain specific language.</p>
</div>
<div class="paragraph">
<p>You can apply multiline scripts directly, too.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^apply script$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given apply script
    """
    $actions {
        $(delay().seconds(1))

        $(echo('Hello from Groovy script!'))
    }
    """</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-groovy-finally-actions"><a class="anchor" href="#steps-groovy-finally-actions"></a><a class="link" href="#steps-groovy-finally-actions">50.3.4. Finally actions</a></h4>
<div class="paragraph">
<p>Sometimes it is mandatory to cleanup test data after a scenario. It would be good to have a set of test actions that
get executed in a guaranteed way - even in case the test scenario failed with errors before.</p>
</div>
<div class="paragraph">
<p>The Citrus framework provides a concept of <code>finally block</code> actions. These actions will be run after the test in all
circumstances (success and failure).</p>
</div>
<div class="listingblock">
<div class="title">Finally block actions</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given apply script
    """
    $finally {
        echo('${greeting} in finally!')
    }
    """</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an alternative syntax you can add a 'doFinally()' test action to your script.</p>
</div>
<div class="listingblock">
<div class="title">Finally test action</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given apply script
    """
    $actions {
        $(doFinally().actions(
            echo('${greeting} in finally!')
        ))
    }
    """</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is how you can define test actions in Groovy that get executed after the test.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tools-cucumber-steps-http"><a class="anchor" href="#tools-cucumber-steps-http"></a><a class="link" href="#tools-cucumber-steps-http">50.4. Http steps</a></h3>
<div class="paragraph">
<p>The Http protocol is a widely used communication protocol when it comes to exchanging data between systems. REST Http services
are very prominent and producing/consuming those services is a common task in software development these days. Citrus provides
ready to use steps that are able to exchange request/response messages via Http as a client and server during the test.</p>
</div>
<div class="paragraph">
<p>The sample below shows how to use Http communication in a test:</p>
</div>
<div class="listingblock">
<div class="title">Http communication sample</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Feature: Http client

  Background:
    Given URL: https://hello-service

  Scenario: Health check
    Given path /health is healthy

  Scenario: GET request
    When send GET /todo
    Then verify HTTP response body: {"id": "@ignore@", "task": "Sample task", "completed": 0}
    And receive HTTP 200 OK</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above sets a base request URL to <code><a href="https://hello-service" class="bare">https://hello-service</a></code> and performs a health check on path <code>/health</code>. After that we can
send a Http <code>GET</code> request to the endpoint and verify the response status code.</p>
</div>
<div class="paragraph">
<p>All steps shown are part of the Citrus framework so you can use them out of the box. The next sections explore the Http
capabilities in more detail.</p>
</div>
<div class="sect3">
<h4 id="steps-http-client"><a class="anchor" href="#steps-http-client"></a><a class="link" href="#steps-http-client">50.4.1. Http client steps</a></h4>
<div class="paragraph">
<p>As a client you can specify the server URL and send requests to it.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:URL|url): {url}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given URL: {url}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The given URL points to a server endpoint. All further client Http steps send the requests to that endpoint.</p>
</div>
<div class="paragraph">
<p>As an alternative you can reference a Http client component that previously has been added to the framework configuration.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^HTTP client \"{name}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP client "{name}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step loads a Http client component by its name and uses that for further requests.</p>
</div>
<div class="paragraph">
<p>Once you have configured the Http endpoint URL or the Http client you can start sending request messages.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-http-client-request"><a class="anchor" href="#steps-http-client-request"></a><a class="link" href="#steps-http-client-request">50.4.2. Send Http requests</a></h4>
<div class="paragraph">
<p>Sending requests via Http is as easy as choosing the Http method (GET, POST, PUT, DELETE, &#8230;&#8203;) to use.</p>
</div>
<div class="listingblock">
<div class="title">@When("^send (GET|HEAD|POST|PUT|PATCH|DELETE|OPTIONS|TRACE) {path}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send {method} {path}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The given path resides to a valid resource on the server endpoint. The resource path is added to the base URL and identifies the resource
on the server.</p>
</div>
<div class="listingblock">
<div class="title">Send Http GET request</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send GET /todo</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can choose the Http method that should be used to send the request (e.g. <code>GET</code>). Of course the request can have headers and a message body.
You need to set these before sending the request in separate steps.</p>
</div>
<div class="sect4">
<h5 id="request-headers"><a class="anchor" href="#request-headers"></a><a class="link" href="#request-headers">Request headers</a></h5>
<div class="listingblock">
<div class="title">@Given("^HTTP request header {name}=\"{value}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP request header {name}="{value}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step above adds a Http header to the request. The header is defined with a name and receives a value. You can set
multiple headers in a single step, too:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^HTTP request headers$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP request headers
  | {name} | {value} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step uses a data table to define multiple message headers with name and value.</p>
</div>
<div class="listingblock">
<div class="title">Set request headers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP request headers
  | Accept          | application/json |
  | Accept-Encoding | gzip |</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="request-body"><a class="anchor" href="#request-body"></a><a class="link" href="#request-body">Request body</a></h5>
<div class="paragraph">
<p>The Http request can have a body content which is sent as part of the request.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^HTTP request body: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP request body: {body}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step above specifies the Http request body in a single line. When you need to use multiline body content please use the next step:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^HTTP request body$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP request body
"""
&lt;&lt;content&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the request body is getting too big it may be a better idea to load the content from an external file resource:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load HTTP request body {file}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load HTTP request body {file}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step loads the body content from the given file resource.</p>
</div>
</div>
<div class="sect4">
<h5 id="request-parameters"><a class="anchor" href="#request-parameters"></a><a class="link" href="#request-parameters">Request parameters</a></h5>
<div class="paragraph">
<p>The Http request is able to use parameters that get added to the request URL. You can set those parameters in a separate step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^HTTP request query parameter {name}=\"{value}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP request query parameter {name}="{value}"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="request-timeouts"><a class="anchor" href="#request-timeouts"></a><a class="link" href="#request-timeouts">Request timeouts</a></h5>
<div class="paragraph">
<p>In some cases the client waits a long time for the server to respond. As Http is a synchronous communication protocol by its nature
the client will synchronously wait for the response before doing any other step. You can specify the time to wait for the server to respond.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^HTTP request timeout is {time} milliseconds$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP request timeout is {time} milliseconds</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sets the client timeout to thee given time in milliseconds.</p>
</div>
</div>
<div class="sect4">
<h5 id="request-fork-mode"><a class="anchor" href="#request-fork-mode"></a><a class="link" href="#request-fork-mode">Request fork mode</a></h5>
<div class="paragraph">
<p>As seen in the previous section Http is synchronous by default. This can be a problem when the test needs to do multiple things in parallel. By default the Http
client step will always block any other step until the server response has been received. You can change this behavior to an asynchronous behavior so the
next steps will not be blocked by the Http client step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^HTTP request fork mode is (enabled|disabled)$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP request fork mode is enabled</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will enable the fork mode so all client request will be non-blocking. By default the fork mode is disabled.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-http-client-request-raw"><a class="anchor" href="#steps-http-client-request-raw"></a><a class="link" href="#steps-http-client-request-raw">50.4.3. Send raw Http request data</a></h4>
<div class="paragraph">
<p>In the previous section several steps have defined the Http request (header, parameter, body) before sending the message
in a separate step. As an alternative to this approach you can also specify the complete Http request data in a single step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^send HTTP request$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given send HTTP request
"""
&lt;&lt;request_data&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next example shows the complete Http request data step:</p>
</div>
<div class="listingblock">
<div class="title">Send raw Http request data</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given send HTTP request
"""
GET https://hello-service
Accept-Charset:utf-8
Accept:application/json, application/*+json, */*
Host:localhost:8080
Content-Type:text/plain;charset=UTF-8
"""</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-http-client-response"><a class="anchor" href="#steps-http-client-response"></a><a class="link" href="#steps-http-client-response">50.4.4. Verify Http responses</a></h4>
<div class="paragraph">
<p>The time you send out a Http request you will be provided with a response from the server. Citrus is able to verify the
Http response content in order to make sure that the server has processed the request as expected.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^receive HTTP {status_code}(?: {reason_phrase})?$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then receive HTTP {status_code} {reason_phrase}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The most critical part of the Http response is thee status code (e.g. 200, 404, 500). The status code should refer to the success
or error of the request. The server can use a wide range of Http status codes that are categorized as follows,
also see <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec6.html">W3C</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>1xx</em> informational response – the request was received, continuing process</p>
</li>
<li>
<p><em>2xx</em> successful – the request was successfully received, understood, and accepted</p>
</li>
<li>
<p><em>3xx</em> redirection – further action needs to be taken in order to complete the request</p>
</li>
<li>
<p><em>4xx</em> client error – the request contains bad syntax or cannot be fulfilled</p>
</li>
<li>
<p><em>5xx</em> server error – the server failed to fulfil an apparently valid request</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Verify Http status code</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then receive HTTP 200 OK</code></pre>
</div>
</div>
<div class="paragraph">
<p>The reason phrase <code>OK</code> is optional and is also not part of the verification mechanism for the response. It just gives human readers
a better understanding of the status code.</p>
</div>
<div class="paragraph">
<p>Of course the Http response can also have headers and a message body. Citrus is able to verify those response data, too. Please
define the expected headers and body content before verifying the status code.</p>
</div>
<div class="sect4">
<h5 id="response-headers"><a class="anchor" href="#response-headers"></a><a class="link" href="#response-headers">Response headers</a></h5>
<div class="listingblock">
<div class="title">@Then("^expect HTTP response header {name}=\"{value}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then expect HTTP response header {name}="{value}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step above adds a Http header to the response. The header is defined with a name and receives a value. You can set
multiple headers in a single step, too:</p>
</div>
<div class="listingblock">
<div class="title">@Then("^expect HTTP response headers$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then expect HTTP response headers
  | {name} | {value} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step uses a data table to define multiple message headers with name and value.</p>
</div>
<div class="listingblock">
<div class="title">Verify response headers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then expect HTTP response headers
  | Encoding     | gzip |
  | Content-Type | application/json |</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="header-name-ignore-case"><a class="anchor" href="#header-name-ignore-case"></a><a class="link" href="#header-name-ignore-case">Header name ignore case</a></h5>
<div class="paragraph">
<p>Header names are not case-sensitive per Http specification. This means servers and clients may choose the header name case individually. In order to avoid verification errors when expecting headers in Http the header validation mechanism in Citrus is able to ignore the header name case.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^HTTP header name ignore case is (enabled|disabled)$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP header name ignore case is enabled</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will enable the mode where header name verification is case-insensitive.</p>
</div>
<div class="paragraph">
<p>You may also use an environment setting <code>CITRUS_HTTP_HEADER_NAME_IGNORE_CASE=true/false</code> to enable/disable the setting for the whole test suite. By default, the setting is disabled so header names are verified with case-sensitive mode.</p>
</div>
</div>
<div class="sect4">
<h5 id="response-body"><a class="anchor" href="#response-body"></a><a class="link" href="#response-body">Response body</a></h5>
<div class="listingblock">
<div class="title">@Then("^expect HTTP response body: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then expect HTTP response body: {body}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step above specifies the Http response body in a single line. When you need to use multiline body content please use the next step:</p>
</div>
<div class="listingblock">
<div class="title">@Then("^expect HTTP response body$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then expect HTTP response body
"""
&lt;&lt;content&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the response body is getting too big it may be a better idea to load the content from an external file resource:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^expect HTTP response body loaded from {file}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given expect HTTP response body loaded from {file}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step loads the body content from the given file resource.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-http-client-response-raw"><a class="anchor" href="#steps-http-client-response-raw"></a><a class="link" href="#steps-http-client-response-raw">50.4.5. Verify raw Http response data</a></h4>
<div class="paragraph">
<p>In the previous section several steps have defined the Http response (header, parameter, body) before verifying the message
received. As an alternative to this approach you can also specify the complete expected Http response data in a single step.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^receive HTTP response$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then receive HTTP response
"""
&lt;&lt;response_data&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next example shows the complete Http response data step:</p>
</div>
<div class="listingblock">
<div class="title">Verify raw Http response data</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then receive HTTP response
"""
HTTP/1.1 200 OK
Content-Type:application/json
X-TodoId:@isNumber()@
Date: @ignore@

{"id": "@ignore@", "task": "Sample task", "completed": 0}
"""</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-http-response-jsonpath"><a class="anchor" href="#steps-http-response-jsonpath"></a><a class="link" href="#steps-http-response-jsonpath">50.4.6. Verify response using JsonPath</a></h4>
<div class="paragraph">
<p>When verifying Http client responses sent by the server you can use JsonPath expressions to validate
the response message body content.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^(?:expect|verify) HTTP response expression: {expression}=\"{value}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then expect HTTP response expression: {expression}="{value}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step defines a JsonPath expression (e.g. <code>$.person.age</code>) and an expected value. The expression is evaluated against
the received response message body and the value is compared to the expected value. This way you can explicitly verify elements
in the Json body.</p>
</div>
<div class="paragraph">
<p>The very same mechanism also applies to XML message body content. Just use a XPath expression instead of JsonPath.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-http-server"><a class="anchor" href="#steps-http-server"></a><a class="link" href="#steps-http-server">50.4.7. Http server steps</a></h4>
<div class="paragraph">
<p>On the server side Citrus needs to start a Http server instance on a given port and listen for incoming requests.
The test is able to verify incoming requests and then provide a simulated response message with response headers and body content.</p>
</div>
<div class="listingblock">
<div class="title">Http communication sample</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Feature: Http server

  Background:
    Given HTTP server listening on port 8080
    And start HTTP server

  Scenario: Expect GET request
    When receive GET /todo
    Then HTTP response body:  {"id": 1000, "task": "Sample task", "completed": 0}
    And send HTTP 200 OK

  Scenario: Expect POST request
    Given expect HTTP request body: {"id": "@isNumber()@", "task": "New task", "completed": "@matches(0|1)@"}
    When receive POST /todo
    Then send HTTP 201 CREATED</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the HTTP server sample above we create a new server instance listening on port <code>8080</code>. Then we expect a <code>GET</code> request on path <code>/todo</code>. The server responds with
a Http <code>200 OK</code> response message and given Json body as payload.</p>
</div>
<div class="paragraph">
<p>The second scenario expects a POST request with a given body as Json payload. The expected request payload is verified with the powerful Citrus JSON
message validator being able to compare JSON tree structures in combination with validation matchers such as <code>isNumber()</code> or <code>matches(0|1)</code>.</p>
</div>
<div class="paragraph">
<p>After the request verification has passed the server responds with a simple Http <code>201 CREATED</code>.</p>
</div>
<div class="paragraph">
<p>The next sections guide you through the Http server capabilities in Citrus.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-http-server-config"><a class="anchor" href="#steps-http-server-config"></a><a class="link" href="#steps-http-server-config">50.4.8. Http server configuration</a></h4>
<div class="paragraph">
<p>When the test run starts Citrus will initialize the Http server instance and listen on a port for incoming requests.</p>
</div>
<div class="sect4">
<h5 id="http-server-port"><a class="anchor" href="#http-server-port"></a><a class="link" href="#http-server-port">Http server port</a></h5>
<div class="paragraph">
<p>By default this server uses the port <code>8080</code>, but you can adjust the port with following step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^HTTP server listening on port {port}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP server listening on port {port}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="http-server-timeout"><a class="anchor" href="#http-server-timeout"></a><a class="link" href="#http-server-timeout">Http server timeout</a></h5>
<div class="paragraph">
<p>The test waits for incoming requests but the test may hit request timeouts when no request has been received. By default
the server waits for five seconds each time a request is expected. You can adjust the server timeout.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^HTTP server timeout is {time} milliseconds$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP server timeout is {time} milliseconds</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sets the server timeout to the given time in milliseconds.</p>
</div>
</div>
<div class="sect4">
<h5 id="http-server-component"><a class="anchor" href="#http-server-component"></a><a class="link" href="#http-server-component">Http server component</a></h5>
<div class="paragraph">
<p>You can use the default Http server instance that is automatically created
or reference server component in the project configuration (e.g. Spring bean, component configuration).</p>
</div>
<div class="listingblock">
<div class="title">@Given("^HTTP server \"{name}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP server "{name}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step loads a Http server component by its name and uses that for server side testing.</p>
</div>
</div>
<div class="sect4">
<h5 id="create-http-server"><a class="anchor" href="#create-http-server"></a><a class="link" href="#create-http-server">Create Http server</a></h5>
<div class="paragraph">
<p>When dealing with multiple server components at the same time or when a fresh server instance is required you
can create a new Http server with:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:create|new) HTTP server \"{name}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given new HTTP server "{name}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates a fresh Http server instance. Please mind that a port can only be bound once so you may need to stop
other server instances or choose another server port.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:create|new) HTTP server \"{name}\" with configuration$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given new HTTP server "{name}" with configuration
| port    | 8081 |
| timeout | 1000 |</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-http-server-request"><a class="anchor" href="#steps-http-server-request"></a><a class="link" href="#steps-http-server-request">50.4.9. Receive Http requests</a></h4>
<div class="paragraph">
<p>You can define expected incoming Http requests as part of the test.</p>
</div>
<div class="listingblock">
<div class="title">@When("^receive (GET|HEAD|POST|PUT|PATCH|DELETE|OPTIONS|TRACE) {path}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When receive {method} {path}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The incoming request must match the given '{method}` and <code>{path}</code>.</p>
</div>
<div class="listingblock">
<div class="title">Receive Http GET request</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When receive GET /todo</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, you can also verify headers and the request message body.
You need to specify the expected request before receiving the request with the <code>receive</code> steps.</p>
</div>
<div class="sect4">
<h5 id="request-headers-2"><a class="anchor" href="#request-headers-2"></a><a class="link" href="#request-headers-2">Request headers</a></h5>
<div class="listingblock">
<div class="title">@Given("^(?:expect|verify) HTTP request header {name}=\"{value}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given expect HTTP request header {name}="{value}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step above adds the Http header to the request validation. The header must be present in the incoming request and
must match the expected value. You can verify multiple headers in a single step, too:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:expect|verify) HTTP request headers$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given expect HTTP request headers
  | {name} | {value} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step uses a data table to define the message headers with name and value.</p>
</div>
<div class="listingblock">
<div class="title">Expect request headers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given expect HTTP request headers
  | Accept          | application/json |
  | Accept-Encoding | gzip |</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="request-body-2"><a class="anchor" href="#request-body-2"></a><a class="link" href="#request-body-2">Request body</a></h5>
<div class="paragraph">
<p>Each incoming Http request can have a body and you are able to verify the body content in multiple ways.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:expect|verify) HTTP request body: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given expect HTTP request body: {body}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step above specifies the expected Http request body in a single line. Multiline body content must use the next step:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:expect|verify) HTTP request body$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given expect HTTP request body
"""
&lt;&lt;content&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the request body is getting too big it may be a better idea to load the content from an external file resource:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^expect HTTP request body loaded from {file}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given expect HTTP request body loaded from {file}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step loads the body content from the given file resource.</p>
</div>
</div>
<div class="sect4">
<h5 id="request-parameters-2"><a class="anchor" href="#request-parameters-2"></a><a class="link" href="#request-parameters-2">Request parameters</a></h5>
<div class="paragraph">
<p>The Http request can have parameters on the request URL. You can verify those parameters in a separate step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:expect|verify) HTTP request query parameter {name}=\"{value}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given expect HTTP request query parameter {name}="{value}"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-http-server-request-raw"><a class="anchor" href="#steps-http-server-request-raw"></a><a class="link" href="#steps-http-server-request-raw">50.4.10. Receive raw Http request data</a></h4>
<div class="paragraph">
<p>In the previous section several steps have defined the expected Http request (header, parameter, body).
As an alternative to this approach you can also specify the complete Http request data in a single step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^receive HTTP request$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given receive HTTP request
"""
&lt;&lt;request_data&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next example shows the complete Http request data step:</p>
</div>
<div class="listingblock">
<div class="title">Receive raw Http request data</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given receive HTTP request
"""
GET https://hello-service
Accept-Charset:utf-8
Accept:application/json, application/*+json, */*
Host:localhost:8080
Content-Type:text/plain;charset=UTF-8
"""</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-http-request-jsonpath"><a class="anchor" href="#steps-http-request-jsonpath"></a><a class="link" href="#steps-http-request-jsonpath">50.4.11. Verify requests using JsonPath</a></h4>
<div class="paragraph">
<p>When verifying Http client requests you can use JsonPath expressions to validate
the request message body content.</p>
</div>
<div class="listingblock">
<div class="title">@When("^(?:expect|verify) HTTP request expression: {expression}=\"{value}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When expect HTTP request expression: {expression}="{value}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step defines a JsonPath expression (e.g. <code>$.person.age</code>) and an expected value. The expression is evaluated against
the received request message body and the value is compared to the expected value. This way you can explicitly verify elements
in the Json body.</p>
</div>
<div class="paragraph">
<p>The very same mechanism also applies to XML message body content. Just use a XPath expression instead of JsonPath.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-http-server-response"><a class="anchor" href="#steps-http-server-response"></a><a class="link" href="#steps-http-server-response">50.4.12. Send Http responses</a></h4>
<div class="paragraph">
<p>The time you have verified a Http request as a server you need to provided a proper response to the calling client.
Citrus is able to simulate the Http response content.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^send HTTP {status_code}(?: {reason_phrase})?$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then send HTTP {status_code} {reason_phrase}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step defines the Http response status code (e.g. 200, 404, 500) to return.</p>
</div>
<div class="listingblock">
<div class="title">Return Http status code</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then send HTTP 200 OK</code></pre>
</div>
</div>
<div class="paragraph">
<p>The reason phrase <code>OK</code> is optional. It just gives human readers a
better understanding of the status code returned.</p>
</div>
<div class="paragraph">
<p>Of course the Http response can also have headers and a message body. Citrus is able to simulate this response data, too.</p>
</div>
<div class="sect4">
<h5 id="response-headers-2"><a class="anchor" href="#response-headers-2"></a><a class="link" href="#response-headers-2">Response headers</a></h5>
<div class="listingblock">
<div class="title">@Given("^HTTP response header {name}=\"{value}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP response header {name}="{value}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step above adds a Http header to the response. The header is defined with a name and value. You can set
multiple headers in a single step, too:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^HTTP response headers$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP response headers
  | {name} | {value} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step uses a data table to define multiple message headers with name and value.</p>
</div>
<div class="listingblock">
<div class="title">Return response headers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP response headers
  | Encoding     | gzip |
  | Content-Type | application/json |</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="response-body-2"><a class="anchor" href="#response-body-2"></a><a class="link" href="#response-body-2">Response body</a></h5>
<div class="listingblock">
<div class="title">@Given("^HTTP response body: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP response body: {body}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step above specifies the Http response body in a single line. When you need to use multiline body content please use the next step:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^HTTP response body$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP response body
"""
&lt;&lt;content&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the response body is getting too big it may be a better idea to load the content from an external file resource:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load HTTP response body {file}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load HTTP response body {file}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step loads the body content from the given file resource.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-http-server-response-raw"><a class="anchor" href="#steps-http-server-response-raw"></a><a class="link" href="#steps-http-server-response-raw">50.4.13. Send raw Http response data</a></h4>
<div class="paragraph">
<p>In the previous section several steps have defined the Http response (header, parameter, body).
As an alternative to this approach you can also specify the complete Http response data in a single step.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^send HTTP response$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then send HTTP response
"""
&lt;&lt;response_data&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next example shows the complete Http response data step:</p>
</div>
<div class="listingblock">
<div class="title">Return raw Http response data</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then send HTTP response
"""
HTTP/1.1 200 OK
Content-Type:application/json
X-TodoId:@isNumber()@
Date: @ignore@

{"id": "@ignore@", "task": "Sample task", "completed": 0}
"""</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-http-health-checks"><a class="anchor" href="#steps-http-health-checks"></a><a class="link" href="#steps-http-health-checks">50.4.14. Http health checks</a></h4>
<div class="paragraph">
<p>Often Http server provide a health endpoint so clients can check the status of the server to be up and running. The health check is supported with the following steps.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^{URL} is healthy$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given {URL} is healthy</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step performs a health check on the given <code>{URL}</code> by sending a request to the endpoint and checking for a response status code marking success (200 OK).</p>
</div>
<div class="listingblock">
<div class="title">Health check</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given https://some-service-url/health is healthy</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of specifying the complete health check URL you can make use of the base URL given in the central Http step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^URL {path} is healthy$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given path {path} is healthy</code></pre>
</div>
</div>
<div class="paragraph">
<p>The given path is added to the base URL and should resolve to the health check resource on the server (e.g. <code>/health</code>).</p>
</div>
<div class="listingblock">
<div class="title">Health path check</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given URL: https://hello-service
Given path /health is healthy</code></pre>
</div>
</div>
<div class="paragraph">
<p>The steps above perform the health check only a single time. Based on the provided Http server response status the step passes or fails.
In some cases can not make sure that the server has been started yet and the health check might fail occasionally. In these cases
it is a good iodea to use the wait health check step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^wait for URL {url}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given wait for URL {url}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step will wait for given URL to return a <code>200 OK</code> response. The step is actively waiting while polling the URL multiple times when the response is
not positive. By default this step uses a <code>HEAD</code> request. You can explicitly choose another Http method, too.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^wait for (GET|HEAD|POST|PUT|PATCH|DELETE|OPTIONS|TRACE) on URL {url}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given wait for GET on URL {url}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sample above uses a <code>GET</code> request for the health checks.</p>
</div>
<div class="paragraph">
<p>Also you can explicitly specify the expected return code that must match in order to pass the wait health check.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^wait for URL {url} to return {status_code}(?: {reason_phrase}?$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given wait for URL {url} to return {status_code} {reason_phrase}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once again the <code>{reason_phrase}</code> is optional and only for better readability reasons.</p>
</div>
<div class="listingblock">
<div class="title">Wait for specific status code</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given wait for URL https://hello-service/health to return 200 OK</code></pre>
</div>
</div>
<div class="paragraph">
<p>Last not least you can specify the request method on the wait operation, too.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^wait for (GET|HEAD|POST|PUT|PATCH|DELETE|OPTIONS|TRACE) on URL {url} to return {status_code}(?: {reason_phrase}?$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given wait for {method} on URL {url} to return {status_code} {reason_phrase}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This completes the health check capabilities in the Http steps.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-http-secure"><a class="anchor" href="#steps-http-secure"></a><a class="link" href="#steps-http-secure">50.4.15. Https support</a></h4>
<div class="paragraph">
<p>Citrus steps support secure Http connections on both client and server.</p>
</div>
<div class="paragraph">
<p>On the client side enabling secure Http connection is as simple as defining a request URL
with <code>https</code> scheme.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:URL|url): {url}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given URL: https://some.endpoint/path</code></pre>
</div>
</div>
<div class="paragraph">
<p>Citrus is going to initialize the client with a SSL request factory and use secure Http connections.</p>
</div>
<div class="paragraph">
<p>On the server side you have to enable secure Http with the following step:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^enable secure HTTP server$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given enable secure HTTP server</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please use this step before starting the server with:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^start HTTP server$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given start HTTP server</code></pre>
</div>
</div>
<div class="paragraph">
<p>The secure SSL connector uses the port <code>8443</code> by default. You can adjust this secure port
with:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^HTTP server secure port {port}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP server secure port {port}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Http server uses a default SSL keystore with a self signed certificate. Users are able
to customize the server certificate with a custom SSL keystore.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^HTTP server SSL keystore path {file}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP server SSL keystore path {file}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">@Given("^HTTP server SSL keystore password {password}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given HTTP server SSL keystore password {password}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The steps set a custom keystore (e.g. server.jks) file and a custom keystore password.</p>
</div>
<div class="paragraph">
<p>The keystore settings are also accessible via environment variables.</p>
</div>
<div class="listingblock">
<div class="title">SSL keystore environment variables</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">CITRUS_HTTP_SECURE_KEYSTORE_PATH={file}
CITRUS_HTTP_SECURE_KEYSTORE_PASSWIRD={password}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Http server components also provide a convenient way to add server properties when creating
new instances:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:create|new) HTTP server \"{name}\" with configuration$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given new HTTP server "{name}" with configuration
| secure              | true       |
| securePort          | 8443       |
| timeout             | 1000       |
| sslKeystorePath     | server.jks |
| sslKeystorePassword | secret     |</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tools-cucumber-steps-jdbc"><a class="anchor" href="#tools-cucumber-steps-jdbc"></a><a class="link" href="#tools-cucumber-steps-jdbc">50.5. JDBC steps</a></h3>
<div class="paragraph">
<p>Citrus provides steps that allow executing SQL actions on relational databases. This includes updates and queries.
In case of a database query you are able to verify the result set with expected values.</p>
</div>
<div class="sect3">
<h4 id="steps-jdbc-datasource"><a class="anchor" href="#steps-jdbc-datasource"></a><a class="link" href="#steps-jdbc-datasource">50.5.1. Connection configuration</a></h4>
<div class="paragraph">
<p>Before running any SQL statement you need to configure a datasource that allows connecting to the
database.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:D|d)atabase connection$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Database connection
| {property} | {value} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step configures a new database connection and uses a data table to define connection properties such as connection
URL, username and password.</p>
</div>
<div class="listingblock">
<div class="title">Specify connection properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Database connection
| driver    | org.postgresql.Driver |
| url       | jdbc:postgresql://localhost:5432/testdb |
| username  | test |
| password  | secret |</code></pre>
</div>
</div>
<div class="paragraph">
<p>This defines the connection parameters so the test is able to connect to the database.</p>
</div>
<div class="paragraph">
<p>In addition to that you can also reference an existing datasource that has been added to the
framework configuration.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:D|d)ata source: {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Data source: {name}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The name of the datasource should reference a configured component in the test project. You can add components as Spring beans
for instance.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-jdbc-update"><a class="anchor" href="#steps-jdbc-update"></a><a class="link" href="#steps-jdbc-update">50.5.2. SQL update</a></h4>
<div class="paragraph">
<p>The test is able to run SQL updates (UPDATE, INSERT, DELETE) on the database.</p>
</div>
<div class="listingblock">
<div class="title">@When("^(?:execute |perform )?SQL update: {statement}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When execute SQL update: {statement}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step executes the given SQL statement using the configured database connection. For multiline statements please use:</p>
</div>
<div class="listingblock">
<div class="title">@When("^(?:execute |perform )?SQL update$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When execute SQL update
"""
{statement}
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also run multiple statements in a single step by using a data table.</p>
</div>
<div class="listingblock">
<div class="title">@When("^(?:execute |perform )?SQL updates$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When execute SQL updates
| {statement_1} |
| {statement_2} |
...
| {statement_x} |</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-jdbc-query"><a class="anchor" href="#steps-jdbc-query"></a><a class="link" href="#steps-jdbc-query">50.5.3. SQL query</a></h4>
<div class="paragraph">
<p>The SQL query obtains data from the database in form of result sets. The Citrus test is able to verify the result sets with an expected
set of rows and column values returned.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^SQL query: {statement}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given SQL query: {statement}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step defines the query to execute. Multiline SQL query statements are supported, too.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^SQL query$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given SQL query
"""
{statement}
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also run multiple queries in one step. As usual the step uses a data table.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^SQL query statements$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When SQL query statements
| {statement_1} |
| {statement_2} |
...
| {statement_x} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a next step you can provide the expected outcome in form of column name and value.</p>
</div>
<div class="sect4">
<h5 id="verify-sql-result-set"><a class="anchor" href="#verify-sql-result-set"></a><a class="link" href="#verify-sql-result-set">Verify SQL result set</a></h5>
<div class="listingblock">
<div class="title">@Then("^verify column {name}={value}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then verify column {name}={value}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step executes the query and verifies the column with given name to match the expected value.</p>
</div>
<div class="paragraph">
<p>You can use multiple verifications on several columns with a data table.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^verify columns$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then verify columns
| {column_1} | {value_1_1} | {value_1_2} |
| {column_2} | {value_2_1} | {value_2_2} |
...
| {column_x} | {value_x_x} | {value_x_x} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The data table is able to verify a matrix of rows and columns. Each column can have multiple row values.</p>
</div>
<div class="listingblock">
<div class="title">Validate multi row result sets</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given SQL query: SELECT ID, TASK, COMPLETED FROM todo ORDER BY id
Then verify columns
| ID        | 1                  | 2             | 3          | 4            | @ignore@               |
| TASK      | Learn some Camel K! | Get some milk | Do laundry | Wash the dog | Test Camel with Citrus! |
| COMPLETED | 0                  | 0             | 0          |            0 | 0                      |</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="result-set-verification-script"><a class="anchor" href="#result-set-verification-script"></a><a class="link" href="#result-set-verification-script">50.5.4. Result set verification script</a></h4>
<div class="paragraph">
<p>For more complex result set validation you can use a Groovy result set verification script.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^verify result set$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then verify result set
"""
&lt;&lt;Groovy&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Groovy script can work with the complete result set and is quite powerful.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given SQL query: SELECT TASK FROM todo
Then verify result set
"""
assert rows.size == 1
assert rows[0].TASK == 'Learn some Camel K!'
"""</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="steps-tools-cucumber-steps-jms"><a class="anchor" href="#steps-tools-cucumber-steps-jms"></a><a class="link" href="#steps-tools-cucumber-steps-jms">50.6. JMS steps</a></h3>
<div class="paragraph">
<p>JMS is well-known as transport for point-to-point and publish/subscribe messaging. Users can produce and consume messages on
queues and topics on a message broker.</p>
</div>
<div class="paragraph">
<p>Citrus has support for JMS related messaging on both producer and consumer.</p>
</div>
<div class="sect3">
<h4 id="steps-jms-connection-factory"><a class="anchor" href="#steps-jms-connection-factory"></a><a class="link" href="#steps-jms-connection-factory">50.6.1. Connection factory</a></h4>
<div class="paragraph">
<p>The JMS standard requires clients to open connections over a connection factory. The connection factory is a vendor specific
implementation and receives a set of properties such as connection URL, username and password.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:JMS|jms) connection factory$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given JMS connection factory
| {property} | {value} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration step receives a data table that defines the connection settings.</p>
</div>
<div class="listingblock">
<div class="title">Connection factory settings</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given JMS connection factory
| type       | org.apache.activemq.artemis.jms.client.ActiveMQConnectionFactory |
| brokerUrl  | tcp://localhost:61616 |
| username   | ${activemq.user}      |
| password  | ${activemq.password}  |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The connection factory type is vendor specific and depends on what kind of message broker you are using in your environment. Please
make sure to add the respective client library as a project dependency in the Citrus configuration.</p>
</div>
<div class="paragraph">
<p>Sensitive values such as <code>username</code> and <code>password</code> can be set with a test variable placeholder. The variable value can
be set by a secret in Kubernetes/Openshift. This ensures to not share sensitive data in the public.</p>
</div>
<div class="paragraph">
<p>As an alternative to defining the connection factory as part of the test steps you can load a predefined connection factory
component from the configuration.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:JMS|jms) connection factory {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given JMS connection factory {name}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step references a connection factory component that has been added to the framework configuration (e.g. as Spring bean).
This way you can share the connection factory in multiple tests.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-jms-endpoint"><a class="anchor" href="#steps-jms-endpoint"></a><a class="link" href="#steps-jms-endpoint">50.6.2. Destination and endpoint configuration</a></h4>
<div class="paragraph">
<p>In addition to the connection factory the test needs to specify the JMS destination (queue or topic) to use.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:JMS|jms) destination: {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given JMS destination: {name}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sets the destination name for the next steps. As an alternative to that you can also reference a predefined endpoint
component from the configuration.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:JMS|jms) endpoint \"{name}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given JMS endpoint {name}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step tries to resolve the JMS endpoint with given <code>{name}</code> in the available configuration. The endpoint has a destination set
and references a connection factory on its own.</p>
</div>
<div class="paragraph">
<p>So now the test is ready to produce and consume messages from JMS destinations.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-jms-send"><a class="anchor" href="#steps-jms-send"></a><a class="link" href="#steps-jms-send">50.6.3. Send JMS messages</a></h4>
<div class="paragraph">
<p>A test can publish messages on a JMS destination. The message consists of message headers and a body content. Before sending a message
the tests needs to specify the message content.</p>
</div>
<div class="sect4">
<h5 id="message-headers"><a class="anchor" href="#message-headers"></a><a class="link" href="#message-headers">Message headers</a></h5>
<div class="paragraph">
<p>The message headers are key value pairs that are sent as part of the message. You can add a new header with the following step:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:JMS|jms) message header {name}(?:=| is )\"{value}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given JMS message header {name}="{value}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using a data table you can set multiple headers in one step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:JMS|jms) message headers$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given JMS message headers
| {header_1} | {value_1} |
| {header_2} | {value_2} |
...
| {header_x} | {value_x} |</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="message-body"><a class="anchor" href="#message-body"></a><a class="link" href="#message-body">Message body</a></h5>
<div class="listingblock">
<div class="title">@Given("^(?:JMS|jms) message body: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given JMS message body: {body}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step can set a single line body content. Of course you can also work with multiline body content.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:JMS|jms) message body$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given JMS message body
"""
{body}
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the body is getting too big it may be a better idea to load the content from an external file resource:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load (?:JMS|jms) message body {file}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load JMS message body {file}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step loads the body content from the given file resource.</p>
</div>
<div class="paragraph">
<p>Now another step can send the message as it has been specified in the previous steps.</p>
</div>
<div class="listingblock">
<div class="title">@When("^send (?:JMS|jms) message$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send JMS message</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sends the message to the previously configured JMS destination. You can overwrite this destination in the send step.</p>
</div>
<div class="listingblock">
<div class="title">@When("^send (?:JMS|jms) message to destination {destination}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send JMS message to destination {destination}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The approach described clearly separates message specification and send operation as all of it is done in separate steps.
As an alternative you can also specify the message content in one step.</p>
</div>
<div class="listingblock">
<div class="title">@When("^send (?:JMS|jms) message with body: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send JMS message with body: {body}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also add some message headers to this step.</p>
</div>
<div class="listingblock">
<div class="title">@When("^send (?:JMS|jms) message with body and headers: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send JMS message with body and headers: {body}
| {header_1} | {value_1} |
| {header_2} | {value_2} |
...
| {header_x} | {value_x} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step combines message header and body specification with the actual send operation.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-jms-receive"><a class="anchor" href="#steps-jms-receive"></a><a class="link" href="#steps-jms-receive">50.6.4. Receive JMS messages</a></h4>
<div class="paragraph">
<p>Similar to sending messages to a JMS destination the test can also consume messages from a queue or topic. When the message
has been received a validation mechanism makes sure that the message content received matches the expectations.</p>
</div>
<div class="paragraph">
<p>Users are able to provide expected message headers and body content in order to verify the received message.</p>
</div>
<div class="sect4">
<h5 id="message-headers-2"><a class="anchor" href="#message-headers-2"></a><a class="link" href="#message-headers-2">Message headers</a></h5>
<div class="paragraph">
<p>The expected message headers need to be set before receiving the message from the destination.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:JMS|jms) message header {name}(?:=| is )\"{value}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given JMS message header {name}="{value}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using a data table you can expect multiple headers in one step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:JMS|jms) message headers$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given JMS message headers
| {header_1} | {value_1} |
| {header_2} | {value_2} |
...
| {header_x} | {value_x} |</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="message-body-2"><a class="anchor" href="#message-body-2"></a><a class="link" href="#message-body-2">Message body</a></h5>
<div class="paragraph">
<p>In addition to verify message headers you can also verify the body content. Once again the user specifies the expected message
body before the message is received.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:JMS|jms) message body: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given JMS message body: {body}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step can expect a single line body content. Of course you can also work with multiline body content.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:JMS|jms) message body$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given JMS message body
"""
{body}
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the body is getting too big it may be a better idea to load the content from an external file resource:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load (?:JMS|jms) message body {file}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load JMS message body {file}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step loads the body content from the given file resource.</p>
</div>
<div class="paragraph">
<p>With the steps above the test has specified the expected message content. With that in place another step can receive the message
and perform the validation.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^receive (?:JMS|jms) message$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then receive JMS message</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step uses the previously defined JMS destination to consume messages from it. You can use another destination in the step, too.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^receive (?:JMS|jms) message from destination {destination}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then receive JMS message from destination {destination}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this approach you have a clean separation of the expected message content specification and the actual receive operation.
Of course you can also combine everything in one single step.</p>
</div>
<div class="listingblock">
<div class="title">@Then(?:receive|expect|verify) (?:JMS|jms) message with body: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then receive JMS message with body: {body}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also add some message headers to this step.</p>
</div>
<div class="listingblock">
<div class="title">@Then(?:receive|expect|verify) (?:JMS|jms) message with body and headers: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then receive JMS message with body and headers: {body}
| {header_1} | {value_1} |
| {header_2} | {value_2} |
...
| {header_x} | {value_x} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step combines message header and body specification with the actual receive operation.</p>
</div>
</div>
<div class="sect4">
<h5 id="consumer-timeout"><a class="anchor" href="#consumer-timeout"></a><a class="link" href="#consumer-timeout">Consumer timeout</a></h5>
<div class="paragraph">
<p>The receive operation takes the first message available on the destination and performs the validation. In case there is no
message available the consumer will wait for a given amount of time before a timeout will fail the test. You can adjust the timeout on
the JMS consumer.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:JMS|jms) consumer timeout is {time}(?: ms| milliseconds)$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given JMS consumer timeout is {time} milliseconds</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="message-selectors"><a class="anchor" href="#message-selectors"></a><a class="link" href="#message-selectors">Message selectors</a></h5>
<div class="paragraph">
<p>The JMS standard provides a concept of message selectors so consumers can specify which message they want to consume from a destination.
The consumer usually evaluates the selector expression on the message headers.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:JMS|jms) selector: {expression}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given JMS selector: {expression}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The selector expression defines a key and value that the message must match. The first message to match the selector on the destination
it received by the consumer.</p>
</div>
<div class="listingblock">
<div class="title">Use message selector</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given JMS selector: key='value'</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tools-cucumber-steps-kafka"><a class="anchor" href="#tools-cucumber-steps-kafka"></a><a class="link" href="#tools-cucumber-steps-kafka">50.7. Kafka steps</a></h3>
<div class="paragraph">
<p>Apache Kafka is a powerful and widely used event streaming platform. Users are able to publish events and subscribe to
event streams.</p>
</div>
<div class="paragraph">
<p>The following sections describe the support for Kafka related event streaming in Citrus.</p>
</div>
<div class="sect3">
<h4 id="steps-kafka-connection"><a class="anchor" href="#steps-kafka-connection"></a><a class="link" href="#steps-kafka-connection">50.7.1. Connection</a></h4>
<div class="paragraph">
<p>First of all the test needs to connect to Kafka bootstrap servers. The connection provides several parameters that you can
set with the following step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Kafka|kafka) connection")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka connection
| {property} | {value} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration step receives a data table that defines the connection settings.</p>
</div>
<div class="listingblock">
<div class="title">Connection settings</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka connection
| url           | localhost:9092 |
| consumerGroup | citrus_group     |
| topic         | citrus_test      |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The most important part of the connection settings is the <code>url</code> that points to one or more Kafka bootstrap servers.</p>
</div>
<div class="paragraph">
<p>In addition to the connection settings there is a set of producer and consumer properties that you can set in order to configure
the behavior of producers and consumers connecting with Kafka.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Kafka|kafka) producer configuration$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka producer configuration
| {property} | {value} |</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Kafka|kafka) consumer configuration$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka consumer configuration
| {property} | {value} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The available properties to set here are described in the Apache Kafka documentation. See the following example how to set producer and
consumer properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka producer configuration
| client.id          | citrus_producer |
| request.timeout.ms | 5000 |

Given Kafka consumer configuration
| client.id          | citrus_consumer |
| max.poll.records   | 1 |</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-kafka-endpoint"><a class="anchor" href="#steps-kafka-endpoint"></a><a class="link" href="#steps-kafka-endpoint">50.7.2. Topic and endpoint configuration</a></h4>
<div class="paragraph">
<p>In addition to the connection the test needs to specify the Kafka topic to use.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Kafka|kafka) topic: {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka topic: {name}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sets the topic name for the next steps. As an alternative to that you can also reference a predefined endpoint
component from the configuration.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Kafka|kafka) endpoint \"{name}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka endpoint {name}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step tries to resolve the Kafka endpoint with given <code>{name}</code> in the available configuration. The endpoint can reference
a topic set and connection settings on its own.</p>
</div>
<div class="paragraph">
<p>So now the test is ready to produce and consume events from Kafka topics.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-kafka-send"><a class="anchor" href="#steps-kafka-send"></a><a class="link" href="#steps-kafka-send">50.7.3. Send Kafka events</a></h4>
<div class="paragraph">
<p>A test can publish events on a Kafka topic. The event consists of message headers and a body content. Before sending an event
the tests needs to specify the message content.</p>
</div>
<div class="sect4">
<h5 id="message-key"><a class="anchor" href="#message-key"></a><a class="link" href="#message-key">Message key</a></h5>
<div class="paragraph">
<p>Each event on a Kafka event stream has a message key set. You can set this key in a separate step before sending the event.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Kafka|kafka) message key: {key}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka message key: {key}$")</code></pre>
</div>
</div>
<div class="paragraph">
<p>This specifies the message key for the next event that is published.</p>
</div>
</div>
<div class="sect4">
<h5 id="message-headers-3"><a class="anchor" href="#message-headers-3"></a><a class="link" href="#message-headers-3">Message headers</a></h5>
<div class="paragraph">
<p>The message headers are key value pairs that are sent as part of the message. You can add a new header with the following step:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Kafka|kafka) message header {name}(?:=| is )\"{value}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka message header {name}="{value}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using a data table you can set multiple headers in one step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Kafka|kafka) message headers$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka message headers
| {header_1} | {value_1} |
| {header_2} | {value_2} |
...
| {header_x} | {value_x} |</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="message-body-3"><a class="anchor" href="#message-body-3"></a><a class="link" href="#message-body-3">Message body</a></h5>
<div class="listingblock">
<div class="title">@Given("^(?:Kafka|kafka) message body: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka message body: {body}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step can set a single line body content. Of course you can also work with multiline body content.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Kafka|kafka) message body$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka message body
"""
{body}
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the body is getting too big it may be a better idea to load the content from an external file resource:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load (?:Kafka|kafka) message body {file}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load Kafka message body {file}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step loads the body content from the given file resource.</p>
</div>
<div class="paragraph">
<p>Now another step can publish the message as it has been specified in the previous steps.</p>
</div>
<div class="listingblock">
<div class="title">@When("^send (?:Kafka|kafka) message$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send Kafka message</code></pre>
</div>
</div>
<div class="paragraph">
<p>This publishes the message to the previously configured Kafka topic. You can overwrite this topic in the publish step.</p>
</div>
<div class="listingblock">
<div class="title">@When("^send (?:Kafka|kafka) message to topic {topic}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send Kafka message to topic {topic}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The approach described clearly separates message specification and send operation as all of it is done in separate steps.
As an alternative you can also specify the message content in one step.</p>
</div>
<div class="listingblock">
<div class="title">@When("^send (?:Kafka|kafka) message with body: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send Kafka message with body: {body}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also add some message headers to this step.</p>
</div>
<div class="listingblock">
<div class="title">@When("^send (?:Kafka|kafka) message with body and headers: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send Kafka message with body and headers: {body}
| {header_1} | {value_1} |
| {header_2} | {value_2} |
...
| {header_x} | {value_x} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step combines message header and body specification with the actual send operation.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-kafka-receive"><a class="anchor" href="#steps-kafka-receive"></a><a class="link" href="#steps-kafka-receive">50.7.4. Receive Kafka events</a></h4>
<div class="paragraph">
<p>Similar to publishing events to a Kafka topic the test can also consume events from an event stream. When the event
has been received a validation mechanism makes sure that the message content received matches the expectations.</p>
</div>
<div class="paragraph">
<p>Users are able to provide expected message headers and body content in order to verify the received event.</p>
</div>
<div class="sect4">
<h5 id="message-headers-4"><a class="anchor" href="#message-headers-4"></a><a class="link" href="#message-headers-4">Message headers</a></h5>
<div class="paragraph">
<p>The expected message headers need to be set before receiving the event from the topic.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Kafka|kafka) message header {name}(?:=| is )\"{value}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka message header {name}="{value}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using a data table you can expect multiple headers in one step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Kafka|kafka) message headers$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka message headers
| {header_1} | {value_1} |
| {header_2} | {value_2} |
...
| {header_x} | {value_x} |</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="message-body-4"><a class="anchor" href="#message-body-4"></a><a class="link" href="#message-body-4">Message body</a></h5>
<div class="paragraph">
<p>In addition to verify message headers you can also verify the body content. Once again the user specifies the expected message
body before the message is received.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Kafka|kafka) message body: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka message body: {body}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step can expect a single line body content. Of course, you can also work with multiline body content.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Kafka|kafka) message body$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka message body
"""
{body}
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the body is getting too big it may be a better idea to load the content from an external file resource:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load (?:Kafka|kafka) message body {file}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load Kafka message body {file}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step loads the body content from the given file resource.</p>
</div>
<div class="paragraph">
<p>With the steps above the test has specified the expected message content. With that in place another step can receive the message
and perform the validation.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^receive (?:Kafka|kafka) message$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then receive Kafka message</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step uses the previously defined Kafka topic to consume events from it. You can use another topic in the step, too.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^receive (?:Kafka|kafka) message from topic {topic}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then receive Kafka message from topic {topic}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this approach you have a clean separation of the expected message content specification and the actual receive operation.
Of course you can also combine everything in one single step.</p>
</div>
<div class="listingblock">
<div class="title">@Then(?:receive|expect|verify) (?:Kafka|kafka) message with body: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then receive Kafka message with body: {body}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also add some message headers to this step.</p>
</div>
<div class="listingblock">
<div class="title">@Then(?:receive|expect|verify) (?:Kafka|kafka) message with body and headers: {body}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then receive Kafka message with body and headers: {body}
| {header_1} | {value_1} |
| {header_2} | {value_2} |
...
| {header_x} | {value_x} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step combines message header and body specification with the actual receive operation.</p>
</div>
</div>
<div class="sect4">
<h5 id="consumer-timeout-2"><a class="anchor" href="#consumer-timeout-2"></a><a class="link" href="#consumer-timeout-2">Consumer timeout</a></h5>
<div class="paragraph">
<p>The <code>receive</code> operation takes the first event available on the topic and performs the validation. In case there is no
event available the consumer will wait for a given amount of time before a timeout will fail the test. You can adjust the timeout on
the Kafka consumer.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Kafka|kafka) consumer timeout is {time}(?: ms| milliseconds)$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka consumer timeout is {time} milliseconds</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-kafka-special-config"><a class="anchor" href="#steps-kafka-special-config"></a><a class="link" href="#steps-kafka-special-config">50.7.5. Special configuration</a></h4>
<div class="paragraph">
<p>The Kafka standard provides a set of special configuration that you can set as part of the test.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Kafka|kafka) topic partition: {partition}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kafka topic partition: {partition}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This set the topic partition for all further steps publishing or consuming events from that topic.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tools-cucumber-steps-kubernetes"><a class="anchor" href="#tools-cucumber-steps-kubernetes"></a><a class="link" href="#tools-cucumber-steps-kubernetes">50.8. Kubernetes steps</a></h3>
<div class="paragraph">
<p>Kubernetes is a famous container management platform that allows automation
of deployment, scaling and management of containerized applications.</p>
</div>
<div class="paragraph">
<p>Citrus uses the Kubernetes client API and is able to create Kubernetes resources
(e.g. secrets, services, deployments and so on) as part of the test.</p>
</div>
<div class="sect3">
<h4 id="steps-k8s-api-version"><a class="anchor" href="#steps-k8s-api-version"></a><a class="link" href="#steps-k8s-api-version">50.8.1. API version</a></h4>
<div class="paragraph">
<p>The default Kubernetes API version used to create and manage resources is <code>v1</code>. You can overwrite this
version with an environment variable set on the Citrus configuration.</p>
</div>
<div class="listingblock">
<div class="title">Overwrite Kubernetes API version</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">CITRUS_KUBERNETES_API_VERSION=v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sets the Kubernetes API version for all operations.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-k8s-client"><a class="anchor" href="#steps-k8s-client"></a><a class="link" href="#steps-k8s-client">50.8.2. Client configuration</a></h4>
<div class="listingblock">
<div class="title">@Given("^Kubernetes timeout is {time}(?: ms| milliseconds)$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given("^Kubernetes timeout is {time} milliseconds</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sets the timeout for all Kubernetes client operations.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-k8s-namespace"><a class="anchor" href="#steps-k8s-namespace"></a><a class="link" href="#steps-k8s-namespace">50.8.3. Set namespace</a></h4>
<div class="paragraph">
<p>Kubernetes uses the concept of namespaces to separate workloads on the cluster. You
can connect to a specific namespace with the follwing step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Kubernetes namespace {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kubernetes namespace {name}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-k8s-pod-state"><a class="anchor" href="#steps-k8s-pod-state"></a><a class="link" href="#steps-k8s-pod-state">50.8.4. Verify pod state</a></h4>
<div class="paragraph">
<p>A Kubernetes pod has a state and is in a phase (e.g. running, stopped). You can verify the state with an expectation.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Kubernetes pod {name} is running/stopped$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kubernetes pod {name} is running</code></pre>
</div>
</div>
<div class="paragraph">
<p>Checks that the Kubernetes pod with given <code>{name}</code> is in state running and that the number of replicas is &gt; 0. The step polls
the state of the pod for a given amount of attempts with a given delay between attempts. You can adjust the polling settings with:</p>
</div>
<div class="listingblock">
<div class="title">@Given Kubernetes resource polling configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kubernetes resource polling configuration
    | maxAttempts          | 10   |
    | delayBetweenAttempts | 1000 |</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of identifying the pod by its name you can also filter the pod with a label expression. The expression
is a label key and value that identifies the pod in the current namespace.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Kubernetes pod labeled with {label}={value} is running/stopped$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kubernetes pod labeled with {label}={value} is running</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-k8s-watch-logs"><a class="anchor" href="#steps-k8s-watch-logs"></a><a class="link" href="#steps-k8s-watch-logs">50.8.5. Watch Kubernetes pod logs</a></h4>
<div class="listingblock">
<div class="title">@Given("^Kubernetes pod {name} should print (.*)$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kubernetes pod {name} should print {log-message}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Watches the log output of a Kubernetes pod and waits for given <code>{log-message}</code> to be present in the logs. The step polls the
logs for a given amount of time. You can adjust the polling configuration with:</p>
</div>
<div class="listingblock">
<div class="title">@Given Kubernetes resource polling configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kubernetes resource polling configuration
    | maxAttempts          | 10   |
    | delayBetweenAttempts | 1000 |</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also wait for a log message to <strong>not</strong> be present in the output. Just use this step:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Kubernetes pod {name} should not print (.*)$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kubernetes pod {name} should not print {log-message}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-k8s-service"><a class="anchor" href="#steps-k8s-service"></a><a class="link" href="#steps-k8s-service">50.8.6. Kubernetes services</a></h4>
<div class="paragraph">
<p>One of the most important features in the Citrus Kubernetes support is the management of
services and in particular the automatic deployment of simulated services in Kubernetes.</p>
</div>
<div class="paragraph">
<p>The user is able to start a local Http server instance and create a service in Kubernetes out of it.
This way the test is able to simulate services in Kubernetes and receive and verify incoming requests
as part of the test.</p>
</div>
<div class="paragraph">
<p>First of all we define a new service within the test.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Kubernetes service \"{name}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kubernetes service "{name}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This initializes a new Http server that will be used as Kubernetes service. The server is listening on
a default port <code>8080</code>. You can use another port.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Kubernetes service port {port}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kubernetes service port {port}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the following the test is able to create a new Kubernetes service with that Http server.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^create Kubernetes service {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given create Kubernetes service {name}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step creates the service in the Kubernetes namespace and exposes the given service port as target port.
Clients are now able to connect to that new service. Each requests on the service will reside in a request
in the test pod. The test is able to receive the request and verify its content as usual.</p>
</div>
<div class="paragraph">
<p>This way we can easily simulate Kubernetes services in the current namespace.</p>
</div>
<div class="paragraph">
<p>In case you need to use another target port you can adjust the port as follows.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^create Kubernetes service {name} with target port {port}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given create Kubernetes service {name} with target port {port}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This exposes the service with the given target port.</p>
</div>
<div class="paragraph">
<p>In case you do not need the service anymore you can delete it with this step:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^delete Kubernetes service {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given delete Kubernetes service {name}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-k8s-secrets"><a class="anchor" href="#steps-k8s-secrets"></a><a class="link" href="#steps-k8s-secrets">50.8.7. Secrets</a></h4>
<div class="paragraph">
<p>Secrets are resources that hold sensitive data. Other resources on the cluster can mount
the secret content and access it.</p>
</div>
<div class="paragraph">
<p>You can create secrets in the current namespace in multiple ways.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^create Kubernetes secret {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given create Kubernetes secret {name}
| {property} | {value} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step receives a secret name and a data table holding the property keys and values. These properties
build the content of the secret.</p>
</div>
<div class="paragraph">
<p>Instead of listing all properties in the test itself you can load the secret from an external property file.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load Kubernetes secret from file {file}.properties$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load Kubernetes secret from file {file}.properties</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step loads the property file and creates the secret from the file content. The file name is used
as the name fo the secret.</p>
</div>
<div class="paragraph">
<p>In case you want to clean up the secret you can delete it with:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^delete Kubernetes secret {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given delete Kubernetes secret {name}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes secrets need to have labels and/or annotations that mark the secret with important metadata.
You can add labels/annotations on the Kubernetes resource with these steps:</p>
</div>
<div class="listingblock">
<div class="title">@Then("^create label {label}={value} on Kubernetes secret {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then create label app=citrus on Kubernetes secret my-secret</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">@Then("^create annotation {annotation}={value} on Kubernetes secret {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then create annotation app=citrus on Kubernetes secret my-secret</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or use multiple labels/annotations in one single step:</p>
</div>
<div class="listingblock">
<div class="title">@Then("^create labels on Kubernetes secret {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then create labels on Kubernetes secret my-secret
    | app      | citrus |
    | owned-by | odo  |</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">@Then("^create annotations on Kubernetes secret {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then create annotations on Kubernetes secret my-secret
    | app      | citrus |
    | owned-by | odo  |</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-k8s-resources"><a class="anchor" href="#steps-k8s-resources"></a><a class="link" href="#steps-k8s-resources">50.8.8. Pods, deployments and other resources</a></h4>
<div class="paragraph">
<p>In the previous sections the test has creates services and secrets as Kubernetes resources. In addition to
that the test is able to apply any resource as a YAML file on the Kubernetes cluster.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^create Kubernetes resource$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given create Kubernetes resource
"""
&lt;&lt;YAML&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this step you can apply any Kubernetes resource as a YAML file.</p>
</div>
<div class="listingblock">
<div class="title">Apply Kubernetes resource</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given create Kubernetes resource
"""
apiVersion: v1
kind: Pod
metadata:
  name: my-pod
  labels:
    name: my-pod
spec:
  containers:
  - name: nginx
    image: nginx
    ports:
    - containerPort: 80
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step above creates a new pod resource with the given specification. Instead of
adding the resource specification in the test itself you can also load an external YAML file.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load Kubernetes resource {file_path}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load Kubernetes resource {file_path}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Load pod.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load Kubernetes resource pod.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">pod.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">apiVersion: v1
kind: Pod
metadata:
  name: my-pod
  labels:
    name: my-pod
spec:
  containers:
  - name: nginx
    image: nginx
    ports:
    - containerPort: 80</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case you need to delete a resource you can do so by specifying the minimal resource
as a YAML specification.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^delete Kubernetes resource$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given delete Kubernetes resource
"""
&lt;&lt;YAML&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Delete resource</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given delete Kubernetes resource
"""
apiVersion: v1
kind: Pod
metadata:
  name: my-pod
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also provide the external YAML file when deleting a resource. The step will
automatically extract the resource kind and name from the file content.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^delete Kubernetes resource {file_path}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given delete Kubernetes resource {file_path}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Delete resource from file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given delete Kubernetes resource pod.yaml</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-k8s-crd"><a class="anchor" href="#steps-k8s-crd"></a><a class="link" href="#steps-k8s-crd">50.8.9. Custom resources</a></h4>
<div class="paragraph">
<p>In the previous sections the test has created Kubernetes resources (pods, services, secrets, deployments, &#8230;&#8203;). The user can
also define custom resources in order to extend Kubernetes. Citrus is also able to manage these custom resources.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^create Kubernetes custom resource in {crd}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given create Kubernetes custom resource in {crd}
"""
&lt;&lt;YAML&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>The user has to provide a YAML specification of the custom resource.</p>
</div>
<div class="listingblock">
<div class="title">Create custom resource</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given create Kubernetes custom resource in brokers.eventing.knative.dev
"""
apiVersion: eventing.knative.dev/v1
kind: Broker
metadata:
  name: my-broker
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step needs to know the <code>{crd}</code> (Custom Resource Definition) of the custom resource. In the example above the test
creates a new resource of kind <code>Broker</code> in the custom resource definition <code>brokers.eventing.knative.dev</code>.</p>
</div>
<div class="paragraph">
<p>Of course, you can also load the custom resource from external file resource.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load Kubernetes custom resource {file_path} in {crd}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load Kubernetes custom resource {file_path} in {crd}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Load custom resource from file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load Kubernetes custom resource broker.yaml in brokers.eventing.knative.dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once again the step needs to have the CRD type and the YAML specification as a file resource.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You need to make sure that the Citrus runtime and the user that connects to the Kubernetes cluster has proper permissions to manage the custom resource.
The proper roles and role bindings need to apply to the user as well as a service account.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Prior to using the custom resource in a Citrus test you need to grant role permissions to the Citrus runtime.
Otherwise, the test is not allowed to create the custom resource due to security constraints on the cluster.</p>
</div>
<div class="paragraph">
<p>The Citrus runtime uses a service account <code>citrus-viewer</code> to run the test.
The service account needs to have proper roles and permissions for managing the custom resource.</p>
</div>
<div class="paragraph">
<p>Assume that there is a CRD <code>foos.citrus.dev</code> and you want to manage the resources in your test:</p>
</div>
<div class="listingblock">
<div class="title">crd-foo.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  labels:
    app: "citrus"
  creationTimestamp: null
  name: foos.citrus.dev
spec:
  group: citrus.dev
  names:
    kind: Foo
    listKind: FooList
    plural: foos
    singular: foo
  scope: Namespaced
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        description: Foo resource schema
        properties:
          apiVersion:
            description: 'APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'
            type: string
          kind:
            description: 'Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
            type: string
          metadata:
            type: object
          spec:
            description: Spec defines the desired state of Test
            properties:
              message:
                type: string
            required:
              - message
            type: object
          status:
            description: Status defines the observed state of Foo
            properties:
              conditions:
                items:
                  description: Condition describes the state of a resource at a certain point.
                  properties:
                    message:
                      description: A human readable message indicating details about the transition.
                      type: string
                    reason:
                      description: The reason for the condition's last transition.
                      type: string
                    status:
                      description: Status of the condition, one of True, False, Unknown.
                      type: string
                    type:
                      description: Type of condition.
                      type: string
                  required:
                    - status
                    - type
                  type: object
                type: array
              version:
                type: string
            type: object
        type: object
    subresources:
      status: {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The role to manage the new CRD <code>foos.citrus.dev</code> would be:</p>
</div>
<div class="listingblock">
<div class="title">role-foo.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: foo-operator
  labels:
    app: "citrus"
    citrus.citrusframework.org/append-to-viewer: "true"
rules:
- apiGroups:
    - citrus.dev
  resources:
    - foos
  verbs:
    - create
    - delete
    - get
    - list
    - update</code></pre>
</div>
</div>
<div class="paragraph">
<p>The role <code>foo-operator</code> is granted to create/delete/get/list/update custom resources of type <code>foos.citrus.dev</code>.</p>
</div>
<div class="paragraph">
<p>You also need a role binding to the <code>citrus-viewer</code> service account:</p>
</div>
<div class="listingblock">
<div class="title">role-pipe-foo.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: citrus-foo-permission
  labels:
    app: "citrus"
subjects:
- kind: ServiceAccount
  name: citrus-viewer
roleRef:
  kind: Role
  name: foo-operator
  apiGroup: rbac.authorization.k8s.io</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can use the usual Kubernetes tools to create the role and role bindings for the user and a service account.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This role setup must be done by a cluster administrator.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In case you need to delete a custom resource from Kubernetes the user has to provide a minimal
YAML specification that identifies the resource.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^delete Kubernetes custom resource in {crd}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then delete Kubernetes custom resource in {crd}
"""
&lt;&lt;YAML&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Delete custom resource</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then delete Kubernetes custom resource in {crd}
"""
apiVersion: eventing.knative.dev/v1
kind: Broker
metadata:
  name: my-broker
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an alternative to that you can use an external file resource that holds
the minimal YAML specification.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^delete Kubernetes custom resource {file_path} in {crd}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then delete Kubernetes custom resource {file_path} in {crd}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Delete custom resource from file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then delete Kubernetes custom resource broker.yaml in brokers.eventing.knative.dev</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-k8s-crd-condition"><a class="anchor" href="#steps-k8s-crd-condition"></a><a class="link" href="#steps-k8s-crd-condition">50.8.10. Verify custom resource conditions</a></h4>
<div class="paragraph">
<p>Custom resources often define a status and describe multiple conditions (e.g. ready, available, completed).
You can verify the condition on a custom resource.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^wait for condition={condition} on Kubernetes custom resource {name} in {type}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given wait for condition={condition} on Kubernetes custom resource {name} in {type}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step verifies that the given Kubernetes resource with name <code>{name}</code> describes a status condition <code>{condition}</code>. The step polls
the state of the resource for a given amount of attempts with a given delay between attempts. You can adjust the polling settings with:</p>
</div>
<div class="listingblock">
<div class="title">@Given Kubernetes resource polling configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Kubernetes resource polling configuration
    | maxAttempts          | 10   |
    | delayBetweenAttempts | 1000 |</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assume you have a custom resource like this:</p>
</div>
<div class="listingblock">
<div class="title">foo-crd.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: citrus.dev/v1
kind: Foo
metadata:
  name: my-foo-resource
spec:
  message: Hello
status:
  conditions:
  - type: Initialized
    status: true
  - type: Ready
    status: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The custom resource defines a status with multiple conditions. You can wait for a condition in the test.</p>
</div>
<div class="listingblock">
<div class="title">Wait for condition=Ready</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given wait for condition=Ready on Kubernetes custom resource foo/my-foo-resource in foos.citrus.dev/v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The expected condition is <code>Ready</code> for the resource named <code>my-foo-resource</code>. The resource name can use a prefix that represents
the kind information <code>foo/</code>. The kind helps to identify the custom resource. Also, the step defines the resource type <code>foos.citrus.dev</code> and
version <code>v1</code>. This is required to identify the custom resource on the cluster.</p>
</div>
<div class="paragraph">
<p>Instead of identifying the resource by its name you can also filter the resources with a label expression. The expression
is a label key and value that identifies the resource in the current namespace.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^wait for condition={condition} on Kubernetes custom resource in {type} labeled with {key}={value}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given wait for condition={condition} on Kubernetes custom resource in {type} labeled with {key}={value}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will get all resources of type <code>{type}</code> and filter by given label <code>{key}={value}</code>. Then the given condition is verified
on the resource.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-k8s-autoremove"><a class="anchor" href="#steps-k8s-autoremove"></a><a class="link" href="#steps-k8s-autoremove">50.8.11. Cleanup Kubernetes resources</a></h4>
<div class="paragraph">
<p>The described steps are able to create Kubernetes resources on the current Kubernetes namespace.
By default these resources get removed automatically after the test scenario.</p>
</div>
<div class="paragraph">
<p>The auto removal of Kubernetes resources can be turned off with the following step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Disable auto removal of Kubernetes resources$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Disable auto removal of Kubernetes resources</code></pre>
</div>
</div>
<div class="paragraph">
<p>Usually this step is a <code>Background</code> step for all scenarios in a feature file. This way multiple scenarios can work on
the very same Kubernetes resources.</p>
</div>
<div class="paragraph">
<p>There is also a separate step to explicitly enable the auto removal.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Enable auto removal of Kubernetes resources$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Enable auto removal of Kubernetes resources</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, all Kubernetes resources are automatically removed after each scenario.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tools-cucumber-steps-knative"><a class="anchor" href="#tools-cucumber-steps-knative"></a><a class="link" href="#tools-cucumber-steps-knative">50.9. Knative steps</a></h3>
<div class="paragraph">
<p>Knative represents the Kubernetes-based platform to manage serverless workloads.
You are able to leverage Knative eventing features such as producing and consuming
events.</p>
</div>
<div class="paragraph">
<p>The following sections guide you through the Knative eventing capabilities in Citrus.</p>
</div>
<div class="sect3">
<h4 id="steps-knative-api-version"><a class="anchor" href="#steps-knative-api-version"></a><a class="link" href="#steps-knative-api-version">50.9.1. API version</a></h4>
<div class="paragraph">
<p>The default Knative API version used to create and manage resources is <code>v1beta1</code>. You can overwrite this
version with a environment variable set on the Citrus configuration.</p>
</div>
<div class="listingblock">
<div class="title">Overwrite Knative API version</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">CITRUS_KNATIVE_API_VERSION=v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sets the Knative API version for all operations.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-knative-client"><a class="anchor" href="#steps-knative-client"></a><a class="link" href="#steps-knative-client">50.9.2. Client configuration</a></h4>
<div class="listingblock">
<div class="title">@Given("^Knative timeout is {time}(?: ms| milliseconds)$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given("^Knative timeout is {time} milliseconds</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sets the timeout for all Knative client operations.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-knative-namespace"><a class="anchor" href="#steps-knative-namespace"></a><a class="link" href="#steps-knative-namespace">50.9.3. Set namespace</a></h4>
<div class="paragraph">
<p>Knative uses the concept of namespaces to separate workloads on the cluster. You
can connect to a specific namespace with the follwing step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Knative namespace {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Knative namespace {name}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-knative-broker"><a class="anchor" href="#steps-knative-broker"></a><a class="link" href="#steps-knative-broker">50.9.4. Knative broker</a></h4>
<div class="paragraph">
<p>Eventing deals with publish/subscribe delivery of events in Knative.
Knative eventing uses a broker that manages channels, subscriptions and events.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Knative broker {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Knative broker {name}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sets the broker name to use in all further steps that publish and consume events. The broker
should already be present on the Kubernetes namespace. In case there is no broker yet you can create one.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^create Knative broker {name}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given create Knative broker {name}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step creates a new broker with the given <code>{name}</code>. The broker uses the default settings given
in the Knative platform.</p>
</div>
<div class="paragraph">
<p>You can verify that the broker is up and running with the following step:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Knative broker {name} is running$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Knative broker {name} is running</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-knative-service"><a class="anchor" href="#steps-knative-service"></a><a class="link" href="#steps-knative-service">50.9.5. Create event consumer service</a></h4>
<div class="paragraph">
<p>The Knative broker delivers events to sinks. In order to start consuming events in a test you should
create a event consumer service which acts as a sink.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^create Knative event consumer service {service}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given create Knative event consumer service {service}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step creates a new event consumer service. In particular this step creates a new <a href="#steps-k8s-service">Kubernetes service</a>.
The service instantiates a new local Http server and creates a new Kubernetes service from it. The service exposes a
port which is <code>8080</code> by default.</p>
</div>
<div class="paragraph">
<p>You can adjust the service port as follows:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Knative service port {port}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Knative service port {port}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default the Kubernetes service uses the service port as a target port when exposing the service.
You can choose another target port, too.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^create Knative event consumer service {service} with target port {port}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given create Knative event consumer service {service} with target port {port}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-knative-trigger"><a class="anchor" href="#steps-knative-trigger"></a><a class="link" href="#steps-knative-trigger">50.9.6. Manage triggers</a></h4>
<div class="paragraph">
<p>Triggers are used to deliver events to services and channels. Users can create
a trigger as part of the test in order to start consuming events.</p>
</div>
<div class="sect4">
<h5 id="triggers-on-services"><a class="anchor" href="#triggers-on-services"></a><a class="link" href="#triggers-on-services">Triggers on services</a></h5>
<div class="listingblock">
<div class="title">@Given("^create Knative trigger {trigger} on service {service}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given create Knative trigger {trigger} on service {service}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step creates a new trigger on the given Knative broker. The trigger watches for events
on the broker and forwards these events to the given service.</p>
</div>
<div class="paragraph">
<p>The service name either references an existing Kubernetes service or a
new service that is created as part of the test as described in this guide.</p>
</div>
<div class="paragraph">
<p>Triggers can use filters on event attributes. This narrows the amount of events handled by the trigger.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^create Knative trigger {trigger} on service {service} with filter on attributes$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given create Knative trigger {trigger} on service {service} with filter on attributes
| {attribute} | {value} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>You need to add one or many attributes with respective value that should be added to the filter. As a result
the trigger will only handle events matching the given filters.</p>
</div>
</div>
<div class="sect4">
<h5 id="triggers-on-channels"><a class="anchor" href="#triggers-on-channels"></a><a class="link" href="#triggers-on-channels">Triggers on channels</a></h5>
<div class="paragraph">
<p>Triggers can also forward events to channels. Subscribers are able to start subscriptions
on these channels in order to receive the events.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^create Knative trigger {trigger} on channel {channel}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given create Knative trigger {trigger} on channel {channel}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, you can also add filters on attributes that narrow the amount of events
handled by the trigger.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^create Knative trigger {trigger} on channel {channel} with filter on attributes$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given create Knative trigger {trigger} on channel {channel} with filter on attributes
| {attribute} | {value} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step uses a data table with attributes and values that should be added to the filter. As a result
the trigger will only handle events matching the given filters.</p>
</div>
</div>
<div class="sect4">
<h5 id="delete-knative-trigger"><a class="anchor" href="#delete-knative-trigger"></a><a class="link" href="#delete-knative-trigger">Delete Knative trigger</a></h5>
<div class="paragraph">
<p>You can delete a trigger by giving its name in the current namespace.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^delete Knative trigger {trigger}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given delete Knative trigger {trigger}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This removes the Knative trigger from the current namespace.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-knative-channels"><a class="anchor" href="#steps-knative-channels"></a><a class="link" href="#steps-knative-channels">50.9.7. Create channels</a></h4>
<div class="paragraph">
<p>Channels represent a central concept of Knative eventing. Channels are able to deliver events
to multiple subscribers. A test in Citrus is able to create new channels.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^create Knative channel {channel}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given create Knative channel {channel}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the channel is available you can subscribe a service to the channel.</p>
</div>
<div class="listingblock">
<div class="title">@Given subscribe service {service} to Knative channel {channel}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given subscribe service {service} to Knative channel {channel}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-knative-send-events"><a class="anchor" href="#steps-knative-send-events"></a><a class="link" href="#steps-knative-send-events">50.9.8. Publish events</a></h4>
<div class="paragraph">
<p>The test is able to publish events on the Knative broker. Citrus uses the Knative Http client API
to publish events on the broker.</p>
</div>
<div class="paragraph">
<p>Because of that the test needs to specify a proper broker URL before publishing any events.</p>
</div>
<div class="sect4">
<h5 id="knative-broker-url"><a class="anchor" href="#knative-broker-url"></a><a class="link" href="#knative-broker-url">Knative broker URL</a></h5>
<div class="listingblock">
<div class="title">@Given("^Knative broker (?:URL|url): {url}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Knative broker URL: {url}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The URL points to a Knative broker and uses Http as transport. The test is able to publish events
using this broker endpoint.</p>
</div>
</div>
<div class="sect4">
<h5 id="knative-client-2"><a class="anchor" href="#knative-client-2"></a><a class="link" href="#knative-client-2">Knative client</a></h5>
<div class="paragraph">
<p>As an alternative to that you can also specify a Http client component which connects to the broker.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Knative client \"{name}\"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Knative client "{name}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client references a component in the configuration (e.g. Spring bean).</p>
</div>
<div class="paragraph">
<p>Now the test is ready to publish the event.</p>
</div>
</div>
<div class="sect4">
<h5 id="create-cloud-events"><a class="anchor" href="#create-cloud-events"></a><a class="link" href="#create-cloud-events">Create cloud events</a></h5>
<div class="listingblock">
<div class="title">@When("^(?:create|send) Knative event$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send Knative event
| {property} | {value} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step uses a data table in order to specify the cloud event properties that should be published.
The cloud event data structure defines following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>specversion</p>
</li>
<li>
<p>type</p>
</li>
<li>
<p>source</p>
</li>
<li>
<p>subject</p>
</li>
<li>
<p>id</p>
</li>
<li>
<p>datacontenttype</p>
</li>
<li>
<p>data</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Following these properties you can specify the cloud event in the send operation.</p>
</div>
<div class="listingblock">
<div class="title">Send cloud event</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send Knative event
| specversion     | 1.0 |
| type            | greeting |
| source          | https://github.com/citrusframework |
| subject         | hello |
| id              | say-hello |
| datacontenttype | application/json |
| data            | {"msg": "Hello Knative!"} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>data</code> property defines the cloud event payload which is a Json payload in the example above. This can be
any payload and depends on what you want to send as part of the event.</p>
</div>
<div class="paragraph">
<p>As we are using the Http cloud event model we can also use Http property equivalents as property keys.</p>
</div>
<div class="listingblock">
<div class="title">Send cloud event via Http properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send Knative event
| ce-specversion     | 1.0 |
| ce-type            | greeting |
| ce-source          | https://github.com/citrusframework |
| ce-subject         | hello |
| ce-id              | say-hello-${id} |
| Content-Type       | application/json;charset=UTF-8 |
| data               | {"msg": "Hello Knative!"} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of using a <code>data</code> property in the data table you can also specify the event payload in a separate step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Knative event data: {data}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Knative event data: {data}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step sets a single line event data that is going to represent the payload of the cloud event.</p>
</div>
<div class="paragraph">
<p>The following step supports multiline event data.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Knative event data$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Knative event data
"""
&lt;&lt;data&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>With these steps the cloud event data table must not specify the <code>data</code> property anymore.</p>
</div>
<div class="listingblock">
<div class="title">Send cloud event</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Knative event data
"""
{
  "msg": "Hello Knative!"
}
"""
Then send Knative event
| specversion     | 1.0 |
| type            | greeting |
| source          | https://github.com/citrusframework |
| subject         | hello |
| id              | say-hello |
| datacontenttype | application/json |</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="create-cloud-events-via-json"><a class="anchor" href="#create-cloud-events-via-json"></a><a class="link" href="#create-cloud-events-via-json">Create cloud events via Json</a></h5>
<div class="paragraph">
<p>The cloud events model supports Json so you can also specify the event with a single step in Json.</p>
</div>
<div class="listingblock">
<div class="title">@When("^(?:create|send) Knative event as json$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send Knative event as json
"""
&lt;&lt;json&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Send cloud event via Json</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When send Knative event as json
"""
{
  "specversion" : "1.0",
  "type" : "greeting",
  "source" : "https://github.com/citrusframework",
  "subject" : "hello",
  "id" : "say-hello",
  "datacontenttype" : "application/json",
  "data" : "{\"msg\": \"Hello Knative!\"}"
}
"""</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="producer-timeouts"><a class="anchor" href="#producer-timeouts"></a><a class="link" href="#producer-timeouts">Producer timeouts</a></h5>
<div class="paragraph">
<p>The producer connects to the Knative broker in order to publish events.
In case the broker is not available a timeout will fail the test. You can adjust the
producer timeout.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Knative event producer timeout is {time}(?: ms| milliseconds)$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Knative event producer timeout is {time} milliseconds</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-knative-receive-events"><a class="anchor" href="#steps-knative-receive-events"></a><a class="link" href="#steps-knative-receive-events">50.9.9. Receive events</a></h4>
<div class="paragraph">
<p>In order to receive events from Knative you should setup a <a href="#steps-knative-service">service</a> or <a href="#knative-channels">channel</a>
in combination with a <a href="#steps-knative-trigger">trigger</a>. The trigger watches for events on the broker and forwards
these to the service or channel.</p>
</div>
<div class="paragraph">
<p>The test is able to receive events and verify its content.</p>
</div>
<div class="sect4">
<h5 id="receive-cloud-events"><a class="anchor" href="#receive-cloud-events"></a><a class="link" href="#receive-cloud-events">Receive cloud events</a></h5>
<div class="listingblock">
<div class="title">@Then("^(?:receive|verify) Knative event$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then receive Knative event
| {property} | {value} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step uses a data table in order to specify the cloud event properties as expected content.
The cloud event data structure defines following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>specversion</p>
</li>
<li>
<p>type</p>
</li>
<li>
<p>source</p>
</li>
<li>
<p>subject</p>
</li>
<li>
<p>id</p>
</li>
<li>
<p>datacontenttype</p>
</li>
<li>
<p>data</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Following these properties you can specify the cloud event in the receive operation.</p>
</div>
<div class="listingblock">
<div class="title">Receive cloud event</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then receive Knative event
| specversion     | 1.0 |
| type            | greeting |
| source          | https://github.com/citrusframework |
| subject         | hello |
| id              | say-hello |
| datacontenttype | application/json |
| data            | {"msg": "Hello Knative!"} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>data</code> property defines the cloud event payload which is a Json payload in the example above. This can be
any payload and depends on what you want to receive as part of the event.</p>
</div>
<div class="paragraph">
<p>As we are using the Http cloud event model we can also use Http property equivalents as property keys.</p>
</div>
<div class="listingblock">
<div class="title">Receive cloud event via Http properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then receive Knative event
| ce-specversion     | 1.0 |
| ce-type            | greeting |
| ce-source          | https://github.com/citrusframework |
| ce-subject         | hello |
| ce-id              | say-hello-${id} |
| Content-Type       | application/json;charset=UTF-8 |
| data               | {"msg": "Hello Knative!"} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of using a <code>data</code> property in the data table you can also specify the event payload in a separate step.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^(?:expect|verify) Knative event data: {data}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then expect Knative event data: {data}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step sets a single line event data that is going to represent the payload of the cloud event.</p>
</div>
<div class="paragraph">
<p>The following step supports multiline event data.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^(?:expect|verify) Knative event data$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then expect Knative event data
"""
&lt;&lt;data&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="paragraph">
<p>With these steps the cloud event data table must not specify the <code>data</code> property anymore.</p>
</div>
<div class="listingblock">
<div class="title">Receive cloud event</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given expect Knative event data
"""
{
  "msg": "Hello Knative!"
}
"""
Then receive Knative event
| specversion     | 1.0 |
| type            | greeting |
| source          | https://github.com/citrusframework |
| subject         | hello |
| id              | say-hello |
| datacontenttype | application/json |</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="receive-cloud-events-via-json"><a class="anchor" href="#receive-cloud-events-via-json"></a><a class="link" href="#receive-cloud-events-via-json">Receive cloud events via Json</a></h5>
<div class="paragraph">
<p>The cloud events model supports Json so you can also specify the event with a single step in Json.</p>
</div>
<div class="listingblock">
<div class="title">@When("^(?:receive|verify) Knative event as json$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then receive Knative event as json
"""
&lt;&lt;json&gt;&gt;
"""</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Receive cloud event via Json</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then receive Knative event as json
"""
{
  "specversion" : "1.0",
  "type" : "greeting",
  "source" : "https://github.com/citrusframework",
  "subject" : "hello",
  "id" : "say-hello",
  "datacontenttype" : "application/json",
  "data" : "{\"msg\": \"Hello Knative!\"}"
}
"""</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="consumer-timeouts"><a class="anchor" href="#consumer-timeouts"></a><a class="link" href="#consumer-timeouts">Consumer timeouts</a></h5>
<div class="paragraph">
<p>The consumer connects to the Knative broker in order to consume events.
The consumer will wait for events and in case no event arrives in time a
timeout will fail the test. You can adjust this event consumer timeout.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Knative event consumer timeout is {time}(?: ms| milliseconds)$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Knative event consumer timeout is {time} milliseconds</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-knative-resources"><a class="anchor" href="#steps-knative-resources"></a><a class="link" href="#steps-knative-resources">50.9.10. Manage Knative resources</a></h4>
<div class="paragraph">
<p>The described steps are able to create Knative resources on the current Kubernetes namespace.
By default these resources get removed automatically after the test scenario.</p>
</div>
<div class="paragraph">
<p>The auto removal of Knative resources can be turned off with the following step.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Disable auto removal of Knative resources$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Disable auto removal of Knative resources</code></pre>
</div>
</div>
<div class="paragraph">
<p>Usually this step is a <code>Background</code> step for all scenarios in a feature file. This way multiple scenarios can work on
the very same Knative resources and share integrations.</p>
</div>
<div class="paragraph">
<p>There is also a separate step to explicitly enable the auto removal.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Enable auto removal of Knative resources$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Enable auto removal of Knative resources</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, all Knative resources are automatically removed after each scenario.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tools-cucumber-steps-openapi"><a class="anchor" href="#tools-cucumber-steps-openapi"></a><a class="link" href="#tools-cucumber-steps-openapi">50.10. OpenAPI steps</a></h3>
<div class="paragraph">
<p>OpenAPI documents specify RESTful Http services in a standardized, language-agnostic way. The specifications describe
resources, path items, operations, security schemes and many more components. All these components specified are part
of a REST Http service.</p>
</div>
<div class="paragraph">
<p>Citrus as a framework is able to use this information in an OpenAPI document in order to generate proper request and response
data for your test.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Feature: Petstore API V3

  Background:
    Given OpenAPI specification: http://localhost:8080/petstore/v3/openapi.json

  Scenario: getPet
    When invoke operation: getPetById
    Then verify operation result: 200 OK

  Scenario: petNotFound
    Given variable petId is "0"
    When invoke operation: getPetById
    Then verify operation result: 404 NOT_FOUND

  Scenario: addPet
    When invoke operation: addPet
    Then verify operation result: 201 CREATED

  Scenario: updatePet
    When invoke operation: updatePet
    Then verify operation result: 200 OK

  Scenario: deletePet
    When invoke operation: deletePet
    Then verify operation result: 204 NO_CONTENT</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="steps-openapi-load"><a class="anchor" href="#steps-openapi-load"></a><a class="link" href="#steps-openapi-load">50.10.1. Load OpenAPI specifications</a></h4>
<div class="paragraph">
<p>The test is able to load OpenAPI specifications via Http URL or the local file system. When loaded into the test steps can make
use of all available operations in the specification.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^OpenAPI (?:specification|resource): {url}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given OpenAPI specification {url}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The given url can point to a local file on the file system or to a Http endpoint. The step loads the OpenAPI specification so
all operations are ready to be used.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-openapi-invoke-operations"><a class="anchor" href="#steps-openapi-invoke-operations"></a><a class="link" href="#steps-openapi-invoke-operations">50.10.2. Invoke operations</a></h4>
<div class="paragraph">
<p>You can invoke operations as a client by referencing the operation name given in the specification. Citrus loads the operation from
the specification and automatically generates proper request/response data for you.</p>
</div>
<div class="paragraph">
<p>The rules in the OpenAPI specification define how to generate proper test data with randomized values.</p>
</div>
<div class="listingblock">
<div class="title">@When("^(?:I|i)nvoke operation: {id}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When invoke operation: {id}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step obtains the operation with the given <code>{id}</code> and invokes it on the Http URL that is given in the specification. In case the server URL
is missing in the specification the step uses the base URL of the OpenAPI endpoint where the document has been loaded from.</p>
</div>
<div class="paragraph">
<p>The step uses the specification rules for the operation to generate a proper request for you. Request parameters, headers and body content are
automatically generated. In case the operation defines a request body the step will also generate it with randomized values.</p>
</div>
<div class="listingblock">
<div class="title">Generated body example with randomized values</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "id": 26866048,
  "name": "mGNTgkfxgg",
  "photoUrls": [
    "XHAGIyFcyh"
  ],
  "category": {
    "name": "konwOUYwMo",
    "id": 18676332
  },
  "tags": [
    {
      "name": "KDnoWCfUBn",
      "id": 31444049
    }
  ],
  "status": "sold"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated request should be valid according to the rules in the OpenAPI specification. You can overwrite the
randomized values with test variables and <a href="#steps-openapi-dictionaries">inbound/outbound data dictionaries</a> in order to have
more human-readable test data.</p>
</div>
<div class="paragraph">
<p>Now that the test has sent the request you can verify the operation result in a next step.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-openapi-verify-result"><a class="anchor" href="#steps-openapi-verify-result"></a><a class="link" href="#steps-openapi-verify-result">50.10.3. Verify operation result</a></h4>
<div class="paragraph">
<p>The test is able to verify the response status code returned by the server.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^(?:V|v)erify operation result: {status_code}(?: {reason_phrase})?$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then verify operation result: {status_code} {reason_phrase}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step expects a <code>{status_code}</code> (e.g. 200, 404, 500) and optionally gives the <code>{reason_phrase}</code> (e.g. OK, NOT_FOUND, INTERNAL_SERVER_ERROR).
Thee reason phrase is optional and is only for better readability reasons.</p>
</div>
<div class="paragraph">
<p>The operation defines a set of responses in the OpenAPI specification. The step tries to find the response with the given <code>{status_code}</code>
and reads the given rules such as response body, headers etc. Based on the response definition in the OpenAPI specification the
step automatically verifies the server reponse and makes sure that the response matches the given rules.</p>
</div>
<div class="paragraph">
<p>In particular the step generates an expected response body (if any is specified) and compares the actual response with the generated one.</p>
</div>
<div class="listingblock">
<div class="title">Generated response body example with validations</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "id": "@isNumber()@",
  "name": "@notEmpty()@",
  "photoUrls": "@ignore@",
  "category": {
    "id": "@isNumber()@",
    "name": "@notEmpty()@"
  },
  "tags": "@ignore@",
  "status": "@matches(available|pending|sold)@"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated response makes use of Citrus validation matchers based on the rules in the specification. Id values are validated with <code>@isNumber()@</code>, String values
should not be empty <code>@notEmpty()@</code> and enumeration values are checked with <code>@matches(value_1|value_2|&#8230;&#8203;|value_x)@</code>.</p>
</div>
<div class="paragraph">
<p>The received response must match all these validation matchers. In addition to that a Json schema validation is performed on the response.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-openapi-verify-request"><a class="anchor" href="#steps-openapi-verify-request"></a><a class="link" href="#steps-openapi-verify-request">50.10.4. Verify operation requests</a></h4>
<div class="paragraph">
<p>On the server side your test is able to verify incoming requests based on the rules in the specification. The test references a given operation
by its name in the specification and generates proper verification steps on the request content. Based on the specification the
incoming request must follow the rules and schemas attached to the OpenAPI operation.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^(?:receive|expect|verify) operation: {id}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then expect operation {id}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step expects a request matching the operation with the given <code>{id}</code>. The step loads the operation from the specification and autoamtically
verifies that the incoming request matches the specified request.</p>
</div>
<div class="paragraph">
<p>In fact the step generates a request body (if any is specified on the operation) with validation expressions and compares the
incoming request with the generated template. In case the incoming request does not match the generated validation rules
the test will fail accordingly.</p>
</div>
<div class="listingblock">
<div class="title">Generated request body example with validations</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "id": "@isNumber()@",
  "name": "@notEmpty()@",
  "photoUrls": "@ignore@",
  "category": {
    "id": "@isNumber()@",
    "name": "@notEmpty()@"
  },
  "tags": "@ignore@",
  "status": "@matches(available|pending|sold)@"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated request uses Citrus validation matchers based on the rules in the OpenAPI specification. Identifiers are validated with <code>@isNumber()@</code>, String values
should not be empty <code>@notEmpty()@</code> and enumeration values are checked with <code>@matches(value_1|value_2|&#8230;&#8203;|value_x)@</code>.</p>
</div>
<div class="paragraph">
<p>This way you can make sure that the incoming request matches the rules defined in the OpenAPI specification. In addition to the
message request body verification the step will automatically verify <code>Content-Type</code> headers, path parameters, query parameters and the general
request path used.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-openapi-send-response"><a class="anchor" href="#steps-openapi-send-response"></a><a class="link" href="#steps-openapi-send-response">50.10.5. Send operation response</a></h4>
<div class="paragraph">
<p>When the OpenAPI step has received and verified a request it is time to respond with proper message content. The given operation
in the OpenAPI specification is able to define multiple response messages that are valid. In the test the user picks one of
these response messages and the step generates the message content based on the specification.</p>
</div>
<div class="paragraph">
<p>The step will generate proper test data with randomized values as response body.</p>
</div>
<div class="listingblock">
<div class="title">@Then("^send operation result: {status} {reason_phrase}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Then send operation result: 201 CREATED</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step obtains the operation response with the status <code>201</code> and generates the response data. The response is able to define <code>Content-Type</code> headers
and response body content.</p>
</div>
<div class="listingblock">
<div class="title">Generated response body example with randomized values</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "id": 26866048,
  "name": "mGNTgkfxgg",
  "photoUrls": [
    "XHAGIyFcyh"
  ],
  "category": {
    "name": "konwOUYwMo",
    "id": 18676332
  },
  "tags": [
    {
      "name": "KDnoWCfUBn",
      "id": 31444049
    }
  ],
  "status": "sold"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated response should be valid according to the rules in the OpenAPI specification. You can overwrite the
randomized values with test variables and <a href="#steps-openapi-dictionaries">inbound/outbound data dictionaries</a> in order to have
more human-readable test data.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-openapi-test-data"><a class="anchor" href="#steps-openapi-test-data"></a><a class="link" href="#steps-openapi-test-data">50.10.6. Generate test data</a></h4>
<div class="paragraph">
<p>The Citrus OpenAPI steps use the information in the specification to generate proper message content for requests and responses. The generated test
data follows the schemas attached to the operations and response definitions. By default, the steps include optional fields when generating
and validating message contents.</p>
</div>
<div class="paragraph">
<p>You can disable the optional fields in generation and validation accordingly:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^Disable OpenAPI generate optional fields$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Disable OpenAPI generate optional fields</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">@Given("^Disable OpenAPI validate optional fields$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Disable OpenAPI validate optional fields</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this setting the OpenAPI steps will exclude optional fields from both test data generation and message content validation.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-openapi-dictionaries"><a class="anchor" href="#steps-openapi-dictionaries"></a><a class="link" href="#steps-openapi-dictionaries">50.10.7. Inbound/outbound data dictionaries</a></h4>
<div class="paragraph">
<p>Data dictionaries are a good way to make generated randomized values more human-readable. By default, Citrus generates random values based
on the specifications in the OpenAPI document. You can overwrite the basic generation rules by specifying rules in a data dictionary.</p>
</div>
<div class="sect4">
<h5 id="outbound-dictionary"><a class="anchor" href="#outbound-dictionary"></a><a class="link" href="#outbound-dictionary">Outbound dictionary</a></h5>
<div class="paragraph">
<p>Outbound dictionaries are used to customize generated client requests.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^OpenAPI outbound dictionary$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given OpenAPI outbound dictionary
| {expression} | {value} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The outbound dictionary holds a list of expressions that overwrite values in the generated request body.</p>
</div>
<div class="paragraph">
<p>Based on the body data format (e.g. Json or XML) you can use JsonPath or XPath expressions in the dictionary.
Citrus evaluates the given expressions on the generated request body before the request is sent to the server.</p>
</div>
<div class="listingblock">
<div class="title">Outbound dictionary sample</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given OpenAPI outbound dictionary
  | $.name          | citrus:randomEnumValue('hasso','cutie','fluffy') |
  | $.category.name | citrus:randomEnumValue('dog', 'cat', 'fish') |</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also load the dictionary rules from an external file resource.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load OpenAPI outbound dictionary {file_path}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load OpenAPI outbound dictionary {file_path}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this outbound data dictionary in place a generated request can look like follows:</p>
</div>
<div class="listingblock">
<div class="title">Generated request with outbound dictionary</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "id": 12337393,
  "name": "hasso",
  "photoUrls": [
    "aaKoEDhLYc"
  ],
  "category": {
    "name": "cat",
    "id": 23927231
  },
  "tags": [
    {
      "name": "FQxvuCbcqT",
      "id": 58291150
    }
  ],
  "status": "pending"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You see that the request now uses more human readable values for <code>$.name</code> and <code>$.category.name</code>.</p>
</div>
<div class="paragraph">
<p>The same mechanism applies for inbound messages that are verified by Citrus. The framework will generate an expected response
data structure coming from the OpenAPI specification.</p>
</div>
</div>
<div class="sect4">
<h5 id="inbound-dictionary"><a class="anchor" href="#inbound-dictionary"></a><a class="link" href="#inbound-dictionary">Inbound dictionary</a></h5>
<div class="paragraph">
<p>Inbound dictionaries adjust the generated expected responses which verify incoming messages with expected validation statements.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^OpenAPI inbound dictionary$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given OpenAPI inbound dictionary
| {expression} | {value} |</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also load the dictionary rules from an external file resource.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^load OpenAPI inbound dictionary {file_path}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given load OpenAPI inbound dictionary {file_path}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The inbound dictionary holds a list of expressions that overwrite values in the generated response body.</p>
</div>
<div class="paragraph">
<p>Based on the body data format (e.g. Json or XML) you can use JsonPath or XPath expressions in the dictionary.
Citrus evaluates the given expressions on the generated response body. This way you can overwrite given values in the body
structure before the validation takes place.</p>
</div>
<div class="listingblock">
<div class="title">Inbound dictionary sample</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given OpenAPI inbound dictionary
  | $.name          | @assertThat(anyOf(is(hasso),is(cutie),is(fluffy)))@ |
  | $.category.name | @assertThat(anyOf(is(dog),is(cat),is(fish)))@ |</code></pre>
</div>
</div>
<div class="paragraph">
<p>Below is a sample Json payload that has been generated with the inbound data dictionary.</p>
</div>
<div class="listingblock">
<div class="title">Generated response with inbound dictionary</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "id": "@isNumber()@",
  "name": "@assertThat(anyOf(is(hasso),is(cutie),is(fluffy)))@",
  "photoUrls": "@ignore@",
  "category": {
    "name": "@assertThat(anyOf(is(dog),is(cat),is(fish)))@",
    "id": "@isNumber()@"
  },
  "tags": "@ignore@",
  "status": "@matches(available|pending|sold)@"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated response ensures that the rules defined in the OpenAPI specification do match and in addition that the received data
meets our expectations in the dictionary.</p>
</div>
<div class="paragraph">
<p>In case you need to have a more specific response validation where each field gets validated with an expected value please
consider using the <a href="#tools-cucumber-steps-http">Http steps</a> in Citrus. Here you can provide a complete expected Http response with body and headers.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-openapi-fork-mode"><a class="anchor" href="#steps-openapi-fork-mode"></a><a class="link" href="#steps-openapi-fork-mode">50.10.8. Request fork mode</a></h4>
<div class="paragraph">
<p>When the OpenAPI steps fire requests to the server the step synchronously waits for the response. All other steps are in the feature are blocked
by the synchronous communication. In some cases this is a problem because you might want to run some steps in parallel to the synchronous communication.</p>
</div>
<div class="paragraph">
<p>In these cases you can make use of the form mode when sending Http client requests.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^OpenAPI request fork mode is (enabled|disabled)$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given OpenAPI request fork mode is enabled</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this in place the step will not block other steps while waiting for the synchronous response from the server. The feature will continue with
the next steps when fork mode is enabled. At a later point in time you may verify the response as usual with the separate verification step.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="steps-tools-cucumber-steps-selenium"><a class="anchor" href="#steps-tools-cucumber-steps-selenium"></a><a class="link" href="#steps-tools-cucumber-steps-selenium">50.11. Selenium steps</a></h3>
<div class="paragraph">
<p>Selenium is a very popular UI testing tool that enables you to simulate user interactions on a web frontend. Selenium
supports a wide range of browsers and is able to run with a grid of nodes in a Kubernetes environment.</p>
</div>
<div class="paragraph">
<p>Citrus provides ready-to-use steps that leverage Selenium UI testing with Cloud-native BDD.</p>
</div>
<div class="paragraph">
<p>The following sections guide you through the Selenium capabilities in Citrus.</p>
</div>
<div class="sect3">
<h4 id="steps-selenium-browser-type"><a class="anchor" href="#steps-selenium-browser-type"></a><a class="link" href="#steps-selenium-browser-type">50.11.1. Browser type</a></h4>
<div class="paragraph">
<p>Selenium supports many browsers. When running a Citrus test with Selenium you need to choose which browser type to use. By
default, Citrus uses the <code>htmlunit</code> browser type. You can overwrite this type with the system property <code>citrus.selenium.browser.type</code>
or environment variable <code>CITRUS_SELENIUM_BROWSER_TYPE</code> set on the Citrus configuration.</p>
</div>
<div class="listingblock">
<div class="title">Set Selenium browser type</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">CITRUS_SELENIUM_BROWSER_TYPE=chrome</code></pre>
</div>
</div>
<div class="paragraph">
<p>These are the supported browser types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>firefox</p>
</li>
<li>
<p>safari</p>
</li>
<li>
<p>MicrosoftEdge</p>
</li>
<li>
<p>safariproxy</p>
</li>
<li>
<p>chrome</p>
</li>
<li>
<p>htmlunit</p>
</li>
<li>
<p>internet explorer</p>
</li>
<li>
<p>phantomjs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This sets the Selenium browser type for all operations.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-selenium-browser"><a class="anchor" href="#steps-selenium-browser"></a><a class="link" href="#steps-selenium-browser">50.11.2. Selenium broker</a></h4>
<div class="paragraph">
<p>Citrus creates a default browser component using the given <a href="#selenium-browser-type">browser type</a>. You can also create a
browser instance by yourself and reference this in your test by its name.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Browser|browser) "{name}"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given browser "{name}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This loads the browser component with given name from the configuration (e.g. Spring application context).</p>
</div>
<div class="paragraph">
<p>You can also use the system property <code>citrus.selenium.browser.name</code> environment variable <code>CITRUS_SELENIUM_BROWSER_NAME</code></p>
</div>
</div>
<div class="sect3">
<h4 id="steps-selenium-browser-remote"><a class="anchor" href="#steps-selenium-browser-remote"></a><a class="link" href="#steps-selenium-browser-remote">50.11.3. Remote web driver</a></h4>
<div class="paragraph">
<p>As soon as the Citrus test is run on a Kubernetes environment you must use a remote web driver. This is because the default Citrus test
runtime pod is not able to run UI tests because no web browser infrastructure is installed in the image.</p>
</div>
<div class="paragraph">
<p>You can automatically start a Selenium sidecar container as part of the test runtime pod. The <a href="https://hub.docker.com/u/selenium">Selenium images</a>
provide the required web browser infrastructure for UI testing. Citrus adds the Selenium container as a sidecar to the test
runtime. Now your test is able to connect with the remote browser using a remote web driver connection.</p>
</div>
<div class="paragraph">
<p>Add the following configuration to the <code>citrus-config.yaml</code> in your test.</p>
</div>
<div class="listingblock">
<div class="title">citrus-config.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">config:
  runtime:
    selenium:
      image: selenium/standalone-chrome:latest
    env:
      - name: CITRUS_SELENIUM_BROWSER_TYPE
        value: chrome
      - name: CITRUS_SELENIUM_BROWSER_REMOTE_SERVER_URL
        value: http://localhost:4444/wd/hub</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sets the Selenium container image (<code>selenium/standalone-chrome:latest</code>), the browser type and the remote web driver URL.
Citrus automatically starts the given Selenium container image and connects the browser to the remote web driver.</p>
</div>
<div class="paragraph">
<p>This way you can run the UI tests in a Kubernetes environment.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-selenium-start-stop"><a class="anchor" href="#steps-selenium-start-stop"></a><a class="link" href="#steps-selenium-start-stop">50.11.4. Start/stop browser</a></h4>
<div class="paragraph">
<p>Before you can run some user interactions with Selenium you need to start the browser.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^start browser$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given start browser</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">@Given("^stop browser$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given stop browser</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-selenium-navigate"><a class="anchor" href="#steps-selenium-navigate"></a><a class="link" href="#steps-selenium-navigate">50.11.5. Navigate to URL</a></h4>
<div class="paragraph">
<p>See the following step that navigates to a given URL in the browser.</p>
</div>
<div class="listingblock">
<div class="title">@When("^(?:User|user) navigates to "{url}"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When User navigates to "{url}"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-selenium-verify-elements"><a class="anchor" href="#steps-selenium-verify-elements"></a><a class="link" href="#steps-selenium-verify-elements">50.11.6. Verify elements on page</a></h4>
<div class="paragraph">
<p>Selenium is able to verify web elements on the current page. You can select the element by its attributes (e.g. id, name, style)
and verify its properties (e.g. text value, styles).</p>
</div>
<div class="listingblock">
<div class="title">@When("^(?:Browser|browser) page should display {element-type} with {attribute}="{value}"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When Browser page should display {element-type} with {attribute}="{value}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step verifies that the given element of type <code>{element-type}</code> is present on the current web page. The element is selected
by the given <code>{attribute}</code> and <code>{value}</code>.</p>
</div>
<div class="listingblock">
<div class="title">Verify heading with text</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When Browser page should display heading with text="Welcome!"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Possible element types are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>element</p>
</li>
<li>
<p>button</p>
</li>
<li>
<p>link</p>
</li>
<li>
<p>input</p>
</li>
<li>
<p>textfield</p>
</li>
<li>
<p>form</p>
</li>
<li>
<p>heading</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Possible attributes to select the element are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>id</p>
</li>
<li>
<p>name</p>
</li>
<li>
<p>class-name</p>
</li>
<li>
<p>link-text</p>
</li>
<li>
<p>css-selector</p>
</li>
<li>
<p>tag-name</p>
</li>
<li>
<p>xpath</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can add additional attribute validations in a data table</p>
</div>
<div class="listingblock">
<div class="title">Verify element with attributes</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When And browser page should display element with id="hello-text" having
    | text   | Hello!         |
    | styles | background-color=rgba(0, 0, 0, 0) |</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-selenium-click"><a class="anchor" href="#steps-selenium-click"></a><a class="link" href="#steps-selenium-click">50.11.7. Click elements</a></h4>
<div class="paragraph">
<p>You can click on elements such as buttons or links. The element must be identified by an attribute (e.g. id, name, style)
with a given value.</p>
</div>
<div class="listingblock">
<div class="title">@When("^(?:User|user) clicks (?:element|button|link) with {attribute}="{value}"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When User clicks (element|button|link) with {attribute}="{value}"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Click button by id</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When User clicks button with id="submit"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-selenium-forms"><a class="anchor" href="#steps-selenium-forms"></a><a class="link" href="#steps-selenium-forms">50.11.8. Form controls</a></h4>
<div class="paragraph">
<p>Filling out a user form on a web page is a very common use case in UI testing. Citrus is able to enter text into input fields,
select items from a drop down list and check/uncheck checkboxes.</p>
</div>
<div class="sect4">
<h5 id="input-fields"><a class="anchor" href="#input-fields"></a><a class="link" href="#input-fields">Input fields</a></h5>
<div class="listingblock">
<div class="title">@When("^(?:User|user) enters text "{input}" to (?:element|input|textfield) with {attribute}="{value}"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When User enters text "{input}" to (element|input|textfield) with {attribute}="{value}"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Enter text in input field</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When User enters text "Christoph" to input with id="name"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="checkboxes"><a class="anchor" href="#checkboxes"></a><a class="link" href="#checkboxes">Checkboxes</a></h5>
<div class="listingblock">
<div class="title">@When("^(?:User|user) (checks|unchecks) checkbox with {attribute}="{value}"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When User (checks|unchecks) checkbox with {attribute}="{value}"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Check checkbox</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When User checks checkbox with id="show-details"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="dropdowns"><a class="anchor" href="#dropdowns"></a><a class="link" href="#dropdowns">Dropdowns</a></h5>
<div class="listingblock">
<div class="title">@When("^(?:User|user) selects option "{option}" on (?:element|dropdown) with {attribute}="{value}"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When User selects option "{option}" with {attribute}="{value}"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Check checkbox</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When User selects option "21-30" on dropdown with id="age"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-selenium-alert"><a class="anchor" href="#steps-selenium-alert"></a><a class="link" href="#steps-selenium-alert">50.11.9. Alert dialogs</a></h4>
<div class="paragraph">
<p>Web pages can open alert dialogs that need to be accepted or dismissed.</p>
</div>
<div class="listingblock">
<div class="title">@When("^(?:User|user) (accepts|dismisses) alert$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When User (accepts|dismisses) alert</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also verify the alert text displayed to the user.</p>
</div>
<div class="listingblock">
<div class="title">@When("^(?:Browser|browser) page should display alert with text "{text}"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When Browser page should display alert with text "{text}"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Verify alert with text</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">When Browser page should display alert with text "WARNING!"</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The alert text verification implicitly accepts the alert dialog after validation.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="steps-selenium-pages"><a class="anchor" href="#steps-selenium-pages"></a><a class="link" href="#steps-selenium-pages">50.11.10. Page objects</a></h4>
<div class="paragraph">
<p>Selenium provides a good way to encapsulate web page capabilities in form of page objects. These object usually defines elements
on a web page and perform predefined operations on that page.</p>
</div>
<div class="listingblock">
<div class="title">Page object</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class UserFormPage implements WebPage {

    @FindBy(id = "userForm")
    private WebElement form;

    @FindBy(id = "username")
    private WebElement userName;

    /**
     * Sets the user name.
     * @param value
     */
    public void setUserName(String value) {
        userName.clear();
        userName.sendKeys(value);
    }

    /**
     * Submits the form.
     */
    public void submit() {
        form.submit();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The page object above defines a <code>form</code> element as well as a <code>username</code> input text field. The page identifies the elements
with <code>@FindBy</code> annotations. In addition, the page defines operations such as <code>setUserName</code> and <code>submit</code>.</p>
</div>
<div class="paragraph">
<p>Citrus is able to load the page objects by its name in the current configuration (e.g. Spring application context).</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Browser|browser) page "{name}"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Browser page "{name}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step loads the page object that has been added to the configuration with the given name.</p>
</div>
<div class="paragraph">
<p>You can also instantiate new page objects by its types as follows:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Browser|browser) page "{name}" of type {type}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Browser page "{name}" of type {type}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Instantiate UserForm page</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Browser page "userForm" of type org.sample.UserFormPage</code></pre>
</div>
</div>
<div class="paragraph">
<p>This loads a new page object of type <code>org.sample.UserFormPage</code>. Please make sure that the given class is available on the test
classpath and that the class provides a default constructor.</p>
</div>
<div class="paragraph">
<p>You can instantiate many web page objects in a single step.</p>
</div>
<div class="listingblock">
<div class="title">Instantiate many page objects</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Browser page types
  | indexPage | org.sample.IndexPage     |
  | userForm  | org.sample.UserFormPage  |
  | orderForm | org.sample.OrderFormPage |</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the page objects are loaded you can perform operations.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Browser|browser) page {name} performs {operation}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Browser page {name} performs {operation}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Call submit operation on userForm</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Browser page userForm performs submit</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step uses the given page object <code>userForm</code> and performs the <code>submit</code> operation. This simply calls the <code>submit()</code> method
on the page object.</p>
</div>
<div class="listingblock">
<div class="title">Page object</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class UserFormPage implements WebPage {

    @FindBy(id = "userForm")
    private WebElement form;

    /**
     * Submits the form.
     */
    public void submit() {
        form.submit();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case the operation requires parameters you can set those on the operation call.</p>
</div>
<div class="listingblock">
<div class="title">Call setUserName operation with arguments</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Browser page userForm performs setUserName with arguments
  | Christoph |</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>setUserName</code> operation on the page object requires the username value as a parameter. This value is set as <code>Christoph</code> in
the step above.</p>
</div>
<div class="listingblock">
<div class="title">Page object</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class UserFormPage implements WebPage {

    @FindBy(id = "username")
    private WebElement userName;

    /**
     * Sets the user name.
     * @param value
     */
    public void setUserName(String value) {
        userName.clear();
        userName.sendKeys(value);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each page operation can use the current <code>TestContext</code> as argument, too. This context will be automatically injected by Citrus
when the operation is called.</p>
</div>
<div class="listingblock">
<div class="title">Use test context in page objects</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class UserFormPage implements WebPage {

    @FindBy(id = "username")
    private WebElement userName;

    /**
     * Sets the user name.
     * @param value
     * @param context
     */
    public void setUserName(String value, TestContext context) {
        userName.clear();
        userName.sendKeys(value);

        context.setVariable("username", value);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The page operation <code>setUserName</code> uses the <code>TestContext</code> as additional method argument and is able to set a new test variable.
All subsequent steps in the test are able to access this new variable with <code>${username}</code> then.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-selenium-page-validators"><a class="anchor" href="#steps-selenium-page-validators"></a><a class="link" href="#steps-selenium-page-validators">50.11.11. Page validator</a></h4>
<div class="paragraph">
<p>The previous section has introduced the concept of page objects and how to perform operations on the given page. You can also
use page objects to verify the page contents.</p>
</div>
<div class="listingblock">
<div class="title">Page validator</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class UserFormPageValidator implements PageValidator&lt;UserFormPage&gt; {

    @Override
    public void validate(UserFormPage webPage, SeleniumBrowser browser, TestContext context) {
        Assert.assertNotNull(webPage.userName);
        Assert.assertTrue(StringUtils.hasText(webPage.userName.getAttribute("value")));
        Assert.assertNotNull(webPage.form);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The page validator implements the <code>PageValidator&lt;&gt;</code> interface and implements a <code>validate</code> method. The validation is provided
with the actual page object, the browser instance and the current test context.</p>
</div>
<div class="paragraph">
<p>The validator should verify that the current state on the page is as expected.</p>
</div>
<div class="paragraph">
<p>Citrus is able to load the page validator by its name in the current configuration (e.g. Spring application context).</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Browser|browser) page validator "{name}"$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Browser page validator "{name}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step loads the page validator that has been added to the configuration with the given name.</p>
</div>
<div class="paragraph">
<p>You can also instantiate new page validator objects by its types as follows:</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Browser|browser) page validator "{name}" of type {type}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Browser page validator "{name}" of type {type}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Create page validator</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Browser page validator "userFormValidator" of type org.sample.UserFormPageValidator</code></pre>
</div>
</div>
<div class="paragraph">
<p>This loads a new page validator of type <code>org.sample.UserFormPageValidator</code>. Please make sure that the given class is available on the test
classpath and that the class provides a default constructor.</p>
</div>
<div class="paragraph">
<p>You can instantiate many web page validator objects in a single step.</p>
</div>
<div class="listingblock">
<div class="title">Instantiate many page validator objects</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Browser page validator types
  | indexPageValidator | org.sample.IndexPageValidator     |
  | userFormValidator  | org.sample.UserFormPageValidator  |
  | orderFormValidator | org.sample.OrderFormPageValidator |</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the page validator objects are loaded you can perform its validations.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^(?:Browser|browser) page {name} should validate with {validator}$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Browser page {name} should validate with {validator}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Validate userForm page with userFormValidator</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Browser page userForm should validate with userFormValidator</code></pre>
</div>
</div>
<div class="paragraph">
<p>The step calls the <code>validate</code> method on the page validator <code>userFormValidator</code> and passes the <code>userForm</code> page object as
argument.</p>
</div>
<div class="listingblock">
<div class="title">Page validator</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class UserFormPageValidator implements PageValidator&lt;UserFormPage&gt; {

    @Override
    public void validate(UserFormPage webPage, SeleniumBrowser browser, TestContext context) {
        Assert.assertNotNull(webPage.userName);
        Assert.assertTrue(StringUtils.hasText(webPage.userName.getAttribute("value")));
        Assert.assertNotNull(webPage.form);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The validator accesses the elements and operations provided in the page object and makes sure the state is as expected.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The page object itself can also implement the page validator interface. This way you can combine the concept of
page objects and validator in a single class. The step to verify the page is then able to just use the page object name.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Validate userForm page with implicit validator</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given Browser page userForm should validate</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Page object implementing validator</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class UserFormPage implements WebPage, PageValidator&lt;UserFormPage&gt; {

    @FindBy(id = "userForm")
    private WebElement form;

    @FindBy(id = "username")
    private WebElement userName;

    [...]

    @Override
    public void validate(UserFormPage webPage, SeleniumBrowser browser, TestContext context) {
        Assert.assertNotNull(userName);
        Assert.assertTrue(StringUtils.hasText(userName.getAttribute("value")));
        Assert.assertNotNull(form);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tools-cucumber-steps-testcontainers"><a class="anchor" href="#tools-cucumber-steps-testcontainers"></a><a class="link" href="#tools-cucumber-steps-testcontainers">50.12. Testcontainers steps</a></h3>
<div class="paragraph">
<p>Citrus provides steps that allow to leverage the power of <a href="https://www.testcontainers.org/">Testcontainers</a> library as part of Cloud native tests.
You can configure and start Testcontainers modules as pod in the current namespace.
Testcontainers provides a great set of ready-to-use containers (e.g. <a href="https://www.testcontainers.org/modules/databases/">database containers</a>, <a href="https://www.testcontainers.org/modules/localstack/">AWS cloud stack</a> and many more).</p>
</div>
<div class="sect3">
<h4 id="steps-testcontainer-priviledges"><a class="anchor" href="#steps-testcontainer-priviledges"></a><a class="link" href="#steps-testcontainer-priviledges">50.12.1. Setup required privileges</a></h4>
<div class="paragraph">
<p>Running Testcontainers in Kubernetes may require privileges on the Citrus service account.
This depends on the restrictions and RBAC settings in your cluster.</p>
</div>
<div class="paragraph">
<p>Be sure to add <code>privileged</code> security context constraint to the <code>citrus-viewer</code> service account in the namespace where tests are run.</p>
</div>
<div class="listingblock">
<div class="title">Add privileged security context constraint</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc adm policy add-scc-to-user privileged system:serviceaccount:{namespace}:citrus-viewer</code></pre>
</div>
</div>
<div class="paragraph">
<p>This adds the <code>privileged</code> security constraint to the <code>citrus-viewer</code> service account.
This is required for the test to start and manage a Testcontainer pod as part of the test.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-testcontainer-database"><a class="anchor" href="#steps-testcontainer-database"></a><a class="link" href="#steps-testcontainer-database">50.12.2. Database containers</a></h4>
<div class="paragraph">
<p>You can choose from a wide range of database modules provided in Testcontainers.
Citrus is able to run these database containers as part of the test.</p>
</div>
</div>
<div class="sect3">
<h4 id="steps-testcontainer-postgresql"><a class="anchor" href="#steps-testcontainer-postgresql"></a><a class="link" href="#steps-testcontainer-postgresql">50.12.3. PostgreSQL container</a></h4>
<div class="paragraph">
<p>Configure and manage a PostgreSQL database container.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^PostgreSQL version (^\\s+)$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given PostgreSQL version 9.6.12</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">@Given("^start PostgreSQL container$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given start PostgreSQL container</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="steps-testcontainer-mongodb"><a class="anchor" href="#steps-testcontainer-mongodb"></a><a class="link" href="#steps-testcontainer-mongodb">50.12.4. MongoDB container</a></h4>
<div class="paragraph">
<p>Configure and manage a MongoDB database container.</p>
</div>
<div class="listingblock">
<div class="title">@Given("^MongoDB version (^\\s+)$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given MongoDB version 4.10.0</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">@Given("^start MongoDB container$")</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gherkin hljs" data-lang="gherkin">Given start MongoDB container</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-restdocs"><a class="anchor" href="#spring-restdocs"></a><a class="link" href="#spring-restdocs">51. Spring Restdocs support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Restdocs project helps to easily generate API documentation for RESTful services. While messages are exchanged the Restdocs library generates request/response snippets and API documentation. You can add the Spring Restdocs documentation to the Citrus client components for Http <strong>and</strong> SOAP endpoints.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Spring Restdocs support components in Citrus are kept in a separate Maven module. If not already done, you have to include the module as Maven dependency to your project
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.citrusframework&lt;/groupId&gt;
  &lt;artifactId&gt;citrus-restdocs&lt;/artifactId&gt;
  &lt;version&gt;${citrus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="spring-restdocs-using-http"><a class="anchor" href="#spring-restdocs-using-http"></a><a class="link" href="#spring-restdocs-using-http">51.1. Spring Restdocs using Http</a></h3>
<div class="paragraph">
<p>First of all we concentrate on adding the Spring Restdocs feature to Http client communication. The next sample configuration uses the new Spring Restdocs components in Citrus:</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.restdocs.http.CitrusRestDocsSupport;

@BindToRegistry
public HttpClient httpClient() {
    return new HttpClientBuilder()
                .requestUrl("http://localhost:11080/hello")
                .requestMethod(RequestMethod.POST)
                .contentType(MediaType.APPLICATION_XML_VALUE)
                .interceptors(Arrays.asList(restDocumentationConfigurer, restDocumentationInterceptor))
                .build();
}

@BindToRegistry
public CitrusRestDocConfigurer restDocumentationConfigurer() {
    return CitrusRestDocsSupport.restDocsConfigurer(new ManualRestDocumentation("target/citrus-docs/generated-snippets"));
}

@BindToRegistry
public RestDocClientInterceptor restDocumentationInterceptor() {
    return CitrusRestDocsSupport.restDocsInterceptor("rest-docs/{method-name}");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.restdocs.http.CitrusRestDocsSupport;

@Bean
public HttpClient httpClient() {
    return new HttpClientBuilder()
                .requestUrl("http://localhost:11080/hello")
                .requestMethod(RequestMethod.POST)
                .contentType(MediaType.APPLICATION_XML_VALUE)
                .interceptors(Arrays.asList(restDocumentationConfigurer, restDocumentationInterceptor))
                .build();
}

@Bean
public CitrusRestDocConfigurer restDocumentationConfigurer() {
    return CitrusRestDocsSupport.restDocsConfigurer(new ManualRestDocumentation("target/citrus-docs/generated-snippets"));
}

@Bean
public RestDocClientInterceptor restDocumentationInterceptor() {
    return CitrusRestDocsSupport.restDocsInterceptor("rest-docs/{method-name}");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus-restdocs="http://www.citrusframework.org/schema/restdocs/config"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.citrusframework.org/schema/restdocs/config
       http://www.citrusframework.org/schema/restdocs/config/citrus-restdocs-config.xsd"&gt;

    &lt;citrus-restdocs:documentation id="restDocumentation"
                              output-directory="target/citrus-docs/generated-snippets"
                              identifier="rest-docs/{method-name}"/&gt;

    &lt;citrus-http:client id="httpClient"
          request-url="http://localhost:8080/test"
          request-method="POST"
          interceptors="restDocumentation"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For easy configuration Citrus has created a separate namespace and schema definition for Spring XML Restdocs related documentation.
Include this namespace into your Spring configuration in order to use the Citrus Restdocs configuration elements.
The namespace URI and schema location are added to the Spring configuration XML file as seen in the example above.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The RestDocs configurer must be added to the list of Citrus test listeners.
This is a mandatory step in order to enable the configurer for documentation preparations before each test.
Otherwise, we would not be able to generate proper documentation.
Usually, when binding the bean to the Citrus registry or the Spring bean application context or when using the Spring bean XML configuration this is done automatically for you.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The above component adds a new documentation configuration.
Behind the scenes the component creates a new restdocs configurer and a client interceptor.
We can reference the new restdocs component in <strong>citrus-http</strong> client components like see in the example above.</p>
</div>
<div class="paragraph">
<p>The Spring Restdocs documentation component acts as a client interceptor. Every time the client component is used to send and receive a message the restdocs interceptor will automatically create its API documentation. The configuration <strong>identifier</strong> attribute describes the output format <code>rest-docs/{method-name}</code> which results in a folder layout like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plaintext hljs" data-lang="plaintext">target/citrus-docs
  |- rest-docs
    |- test-a
      |- curl-request.adoc
      |- http-request.adoc
      |- http-response.adoc
    |- test-b
      |- curl-request.adoc
      |- http-request.adoc
      |- http-response.adoc
    |- test-c
      |- curl-request.adoc
      |- http-request.adoc
      |- http-response.adoc</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above is the result of three test cases each of them performing a client Http request/response communication.
Each test message exchange is documented with separate files.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s use the HttpClient with the documentation enabled in a test like this:</p>
</div>
<div class="listingblock">
<div class="title">Java DSL</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class RestDocConfigurationIT extends TestNGCitrusSpringSupport implements TestActionSupport {

    @Test
    @CitrusTest
    public void testRestDocs() {
        when(http().client(httpClient)
                .send()
                .post()
                .message()
                .body("""
                &lt;testRequestMessage&gt;
                    &lt;text&gt;Hello HttpServer&gt;/text&gt;
                &lt;/testRequestMessage&gt;
                """)
                .header("Operation", "sayHello"));

        then(http().client(httpClient)
                .receive()
                .response(HttpStatus.OK)
                .message()
                .body("""
                &lt;testResponseMessage&gt;
                    &lt;text&gt;Hello Citrus!&gt;/text&gt;
                &lt;/testResponseMessage&gt;
                """)
                .header("Operation", "sayHello"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test produces the request.</p>
</div>
<div class="listingblock">
<div class="title">http-request.adoc</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-http hljs" data-lang="http">POST /test HTTP/1.1
Accept: application/xml
CustomHeaderId: 123456789
Content-Type: application/xml;charset=UTF-8
Content-Length: 118
Accept-Charset: utf-8
Host: localhost
Operation: sayHello

&lt;testRequestMessage&gt;
    &lt;text&gt;Hello HttpServer&gt;/text&gt;
&lt;/testRequestMessage&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>http-request.adoc</strong> file represents the send message data for the client request.
The respective <strong>http-response.adoc</strong> represents the response that was sent to the client.</p>
</div>
<div class="listingblock">
<div class="title">http-response.adoc</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-http hljs" data-lang="http">HTTP/1.1 200 OK
Date: Tue, 07 Jun 2016 12:10:46 GMT
Content-Type: application/xml;charset=UTF-8
Accept-Charset: utf-8
Content-Length: 122
Server: Jetty(9.2.15.v20160210)
Operation: sayHello

&lt;testResponseMessage&gt;
    &lt;text&gt;Hello Citrus!&gt;/text&gt;
&lt;/testResponseMessage&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nice work! We have automatically created snippets for the RESTful API by just adding the interceptor to the Citrus client component.
Spring Restdocs components can be combined manually.
See the next configuration that uses this approach.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.restdocs.http.CitrusRestDocsSupport;

@BindToRegistry
public HttpClient httpClient() {
    return new HttpClientBuilder()
                .requestUrl("http://localhost:11080/hello")
                .requestMethod(RequestMethod.POST)
                .contentType(MediaType.APPLICATION_XML_VALUE)
                .interceptors(Arrays.asList(restDocumentationConfigurer, restDocumentationInterceptor))
                .build();
}

@BindToRegistry
public CitrusRestDocConfigurer restDocumentationConfigurer() {
    return CitrusRestDocsSupport.restDocsConfigurer(new ManualRestDocumentation("target/citrus-docs/generated-snippets"));
}

@BindToRegistry
public RestDocClientInterceptor restDocumentationInterceptor() {
    return CitrusRestDocsSupport.restDocsInterceptor("rest-docs/{method-name}");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.restdocs.http.CitrusRestDocsSupport;

@Bean
public HttpClient httpClient() {
    return new HttpClientBuilder()
                .requestUrl("http://localhost:11080/hello")
                .requestMethod(RequestMethod.POST)
                .contentType(MediaType.APPLICATION_XML_VALUE)
                .interceptors(Arrays.asList(restDocumentationConfigurer, restDocumentationInterceptor))
                .build();
}

@Bean
public CitrusRestDocConfigurer restDocumentationConfigurer() {
    return CitrusRestDocsSupport.restDocsConfigurer(new ManualRestDocumentation("target/citrus-docs/generated-snippets"));
}

@Bean
public RestDocClientInterceptor restDocumentationInterceptor() {
    return CitrusRestDocsSupport.restDocsInterceptor("rest-docs/{method-name}");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus-restdocs="http://www.citrusframework.org/schema/restdocs/config"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.citrusframework.org/schema/restdocs/config
       http://www.citrusframework.org/schema/restdocs/config/citrus-restdocs-config.xsd"&gt;

    &lt;citrus-restdocs:configurer id="restDocConfigurer" output-directory="target/citrus-docs/generated-snippets"/&gt;
    &lt;citrus-restdocs:client-interceptor id="restDocClientInterceptor" identifier="rest-docs/{method-name}"/&gt;

    &lt;util:list id="restDocInterceptors"&gt;
        &lt;ref bean="restDocConfigurer"/&gt;
        &lt;ref bean="restDocClientInterceptor"/&gt;
    &lt;/util:list&gt;

    &lt;citrus-http:client id="httpClient"
          request-url="http://localhost:8080/test"
          request-method="POST"
          interceptors="restDocInterceptors"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>What exactly is the difference to the <strong>citrus-restdocs:documentation</strong> that we have used before? In general there is no difference. Both configurations are identical in its outcome. Why should someone use the second approach then? It is more verbose as we need to also define a list of interceptors. The answer is easy. If you want to combine the restdocs interceptors with other client interceptors in a list then you should use the manual combination approach. We can add basic authentication interceptors for instance to the list of interceptors then. The more comfortable <strong>citrus-restdocs:documentation</strong> component only supports exclusive restdocs interceptors.</p>
</div>
</div>
<div class="sect2">
<h3 id="spring-restdocs-using-soap"><a class="anchor" href="#spring-restdocs-using-soap"></a><a class="link" href="#spring-restdocs-using-soap">51.2. Spring Restdocs using SOAP</a></h3>
<div class="paragraph">
<p>You can use the Spring Restdocs features also for SOAP clients in Citrus. This is a controversy idea as SOAP endpoints are different to RESTful concepts. But at the end SOAP Http communication is Http communication with request and response messages. Why should we miss out the fantastic documentation feature here just because of ideology reasons.</p>
</div>
<div class="paragraph">
<p>The concept of adding the Spring Restdocs documentation as interceptor to the client is still the same.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.restdocs.http.CitrusRestDocsSupport;

@BindToRegistry
public WebServiceClient soapClient() {
    return new WebServiceClientBuilder()
                .defaultUri("http://localhost:8080/test")
                .interceptors(Arrays.asList(soapDocumentationConfigurer, soapDocumentationInterceptor))
                .build();
}

@BindToRegistry
public CitrusRestDocConfigurer soapDocumentationConfigurer() {
    return CitrusRestDocsSupport.restDocsConfigurer(new ManualRestDocumentation("target/citrus-docs/generated-snippets"));
}

@BindToRegistry
public RestDocClientInterceptor soapDocumentationInterceptor() {
    return CitrusRestDocsSupport.restDocsInterceptor("soap-docs/{method-name}");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.citrusframework.restdocs.http.CitrusRestDocsSupport;

@Bean
public WebServiceClient soapClient() {
    return new WebServiceClientBuilder()
                .defaultUri("http://localhost:8080/test")
                .interceptors(Arrays.asList(soapDocumentationConfigurer, soapDocumentationInterceptor))
                .build();
}

@Bean
public CitrusRestDocConfigurer soapDocumentationConfigurer() {
    return CitrusRestDocsSupport.restDocsConfigurer(new ManualRestDocumentation("target/citrus-docs/generated-snippets"));
}

@Bean
public RestDocClientInterceptor soapDocumentationInterceptor() {
    return CitrusRestDocsSupport.restDocsInterceptor("soap-docs/{method-name}");
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus-restdocs="http://www.citrusframework.org/schema/restdocs/config"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.citrusframework.org/schema/restdocs/config
       http://www.citrusframework.org/schema/restdocs/config/citrus-restdocs-config.xsd"&gt;

    &lt;citrus-restdocs:documentation id="soapDocumentation"
                              type="soap"
                              output-directory="target/citrus-docs/generated-snippets"
                              identifier="soap-docs/{method-name}"/&gt;

    &lt;citrus-ws:client id="soapClient"
                  request-url="http://localhost:8080/test"
                  interceptors="soapDocumentation"/&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have added a <strong>type</strong> setting with value <strong>soap</strong> . And that is basically all we need to do. Now Citrus knows that we would like to add documentation for a SOAP client:</p>
</div>
<div class="paragraph">
<p>Following from that the <strong>soapClient</strong> is enabled to generate Spring Restdocs documentation for each request/response. The generated snippets then do represent the SOAP request and response messages.</p>
</div>
<div class="listingblock">
<div class="title">http-request.adoc</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-http hljs" data-lang="http">POST /test HTTP/1.1
SOAPAction: "test"
Accept: application/xml
CustomHeaderId: 123456789
Content-Type: application/xml;charset=UTF-8
Content-Length: 529
Accept-Charset: utf-8
Host: localhost

&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
  &lt;SOAP-ENV:Header&gt;
    &lt;Operation xmlns="http://citrusframework.org/test"&gt;sayHello&gt;/Operation&gt;
  &lt;/SOAP-ENV:Header&gt;
  &lt;SOAP-ENV:Body&gt;
    &lt;testRequestMessage&gt;
      &lt;text&gt;Hello HttpServer&gt;/text&gt;
    &lt;/testRequestMessage&gt;
  &lt;/SOAP-ENV:Body&gt;
&lt;/SOAP-ENV:Envelope&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">http-response.adoc</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-http hljs" data-lang="http">HTTP/1.1 200 OK
Date: Tue, 07 Jun 2016 12:10:46 GMT
Content-Type: application/xml;charset=UTF-8
Accept-Charset: utf-8
Content-Length: 612
Server: Jetty(9.2.15.v20160210)

&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
  &lt;SOAP-ENV:Header&gt;
    &gt;Operation xmlns="http://citrusframework.org/test"&gt;sayHello&gt;/Operation&gt;
  &lt;/SOAP-ENV:Header&gt;
  &lt;SOAP-ENV:Body&gt;
    &lt;testResponseMessage&gt;
      &lt;text&gt;Hello Citrus!&gt;/text&gt;
    &lt;/testResponseMessage&gt;
  &lt;/SOAP-ENV:Body&gt;
&lt;/SOAP-ENV:Envelope&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The file names are still using <strong>http-request</strong> and <strong>http-response</strong> but the content is clearly the SOAP request/response message data.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tracing-messages"><a class="anchor" href="#tracing-messages"></a><a class="link" href="#tracing-messages">52. Tracing messages</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>As we deal with message based interfaces Citrus will send and receive a lot of messages during a test run. Now we may want to see these messages in chronological order as they were processed by Citrus. We can enable message tracing in Citrus in order to save messages to the file system for further investigations.</p>
</div>
<div class="paragraph">
<p>Citrus offers an easy way to debug all received messages to the file system. You need to enable some specific loggers and interceptors in the Spring application context.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean class="org.citrusframework.report.MessageTracingTestListener"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just add this bean to the Spring configuration and Citrus will listen for sent and received messages for saving those to the file system. You will find files like these in the default test output folder after the test run:</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">logs/trace/messages/MyTest.msgs
logs/trace/messages/FooTest.msgs
logs/trace/messages/SomeTest.msgs</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each Citrus test writes a <strong>.msgs</strong> file containing all messages that went over the wire during the test. By default the debug directory is set to <strong><em>logs/trace/messages/</em></strong> relative to the project test output directory. But you can set your own output directory in the configuration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean class="org.citrusframework.report.MessageTracingTestListener"&gt;
  &lt;property name="outputDirectory" value="file:/path/to/folder"/&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As the file names do not change with each test run message tracing files may be overwritten. So you eventually need to save the generated message debug files before running another group of test cases.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s see some sample output for a test case with message communication over SOAP Http:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">Sending SOAP request:
&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
&lt;SOAP-ENV:Header&gt;
&lt;Operation xmlns="http://citrusframework.org/test"&gt;sayHello&lt;/Operation&gt;
&lt;/SOAP-ENV:Header&gt;
&lt;SOAP-ENV:Body&gt;
&lt;ns0:HelloRequest xmlns:ns0="http://citrusframework.org/schemas/samples/sayHello.xsd"&gt;
    &lt;ns0:MessageId&gt;0857041782&lt;/ns0:MessageId&gt;
    &lt;ns0:CorrelationId&gt;6915071793&lt;/ns0:CorrelationId&gt;
    &lt;ns0:User&gt;Christoph&lt;/ns0:User&gt;
    &lt;ns0:Text&gt;Hello WebServer&lt;/ns0:Text&gt;
&lt;/ns0:HelloRequest&gt;
&lt;/SOAP-ENV:Body&gt;
&lt;/SOAP-ENV:Envelope&gt;

======================================================================

Received SOAP response:
&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
&lt;SOAP-ENV:Header/&gt;
&lt;SOAP-ENV:Body&gt;
&lt;ns0:HelloResponse xmlns:ns0="http://citrusframework.org/schemas/samples/sayHello.xsd"&gt;
    &lt;ns0:MessageId&gt;0857041782&lt;/ns0:MessageId&gt;
    &lt;ns0:CorrelationId&gt;6915071793&lt;/ns0:CorrelationId&gt;
    &lt;ns0:User&gt;WebServer&lt;/ns0:User&gt;
    &lt;ns0:Text&gt;Hello Christoph&lt;/ns0:Text&gt;
&lt;/ns0:HelloResponse&gt;
&lt;/SOAP-ENV:Body&gt;
&lt;/SOAP-ENV:Envelope&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For this message tracing to work we need to add logging listeners to our sender and receiver components accordingly.</p>
</div>
<div class="listingblock primary">
<div class="title">Citrus Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BindToRegistry
public WebServiceClient soapClient() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8080/services/ws/todolist")
            .interceptors(clientInterceptors())
            .build();
}

public List&lt;ClientInterceptor&gt; clientInterceptors() {
    return Arrays.asList(new LoggingClientInterceptor());
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring Bean</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public WebServiceClient soapClient() {
    return new WebServiceClientBuilder()
            .defaultUri("http://localhost:8080/services/ws/todolist")
            .interceptors(clientInterceptors())
            .build();
}

public List&lt;ClientInterceptor&gt; clientInterceptors() {
    return Arrays.asList(new LoggingClientInterceptor());
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Spring XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:citrus="http://www.citrusframework.org/schema/config"
       xmlns:citrus-ws="http://www.citrusframework.org/schema/ws/config"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.citrusframework.org/schema/config
       http://www.citrusframework.org/schema/config/citrus-config.xsd
       http://www.citrusframework.org/schema/ws/config
       http://www.citrusframework.org/schema/ws/config/citrus-ws-config.xsd"&gt;


    &lt;citrus-ws:client id="soapClient"
                    request-url="http://localhost:8080/services/ws/todolist[http://localhost:8071]"
                    interceptors="clientInterceptors"/&gt;

    &lt;util:list id="clientInterceptors"&gt;
        &lt;bean class="org.citrusframework.ws.interceptor.LoggingClientInterceptor"/&gt;
    &lt;/util:list&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Be aware of adding the Spring <strong>util</strong> XML namespace to the application context when using the <strong>util:list</strong> construct.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="samples"><a class="anchor" href="#samples"></a><a class="link" href="#samples">53. Samples</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter gives some samples where you can see Citrus in action.</p>
</div>
<div class="sect2">
<h3 id="samples-flightbooking"><a class="anchor" href="#samples-flightbooking"></a><a class="link" href="#samples-flightbooking">53.1. The FlightBooking sample</a></h3>
<div class="paragraph">
<p>A simple project example should give you the idea how Citrus works. The system under test is a flight booking service that handles travel requests from a travel agency. A travel request consists of a complete travel route including several flights. The FlightBookingService application will split the complete travel booking into separate flight bookings that are sent to the respective airlines in charge. The booking and customer data is persisted in a database.</p>
</div>
<div class="paragraph">
<p>The airlines will confirm or deny the flight bookings. The FlightBookingService application consolidates all incoming flight confirmations and combines them to a complete travel confirmation or denial that is sent back to the travel agency. Next picture tries to put the architecture into graphics:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/samples/flightbooking/architecture_overview.jpg" alt="samples/flightbooking/architecture_overview.jpg"></span></p>
</div>
<div class="paragraph">
<p>In our example two different airlines are connected to the FlightBookingService application: the SmartAriline over JMS and the RoyalAirline over Http.</p>
</div>
<div class="sect3">
<h4 id="flightbooking-use-case"><a class="anchor" href="#flightbooking-use-case"></a><a class="link" href="#flightbooking-use-case">53.1.1. The use case</a></h4>
<div class="paragraph">
<p>The use case that we would like to test is quite simple. The test should handle a simple travel booking and expect a positive processing to the end. The test case neither simulates business errors nor technical problems. Next picture shows the use case as a sequence diagram.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/samples/flightbooking/sequence_diagram.jpg" alt="samples/flightbooking/sequence_diagram.jpg"></span></p>
</div>
<div class="paragraph">
<p>The travel agency puts a travel booking request towards the system. The travel booking contains two separate flights. The flight requests are published to the airlines (SmartAirline and RoyalAirline). Both airlines confirm the flight bookings with a positive answer. The consolidated travel booking response is then sent back to the travel agency.</p>
</div>
</div>
<div class="sect3">
<h4 id="flightbooking-simulated-systems"><a class="anchor" href="#flightbooking-simulated-systems"></a><a class="link" href="#flightbooking-simulated-systems">53.1.2. Configure the simulated systems</a></h4>
<div class="paragraph">
<p>Citrus simulates all surrounding applications in their behavior during the test. The simulated applications are: TravelAgency, SmartAirline and RoyalAirline. The simulated systems have to be configured in the Citrus configuration first. The configuration is done in Spring XML configuration files, as Citrus uses Spring to glue all its services together.</p>
</div>
<div class="paragraph">
<p>First of all we have a look at the TravelAgency configuration. The TravelAgency is using JMS to connect to our tested system, so we need to configure this JMS connection in Citrus.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="connectionFactory" class="org.apache.activemq.artemis.jms.client.ActiveMQConnectionFactory"&gt;
  &lt;property name="brokerURL" value="tcp://localhost:61616"/&gt;
&lt;/bean&gt;

&lt;citrus-jms:endpoint id="travelAgencyBookingRequestEndpoint"
                      destination-name="${travel.agency.request.queue}"/&gt;

&lt;citrus-jms:endpoint id="travelAgencyBookingResponseEndpoint"
                      destination-name="${travel.agency.response.queue}"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is all Citrus needs to send and receive messages over JMS in order to simulate the TravelAgency. By default all JMS message senders and receivers need a connection factory. Therefore Citrus is searching for a bean named "connectionFactory". In the example we connect to a ActiveMQ message broker. A connection to other JMS brokers like TIBCO EMS or Apache ActiveMQ is possible too by simply changing the connection factory implementation.</p>
</div>
<div class="paragraph">
<p>The identifiers of the message senders and receivers are very important. We should think of suitable ids that give the reader a first hint what the sender/receiver is used for. As we want to simulate the TravelAgency in combination with sending booking requests our id is "travelAgencyBookingRequestEndpoint" for example.</p>
</div>
<div class="paragraph">
<p>The sender and receivers do also need a JMS destination. Here the destination names are provided by property expressions. The Spring IoC container resolves the properties for us. All we need to do is publish the property file to the Spring container like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean name="propertyLoader"
   class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"&gt;
    &lt;property name="locations"&gt;
        &lt;list&gt;
            &lt;value&gt;citrus.properties&lt;/value&gt;
        &lt;/list&gt;
    &lt;/property&gt;
    &lt;property name="ignoreUnresolvablePlaceholders" value="true"/&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The citrus.properties file is located in our project&#8217;s resources folder and defines the actual queue names besides other properties of course:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">#JMS queues
travel.agency.request.queue=Travel.Agency.Request.Queue
travel.agency.response.queue=Travel.Agency.Response.Queue
smart.airline.request.queue=Smart.Airline.Request.Queue
smart.airline.response.queue=Smart.Airline.Response.Queue
royal.airline.request.queue=Royal.Airline.Request.Queue</code></pre>
</div>
</div>
<div class="paragraph">
<p>What else do we need in our Spring configuration? There are some basic beans that are commonly defined in a Citrus application but I do not want to bore you with these details. So if you want to have a look at the Spring application context file in the resources folder and see how things are defined there.</p>
</div>
<div class="paragraph">
<p>We continue with the first airline to be configured the SmartAirline. The SmartAirline is also using JMS to communicate with the FlightBookingService. So there is nothing new for us, we simply define additional JMS message senders and receivers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-jms:endpoint id="smartAirlineBookingRequestEndpoint"
                      destination-name="${smart.airline.request.queue}"/&gt;

&lt;citrus-jms:endpoint id="smartAirlineBookingResponseEndpoint"
                      destination-name="${smart.airline.response.queue}"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We do not define a new JMS connection factory because TravelAgency and SmartAirline are using the same message broker instance. In case you need to handle multiple connection factories simply define the connection factory with the attribute "connection-factory".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-jms:endpoint id="smartAirlineBookingRequestEndpoint"
                            destination-name="${smart.airline.request.queue}"
                            connection-factory="smartAirlineConnectionFactory"/&gt;

&lt;citrus-jms:endpoint id="smartAirlineBookingResponseEndpoint"
                          destination-name="${smart.airline.response.queue}"
                          connection-factory="smartAirlineConnectionFactory"/&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="flightbooking-http-adapter"><a class="anchor" href="#flightbooking-http-adapter"></a><a class="link" href="#flightbooking-http-adapter">53.1.3. Configure the Http adapter</a></h4>
<div class="paragraph">
<p>The RoyalAirline is connected to our system using Http request/response communication. This means we have to simulate a Http server in the test that accepts client requests and provides proper responses. Citrus offers a Http server implementation that will listen on a port for client requests. The adapter forwards incoming request to the test engine over JMS and receives a proper response that is forwarded as a Http response to the client. The next picture shows this mechanism in detail.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/samples/flightbooking/http_adapter.jpg" alt="samples/flightbooking/http_adapter.jpg"></span></p>
</div>
<div class="paragraph">
<p>The RoyalAirline adapter receives client requests over Http and sends them over JMS to a message receiver as we already know it. The test engine validates the received request and provides a proper response back to the adapter. The adapter will transform the response to Http again and publishes it to the calling client. Citrus offers these kind of adapters for Http and SOAP communication. By writing your own adapters like this you will be able to extend Citrus so it works with protocols that are not supported yet.</p>
</div>
<div class="paragraph">
<p>Let us define the Http adapter in the Spring configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;citrus-http:server id="royalAirlineHttpServer"
                       port="8091"
                       uri="/flightbooking"
                       endpoint-adapter="jmsEndpointAdapter"/&gt;

&lt;citrus-jms:endpoint-adapter id="jmsEndpointAdapter
      destination-name="${royal.airline.request.queue}"/&gt;
      connection-factory="connectionFactory" /&gt;
      timeout="2000"/&gt;

&lt;citrus-jms:sync-endpoint id="royalAirlineBookingEndpoint"
                            destination-name="${royal.airline.request.queue}"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We need to configure a Http server instance with a port, a request URI and the endpoint adapter. We define the JMS endpoint adapter to handle request as described. In Addition to the endpoint adapter we also need synchronous JMS message sender and receiver instances. That&#8217;s it! We are able to receive Http request in order to simulate the RoyalAirline application. What is missing now? The test case definition itself.</p>
</div>
</div>
<div class="sect3">
<h4 id="flightbooking-test-case"><a class="anchor" href="#flightbooking-test-case"></a><a class="link" href="#flightbooking-test-case">53.1.4. The test case</a></h4>
<div class="paragraph">
<p>The test case definition is also a Spring configuration file. Citrus offers a customized XML syntax to define a test case. This XML test defining language is supposed to be easy to understand and more specific to the domain we are dealing with. Next listing shows the whole test case definition. Keep in mind that a test case defines every step in the use case. So we define sending and receiving actions of the use case as described in the sequence diagram we saw earlier.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
             xmlns:spring="http://www.springframework.org/schema/beans"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://www.springframework.org/schema/beans
                 http://www.springframework.org/schema/beans/spring-beans.xsd
                 http://www.citrusframework.org/schema/testcase
                 http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd"&gt;
    &lt;testcase name="FlightBookingTest"&gt;
        &lt;meta-info&gt;
            &lt;author&gt;Christoph Deppisch&lt;/author&gt;
            &lt;creationdate&gt;2009-04-15&lt;/creationdate&gt;
            &lt;status&gt;FINAL&lt;/status&gt;
            &lt;last-updated-by&gt;Christoph Deppisch&lt;/last-updated-by&gt;
            &lt;last-updated-on&gt;2009-04-15T00:00:00&lt;/last-updated-on&gt;
        &lt;/meta-info&gt;
        &lt;description&gt;
            Test flight booking service.
        &lt;/description&gt;
        &lt;variables&gt;
            &lt;variable name="correlationId"
                value="citrus:concat('Lx1x', 'citrus:randomNumber(10)')"/&gt;
            &lt;variable name="customerId"
                value="citrus:concat('Mx1x', citrus:randomNumber(10))"/&gt;
        &lt;/variables&gt;
        &lt;actions&gt;
            &lt;send endpoint="travelAgencyBookingRequestEndpoint"&gt;
                &lt;message&gt;
                    &lt;data&gt;
                      &lt;![CDATA[
                        &lt;TravelBookingRequestMessage
                          xmlns="http://citrusframework.org/schemas/TravelAgency"&gt;
                          &lt;correlationId&gt;${correlationId}&lt;/correlationId&gt;
                          &lt;customer&gt;
                            &lt;id&gt;${customerId}&lt;/id&gt;
                            &lt;firstname&gt;John&lt;/firstname&gt;
                            &lt;lastname&gt;Doe&lt;/lastname&gt;
                          &lt;/customer&gt;
                          &lt;flights&gt;
                            &lt;flight&gt;
                              &lt;flightId&gt;SM 1269&lt;/flightId&gt;
                              &lt;airline&gt;SmartAirline&lt;/airline&gt;
                              &lt;fromAirport&gt;MUC&lt;/fromAirport&gt;
                              &lt;toAirport&gt;FRA&lt;/toAirport&gt;
                              &lt;date&gt;2009-04-15&lt;/date&gt;
                              &lt;scheduledDeparture&gt;11:55:00&lt;/scheduledDeparture&gt;
                              &lt;scheduledArrival&gt;13:00:00&lt;/scheduledArrival&gt;
                            &lt;/flight&gt;
                            &lt;flight&gt;
                              &lt;flightId&gt;RA 1780&lt;/flightId&gt;
                              &lt;airline&gt;RoyalAirline&lt;/airline&gt;
                              &lt;fromAirport&gt;FRA&lt;/fromAirport&gt;
                              &lt;toAirport&gt;HAM&lt;/toAirport&gt;
                              &lt;date&gt;2009-04-15&lt;/date&gt;
                              &lt;scheduledDeparture&gt;16:00:00&lt;/scheduledDeparture&gt;
                              &lt;scheduledArrival&gt;17:10:00&lt;/scheduledArrival&gt;
                            &lt;/flight&gt;
                          &lt;/flights&gt;
                        &lt;/TravelBookingRequestMessage&gt;
                      ]]&gt;
                    &lt;/data&gt;
                &lt;/message&gt;
                &lt;header&gt;
                    &lt;element name="correlationId" value="${correlationId}"/&gt;
                &lt;/header&gt;
            &lt;/send&gt;

            &lt;receive endpoint="smartAirlineBookingRequestEndpoint"&gt;
                &lt;message&gt;
                    &lt;data&gt;
                      &lt;![CDATA[
                        &lt;FlightBookingRequestMessage
                          xmlns="http://citrusframework.org/schemas/AirlineSchema"&gt;
                          &lt;correlationId&gt;${correlationId}&lt;/correlationId&gt;
                          &lt;bookingId&gt;???&lt;/bookingId&gt;
                          &lt;customer&gt;
                            &lt;id&gt;${customerId}&lt;/id&gt;
                            &lt;firstname&gt;John&lt;/firstname&gt;
                            &lt;lastname&gt;Doe&lt;/lastname&gt;
                          &lt;/customer&gt;
                          &lt;flight&gt;
                            &lt;flightId&gt;SM 1269&lt;/flightId&gt;
                            &lt;airline&gt;SmartAirline&lt;/airline&gt;
                            &lt;fromAirport&gt;MUC&lt;/fromAirport&gt;
                            &lt;toAirport&gt;FRA&lt;/toAirport&gt;
                            &lt;date&gt;2009-04-15&lt;/date&gt;
                            &lt;scheduledDeparture&gt;11:55:00&lt;/scheduledDeparture&gt;
                            &lt;scheduledArrival&gt;13:00:00&lt;/scheduledArrival&gt;
                          &lt;/flight&gt;
                        &lt;/FlightBookingRequestMessage&gt;
                      ]]&gt;
                    &lt;/data&gt;
                    &lt;ignore path="//:FlightBookingRequestMessage/:bookingId"/&gt;
                &lt;/message&gt;
                &lt;header&gt;
                    &lt;element name="correlationId" value="${correlationId}"/&gt;
                &lt;/header&gt;
                &lt;extract&gt;
                    &lt;message path="//:FlightBookingRequestMessage/:bookingId"
                                variable="${smartAirlineBookingId}"/&gt;
                &lt;/extract&gt;
            &lt;/receive&gt;

            &lt;send endpoint="smartAirlineBookingResponseEndpoint"&gt;
                &lt;message&gt;
                    &lt;data&gt;
                      &lt;![CDATA[
                        &lt;FlightBookingConfirmationMessage
                          xmlns="http://citrusframework.org/schemas/AirlineSchema"&gt;
                          &lt;correlationId&gt;${correlationId}&lt;/correlationId&gt;
                          &lt;bookingId&gt;${smartAirlineBookingId}&lt;/bookingId&gt;
                          &lt;success&gt;true&lt;/success&gt;
                          &lt;flight&gt;
                            &lt;flightId&gt;SM 1269&lt;/flightId&gt;
                            &lt;airline&gt;SmartAirline&lt;/airline&gt;
                            &lt;fromAirport&gt;MUC&lt;/fromAirport&gt;
                            &lt;toAirport&gt;FRA&lt;/toAirport&gt;
                            &lt;date&gt;2009-04-15&lt;/date&gt;
                            &lt;scheduledDeparture&gt;11:55:00&lt;/scheduledDeparture&gt;
                            &lt;scheduledArrival&gt;13:00:00&lt;/scheduledArrival&gt;
                          &lt;/flight&gt;
                        &lt;/FlightBookingConfirmationMessage&gt;
                      ]]&gt;
                    &lt;/data&gt;
                &lt;/message&gt;
                &lt;header&gt;
                    &lt;element name="correlationId" value="${correlationId}"/&gt;
                &lt;/header&gt;
            &lt;/send&gt;

            &lt;receive endpoint="royalAirlineBookingEndpoint"&gt;
                &lt;message&gt;
                    &lt;data&gt;
                      &lt;![CDATA[
                        &lt;FlightBookingRequestMessage
                          xmlns="http://citrusframework.org/schemas/FlightBooking/AirlineSchema"&gt;
                          &lt;correlationId&gt;${correlationId}&lt;/correlationId&gt;
                          &lt;bookingId&gt;???&lt;/bookingId&gt;
                          &lt;customer&gt;
                              &lt;id&gt;${customerId}&lt;/id&gt;
                              &lt;firstname&gt;John&lt;/firstname&gt;
                              &lt;lastname&gt;Doe&lt;/lastname&gt;
                          &lt;/customer&gt;
                          &lt;flight&gt;
                            &lt;flightId&gt;RA 1780&lt;/flightId&gt;
                            &lt;airline&gt;RoyalAirline&lt;/airline&gt;
                            &lt;fromAirport&gt;FRA&lt;/fromAirport&gt;
                            &lt;toAirport&gt;HAM&lt;/toAirport&gt;
                            &lt;date&gt;2009-04-15&lt;/date&gt;
                            &lt;scheduledDeparture&gt;16:00:00&lt;/scheduledDeparture&gt;
                            &lt;scheduledArrival&gt;17:10:00&lt;/scheduledArrival&gt;
                          &lt;/flight&gt;
                        &lt;/FlightBookingRequestMessage&gt;
                      ]]&gt;
                    &lt;/data&gt;
                    &lt;ignore path="//:FlightBookingRequestMessage/:bookingId"/&gt;
                &lt;/message&gt;
                &lt;header&gt;
                    &lt;element name="correlationId" value="${correlationId}"/&gt;
                &lt;/header&gt;
                &lt;extract&gt;
                    &lt;message path="//:FlightBookingRequestMessage/:bookingId"
                                variable="${royalAirlineBookingId}"/&gt;
                &lt;/extract&gt;
            &lt;/receive&gt;

            &lt;send endpoint="royalAirlineBookingEndpoint"&gt;
                &lt;message&gt;
                    &lt;data&gt;
                      &lt;![CDATA[
                        &lt;FlightBookingConfirmationMessage
                          xmlns="http://citrusframework.org/schemas/AirlineSchema"&gt;
                          &lt;correlationId&gt;${correlationId}&lt;/correlationId&gt;
                          &lt;bookingId&gt;${royalAirlineBookingId}&lt;/bookingId&gt;
                          &lt;success&gt;true&lt;/success&gt;
                          &lt;flight&gt;
                            &lt;flightId&gt;RA 1780&lt;/flightId&gt;
                            &lt;airline&gt;RoyalAirline&lt;/airline&gt;
                            &lt;fromAirport&gt;FRA&lt;/fromAirport&gt;
                            &lt;toAirport&gt;HAM&lt;/toAirport&gt;
                            &lt;date&gt;2009-04-15&lt;/date&gt;
                            &lt;scheduledDeparture&gt;16:00:00&lt;/scheduledDeparture&gt;
                            &lt;scheduledArrival&gt;17:10:00&lt;/scheduledArrival&gt;
                          &lt;/flight&gt;
                        &lt;/FlightBookingConfirmationMessage&gt;
                      ]]&gt;
                    &lt;/data&gt;
                &lt;/message&gt;
                &lt;header&gt;
                    &lt;element name="correlationid" value="${correlationId}"/&gt;
                &lt;/header&gt;
            &lt;/send&gt;

            &lt;receive endpoint="travelAgencyBookingResponseEndpoint"&gt;
                &lt;message&gt;
                    &lt;data&gt;
                      &lt;![CDATA[
                        &lt;TravelBookingResponseMessage
                          xmlns="http://citrusframework.org/schemas/TravelAgency"&gt;
                          &lt;correlationId&gt;${correlationId}&lt;/correlationId&gt;
                          &lt;success&gt;true&lt;/success&gt;
                          &lt;flights&gt;
                            &lt;flight&gt;
                              &lt;flightId&gt;SM 1269&lt;/flightId&gt;
                              &lt;airline&gt;SmartAirline&lt;/airline&gt;
                              &lt;fromAirport&gt;MUC&lt;/fromAirport&gt;
                              &lt;toAirport&gt;FRA&lt;/toAirport&gt;
                              &lt;date&gt;2009-04-15&lt;/date&gt;
                              &lt;scheduledDeparture&gt;11:55:00&lt;/scheduledDeparture&gt;
                              &lt;scheduledArrival&gt;13:00:00&lt;/scheduledArrival&gt;
                            &lt;/flight&gt;
                            &lt;flight&gt;
                              &lt;flightId&gt;RA 1780&lt;/flightId&gt;
                              &lt;airline&gt;RoyalAirline&lt;/airline&gt;
                              &lt;fromAirport&gt;FRA&lt;/fromAirport&gt;
                              &lt;toAirport&gt;HAM&lt;/toAirport&gt;
                              &lt;date&gt;2009-04-15&lt;/date&gt;
                              &lt;scheduledDeparture&gt;16:00:00&lt;/scheduledDeparture&gt;
                              &lt;scheduledArrival&gt;17:10:00&lt;/scheduledArrival&gt;
                            &lt;/flight&gt;
                          &lt;/flights&gt;
                        &lt;/TravelBookingResponseMessage&gt;
                      ]]&gt;
                    &lt;/data&gt;
                &lt;/message&gt;
                &lt;header&gt;
                    &lt;element name="correlationId" value="${correlationId}"/&gt;
                &lt;/header&gt;
            &lt;/receive&gt;

        &lt;/actions&gt;
    &lt;/testcase&gt;
&lt;/spring:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar to a sequence diagram the test case describes every step of the use case. At the very beginning the test case gets name and its meta information. Following with the variable values that are used all over the test. Here it is the correlationId and the customerId that are used as test variables. Inside message templates header values the variables are referenced several times in the test</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&lt;correlationId&gt;${correlationId}&lt;/correlationId&gt;
&lt;id&gt;${customerId}&lt;/id&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sending/receiving actions use a previously defined message sender/receiver. This is the link between test case and basic Spring configuration we have done before.</p>
</div>
<div class="paragraph">
<p><code>send endpoint=&quot;travelAgencyBookingRequestEndpoint&quot;</code></p>
</div>
<div class="paragraph">
<p>The sending action chooses a message sender to actually send the message using a message transport (JMS, Http, SOAP, etc.). After sending this first "TravelBookingRequestMessage" request the test case expects the first "FlightBookingRequestMessage" message on the SmartAirline JMS destination. In case this message is not arriving in time the test will fail with errors. In positive case our FlightBookingService works well and the message arrives in time. The received message is validated against a defined expected message template. Only in case all content validation steps are successful the test continues with the action chain. And so the test case proceeds and works through the use case until every message is sent respectively received and validated. The use case is done automatically without human interaction. Citrus simulates all surrounding applications and provides detailed validation possibilities of messages.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix"><a class="anchor" href="#appendix"></a><a class="link" href="#appendix">54. Appendix</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="maven-archetypes"><a class="anchor" href="#maven-archetypes"></a><a class="link" href="#maven-archetypes">Maven archetype</a></h3>
<div class="paragraph">
<p>If you start from scratch or in case you would like to have Citrus operating in a separate Maven module you can use the
Citrus Maven archetype to create a new Maven project. The archetype will setup a basic Citrus project structure with basic
settings and files.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">mvn archetype:generate -Dfilter=org.citrusframework.mvn:citrus

1: remote -&gt; org.citrusframework.mvn:citrus-quickstart (Citrus quickstart project)
2: remote -&gt; org.citrusframework.mvn:citrus-quickstart-jms (Citrus quickstart project with JMS consumer and producer)
3: remote -&gt; org.citrusframework.mvn:citrus-quickstart-soap (Citrus quickstart project with SOAP client and producer)
Choose a number: 1

Define value for groupId: org.citrusframework.samples
Define value for artifactId: citrus-sample
Define value for version: 1.0-SNAPSHOT
Define value for package: org.citrusframework.samples</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the sample above we used the Citrus archetype available in Maven central repository.
As the list of default archetypes available in Maven central is very long, it has been filtered for official Citrus archetypes.</p>
</div>
<div class="paragraph">
<p>After choosing the Citrus quickstart archetype you have to define several values for your project: the groupId, the artifactId,
the package and the project version. After that we are done! Maven created a Citrus project structure for us which is
ready for testing. You should see the following basic project folder structure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">citrus-sample
  |   + src
  |   |   + main
  |   |    |   + java
  |   |    |   + resources
  |   |   + test
  |   |    |   + java
  |   |    |   + resources
  pom.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Citrus project is absolutely ready for testing. With Maven we can build, package, install and test our project right
away without any adjustments. Try to execute the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">mvn clean verify
mvn clean verify -Dit.test=MyFirstCitrusTest</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you need additional assistance in setting up a Citrus Maven project please visit our Maven setup tutorial on
<a href="https://citfrusframework.org">https://citrusframework.org/tutorials.html</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 4.8.2<br>
Last updated 2025-10-28 08:41:01 +0100
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/languages/gherkin.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/languages/groovy.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
<style>
  #footer {
    height: 180px;
  }

  #footer-sponsor {
    position: absolute;
    bottom: 5px;
    right: 25px;
    float: right;
  }
</style>
<div id="footer-sponsor">
    <img src="images/bmi_logo_eng.png" alt="Federal Ministry for Economic Affairs and Energy" style="margin-right: 50px"/>
    <a href="https://www.consol.de" target="_blank" alt="ConSol Software GmbH"><img src="images/sponsor-logo.png" /></a>
</div>
</body>
</html>