name: "CamelJBangCmdReceiveTest"
author: "Christoph"
status: "FINAL"
variables:
  # ToDo: Remove pinned version when fixed in Camel (see CAMEL-22922)
  - name: camelVersion
    value: 4.16.0
actions:
  - camel:
      jbang:
        camelVersion: ${camelVersion}
        run:
          stub:
            - kafka
          integration:
            name: "echo-events-yaml"
            file: "classpath:org/citrusframework/camel/integration/echo-events.yaml"

  - timer:
      id: send-events
      fork: true
      delay: 5000
      interval: 1000
      actions:
        - camel:
            jbang:
              cmd:
                send:
                  integration: "echo-events-yaml"
                  body:
                    data: "citrus:randomEnumValue('Hello Camel', 'Camel rocks!', 'Good Bye Camel!')"

  - camel:
      jbang:
        camelVersion: ${camelVersion}
        cmd:
          receive:
            integration: "echo-events-yaml"
            endpoint: "kafka:info"
            tail: 1
            grep: "Hello Camel"

  - camel:
      jbang:
        camelVersion: ${camelVersion}
        cmd:
          receive:
            integration: "echo-events-yaml"
            endpoint: "kafka:info"
            tail: 1
            grep: "Camel rocks!"

  - camel:
      jbang:
        camelVersion: ${camelVersion}
        cmd:
          receive:
            integration: "echo-events-yaml"
            endpoint: "kafka:info"
            tail: 1
            grep: "Good Bye Camel!"

finally:
  - stopTimer:
      id: send-events

  - camel:
      jbang:
        camelVersion: ${camelVersion}
        stop:
          integration: "echo-events-yaml"
